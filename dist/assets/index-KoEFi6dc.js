var vr=Object.defineProperty;var Er=(t,e,n)=>e in t?vr(t,e,{enumerable:!0,configurable:!0,writable:!0,value:n}):t[e]=n;var k=(t,e,n)=>Er(t,typeof e!="symbol"?e+"":e,n);(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))a(i);new MutationObserver(i=>{for(const s of i)if(s.type==="childList")for(const o of s.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&a(o)}).observe(document,{childList:!0,subtree:!0});function n(i){const s={};return i.integrity&&(s.integrity=i.integrity),i.referrerPolicy&&(s.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?s.credentials="include":i.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function a(i){if(i.ep)return;i.ep=!0;const s=n(i);fetch(i.href,s)}})();var st,x,$n,me,yn,Gn,qn,Wn,Gt,xt,Mt,De={},zn=[],br=/acit|ex(?:s|g|n|p|$)|rph|grid|ows|mnc|ntw|ine[ch]|zoo|^ord|itera/i,ot=Array.isArray;function he(t,e){for(var n in e)t[n]=e[n];return t}function qt(t){t&&t.parentNode&&t.parentNode.removeChild(t)}function Tr(t,e,n){var a,i,s,o={};for(s in e)s=="key"?a=e[s]:s=="ref"?i=e[s]:o[s]=e[s];if(arguments.length>2&&(o.children=arguments.length>3?st.call(arguments,2):n),typeof t=="function"&&t.defaultProps!=null)for(s in t.defaultProps)o[s]===void 0&&(o[s]=t.defaultProps[s]);return Je(t,o,a,i,null)}function Je(t,e,n,a,i){var s={type:t,props:e,key:n,ref:a,__k:null,__:null,__b:0,__e:null,__c:null,constructor:void 0,__v:i??++$n,__i:-1,__u:0};return i==null&&x.vnode!=null&&x.vnode(s),s}function te(t){return t.children}function Ze(t,e){this.props=t,this.context=e}function Ae(t,e){if(e==null)return t.__?Ae(t.__,t.__i+1):null;for(var n;e<t.__k.length;e++)if((n=t.__k[e])!=null&&n.__e!=null)return n.__e;return typeof t.type=="function"?Ae(t):null}function Bn(t){var e,n;if((t=t.__)!=null&&t.__c!=null){for(t.__e=t.__c.base=null,e=0;e<t.__k.length;e++)if((n=t.__k[e])!=null&&n.__e!=null){t.__e=t.__c.base=n.__e;break}return Bn(t)}}function vn(t){(!t.__d&&(t.__d=!0)&&me.push(t)&&!nt.__r++||yn!=x.debounceRendering)&&((yn=x.debounceRendering)||Gn)(nt)}function nt(){for(var t,e,n,a,i,s,o,p=1;me.length;)me.length>p&&me.sort(qn),t=me.shift(),p=me.length,t.__d&&(n=void 0,a=void 0,i=(a=(e=t).__v).__e,s=[],o=[],e.__P&&((n=he({},a)).__v=a.__v+1,x.vnode&&x.vnode(n),Wt(e.__P,n,a,e.__n,e.__P.namespaceURI,32&a.__u?[i]:null,s,i??Ae(a),!!(32&a.__u),o),n.__v=a.__v,n.__.__k[n.__i]=n,Yn(s,n,o),a.__e=a.__=null,n.__e!=i&&Bn(n)));nt.__r=0}function Xn(t,e,n,a,i,s,o,p,u,d,m){var c,h,_,b,w,E,g,f=a&&a.__k||zn,v=e.length;for(u=Nr(n,e,f,u,v),c=0;c<v;c++)(_=n.__k[c])!=null&&(h=_.__i==-1?De:f[_.__i]||De,_.__i=c,E=Wt(t,_,h,i,s,o,p,u,d,m),b=_.__e,_.ref&&h.ref!=_.ref&&(h.ref&&zt(h.ref,null,_),m.push(_.ref,_.__c||b,_)),w==null&&b!=null&&(w=b),(g=!!(4&_.__u))||h.__k===_.__k?u=Vn(_,u,t,g):typeof _.type=="function"&&E!==void 0?u=E:b&&(u=b.nextSibling),_.__u&=-7);return n.__e=w,u}function Nr(t,e,n,a,i){var s,o,p,u,d,m=n.length,c=m,h=0;for(t.__k=new Array(i),s=0;s<i;s++)(o=e[s])!=null&&typeof o!="boolean"&&typeof o!="function"?(u=s+h,(o=t.__k[s]=typeof o=="string"||typeof o=="number"||typeof o=="bigint"||o.constructor==String?Je(null,o,null,null,null):ot(o)?Je(te,{children:o},null,null,null):o.constructor==null&&o.__b>0?Je(o.type,o.props,o.key,o.ref?o.ref:null,o.__v):o).__=t,o.__b=t.__b+1,p=null,(d=o.__i=Sr(o,n,u,c))!=-1&&(c--,(p=n[d])&&(p.__u|=2)),p==null||p.__v==null?(d==-1&&(i>m?h--:i<m&&h++),typeof o.type!="function"&&(o.__u|=4)):d!=u&&(d==u-1?h--:d==u+1?h++:(d>u?h--:h++,o.__u|=4))):t.__k[s]=null;if(c)for(s=0;s<m;s++)(p=n[s])!=null&&!(2&p.__u)&&(p.__e==a&&(a=Ae(p)),jn(p,p));return a}function Vn(t,e,n,a){var i,s;if(typeof t.type=="function"){for(i=t.__k,s=0;i&&s<i.length;s++)i[s]&&(i[s].__=t,e=Vn(i[s],e,n,a));return e}t.__e!=e&&(a&&(e&&t.type&&!e.parentNode&&(e=Ae(t)),n.insertBefore(t.__e,e||null)),e=t.__e);do e=e&&e.nextSibling;while(e!=null&&e.nodeType==8);return e}function Sr(t,e,n,a){var i,s,o,p=t.key,u=t.type,d=e[n],m=d!=null&&(2&d.__u)==0;if(d===null&&t.key==null||m&&p==d.key&&u==d.type)return n;if(a>(m?1:0)){for(i=n-1,s=n+1;i>=0||s<e.length;)if((d=e[o=i>=0?i--:s++])!=null&&!(2&d.__u)&&p==d.key&&u==d.type)return o}return-1}function En(t,e,n){e[0]=="-"?t.setProperty(e,n??""):t[e]=n==null?"":typeof n!="number"||br.test(e)?n:n+"px"}function Ye(t,e,n,a,i){var s,o;e:if(e=="style")if(typeof n=="string")t.style.cssText=n;else{if(typeof a=="string"&&(t.style.cssText=a=""),a)for(e in a)n&&e in n||En(t.style,e,"");if(n)for(e in n)a&&n[e]==a[e]||En(t.style,e,n[e])}else if(e[0]=="o"&&e[1]=="n")s=e!=(e=e.replace(Wn,"$1")),o=e.toLowerCase(),e=o in t||e=="onFocusOut"||e=="onFocusIn"?o.slice(2):e.slice(2),t.l||(t.l={}),t.l[e+s]=n,n?a?n.u=a.u:(n.u=Gt,t.addEventListener(e,s?Mt:xt,s)):t.removeEventListener(e,s?Mt:xt,s);else{if(i=="http://www.w3.org/2000/svg")e=e.replace(/xlink(H|:h)/,"h").replace(/sName$/,"s");else if(e!="width"&&e!="height"&&e!="href"&&e!="list"&&e!="form"&&e!="tabIndex"&&e!="download"&&e!="rowSpan"&&e!="colSpan"&&e!="role"&&e!="popover"&&e in t)try{t[e]=n??"";break e}catch{}typeof n=="function"||(n==null||n===!1&&e[4]!="-"?t.removeAttribute(e):t.setAttribute(e,e=="popover"&&n==1?"":n))}}function bn(t){return function(e){if(this.l){var n=this.l[e.type+t];if(e.t==null)e.t=Gt++;else if(e.t<n.u)return;return n(x.event?x.event(e):e)}}}function Wt(t,e,n,a,i,s,o,p,u,d){var m,c,h,_,b,w,E,g,f,v,S,T,R,M,I,Z,re,O=e.type;if(e.constructor!=null)return null;128&n.__u&&(u=!!(32&n.__u),s=[p=e.__e=n.__e]),(m=x.__b)&&m(e);e:if(typeof O=="function")try{if(g=e.props,f="prototype"in O&&O.prototype.render,v=(m=O.contextType)&&a[m.__c],S=m?v?v.props.value:m.__:a,n.__c?E=(c=e.__c=n.__c).__=c.__E:(f?e.__c=c=new O(g,S):(e.__c=c=new Ze(g,S),c.constructor=O,c.render=Ar),v&&v.sub(c),c.props=g,c.state||(c.state={}),c.context=S,c.__n=a,h=c.__d=!0,c.__h=[],c._sb=[]),f&&c.__s==null&&(c.__s=c.state),f&&O.getDerivedStateFromProps!=null&&(c.__s==c.state&&(c.__s=he({},c.__s)),he(c.__s,O.getDerivedStateFromProps(g,c.__s))),_=c.props,b=c.state,c.__v=e,h)f&&O.getDerivedStateFromProps==null&&c.componentWillMount!=null&&c.componentWillMount(),f&&c.componentDidMount!=null&&c.__h.push(c.componentDidMount);else{if(f&&O.getDerivedStateFromProps==null&&g!==_&&c.componentWillReceiveProps!=null&&c.componentWillReceiveProps(g,S),!c.__e&&c.shouldComponentUpdate!=null&&c.shouldComponentUpdate(g,c.__s,S)===!1||e.__v==n.__v){for(e.__v!=n.__v&&(c.props=g,c.state=c.__s,c.__d=!1),e.__e=n.__e,e.__k=n.__k,e.__k.some(function(j){j&&(j.__=e)}),T=0;T<c._sb.length;T++)c.__h.push(c._sb[T]);c._sb=[],c.__h.length&&o.push(c);break e}c.componentWillUpdate!=null&&c.componentWillUpdate(g,c.__s,S),f&&c.componentDidUpdate!=null&&c.__h.push(function(){c.componentDidUpdate(_,b,w)})}if(c.context=S,c.props=g,c.__P=t,c.__e=!1,R=x.__r,M=0,f){for(c.state=c.__s,c.__d=!1,R&&R(e),m=c.render(c.props,c.state,c.context),I=0;I<c._sb.length;I++)c.__h.push(c._sb[I]);c._sb=[]}else do c.__d=!1,R&&R(e),m=c.render(c.props,c.state,c.context),c.state=c.__s;while(c.__d&&++M<25);c.state=c.__s,c.getChildContext!=null&&(a=he(he({},a),c.getChildContext())),f&&!h&&c.getSnapshotBeforeUpdate!=null&&(w=c.getSnapshotBeforeUpdate(_,b)),Z=m,m!=null&&m.type===te&&m.key==null&&(Z=Qn(m.props.children)),p=Xn(t,ot(Z)?Z:[Z],e,n,a,i,s,o,p,u,d),c.base=e.__e,e.__u&=-161,c.__h.length&&o.push(c),E&&(c.__E=c.__=null)}catch(j){if(e.__v=null,u||s!=null)if(j.then){for(e.__u|=u?160:128;p&&p.nodeType==8&&p.nextSibling;)p=p.nextSibling;s[s.indexOf(p)]=null,e.__e=p}else{for(re=s.length;re--;)qt(s[re]);It(e)}else e.__e=n.__e,e.__k=n.__k,j.then||It(e);x.__e(j,e,n)}else s==null&&e.__v==n.__v?(e.__k=n.__k,e.__e=n.__e):p=e.__e=wr(n.__e,e,n,a,i,s,o,u,d);return(m=x.diffed)&&m(e),128&e.__u?void 0:p}function It(t){t&&t.__c&&(t.__c.__e=!0),t&&t.__k&&t.__k.forEach(It)}function Yn(t,e,n){for(var a=0;a<n.length;a++)zt(n[a],n[++a],n[++a]);x.__c&&x.__c(e,t),t.some(function(i){try{t=i.__h,i.__h=[],t.some(function(s){s.call(i)})}catch(s){x.__e(s,i.__v)}})}function Qn(t){return typeof t!="object"||t==null||t.__b&&t.__b>0?t:ot(t)?t.map(Qn):he({},t)}function wr(t,e,n,a,i,s,o,p,u){var d,m,c,h,_,b,w,E=n.props,g=e.props,f=e.type;if(f=="svg"?i="http://www.w3.org/2000/svg":f=="math"?i="http://www.w3.org/1998/Math/MathML":i||(i="http://www.w3.org/1999/xhtml"),s!=null){for(d=0;d<s.length;d++)if((_=s[d])&&"setAttribute"in _==!!f&&(f?_.localName==f:_.nodeType==3)){t=_,s[d]=null;break}}if(t==null){if(f==null)return document.createTextNode(g);t=document.createElementNS(i,f,g.is&&g),p&&(x.__m&&x.__m(e,s),p=!1),s=null}if(f==null)E===g||p&&t.data==g||(t.data=g);else{if(s=s&&st.call(t.childNodes),E=n.props||De,!p&&s!=null)for(E={},d=0;d<t.attributes.length;d++)E[(_=t.attributes[d]).name]=_.value;for(d in E)if(_=E[d],d!="children"){if(d=="dangerouslySetInnerHTML")c=_;else if(!(d in g)){if(d=="value"&&"defaultValue"in g||d=="checked"&&"defaultChecked"in g)continue;Ye(t,d,null,_,i)}}for(d in g)_=g[d],d=="children"?h=_:d=="dangerouslySetInnerHTML"?m=_:d=="value"?b=_:d=="checked"?w=_:p&&typeof _!="function"||E[d]===_||Ye(t,d,_,E[d],i);if(m)p||c&&(m.__html==c.__html||m.__html==t.innerHTML)||(t.innerHTML=m.__html),e.__k=[];else if(c&&(t.innerHTML=""),Xn(e.type=="template"?t.content:t,ot(h)?h:[h],e,n,a,f=="foreignObject"?"http://www.w3.org/1999/xhtml":i,s,o,s?s[0]:n.__k&&Ae(n,0),p,u),s!=null)for(d=s.length;d--;)qt(s[d]);p||(d="value",f=="progress"&&b==null?t.removeAttribute("value"):b!=null&&(b!==t[d]||f=="progress"&&!b||f=="option"&&b!=E[d])&&Ye(t,d,b,E[d],i),d="checked",w!=null&&w!=t[d]&&Ye(t,d,w,E[d],i))}return t}function zt(t,e,n){try{if(typeof t=="function"){var a=typeof t.__u=="function";a&&t.__u(),a&&e==null||(t.__u=t(e))}else t.current=e}catch(i){x.__e(i,n)}}function jn(t,e,n){var a,i;if(x.unmount&&x.unmount(t),(a=t.ref)&&(a.current&&a.current!=t.__e||zt(a,null,e)),(a=t.__c)!=null){if(a.componentWillUnmount)try{a.componentWillUnmount()}catch(s){x.__e(s,e)}a.base=a.__P=null}if(a=t.__k)for(i=0;i<a.length;i++)a[i]&&jn(a[i],e,n||typeof t.type!="function");n||qt(t.__e),t.__c=t.__=t.__e=void 0}function Ar(t,e,n){return this.constructor(t,n)}function Lr(t,e,n){var a,i,s,o;e==document&&(e=document.documentElement),x.__&&x.__(t,e),i=(a=!1)?null:e.__k,s=[],o=[],Wt(e,t=e.__k=Tr(te,null,[t]),i||De,De,e.namespaceURI,i?null:e.firstChild?st.call(e.childNodes):null,s,i?i.__e:e.firstChild,a,o),Yn(s,t,o)}st=zn.slice,x={__e:function(t,e,n,a){for(var i,s,o;e=e.__;)if((i=e.__c)&&!i.__)try{if((s=i.constructor)&&s.getDerivedStateFromError!=null&&(i.setState(s.getDerivedStateFromError(t)),o=i.__d),i.componentDidCatch!=null&&(i.componentDidCatch(t,a||{}),o=i.__d),o)return i.__E=i}catch(p){t=p}throw t}},$n=0,Ze.prototype.setState=function(t,e){var n;n=this.__s!=null&&this.__s!=this.state?this.__s:this.__s=he({},this.state),typeof t=="function"&&(t=t(he({},n),this.props)),t&&he(n,t),t!=null&&this.__v&&(e&&this._sb.push(e),vn(this))},Ze.prototype.forceUpdate=function(t){this.__v&&(this.__e=!0,t&&this.__h.push(t),vn(this))},Ze.prototype.render=te,me=[],Gn=typeof Promise=="function"?Promise.prototype.then.bind(Promise.resolve()):setTimeout,qn=function(t,e){return t.__v.__b-e.__v.__b},nt.__r=0,Wn=/(PointerCapture)$|Capture$/i,Gt=0,xt=bn(!1),Mt=bn(!0);var Cr=0;function r(t,e,n,a,i,s){e||(e={});var o,p,u=e;if("ref"in u)for(p in u={},e)p=="ref"?o=e[p]:u[p]=e[p];var d={type:t,props:u,key:n,ref:o,__k:null,__:null,__b:0,__e:null,__c:null,constructor:void 0,__v:--Cr,__i:-1,__u:0,__source:i,__self:s};if(typeof t=="function"&&(o=t.defaultProps))for(p in o)u[p]===void 0&&(u[p]=o[p]);return x.vnode&&x.vnode(d),d}var Pe,U,vt,Tn,rt=0,Kn=[],$=x,Nn=$.__b,Sn=$.__r,wn=$.diffed,An=$.__c,Ln=$.unmount,Cn=$.__;function Bt(t,e){$.__h&&$.__h(U,t,rt||e),rt=0;var n=U.__H||(U.__H={__:[],__h:[]});return t>=n.__.length&&n.__.push({}),n.__[t]}function L(t){return rt=1,Rr(Zn,t)}function Rr(t,e,n){var a=Bt(Pe++,2);if(a.t=t,!a.__c&&(a.__=[Zn(void 0,e),function(p){var u=a.__N?a.__N[0]:a.__[0],d=a.t(u,p);u!==d&&(a.__N=[d,a.__[1]],a.__c.setState({}))}],a.__c=U,!U.__f)){var i=function(p,u,d){if(!a.__c.__H)return!0;var m=a.__c.__H.__.filter(function(h){return!!h.__c});if(m.every(function(h){return!h.__N}))return!s||s.call(this,p,u,d);var c=a.__c.props!==p;return m.forEach(function(h){if(h.__N){var _=h.__[0];h.__=h.__N,h.__N=void 0,_!==h.__[0]&&(c=!0)}}),s&&s.call(this,p,u,d)||c};U.__f=!0;var s=U.shouldComponentUpdate,o=U.componentWillUpdate;U.componentWillUpdate=function(p,u,d){if(this.__e){var m=s;s=void 0,i(p,u,d),s=m}o&&o.call(this,p,u,d)},U.shouldComponentUpdate=i}return a.__N||a.__}function V(t,e){var n=Bt(Pe++,3);!$.__s&&Jn(n.__H,e)&&(n.__=t,n.u=e,U.__H.__h.push(n))}function at(t){return rt=5,Or(function(){return{current:t}},[])}function Or(t,e){var n=Bt(Pe++,7);return Jn(n.__H,e)&&(n.__=t(),n.__H=e,n.__h=t),n.__}function kr(){for(var t;t=Kn.shift();)if(t.__P&&t.__H)try{t.__H.__h.forEach(et),t.__H.__h.forEach(Ft),t.__H.__h=[]}catch(e){t.__H.__h=[],$.__e(e,t.__v)}}$.__b=function(t){U=null,Nn&&Nn(t)},$.__=function(t,e){t&&e.__k&&e.__k.__m&&(t.__m=e.__k.__m),Cn&&Cn(t,e)},$.__r=function(t){Sn&&Sn(t),Pe=0;var e=(U=t.__c).__H;e&&(vt===U?(e.__h=[],U.__h=[],e.__.forEach(function(n){n.__N&&(n.__=n.__N),n.u=n.__N=void 0})):(e.__h.forEach(et),e.__h.forEach(Ft),e.__h=[],Pe=0)),vt=U},$.diffed=function(t){wn&&wn(t);var e=t.__c;e&&e.__H&&(e.__H.__h.length&&(Kn.push(e)!==1&&Tn===$.requestAnimationFrame||((Tn=$.requestAnimationFrame)||xr)(kr)),e.__H.__.forEach(function(n){n.u&&(n.__H=n.u),n.u=void 0})),vt=U=null},$.__c=function(t,e){e.some(function(n){try{n.__h.forEach(et),n.__h=n.__h.filter(function(a){return!a.__||Ft(a)})}catch(a){e.some(function(i){i.__h&&(i.__h=[])}),e=[],$.__e(a,n.__v)}}),An&&An(t,e)},$.unmount=function(t){Ln&&Ln(t);var e,n=t.__c;n&&n.__H&&(n.__H.__.forEach(function(a){try{et(a)}catch(i){e=i}}),n.__H=void 0,e&&$.__e(e,n.__v))};var Rn=typeof requestAnimationFrame=="function";function xr(t){var e,n=function(){clearTimeout(a),Rn&&cancelAnimationFrame(e),setTimeout(t)},a=setTimeout(n,35);Rn&&(e=requestAnimationFrame(n))}function et(t){var e=U,n=t.__c;typeof n=="function"&&(t.__c=void 0,n()),U=e}function Ft(t){var e=U;t.__c=t.__(),U=e}function Jn(t,e){return!t||t.length!==e.length||e.some(function(n,a){return n!==t[a]})}function Zn(t,e){return typeof e=="function"?e(t):e}const Mr={maxQueueSize:50,defaultTimeout:1e4,maxTimeout:3e4};class Ir{constructor(e={}){k(this,"queue",[]);k(this,"processing",!1);k(this,"nextId",1);k(this,"config");k(this,"stats",{totalProcessed:0,totalTimeouts:0,totalErrors:0});this.config={...Mr,...e}}async enqueue(e,n){if(this.queue.length>=this.config.maxQueueSize)throw new Error(`Query queue full (${this.config.maxQueueSize} items). Too many pending queries.`);const a=Math.min(n||this.config.defaultTimeout,this.config.maxTimeout);return new Promise((i,s)=>{const o={id:this.nextId++,execute:e,resolve:i,reject:s,timeout:a,enqueuedAt:Date.now()};this.queue.push(o),this.processing||this.processQueue()})}async processQueue(){if(!(this.processing||this.queue.length===0)){for(this.processing=!0;this.queue.length>0;){const e=this.queue.shift();try{await this.executeWithTimeout(e)}catch{}}this.processing=!1}}async executeWithTimeout(e){const n=new Promise((a,i)=>{setTimeout(()=>{i(new Error(`Query ${e.id} timed out after ${e.timeout}ms`))},e.timeout)});try{const a=await Promise.race([e.execute(),n]);this.stats.totalProcessed++,e.resolve(a)}catch(a){a instanceof Error&&a.message.includes("timed out")?(this.stats.totalTimeouts++,console.warn(`[QueryQueue] Query ${e.id} timed out`,{timeout:e.timeout,waitTime:Date.now()-e.enqueuedAt})):this.stats.totalErrors++,e.reject(a)}}getStats(){return{queueLength:this.queue.length,busy:this.processing,totalProcessed:this.stats.totalProcessed,totalTimeouts:this.stats.totalTimeouts,totalErrors:this.stats.totalErrors}}isBusy(){return this.processing||this.queue.length>0}clear(){const e=new Error("Query queue cleared");for(const n of this.queue)n.reject(e);this.queue=[]}get length(){return this.queue.length}}let Et=null;function Dt(t){return Et||(Et=new Ir(t)),Et}function Fr(t,e){return Dt().enqueue(t,e)}class er{constructor(){k(this,"worker",null);k(this,"nextId",1);k(this,"pending",new Map);this.initWorker()}initWorker(){this.worker=new Worker(new URL("/assets/sqlite.worker-BP5VJzs3.js",import.meta.url),{type:"module"}),this.worker.onmessage=e=>{const n=e.data;if("type"in n&&n.type==="READY"){console.log("[DbClient] Worker ready");return}const{id:a,response:i}=n,s=this.pending.get(a);s&&(this.pending.delete(a),s.resolve(i))},this.worker.onerror=e=>{console.error("[DbClient] Worker error:",e);for(const n of this.pending.values())n.reject(new Error("Worker error"));this.pending.clear()}}async sendRequest(e,n=1e4){if(!this.worker)throw new Error("Worker not initialized");const a=this.nextId++;return Fr(async()=>new Promise((i,s)=>{const o=setTimeout(()=>{this.pending.delete(a),s(new Error(`Request ${e.type} timed out after ${n}ms`))},n);this.pending.set(a,{resolve:u=>{clearTimeout(o),u.ok?i(u.data):s(new Error(u.error))},reject:u=>{clearTimeout(o),s(u)},timeout:o});const p={id:a,request:e};this.worker.postMessage(p)}),n)}async openFromFile(e){return this.sendRequest({type:"OPEN_FROM_FILE",file:e})}async openFromOpfs(e){return this.sendRequest({type:"OPEN_FROM_OPFS",path:e})}async openDemo(){return this.sendRequest({type:"OPEN_DEMO"})}async saveToOpfs(e){return this.sendRequest({type:"SAVE_TO_OPFS",path:e})}async removeFromOpfs(e){return this.sendRequest({type:"REMOVE_FROM_OPFS",path:e})}async listOpfsFiles(){return this.sendRequest({type:"LIST_OPFS_FILES"})}async close(){return this.sendRequest({type:"CLOSE"})}async searchFts(e,n=20,a,i){return this.sendRequest({type:"FTS_SEARCH",query:e,limit:n,entityType:a,entityValue:i})}async searchHybrid(e,n=20,a){return this.sendRequest({type:"HYBRID_SEARCH",query:e,limit:n,weights:a})}async listEntities(e,n=100){return this.sendRequest({type:"LIST_ENTITIES",entityType:e,limit:n})}async getPageList(e=100,n=0){return this.sendRequest({type:"GET_PAGE_LIST",limit:e,offset:n})}async getPageBlob(e){return this.sendRequest({type:"GET_PAGE_BLOB",name:e})}async verifyPage(e){return this.sendRequest({type:"VERIFY_PAGE",gid:e})}async getCheckpoints(){return this.sendRequest({type:"GET_CHECKPOINTS"})}async graphHops(e,n,a,i){return this.sendRequest({type:"GRAPH_HOPS",seedGid:e,predicate:n,maxHops:a,limit:i})}getQueueStats(){return Dt().getStats()}isQueueBusy(){return Dt().isBusy()}terminate(){this.worker&&(this.worker.terminate(),this.worker=null);for(const e of this.pending.values())clearTimeout(e.timeout),e.reject(new Error("Worker terminated"));this.pending.clear()}}let bt=null;function J(){return bt||(bt=new er),bt}function tr(t={}){const{defaultMode:e="hybrid",maxResults:n=10,maxGraphHops:a=2,debounceMs:i=300}=t,[s,o]=L(e),[p,u]=L(null),[d,m]=L(""),[c,h]=L(!1),[_,b]=L(null),[w,E]=L({}),[g,f]=L(""),[v,S]=L(()=>{try{const F=localStorage.getItem("memglyph-search-history");return F?JSON.parse(F):[]}catch{return[]}}),T=at(null);V(()=>{if(g.trim())return T.current&&clearTimeout(T.current),T.current=window.setTimeout(()=>{I(g)},i),()=>{T.current&&clearTimeout(T.current)}},[g,s,w]);const R=F=>{if(!F.trim())return;const ae=F.trim();S(ee=>{const He=ee.filter(_e=>_e!==ae),$e=[ae,...He].slice(0,10);try{localStorage.setItem("memglyph-search-history",JSON.stringify($e))}catch(_e){console.warn("[Search] Failed to save history:",_e)}return $e})},M=()=>{S([]);try{localStorage.removeItem("memglyph-search-history")}catch(F){console.warn("[Search] Failed to clear history:",F)}},I=async F=>{if(F.trim()){h(!0),b(null),m(F),R(F);try{const ae=J();let ee=[];switch(s){case"fts":ee=await Dr(ae,F,n,w);break;case"hybrid":ee=await ae.searchHybrid(F,n);break;case"graph":ee=await Pr(ae,F,n,a,w);break;default:throw new Error(`Unknown search mode: ${s}`)}return u(ee),console.log(`[Search] ${s} mode: ${ee.length} results`),ee}catch(ae){const ee=String(ae);return b(ee),console.error("[Search] Failed:",ae),[]}finally{h(!1)}}};return{mode:s,results:p,lastQuery:d,loading:c,error:_,entityFilter:w,searchHistory:v,search:F=>{f(F)},searchImmediate:F=>(T.current&&clearTimeout(T.current),f(""),I(F)),clear:()=>{u(null),m(""),b(null),f(""),T.current&&clearTimeout(T.current)},changeMode:F=>{o(F),u(null)},setFilter:F=>{E(F),u(null)},clearFilter:()=>{E({}),u(null)},clearHistory:M}}async function Dr(t,e,n,a){return(await t.searchFts(e,n,a.entityType,a.entityValue)).map(s=>({gid:s.gid,pageNo:s.pageNo,title:s.title,snippet:s.snippet,scores:{fts:s.score,vector:0,entity:0,graph:0,final:s.score}}))}async function Pr(t,e,n,a,i){const s=await t.searchFts(e,3,i.entityType,i.entityValue);if(s.length===0)return[];const o=s[0].gid,p=await t.graphHops(o,void 0,a,n),u=p.nodes.map(d=>{const m=p.distances[d.gid]||0,c=s.find(h=>h.gid===d.gid);return{gid:d.gid,pageNo:d.pageNo,title:d.title,snippet:(c==null?void 0:c.snippet)||null,scores:{fts:(c==null?void 0:c.score)||0,vector:0,entity:0,graph:1/(m+1),final:((c==null?void 0:c.score)||0)*.3+1/(m+1)*.7}}});return u.sort((d,m)=>m.scores.final-d.scores.final),u}/*! @license DOMPurify 3.3.0 | (c) Cure53 and other contributors | Released under the Apache license 2.0 and Mozilla Public License 2.0 | github.com/cure53/DOMPurify/blob/3.3.0/LICENSE */const{entries:nr,setPrototypeOf:On,isFrozen:Ur,getPrototypeOf:Hr,getOwnPropertyDescriptor:$r}=Object;let{freeze:Y,seal:ne,create:Pt}=Object,{apply:Ut,construct:Ht}=typeof Reflect<"u"&&Reflect;Y||(Y=function(e){return e});ne||(ne=function(e){return e});Ut||(Ut=function(e,n){for(var a=arguments.length,i=new Array(a>2?a-2:0),s=2;s<a;s++)i[s-2]=arguments[s];return e.apply(n,i)});Ht||(Ht=function(e){for(var n=arguments.length,a=new Array(n>1?n-1:0),i=1;i<n;i++)a[i-1]=arguments[i];return new e(...a)});const Qe=Q(Array.prototype.forEach),Gr=Q(Array.prototype.lastIndexOf),kn=Q(Array.prototype.pop),Oe=Q(Array.prototype.push),qr=Q(Array.prototype.splice),tt=Q(String.prototype.toLowerCase),Tt=Q(String.prototype.toString),Nt=Q(String.prototype.match),ke=Q(String.prototype.replace),Wr=Q(String.prototype.indexOf),zr=Q(String.prototype.trim),ie=Q(Object.prototype.hasOwnProperty),X=Q(RegExp.prototype.test),xe=Br(TypeError);function Q(t){return function(e){e instanceof RegExp&&(e.lastIndex=0);for(var n=arguments.length,a=new Array(n>1?n-1:0),i=1;i<n;i++)a[i-1]=arguments[i];return Ut(t,e,a)}}function Br(t){return function(){for(var e=arguments.length,n=new Array(e),a=0;a<e;a++)n[a]=arguments[a];return Ht(t,n)}}function C(t,e){let n=arguments.length>2&&arguments[2]!==void 0?arguments[2]:tt;On&&On(t,null);let a=e.length;for(;a--;){let i=e[a];if(typeof i=="string"){const s=n(i);s!==i&&(Ur(e)||(e[a]=s),i=s)}t[i]=!0}return t}function Xr(t){for(let e=0;e<t.length;e++)ie(t,e)||(t[e]=null);return t}function ue(t){const e=Pt(null);for(const[n,a]of nr(t))ie(t,n)&&(Array.isArray(a)?e[n]=Xr(a):a&&typeof a=="object"&&a.constructor===Object?e[n]=ue(a):e[n]=a);return e}function Me(t,e){for(;t!==null;){const a=$r(t,e);if(a){if(a.get)return Q(a.get);if(typeof a.value=="function")return Q(a.value)}t=Hr(t)}function n(){return null}return n}const xn=Y(["a","abbr","acronym","address","area","article","aside","audio","b","bdi","bdo","big","blink","blockquote","body","br","button","canvas","caption","center","cite","code","col","colgroup","content","data","datalist","dd","decorator","del","details","dfn","dialog","dir","div","dl","dt","element","em","fieldset","figcaption","figure","font","footer","form","h1","h2","h3","h4","h5","h6","head","header","hgroup","hr","html","i","img","input","ins","kbd","label","legend","li","main","map","mark","marquee","menu","menuitem","meter","nav","nobr","ol","optgroup","option","output","p","picture","pre","progress","q","rp","rt","ruby","s","samp","search","section","select","shadow","slot","small","source","spacer","span","strike","strong","style","sub","summary","sup","table","tbody","td","template","textarea","tfoot","th","thead","time","tr","track","tt","u","ul","var","video","wbr"]),St=Y(["svg","a","altglyph","altglyphdef","altglyphitem","animatecolor","animatemotion","animatetransform","circle","clippath","defs","desc","ellipse","enterkeyhint","exportparts","filter","font","g","glyph","glyphref","hkern","image","inputmode","line","lineargradient","marker","mask","metadata","mpath","part","path","pattern","polygon","polyline","radialgradient","rect","stop","style","switch","symbol","text","textpath","title","tref","tspan","view","vkern"]),wt=Y(["feBlend","feColorMatrix","feComponentTransfer","feComposite","feConvolveMatrix","feDiffuseLighting","feDisplacementMap","feDistantLight","feDropShadow","feFlood","feFuncA","feFuncB","feFuncG","feFuncR","feGaussianBlur","feImage","feMerge","feMergeNode","feMorphology","feOffset","fePointLight","feSpecularLighting","feSpotLight","feTile","feTurbulence"]),Vr=Y(["animate","color-profile","cursor","discard","font-face","font-face-format","font-face-name","font-face-src","font-face-uri","foreignobject","hatch","hatchpath","mesh","meshgradient","meshpatch","meshrow","missing-glyph","script","set","solidcolor","unknown","use"]),At=Y(["math","menclose","merror","mfenced","mfrac","mglyph","mi","mlabeledtr","mmultiscripts","mn","mo","mover","mpadded","mphantom","mroot","mrow","ms","mspace","msqrt","mstyle","msub","msup","msubsup","mtable","mtd","mtext","mtr","munder","munderover","mprescripts"]),Yr=Y(["maction","maligngroup","malignmark","mlongdiv","mscarries","mscarry","msgroup","mstack","msline","msrow","semantics","annotation","annotation-xml","mprescripts","none"]),Mn=Y(["#text"]),In=Y(["accept","action","align","alt","autocapitalize","autocomplete","autopictureinpicture","autoplay","background","bgcolor","border","capture","cellpadding","cellspacing","checked","cite","class","clear","color","cols","colspan","controls","controlslist","coords","crossorigin","datetime","decoding","default","dir","disabled","disablepictureinpicture","disableremoteplayback","download","draggable","enctype","enterkeyhint","exportparts","face","for","headers","height","hidden","high","href","hreflang","id","inert","inputmode","integrity","ismap","kind","label","lang","list","loading","loop","low","max","maxlength","media","method","min","minlength","multiple","muted","name","nonce","noshade","novalidate","nowrap","open","optimum","part","pattern","placeholder","playsinline","popover","popovertarget","popovertargetaction","poster","preload","pubdate","radiogroup","readonly","rel","required","rev","reversed","role","rows","rowspan","spellcheck","scope","selected","shape","size","sizes","slot","span","srclang","start","src","srcset","step","style","summary","tabindex","title","translate","type","usemap","valign","value","width","wrap","xmlns","slot"]),Lt=Y(["accent-height","accumulate","additive","alignment-baseline","amplitude","ascent","attributename","attributetype","azimuth","basefrequency","baseline-shift","begin","bias","by","class","clip","clippathunits","clip-path","clip-rule","color","color-interpolation","color-interpolation-filters","color-profile","color-rendering","cx","cy","d","dx","dy","diffuseconstant","direction","display","divisor","dur","edgemode","elevation","end","exponent","fill","fill-opacity","fill-rule","filter","filterunits","flood-color","flood-opacity","font-family","font-size","font-size-adjust","font-stretch","font-style","font-variant","font-weight","fx","fy","g1","g2","glyph-name","glyphref","gradientunits","gradienttransform","height","href","id","image-rendering","in","in2","intercept","k","k1","k2","k3","k4","kerning","keypoints","keysplines","keytimes","lang","lengthadjust","letter-spacing","kernelmatrix","kernelunitlength","lighting-color","local","marker-end","marker-mid","marker-start","markerheight","markerunits","markerwidth","maskcontentunits","maskunits","max","mask","mask-type","media","method","mode","min","name","numoctaves","offset","operator","opacity","order","orient","orientation","origin","overflow","paint-order","path","pathlength","patterncontentunits","patterntransform","patternunits","points","preservealpha","preserveaspectratio","primitiveunits","r","rx","ry","radius","refx","refy","repeatcount","repeatdur","restart","result","rotate","scale","seed","shape-rendering","slope","specularconstant","specularexponent","spreadmethod","startoffset","stddeviation","stitchtiles","stop-color","stop-opacity","stroke-dasharray","stroke-dashoffset","stroke-linecap","stroke-linejoin","stroke-miterlimit","stroke-opacity","stroke","stroke-width","style","surfacescale","systemlanguage","tabindex","tablevalues","targetx","targety","transform","transform-origin","text-anchor","text-decoration","text-rendering","textlength","type","u1","u2","unicode","values","viewbox","visibility","version","vert-adv-y","vert-origin-x","vert-origin-y","width","word-spacing","wrap","writing-mode","xchannelselector","ychannelselector","x","x1","x2","xmlns","y","y1","y2","z","zoomandpan"]),Fn=Y(["accent","accentunder","align","bevelled","close","columnsalign","columnlines","columnspan","denomalign","depth","dir","display","displaystyle","encoding","fence","frame","height","href","id","largeop","length","linethickness","lspace","lquote","mathbackground","mathcolor","mathsize","mathvariant","maxsize","minsize","movablelimits","notation","numalign","open","rowalign","rowlines","rowspacing","rowspan","rspace","rquote","scriptlevel","scriptminsize","scriptsizemultiplier","selection","separator","separators","stretchy","subscriptshift","supscriptshift","symmetric","voffset","width","xmlns"]),je=Y(["xlink:href","xml:id","xlink:title","xml:space","xmlns:xlink"]),Qr=ne(/\{\{[\w\W]*|[\w\W]*\}\}/gm),jr=ne(/<%[\w\W]*|[\w\W]*%>/gm),Kr=ne(/\$\{[\w\W]*/gm),Jr=ne(/^data-[\-\w.\u00B7-\uFFFF]+$/),Zr=ne(/^aria-[\-\w]+$/),rr=ne(/^(?:(?:(?:f|ht)tps?|mailto|tel|callto|sms|cid|xmpp|matrix):|[^a-z]|[a-z+.\-]+(?:[^a-z+.\-:]|$))/i),ea=ne(/^(?:\w+script|data):/i),ta=ne(/[\u0000-\u0020\u00A0\u1680\u180E\u2000-\u2029\u205F\u3000]/g),ar=ne(/^html$/i),na=ne(/^[a-z][.\w]*(-[.\w]+)+$/i);var Dn=Object.freeze({__proto__:null,ARIA_ATTR:Zr,ATTR_WHITESPACE:ta,CUSTOM_ELEMENT:na,DATA_ATTR:Jr,DOCTYPE_NAME:ar,ERB_EXPR:jr,IS_ALLOWED_URI:rr,IS_SCRIPT_OR_DATA:ea,MUSTACHE_EXPR:Qr,TMPLIT_EXPR:Kr});const Ie={element:1,text:3,progressingInstruction:7,comment:8,document:9},ra=function(){return typeof window>"u"?null:window},aa=function(e,n){if(typeof e!="object"||typeof e.createPolicy!="function")return null;let a=null;const i="data-tt-policy-suffix";n&&n.hasAttribute(i)&&(a=n.getAttribute(i));const s="dompurify"+(a?"#"+a:"");try{return e.createPolicy(s,{createHTML(o){return o},createScriptURL(o){return o}})}catch{return console.warn("TrustedTypes policy "+s+" could not be created."),null}},Pn=function(){return{afterSanitizeAttributes:[],afterSanitizeElements:[],afterSanitizeShadowDOM:[],beforeSanitizeAttributes:[],beforeSanitizeElements:[],beforeSanitizeShadowDOM:[],uponSanitizeAttribute:[],uponSanitizeElement:[],uponSanitizeShadowNode:[]}};function ir(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:ra();const e=A=>ir(A);if(e.version="3.3.0",e.removed=[],!t||!t.document||t.document.nodeType!==Ie.document||!t.Element)return e.isSupported=!1,e;let{document:n}=t;const a=n,i=a.currentScript,{DocumentFragment:s,HTMLTemplateElement:o,Node:p,Element:u,NodeFilter:d,NamedNodeMap:m=t.NamedNodeMap||t.MozNamedAttrMap,HTMLFormElement:c,DOMParser:h,trustedTypes:_}=t,b=u.prototype,w=Me(b,"cloneNode"),E=Me(b,"remove"),g=Me(b,"nextSibling"),f=Me(b,"childNodes"),v=Me(b,"parentNode");if(typeof o=="function"){const A=n.createElement("template");A.content&&A.content.ownerDocument&&(n=A.content.ownerDocument)}let S,T="";const{implementation:R,createNodeIterator:M,createDocumentFragment:I,getElementsByTagName:Z}=n,{importNode:re}=a;let O=Pn();e.isSupported=typeof nr=="function"&&typeof v=="function"&&R&&R.createHTMLDocument!==void 0;const{MUSTACHE_EXPR:j,ERB_EXPR:se,TMPLIT_EXPR:Ue,DATA_ATTR:F,ARIA_ATTR:ae,IS_SCRIPT_OR_DATA:ee,ATTR_WHITESPACE:He,CUSTOM_ELEMENT:$e}=Dn;let{IS_ALLOWED_URI:_e}=Dn,G=null;const Yt=C({},[...xn,...St,...wt,...At,...Mn]);let W=null;const Qt=C({},[...In,...Lt,...Fn,...je]);let P=Object.seal(Pt(null,{tagNameCheck:{writable:!0,configurable:!1,enumerable:!0,value:null},attributeNameCheck:{writable:!0,configurable:!1,enumerable:!0,value:null},allowCustomizedBuiltInElements:{writable:!0,configurable:!1,enumerable:!0,value:!1}})),Le=null,lt=null;const ge=Object.seal(Pt(null,{tagCheck:{writable:!0,configurable:!1,enumerable:!0,value:null},attributeCheck:{writable:!0,configurable:!1,enumerable:!0,value:null}}));let jt=!0,ct=!0,Kt=!1,Jt=!0,ye=!1,Ge=!0,pe=!1,dt=!1,ut=!1,ve=!1,qe=!1,We=!1,Zt=!0,en=!1;const ur="user-content-";let ht=!0,Ce=!1,Ee={},be=null;const tn=C({},["annotation-xml","audio","colgroup","desc","foreignobject","head","iframe","math","mi","mn","mo","ms","mtext","noembed","noframes","noscript","plaintext","script","style","svg","template","thead","title","video","xmp"]);let nn=null;const rn=C({},["audio","video","img","source","image","track"]);let pt=null;const an=C({},["alt","class","for","id","label","name","pattern","placeholder","role","summary","title","value","style","xmlns"]),ze="http://www.w3.org/1998/Math/MathML",Be="http://www.w3.org/2000/svg",le="http://www.w3.org/1999/xhtml";let Te=le,ft=!1,mt=null;const hr=C({},[ze,Be,le],Tt);let Xe=C({},["mi","mo","mn","ms","mtext"]),Ve=C({},["annotation-xml"]);const pr=C({},["title","style","font","a","script"]);let Re=null;const fr=["application/xhtml+xml","text/html"],mr="text/html";let q=null,Ne=null;const _r=n.createElement("form"),sn=function(l){return l instanceof RegExp||l instanceof Function},_t=function(){let l=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};if(!(Ne&&Ne===l)){if((!l||typeof l!="object")&&(l={}),l=ue(l),Re=fr.indexOf(l.PARSER_MEDIA_TYPE)===-1?mr:l.PARSER_MEDIA_TYPE,q=Re==="application/xhtml+xml"?Tt:tt,G=ie(l,"ALLOWED_TAGS")?C({},l.ALLOWED_TAGS,q):Yt,W=ie(l,"ALLOWED_ATTR")?C({},l.ALLOWED_ATTR,q):Qt,mt=ie(l,"ALLOWED_NAMESPACES")?C({},l.ALLOWED_NAMESPACES,Tt):hr,pt=ie(l,"ADD_URI_SAFE_ATTR")?C(ue(an),l.ADD_URI_SAFE_ATTR,q):an,nn=ie(l,"ADD_DATA_URI_TAGS")?C(ue(rn),l.ADD_DATA_URI_TAGS,q):rn,be=ie(l,"FORBID_CONTENTS")?C({},l.FORBID_CONTENTS,q):tn,Le=ie(l,"FORBID_TAGS")?C({},l.FORBID_TAGS,q):ue({}),lt=ie(l,"FORBID_ATTR")?C({},l.FORBID_ATTR,q):ue({}),Ee=ie(l,"USE_PROFILES")?l.USE_PROFILES:!1,jt=l.ALLOW_ARIA_ATTR!==!1,ct=l.ALLOW_DATA_ATTR!==!1,Kt=l.ALLOW_UNKNOWN_PROTOCOLS||!1,Jt=l.ALLOW_SELF_CLOSE_IN_ATTR!==!1,ye=l.SAFE_FOR_TEMPLATES||!1,Ge=l.SAFE_FOR_XML!==!1,pe=l.WHOLE_DOCUMENT||!1,ve=l.RETURN_DOM||!1,qe=l.RETURN_DOM_FRAGMENT||!1,We=l.RETURN_TRUSTED_TYPE||!1,ut=l.FORCE_BODY||!1,Zt=l.SANITIZE_DOM!==!1,en=l.SANITIZE_NAMED_PROPS||!1,ht=l.KEEP_CONTENT!==!1,Ce=l.IN_PLACE||!1,_e=l.ALLOWED_URI_REGEXP||rr,Te=l.NAMESPACE||le,Xe=l.MATHML_TEXT_INTEGRATION_POINTS||Xe,Ve=l.HTML_INTEGRATION_POINTS||Ve,P=l.CUSTOM_ELEMENT_HANDLING||{},l.CUSTOM_ELEMENT_HANDLING&&sn(l.CUSTOM_ELEMENT_HANDLING.tagNameCheck)&&(P.tagNameCheck=l.CUSTOM_ELEMENT_HANDLING.tagNameCheck),l.CUSTOM_ELEMENT_HANDLING&&sn(l.CUSTOM_ELEMENT_HANDLING.attributeNameCheck)&&(P.attributeNameCheck=l.CUSTOM_ELEMENT_HANDLING.attributeNameCheck),l.CUSTOM_ELEMENT_HANDLING&&typeof l.CUSTOM_ELEMENT_HANDLING.allowCustomizedBuiltInElements=="boolean"&&(P.allowCustomizedBuiltInElements=l.CUSTOM_ELEMENT_HANDLING.allowCustomizedBuiltInElements),ye&&(ct=!1),qe&&(ve=!0),Ee&&(G=C({},Mn),W=[],Ee.html===!0&&(C(G,xn),C(W,In)),Ee.svg===!0&&(C(G,St),C(W,Lt),C(W,je)),Ee.svgFilters===!0&&(C(G,wt),C(W,Lt),C(W,je)),Ee.mathMl===!0&&(C(G,At),C(W,Fn),C(W,je))),l.ADD_TAGS&&(typeof l.ADD_TAGS=="function"?ge.tagCheck=l.ADD_TAGS:(G===Yt&&(G=ue(G)),C(G,l.ADD_TAGS,q))),l.ADD_ATTR&&(typeof l.ADD_ATTR=="function"?ge.attributeCheck=l.ADD_ATTR:(W===Qt&&(W=ue(W)),C(W,l.ADD_ATTR,q))),l.ADD_URI_SAFE_ATTR&&C(pt,l.ADD_URI_SAFE_ATTR,q),l.FORBID_CONTENTS&&(be===tn&&(be=ue(be)),C(be,l.FORBID_CONTENTS,q)),ht&&(G["#text"]=!0),pe&&C(G,["html","head","body"]),G.table&&(C(G,["tbody"]),delete Le.tbody),l.TRUSTED_TYPES_POLICY){if(typeof l.TRUSTED_TYPES_POLICY.createHTML!="function")throw xe('TRUSTED_TYPES_POLICY configuration option must provide a "createHTML" hook.');if(typeof l.TRUSTED_TYPES_POLICY.createScriptURL!="function")throw xe('TRUSTED_TYPES_POLICY configuration option must provide a "createScriptURL" hook.');S=l.TRUSTED_TYPES_POLICY,T=S.createHTML("")}else S===void 0&&(S=aa(_,i)),S!==null&&typeof T=="string"&&(T=S.createHTML(""));Y&&Y(l),Ne=l}},on=C({},[...St,...wt,...Vr]),ln=C({},[...At,...Yr]),gr=function(l){let y=v(l);(!y||!y.tagName)&&(y={namespaceURI:Te,tagName:"template"});const N=tt(l.tagName),D=tt(y.tagName);return mt[l.namespaceURI]?l.namespaceURI===Be?y.namespaceURI===le?N==="svg":y.namespaceURI===ze?N==="svg"&&(D==="annotation-xml"||Xe[D]):!!on[N]:l.namespaceURI===ze?y.namespaceURI===le?N==="math":y.namespaceURI===Be?N==="math"&&Ve[D]:!!ln[N]:l.namespaceURI===le?y.namespaceURI===Be&&!Ve[D]||y.namespaceURI===ze&&!Xe[D]?!1:!ln[N]&&(pr[N]||!on[N]):!!(Re==="application/xhtml+xml"&&mt[l.namespaceURI]):!1},oe=function(l){Oe(e.removed,{element:l});try{v(l).removeChild(l)}catch{E(l)}},fe=function(l,y){try{Oe(e.removed,{attribute:y.getAttributeNode(l),from:y})}catch{Oe(e.removed,{attribute:null,from:y})}if(y.removeAttribute(l),l==="is")if(ve||qe)try{oe(y)}catch{}else try{y.setAttribute(l,"")}catch{}},cn=function(l){let y=null,N=null;if(ut)l="<remove></remove>"+l;else{const H=Nt(l,/^[\r\n\t ]+/);N=H&&H[0]}Re==="application/xhtml+xml"&&Te===le&&(l='<html xmlns="http://www.w3.org/1999/xhtml"><head></head><body>'+l+"</body></html>");const D=S?S.createHTML(l):l;if(Te===le)try{y=new h().parseFromString(D,Re)}catch{}if(!y||!y.documentElement){y=R.createDocument(Te,"template",null);try{y.documentElement.innerHTML=ft?T:D}catch{}}const B=y.body||y.documentElement;return l&&N&&B.insertBefore(n.createTextNode(N),B.childNodes[0]||null),Te===le?Z.call(y,pe?"html":"body")[0]:pe?y.documentElement:B},dn=function(l){return M.call(l.ownerDocument||l,l,d.SHOW_ELEMENT|d.SHOW_COMMENT|d.SHOW_TEXT|d.SHOW_PROCESSING_INSTRUCTION|d.SHOW_CDATA_SECTION,null)},gt=function(l){return l instanceof c&&(typeof l.nodeName!="string"||typeof l.textContent!="string"||typeof l.removeChild!="function"||!(l.attributes instanceof m)||typeof l.removeAttribute!="function"||typeof l.setAttribute!="function"||typeof l.namespaceURI!="string"||typeof l.insertBefore!="function"||typeof l.hasChildNodes!="function")},un=function(l){return typeof p=="function"&&l instanceof p};function ce(A,l,y){Qe(A,N=>{N.call(e,l,y,Ne)})}const hn=function(l){let y=null;if(ce(O.beforeSanitizeElements,l,null),gt(l))return oe(l),!0;const N=q(l.nodeName);if(ce(O.uponSanitizeElement,l,{tagName:N,allowedTags:G}),Ge&&l.hasChildNodes()&&!un(l.firstElementChild)&&X(/<[/\w!]/g,l.innerHTML)&&X(/<[/\w!]/g,l.textContent)||l.nodeType===Ie.progressingInstruction||Ge&&l.nodeType===Ie.comment&&X(/<[/\w]/g,l.data))return oe(l),!0;if(!(ge.tagCheck instanceof Function&&ge.tagCheck(N))&&(!G[N]||Le[N])){if(!Le[N]&&fn(N)&&(P.tagNameCheck instanceof RegExp&&X(P.tagNameCheck,N)||P.tagNameCheck instanceof Function&&P.tagNameCheck(N)))return!1;if(ht&&!be[N]){const D=v(l)||l.parentNode,B=f(l)||l.childNodes;if(B&&D){const H=B.length;for(let K=H-1;K>=0;--K){const de=w(B[K],!0);de.__removalCount=(l.__removalCount||0)+1,D.insertBefore(de,g(l))}}}return oe(l),!0}return l instanceof u&&!gr(l)||(N==="noscript"||N==="noembed"||N==="noframes")&&X(/<\/no(script|embed|frames)/i,l.innerHTML)?(oe(l),!0):(ye&&l.nodeType===Ie.text&&(y=l.textContent,Qe([j,se,Ue],D=>{y=ke(y,D," ")}),l.textContent!==y&&(Oe(e.removed,{element:l.cloneNode()}),l.textContent=y)),ce(O.afterSanitizeElements,l,null),!1)},pn=function(l,y,N){if(Zt&&(y==="id"||y==="name")&&(N in n||N in _r))return!1;if(!(ct&&!lt[y]&&X(F,y))){if(!(jt&&X(ae,y))){if(!(ge.attributeCheck instanceof Function&&ge.attributeCheck(y,l))){if(!W[y]||lt[y]){if(!(fn(l)&&(P.tagNameCheck instanceof RegExp&&X(P.tagNameCheck,l)||P.tagNameCheck instanceof Function&&P.tagNameCheck(l))&&(P.attributeNameCheck instanceof RegExp&&X(P.attributeNameCheck,y)||P.attributeNameCheck instanceof Function&&P.attributeNameCheck(y,l))||y==="is"&&P.allowCustomizedBuiltInElements&&(P.tagNameCheck instanceof RegExp&&X(P.tagNameCheck,N)||P.tagNameCheck instanceof Function&&P.tagNameCheck(N))))return!1}else if(!pt[y]){if(!X(_e,ke(N,He,""))){if(!((y==="src"||y==="xlink:href"||y==="href")&&l!=="script"&&Wr(N,"data:")===0&&nn[l])){if(!(Kt&&!X(ee,ke(N,He,"")))){if(N)return!1}}}}}}}return!0},fn=function(l){return l!=="annotation-xml"&&Nt(l,$e)},mn=function(l){ce(O.beforeSanitizeAttributes,l,null);const{attributes:y}=l;if(!y||gt(l))return;const N={attrName:"",attrValue:"",keepAttr:!0,allowedAttributes:W,forceKeepAttr:void 0};let D=y.length;for(;D--;){const B=y[D],{name:H,namespaceURI:K,value:de}=B,Se=q(H),yt=de;let z=H==="value"?yt:zr(yt);if(N.attrName=Se,N.attrValue=z,N.keepAttr=!0,N.forceKeepAttr=void 0,ce(O.uponSanitizeAttribute,l,N),z=N.attrValue,en&&(Se==="id"||Se==="name")&&(fe(H,l),z=ur+z),Ge&&X(/((--!?|])>)|<\/(style|title|textarea)/i,z)){fe(H,l);continue}if(Se==="attributename"&&Nt(z,"href")){fe(H,l);continue}if(N.forceKeepAttr)continue;if(!N.keepAttr){fe(H,l);continue}if(!Jt&&X(/\/>/i,z)){fe(H,l);continue}ye&&Qe([j,se,Ue],gn=>{z=ke(z,gn," ")});const _n=q(l.nodeName);if(!pn(_n,Se,z)){fe(H,l);continue}if(S&&typeof _=="object"&&typeof _.getAttributeType=="function"&&!K)switch(_.getAttributeType(_n,Se)){case"TrustedHTML":{z=S.createHTML(z);break}case"TrustedScriptURL":{z=S.createScriptURL(z);break}}if(z!==yt)try{K?l.setAttributeNS(K,H,z):l.setAttribute(H,z),gt(l)?oe(l):kn(e.removed)}catch{fe(H,l)}}ce(O.afterSanitizeAttributes,l,null)},yr=function A(l){let y=null;const N=dn(l);for(ce(O.beforeSanitizeShadowDOM,l,null);y=N.nextNode();)ce(O.uponSanitizeShadowNode,y,null),hn(y),mn(y),y.content instanceof s&&A(y.content);ce(O.afterSanitizeShadowDOM,l,null)};return e.sanitize=function(A){let l=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{},y=null,N=null,D=null,B=null;if(ft=!A,ft&&(A="<!-->"),typeof A!="string"&&!un(A))if(typeof A.toString=="function"){if(A=A.toString(),typeof A!="string")throw xe("dirty is not a string, aborting")}else throw xe("toString is not a function");if(!e.isSupported)return A;if(dt||_t(l),e.removed=[],typeof A=="string"&&(Ce=!1),Ce){if(A.nodeName){const de=q(A.nodeName);if(!G[de]||Le[de])throw xe("root node is forbidden and cannot be sanitized in-place")}}else if(A instanceof p)y=cn("<!---->"),N=y.ownerDocument.importNode(A,!0),N.nodeType===Ie.element&&N.nodeName==="BODY"||N.nodeName==="HTML"?y=N:y.appendChild(N);else{if(!ve&&!ye&&!pe&&A.indexOf("<")===-1)return S&&We?S.createHTML(A):A;if(y=cn(A),!y)return ve?null:We?T:""}y&&ut&&oe(y.firstChild);const H=dn(Ce?A:y);for(;D=H.nextNode();)hn(D),mn(D),D.content instanceof s&&yr(D.content);if(Ce)return A;if(ve){if(qe)for(B=I.call(y.ownerDocument);y.firstChild;)B.appendChild(y.firstChild);else B=y;return(W.shadowroot||W.shadowrootmode)&&(B=re.call(a,B,!0)),B}let K=pe?y.outerHTML:y.innerHTML;return pe&&G["!doctype"]&&y.ownerDocument&&y.ownerDocument.doctype&&y.ownerDocument.doctype.name&&X(ar,y.ownerDocument.doctype.name)&&(K="<!DOCTYPE "+y.ownerDocument.doctype.name+`>
`+K),ye&&Qe([j,se,Ue],de=>{K=ke(K,de," ")}),S&&We?S.createHTML(K):K},e.setConfig=function(){let A=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};_t(A),dt=!0},e.clearConfig=function(){Ne=null,dt=!1},e.isValidAttribute=function(A,l,y){Ne||_t({});const N=q(A),D=q(l);return pn(N,D,y)},e.addHook=function(A,l){typeof l=="function"&&Oe(O[A],l)},e.removeHook=function(A,l){if(l!==void 0){const y=Gr(O[A],l);return y===-1?void 0:qr(O[A],y,1)[0]}return kn(O[A])},e.removeHooks=function(A){O[A]=[]},e.removeAllHooks=function(){O=Pn()},e}var Xt=ir();function ia({mode:t,onModeChange:e,showToggle:n=!0}){return n?r("div",{className:"search-mode-toggle",children:[r("button",{className:`mode-btn ${t==="fts"?"active":""}`,onClick:()=>e("fts"),children:"ðŸ“ FTS Only"}),r("button",{className:`mode-btn ${t==="hybrid"?"active":""}`,onClick:()=>e("hybrid"),children:"âš¡ Hybrid"}),r("button",{className:`mode-btn ${t==="graph"?"active":""}`,onClick:()=>e("graph"),children:"ðŸ•¸ï¸ Graph"})]}):null}function sa({onSearch:t,loading:e,placeholder:n,searchHistory:a,onClearHistory:i}){return r(te,{children:[r("form",{onSubmit:s=>{s.preventDefault();const p=new FormData(s.currentTarget).get("query");p!=null&&p.trim()&&t(p.trim())},children:r("div",{className:"search-bar",children:[r("input",{type:"text",name:"query",placeholder:n||"Search the capsule...",className:"search-input",disabled:e}),r("button",{type:"submit",className:"btn-search",disabled:e,children:e?"Searching...":"Search"})]})}),a&&a.length>0&&r("div",{className:"search-history",children:[r("div",{className:"search-history-header",children:[r("span",{className:"search-history-label",children:"Recent searches:"}),i&&r("button",{className:"search-history-clear",onClick:i,type:"button",children:"Clear"})]}),r("div",{className:"search-history-items",children:a.map((s,o)=>r("button",{className:"search-history-item",onClick:()=>t(s),type:"button",children:s},o))})]})]})}function oa({results:t,query:e,onResultClick:n}){return r("div",{className:"search-results",children:[r("p",{className:"results-header",children:["Found ",t.length," results for ",r("strong",{children:['"',e,'"']})]}),t.map(a=>r("div",{className:`result-item ${n?"result-item-clickable":""}`,onClick:()=>n==null?void 0:n(a.gid),style:{cursor:n?"pointer":"default"},children:[r("div",{className:"result-header",children:[r("span",{className:"result-page",children:["Page ",a.pageNo]}),r("span",{className:"result-score",children:["Score: ",a.scores.final.toFixed(3)]})]}),r("h4",{className:"result-title",children:a.title}),a.snippet&&r("p",{className:"result-snippet",dangerouslySetInnerHTML:{__html:Xt.sanitize(a.snippet,{ALLOWED_TAGS:["mark","strong","em","b","i"],ALLOWED_ATTR:[]})}}),r("div",{className:"result-scores",children:[r("span",{children:["FTS: ",a.scores.fts.toFixed(2)]}),r("span",{children:["Entity: ",a.scores.entity.toFixed(2)]}),r("span",{children:["Graph: ",a.scores.graph.toFixed(2)]})]})]},a.gid))]})}function la({mode:t,results:e,lastQuery:n,loading:a,onSearch:i,onModeChange:s,onResultClick:o,showModeToggle:p=!0,placeholder:u,searchHint:d,searchHistory:m,onClearHistory:c}){return r("div",{className:"search-section",children:[r("div",{className:"search-header",children:r("h3",{children:"ðŸ” Search"})}),r(ia,{mode:t,onModeChange:s,showToggle:p}),d&&r("p",{className:"search-hint",children:d}),r("div",{className:"keyboard-shortcuts-hint",children:[r("span",{className:"shortcut-item",children:[r("kbd",{children:"/"})," Focus search"]}),r("span",{className:"shortcut-item",children:[r("kbd",{children:"Ctrl+L"})," Toggle LLM"]}),r("span",{className:"shortcut-item",children:[r("kbd",{children:"Esc"})," Clear focus"]})]}),r(sa,{onSearch:i,loading:a,placeholder:u,searchHistory:m,onClearHistory:c}),e&&e.length>0&&r(oa,{results:e,query:n,onResultClick:o}),e&&e.length===0&&r("div",{className:"no-results",children:[r("p",{children:["No results found for ",r("strong",{children:['"',n,'"']})]}),r("p",{className:"search-hint",children:"Try different keywords or search terms."})]})]})}function sr(t={}){const{autoLoad:e=!0,maxEntities:n=50}=t,[a,i]=L([]),[s,o]=L(null),[p,u]=L(!1),[d,m]=L(null),c=async()=>{u(!0),m(null);try{const f=await J().listEntities(void 0,n);i(f),console.log("[Entities] Loaded:",f.length)}catch(g){const f=String(g);m(f),console.error("[Entities] Failed to load:",g)}finally{u(!1)}};V(()=>{e&&c()},[e]);const h=g=>{o(g)},_=()=>Array.from(new Set(a.map(g=>g.entityType))),b=()=>s?a.filter(g=>g.entityType===s):a,w=g=>a.filter(f=>f.entityType===g).reduce((f,v)=>f+v.count,0),E=()=>a.reduce((g,f)=>g+f.count,0);return{entities:a,selectedType:s,loading:p,error:d,types:_(),filteredEntities:b(),totalCount:E(),loadEntities:c,selectType:h,getTypeCount:w}}function ca({types:t,selectedType:e,totalCount:n,onSelectType:a,getTypeCount:i}){return r("div",{className:"entity-filters",children:[r("button",{className:`entity-filter ${e===null?"active":""}`,onClick:()=>a(null),children:["All (",n,")"]}),t.map(s=>{const o=i(s);return r("button",{className:`entity-filter ${e===s?"active":""}`,onClick:()=>a(s),children:[s," (",o,")"]},s)})]})}function da({entities:t,maxDisplay:e=20}){const n=t.slice(0,e);return r("div",{className:"entity-list",children:[n.map(a=>r("div",{className:"entity-item",children:[r("span",{className:"entity-type",children:a.entityType}),r("span",{className:"entity-value",children:a.normalizedValue}),r("span",{className:"entity-count",children:a.count})]},`${a.entityType}-${a.normalizedValue}`)),t.length>e&&r("div",{className:"entity-item entity-more",children:r("span",{className:"entity-value",children:["... and ",t.length-e," more"]})})]})}function ua({entities:t,types:e,selectedType:n,totalCount:a,onSelectType:i,getTypeCount:s,show:o=!0,maxDisplay:p=20}){if(!o||t.length===0)return null;const u=n?t.filter(d=>d.entityType===n):t;return r("div",{className:"entity-panel",children:[r("h4",{children:"Filter by Entity Type"}),r(ca,{types:e,selectedType:n,totalCount:a,onSelectType:i,getTypeCount:s}),r(da,{entities:u,maxDisplay:p})]})}class ha{constructor(){k(this,"worker",null);k(this,"nextId",1);k(this,"pending",new Map);k(this,"progressCallback",null);this.initWorker()}initWorker(){this.worker=new Worker(new URL("/assets/llm.worker-BXtIo8pX.js",import.meta.url),{type:"module"}),this.worker.onmessage=e=>{const n=e.data;if("type"in n&&n.type==="READY"){console.log("[LlmClient] Worker ready");return}if("type"in n&&n.type==="PROGRESS"){this.progressCallback&&this.progressCallback(n.data);return}const{id:a,response:i}=n,s=this.pending.get(a);s&&(this.pending.delete(a),s.resolve(i))},this.worker.onerror=e=>{console.error("[LlmClient] Worker error:",e);for(const n of this.pending.values())n.reject(new Error("Worker error"));this.pending.clear()}}async sendRequest(e){if(!this.worker)throw new Error("Worker not initialized");const n=this.nextId++;return new Promise((a,i)=>{this.pending.set(n,{resolve:o=>{o.ok?a(o.data):i(new Error(o.error))},reject:i});const s={id:n,request:e};this.worker.postMessage(s)})}onProgress(e){this.progressCallback=e}async loadModel(e){return this.sendRequest({type:"LOAD_MODEL",modelUrl:e})}async reason(e){return this.sendRequest({type:"REASON",request:e})}async unloadModel(){return this.sendRequest({type:"UNLOAD_MODEL"})}async getStatus(){return this.sendRequest({type:"GET_STATUS"})}terminate(){this.worker&&(this.worker.terminate(),this.worker=null),this.pending.clear(),this.progressCallback=null}}let Ct=null;function Un(){return Ct||(Ct=new ha),Ct}const pa={"0.6b":"https://huggingface.co/unsloth/Qwen3-0.6B-GGUF/resolve/main/Qwen3-0.6B-Q4_K_M.gguf","1.5b":"https://huggingface.co/ggml-org/Qwen2.5-1.5B-Instruct-GGUF/resolve/main/qwen2.5-1.5b-instruct-q4_k_m.gguf"};function or(t={}){const[e,n]=L(!1),[a,i]=L(null),[s,o]=L(!1),[p,u]=L(null),[d,m]=L(null),[c,h]=L(null),[_,b]=L(0),[w,E]=L(.7),g=at(0),f=at(null);V(()=>{if(s&&!p)return g.current=Date.now(),b(0),f.current=window.setInterval(()=>{const M=(Date.now()-g.current)/1e3;b(M)},100),()=>{f.current&&clearInterval(f.current)};f.current&&(clearInterval(f.current),f.current=null),b(0)},[s,p]);const v=async()=>{o(!0),h(null),u(null);try{const M=Un();M.onProgress(Z=>{u(Z)});const I=await M.loadModel(pa["0.6b"]);i(I),u(null),console.log("[LLM] Model loaded:",I)}catch(M){const I=String(M);h(I),console.error("[LLM] Failed to load model:",M)}finally{o(!1)}};return{enabled:e,modelInfo:a,loading:s,progress:p,reasoning:d,error:c,elapsedTime:_,temperature:w,toggle:async()=>{e?(n(!1),m(null)):(a!=null&&a.loaded||await v(),n(!0))},loadModel:v,reason:async(M,I,Z=256)=>{if(!(a!=null&&a.loaded)){console.warn("[LLM] Cannot reason: model not loaded");return}o(!0),h(null);try{const re=Un(),O=I.slice(0,5).map(se=>({gid:se.gid,pageNo:se.pageNo,title:se.title,text:se.snippet||"",score:se.scores.final})),j=await re.reason({question:M,snippets:O,maxTokens:Z,temperature:w});m(j),console.log("[LLM] Reasoning complete:",j)}catch(re){const O=String(re);h(O),console.error("[LLM] Reasoning failed:",re)}finally{o(!1)}},clearReasoning:()=>{m(null)},setTemperature:E}}function fa({reasoning:t,searchResults:e,loading:n}){const[a,i]=L(null);return n&&!t?r("div",{className:"reasoning-loading",children:[r("div",{className:"spinner"}),r("p",{children:"LLM is reasoning..."})]}):t?r("div",{className:"reasoning-output",children:[r("div",{className:"reasoning-header",children:[r("h4",{children:"ðŸ¤– LLM Reasoning"}),r("span",{className:"reasoning-meta",children:[t.inferenceTimeMs.toFixed(0),"ms Â· ",t.tokensGenerated," tokens"]})]}),r("div",{className:"reasoning-answer",children:t.answer}),t.usedSnippets.length>0&&r("div",{className:"reasoning-citations",children:[r("strong",{children:"ðŸ“‘ Cited sources:"}),t.usedSnippets.map(s=>{const o=e==null?void 0:e.find(p=>p.gid===s);return r("span",{className:"citation",onMouseEnter:()=>i(s),onMouseLeave:()=>i(null),style:{position:"relative"},children:["Page ",(o==null?void 0:o.pageNo)||"?",a===s&&o&&r("div",{className:"citation-tooltip",children:[r("div",{className:"citation-tooltip-title",children:o.title}),o.snippet&&r("div",{className:"citation-tooltip-snippet",dangerouslySetInnerHTML:{__html:Xt.sanitize(o.snippet,{ALLOWED_TAGS:["mark","strong","em","b","i"],ALLOWED_ATTR:[]})}}),r("div",{className:"citation-tooltip-meta",children:["Score: ",o.scores.final.toFixed(3)," â€¢ GID: ",s.slice(0,8),"..."]})]})]},s)})]})]}):null}function we(){return typeof navigator<"u"&&"storage"in navigator&&"getDirectory"in navigator.storage}async function ma(){if(!we())throw new Error("OPFS not supported in this browser");return await navigator.storage.getDirectory()}async function _a(){return await(await ma()).getDirectoryHandle("capsules",{create:!0})}function ga(t){const e=t.replace(/[^a-z0-9._-]/gi,"-");return e.endsWith(".mgx.sqlite")?e:`${e}.mgx.sqlite`}async function ya(t,e){if(!we())throw new Error("OPFS not supported - cannot persist file");const n=await _a(),a=e||ga(t.name),s=await(await n.getFileHandle(a,{create:!0})).createWritable();try{return await s.write(t),await s.close(),console.log(`[OPFS] Copied file to ${a} (${t.size} bytes)`),{path:a,size:t.size}}catch(o){throw await s.close(),o}}async function va(){if(!navigator.storage||!navigator.storage.estimate)return null;try{const t=await navigator.storage.estimate(),e=t.usage||0,n=t.quota||0;return{usage:e,quota:n,available:n-e,percentUsed:n>0?e/n*100:0}}catch(t){return console.error("[OPFS] Failed to get storage quota:",t),null}}async function Ea(){if(!navigator.storage||!navigator.storage.persist)return!1;try{const t=await navigator.storage.persist();return console.log(`[OPFS] Persistent storage: ${t}`),t}catch(t){return console.error("[OPFS] Failed to request persistent storage:",t),!1}}function Fe(t){if(t===0)return"0 B";const e=1024,n=["B","KB","MB","GB"],a=Math.floor(Math.log(t)/Math.log(e));return`${(t/Math.pow(e,a)).toFixed(2)} ${n[a]}`}async function ba(t,e=500*1024*1024){if(t.size===0)return{valid:!1,error:"File is empty"};if(t.size>e)return{valid:!1,error:`File too large (${Fe(t.size)} > ${Fe(e)})`};const n=t.name.toLowerCase();if(!n.endsWith(".mgx.sqlite")&&!n.endsWith(".sqlite"))return{valid:!1,error:"File must have .mgx.sqlite or .sqlite extension"};try{const a=await t.slice(0,16).arrayBuffer();if(!new TextDecoder().decode(a).startsWith("SQLite format 3"))return{valid:!1,error:"Not a valid SQLite file (invalid header)"}}catch(a){return{valid:!1,error:`Failed to read file header: ${a}`}}return{valid:!0}}function Ta({onFileSelected:t,onOpfsFileSelected:e,onError:n}){const[a,i]=L([]),[s,o]=L(null),[p,u]=L(!1),[d,m]=L(!1),c=J();V(()=>{h(),_()},[]);async function h(){try{const f=await c.listOpfsFiles();i(f)}catch(f){console.error("[FilePicker] Failed to list OPFS files:",f)}}async function _(){var f,v;try{const S=await va();o(S);const T=await((v=(f=navigator.storage)==null?void 0:f.persisted)==null?void 0:v.call(f));m(T||!1)}catch(S){console.error("[FilePicker] Failed to get quota:",S)}}async function b(f){var T;const v=f.target,S=(T=v.files)==null?void 0:T[0];if(S){u(!0);try{const R=await ba(S);if(!R.valid){n(R.error),u(!1);return}if(we()){const{path:M}=await ya(S);await h(),await _(),t(S,M)}else t(S)}catch(R){n(`Failed to load file: ${R}`)}finally{u(!1),v.value=""}}}async function w(f){u(!0);try{e(f)}catch(v){n(`Failed to open from OPFS: ${v}`)}finally{u(!1)}}async function E(f,v){if(v.stopPropagation(),!!confirm(`Remove "${f}" from device storage?`))try{await c.removeFromOpfs(f),await h(),await _()}catch(S){n(`Failed to remove file: ${S}`)}}async function g(){try{await Ea()?m(!0):n("Persistent storage not granted. Files may be evicted under storage pressure.")}catch(f){n(`Failed to request persistence: ${f}`)}}return r("div",{class:"file-picker",children:[r("div",{class:"file-picker-header",children:[r("h2",{children:"Open Capsule"}),s&&r("div",{class:"storage-quota",children:[r("div",{class:"quota-bar",children:r("div",{class:"quota-used",style:`width: ${Math.min(s.percentUsed,100)}%`})}),r("p",{class:"quota-text",children:[Fe(s.usage)," / ",Fe(s.quota)," used (",s.percentUsed.toFixed(1),"%)"]}),!d&&we()&&r("button",{class:"btn-secondary btn-sm",onClick:g,children:"Request Persistent Storage"})]})]}),r("div",{class:"file-input-section",children:[r("label",{class:"file-input-label",children:[r("input",{type:"file",accept:".mgx.sqlite,.sqlite",onChange:b,disabled:p,style:"display: none"}),r("button",{class:"btn-primary",disabled:p,children:p?"Loading...":"Select File from Device"})]}),r("p",{class:"help-text",children:"Choose a .mgx.sqlite or .sqlite file from your device"})]}),we()&&a.length>0&&r("div",{class:"opfs-files-section",children:[r("h3",{children:"Stored on Device"}),r("ul",{class:"opfs-files-list",children:a.map(f=>r("li",{class:"opfs-file-item",children:[r("button",{class:"opfs-file-button",onClick:()=>w(f.path),disabled:p,children:r("div",{class:"file-info",children:[r("span",{class:"file-name",children:f.path}),r("span",{class:"file-meta",children:[Fe(f.size)," â€¢"," ",new Date(f.lastModified).toLocaleDateString()]})]})}),r("button",{class:"btn-remove",onClick:v=>E(f.path,v),title:"Remove from device","aria-label":"Remove from device",children:"Ã—"})]},f.path))})]}),!we()&&r("div",{class:"opfs-warning",children:r("p",{children:[r("strong",{children:"Note:"})," Your browser doesn't support persistent storage. Files will only be kept in memory and lost when you close the tab."]})})]})}function Na(t={}){const{autoLoad:e=!1,maxHops:n=2,limit:a=50}=t,[i,s]=L(null),[o,p]=L(null),[u,d]=L(void 0),[m,c]=L(!1),[h,_]=L(null),b=async(T,R)=>{c(!0),_(null),p(T),d(R);try{const I=await J().graphHops(T,R,n,a);s(I),console.log("[Graph] Loaded:",I.nodes.length,"nodes,",I.edges.length,"edges")}catch(M){const I=String(M);_(I),console.error("[Graph] Failed to load:",M)}finally{c(!1)}},w=async T=>{await b(T,u)},E=async T=>{o&&await b(o,T)},g=()=>{s(null),p(null),d(void 0),_(null)},f=()=>i?Array.from(new Set(i.edges.map(T=>T.predicate))):[],v=T=>i==null?void 0:i.nodes.find(R=>R.gid===T),S=T=>i?i.edges.filter(R=>R.fromGid===T):[];return V(()=>{e&&o&&b(o,u)},[e]),{graphData:i,seedGid:o,predicate:u,loading:m,error:h,predicates:f(),nodeCount:(i==null?void 0:i.nodes.length)||0,edgeCount:(i==null?void 0:i.edges.length)||0,loadGraph:b,navigateToNode:w,filterByPredicate:E,clear:g,getNode:v,getNodeEdges:S}}function Sa({nodes:t,edges:e,seedGid:n,onNodeClick:a,width:i=800,height:s=600}){const[o,p]=L(new Map),u=at();return V(()=>{const d=new Map,m=i/2,c=s/2;t.forEach((h,_)=>{const b=_/t.length*2*Math.PI,w=Math.min(i,s)/3;d.set(h.gid,{gid:h.gid,x:m+w*Math.cos(b),y:c+w*Math.sin(b),vx:0,vy:0})}),p(d)},[t,i,s]),V(()=>{if(o.size===0)return;const d=()=>{const c=new Map(o),h=.3;c.forEach(_=>{c.forEach(b=>{if(_.gid===b.gid)return;const w=b.x-_.x,E=b.y-_.y,g=w*w+E*E+1,f=Math.sqrt(g),v=2e3/g;_.vx-=w/f*v*h,_.vy-=E/f*v*h})}),e.forEach(_=>{const b=c.get(_.fromGid),w=c.get(_.toGid);if(!b||!w)return;const E=w.x-b.x,g=w.y-b.y,f=Math.sqrt(E*E+g*g)+1,v=f*.01;b.vx+=E/f*v*h,b.vy+=g/f*v*h,w.vx-=E/f*v*h,w.vy-=g/f*v*h}),c.forEach(_=>{_.x+=_.vx,_.y+=_.vy,_.vx*=.8,_.vy*=.8,_.x=Math.max(30,Math.min(i-30,_.x)),_.y=Math.max(30,Math.min(s-30,_.y))}),p(c),u.current=requestAnimationFrame(d)};u.current=requestAnimationFrame(d);const m=setTimeout(()=>{u.current&&cancelAnimationFrame(u.current)},3e3);return()=>{u.current&&cancelAnimationFrame(u.current),clearTimeout(m)}},[e,i,s]),r("svg",{width:i,height:s,className:"graph-view",style:{border:"1px solid var(--color-border)",borderRadius:"8px"},children:[r("g",{className:"graph-edges",children:e.map((d,m)=>{const c=o.get(d.fromGid),h=o.get(d.toGid);return!c||!h?null:r("line",{x1:c.x,y1:c.y,x2:h.x,y2:h.y,stroke:"#94a3b8",strokeWidth:Math.max(1,d.weight*2),strokeOpacity:.6,markerEnd:"url(#arrowhead)"},`${d.fromGid}-${d.toGid}-${m}`)})}),r("defs",{children:r("marker",{id:"arrowhead",markerWidth:"10",markerHeight:"10",refX:"9",refY:"3",orient:"auto",markerUnits:"strokeWidth",children:r("path",{d:"M0,0 L0,6 L9,3 z",fill:"#94a3b8"})})}),r("g",{className:"graph-nodes",children:t.map(d=>{const m=o.get(d.gid);if(!m)return null;const c=d.gid===n,h=c?12:8,_=c?"#3b82f6":"#64748b";return r("g",{className:"graph-node",onClick:()=>a==null?void 0:a(d.gid),style:{cursor:a?"pointer":"default"},children:[r("circle",{cx:m.x,cy:m.y,r:h,fill:_,stroke:"#ffffff",strokeWidth:2,opacity:.9}),r("text",{x:m.x,y:m.y-h-5,textAnchor:"middle",fontSize:"11",fill:"var(--color-fg)",style:{pointerEvents:"none",userSelect:"none"},children:d.title||`Page ${d.pageNo}`})]},d.gid)})})]})}function wa({nodes:t,edges:e,seedGid:n,onNodeClick:a,loading:i,error:s}){return i?r("div",{className:"graph-panel-loading",children:[r("div",{className:"spinner"}),r("p",{children:"Loading graph..."})]}):s?r("div",{className:"graph-panel-error",children:r("p",{children:["Error: ",s]})}):t.length===0?r("div",{className:"graph-panel-empty",children:[r("p",{children:"No graph data to display"}),r("p",{className:"hint",children:"Search for a page or select a result to explore its connections"})]}):r("div",{className:"graph-panel",children:[r("div",{className:"graph-info",children:[r("span",{children:[t.length," nodes"]}),r("span",{children:[e.length," edges"]})]}),r(Sa,{nodes:t,edges:e,seedGid:n,onNodeClick:a,width:800,height:600})]})}function Aa({predicates:t,selectedPredicate:e,onPredicateChange:n,onReset:a}){return r("div",{className:"graph-controls",children:[r("div",{className:"graph-controls-section",children:[r("label",{className:"graph-controls-label",children:"Filter by Relationship:"}),r("select",{className:"graph-controls-select",value:e||"",onChange:i=>{const s=i.target.value;n(s||void 0)},children:[r("option",{value:"",children:"All Relationships"}),t.map(i=>r("option",{value:i,children:i},i))]})]}),a&&r("button",{className:"btn-secondary btn-sm",onClick:a,children:"Reset View"})]})}function La({nodeCount:t,edgeCount:e,predicateCount:n,seedNode:a}){return r("div",{className:"graph-stats",children:[r("div",{className:"graph-stat",children:[r("span",{className:"graph-stat-label",children:"Nodes:"}),r("span",{className:"graph-stat-value",children:t})]}),r("div",{className:"graph-stat",children:[r("span",{className:"graph-stat-label",children:"Edges:"}),r("span",{className:"graph-stat-value",children:e})]}),r("div",{className:"graph-stat",children:[r("span",{className:"graph-stat-label",children:"Relationships:"}),r("span",{className:"graph-stat-value",children:n})]}),a&&r("div",{className:"graph-stat",children:[r("span",{className:"graph-stat-label",children:"Seed:"}),r("span",{className:"graph-stat-value",children:a})]})]})}function Ca(t={}){const{autoLoadCheckpoints:e=!1}=t,[n,a]=L([]),[i,s]=L(null),[o,p]=L(!1),[u,d]=L(!1),[m,c]=L(null),h=async()=>{p(!0),c(null);try{const E=await J().getCheckpoints();a(E),console.log("[Provenance] Loaded",E.length,"checkpoints")}catch(w){const E=String(w);c(E),console.error("[Provenance] Failed to load checkpoints:",w)}finally{p(!1)}},_=async w=>{d(!0),c(null);try{const g=await J().verifyPage(w);s(g),console.log("[Provenance] Verification result:",g)}catch(E){const g=String(E);c(g),console.error("[Provenance] Failed to verify page:",E)}finally{d(!1)}},b=()=>{s(null)};return V(()=>{e&&h()},[e]),{checkpoints:n,verificationResult:i,loading:o,verifying:u,error:m,checkpointCount:n.length,latestCheckpoint:n[0]||null,loadCheckpoints:h,verifyPage:_,clearVerification:b}}function Ra({checkpoint:t,isLatest:e}){return r("div",{className:`checkpoint-item ${e?"checkpoint-latest":""}`,children:[r("div",{className:"checkpoint-header",children:[r("div",{className:"checkpoint-epoch",children:[e&&r("span",{className:"checkpoint-badge",children:"Latest"}),r("span",{className:"checkpoint-epoch-value",children:["Epoch ",t.epoch]})]}),r("div",{className:"checkpoint-date",children:new Date(t.createdTs).toLocaleString()})]}),r("div",{className:"checkpoint-body",children:[r("div",{className:"checkpoint-field",children:[r("span",{className:"field-label",children:"Merkle Root:"}),r("code",{className:"field-value",title:t.merkleRoot,children:[t.merkleRoot.substring(0,16),"..."]})]}),r("div",{className:"checkpoint-field",children:[r("span",{className:"field-label",children:"Pages:"}),r("span",{className:"field-value",children:t.pagesCount})]}),t.anchors&&t.anchors.length>0&&r("div",{className:"checkpoint-field",children:[r("span",{className:"field-label",children:"Anchors:"}),r("span",{className:"field-value",children:t.anchors.length})]})]})]})}function Oa({checkpoints:t,loading:e,error:n}){return e?r("div",{className:"checkpoint-timeline-loading",children:[r("div",{className:"spinner"}),r("p",{children:"Loading checkpoints..."})]}):n?r("div",{className:"checkpoint-timeline-error",children:r("p",{children:["Error: ",n]})}):t.length===0?r("div",{className:"checkpoint-timeline-empty",children:[r("p",{children:"No checkpoints found"}),r("p",{className:"hint",children:"This capsule has not been checkpointed yet"})]}):r("div",{className:"checkpoint-timeline",children:t.map((a,i)=>r(Ra,{checkpoint:a,isLatest:i===0},a.epoch))})}function ka({result:t,verifying:e,onVerify:n}){return e?r("div",{className:"verification-panel verification-loading",children:[r("div",{className:"spinner"}),r("p",{children:"Verifying page integrity..."})]}):t?r("div",{className:`verification-panel ${t.verified?"verification-success":"verification-failure"}`,children:[r("div",{className:"verification-header",children:r("div",{className:"verification-status",children:t.verified?r(te,{children:[r("span",{className:"status-icon",children:"âœ“"}),r("span",{className:"status-text",children:"Verified"})]}):r(te,{children:[r("span",{className:"status-icon",children:"âœ—"}),r("span",{className:"status-text",children:"Verification Failed"})]})})}),r("div",{className:"verification-body",children:[r("div",{className:"verification-field",children:[r("span",{className:"field-label",children:"Content SHA:"}),r("code",{className:"field-value",title:t.contentSha,children:[t.contentSha.substring(0,16),"..."]})]}),t.expectedSha&&r("div",{className:"verification-field",children:[r("span",{className:"field-label",children:"Expected SHA:"}),r("code",{className:"field-value",title:t.expectedSha,children:[t.expectedSha.substring(0,16),"..."]})]}),t.epoch&&r("div",{className:"verification-field",children:[r("span",{className:"field-label",children:"Checkpoint Epoch:"}),r("span",{className:"field-value",children:t.epoch})]}),t.merkleRoot&&r("div",{className:"verification-field",children:[r("span",{className:"field-label",children:"Merkle Root:"}),r("code",{className:"field-value",title:t.merkleRoot,children:[t.merkleRoot.substring(0,16),"..."]})]}),t.signer&&r("div",{className:"verification-field",children:[r("span",{className:"field-label",children:"Signer:"}),r("code",{className:"field-value",children:t.signer})]}),t.signature&&r("div",{className:"verification-field",children:[r("span",{className:"field-label",children:"Signature:"}),r("code",{className:"field-value",title:t.signature,children:[t.signature.substring(0,16),"..."]})]})]}),n&&r("div",{className:"verification-footer",children:r("button",{className:"btn-secondary btn-sm",onClick:n,children:"Verify Again"})})]}):r("div",{className:"verification-panel verification-empty",children:[r("p",{children:'Click "Verify Page" to check integrity'}),n&&r("button",{className:"btn-primary btn-sm",onClick:n,children:"Verify Page"})]})}function xa({checkpoints:t,verificationResult:e,loading:n,verifying:a,error:i,onVerify:s}){const[o,p]=L("checkpoints");return r("div",{className:"provenance-panel",children:[r("div",{className:"provenance-header",children:r("h3",{children:"Provenance & Trust"})}),r("div",{className:"provenance-tabs",children:[r("button",{className:`provenance-tab ${o==="checkpoints"?"active":""}`,onClick:()=>p("checkpoints"),children:["ðŸ“œ Checkpoints (",t.length,")"]}),r("button",{className:`provenance-tab ${o==="verification"?"active":""}`,onClick:()=>p("verification"),children:"ðŸ” Verification"})]}),r("div",{className:"provenance-content",children:[o==="checkpoints"&&r(Oa,{checkpoints:t,loading:n,error:i}),o==="verification"&&r(ka,{result:e,verifying:a,onVerify:s})]})]})}function Ma(t){const{onFocusSearch:e,onToggleLlm:n,onEscape:a}=t;V(()=>{function i(s){const o=s.target,p=o.tagName==="INPUT"||o.tagName==="TEXTAREA"||o.isContentEditable;if(s.key==="/"&&!p){s.preventDefault(),e==null||e();return}if((s.ctrlKey||s.metaKey)&&s.key==="l"){s.preventDefault(),n==null||n();return}if(s.key==="Escape"){a==null||a();return}}return window.addEventListener("keydown",i),()=>{window.removeEventListener("keydown",i)}},[e,n,a])}function Ia(t){return t.startsWith("asset://")?{protocol:"asset",path:t.slice(8)}:null}const Rt=new Map,Fa=new Map;async function Da(t){if(Rt.has(t))return Rt.get(t);const e=Ia(t);if(!e)return console.error("[Assets] Invalid asset URL:",t),null;try{const a=await J().getPageBlob(e.path);if(!a||a.size===0)return console.warn("[Assets] Asset not found or empty:",e.path),null;const i=URL.createObjectURL(a);return Rt.set(t,i),Fa.set(t,a),console.log("[Assets] Loaded:",e.path,`(${a.size} bytes, ${a.type||"unknown type"})`),i}catch(n){return console.error("[Assets] Failed to load asset:",t,n),null}}function Pa(t){const[e,n]=L(null);return V(()=>{if(!t){n(null);return}if(!t.startsWith("asset://")){n(t);return}Da(t).then(n)},[t]),e}function Ua({gid:t,onClose:e}){const[n,a]=L(null),[i,s]=L(!0),[o,p]=L(null);V(()=>{(async()=>{s(!0),p(null);try{const h=await J().query("SELECT gid, doc_id, page_no, title, tags, updated_ts FROM meta_index WHERE gid = ? LIMIT 1",[t]);h.length>0?a(h[0]):p("Page not found")}catch(c){p(String(c)),console.error("[PagePreview] Failed to load page:",c)}finally{s(!1)}})()},[t]);const u=n?`asset://glyphs/page_${String(n.pageNo).padStart(4,"0")}.mgx.png`:void 0,d=Pa(u);return i?r("div",{className:"page-preview",children:r("div",{className:"page-preview-loading",children:[r("div",{className:"spinner"}),r("p",{children:"Loading page..."})]})}):o||!n?r("div",{className:"page-preview",children:r("div",{className:"page-preview-error",children:[r("p",{children:["Error: ",o||"Page not found"]}),e&&r("button",{className:"btn-secondary",onClick:e,children:"Close"})]})}):r("div",{className:"page-preview",children:[r("div",{className:"page-preview-header",children:[r("div",{className:"page-preview-title",children:[r("span",{className:"page-number",children:["Page ",n.pageNo]}),r("h3",{children:n.title||"(Untitled)"})]}),e&&r("button",{className:"btn-icon",onClick:e,title:"Close preview",children:"âœ•"})]}),r("div",{className:"page-preview-content",children:d?r("img",{src:d,alt:`Page ${n.pageNo}`,className:"page-image"}):r("div",{className:"page-preview-placeholder",children:r("p",{children:"No image available for this page"})})}),r("div",{className:"page-preview-metadata",children:r("dl",{children:[r("dt",{children:"GID:"}),r("dd",{children:r("code",{title:n.gid,children:[n.gid.substring(0,16),"..."]})}),n.tags&&r(te,{children:[r("dt",{children:"Tags:"}),r("dd",{children:n.tags})]}),r("dt",{children:"Updated:"}),r("dd",{children:new Date(n.updatedTs).toLocaleString()})]})})]})}function Ha({selectedGid:t,onClose:e}){return t?r(Ua,{gid:t,onClose:e}):r("div",{className:"page-preview-panel-empty",children:r("p",{children:"Select a search result to preview the page"})})}function $a({config:t,children:e}){return r("div",{className:"layout-landing",children:[r("section",{className:"hero",children:[r("div",{className:"hero-content",children:[t.logo_asset&&r("img",{src:t.logo_asset,alt:"Logo",className:"hero-logo"}),r("h1",{className:"hero-title",children:t.hero_title||t.site_title||"Welcome"}),t.hero_subtitle&&r("p",{className:"hero-subtitle",children:t.hero_subtitle})]}),t.hero_image&&r("div",{className:"hero-background",style:{backgroundImage:`url(${t.hero_image})`}})]}),r("main",{className:"landing-main",children:e})]})}function Ga({config:t,navigation:e,currentPage:n,children:a}){const i=e.filter(s=>s.menu==="sidebar");return r("div",{className:"layout-docs",children:[r("aside",{className:"docs-sidebar",children:r("nav",{className:"docs-nav",children:[r("div",{className:"docs-nav-header",children:[t.logo_asset&&r("img",{src:t.logo_asset,alt:"Logo",className:"docs-logo"}),r("h3",{children:t.site_title||"Documentation"})]}),r("ul",{className:"docs-nav-list",children:i.map(s=>r("li",{className:"docs-nav-item",children:r("a",{href:`#${s.to_slug}`,className:(n==null?void 0:n.slug)===s.to_slug?"active":"",children:[s.icon_asset&&r("img",{src:s.icon_asset,alt:"",className:"nav-icon"}),s.label]})},s.to_slug))})]})}),r("main",{className:"docs-main",children:[n&&r("div",{className:"docs-breadcrumbs",children:[r("a",{href:"#/",children:"Home"}),n.category&&r(te,{children:[r("span",{children:" / "}),r("span",{children:n.category})]}),r("span",{children:" / "}),r("span",{children:n.title})]}),r("article",{className:"docs-content",children:[n&&r("h1",{children:n.title}),a]})]})]})}function lr({config:t,children:e}){return r("div",{className:"layout-dashboard",children:[r("header",{className:"dashboard-header",children:r("h1",{children:t.site_title||"Dashboard"})}),r("main",{className:"dashboard-content",children:e})]})}function cr({config:t,title:e,children:n}){return r("div",{className:"layout-simple",children:[r("header",{className:"simple-header",children:[t.logo_asset&&r("img",{src:t.logo_asset,alt:"Logo",className:"simple-logo"}),e&&r("h1",{children:e})]}),r("main",{className:"simple-content",children:n}),r("footer",{className:"simple-footer",children:r("p",{children:"Powered by GlyphCapsule"})})]})}function qa({topBar:t,leftSidebar:e,centerPanel:n,rightSidebar:a,showLeftSidebar:i=!0,showRightSidebar:s=!1}){return r("div",{className:"capsule-layout",children:[r("div",{className:"capsule-topbar",children:t}),r("div",{className:"capsule-content",children:[i&&e&&r("aside",{className:"capsule-sidebar capsule-sidebar-left",children:e}),r("main",{className:"capsule-main",children:n}),s&&a&&r("aside",{className:"capsule-sidebar capsule-sidebar-right",children:a})]})]})}function Wa({capsuleName:t,onClose:e,actions:n}){return r("div",{className:"topbar-content",children:[r("div",{className:"topbar-left",children:r("h2",{className:"topbar-title",children:["ðŸ“¦ ",t]})}),r("div",{className:"topbar-right",children:[n,e&&r("button",{className:"btn-secondary btn-sm",onClick:e,children:"Close Capsule"})]})]})}function za({title:t,children:e,onClear:n,hasActiveFilters:a=!1}){return r("div",{className:"filter-panel",children:[r("div",{className:"filter-panel-header",children:[r("h3",{children:t}),a&&n&&r("button",{className:"btn-link btn-sm",onClick:n,children:"Clear All"})]}),r("div",{className:"filter-panel-content",children:e})]})}function Ba({capsuleInfo:t,onClose:e}){var S;const[n,a]=L("search"),[i,s]=L(null),[o,p]=L(!1),u=tr({defaultMode:"fts"}),d=sr({autoLoad:!0}),m=Na({maxHops:2,limit:50}),c=Ca({autoLoadCheckpoints:!0}),h=or({});Ma({onFocusSearch:()=>{const T=document.querySelector('input[name="query"]');T==null||T.focus(),T==null||T.select()},onToggleLlm:()=>{h.toggle()},onEscape:()=>{document.activeElement instanceof HTMLElement&&document.activeElement.blur()}});const _=T=>{s(T)},b=T=>{m.navigateToNode(T),s(T)},w=T=>{a("graph"),m.loadGraph(T),s(T)},E=()=>{u.clearFilter(),u.lastQuery&&u.search(u.lastQuery)},g=()=>{i&&(c.verifyPage(i),p(!0))},f=async()=>{h.enabled&&u.results&&u.results.length>0&&u.lastQuery&&(h.clearReasoning(),await h.reason(u.lastQuery,u.results,1500))};V(()=>{h.enabled&&u.results&&u.results.length>0&&u.lastQuery&&(!h.reasoning||h.reasoning.usedSnippets.length===0)&&f()},[h.enabled,u.results,u.lastQuery]);const v=!!(u.entityFilter.entityType||u.entityFilter.entityValue);return r(qa,{topBar:r(Wa,{capsuleName:t.fileName,onClose:e,actions:r(te,{children:[r("div",{className:"capsule-stats",children:[r("span",{children:[t.pageCount," pages"]}),r("span",{children:[t.entityCount," entities"]}),r("span",{children:[t.edgeCount," edges"]})]}),r("button",{className:`btn-secondary btn-sm ${h.enabled?"active":""}`,onClick:h.toggle,disabled:h.loading,title:(S=h.modelInfo)!=null&&S.loaded?"LLM Ready":"Click to load LLM",children:["ðŸ¤– ",h.enabled?"LLM On":"LLM Off"]}),r("button",{className:`btn-secondary btn-sm ${o?"active":""}`,onClick:()=>p(!o),children:[o?"âœ“":""," Provenance"]})]})}),leftSidebar:r(za,{title:"Entity Filters",onClear:E,hasActiveFilters:v,children:[v&&r("div",{className:"active-filters",children:[r("p",{className:"filter-label",children:"Active Filter:"}),u.entityFilter.entityType&&r("span",{className:"filter-tag",children:["Type: ",u.entityFilter.entityType]}),u.entityFilter.entityValue&&r("span",{className:"filter-tag",children:["Value: ",u.entityFilter.entityValue]})]}),r(ua,{entities:d.entities,types:d.types,selectedType:d.selectedType,totalCount:d.totalCount,onSelectType:d.selectType,getTypeCount:d.getTypeCount,show:!0,maxDisplay:20})]}),centerPanel:r("div",{className:"capsule-center",children:[r("div",{className:"view-mode-tabs",children:[r("button",{className:`tab-btn ${n==="search"?"active":""}`,onClick:()=>a("search"),children:"ðŸ” Search"}),r("button",{className:`tab-btn ${n==="graph"?"active":""}`,onClick:()=>a("graph"),children:"ðŸ•¸ï¸ Graph"})]}),n==="search"&&r(te,{children:[r(la,{mode:u.mode,results:u.results,lastQuery:u.lastQuery,loading:u.loading,onSearch:u.search,onModeChange:u.changeMode,onResultClick:_,showModeToggle:!0,placeholder:"Search the capsule...",searchHint:'Try: "vector search", "LEANN", "SQLite", or "hybrid retrieval"',searchHistory:u.searchHistory,onClearHistory:u.clearHistory}),h.enabled&&u.results&&u.results.length>0&&r("div",{className:"llm-section",children:[r("div",{className:"llm-temperature-control",children:[r("label",{htmlFor:"temperature-slider",className:"temperature-label",children:["Creativity:",r("input",{id:"temperature-slider",type:"range",min:"0",max:"1",step:"0.1",value:h.temperature,onChange:T=>h.setTemperature(parseFloat(T.currentTarget.value)),className:"temperature-slider"}),r("span",{className:"temperature-value",children:h.temperature.toFixed(1)})]}),r("small",{className:"temperature-hint",children:[h.temperature<.3&&"â„ï¸ Very factual",h.temperature>=.3&&h.temperature<.6&&"ðŸ“ Mostly factual",h.temperature>=.6&&h.temperature<.8&&"âš–ï¸ Balanced",h.temperature>=.8&&"ðŸŽ¨ Creative"]})]}),h.progress&&r("div",{className:"llm-progress-bar",children:[r("div",{className:"llm-progress-info",children:[r("span",{children:["ðŸ¤– ",h.progress.message]}),r("span",{children:[(h.progress.progress*100).toFixed(0),"%"]})]}),r("div",{className:"llm-progress-track",children:r("div",{className:"llm-progress-fill",style:{width:`${h.progress.progress*100}%`}})})]}),h.reasoning&&r(fa,{reasoning:h.reasoning,searchResults:u.results,loading:h.loading}),h.loading&&!h.reasoning&&!h.progress&&r("div",{className:"reasoning-loading",children:[r("div",{className:"spinner"}),r("p",{children:"LLM is reasoning over search results..."}),h.elapsedTime>0&&r("p",{className:"inference-time",children:["Elapsed: ",h.elapsedTime.toFixed(1),"s",h.elapsedTime>3&&" â€¢ Typically takes 2-5s"]})]}),h.error&&r("div",{className:"llm-error-panel",children:[r("strong",{children:"âš ï¸ LLM Error:"})," ",h.error,r("button",{className:"btn-secondary btn-sm",onClick:f,disabled:h.loading,style:{marginLeft:"1rem"},children:h.loading?"Retrying...":"Try Again"})]})]}),h.enabled&&(!u.results||u.results.length===0)&&u.lastQuery&&r("div",{className:"llm-no-results",children:r("p",{children:"ðŸ¤– LLM needs search results to reason. Try searching first!"})})]}),n==="graph"&&r("div",{className:"graph-view-container",children:[!m.graphData&&r("div",{className:"graph-view-empty",children:[r("p",{children:"Select a search result to explore its graph connections"}),r("p",{className:"hint",children:"Or switch to Search tab to find pages"})]}),m.graphData&&r(te,{children:[r(La,{nodeCount:m.nodeCount,edgeCount:m.edgeCount,predicateCount:m.predicates.length,seedNode:m.seedGid||void 0}),r(Aa,{predicates:m.predicates,selectedPredicate:m.predicate,onPredicateChange:m.filterByPredicate,onReset:m.clear}),r(wa,{nodes:m.graphData.nodes,edges:m.graphData.edges,seedGid:m.seedGid||void 0,onNodeClick:b,loading:m.loading,error:m.error})]})]}),i&&r("div",{className:"page-preview-section",children:[r("div",{className:"page-preview-header-actions",children:[r("h3",{children:"Page Preview"}),r("div",{className:"page-preview-actions",children:[n==="search"&&r("button",{className:"btn-secondary btn-sm",onClick:()=>w(i),children:"Explore Graph"}),r("button",{className:"btn-primary btn-sm",onClick:g,disabled:c.verifying,children:c.verifying?"Verifying...":"Verify Page"})]})]}),r(Ha,{selectedGid:i,onClose:()=>s(null)})]})]}),rightSidebar:o&&r(xa,{checkpoints:c.checkpoints,verificationResult:c.verificationResult,loading:c.loading,verifying:c.verifying,error:c.error,onVerify:g}),showLeftSidebar:!0,showRightSidebar:o})}const Xa=`-- GlyphCase Envelope Schema v1.1
-- Append-only episodic memory layer for Dynamic GlyphCases
-- This schema represents the mutable, hash-chained memory buffer
-- that sits alongside the immutable Core.

-- ============================================================================
-- METADATA
-- ============================================================================

-- Envelope metadata and configuration
CREATE TABLE IF NOT EXISTS _envelope_meta (
  key TEXT PRIMARY KEY,
  value TEXT NOT NULL
) STRICT;

-- Core metadata values:
-- 'gcase_id' - SHA256 hash of the Core capsule this envelope is linked to
-- 'created_at' - ISO8601 timestamp of envelope creation
-- 'format_version' - Envelope schema version (1.1)
-- 'last_hash' - Most recent hash in the chain

-- ============================================================================
-- HASH CHAIN (Merkle Integrity)
-- ============================================================================

-- Hash chain for append-only integrity verification
-- Each block represents a batch of appends with a Merkle root
CREATE TABLE IF NOT EXISTS _env_chain (
  seq INTEGER PRIMARY KEY AUTOINCREMENT,
  block_hash TEXT NOT NULL UNIQUE,
  parent_hash TEXT NOT NULL,
  block_type TEXT NOT NULL, -- 'retrieval' | 'embedding' | 'feedback' | 'summary'
  row_count INTEGER NOT NULL DEFAULT 1,
  created_at TEXT NOT NULL DEFAULT (datetime('now'))
) STRICT;

CREATE INDEX IF NOT EXISTS idx_chain_block_type ON _env_chain(block_type);
CREATE INDEX IF NOT EXISTS idx_chain_created_at ON _env_chain(created_at);

-- ============================================================================
-- RETRIEVAL LOGS
-- ============================================================================

-- Logs every search/retrieval operation performed
-- Enables learning from query patterns and improving relevance
CREATE TABLE IF NOT EXISTS env_retrieval_log (
  id TEXT PRIMARY KEY,
  seq INTEGER NOT NULL REFERENCES _env_chain(seq),
  ts TEXT NOT NULL DEFAULT (datetime('now')),
  query_text TEXT NOT NULL,
  query_type TEXT NOT NULL CHECK(query_type IN ('fts', 'vector', 'hybrid', 'graph')),
  top_docs TEXT, -- JSON array of {gid, score, snippet}
  hit_count INTEGER NOT NULL DEFAULT 0,
  parent_hash TEXT NOT NULL
) STRICT;

CREATE INDEX IF NOT EXISTS idx_retrieval_ts ON env_retrieval_log(ts);
CREATE INDEX IF NOT EXISTS idx_retrieval_type ON env_retrieval_log(query_type);
CREATE INDEX IF NOT EXISTS idx_retrieval_query ON env_retrieval_log(query_text);

-- ============================================================================
-- CONTEXTUAL EMBEDDINGS
-- ============================================================================

-- Runtime-generated embeddings for queries, responses, and context
-- Provides adaptive semantic memory beyond the canonical Core vectors
CREATE TABLE IF NOT EXISTS env_embeddings (
  id TEXT PRIMARY KEY,
  seq INTEGER NOT NULL REFERENCES _env_chain(seq),
  source TEXT NOT NULL, -- 'user_query' | 'llm_response' | 'context_window' | 'feedback_cluster'
  vector BLOB NOT NULL,
  metadata TEXT, -- JSON metadata about this embedding
  created_at TEXT NOT NULL DEFAULT (datetime('now')),
  parent_hash TEXT NOT NULL
) STRICT;

CREATE INDEX IF NOT EXISTS idx_embeddings_source ON env_embeddings(source);
CREATE INDEX IF NOT EXISTS idx_embeddings_created ON env_embeddings(created_at);

-- ============================================================================
-- USER FEEDBACK
-- ============================================================================

-- User ratings and feedback on retrievals and responses
-- Enables learning from human signals and improving relevance over time
CREATE TABLE IF NOT EXISTS env_feedback (
  id TEXT PRIMARY KEY,
  seq INTEGER NOT NULL REFERENCES _env_chain(seq),
  retrieval_id TEXT REFERENCES env_retrieval_log(id),
  rating INTEGER NOT NULL CHECK(rating IN (-1, 0, 1)), -- -1 (bad) | 0 (neutral) | 1 (good)
  notes TEXT,
  created_at TEXT NOT NULL DEFAULT (datetime('now')),
  parent_hash TEXT NOT NULL
) STRICT;

CREATE INDEX IF NOT EXISTS idx_feedback_rating ON env_feedback(rating);
CREATE INDEX IF NOT EXISTS idx_feedback_retrieval ON env_feedback(retrieval_id);
CREATE INDEX IF NOT EXISTS idx_feedback_created ON env_feedback(created_at);

-- ============================================================================
-- CONTEXT SUMMARIES
-- ============================================================================

-- LLM-generated context summaries and insights
-- Captures high-level understanding and reasoning patterns
CREATE TABLE IF NOT EXISTS env_context_summaries (
  id TEXT PRIMARY KEY,
  seq INTEGER NOT NULL REFERENCES _env_chain(seq),
  summary TEXT NOT NULL,
  relevance REAL NOT NULL CHECK(relevance >= 0.0 AND relevance <= 1.0),
  source_retrievals TEXT, -- JSON array of retrieval_log IDs
  created_at TEXT NOT NULL DEFAULT (datetime('now')),
  parent_hash TEXT NOT NULL
) STRICT;

CREATE INDEX IF NOT EXISTS idx_summaries_relevance ON env_context_summaries(relevance);
CREATE INDEX IF NOT EXISTS idx_summaries_created ON env_context_summaries(created_at);

-- ============================================================================
-- VIEWS
-- ============================================================================

-- Recent activity view (last 100 events)
CREATE VIEW IF NOT EXISTS v_recent_activity AS
SELECT
  'retrieval' as event_type,
  id,
  ts as timestamp,
  query_text as description,
  hit_count as value
FROM env_retrieval_log
UNION ALL
SELECT
  'feedback' as event_type,
  id,
  created_at as timestamp,
  notes as description,
  rating as value
FROM env_feedback
UNION ALL
SELECT
  'summary' as event_type,
  id,
  created_at as timestamp,
  substr(summary, 1, 100) as description,
  relevance as value
FROM env_context_summaries
ORDER BY timestamp DESC
LIMIT 100;

-- Envelope statistics view
CREATE VIEW IF NOT EXISTS v_envelope_stats AS
SELECT
  (SELECT COUNT(*) FROM env_retrieval_log) as retrieval_count,
  (SELECT COUNT(*) FROM env_embeddings) as embedding_count,
  (SELECT COUNT(*) FROM env_feedback) as feedback_count,
  (SELECT COUNT(*) FROM env_context_summaries) as summary_count,
  (SELECT COUNT(*) FROM _env_chain) as chain_length,
  (SELECT MIN(ts) FROM env_retrieval_log) as first_activity,
  (SELECT MAX(ts) FROM env_retrieval_log) as last_activity;
`;async function Ke(t){const e=JSON.stringify({table:t.table,id:t.rowId,data:$t(t.data),parent:t.parentHash,ts:t.timestamp}),a=new TextEncoder().encode(e),i=await crypto.subtle.digest("SHA-256",a);return Array.from(new Uint8Array(i)).map(o=>o.toString(16).padStart(2,"0")).join("")}function $t(t){if(t instanceof Float32Array)return{__type:"Float32Array",values:Array.from(t)};if(Array.isArray(t))return t.map($t);if(t&&typeof t=="object"){const e={};for(const[n,a]of Object.entries(t))e[n]=$t(a);return e}return t}class Ot{constructor(e,n){k(this,"lastHash");k(this,"db");k(this,"genesis","0".repeat(64));this.db=e,this.lastHash=n||this.genesis}getCurrentHash(){return this.lastHash}async appendRetrieval(e){const n=new Date().toISOString(),a=await Ke({table:"retrieval_log",rowId:e.id,data:e,parentHash:this.lastHash,timestamp:n}),i=this.db.prepare(`
      INSERT INTO env_retrieval_log
      (id, query_text, query_type, top_docs, hit_count, parent_hash, ts)
      VALUES (?, ?, ?, ?, ?, ?, ?)
    `);try{i.bind([e.id,e.query_text,e.query_type,e.top_docs?JSON.stringify(e.top_docs):null,e.hit_count,this.lastHash,n]),i.step()}finally{i.finalize()}return await this.recordChainBlock(a,"retrieval",1),this.lastHash=a,a}async appendEmbedding(e){const n=new Date().toISOString(),a=await Ke({table:"embeddings",rowId:e.id,data:e,parentHash:this.lastHash,timestamp:n}),i=new Uint8Array(e.vector.buffer),s=this.db.prepare(`
      INSERT INTO env_embeddings
      (id, source, vector, metadata, parent_hash, created_at)
      VALUES (?, ?, ?, ?, ?, ?)
    `);try{s.bind([e.id,e.source,i,e.metadata?JSON.stringify(e.metadata):null,this.lastHash,n]),s.step()}finally{s.finalize()}return await this.recordChainBlock(a,"embedding",1),this.lastHash=a,a}async appendFeedback(e){const n=new Date().toISOString(),a=await Ke({table:"feedback",rowId:e.id,data:e,parentHash:this.lastHash,timestamp:n}),i=this.db.prepare(`
      INSERT INTO env_feedback
      (id, retrieval_id, rating, notes, parent_hash, created_at)
      VALUES (?, ?, ?, ?, ?, ?)
    `);try{i.bind([e.id,e.retrieval_id||null,e.rating,e.notes||null,this.lastHash,n]),i.step()}finally{i.finalize()}return await this.recordChainBlock(a,"feedback",1),this.lastHash=a,a}async appendSummary(e){const n=new Date().toISOString(),a=await Ke({table:"summaries",rowId:e.id,data:e,parentHash:this.lastHash,timestamp:n}),i=this.db.prepare(`
      INSERT INTO env_context_summaries
      (id, summary, relevance, source_retrievals, parent_hash, created_at)
      VALUES (?, ?, ?, ?, ?, ?)
    `);try{i.bind([e.id,e.summary,e.relevance,e.source_retrievals?JSON.stringify(e.source_retrievals):null,this.lastHash,n]),i.step()}finally{i.finalize()}return await this.recordChainBlock(a,"summary",1),this.lastHash=a,a}async recordChainBlock(e,n,a){const i=this.db.prepare(`
      INSERT INTO _env_chain (block_hash, parent_hash, block_type, row_count)
      VALUES (?, ?, ?, ?)
    `);try{i.bind([e,this.lastHash,n,a]),i.step();const o=this.db.prepare("SELECT last_insert_rowid()");try{o.step();const p=o.get([])[0],u=this.db.prepare(`
          UPDATE env_${n==="retrieval"?"retrieval_log":n==="embedding"?"embeddings":n==="feedback"?"feedback":"context_summaries"}
          SET seq = ?
          WHERE parent_hash = ?
        `);try{u.bind([p,this.lastHash]),u.step()}finally{u.finalize()}}finally{o.finalize()}}finally{i.finalize()}const s=this.db.prepare(`
      INSERT OR REPLACE INTO _envelope_meta (key, value) VALUES ('last_hash', ?)
    `);try{s.bind([e]),s.step()}finally{s.finalize()}}async verifyChain(){const e=[],n=this.db.prepare(`
      SELECT seq, block_hash, parent_hash, block_type
      FROM _env_chain
      ORDER BY seq ASC
    `),a=[];try{for(;n.step();){const i=n.get([]);a.push({seq:i[0],block_hash:i[1],parent_hash:i[2],block_type:i[3],row_count:0,created_at:""})}}finally{n.finalize()}for(let i=1;i<a.length;i++){const s=a[i],o=a[i-1];s.parent_hash!==o.block_hash&&e.push(`Chain break at seq ${s.seq}: parent_hash ${s.parent_hash} does not match previous block_hash ${o.block_hash}`)}return{valid:e.length===0,errors:e}}getChainStats(){const e=this.db.prepare(`
      SELECT block_type, COUNT(*) as count
      FROM _env_chain
      GROUP BY block_type
    `),n={};try{for(;e.step();){const s=e.get([]);n[s[0]]=s[1]}}finally{e.finalize()}const a=this.db.prepare("SELECT COUNT(*) FROM _env_chain");let i=0;try{a.step(),i=a.get([])[0]}finally{a.finalize()}return{length:i,currentHash:this.lastHash,types:n}}}async function kt(t){const e=await t.arrayBuffer(),n=await crypto.subtle.digest("SHA-256",e);return Array.from(new Uint8Array(n)).map(i=>i.toString(16).padStart(2,"0")).join("")}class it{constructor(){k(this,"db",null);k(this,"writer",null);k(this,"gcaseId",null);k(this,"opfsPath",null)}static async exists(e){try{const n=await kt(e),a=`/envelopes/${n}.db`;return await(await(await navigator.storage.getDirectory()).getDirectoryHandle("envelopes",{create:!1})).getFileHandle(`${n}.db`,{create:!1}),!0}catch{return!1}}async create(e,n){this.gcaseId=await kt(e),this.opfsPath=`/envelopes/${this.gcaseId}.db`,await(await navigator.storage.getDirectory()).getDirectoryHandle("envelopes",{create:!0}),this.db=new n.oo1.OpfsDb(this.opfsPath,"c"),this.db.exec(Xa);const i=new Date().toISOString(),s="0".repeat(64),o=this.db.prepare(`
      INSERT INTO _envelope_meta (key, value) VALUES
      ('gcase_id', ?),
      ('created_at', ?),
      ('format_version', '1.1'),
      ('last_hash', ?)
    `);try{o.bind([this.gcaseId,i,s]),o.step()}finally{o.finalize()}this.writer=new Ot(this.db,s),console.log(`[Envelope] Created new envelope for ${this.gcaseId}`)}async load(e,n){this.gcaseId=await kt(e),this.opfsPath=`/envelopes/${this.gcaseId}.db`,this.db=new n.oo1.OpfsDb(this.opfsPath,"w");const a=this.db.prepare(`
      SELECT value FROM _envelope_meta WHERE key = 'last_hash'
    `);let i="0".repeat(64);try{a.step()&&(i=a.get([])[0])}finally{a.finalize()}this.writer=new Ot(this.db,i),console.log(`[Envelope] Loaded existing envelope for ${this.gcaseId}`)}async open(e,n){await it.exists(e)?await this.load(e,n):await this.create(e,n)}close(){this.db&&(this.db.close(),this.db=null,this.writer=null,this.gcaseId=null,console.log("[Envelope] Closed envelope database"))}getWriter(){return this.writer}getStats(){if(!this.db)return null;const e=this.db.prepare("SELECT * FROM v_envelope_stats");try{if(e.step()){const n=e.get([]);return{retrievalCount:n[0]||0,embeddingCount:n[1]||0,feedbackCount:n[2]||0,summaryCount:n[3]||0,chainLength:n[4]||0,firstActivity:n[5]||null,lastActivity:n[6]||null}}}finally{e.finalize()}return null}getMeta(){if(!this.db)return null;const e=this.db.prepare("SELECT key, value FROM _envelope_meta"),n={};try{for(;e.step();){const a=e.get([]);n[a[0]]=a[1]}}finally{e.finalize()}return{gcaseId:n.gcase_id||"",createdAt:n.created_at||"",formatVersion:n.format_version||"1.1",lastHash:n.last_hash||""}}async clear(){if(!this.db)return;this.db.exec(`
      DELETE FROM env_retrieval_log;
      DELETE FROM env_embeddings;
      DELETE FROM env_feedback;
      DELETE FROM env_context_summaries;
      DELETE FROM _env_chain;
    `);const e="0".repeat(64),n=this.db.prepare(`
      UPDATE _envelope_meta SET value = ? WHERE key = 'last_hash'
    `);try{n.bind([e]),n.step()}finally{n.finalize()}this.writer=new Ot(this.db,e),console.log("[Envelope] Cleared all envelope data")}async export(){if(!this.db||!this.opfsPath)throw new Error("No envelope database open");return await(await(await(await navigator.storage.getDirectory()).getDirectoryHandle("envelopes")).getFileHandle(`${this.gcaseId}.db`)).getFile()}getRecentActivity(e=20){if(!this.db)return[];const n=this.db.prepare(`
      SELECT event_type, id, timestamp, description, value
      FROM v_recent_activity
      LIMIT ?
    `),a=[];try{for(n.bind([e]);n.step();){const i=n.get([]);a.push({eventType:i[0],id:i[1],timestamp:i[2],description:i[3],value:i[4]})}}finally{n.finalize()}return a}async verify(){return this.writer?this.writer.verifyChain():{valid:!1,errors:["No envelope writer available"]}}getDatabase(){return this.db}isOpen(){return this.db!==null}getOpfsPath(){return this.opfsPath}getGCaseId(){return this.gcaseId}}class Va{constructor(){k(this,"bus",new EventTarget);k(this,"topics",new Set);k(this,"eventLog",[]);k(this,"maxLogSize",100)}publish(e,n){this.topics.add(e);const a={topic:e,data:n,timestamp:Date.now()};this.bus.dispatchEvent(new CustomEvent(e,{detail:a}))}subscribe(e,n){const a=i=>{const s=i;n(s.detail.data,s.detail)};return this.bus.addEventListener(e,a),()=>{this.bus.removeEventListener(e,a)}}subscribeMany(e,n){const a=e.map(i=>this.subscribe(i,(s,o)=>n(i,s,o)));return()=>{a.forEach(i=>i())}}getActiveTopics(){return Array.from(this.topics)}getRecentEvents(e){return[]}clearEventLog(){this.eventLog=[]}getStats(){const e={};return{activeTopics:this.topics.size,eventLogSize:this.eventLog.length,topicCounts:e}}}const Vt=new Va,Hn=t=>Vt.publish("capsule.loaded",t),Ya=()=>Vt.publish("capsule.unloaded",{});class Qa{constructor(){k(this,"dbClient");k(this,"envelopeManager");k(this,"currentModality","static");k(this,"currentFile",null);k(this,"currentInfo",null);this.dbClient=new er,this.envelopeManager=new it}getModalityPreference(){return localStorage.getItem("glyphcase.modality")||"auto"}setModalityPreference(e){localStorage.setItem("glyphcase.modality",e)}async detectModality(e){const n=this.getModalityPreference();return n==="static"?"static":n==="dynamic"||await it.exists(e)?"dynamic":"static"}async openFromFile(e,n){this.currentFile=e;const a=await this.dbClient.openFromFile(e);let i;n!==void 0?i=n?"dynamic":"static":i=await this.detectModality(e),this.currentModality=i;let s;return i==="dynamic"&&console.log("[GlyphCase] Dynamic mode - envelope will be initialized on first write"),this.currentInfo={...a,modality:i,envelopeStats:s},Hn({gid:a.docId||"unknown",title:a.title||"Untitled",modality:i}),this.currentInfo}async openDemo(){const e=await this.dbClient.openDemo();return this.currentModality="static",this.currentInfo={...e,modality:"static"},Hn({gid:e.docId||"demo",title:e.title||"Demo",modality:"static"}),this.currentInfo}async enableDynamicMode(){if(!this.currentFile)throw new Error("No capsule loaded");if(this.currentModality==="dynamic"){console.log("[GlyphCase] Already in dynamic mode");return}this.currentModality="dynamic",this.currentInfo&&(this.currentInfo.modality="dynamic"),console.log("[GlyphCase] Enabled dynamic mode")}getModality(){return this.currentModality}getInfo(){return this.currentInfo}isDynamic(){return this.currentModality==="dynamic"}getCore(){return this.dbClient}getEnvelope(){return this.envelopeManager}getStream(){return Vt}async close(){this.envelopeManager.isOpen()&&this.envelopeManager.close(),await this.dbClient.close(),this.currentModality="static",this.currentFile=null,this.currentInfo=null,Ya()}async exportEnvelope(){return this.envelopeManager.isOpen()?this.envelopeManager.export():null}async clearEnvelope(){this.envelopeManager.isOpen()&&(await this.envelopeManager.clear(),this.currentInfo&&(this.currentInfo.envelopeStats=this.envelopeManager.getStats()||void 0))}getEnvelopeStats(){return this.envelopeManager.getStats()}async verifyEnvelope(){return this.envelopeManager.isOpen()?this.envelopeManager.verify():null}}new Qa;async function ja(t){const n=(await t.query("SELECT name FROM sqlite_master WHERE type='table'")).map(h=>h.name),a=n.includes("_ui_pages"),i=n.includes("_ui_dashboards"),s=n.includes("_ui_navigation"),o=n.includes("_ui_params"),p=n.includes("_meta_manifest"),u=n.includes("sqlar"),d=n.some(h=>h.startsWith("fts_"));let m="1.0";if(p)try{const h=await t.query("SELECT value FROM _meta_manifest WHERE key='gcui'");h.length>0&&(m=h[0].value)}catch(h){console.warn("Failed to read GCUI version:",h)}let c;return a&&i?c="hybrid":a?c="website":i?c="dashboard":c="generic",{version:m,hasWebsite:a,hasDashboards:i,hasNavigation:s,hasParams:o,hasFTS:d,hasAssets:u,mode:c}}async function Ka(t){try{const e=await t.query("SELECT key, value FROM _meta_manifest");if(e.length===0)return null;const n={gcui:"1.0",capsule_kind:"sqlar"};return e.forEach(a=>{n[a.key]=a.value}),n}catch(e){return console.warn("Failed to load manifest:",e),null}}async function Ja(t){try{const e=await t.query("SELECT key, value FROM _ui_config"),n={};return e.forEach(a=>{n[a.key]=a.value}),n}catch(e){return console.warn("Failed to load config:",e),{}}}async function Za(t){try{return(await t.query("SELECT slug, title, content, layout, category, order_index FROM _ui_pages ORDER BY order_index ASC, slug ASC")).map(n=>({slug:n.slug,title:n.title,content:n.content||void 0,layout:n.layout||void 0,category:n.category||void 0,order_index:n.order_index||void 0}))}catch(e){return console.warn("Failed to load pages:",e),[]}}async function ei(t){try{return(await t.query("SELECT menu, label, to_slug, order_index, icon_asset FROM _ui_navigation ORDER BY menu, order_index ASC")).map(n=>({menu:n.menu,label:n.label,to_slug:n.to_slug,order_index:n.order_index||void 0,icon_asset:n.icon_asset||void 0}))}catch(e){return console.warn("Failed to load navigation:",e),[]}}async function ti(t){try{return(await t.query("SELECT name, query, grammar, config FROM _ui_dashboards")).map(n=>({name:n.name,query:n.query,grammar:n.grammar||void 0,config:n.config||void 0}))}catch(e){return console.warn("Failed to load dashboards:",e),[]}}async function ni(t){const e=await ja(t),n=await Ka(t)||{gcui:e.version,capsule_kind:"sqlar"},a=await Ja(t),i=e.hasWebsite?await Za(t):[],s=e.hasNavigation?await ei(t):[],o=e.hasDashboards?await ti(t):[];return{manifest:n,capabilities:e,config:a,pages:i,navigation:s,dashboards:o}}function ri({data:t,config:e,width:n=600,height:a=400}){if(!t||t.length===0)return r("div",{className:"chart-empty",style:{width:n,height:a},children:r("p",{children:"No data to display"})});switch(e.mark){case"bar":return r(ai,{data:t,config:e,width:n,height:a});case"line":return r(ii,{data:t,config:e,width:n,height:a});case"point":return r(si,{data:t,config:e,width:n,height:a});case"area":return r(oi,{data:t,config:e,width:n,height:a});default:return r("div",{className:"chart-unsupported",style:{width:n,height:a},children:[r("p",{children:["Unsupported chart type: ",e.mark]}),r("p",{children:"Showing data as table:"}),r(li,{data:t})]})}}function ai({data:t,config:e,width:n,height:a}){var d,m;const{encoding:i}=e,s=((d=i.x)==null?void 0:d.field)||Object.keys(t[0])[0],o=((m=i.y)==null?void 0:m.field)||Object.keys(t[0])[1],p=Math.max(...t.map(c=>Number(c[o])||0)),u=Math.max(20,(n-100)/t.length-10);return r("div",{className:"chart chart-bar",style:{width:n,height:a},children:[e.title&&r("h4",{className:"chart-title",children:e.title}),r("div",{className:"chart-container",style:{height:a-60},children:r("div",{className:"chart-bars",style:{display:"flex",alignItems:"flex-end",height:"100%",gap:"8px"},children:t.map((c,h)=>{const _=Number(c[o])||0,b=_/p*(a-100);return r("div",{className:"chart-bar-item",style:{textAlign:"center"},children:[r("div",{className:"bar",style:{width:u,height:b,backgroundColor:"#6366f1",borderRadius:"4px 4px 0 0"},title:`${c[s]}: ${_}`}),r("div",{className:"bar-label",style:{fontSize:"12px",marginTop:"4px",maxWidth:u,overflow:"hidden",textOverflow:"ellipsis"},children:String(c[s]).slice(0,10)})]},h)})})}),r("div",{className:"chart-legend",style:{fontSize:"12px",marginTop:"8px",textAlign:"center"},children:[r("strong",{children:o})," by ",r("strong",{children:s})]})]})}function ii({data:t,config:e,width:n,height:a}){var E,g;const{encoding:i}=e,s=((E=i.x)==null?void 0:E.field)||Object.keys(t[0])[0],o=((g=i.y)==null?void 0:g.field)||Object.keys(t[0])[1],p=t.map(f=>Number(f[o])||0),u=Math.max(...p),d=Math.min(...p),m=u-d||1,c=n-80,h=a-100,_=c/(t.length-1||1),b=t.map((f,v)=>{const S=40+v*_,T=Number(f[o])||0,R=h-(T-d)/m*h+20;return{x:S,y:R,value:T,label:f[s]}}),w=b.map((f,v)=>`${v===0?"M":"L"} ${f.x} ${f.y}`).join(" ");return r("div",{className:"chart chart-line",style:{width:n,height:a},children:[e.title&&r("h4",{className:"chart-title",children:e.title}),r("svg",{width:n,height:a-40,style:{overflow:"visible"},children:[[0,.25,.5,.75,1].map(f=>{const v=h-f*h+20,S=d+f*m;return r("g",{children:[r("line",{x1:40,y1:v,x2:n-40,y2:v,stroke:"#e5e7eb",strokeWidth:1}),r("text",{x:10,y:v+4,fontSize:10,fill:"#666",children:S.toFixed(0)})]},f)}),r("path",{d:w,fill:"none",stroke:"#6366f1",strokeWidth:2}),b.map((f,v)=>r("circle",{cx:f.x,cy:f.y,r:4,fill:"#6366f1",children:r("title",{children:`${f.label}: ${f.value}`})},v)),b.map((f,v)=>r("text",{x:f.x,y:h+40,fontSize:10,fill:"#666",textAnchor:"middle",children:String(f.label).slice(0,8)},v))]}),r("div",{className:"chart-legend",style:{fontSize:"12px",textAlign:"center"},children:[r("strong",{children:o})," over ",r("strong",{children:s})]})]})}function si({data:t,config:e,width:n,height:a}){var g,f;const{encoding:i}=e,s=((g=i.x)==null?void 0:g.field)||Object.keys(t[0])[0],o=((f=i.y)==null?void 0:f.field)||Object.keys(t[0])[1],p=t.map(v=>Number(v[s])||0),u=t.map(v=>Number(v[o])||0),d=Math.min(...p),m=Math.max(...p),c=Math.min(...u),h=Math.max(...u),_=m-d||1,b=h-c||1,w=n-80,E=a-100;return r("div",{className:"chart chart-scatter",style:{width:n,height:a},children:[e.title&&r("h4",{className:"chart-title",children:e.title}),r("svg",{width:n,height:a-40,children:[[0,.25,.5,.75,1].map(v=>{const S=E-v*E+20;return r("line",{x1:40,y1:S,x2:n-40,y2:S,stroke:"#e5e7eb",strokeWidth:1},v)}),t.map((v,S)=>{const T=Number(v[s])||0,R=Number(v[o])||0,M=40+(T-d)/_*w,I=E-(R-c)/b*E+20;return r("circle",{cx:M,cy:I,r:5,fill:"#6366f1",opacity:.7,children:r("title",{children:`${s}: ${T}, ${o}: ${R}`})},S)})]}),r("div",{className:"chart-legend",style:{fontSize:"12px",textAlign:"center"},children:[r("strong",{children:o})," vs ",r("strong",{children:s})]})]})}function oi({data:t,config:e,width:n,height:a}){var g,f;const{encoding:i}=e,s=((g=i.x)==null?void 0:g.field)||Object.keys(t[0])[0],o=((f=i.y)==null?void 0:f.field)||Object.keys(t[0])[1],p=t.map(v=>Number(v[o])||0),u=Math.max(...p),d=Math.min(...p),m=u-d||1,c=n-80,h=a-100,_=c/(t.length-1||1),w=t.map((v,S)=>{const T=40+S*_,R=Number(v[o])||0,M=h-(R-d)/m*h+20;return{x:T,y:M}}).map((v,S)=>`${S===0?"M":"L"} ${v.x} ${v.y}`).join(" "),E=`${w} L ${n-40} ${h+20} L 40 ${h+20} Z`;return r("div",{className:"chart chart-area",style:{width:n,height:a},children:[e.title&&r("h4",{className:"chart-title",children:e.title}),r("svg",{width:n,height:a-40,children:[r("path",{d:E,fill:"#6366f1",opacity:.3}),r("path",{d:w,fill:"none",stroke:"#6366f1",strokeWidth:2})]}),r("div",{className:"chart-legend",style:{fontSize:"12px",textAlign:"center"},children:[r("strong",{children:o})," over ",r("strong",{children:s})]})]})}function li({data:t}){if(t.length===0)return null;const e=Object.keys(t[0]);return r("table",{className:"data-table",style:{width:"100%",borderCollapse:"collapse",fontSize:"12px"},children:[r("thead",{children:r("tr",{children:e.map(n=>r("th",{style:{borderBottom:"2px solid #ddd",padding:"8px",textAlign:"left"},children:n},n))})}),r("tbody",{children:t.slice(0,10).map((n,a)=>r("tr",{children:e.map(i=>r("td",{style:{borderBottom:"1px solid #eee",padding:"6px"},children:String(n[i])},i))},a))})]})}function dr({dashboards:t}){return t.length===0?r("div",{className:"dashboard-empty",children:r("p",{children:"No dashboards defined"})}):r("div",{className:"dashboard-grid",children:t.map(e=>r(ci,{dashboard:e},e.name))})}function ci({dashboard:t}){const[e,n]=L(null),[a,i]=L(!1),[s,o]=L(null);V(()=>{p()},[t.query]);const p=async()=>{i(!0),o(null);try{const m=await J().query(t.query);n(m)}catch(d){o(String(d)),console.error(`[Dashboard] Failed to load ${t.name}:`,d)}finally{i(!1)}};if(a)return r("div",{className:"dashboard-panel loading",children:[r("div",{className:"spinner"}),r("p",{children:["Loading ",t.name,"..."]})]});if(s)return r("div",{className:"dashboard-panel error",children:[r("h4",{children:t.name}),r("p",{className:"error-message",children:["Error: ",s]}),r("details",{children:[r("summary",{children:"Query"}),r("pre",{children:t.query})]})]});if(!e||e.length===0)return r("div",{className:"dashboard-panel empty",children:[r("h4",{children:t.name}),r("p",{children:"No data"})]});let u=null;if(t.config)try{u=JSON.parse(t.config)}catch(d){console.error(`[Dashboard] Invalid config for ${t.name}:`,d)}return!u||t.grammar!=="vegalite-lite-v1"?r("div",{className:"dashboard-panel table",children:[r("h4",{children:t.name}),r(di,{data:e})]}):r("div",{className:"dashboard-panel chart",children:r(ri,{data:e,config:u,width:600,height:400})})}function di({data:t}){const e=Object.keys(t[0]||{});return r("div",{style:{overflowX:"auto"},children:r("table",{className:"dashboard-table",style:{width:"100%",borderCollapse:"collapse",fontSize:"14px"},children:[r("thead",{children:r("tr",{children:e.map(n=>r("th",{style:{borderBottom:"2px solid #ddd",padding:"12px",textAlign:"left",fontWeight:600},children:n},n))})}),r("tbody",{children:t.map((n,a)=>r("tr",{style:{borderBottom:"1px solid #eee"},children:e.map(i=>r("td",{style:{padding:"10px"},children:String(n[i])},i))},a))})]})})}function ui({content:t}){const e=hi(t),n=Xt.sanitize(e,{ALLOWED_TAGS:["h1","h2","h3","h4","h5","h6","p","br","strong","em","code","pre","a","ul","ol","li"],ALLOWED_ATTR:["href"],ALLOW_DATA_ATTR:!1});return r("div",{className:"markdown-content",dangerouslySetInnerHTML:{__html:n}})}function hi(t){let e=t;return e=e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;"),e=e.replace(/^### (.*$)/gim,"<h3>$1</h3>"),e=e.replace(/^## (.*$)/gim,"<h2>$1</h2>"),e=e.replace(/^# (.*$)/gim,"<h1>$1</h1>"),e=e.replace(/\*\*(.*?)\*\*/g,"<strong>$1</strong>"),e=e.replace(/\*(.*?)\*/g,"<em>$1</em>"),e=e.replace(/`(.*?)`/g,"<code>$1</code>"),e=e.replace(/\[(.*?)\]\((.*?)\)/g,'<a href="$2">$1</a>'),e=e.replace(/```(.*?)\n([\s\S]*?)```/g,"<pre><code>$2</code></pre>"),e=e.replace(/^\- (.*$)/gim,"<li>$1</li>"),e=e.replace(/(<li>.*<\/li>)/s,"<ul>$1</ul>"),e=e.replace(/^\d+\. (.*$)/gim,"<li>$1</li>"),e=e.split(`

`).map(a=>a.startsWith("<h")||a.startsWith("<ul>")||a.startsWith("<ol>")||a.startsWith("<pre>")||a.startsWith("<li>")?a:`<p>${a}</p>`).join(`
`),e=e.replace(/\n/g,"<br>"),e}function pi({context:t}){const[e,n]=L("/");V(()=>{const i=()=>{const s=window.location.hash.slice(1);n(s||"/")};return window.addEventListener("hashchange",i),i(),()=>window.removeEventListener("hashchange",i)},[]);const a=t.pages.find(i=>i.slug===e)||t.pages[0];return a?r(fi,{page:a,context:t}):t.dashboards.length>0?r(lr,{config:t.config,children:r(dr,{dashboards:t.dashboards})}):r(cr,{config:t.config,title:"404 Not Found",children:[r("p",{children:["Page not found: ",e]}),r("p",{children:r("a",{href:"#/",children:"Go home"})})]})}function fi({page:t,context:e}){const n=t.layout||"simple",a=t.content?r(ui,{content:t.content}):r("p",{children:"No content"});switch(n){case"landing":return r($a,{config:e.config,children:a});case"docs":return r(Ga,{config:e.config,navigation:e.navigation,currentPage:t,children:a});case"dashboard":return r(lr,{config:e.config,children:[a,e.dashboards.length>0&&r(dr,{dashboards:e.dashboards})]});case"simple":default:return r(cr,{config:e.config,title:t.title,children:a})}}const mi={mode:"website",bundledCapsule:"/memglyph-demo.mgx.sqlite",branding:{title:"Memglyph",tagline:"Your knowledge, crystallized",logoUrl:"/logo.svg"},features:{llm:{enabled:!0,autoReason:!1,defaultModel:"qwen3-0.6b",maxTokens:256},search:{defaultMode:"hybrid",enabledModes:["fts","hybrid"],showModeToggle:!1},graph:{enabled:!0,maxHops:2,defaultMaxHops:1},upload:{enabled:!1,acceptedExtensions:[]},gcui:{enabled:!0,fallbackToGeneric:!1},pwa:{enabled:!0,offlineMode:!0}},ui:{showLanding:!0,theme:"documentation"}},_i={mode:"viewer",bundledCapsule:"/memglyph-demo.mgx.sqlite",branding:{title:"SQLAR Viewer",tagline:"Query your knowledge capsules",logoUrl:"/sqlar-logo.svg"},features:{llm:{enabled:!0,autoReason:!1,defaultModel:"qwen3-0.6b",maxTokens:256},search:{defaultMode:"hybrid",enabledModes:["fts","hybrid","graph"],showModeToggle:!0},graph:{enabled:!0,maxHops:3,defaultMaxHops:2},upload:{enabled:!0,acceptedExtensions:[".sqlite",".sqlar",".db",".mgx.sqlite"]},gcui:{enabled:!0,fallbackToGeneric:!0},pwa:{enabled:!0,offlineMode:!0}},ui:{showLanding:!1,theme:"tool"}};function gi(){return"website"}function yi(){return gi()==="viewer"?_i:mi}function vi(){const t=yi(),[e,n]=L(null),[a,i]=L(null),[s,o]=L(!1),[p,u]=L(null),[d,m]=L(!1);tr({defaultMode:t.features.search.defaultMode});const c=sr({autoLoad:!1});return or({}),V(()=>{e&&(c.loadEntities(),(async()=>{try{const g=J(),f=await ni(g);console.log("[GCUI] Detected capabilities:",f.capabilities),f.capabilities.mode!=="generic"?(i(f),console.log("[GCUI] Rendering in",f.capabilities.mode,"mode")):(console.log("[GCUI] No GCUI tables found, using legacy mode"),i(null))}catch(g){console.warn("[GCUI] Detection failed, using legacy mode:",g),i(null)}})())},[e]),r("div",{className:"app",children:[r("header",{className:"app-header",children:[r("h1",{children:"Glyphcapsule Explorer"}),r("p",{children:"Hybrid Retrieval Demo for MemGlyph"})]}),r("main",{className:"app-main",children:e?a&&t.features.gcui.enabled?r("div",{className:"gcui-mode",children:r(pi,{context:a})}):r(Ba,{capsuleInfo:e,onClose:()=>n(null)}):r("div",{className:"welcome",children:[p&&r("div",{className:"error",style:"max-width: 600px; margin: 1rem auto;",children:[r("strong",{children:"Error:"})," ",p]}),r(Ta,{onFileSelected:async(E,g)=>{o(!0),u(null);try{const v=await J().openFromFile(E);n(v),console.log("Capsule opened:",v)}catch(f){u(String(f)),console.error("Failed to open file:",f)}finally{o(!1)}},onOpfsFileSelected:async E=>{o(!0),u(null);try{const f=await J().openFromOpfs(E);n(f),console.log("Capsule opened from OPFS:",f)}catch(g){u(String(g)),console.error("Failed to open from OPFS:",g)}finally{o(!1)}},onError:E=>{u(E)}}),r("div",{style:"text-align: center; margin-top: 1.5rem;",children:[r("p",{style:"margin-bottom: 0.5rem; opacity: 0.7;",children:"Or try the demo:"}),r("button",{className:"btn-secondary",onClick:async()=>{o(!0),u(null);try{const g=await J().openDemo();n(g),console.log("Capsule info:",g)}catch(E){u(String(E)),console.error("Failed to open capsule:",E)}finally{o(!1)}},disabled:s,children:s?"Loading Demo...":"Load Demo Capsule"})]})]})}),r("footer",{className:"app-footer",children:r("p",{children:"Built with Preact + SQLite WASM + OPFS"})})]})}Lr(r(vi,{}),document.getElementById("app"));
