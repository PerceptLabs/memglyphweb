var Ta=Object.defineProperty;var Na=(t,e,n)=>e in t?Ta(t,e,{enumerable:!0,configurable:!0,writable:!0,value:n}):t[e]=n;var x=(t,e,n)=>Na(t,typeof e!="symbol"?e+"":e,n);(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))r(i);new MutationObserver(i=>{for(const s of i)if(s.type==="childList")for(const l of s.addedNodes)l.tagName==="LINK"&&l.rel==="modulepreload"&&r(l)}).observe(document,{childList:!0,subtree:!0});function n(i){const s={};return i.integrity&&(s.integrity=i.integrity),i.referrerPolicy&&(s.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?s.credentials="include":i.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function r(i){if(i.ep)return;i.ep=!0;const s=n(i);fetch(i.href,s)}})();var ht,I,Gn,Te,bn,Wn,zn,Bn,Xt,Pt,Ut,Be={},Xn=[],Sa=/acit|ex(?:s|g|n|p|$)|rph|grid|ows|mnc|ntw|ine[ch]|zoo|^ord|itera/i,pt=Array.isArray;function ye(t,e){for(var n in e)t[n]=e[n];return t}function Vt(t){t&&t.parentNode&&t.parentNode.removeChild(t)}function Ca(t,e,n){var r,i,s,l={};for(s in e)s=="key"?r=e[s]:s=="ref"?i=e[s]:l[s]=e[s];if(arguments.length>2&&(l.children=arguments.length>3?ht.call(arguments,2):n),typeof t=="function"&&t.defaultProps!=null)for(s in t.defaultProps)l[s]===void 0&&(l[s]=t.defaultProps[s]);return st(t,l,r,i,null)}function st(t,e,n,r,i){var s={type:t,props:e,key:n,ref:r,__k:null,__:null,__b:0,__e:null,__c:null,constructor:void 0,__v:i??++Gn,__i:-1,__u:0};return i==null&&I.vnode!=null&&I.vnode(s),s}function le(t){return t.children}function Ge(t,e){this.props=t,this.context=e}function Me(t,e){if(e==null)return t.__?Me(t.__,t.__i+1):null;for(var n;e<t.__k.length;e++)if((n=t.__k[e])!=null&&n.__e!=null)return n.__e;return typeof t.type=="function"?Me(t):null}function Vn(t){var e,n;if((t=t.__)!=null&&t.__c!=null){for(t.__e=t.__c.base=null,e=0;e<t.__k.length;e++)if((n=t.__k[e])!=null&&n.__e!=null){t.__e=t.__c.base=n.__e;break}return Vn(t)}}function Tn(t){(!t.__d&&(t.__d=!0)&&Te.push(t)&&!ct.__r++||bn!=I.debounceRendering)&&((bn=I.debounceRendering)||Wn)(ct)}function ct(){for(var t,e,n,r,i,s,l,h=1;Te.length;)Te.length>h&&Te.sort(zn),t=Te.shift(),h=Te.length,t.__d&&(n=void 0,r=void 0,i=(r=(e=t).__v).__e,s=[],l=[],e.__P&&((n=ye({},r)).__v=r.__v+1,I.vnode&&I.vnode(n),Yt(e.__P,n,r,e.__n,e.__P.namespaceURI,32&r.__u?[i]:null,s,i??Me(r),!!(32&r.__u),l),n.__v=r.__v,n.__.__k[n.__i]=n,jn(s,n,l),r.__e=r.__=null,n.__e!=i&&Vn(n)));ct.__r=0}function Yn(t,e,n,r,i,s,l,h,p,d,m){var o,u,f,_,b,v,y,g=r&&r.__k||Xn,T=e.length;for(p=wa(n,e,g,p,T),o=0;o<T;o++)(f=n.__k[o])!=null&&(u=f.__i==-1?Be:g[f.__i]||Be,f.__i=o,v=Yt(t,f,u,i,s,l,h,p,d,m),_=f.__e,f.ref&&u.ref!=f.ref&&(u.ref&&Qt(u.ref,null,f),m.push(f.ref,f.__c||_,f)),b==null&&_!=null&&(b=_),(y=!!(4&f.__u))||u.__k===f.__k?p=Qn(f,p,t,y):typeof f.type=="function"&&v!==void 0?p=v:_&&(p=_.nextSibling),f.__u&=-7);return n.__e=b,p}function wa(t,e,n,r,i){var s,l,h,p,d,m=n.length,o=m,u=0;for(t.__k=new Array(i),s=0;s<i;s++)(l=e[s])!=null&&typeof l!="boolean"&&typeof l!="function"?(p=s+u,(l=t.__k[s]=typeof l=="string"||typeof l=="number"||typeof l=="bigint"||l.constructor==String?st(null,l,null,null,null):pt(l)?st(le,{children:l},null,null,null):l.constructor==null&&l.__b>0?st(l.type,l.props,l.key,l.ref?l.ref:null,l.__v):l).__=t,l.__b=t.__b+1,h=null,(d=l.__i=La(l,n,p,o))!=-1&&(o--,(h=n[d])&&(h.__u|=2)),h==null||h.__v==null?(d==-1&&(i>m?u--:i<m&&u++),typeof l.type!="function"&&(l.__u|=4)):d!=p&&(d==p-1?u--:d==p+1?u++:(d>p?u--:u++,l.__u|=4))):t.__k[s]=null;if(o)for(s=0;s<m;s++)(h=n[s])!=null&&!(2&h.__u)&&(h.__e==r&&(r=Me(h)),Zn(h,h));return r}function Qn(t,e,n,r){var i,s;if(typeof t.type=="function"){for(i=t.__k,s=0;i&&s<i.length;s++)i[s]&&(i[s].__=t,e=Qn(i[s],e,n,r));return e}t.__e!=e&&(r&&(e&&t.type&&!e.parentNode&&(e=Me(t)),n.insertBefore(t.__e,e||null)),e=t.__e);do e=e&&e.nextSibling;while(e!=null&&e.nodeType==8);return e}function La(t,e,n,r){var i,s,l,h=t.key,p=t.type,d=e[n],m=d!=null&&(2&d.__u)==0;if(d===null&&t.key==null||m&&h==d.key&&p==d.type)return n;if(r>(m?1:0)){for(i=n-1,s=n+1;i>=0||s<e.length;)if((d=e[l=i>=0?i--:s++])!=null&&!(2&d.__u)&&h==d.key&&p==d.type)return l}return-1}function Nn(t,e,n){e[0]=="-"?t.setProperty(e,n??""):t[e]=n==null?"":typeof n!="number"||Sa.test(e)?n:n+"px"}function et(t,e,n,r,i){var s,l;e:if(e=="style")if(typeof n=="string")t.style.cssText=n;else{if(typeof r=="string"&&(t.style.cssText=r=""),r)for(e in r)n&&e in n||Nn(t.style,e,"");if(n)for(e in n)r&&n[e]==r[e]||Nn(t.style,e,n[e])}else if(e[0]=="o"&&e[1]=="n")s=e!=(e=e.replace(Bn,"$1")),l=e.toLowerCase(),e=l in t||e=="onFocusOut"||e=="onFocusIn"?l.slice(2):e.slice(2),t.l||(t.l={}),t.l[e+s]=n,n?r?n.u=r.u:(n.u=Xt,t.addEventListener(e,s?Ut:Pt,s)):t.removeEventListener(e,s?Ut:Pt,s);else{if(i=="http://www.w3.org/2000/svg")e=e.replace(/xlink(H|:h)/,"h").replace(/sName$/,"s");else if(e!="width"&&e!="height"&&e!="href"&&e!="list"&&e!="form"&&e!="tabIndex"&&e!="download"&&e!="rowSpan"&&e!="colSpan"&&e!="role"&&e!="popover"&&e in t)try{t[e]=n??"";break e}catch{}typeof n=="function"||(n==null||n===!1&&e[4]!="-"?t.removeAttribute(e):t.setAttribute(e,e=="popover"&&n==1?"":n))}}function Sn(t){return function(e){if(this.l){var n=this.l[e.type+t];if(e.t==null)e.t=Xt++;else if(e.t<n.u)return;return n(I.event?I.event(e):e)}}}function Yt(t,e,n,r,i,s,l,h,p,d){var m,o,u,f,_,b,v,y,g,T,S,L,A,H,P,O,he,M=e.type;if(e.constructor!=null)return null;128&n.__u&&(p=!!(32&n.__u),s=[h=e.__e=n.__e]),(m=I.__b)&&m(e);e:if(typeof M=="function")try{if(y=e.props,g="prototype"in M&&M.prototype.render,T=(m=M.contextType)&&r[m.__c],S=m?T?T.props.value:m.__:r,n.__c?v=(o=e.__c=n.__c).__=o.__E:(g?e.__c=o=new M(y,S):(e.__c=o=new Ge(y,S),o.constructor=M,o.render=Ra),T&&T.sub(o),o.props=y,o.state||(o.state={}),o.context=S,o.__n=r,u=o.__d=!0,o.__h=[],o._sb=[]),g&&o.__s==null&&(o.__s=o.state),g&&M.getDerivedStateFromProps!=null&&(o.__s==o.state&&(o.__s=ye({},o.__s)),ye(o.__s,M.getDerivedStateFromProps(y,o.__s))),f=o.props,_=o.state,o.__v=e,u)g&&M.getDerivedStateFromProps==null&&o.componentWillMount!=null&&o.componentWillMount(),g&&o.componentDidMount!=null&&o.__h.push(o.componentDidMount);else{if(g&&M.getDerivedStateFromProps==null&&y!==f&&o.componentWillReceiveProps!=null&&o.componentWillReceiveProps(y,S),!o.__e&&o.shouldComponentUpdate!=null&&o.shouldComponentUpdate(y,o.__s,S)===!1||e.__v==n.__v){for(e.__v!=n.__v&&(o.props=y,o.state=o.__s,o.__d=!1),e.__e=n.__e,e.__k=n.__k,e.__k.some(function(ae){ae&&(ae.__=e)}),L=0;L<o._sb.length;L++)o.__h.push(o._sb[L]);o._sb=[],o.__h.length&&l.push(o);break e}o.componentWillUpdate!=null&&o.componentWillUpdate(y,o.__s,S),g&&o.componentDidUpdate!=null&&o.__h.push(function(){o.componentDidUpdate(f,_,b)})}if(o.context=S,o.props=y,o.__P=t,o.__e=!1,A=I.__r,H=0,g){for(o.state=o.__s,o.__d=!1,A&&A(e),m=o.render(o.props,o.state,o.context),P=0;P<o._sb.length;P++)o.__h.push(o._sb[P]);o._sb=[]}else do o.__d=!1,A&&A(e),m=o.render(o.props,o.state,o.context),o.state=o.__s;while(o.__d&&++H<25);o.state=o.__s,o.getChildContext!=null&&(r=ye(ye({},r),o.getChildContext())),g&&!u&&o.getSnapshotBeforeUpdate!=null&&(b=o.getSnapshotBeforeUpdate(f,_)),O=m,m!=null&&m.type===le&&m.key==null&&(O=Kn(m.props.children)),h=Yn(t,pt(O)?O:[O],e,n,r,i,s,l,h,p,d),o.base=e.__e,e.__u&=-161,o.__h.length&&l.push(o),v&&(o.__E=o.__=null)}catch(ae){if(e.__v=null,p||s!=null)if(ae.then){for(e.__u|=p?160:128;h&&h.nodeType==8&&h.nextSibling;)h=h.nextSibling;s[s.indexOf(h)]=null,e.__e=h}else{for(he=s.length;he--;)Vt(s[he]);Ht(e)}else e.__e=n.__e,e.__k=n.__k,ae.then||Ht(e);I.__e(ae,e,n)}else s==null&&e.__v==n.__v?(e.__k=n.__k,e.__e=n.__e):h=e.__e=Aa(n.__e,e,n,r,i,s,l,p,d);return(m=I.diffed)&&m(e),128&e.__u?void 0:h}function Ht(t){t&&t.__c&&(t.__c.__e=!0),t&&t.__k&&t.__k.forEach(Ht)}function jn(t,e,n){for(var r=0;r<n.length;r++)Qt(n[r],n[++r],n[++r]);I.__c&&I.__c(e,t),t.some(function(i){try{t=i.__h,i.__h=[],t.some(function(s){s.call(i)})}catch(s){I.__e(s,i.__v)}})}function Kn(t){return typeof t!="object"||t==null||t.__b&&t.__b>0?t:pt(t)?t.map(Kn):ye({},t)}function Aa(t,e,n,r,i,s,l,h,p){var d,m,o,u,f,_,b,v=n.props,y=e.props,g=e.type;if(g=="svg"?i="http://www.w3.org/2000/svg":g=="math"?i="http://www.w3.org/1998/Math/MathML":i||(i="http://www.w3.org/1999/xhtml"),s!=null){for(d=0;d<s.length;d++)if((f=s[d])&&"setAttribute"in f==!!g&&(g?f.localName==g:f.nodeType==3)){t=f,s[d]=null;break}}if(t==null){if(g==null)return document.createTextNode(y);t=document.createElementNS(i,g,y.is&&y),h&&(I.__m&&I.__m(e,s),h=!1),s=null}if(g==null)v===y||h&&t.data==y||(t.data=y);else{if(s=s&&ht.call(t.childNodes),v=n.props||Be,!h&&s!=null)for(v={},d=0;d<t.attributes.length;d++)v[(f=t.attributes[d]).name]=f.value;for(d in v)if(f=v[d],d!="children"){if(d=="dangerouslySetInnerHTML")o=f;else if(!(d in y)){if(d=="value"&&"defaultValue"in y||d=="checked"&&"defaultChecked"in y)continue;et(t,d,null,f,i)}}for(d in y)f=y[d],d=="children"?u=f:d=="dangerouslySetInnerHTML"?m=f:d=="value"?_=f:d=="checked"?b=f:h&&typeof f!="function"||v[d]===f||et(t,d,f,v[d],i);if(m)h||o&&(m.__html==o.__html||m.__html==t.innerHTML)||(t.innerHTML=m.__html),e.__k=[];else if(o&&(t.innerHTML=""),Yn(e.type=="template"?t.content:t,pt(u)?u:[u],e,n,r,g=="foreignObject"?"http://www.w3.org/1999/xhtml":i,s,l,s?s[0]:n.__k&&Me(n,0),h,p),s!=null)for(d=s.length;d--;)Vt(s[d]);h||(d="value",g=="progress"&&_==null?t.removeAttribute("value"):_!=null&&(_!==t[d]||g=="progress"&&!_||g=="option"&&_!=v[d])&&et(t,d,_,v[d],i),d="checked",b!=null&&b!=t[d]&&et(t,d,b,v[d],i))}return t}function Qt(t,e,n){try{if(typeof t=="function"){var r=typeof t.__u=="function";r&&t.__u(),r&&e==null||(t.__u=t(e))}else t.current=e}catch(i){I.__e(i,n)}}function Zn(t,e,n){var r,i;if(I.unmount&&I.unmount(t),(r=t.ref)&&(r.current&&r.current!=t.__e||Qt(r,null,e)),(r=t.__c)!=null){if(r.componentWillUnmount)try{r.componentWillUnmount()}catch(s){I.__e(s,e)}r.base=r.__P=null}if(r=t.__k)for(i=0;i<r.length;i++)r[i]&&Zn(r[i],e,n||typeof t.type!="function");n||Vt(t.__e),t.__c=t.__=t.__e=void 0}function Ra(t,e,n){return this.constructor(t,n)}function ka(t,e,n){var r,i,s,l;e==document&&(e=document.documentElement),I.__&&I.__(t,e),i=(r=!1)?null:e.__k,s=[],l=[],Yt(e,t=e.__k=Ca(le,null,[t]),i||Be,Be,e.namespaceURI,i?null:e.firstChild?ht.call(e.childNodes):null,s,i?i.__e:e.firstChild,r,l),jn(s,t,l)}ht=Xn.slice,I={__e:function(t,e,n,r){for(var i,s,l;e=e.__;)if((i=e.__c)&&!i.__)try{if((s=i.constructor)&&s.getDerivedStateFromError!=null&&(i.setState(s.getDerivedStateFromError(t)),l=i.__d),i.componentDidCatch!=null&&(i.componentDidCatch(t,r||{}),l=i.__d),l)return i.__E=i}catch(h){t=h}throw t}},Gn=0,Ge.prototype.setState=function(t,e){var n;n=this.__s!=null&&this.__s!=this.state?this.__s:this.__s=ye({},this.state),typeof t=="function"&&(t=t(ye({},n),this.props)),t&&ye(n,t),t!=null&&this.__v&&(e&&this._sb.push(e),Tn(this))},Ge.prototype.forceUpdate=function(t){this.__v&&(this.__e=!0,t&&this.__h.push(t),Tn(this))},Ge.prototype.render=le,Te=[],Wn=typeof Promise=="function"?Promise.prototype.then.bind(Promise.resolve()):setTimeout,zn=function(t,e){return t.__v.__b-e.__v.__b},ct.__r=0,Bn=/(PointerCapture)$|Capture$/i,Xt=0,Pt=Sn(!1),Ut=Sn(!0);var Oa=0;function a(t,e,n,r,i,s){e||(e={});var l,h,p=e;if("ref"in p)for(h in p={},e)h=="ref"?l=e[h]:p[h]=e[h];var d={type:t,props:p,key:n,ref:l,__k:null,__:null,__b:0,__e:null,__c:null,constructor:void 0,__v:--Oa,__i:-1,__u:0,__source:i,__self:s};if(typeof t=="function"&&(l=t.defaultProps))for(h in l)p[h]===void 0&&(p[h]=l[h]);return I.vnode&&I.vnode(d),d}var Xe,G,Ct,Cn,dt=0,Jn=[],B=I,wn=B.__b,Ln=B.__r,An=B.diffed,Rn=B.__c,kn=B.unmount,On=B.__;function jt(t,e){B.__h&&B.__h(G,t,dt||e),dt=0;var n=G.__H||(G.__H={__:[],__h:[]});return t>=n.__.length&&n.__.push({}),n.__[t]}function N(t){return dt=1,xa(ta,t)}function xa(t,e,n){var r=jt(Xe++,2);if(r.t=t,!r.__c&&(r.__=[ta(void 0,e),function(h){var p=r.__N?r.__N[0]:r.__[0],d=r.t(p,h);p!==d&&(r.__N=[d,r.__[1]],r.__c.setState({}))}],r.__c=G,!G.__f)){var i=function(h,p,d){if(!r.__c.__H)return!0;var m=r.__c.__H.__.filter(function(u){return!!u.__c});if(m.every(function(u){return!u.__N}))return!s||s.call(this,h,p,d);var o=r.__c.props!==h;return m.forEach(function(u){if(u.__N){var f=u.__[0];u.__=u.__N,u.__N=void 0,f!==u.__[0]&&(o=!0)}}),s&&s.call(this,h,p,d)||o};G.__f=!0;var s=G.shouldComponentUpdate,l=G.componentWillUpdate;G.componentWillUpdate=function(h,p,d){if(this.__e){var m=s;s=void 0,i(h,p,d),s=m}l&&l.call(this,h,p,d)},G.shouldComponentUpdate=i}return r.__N||r.__}function K(t,e){var n=jt(Xe++,3);!B.__s&&ea(n.__H,e)&&(n.__=t,n.u=e,G.__H.__h.push(n))}function We(t){return dt=5,Ma(function(){return{current:t}},[])}function Ma(t,e){var n=jt(Xe++,7);return ea(n.__H,e)&&(n.__=t(),n.__H=e,n.__h=t),n.__}function Ia(){for(var t;t=Jn.shift();)if(t.__P&&t.__H)try{t.__H.__h.forEach(lt),t.__H.__h.forEach(qt),t.__H.__h=[]}catch(e){t.__H.__h=[],B.__e(e,t.__v)}}B.__b=function(t){G=null,wn&&wn(t)},B.__=function(t,e){t&&e.__k&&e.__k.__m&&(t.__m=e.__k.__m),On&&On(t,e)},B.__r=function(t){Ln&&Ln(t),Xe=0;var e=(G=t.__c).__H;e&&(Ct===G?(e.__h=[],G.__h=[],e.__.forEach(function(n){n.__N&&(n.__=n.__N),n.u=n.__N=void 0})):(e.__h.forEach(lt),e.__h.forEach(qt),e.__h=[],Xe=0)),Ct=G},B.diffed=function(t){An&&An(t);var e=t.__c;e&&e.__H&&(e.__H.__h.length&&(Jn.push(e)!==1&&Cn===B.requestAnimationFrame||((Cn=B.requestAnimationFrame)||Da)(Ia)),e.__H.__.forEach(function(n){n.u&&(n.__H=n.u),n.u=void 0})),Ct=G=null},B.__c=function(t,e){e.some(function(n){try{n.__h.forEach(lt),n.__h=n.__h.filter(function(r){return!r.__||qt(r)})}catch(r){e.some(function(i){i.__h&&(i.__h=[])}),e=[],B.__e(r,n.__v)}}),Rn&&Rn(t,e)},B.unmount=function(t){kn&&kn(t);var e,n=t.__c;n&&n.__H&&(n.__H.__.forEach(function(r){try{lt(r)}catch(i){e=i}}),n.__H=void 0,e&&B.__e(e,n.__v))};var xn=typeof requestAnimationFrame=="function";function Da(t){var e,n=function(){clearTimeout(r),xn&&cancelAnimationFrame(e),setTimeout(t)},r=setTimeout(n,35);xn&&(e=requestAnimationFrame(n))}function lt(t){var e=G,n=t.__c;typeof n=="function"&&(t.__c=void 0,n()),G=e}function qt(t){var e=G;t.__c=t.__(),G=e}function ea(t,e){return!t||t.length!==e.length||e.some(function(n,r){return n!==t[r]})}function ta(t,e){return typeof e=="function"?e(t):e}const Fa={maxQueueSize:50,defaultTimeout:1e4,maxTimeout:3e4};class Pa{constructor(e={}){x(this,"queue",[]);x(this,"processing",!1);x(this,"nextId",1);x(this,"config");x(this,"stats",{totalProcessed:0,totalTimeouts:0,totalErrors:0});this.config={...Fa,...e}}async enqueue(e,n){if(this.queue.length>=this.config.maxQueueSize)throw new Error(`Query queue full (${this.config.maxQueueSize} items). Too many pending queries.`);const r=Math.min(n||this.config.defaultTimeout,this.config.maxTimeout);return new Promise((i,s)=>{const l={id:this.nextId++,execute:e,resolve:i,reject:s,timeout:r,enqueuedAt:Date.now()};this.queue.push(l),this.processing||this.processQueue()})}async processQueue(){if(!(this.processing||this.queue.length===0)){for(this.processing=!0;this.queue.length>0;){const e=this.queue.shift();try{await this.executeWithTimeout(e)}catch{}}this.processing=!1}}async executeWithTimeout(e){const n=new Promise((r,i)=>{setTimeout(()=>{i(new Error(`Query ${e.id} timed out after ${e.timeout}ms`))},e.timeout)});try{const r=await Promise.race([e.execute(),n]);this.stats.totalProcessed++,e.resolve(r)}catch(r){r instanceof Error&&r.message.includes("timed out")?(this.stats.totalTimeouts++,console.warn(`[QueryQueue] Query ${e.id} timed out`,{timeout:e.timeout,waitTime:Date.now()-e.enqueuedAt})):this.stats.totalErrors++,e.reject(r)}}getStats(){return{queueLength:this.queue.length,busy:this.processing,totalProcessed:this.stats.totalProcessed,totalTimeouts:this.stats.totalTimeouts,totalErrors:this.stats.totalErrors}}isBusy(){return this.processing||this.queue.length>0}clear(){const e=new Error("Query queue cleared");for(const n of this.queue)n.reject(e);this.queue=[]}get length(){return this.queue.length}}let wt=null;function $t(t){return wt||(wt=new Pa(t)),wt}function Ua(t,e){return $t().enqueue(t,e)}class na{constructor(){x(this,"worker",null);x(this,"nextId",1);x(this,"pending",new Map);this.initWorker()}initWorker(){this.worker=new Worker(new URL("/assets/sqlite.worker-1fi7TKBZ.js",import.meta.url),{type:"module"}),this.worker.onmessage=e=>{const n=e.data;if("type"in n&&n.type==="READY"){console.log("[DbClient] Worker ready");return}const{id:r,response:i}=n,s=this.pending.get(r);s&&(this.pending.delete(r),s.resolve(i))},this.worker.onerror=e=>{console.error("[DbClient] Worker error:",e);for(const n of this.pending.values())n.reject(new Error("Worker error"));this.pending.clear()}}async sendRequest(e,n=1e4){if(!this.worker)throw new Error("Worker not initialized");const r=this.nextId++;return Ua(async()=>new Promise((i,s)=>{const l=setTimeout(()=>{this.pending.delete(r),s(new Error(`Request ${e.type} timed out after ${n}ms`))},n);this.pending.set(r,{resolve:p=>{clearTimeout(l),p.ok?i(p.data):s(new Error(p.error))},reject:p=>{clearTimeout(l),s(p)},timeout:l});const h={id:r,request:e};this.worker.postMessage(h)}),n)}async openFromFile(e){return this.sendRequest({type:"OPEN_FROM_FILE",file:e})}async openFromOpfs(e){return this.sendRequest({type:"OPEN_FROM_OPFS",path:e})}async openDemo(){return this.sendRequest({type:"OPEN_DEMO"})}async saveToOpfs(e){return this.sendRequest({type:"SAVE_TO_OPFS",path:e})}async removeFromOpfs(e){return this.sendRequest({type:"REMOVE_FROM_OPFS",path:e})}async listOpfsFiles(){return this.sendRequest({type:"LIST_OPFS_FILES"})}async close(){return this.sendRequest({type:"CLOSE"})}async searchFts(e,n=20,r,i){return this.sendRequest({type:"FTS_SEARCH",query:e,limit:n,entityType:r,entityValue:i})}async searchHybrid(e,n=20,r){return this.sendRequest({type:"HYBRID_SEARCH",query:e,limit:n,weights:r})}async listEntities(e,n=100){return this.sendRequest({type:"LIST_ENTITIES",entityType:e,limit:n})}async getPageList(e=100,n=0){return this.sendRequest({type:"GET_PAGE_LIST",limit:e,offset:n})}async getPageBlob(e){return this.sendRequest({type:"GET_PAGE_BLOB",name:e})}async verifyPage(e){return this.sendRequest({type:"VERIFY_PAGE",gid:e})}async getCheckpoints(){return this.sendRequest({type:"GET_CHECKPOINTS"})}async graphHops(e,n,r,i){return this.sendRequest({type:"GRAPH_HOPS",seedGid:e,predicate:n,maxHops:r,limit:i})}async query(e,n=[]){return this.sendRequest({type:"QUERY",sql:e,params:n})}async exportDatabase(){return this.sendRequest({type:"EXPORT_DATABASE"})}async hasEnvelopeTables(e){return this.sendRequest({type:"HAS_ENVELOPE_TABLES",fileBytes:e})}async extractEnvelope(e){return this.sendRequest({type:"EXTRACT_ENVELOPE",file:e})}getQueueStats(){return $t().getStats()}isQueueBusy(){return $t().isBusy()}terminate(){this.worker&&(this.worker.terminate(),this.worker=null);for(const e of this.pending.values())clearTimeout(e.timeout),e.reject(new Error("Worker terminated"));this.pending.clear()}}let Lt=null;function oe(){return Lt||(Lt=new na),Lt}class Ha{constructor(){x(this,"bus",new EventTarget);x(this,"topics",new Set);x(this,"eventLog",[]);x(this,"maxLogSize",100)}publish(e,n){this.topics.add(e);const r={topic:e,data:n,timestamp:Date.now()};this.bus.dispatchEvent(new CustomEvent(e,{detail:r}))}subscribe(e,n){const r=i=>{const s=i;n(s.detail.data,s.detail)};return this.bus.addEventListener(e,r),()=>{this.bus.removeEventListener(e,r)}}subscribeMany(e,n){const r=e.map(i=>this.subscribe(i,(s,l)=>n(i,s,l)));return()=>{r.forEach(i=>i())}}getActiveTopics(){return Array.from(this.topics)}getRecentEvents(e){return[]}clearEventLog(){this.eventLog=[]}getStats(){const e={};return{activeTopics:this.topics.size,eventLogSize:this.eventLog.length,topicCounts:e}}}const ce=new Ha,qa=t=>ce.publish("retrieval.query",t),$a=t=>ce.publish("retrieval.result",t),Ga=t=>ce.publish("llm.prompt",t),Wa=t=>ce.publish("llm.output",t),za=t=>ce.publish("llm.citation",t),Ba=t=>ce.publish("feedback.signal",t),Mn=t=>ce.publish("capsule.loaded",t),Xa=()=>ce.publish("capsule.unloaded",{}),Va=`-- GlyphCase Envelope Schema v1.1
-- Append-only episodic memory layer for Dynamic GlyphCases
-- This schema represents the mutable, hash-chained memory buffer
-- that sits alongside the immutable Core.

-- ============================================================================
-- METADATA
-- ============================================================================

-- Envelope metadata and configuration
CREATE TABLE IF NOT EXISTS _envelope_meta (
  key TEXT PRIMARY KEY,
  value TEXT NOT NULL
) STRICT;

-- Core metadata values:
-- 'gcase_id' - SHA256 hash of the Core capsule this envelope is linked to
-- 'created_at' - ISO8601 timestamp of envelope creation
-- 'format_version' - Envelope schema version (1.1)
-- 'last_hash' - Most recent hash in the chain

-- ============================================================================
-- HASH CHAIN (Merkle Integrity)
-- ============================================================================

-- Hash chain for append-only integrity verification
-- Each block represents a batch of appends with a Merkle root
CREATE TABLE IF NOT EXISTS _env_chain (
  seq INTEGER PRIMARY KEY AUTOINCREMENT,
  block_hash TEXT NOT NULL UNIQUE,
  parent_hash TEXT NOT NULL,
  block_type TEXT NOT NULL, -- 'retrieval' | 'embedding' | 'feedback' | 'summary'
  row_count INTEGER NOT NULL DEFAULT 1,
  created_at TEXT NOT NULL DEFAULT (datetime('now'))
) STRICT;

CREATE INDEX IF NOT EXISTS idx_chain_block_type ON _env_chain(block_type);
CREATE INDEX IF NOT EXISTS idx_chain_created_at ON _env_chain(created_at);

-- ============================================================================
-- RETRIEVAL LOGS
-- ============================================================================

-- Logs every search/retrieval operation performed
-- Enables learning from query patterns and improving relevance
CREATE TABLE IF NOT EXISTS env_retrieval_log (
  id TEXT PRIMARY KEY,
  seq INTEGER NOT NULL REFERENCES _env_chain(seq),
  ts TEXT NOT NULL DEFAULT (datetime('now')),
  query_text TEXT NOT NULL,
  query_type TEXT NOT NULL CHECK(query_type IN ('fts', 'vector', 'hybrid', 'graph')),
  top_docs TEXT, -- JSON array of {gid, score, snippet}
  hit_count INTEGER NOT NULL DEFAULT 0,
  parent_hash TEXT NOT NULL
) STRICT;

CREATE INDEX IF NOT EXISTS idx_retrieval_ts ON env_retrieval_log(ts);
CREATE INDEX IF NOT EXISTS idx_retrieval_type ON env_retrieval_log(query_type);
CREATE INDEX IF NOT EXISTS idx_retrieval_query ON env_retrieval_log(query_text);

-- ============================================================================
-- CONTEXTUAL EMBEDDINGS
-- ============================================================================

-- Runtime-generated embeddings for queries, responses, and context
-- Provides adaptive semantic memory beyond the canonical Core vectors
CREATE TABLE IF NOT EXISTS env_embeddings (
  id TEXT PRIMARY KEY,
  seq INTEGER NOT NULL REFERENCES _env_chain(seq),
  source TEXT NOT NULL, -- 'user_query' | 'llm_response' | 'context_window' | 'feedback_cluster'
  vector BLOB NOT NULL,
  metadata TEXT, -- JSON metadata about this embedding
  created_at TEXT NOT NULL DEFAULT (datetime('now')),
  parent_hash TEXT NOT NULL
) STRICT;

CREATE INDEX IF NOT EXISTS idx_embeddings_source ON env_embeddings(source);
CREATE INDEX IF NOT EXISTS idx_embeddings_created ON env_embeddings(created_at);

-- ============================================================================
-- USER FEEDBACK
-- ============================================================================

-- User ratings and feedback on retrievals and responses
-- Enables learning from human signals and improving relevance over time
CREATE TABLE IF NOT EXISTS env_feedback (
  id TEXT PRIMARY KEY,
  seq INTEGER NOT NULL REFERENCES _env_chain(seq),
  retrieval_id TEXT REFERENCES env_retrieval_log(id),
  rating INTEGER NOT NULL CHECK(rating IN (-1, 0, 1)), -- -1 (bad) | 0 (neutral) | 1 (good)
  notes TEXT,
  created_at TEXT NOT NULL DEFAULT (datetime('now')),
  parent_hash TEXT NOT NULL
) STRICT;

CREATE INDEX IF NOT EXISTS idx_feedback_rating ON env_feedback(rating);
CREATE INDEX IF NOT EXISTS idx_feedback_retrieval ON env_feedback(retrieval_id);
CREATE INDEX IF NOT EXISTS idx_feedback_created ON env_feedback(created_at);

-- ============================================================================
-- CONTEXT SUMMARIES
-- ============================================================================

-- LLM-generated context summaries and insights
-- Captures high-level understanding and reasoning patterns
CREATE TABLE IF NOT EXISTS env_context_summaries (
  id TEXT PRIMARY KEY,
  seq INTEGER NOT NULL REFERENCES _env_chain(seq),
  summary TEXT NOT NULL,
  relevance REAL NOT NULL CHECK(relevance >= 0.0 AND relevance <= 1.0),
  source_retrievals TEXT, -- JSON array of retrieval_log IDs
  created_at TEXT NOT NULL DEFAULT (datetime('now')),
  parent_hash TEXT NOT NULL
) STRICT;

CREATE INDEX IF NOT EXISTS idx_summaries_relevance ON env_context_summaries(relevance);
CREATE INDEX IF NOT EXISTS idx_summaries_created ON env_context_summaries(created_at);

-- ============================================================================
-- VIEWS
-- ============================================================================

-- Recent activity view (last 100 events)
CREATE VIEW IF NOT EXISTS v_recent_activity AS
SELECT
  'retrieval' as event_type,
  id,
  ts as timestamp,
  query_text as description,
  hit_count as value
FROM env_retrieval_log
UNION ALL
SELECT
  'feedback' as event_type,
  id,
  created_at as timestamp,
  notes as description,
  rating as value
FROM env_feedback
UNION ALL
SELECT
  'summary' as event_type,
  id,
  created_at as timestamp,
  substr(summary, 1, 100) as description,
  relevance as value
FROM env_context_summaries
ORDER BY timestamp DESC
LIMIT 100;

-- Envelope statistics view
CREATE VIEW IF NOT EXISTS v_envelope_stats AS
SELECT
  (SELECT COUNT(*) FROM env_retrieval_log) as retrieval_count,
  (SELECT COUNT(*) FROM env_embeddings) as embedding_count,
  (SELECT COUNT(*) FROM env_feedback) as feedback_count,
  (SELECT COUNT(*) FROM env_context_summaries) as summary_count,
  (SELECT COUNT(*) FROM _env_chain) as chain_length,
  (SELECT MIN(ts) FROM env_retrieval_log) as first_activity,
  (SELECT MAX(ts) FROM env_retrieval_log) as last_activity;

-- Search analytics view
CREATE VIEW IF NOT EXISTS v_search_analytics AS
SELECT
  COUNT(*) as total_queries,
  COUNT(CASE WHEN hit_count = 0 THEN 1 END) as zero_result_queries,
  COUNT(CASE WHEN hit_count > 0 THEN 1 END) as successful_queries,
  ROUND(COUNT(CASE WHEN hit_count = 0 THEN 1 END) * 100.0 / COUNT(*), 2) as zero_result_rate,
  AVG(hit_count) as avg_hit_count,
  COUNT(DISTINCT query_text) as unique_queries,
  query_type,
  date(ts) as query_date
FROM env_retrieval_log
GROUP BY query_type, query_date
ORDER BY query_date DESC;

-- Zero-result queries view (for improving search)
CREATE VIEW IF NOT EXISTS v_zero_result_queries AS
SELECT
  query_text,
  query_type,
  ts,
  COUNT(*) as attempt_count
FROM env_retrieval_log
WHERE hit_count = 0
GROUP BY query_text, query_type
ORDER BY attempt_count DESC, ts DESC;
`;async function tt(t){const e=JSON.stringify({table:t.table,id:t.rowId,data:Gt(t.data),parent:t.parentHash,ts:t.timestamp}),r=new TextEncoder().encode(e),i=await crypto.subtle.digest("SHA-256",r);return Array.from(new Uint8Array(i)).map(l=>l.toString(16).padStart(2,"0")).join("")}function Gt(t){if(t instanceof Float32Array)return{__type:"Float32Array",values:Array.from(t)};if(Array.isArray(t))return t.map(Gt);if(t&&typeof t=="object"){const e={};for(const[n,r]of Object.entries(t))e[n]=Gt(r);return e}return t}class nt{constructor(e,n){x(this,"lastHash");x(this,"db");x(this,"genesis","0".repeat(64));this.db=e,this.lastHash=n||this.genesis}getCurrentHash(){return this.lastHash}async appendRetrieval(e){const n=new Date().toISOString(),r=await tt({table:"retrieval_log",rowId:e.id,data:e,parentHash:this.lastHash,timestamp:n}),i=this.db.prepare(`
      INSERT INTO env_retrieval_log
      (id, query_text, query_type, top_docs, hit_count, parent_hash, ts)
      VALUES (?, ?, ?, ?, ?, ?, ?)
    `);try{i.bind([e.id,e.query_text,e.query_type,e.top_docs?JSON.stringify(e.top_docs):null,e.hit_count,this.lastHash,n]),i.step()}finally{i.finalize()}return await this.recordChainBlock(r,"retrieval",1),this.lastHash=r,r}async appendEmbedding(e){const n=new Date().toISOString(),r=await tt({table:"embeddings",rowId:e.id,data:e,parentHash:this.lastHash,timestamp:n}),i=new Uint8Array(e.vector.buffer),s=this.db.prepare(`
      INSERT INTO env_embeddings
      (id, source, vector, metadata, parent_hash, created_at)
      VALUES (?, ?, ?, ?, ?, ?)
    `);try{s.bind([e.id,e.source,i,e.metadata?JSON.stringify(e.metadata):null,this.lastHash,n]),s.step()}finally{s.finalize()}return await this.recordChainBlock(r,"embedding",1),this.lastHash=r,r}async appendFeedback(e){const n=new Date().toISOString(),r=await tt({table:"feedback",rowId:e.id,data:e,parentHash:this.lastHash,timestamp:n}),i=this.db.prepare(`
      INSERT INTO env_feedback
      (id, retrieval_id, rating, notes, parent_hash, created_at)
      VALUES (?, ?, ?, ?, ?, ?)
    `);try{i.bind([e.id,e.retrieval_id||null,e.rating,e.notes||null,this.lastHash,n]),i.step()}finally{i.finalize()}return await this.recordChainBlock(r,"feedback",1),this.lastHash=r,r}async appendSummary(e){const n=new Date().toISOString(),r=await tt({table:"summaries",rowId:e.id,data:e,parentHash:this.lastHash,timestamp:n}),i=this.db.prepare(`
      INSERT INTO env_context_summaries
      (id, summary, relevance, source_retrievals, parent_hash, created_at)
      VALUES (?, ?, ?, ?, ?, ?)
    `);try{i.bind([e.id,e.summary,e.relevance,e.source_retrievals?JSON.stringify(e.source_retrievals):null,this.lastHash,n]),i.step()}finally{i.finalize()}return await this.recordChainBlock(r,"summary",1),this.lastHash=r,r}async recordChainBlock(e,n,r){const i=this.db.prepare(`
      INSERT INTO _env_chain (block_hash, parent_hash, block_type, row_count)
      VALUES (?, ?, ?, ?)
    `);try{i.bind([e,this.lastHash,n,r]),i.step();const l=this.db.prepare("SELECT last_insert_rowid()");try{l.step();const h=l.get([])[0],p=this.db.prepare(`
          UPDATE env_${n==="retrieval"?"retrieval_log":n==="embedding"?"embeddings":n==="feedback"?"feedback":"context_summaries"}
          SET seq = ?
          WHERE parent_hash = ?
        `);try{p.bind([h,this.lastHash]),p.step()}finally{p.finalize()}}finally{l.finalize()}}finally{i.finalize()}const s=this.db.prepare(`
      INSERT OR REPLACE INTO _envelope_meta (key, value) VALUES ('last_hash', ?)
    `);try{s.bind([e]),s.step()}finally{s.finalize()}}async verifyChain(){const e=[],n=this.db.prepare(`
      SELECT seq, block_hash, parent_hash, block_type
      FROM _env_chain
      ORDER BY seq ASC
    `),r=[];try{for(;n.step();){const i=n.get([]);r.push({seq:i[0],block_hash:i[1],parent_hash:i[2],block_type:i[3],row_count:0,created_at:""})}}finally{n.finalize()}for(let i=1;i<r.length;i++){const s=r[i],l=r[i-1];s.parent_hash!==l.block_hash&&e.push(`Chain break at seq ${s.seq}: parent_hash ${s.parent_hash} does not match previous block_hash ${l.block_hash}`)}return{valid:e.length===0,errors:e}}getChainStats(){const e=this.db.prepare(`
      SELECT block_type, COUNT(*) as count
      FROM _env_chain
      GROUP BY block_type
    `),n={};try{for(;e.step();){const s=e.get([]);n[s[0]]=s[1]}}finally{e.finalize()}const r=this.db.prepare("SELECT COUNT(*) FROM _env_chain");let i=0;try{r.step(),i=r.get([])[0]}finally{r.finalize()}return{length:i,currentHash:this.lastHash,types:n}}}function aa(t="env"){const e=Date.now().toString(36),n=Math.random().toString(36).substring(2,9);return`${t}_${e}_${n}`}async function at(t){const e=await t.arrayBuffer(),n=await crypto.subtle.digest("SHA-256",e);return Array.from(new Uint8Array(n)).map(i=>i.toString(16).padStart(2,"0")).join("")}class ut{constructor(){x(this,"db",null);x(this,"writer",null);x(this,"gcaseId",null);x(this,"opfsPath",null);x(this,"sqlite3",null)}static async exists(e){try{const n=await at(e),r=`/envelopes/${n}.db`;return await(await(await navigator.storage.getDirectory()).getDirectoryHandle("envelopes",{create:!1})).getFileHandle(`${n}.db`,{create:!1}),!0}catch{return!1}}static hasEnvelopeTables(e,n){const r=new e.oo1.DB(":memory:");try{if(e.capi.sqlite3_deserialize(r.pointer,"main",n,n.byteLength,n.byteLength,e.capi.SQLITE_DESERIALIZE_FREEONCLOSE|e.capi.SQLITE_DESERIALIZE_RESIZEABLE)!==0)return!1;const s=r.prepare(`
        SELECT COUNT(*) FROM sqlite_master
        WHERE type='table' AND name='_envelope_meta'
      `);try{if(s.step())return s.get([])[0]>0}finally{s.finalize()}return!1}catch(i){return console.warn("[Envelope] Error checking for envelope tables:",i),!1}finally{r.close()}}async extractFromCanonical(e,n,r){this.sqlite3=n,this.gcaseId=await at(e),this.opfsPath=`/envelopes/${this.gcaseId}.db`,console.log("[Envelope] Extracting envelope from canonical .gcase+ file..."),await(await navigator.storage.getDirectory()).getDirectoryHandle("envelopes",{create:!0}),this.db=new n.oo1.OpfsDb(this.opfsPath,"c");const s=new n.oo1.DB(":memory:");try{const p=n.capi.sqlite3_deserialize(s.pointer,"main",r,r.byteLength,r.byteLength,n.capi.SQLITE_DESERIALIZE_FREEONCLOSE|n.capi.SQLITE_DESERIALIZE_RESIZEABLE);if(p!==0)throw new Error(`Failed to deserialize source database: ${p}`);s.exec(`ATTACH DATABASE '${this.opfsPath}' AS sidecar`);const d=["_envelope_meta","_env_chain","env_retrieval_log","env_embeddings","env_feedback","env_context_summaries"];for(const u of d){const f=s.prepare(`
          SELECT sql FROM main.sqlite_master
          WHERE type='table' AND name=?
        `);try{if(f.bind([u]),f.step()){const _=f.get([])[0];if(_){const b=_.replace(/CREATE TABLE/,"CREATE TABLE sidecar.");s.exec(b),console.log(`[Envelope] Created sidecar table: ${u}`),s.exec(`INSERT INTO sidecar.${u} SELECT * FROM main.${u}`);const v=s.prepare(`SELECT COUNT(*) FROM sidecar.${u}`);try{v.step();const y=v.get([])[0];console.log(`[Envelope] Copied ${y} rows to ${u}`)}finally{v.finalize()}}}}finally{f.finalize()}}const m=["v_recent_activity","v_envelope_stats","v_search_analytics","v_zero_result_queries"];for(const u of m){const f=s.prepare(`
          SELECT sql FROM main.sqlite_master
          WHERE type='view' AND name=?
        `);try{if(f.bind([u]),f.step()){const _=f.get([])[0];if(_){const b=_.replace(/CREATE VIEW/,"CREATE VIEW sidecar.");s.exec(b),console.log(`[Envelope] Created view: ${u}`)}}}finally{f.finalize()}}const o=s.prepare(`
        SELECT sql FROM main.sqlite_master
        WHERE type='index' AND sql IS NOT NULL AND name LIKE 'idx_%'
      `);try{for(;o.step();){const u=o.get([])[0];if(u&&(u.includes("env_")||u.includes("_env_")))try{const f=u.replace(/ON\s+(\w+)/,"ON sidecar.$1");s.exec(f)}catch(f){console.warn("[Envelope] Index copy failed:",f)}}}finally{o.finalize()}s.exec("DETACH DATABASE sidecar"),console.log("[Envelope] Extraction complete")}finally{s.close()}const l=this.db.prepare(`
      SELECT value FROM _envelope_meta WHERE key = 'last_hash'
    `);let h="0".repeat(64);try{l.step()&&(h=l.get([])[0])}finally{l.finalize()}this.writer=new nt(this.db,h),console.log(`[Envelope] Extracted envelope for ${this.gcaseId}`)}async create(e,n){this.sqlite3=n,this.gcaseId=await at(e),this.opfsPath=`/envelopes/${this.gcaseId}.db`,await(await navigator.storage.getDirectory()).getDirectoryHandle("envelopes",{create:!0}),this.db=new n.oo1.OpfsDb(this.opfsPath,"c"),this.db.exec(Va);const i=new Date().toISOString(),s="0".repeat(64),l=this.db.prepare(`
      INSERT INTO _envelope_meta (key, value) VALUES
      ('gcase_id', ?),
      ('created_at', ?),
      ('format_version', '1.1'),
      ('last_hash', ?)
    `);try{l.bind([this.gcaseId,i,s]),l.step()}finally{l.finalize()}this.writer=new nt(this.db,s),console.log(`[Envelope] Created new envelope for ${this.gcaseId}`)}async load(e,n){this.sqlite3=n,this.gcaseId=await at(e),this.opfsPath=`/envelopes/${this.gcaseId}.db`,this.db=new n.oo1.OpfsDb(this.opfsPath,"w");const r=this.db.prepare(`
      SELECT value FROM _envelope_meta WHERE key = 'last_hash'
    `);let i="0".repeat(64);try{r.step()&&(i=r.get([])[0])}finally{r.finalize()}this.writer=new nt(this.db,i),console.log(`[Envelope] Loaded existing envelope for ${this.gcaseId}`)}async open(e,n){await ut.exists(e)?await this.load(e,n):await this.create(e,n)}close(){this.db&&(this.db.close(),this.db=null,this.writer=null,this.gcaseId=null,console.log("[Envelope] Closed envelope database"))}getWriter(){return this.writer}getStats(){if(!this.db)return null;const e=this.db.prepare("SELECT * FROM v_envelope_stats");try{if(e.step()){const n=e.get([]);return{retrievalCount:n[0]||0,embeddingCount:n[1]||0,feedbackCount:n[2]||0,summaryCount:n[3]||0,chainLength:n[4]||0,firstActivity:n[5]||null,lastActivity:n[6]||null}}}finally{e.finalize()}return null}getMeta(){if(!this.db)return null;const e=this.db.prepare("SELECT key, value FROM _envelope_meta"),n={};try{for(;e.step();){const r=e.get([]);n[r[0]]=r[1]}}finally{e.finalize()}return{gcaseId:n.gcase_id||"",createdAt:n.created_at||"",formatVersion:n.format_version||"1.1",lastHash:n.last_hash||""}}async clear(){if(!this.db)return;this.db.exec(`
      DELETE FROM env_retrieval_log;
      DELETE FROM env_embeddings;
      DELETE FROM env_feedback;
      DELETE FROM env_context_summaries;
      DELETE FROM _env_chain;
    `);const e="0".repeat(64),n=this.db.prepare(`
      UPDATE _envelope_meta SET value = ? WHERE key = 'last_hash'
    `);try{n.bind([e]),n.step()}finally{n.finalize()}this.writer=new nt(this.db,e),console.log("[Envelope] Cleared all envelope data")}async exportSidecar(){if(!this.db||!this.opfsPath)throw new Error("No envelope sidecar open");return await(await(await(await navigator.storage.getDirectory()).getDirectoryHandle("envelopes")).getFileHandle(`${this.gcaseId}.db`)).getFile()}getRecentActivity(e=20){if(!this.db)return[];const n=this.db.prepare(`
      SELECT event_type, id, timestamp, description, value
      FROM v_recent_activity
      LIMIT ?
    `),r=[];try{for(n.bind([e]);n.step();){const i=n.get([]);r.push({eventType:i[0],id:i[1],timestamp:i[2],description:i[3],value:i[4]})}}finally{n.finalize()}return r}async verify(){return this.writer?this.writer.verifyChain():{valid:!1,errors:["No envelope writer available"]}}getDatabase(){return this.db}isOpen(){return this.db!==null}getOpfsPath(){return this.opfsPath}getGCaseId(){return this.gcaseId}async mergeWithCore(e){if(!this.db||!this.opfsPath||!this.sqlite3)throw new Error("No envelope sidecar open or sqlite3 not available");console.log(`[Envelope] Merging Core (${e.byteLength} bytes) with Envelope sidecar...`);const n=new this.sqlite3.oo1.DB(":memory:");try{const r=this.sqlite3.capi.sqlite3_deserialize(n.pointer,"main",e,e.byteLength,e.byteLength,this.sqlite3.capi.SQLITE_DESERIALIZE_FREEONCLOSE|this.sqlite3.capi.SQLITE_DESERIALIZE_RESIZEABLE);if(r!==0)throw new Error(`Failed to deserialize Core database: ${r}`);console.log("[Envelope] Core database loaded into memory"),n.exec(`ATTACH DATABASE '${this.opfsPath}' AS envelope`),console.log("[Envelope] Attached sidecar database");const i=["_envelope_meta","_env_chain","env_retrieval_log","env_embeddings","env_feedback","env_context_summaries"];for(const p of i){const d=n.prepare(`
          SELECT sql FROM envelope.sqlite_master
          WHERE type='table' AND name=?
        `);try{if(d.bind([p]),d.step()){const m=d.get([])[0];if(m){n.exec(m),console.log(`[Envelope] Created table: ${p}`),n.exec(`INSERT INTO main.${p} SELECT * FROM envelope.${p}`);const o=n.prepare(`SELECT COUNT(*) FROM main.${p}`);try{o.step();const u=o.get([])[0];console.log(`[Envelope] Copied ${u} rows to ${p}`)}finally{o.finalize()}}}}finally{d.finalize()}}const s=["v_recent_activity","v_envelope_stats","v_search_analytics","v_zero_result_queries"];for(const p of s){const d=n.prepare(`
          SELECT sql FROM envelope.sqlite_master
          WHERE type='view' AND name=?
        `);try{if(d.bind([p]),d.step()){const m=d.get([])[0];m&&(n.exec(m),console.log(`[Envelope] Created view: ${p}`))}}finally{d.finalize()}}const l=n.prepare(`
        SELECT sql FROM envelope.sqlite_master
        WHERE type='index' AND sql IS NOT NULL
      `);try{for(;l.step();){const p=l.get([])[0];if(p)try{n.exec(p)}catch(d){console.warn("[Envelope] Index already exists or failed:",d)}}}finally{l.finalize()}n.exec("DETACH DATABASE envelope"),console.log("[Envelope] Detached sidecar");const h=this.sqlite3.capi.sqlite3_js_db_export(n.pointer);if(!h)throw new Error("Failed to export merged database");return console.log(`[Envelope] Merged database exported: ${h.byteLength} bytes`),new Blob([h],{type:"application/x-sqlite3"})}finally{n.close()}}}class Ya{constructor(){x(this,"dbClient");x(this,"envelopeManager");x(this,"currentModality","static");x(this,"currentFile",null);x(this,"currentInfo",null);this.dbClient=new na,this.envelopeManager=new ut}getModalityPreference(){return localStorage.getItem("glyphcase.modality")||"auto"}setModalityPreference(e){localStorage.setItem("glyphcase.modality",e)}async detectModality(e){const n=this.getModalityPreference();return n==="static"?"static":n==="dynamic"||await ut.exists(e)?"dynamic":"static"}async openFromFile(e,n){this.currentFile=e;const r=new Uint8Array(await e.arrayBuffer()),i=await this.dbClient.hasEnvelopeTables(r);i&&(console.log("[GlyphCase] Detected canonical .gcase+ file with embedded envelope"),await this.dbClient.extractEnvelope(e),console.log("[GlyphCase] Envelope extracted to runtime sidecar"));const s=await this.dbClient.openFromFile(e);let l;n!==void 0?l=n?"dynamic":"static":i?l="dynamic":l=await this.detectModality(e),this.currentModality=l;let h;return l==="dynamic"&&(h=this.envelopeManager.getStats()||void 0,console.log("[GlyphCase] Dynamic mode active with envelope sidecar")),this.currentInfo={...s,modality:l,envelopeStats:h,envelopeExtracted:i},Mn({gid:s.docId||"unknown",title:s.title||"Untitled",modality:l}),this.currentInfo}async openDemo(){const e=await this.dbClient.openDemo();return this.currentModality="static",this.currentInfo={...e,modality:"static"},Mn({gid:e.docId||"demo",title:e.title||"Demo",modality:"static"}),this.currentInfo}async enableDynamicMode(){if(!this.currentFile)throw new Error("No capsule loaded");if(this.currentModality==="dynamic"){console.log("[GlyphCase] Already in dynamic mode");return}this.currentModality="dynamic",this.currentInfo&&(this.currentInfo.modality="dynamic"),console.log("[GlyphCase] Enabled dynamic mode")}getModality(){return this.currentModality}getInfo(){return this.currentInfo}isDynamic(){return this.currentModality==="dynamic"}getCore(){return this.dbClient}getEnvelope(){return this.envelopeManager}getStream(){return ce}async close(){this.envelopeManager.isOpen()&&this.envelopeManager.close(),await this.dbClient.close(),this.currentModality="static",this.currentFile=null,this.currentInfo=null,Xa()}async saveGlyphCase(){const e=await this.dbClient.exportDatabase();return this.currentModality==="static"||!this.envelopeManager.isOpen()?(console.log("[GlyphCase] Saving Standard GlyphCase (Core only)"),new Blob([e],{type:"application/x-sqlite3"})):(console.log("[GlyphCase] Saving Dynamic GlyphCase (.gcase+)"),this.envelopeManager.mergeWithCore(e))}async exportGlyphCase(){return this.saveGlyphCase()}async exportEnvelopeSidecar(){return this.envelopeManager.isOpen()?this.envelopeManager.exportSidecar():null}async clearEnvelope(){this.envelopeManager.isOpen()&&(await this.envelopeManager.clear(),this.currentInfo&&(this.currentInfo.envelopeStats=this.envelopeManager.getStats()||void 0))}getEnvelopeStats(){return this.envelopeManager.getStats()}async verifyEnvelope(){return this.envelopeManager.isOpen()?this.envelopeManager.verify():null}}const q=new Ya;function ra(t={}){const{defaultMode:e="hybrid",maxResults:n=10,maxGraphHops:r=2,debounceMs:i=300}=t,[s,l]=N(e),[h,p]=N(null),[d,m]=N(""),[o,u]=N(!1),[f,_]=N(null),[b,v]=N({}),[y,g]=N(""),[T,S]=N(()=>{try{const R=localStorage.getItem("memglyph-search-history");return R?JSON.parse(R):[]}catch{return[]}}),L=We(null);K(()=>{if(y.trim())return L.current&&clearTimeout(L.current),L.current=window.setTimeout(()=>{P(y)},i),()=>{L.current&&clearTimeout(L.current)}},[y,s,b]);const A=R=>{if(!R.trim())return;const ie=R.trim();S(J=>{const W=J.filter(X=>X!==ie),se=[ie,...W].slice(0,10);try{localStorage.setItem("memglyph-search-history",JSON.stringify(se))}catch(X){console.warn("[Search] Failed to save history:",X)}return se})},H=()=>{S([]);try{localStorage.removeItem("memglyph-search-history")}catch(R){console.warn("[Search] Failed to clear history:",R)}},P=async R=>{if(!R.trim())return;u(!0),_(null),m(R),A(R);const ie=performance.now();try{const J=oe();qa({query:R,type:s,limit:n});let W=[];switch(s){case"fts":W=await ja(J,R,n,b);break;case"hybrid":W=await J.searchHybrid(R,n);break;case"graph":W=await Ka(J,R,n,r,b);break;default:throw new Error(`Unknown search mode: ${s}`)}const se=performance.now()-ie;return $a({query:R,type:s,results:W.map(X=>({gid:X.gid,score:X.scores.final,snippet:X.snippet||void 0})),executionTime:se}),q.isDynamic()&&await Qa(R,s,W),p(W),console.log(`[Search] ${s} mode: ${W.length} results in ${se.toFixed(0)}ms`),W}catch(J){const W=String(J);return _(W),console.error("[Search] Failed:",J),[]}finally{u(!1)}};return{mode:s,results:h,lastQuery:d,loading:o,error:f,entityFilter:b,searchHistory:T,search:R=>{g(R)},searchImmediate:R=>(L.current&&clearTimeout(L.current),g(""),P(R)),clear:()=>{p(null),m(""),_(null),g(""),L.current&&clearTimeout(L.current)},changeMode:R=>{l(R),p(null)},setFilter:R=>{v(R),p(null)},clearFilter:()=>{v({}),p(null)},clearHistory:H}}async function Qa(t,e,n){try{const r=q.getEnvelope();if(!r.isOpen()){console.warn("[Search] Envelope not open, skipping log");return}const i=r.getWriter();if(!i){console.warn("[Search] No envelope writer available");return}await i.appendRetrieval({id:aa("ret"),query_text:t,query_type:e,top_docs:n.slice(0,10).map(s=>({gid:s.gid,score:s.scores.final,snippet:s.snippet||void 0})),hit_count:n.length}),console.log(`[Search] Logged retrieval to envelope: ${n.length} results`)}catch(r){console.error("[Search] Failed to log to envelope:",r)}}async function ja(t,e,n,r){return(await t.searchFts(e,n,r.entityType,r.entityValue)).map(s=>({gid:s.gid,pageNo:s.pageNo,title:s.title,snippet:s.snippet,scores:{fts:s.score,vector:0,entity:0,graph:0,final:s.score}}))}async function Ka(t,e,n,r,i){const s=await t.searchFts(e,3,i.entityType,i.entityValue);if(s.length===0)return[];const l=s[0].gid,h=await t.graphHops(l,void 0,r,n),p=h.nodes.map(d=>{const m=h.distances[d.gid]||0,o=s.find(u=>u.gid===d.gid);return{gid:d.gid,pageNo:d.pageNo,title:d.title,snippet:(o==null?void 0:o.snippet)||null,scores:{fts:(o==null?void 0:o.score)||0,vector:0,entity:0,graph:1/(m+1),final:((o==null?void 0:o.score)||0)*.3+1/(m+1)*.7}}});return p.sort((d,m)=>m.scores.final-d.scores.final),p}/*! @license DOMPurify 3.3.0 | (c) Cure53 and other contributors | Released under the Apache license 2.0 and Mozilla Public License 2.0 | github.com/cure53/DOMPurify/blob/3.3.0/LICENSE */const{entries:ia,setPrototypeOf:In,isFrozen:Za,getPrototypeOf:Ja,getOwnPropertyDescriptor:er}=Object;let{freeze:te,seal:de,create:Wt}=Object,{apply:zt,construct:Bt}=typeof Reflect<"u"&&Reflect;te||(te=function(e){return e});de||(de=function(e){return e});zt||(zt=function(e,n){for(var r=arguments.length,i=new Array(r>2?r-2:0),s=2;s<r;s++)i[s-2]=arguments[s];return e.apply(n,i)});Bt||(Bt=function(e){for(var n=arguments.length,r=new Array(n>1?n-1:0),i=1;i<n;i++)r[i-1]=arguments[i];return new e(...r)});const rt=ne(Array.prototype.forEach),tr=ne(Array.prototype.lastIndexOf),Dn=ne(Array.prototype.pop),Pe=ne(Array.prototype.push),nr=ne(Array.prototype.splice),ot=ne(String.prototype.toLowerCase),At=ne(String.prototype.toString),Rt=ne(String.prototype.match),Ue=ne(String.prototype.replace),ar=ne(String.prototype.indexOf),rr=ne(String.prototype.trim),ue=ne(Object.prototype.hasOwnProperty),ee=ne(RegExp.prototype.test),He=ir(TypeError);function ne(t){return function(e){e instanceof RegExp&&(e.lastIndex=0);for(var n=arguments.length,r=new Array(n>1?n-1:0),i=1;i<n;i++)r[i-1]=arguments[i];return zt(t,e,r)}}function ir(t){return function(){for(var e=arguments.length,n=new Array(e),r=0;r<e;r++)n[r]=arguments[r];return Bt(t,n)}}function k(t,e){let n=arguments.length>2&&arguments[2]!==void 0?arguments[2]:ot;In&&In(t,null);let r=e.length;for(;r--;){let i=e[r];if(typeof i=="string"){const s=n(i);s!==i&&(Za(e)||(e[r]=s),i=s)}t[i]=!0}return t}function sr(t){for(let e=0;e<t.length;e++)ue(t,e)||(t[e]=null);return t}function _e(t){const e=Wt(null);for(const[n,r]of ia(t))ue(t,n)&&(Array.isArray(r)?e[n]=sr(r):r&&typeof r=="object"&&r.constructor===Object?e[n]=_e(r):e[n]=r);return e}function qe(t,e){for(;t!==null;){const r=er(t,e);if(r){if(r.get)return ne(r.get);if(typeof r.value=="function")return ne(r.value)}t=Ja(t)}function n(){return null}return n}const Fn=te(["a","abbr","acronym","address","area","article","aside","audio","b","bdi","bdo","big","blink","blockquote","body","br","button","canvas","caption","center","cite","code","col","colgroup","content","data","datalist","dd","decorator","del","details","dfn","dialog","dir","div","dl","dt","element","em","fieldset","figcaption","figure","font","footer","form","h1","h2","h3","h4","h5","h6","head","header","hgroup","hr","html","i","img","input","ins","kbd","label","legend","li","main","map","mark","marquee","menu","menuitem","meter","nav","nobr","ol","optgroup","option","output","p","picture","pre","progress","q","rp","rt","ruby","s","samp","search","section","select","shadow","slot","small","source","spacer","span","strike","strong","style","sub","summary","sup","table","tbody","td","template","textarea","tfoot","th","thead","time","tr","track","tt","u","ul","var","video","wbr"]),kt=te(["svg","a","altglyph","altglyphdef","altglyphitem","animatecolor","animatemotion","animatetransform","circle","clippath","defs","desc","ellipse","enterkeyhint","exportparts","filter","font","g","glyph","glyphref","hkern","image","inputmode","line","lineargradient","marker","mask","metadata","mpath","part","path","pattern","polygon","polyline","radialgradient","rect","stop","style","switch","symbol","text","textpath","title","tref","tspan","view","vkern"]),Ot=te(["feBlend","feColorMatrix","feComponentTransfer","feComposite","feConvolveMatrix","feDiffuseLighting","feDisplacementMap","feDistantLight","feDropShadow","feFlood","feFuncA","feFuncB","feFuncG","feFuncR","feGaussianBlur","feImage","feMerge","feMergeNode","feMorphology","feOffset","fePointLight","feSpecularLighting","feSpotLight","feTile","feTurbulence"]),lr=te(["animate","color-profile","cursor","discard","font-face","font-face-format","font-face-name","font-face-src","font-face-uri","foreignobject","hatch","hatchpath","mesh","meshgradient","meshpatch","meshrow","missing-glyph","script","set","solidcolor","unknown","use"]),xt=te(["math","menclose","merror","mfenced","mfrac","mglyph","mi","mlabeledtr","mmultiscripts","mn","mo","mover","mpadded","mphantom","mroot","mrow","ms","mspace","msqrt","mstyle","msub","msup","msubsup","mtable","mtd","mtext","mtr","munder","munderover","mprescripts"]),or=te(["maction","maligngroup","malignmark","mlongdiv","mscarries","mscarry","msgroup","mstack","msline","msrow","semantics","annotation","annotation-xml","mprescripts","none"]),Pn=te(["#text"]),Un=te(["accept","action","align","alt","autocapitalize","autocomplete","autopictureinpicture","autoplay","background","bgcolor","border","capture","cellpadding","cellspacing","checked","cite","class","clear","color","cols","colspan","controls","controlslist","coords","crossorigin","datetime","decoding","default","dir","disabled","disablepictureinpicture","disableremoteplayback","download","draggable","enctype","enterkeyhint","exportparts","face","for","headers","height","hidden","high","href","hreflang","id","inert","inputmode","integrity","ismap","kind","label","lang","list","loading","loop","low","max","maxlength","media","method","min","minlength","multiple","muted","name","nonce","noshade","novalidate","nowrap","open","optimum","part","pattern","placeholder","playsinline","popover","popovertarget","popovertargetaction","poster","preload","pubdate","radiogroup","readonly","rel","required","rev","reversed","role","rows","rowspan","spellcheck","scope","selected","shape","size","sizes","slot","span","srclang","start","src","srcset","step","style","summary","tabindex","title","translate","type","usemap","valign","value","width","wrap","xmlns","slot"]),Mt=te(["accent-height","accumulate","additive","alignment-baseline","amplitude","ascent","attributename","attributetype","azimuth","basefrequency","baseline-shift","begin","bias","by","class","clip","clippathunits","clip-path","clip-rule","color","color-interpolation","color-interpolation-filters","color-profile","color-rendering","cx","cy","d","dx","dy","diffuseconstant","direction","display","divisor","dur","edgemode","elevation","end","exponent","fill","fill-opacity","fill-rule","filter","filterunits","flood-color","flood-opacity","font-family","font-size","font-size-adjust","font-stretch","font-style","font-variant","font-weight","fx","fy","g1","g2","glyph-name","glyphref","gradientunits","gradienttransform","height","href","id","image-rendering","in","in2","intercept","k","k1","k2","k3","k4","kerning","keypoints","keysplines","keytimes","lang","lengthadjust","letter-spacing","kernelmatrix","kernelunitlength","lighting-color","local","marker-end","marker-mid","marker-start","markerheight","markerunits","markerwidth","maskcontentunits","maskunits","max","mask","mask-type","media","method","mode","min","name","numoctaves","offset","operator","opacity","order","orient","orientation","origin","overflow","paint-order","path","pathlength","patterncontentunits","patterntransform","patternunits","points","preservealpha","preserveaspectratio","primitiveunits","r","rx","ry","radius","refx","refy","repeatcount","repeatdur","restart","result","rotate","scale","seed","shape-rendering","slope","specularconstant","specularexponent","spreadmethod","startoffset","stddeviation","stitchtiles","stop-color","stop-opacity","stroke-dasharray","stroke-dashoffset","stroke-linecap","stroke-linejoin","stroke-miterlimit","stroke-opacity","stroke","stroke-width","style","surfacescale","systemlanguage","tabindex","tablevalues","targetx","targety","transform","transform-origin","text-anchor","text-decoration","text-rendering","textlength","type","u1","u2","unicode","values","viewbox","visibility","version","vert-adv-y","vert-origin-x","vert-origin-y","width","word-spacing","wrap","writing-mode","xchannelselector","ychannelselector","x","x1","x2","xmlns","y","y1","y2","z","zoomandpan"]),Hn=te(["accent","accentunder","align","bevelled","close","columnsalign","columnlines","columnspan","denomalign","depth","dir","display","displaystyle","encoding","fence","frame","height","href","id","largeop","length","linethickness","lspace","lquote","mathbackground","mathcolor","mathsize","mathvariant","maxsize","minsize","movablelimits","notation","numalign","open","rowalign","rowlines","rowspacing","rowspan","rspace","rquote","scriptlevel","scriptminsize","scriptsizemultiplier","selection","separator","separators","stretchy","subscriptshift","supscriptshift","symmetric","voffset","width","xmlns"]),it=te(["xlink:href","xml:id","xlink:title","xml:space","xmlns:xlink"]),cr=de(/\{\{[\w\W]*|[\w\W]*\}\}/gm),dr=de(/<%[\w\W]*|[\w\W]*%>/gm),ur=de(/\$\{[\w\W]*/gm),hr=de(/^data-[\-\w.\u00B7-\uFFFF]+$/),pr=de(/^aria-[\-\w]+$/),sa=de(/^(?:(?:(?:f|ht)tps?|mailto|tel|callto|sms|cid|xmpp|matrix):|[^a-z]|[a-z+.\-]+(?:[^a-z+.\-:]|$))/i),mr=de(/^(?:\w+script|data):/i),fr=de(/[\u0000-\u0020\u00A0\u1680\u180E\u2000-\u2029\u205F\u3000]/g),la=de(/^html$/i),gr=de(/^[a-z][.\w]*(-[.\w]+)+$/i);var qn=Object.freeze({__proto__:null,ARIA_ATTR:pr,ATTR_WHITESPACE:fr,CUSTOM_ELEMENT:gr,DATA_ATTR:hr,DOCTYPE_NAME:la,ERB_EXPR:dr,IS_ALLOWED_URI:sa,IS_SCRIPT_OR_DATA:mr,MUSTACHE_EXPR:cr,TMPLIT_EXPR:ur});const $e={element:1,text:3,progressingInstruction:7,comment:8,document:9},_r=function(){return typeof window>"u"?null:window},yr=function(e,n){if(typeof e!="object"||typeof e.createPolicy!="function")return null;let r=null;const i="data-tt-policy-suffix";n&&n.hasAttribute(i)&&(r=n.getAttribute(i));const s="dompurify"+(r?"#"+r:"");try{return e.createPolicy(s,{createHTML(l){return l},createScriptURL(l){return l}})}catch{return console.warn("TrustedTypes policy "+s+" could not be created."),null}},$n=function(){return{afterSanitizeAttributes:[],afterSanitizeElements:[],afterSanitizeShadowDOM:[],beforeSanitizeAttributes:[],beforeSanitizeElements:[],beforeSanitizeShadowDOM:[],uponSanitizeAttribute:[],uponSanitizeElement:[],uponSanitizeShadowNode:[]}};function oa(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:_r();const e=w=>oa(w);if(e.version="3.3.0",e.removed=[],!t||!t.document||t.document.nodeType!==$e.document||!t.Element)return e.isSupported=!1,e;let{document:n}=t;const r=n,i=r.currentScript,{DocumentFragment:s,HTMLTemplateElement:l,Node:h,Element:p,NodeFilter:d,NamedNodeMap:m=t.NamedNodeMap||t.MozNamedAttrMap,HTMLFormElement:o,DOMParser:u,trustedTypes:f}=t,_=p.prototype,b=qe(_,"cloneNode"),v=qe(_,"remove"),y=qe(_,"nextSibling"),g=qe(_,"childNodes"),T=qe(_,"parentNode");if(typeof l=="function"){const w=n.createElement("template");w.content&&w.content.ownerDocument&&(n=w.content.ownerDocument)}let S,L="";const{implementation:A,createNodeIterator:H,createDocumentFragment:P,getElementsByTagName:O}=n,{importNode:he}=r;let M=$n();e.isSupported=typeof ia=="function"&&typeof T=="function"&&A&&A.createHTMLDocument!==void 0;const{MUSTACHE_EXPR:ae,ERB_EXPR:Ne,TMPLIT_EXPR:U,DATA_ATTR:R,ARIA_ATTR:ie,IS_SCRIPT_OR_DATA:J,ATTR_WHITESPACE:W,CUSTOM_ELEMENT:se}=qn;let{IS_ALLOWED_URI:X}=qn,D=null;const V=k({},[...Fn,...kt,...Ot,...xt,...Pn]);let Q=null;const Zt=k({},[...Un,...Mt,...Hn,...it]);let $=Object.seal(Wt(null,{tagNameCheck:{writable:!0,configurable:!1,enumerable:!0,value:null},attributeNameCheck:{writable:!0,configurable:!1,enumerable:!0,value:null},allowCustomizedBuiltInElements:{writable:!0,configurable:!1,enumerable:!0,value:!1}})),Ie=null,mt=null;const Se=Object.seal(Wt(null,{tagCheck:{writable:!0,configurable:!1,enumerable:!0,value:null},attributeCheck:{writable:!0,configurable:!1,enumerable:!0,value:null}}));let Jt=!0,ft=!0,en=!1,tn=!0,Ce=!1,Ve=!0,ve=!1,gt=!1,_t=!1,we=!1,Ye=!1,Qe=!1,nn=!0,an=!1;const ma="user-content-";let yt=!0,De=!1,Le={},Ae=null;const rn=k({},["annotation-xml","audio","colgroup","desc","foreignobject","head","iframe","math","mi","mn","mo","ms","mtext","noembed","noframes","noscript","plaintext","script","style","svg","template","thead","title","video","xmp"]);let sn=null;const ln=k({},["audio","video","img","source","image","track"]);let vt=null;const on=k({},["alt","class","for","id","label","name","pattern","placeholder","role","summary","title","value","style","xmlns"]),je="http://www.w3.org/1998/Math/MathML",Ke="http://www.w3.org/2000/svg",me="http://www.w3.org/1999/xhtml";let Re=me,Et=!1,bt=null;const fa=k({},[je,Ke,me],At);let Ze=k({},["mi","mo","mn","ms","mtext"]),Je=k({},["annotation-xml"]);const ga=k({},["title","style","font","a","script"]);let Fe=null;const _a=["application/xhtml+xml","text/html"],ya="text/html";let Y=null,ke=null;const va=n.createElement("form"),cn=function(c){return c instanceof RegExp||c instanceof Function},Tt=function(){let c=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};if(!(ke&&ke===c)){if((!c||typeof c!="object")&&(c={}),c=_e(c),Fe=_a.indexOf(c.PARSER_MEDIA_TYPE)===-1?ya:c.PARSER_MEDIA_TYPE,Y=Fe==="application/xhtml+xml"?At:ot,D=ue(c,"ALLOWED_TAGS")?k({},c.ALLOWED_TAGS,Y):V,Q=ue(c,"ALLOWED_ATTR")?k({},c.ALLOWED_ATTR,Y):Zt,bt=ue(c,"ALLOWED_NAMESPACES")?k({},c.ALLOWED_NAMESPACES,At):fa,vt=ue(c,"ADD_URI_SAFE_ATTR")?k(_e(on),c.ADD_URI_SAFE_ATTR,Y):on,sn=ue(c,"ADD_DATA_URI_TAGS")?k(_e(ln),c.ADD_DATA_URI_TAGS,Y):ln,Ae=ue(c,"FORBID_CONTENTS")?k({},c.FORBID_CONTENTS,Y):rn,Ie=ue(c,"FORBID_TAGS")?k({},c.FORBID_TAGS,Y):_e({}),mt=ue(c,"FORBID_ATTR")?k({},c.FORBID_ATTR,Y):_e({}),Le=ue(c,"USE_PROFILES")?c.USE_PROFILES:!1,Jt=c.ALLOW_ARIA_ATTR!==!1,ft=c.ALLOW_DATA_ATTR!==!1,en=c.ALLOW_UNKNOWN_PROTOCOLS||!1,tn=c.ALLOW_SELF_CLOSE_IN_ATTR!==!1,Ce=c.SAFE_FOR_TEMPLATES||!1,Ve=c.SAFE_FOR_XML!==!1,ve=c.WHOLE_DOCUMENT||!1,we=c.RETURN_DOM||!1,Ye=c.RETURN_DOM_FRAGMENT||!1,Qe=c.RETURN_TRUSTED_TYPE||!1,_t=c.FORCE_BODY||!1,nn=c.SANITIZE_DOM!==!1,an=c.SANITIZE_NAMED_PROPS||!1,yt=c.KEEP_CONTENT!==!1,De=c.IN_PLACE||!1,X=c.ALLOWED_URI_REGEXP||sa,Re=c.NAMESPACE||me,Ze=c.MATHML_TEXT_INTEGRATION_POINTS||Ze,Je=c.HTML_INTEGRATION_POINTS||Je,$=c.CUSTOM_ELEMENT_HANDLING||{},c.CUSTOM_ELEMENT_HANDLING&&cn(c.CUSTOM_ELEMENT_HANDLING.tagNameCheck)&&($.tagNameCheck=c.CUSTOM_ELEMENT_HANDLING.tagNameCheck),c.CUSTOM_ELEMENT_HANDLING&&cn(c.CUSTOM_ELEMENT_HANDLING.attributeNameCheck)&&($.attributeNameCheck=c.CUSTOM_ELEMENT_HANDLING.attributeNameCheck),c.CUSTOM_ELEMENT_HANDLING&&typeof c.CUSTOM_ELEMENT_HANDLING.allowCustomizedBuiltInElements=="boolean"&&($.allowCustomizedBuiltInElements=c.CUSTOM_ELEMENT_HANDLING.allowCustomizedBuiltInElements),Ce&&(ft=!1),Ye&&(we=!0),Le&&(D=k({},Pn),Q=[],Le.html===!0&&(k(D,Fn),k(Q,Un)),Le.svg===!0&&(k(D,kt),k(Q,Mt),k(Q,it)),Le.svgFilters===!0&&(k(D,Ot),k(Q,Mt),k(Q,it)),Le.mathMl===!0&&(k(D,xt),k(Q,Hn),k(Q,it))),c.ADD_TAGS&&(typeof c.ADD_TAGS=="function"?Se.tagCheck=c.ADD_TAGS:(D===V&&(D=_e(D)),k(D,c.ADD_TAGS,Y))),c.ADD_ATTR&&(typeof c.ADD_ATTR=="function"?Se.attributeCheck=c.ADD_ATTR:(Q===Zt&&(Q=_e(Q)),k(Q,c.ADD_ATTR,Y))),c.ADD_URI_SAFE_ATTR&&k(vt,c.ADD_URI_SAFE_ATTR,Y),c.FORBID_CONTENTS&&(Ae===rn&&(Ae=_e(Ae)),k(Ae,c.FORBID_CONTENTS,Y)),yt&&(D["#text"]=!0),ve&&k(D,["html","head","body"]),D.table&&(k(D,["tbody"]),delete Ie.tbody),c.TRUSTED_TYPES_POLICY){if(typeof c.TRUSTED_TYPES_POLICY.createHTML!="function")throw He('TRUSTED_TYPES_POLICY configuration option must provide a "createHTML" hook.');if(typeof c.TRUSTED_TYPES_POLICY.createScriptURL!="function")throw He('TRUSTED_TYPES_POLICY configuration option must provide a "createScriptURL" hook.');S=c.TRUSTED_TYPES_POLICY,L=S.createHTML("")}else S===void 0&&(S=yr(f,i)),S!==null&&typeof L=="string"&&(L=S.createHTML(""));te&&te(c),ke=c}},dn=k({},[...kt,...Ot,...lr]),un=k({},[...xt,...or]),Ea=function(c){let E=T(c);(!E||!E.tagName)&&(E={namespaceURI:Re,tagName:"template"});const C=ot(c.tagName),F=ot(E.tagName);return bt[c.namespaceURI]?c.namespaceURI===Ke?E.namespaceURI===me?C==="svg":E.namespaceURI===je?C==="svg"&&(F==="annotation-xml"||Ze[F]):!!dn[C]:c.namespaceURI===je?E.namespaceURI===me?C==="math":E.namespaceURI===Ke?C==="math"&&Je[F]:!!un[C]:c.namespaceURI===me?E.namespaceURI===Ke&&!Je[F]||E.namespaceURI===je&&!Ze[F]?!1:!un[C]&&(ga[C]||!dn[C]):!!(Fe==="application/xhtml+xml"&&bt[c.namespaceURI]):!1},pe=function(c){Pe(e.removed,{element:c});try{T(c).removeChild(c)}catch{v(c)}},Ee=function(c,E){try{Pe(e.removed,{attribute:E.getAttributeNode(c),from:E})}catch{Pe(e.removed,{attribute:null,from:E})}if(E.removeAttribute(c),c==="is")if(we||Ye)try{pe(E)}catch{}else try{E.setAttribute(c,"")}catch{}},hn=function(c){let E=null,C=null;if(_t)c="<remove></remove>"+c;else{const z=Rt(c,/^[\r\n\t ]+/);C=z&&z[0]}Fe==="application/xhtml+xml"&&Re===me&&(c='<html xmlns="http://www.w3.org/1999/xhtml"><head></head><body>'+c+"</body></html>");const F=S?S.createHTML(c):c;if(Re===me)try{E=new u().parseFromString(F,Fe)}catch{}if(!E||!E.documentElement){E=A.createDocument(Re,"template",null);try{E.documentElement.innerHTML=Et?L:F}catch{}}const Z=E.body||E.documentElement;return c&&C&&Z.insertBefore(n.createTextNode(C),Z.childNodes[0]||null),Re===me?O.call(E,ve?"html":"body")[0]:ve?E.documentElement:Z},pn=function(c){return H.call(c.ownerDocument||c,c,d.SHOW_ELEMENT|d.SHOW_COMMENT|d.SHOW_TEXT|d.SHOW_PROCESSING_INSTRUCTION|d.SHOW_CDATA_SECTION,null)},Nt=function(c){return c instanceof o&&(typeof c.nodeName!="string"||typeof c.textContent!="string"||typeof c.removeChild!="function"||!(c.attributes instanceof m)||typeof c.removeAttribute!="function"||typeof c.setAttribute!="function"||typeof c.namespaceURI!="string"||typeof c.insertBefore!="function"||typeof c.hasChildNodes!="function")},mn=function(c){return typeof h=="function"&&c instanceof h};function fe(w,c,E){rt(w,C=>{C.call(e,c,E,ke)})}const fn=function(c){let E=null;if(fe(M.beforeSanitizeElements,c,null),Nt(c))return pe(c),!0;const C=Y(c.nodeName);if(fe(M.uponSanitizeElement,c,{tagName:C,allowedTags:D}),Ve&&c.hasChildNodes()&&!mn(c.firstElementChild)&&ee(/<[/\w!]/g,c.innerHTML)&&ee(/<[/\w!]/g,c.textContent)||c.nodeType===$e.progressingInstruction||Ve&&c.nodeType===$e.comment&&ee(/<[/\w]/g,c.data))return pe(c),!0;if(!(Se.tagCheck instanceof Function&&Se.tagCheck(C))&&(!D[C]||Ie[C])){if(!Ie[C]&&_n(C)&&($.tagNameCheck instanceof RegExp&&ee($.tagNameCheck,C)||$.tagNameCheck instanceof Function&&$.tagNameCheck(C)))return!1;if(yt&&!Ae[C]){const F=T(c)||c.parentNode,Z=g(c)||c.childNodes;if(Z&&F){const z=Z.length;for(let re=z-1;re>=0;--re){const ge=b(Z[re],!0);ge.__removalCount=(c.__removalCount||0)+1,F.insertBefore(ge,y(c))}}}return pe(c),!0}return c instanceof p&&!Ea(c)||(C==="noscript"||C==="noembed"||C==="noframes")&&ee(/<\/no(script|embed|frames)/i,c.innerHTML)?(pe(c),!0):(Ce&&c.nodeType===$e.text&&(E=c.textContent,rt([ae,Ne,U],F=>{E=Ue(E,F," ")}),c.textContent!==E&&(Pe(e.removed,{element:c.cloneNode()}),c.textContent=E)),fe(M.afterSanitizeElements,c,null),!1)},gn=function(c,E,C){if(nn&&(E==="id"||E==="name")&&(C in n||C in va))return!1;if(!(ft&&!mt[E]&&ee(R,E))){if(!(Jt&&ee(ie,E))){if(!(Se.attributeCheck instanceof Function&&Se.attributeCheck(E,c))){if(!Q[E]||mt[E]){if(!(_n(c)&&($.tagNameCheck instanceof RegExp&&ee($.tagNameCheck,c)||$.tagNameCheck instanceof Function&&$.tagNameCheck(c))&&($.attributeNameCheck instanceof RegExp&&ee($.attributeNameCheck,E)||$.attributeNameCheck instanceof Function&&$.attributeNameCheck(E,c))||E==="is"&&$.allowCustomizedBuiltInElements&&($.tagNameCheck instanceof RegExp&&ee($.tagNameCheck,C)||$.tagNameCheck instanceof Function&&$.tagNameCheck(C))))return!1}else if(!vt[E]){if(!ee(X,Ue(C,W,""))){if(!((E==="src"||E==="xlink:href"||E==="href")&&c!=="script"&&ar(C,"data:")===0&&sn[c])){if(!(en&&!ee(J,Ue(C,W,"")))){if(C)return!1}}}}}}}return!0},_n=function(c){return c!=="annotation-xml"&&Rt(c,se)},yn=function(c){fe(M.beforeSanitizeAttributes,c,null);const{attributes:E}=c;if(!E||Nt(c))return;const C={attrName:"",attrValue:"",keepAttr:!0,allowedAttributes:Q,forceKeepAttr:void 0};let F=E.length;for(;F--;){const Z=E[F],{name:z,namespaceURI:re,value:ge}=Z,Oe=Y(z),St=ge;let j=z==="value"?St:rr(St);if(C.attrName=Oe,C.attrValue=j,C.keepAttr=!0,C.forceKeepAttr=void 0,fe(M.uponSanitizeAttribute,c,C),j=C.attrValue,an&&(Oe==="id"||Oe==="name")&&(Ee(z,c),j=ma+j),Ve&&ee(/((--!?|])>)|<\/(style|title|textarea)/i,j)){Ee(z,c);continue}if(Oe==="attributename"&&Rt(j,"href")){Ee(z,c);continue}if(C.forceKeepAttr)continue;if(!C.keepAttr){Ee(z,c);continue}if(!tn&&ee(/\/>/i,j)){Ee(z,c);continue}Ce&&rt([ae,Ne,U],En=>{j=Ue(j,En," ")});const vn=Y(c.nodeName);if(!gn(vn,Oe,j)){Ee(z,c);continue}if(S&&typeof f=="object"&&typeof f.getAttributeType=="function"&&!re)switch(f.getAttributeType(vn,Oe)){case"TrustedHTML":{j=S.createHTML(j);break}case"TrustedScriptURL":{j=S.createScriptURL(j);break}}if(j!==St)try{re?c.setAttributeNS(re,z,j):c.setAttribute(z,j),Nt(c)?pe(c):Dn(e.removed)}catch{Ee(z,c)}}fe(M.afterSanitizeAttributes,c,null)},ba=function w(c){let E=null;const C=pn(c);for(fe(M.beforeSanitizeShadowDOM,c,null);E=C.nextNode();)fe(M.uponSanitizeShadowNode,E,null),fn(E),yn(E),E.content instanceof s&&w(E.content);fe(M.afterSanitizeShadowDOM,c,null)};return e.sanitize=function(w){let c=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{},E=null,C=null,F=null,Z=null;if(Et=!w,Et&&(w="<!-->"),typeof w!="string"&&!mn(w))if(typeof w.toString=="function"){if(w=w.toString(),typeof w!="string")throw He("dirty is not a string, aborting")}else throw He("toString is not a function");if(!e.isSupported)return w;if(gt||Tt(c),e.removed=[],typeof w=="string"&&(De=!1),De){if(w.nodeName){const ge=Y(w.nodeName);if(!D[ge]||Ie[ge])throw He("root node is forbidden and cannot be sanitized in-place")}}else if(w instanceof h)E=hn("<!---->"),C=E.ownerDocument.importNode(w,!0),C.nodeType===$e.element&&C.nodeName==="BODY"||C.nodeName==="HTML"?E=C:E.appendChild(C);else{if(!we&&!Ce&&!ve&&w.indexOf("<")===-1)return S&&Qe?S.createHTML(w):w;if(E=hn(w),!E)return we?null:Qe?L:""}E&&_t&&pe(E.firstChild);const z=pn(De?w:E);for(;F=z.nextNode();)fn(F),yn(F),F.content instanceof s&&ba(F.content);if(De)return w;if(we){if(Ye)for(Z=P.call(E.ownerDocument);E.firstChild;)Z.appendChild(E.firstChild);else Z=E;return(Q.shadowroot||Q.shadowrootmode)&&(Z=he.call(r,Z,!0)),Z}let re=ve?E.outerHTML:E.innerHTML;return ve&&D["!doctype"]&&E.ownerDocument&&E.ownerDocument.doctype&&E.ownerDocument.doctype.name&&ee(la,E.ownerDocument.doctype.name)&&(re="<!DOCTYPE "+E.ownerDocument.doctype.name+`>
`+re),Ce&&rt([ae,Ne,U],ge=>{re=Ue(re,ge," ")}),S&&Qe?S.createHTML(re):re},e.setConfig=function(){let w=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};Tt(w),gt=!0},e.clearConfig=function(){ke=null,gt=!1},e.isValidAttribute=function(w,c,E){ke||Tt({});const C=Y(w),F=Y(c);return gn(C,F,E)},e.addHook=function(w,c){typeof c=="function"&&Pe(M[w],c)},e.removeHook=function(w,c){if(c!==void 0){const E=tr(M[w],c);return E===-1?void 0:nr(M[w],E,1)[0]}return Dn(M[w])},e.removeHooks=function(w){M[w]=[]},e.removeAllHooks=function(){M=$n()},e}var Kt=oa();function vr({mode:t,onModeChange:e,showToggle:n=!0}){return n?a("div",{className:"search-mode-toggle",children:[a("button",{className:`mode-btn ${t==="fts"?"active":""}`,onClick:()=>e("fts"),children:" FTS Only"}),a("button",{className:`mode-btn ${t==="hybrid"?"active":""}`,onClick:()=>e("hybrid"),children:" Hybrid"}),a("button",{className:`mode-btn ${t==="graph"?"active":""}`,onClick:()=>e("graph"),children:" Graph"})]}):null}function Er({onSearch:t,loading:e,placeholder:n,searchHistory:r,onClearHistory:i}){return a(le,{children:[a("form",{onSubmit:s=>{s.preventDefault();const h=new FormData(s.currentTarget).get("query");h!=null&&h.trim()&&t(h.trim())},children:a("div",{className:"search-bar",children:[a("input",{type:"text",name:"query",placeholder:n||"Search the capsule...",className:"search-input",disabled:e}),a("button",{type:"submit",className:"btn-search",disabled:e,children:e?"Searching...":"Search"})]})}),r&&r.length>0&&a("div",{className:"search-history",children:[a("div",{className:"search-history-header",children:[a("span",{className:"search-history-label",children:"Recent searches:"}),i&&a("button",{className:"search-history-clear",onClick:i,type:"button",children:"Clear"})]}),a("div",{className:"search-history-items",children:r.map((s,l)=>a("button",{className:"search-history-item",onClick:()=>t(s),type:"button",children:s},l))})]})]})}function br({resultGid:t,retrievalId:e}){const[n,r]=N(null),[i,s]=N(!1),l=async h=>{s(!0);try{if(Ba({retrievalId:e,rating:h,notes:void 0}),q.isDynamic()){const d=q.getEnvelope().getWriter();d&&await d.appendFeedback({id:aa("fb"),retrieval_id:e,rating:h,notes:void 0})}r(h)}catch(p){console.error("[Feedback] Failed to submit feedback:",p)}finally{s(!1)}};return q.isDynamic()?a("div",{className:"result-feedback",children:[a("button",{className:`feedback-btn ${n===1?"feedback-btn-active-positive":""}`,onClick:h=>{h.stopPropagation(),l(1)},disabled:i||n!==null,title:"Helpful result",children:""}),a("button",{className:`feedback-btn ${n===-1?"feedback-btn-active-negative":""}`,onClick:h=>{h.stopPropagation(),l(-1)},disabled:i||n!==null,title:"Not helpful",children:""})]}):null}function Tr({results:t,query:e,onResultClick:n,retrievalId:r}){return a("div",{className:"search-results",children:[a("p",{className:"results-header",children:["Found ",t.length," results for ",a("strong",{children:['"',e,'"']})]}),t.map(i=>a("div",{className:`result-item ${n?"result-item-clickable":""}`,onClick:()=>n==null?void 0:n(i.gid),style:{cursor:n?"pointer":"default"},children:[a("div",{className:"result-header",children:[a("span",{className:"result-page",children:["Page ",i.pageNo]}),a("span",{className:"result-score",children:["Score: ",i.scores.final.toFixed(3)]}),a(br,{resultGid:i.gid,retrievalId:r})]}),a("h4",{className:"result-title",children:i.title}),i.snippet&&a("p",{className:"result-snippet",dangerouslySetInnerHTML:{__html:Kt.sanitize(i.snippet,{ALLOWED_TAGS:["mark","strong","em","b","i"],ALLOWED_ATTR:[]})}}),a("div",{className:"result-scores",children:[a("span",{children:["FTS: ",i.scores.fts.toFixed(2)]}),a("span",{children:["Entity: ",i.scores.entity.toFixed(2)]}),a("span",{children:["Graph: ",i.scores.graph.toFixed(2)]})]})]},i.gid))]})}function Nr({mode:t,results:e,lastQuery:n,loading:r,onSearch:i,onModeChange:s,onResultClick:l,showModeToggle:h=!0,placeholder:p,searchHint:d,searchHistory:m,onClearHistory:o}){return a("div",{className:"search-section",children:[a("div",{className:"search-header",children:a("h3",{children:" Search"})}),a(vr,{mode:t,onModeChange:s,showToggle:h}),d&&a("p",{className:"search-hint",children:d}),a("div",{className:"keyboard-shortcuts-hint",children:[a("span",{className:"shortcut-item",children:[a("kbd",{children:"/"})," Focus search"]}),a("span",{className:"shortcut-item",children:[a("kbd",{children:"Ctrl+L"})," Toggle LLM"]}),a("span",{className:"shortcut-item",children:[a("kbd",{children:"Esc"})," Clear focus"]})]}),a(Er,{onSearch:i,loading:r,placeholder:p,searchHistory:m,onClearHistory:o}),e&&e.length>0&&a(Tr,{results:e,query:n,onResultClick:l}),e&&e.length===0&&a("div",{className:"no-results",children:[a("p",{children:["No results found for ",a("strong",{children:['"',n,'"']})]}),a("p",{className:"search-hint",children:"Try different keywords or search terms."})]})]})}function ca(t={}){const{autoLoad:e=!0,maxEntities:n=50}=t,[r,i]=N([]),[s,l]=N(null),[h,p]=N(!1),[d,m]=N(null),o=async()=>{p(!0),m(null);try{const g=await oe().listEntities(void 0,n);i(g),console.log("[Entities] Loaded:",g.length)}catch(y){const g=String(y);m(g),console.error("[Entities] Failed to load:",y)}finally{p(!1)}};K(()=>{e&&o()},[e]);const u=y=>{l(y)},f=()=>Array.from(new Set(r.map(y=>y.entityType))),_=()=>s?r.filter(y=>y.entityType===s):r,b=y=>r.filter(g=>g.entityType===y).reduce((g,T)=>g+T.count,0),v=()=>r.reduce((y,g)=>y+g.count,0);return{entities:r,selectedType:s,loading:h,error:d,types:f(),filteredEntities:_(),totalCount:v(),loadEntities:o,selectType:u,getTypeCount:b}}function Sr({types:t,selectedType:e,totalCount:n,onSelectType:r,getTypeCount:i}){return a("div",{className:"entity-filters",children:[a("button",{className:`entity-filter ${e===null?"active":""}`,onClick:()=>r(null),children:["All (",n,")"]}),t.map(s=>{const l=i(s);return a("button",{className:`entity-filter ${e===s?"active":""}`,onClick:()=>r(s),children:[s," (",l,")"]},s)})]})}function Cr({entities:t,maxDisplay:e=20}){const n=t.slice(0,e);return a("div",{className:"entity-list",children:[n.map(r=>a("div",{className:"entity-item",children:[a("span",{className:"entity-type",children:r.entityType}),a("span",{className:"entity-value",children:r.normalizedValue}),a("span",{className:"entity-count",children:r.count})]},`${r.entityType}-${r.normalizedValue}`)),t.length>e&&a("div",{className:"entity-item entity-more",children:a("span",{className:"entity-value",children:["... and ",t.length-e," more"]})})]})}function wr({entities:t,types:e,selectedType:n,totalCount:r,onSelectType:i,getTypeCount:s,show:l=!0,maxDisplay:h=20}){if(!l||t.length===0)return null;const p=n?t.filter(d=>d.entityType===n):t;return a("div",{className:"entity-panel",children:[a("h4",{children:"Filter by Entity Type"}),a(Sr,{types:e,selectedType:n,totalCount:r,onSelectType:i,getTypeCount:s}),a(Cr,{entities:p,maxDisplay:h})]})}class Lr{constructor(){x(this,"worker",null);x(this,"nextId",1);x(this,"pending",new Map);x(this,"progressCallback",null);x(this,"streamTokenCallback",null);x(this,"streamCompleteCallback",null);x(this,"streamErrorCallback",null);this.initWorker()}initWorker(){this.worker=new Worker(new URL("/assets/llm.worker-BiRl8TFV.js",import.meta.url),{type:"module"}),this.worker.onmessage=e=>{const n=e.data;if("type"in n&&n.type==="READY"){console.log("[LlmClient] Worker ready");return}if("type"in n&&n.type==="PROGRESS"){this.progressCallback&&this.progressCallback(n.data);return}if("type"in n&&n.type==="STREAM_TOKEN"){this.streamTokenCallback&&this.streamTokenCallback(n.token,n.piece);return}if("type"in n&&n.type==="STREAM_COMPLETE"){this.streamCompleteCallback&&this.streamCompleteCallback();return}if("type"in n&&n.type==="STREAM_ERROR"){this.streamErrorCallback&&this.streamErrorCallback(n.error);return}const{id:r,response:i}=n,s=this.pending.get(r);s&&(this.pending.delete(r),s.resolve(i))},this.worker.onerror=e=>{console.error("[LlmClient] Worker error:",e);for(const n of this.pending.values())n.reject(new Error("Worker error"));this.pending.clear()}}async sendRequest(e){if(!this.worker)throw new Error("Worker not initialized");const n=this.nextId++;return new Promise((r,i)=>{this.pending.set(n,{resolve:l=>{l.ok?r(l.data):i(new Error(l.error))},reject:i});const s={id:n,request:e};this.worker.postMessage(s)})}onProgress(e){this.progressCallback=e}onStreamToken(e){this.streamTokenCallback=e}onStreamComplete(e){this.streamCompleteCallback=e}onStreamError(e){this.streamErrorCallback=e}async abortReasoning(){return this.sendRequest({type:"ABORT_REASONING"})}async loadModel(e){return this.sendRequest({type:"LOAD_MODEL",modelUrl:e})}async reason(e){return this.sendRequest({type:"REASON",request:e})}async unloadModel(){return this.sendRequest({type:"UNLOAD_MODEL"})}async getStatus(){return this.sendRequest({type:"GET_STATUS"})}terminate(){this.worker&&(this.worker.terminate(),this.worker=null),this.pending.clear(),this.progressCallback=null,this.streamTokenCallback=null,this.streamCompleteCallback=null,this.streamErrorCallback=null}}let It=null;function Dt(){return It||(It=new Lr),It}const Ar={"0.6b":"https://huggingface.co/unsloth/Qwen3-0.6B-GGUF/resolve/main/Qwen3-0.6B-Q4_K_M.gguf","1.5b":"https://huggingface.co/ggml-org/Qwen2.5-1.5B-Instruct-GGUF/resolve/main/qwen2.5-1.5b-instruct-q4_k_m.gguf"};function da(t={}){const[e,n]=N(!1),[r,i]=N(null),[s,l]=N(!1),[h,p]=N(null),[d,m]=N(null),[o,u]=N(null),[f,_]=N(0),[b,v]=N(.7),[y,g]=N(!1),[T,S]=N(""),L=We(0),A=We(null),H=We(0),P=5e3;K(()=>{if(s&&!h)return L.current=Date.now(),_(0),A.current=window.setInterval(()=>{const U=(Date.now()-L.current)/1e3;_(U)},100),()=>{A.current&&clearInterval(A.current)};A.current&&(clearInterval(A.current),A.current=null),_(0)},[s,h]);const O=async()=>{l(!0),u(null),p(null);try{const U=Dt();U.onProgress(ie=>{p(ie)}),U.onStreamToken((ie,J)=>{S(W=>W+J)}),U.onStreamComplete(()=>{g(!1)}),U.onStreamError(ie=>{u(ie),g(!1),S("")});const R=await U.loadModel(Ar["0.6b"]);i(R),p(null),console.log("[LLM] Model loaded:",R)}catch(U){const R=String(U);u(R),console.error("[LLM] Failed to load model:",U)}finally{l(!1)}};return{enabled:e,modelInfo:r,loading:s,progress:h,reasoning:d,error:o,elapsedTime:f,temperature:b,isStreaming:y,streamingText:T,toggle:async()=>{e?(n(!1),m(null)):(r!=null&&r.loaded||await O(),n(!0))},loadModel:O,reason:async(U,R,ie=256)=>{if(!(r!=null&&r.loaded)){console.warn("[LLM] Cannot reason: model not loaded");return}const J=Date.now(),W=J-H.current;if(W<P){const X=`Please wait ${Math.ceil((P-W)/1e3)}s before making another query (rate limit: 1 query per 5 seconds)`;u(X),console.warn("[LLM] Rate limit hit:",X);return}H.current=J,l(!0),u(null),g(!0),S("");try{const se=Dt(),X=R.slice(0,5).map(V=>({gid:V.gid,pageNo:V.pageNo,title:V.title,text:V.snippet||"",score:V.scores.final}));Ga({prompt:U,context:X.map(V=>V.text),model:r.modelId});const D=await se.reason({question:U,snippets:X,maxTokens:ie,temperature:b});Wa({response:D.answer,citations:D.usedSnippets.map(V=>({gid:V.gid,pageNo:V.pageNo})),model:r.modelId}),D.usedSnippets.forEach(V=>{za({gid:V.gid,pageNo:V.pageNo,title:V.title||void 0,snippet:V.text})}),m(D),g(!1),console.log("[LLM] Reasoning complete:",D)}catch(se){const X=String(se);u(X),g(!1),S(""),console.error("[LLM] Reasoning failed:",se)}finally{l(!1)}},clearReasoning:()=>{m(null)},abortReasoning:async()=>{try{await Dt().abortReasoning(),g(!1),S(""),l(!1),console.log("[LLM] Reasoning aborted")}catch(U){console.error("[LLM] Failed to abort reasoning:",U)}},setTemperature:v}}function Rr({reasoning:t,searchResults:e,loading:n}){const[r,i]=N(null);return n&&!t?a("div",{className:"reasoning-loading",children:[a("div",{className:"spinner"}),a("p",{children:"LLM is reasoning..."})]}):t?a("div",{className:"reasoning-output",children:[a("div",{className:"reasoning-header",children:[a("h4",{children:" LLM Reasoning"}),a("span",{className:"reasoning-meta",children:[t.inferenceTimeMs.toFixed(0),"ms  ",t.tokensGenerated," tokens"]})]}),a("div",{className:"reasoning-answer",children:t.answer}),t.usedSnippets.length>0&&a("div",{className:"reasoning-citations",children:[a("strong",{children:" Cited sources:"}),t.usedSnippets.map(s=>{const l=e==null?void 0:e.find(h=>h.gid===s);return a("span",{className:"citation",onMouseEnter:()=>i(s),onMouseLeave:()=>i(null),style:{position:"relative"},children:["Page ",(l==null?void 0:l.pageNo)||"?",r===s&&l&&a("div",{className:"citation-tooltip",children:[a("div",{className:"citation-tooltip-title",children:l.title}),l.snippet&&a("div",{className:"citation-tooltip-snippet",dangerouslySetInnerHTML:{__html:Kt.sanitize(l.snippet,{ALLOWED_TAGS:["mark","strong","em","b","i"],ALLOWED_ATTR:[]})}}),a("div",{className:"citation-tooltip-meta",children:["Score: ",l.scores.final.toFixed(3),"  GID: ",s.slice(0,8),"..."]})]})]},s)})]})]}):null}function xe(){return typeof navigator<"u"&&"storage"in navigator&&"getDirectory"in navigator.storage}async function kr(){if(!xe())throw new Error("OPFS not supported in this browser");return await navigator.storage.getDirectory()}async function Or(){return await(await kr()).getDirectoryHandle("capsules",{create:!0})}function xr(t){const e=t.replace(/[^a-z0-9._-]/gi,"-");return e.endsWith(".mgx.sqlite")?e:`${e}.mgx.sqlite`}async function Mr(t,e){if(!xe())throw new Error("OPFS not supported - cannot persist file");const n=await Or(),r=e||xr(t.name),s=await(await n.getFileHandle(r,{create:!0})).createWritable();try{return await s.write(t),await s.close(),console.log(`[OPFS] Copied file to ${r} (${t.size} bytes)`),{path:r,size:t.size}}catch(l){throw await s.close(),l}}async function Ir(){if(!navigator.storage||!navigator.storage.estimate)return null;try{const t=await navigator.storage.estimate(),e=t.usage||0,n=t.quota||0;return{usage:e,quota:n,available:n-e,percentUsed:n>0?e/n*100:0}}catch(t){return console.error("[OPFS] Failed to get storage quota:",t),null}}async function Dr(){if(!navigator.storage||!navigator.storage.persist)return!1;try{const t=await navigator.storage.persist();return console.log(`[OPFS] Persistent storage: ${t}`),t}catch(t){return console.error("[OPFS] Failed to request persistent storage:",t),!1}}function ze(t){if(t===0)return"0 B";const e=1024,n=["B","KB","MB","GB"],r=Math.floor(Math.log(t)/Math.log(e));return`${(t/Math.pow(e,r)).toFixed(2)} ${n[r]}`}async function Fr(t,e=500*1024*1024){if(t.size===0)return{valid:!1,error:"File is empty"};if(t.size>e)return{valid:!1,error:`File too large (${ze(t.size)} > ${ze(e)})`};const n=t.name.toLowerCase();if(!n.endsWith(".mgx.sqlite")&&!n.endsWith(".sqlite"))return{valid:!1,error:"File must have .mgx.sqlite or .sqlite extension"};try{const r=await t.slice(0,16).arrayBuffer();if(!new TextDecoder().decode(r).startsWith("SQLite format 3"))return{valid:!1,error:"Not a valid SQLite file (invalid header)"}}catch(r){return{valid:!1,error:`Failed to read file header: ${r}`}}return{valid:!0}}function Pr({onFileSelected:t,onOpfsFileSelected:e,onError:n}){const[r,i]=N([]),[s,l]=N(null),[h,p]=N(!1),[d,m]=N(!1),o=oe();K(()=>{u(),f()},[]);async function u(){try{const g=await o.listOpfsFiles();i(g)}catch(g){console.error("[FilePicker] Failed to list OPFS files:",g)}}async function f(){var g,T;try{const S=await Ir();l(S);const L=await((T=(g=navigator.storage)==null?void 0:g.persisted)==null?void 0:T.call(g));m(L||!1)}catch(S){console.error("[FilePicker] Failed to get quota:",S)}}async function _(g){var L;const T=g.target,S=(L=T.files)==null?void 0:L[0];if(S){p(!0);try{const A=await Fr(S);if(!A.valid){n(A.error),p(!1);return}if(xe()){const{path:H}=await Mr(S);await u(),await f(),t(S,H)}else t(S)}catch(A){n(`Failed to load file: ${A}`)}finally{p(!1),T.value=""}}}async function b(g){p(!0);try{e(g)}catch(T){n(`Failed to open from OPFS: ${T}`)}finally{p(!1)}}async function v(g,T){if(T.stopPropagation(),!!confirm(`Remove "${g}" from device storage?`))try{await o.removeFromOpfs(g),await u(),await f()}catch(S){n(`Failed to remove file: ${S}`)}}async function y(){try{await Dr()?m(!0):n("Persistent storage not granted. Files may be evicted under storage pressure.")}catch(g){n(`Failed to request persistence: ${g}`)}}return a("div",{class:"file-picker",children:[a("div",{class:"file-picker-header",children:[a("h2",{children:"Open Capsule"}),s&&a("div",{class:"storage-quota",children:[a("div",{class:"quota-bar",children:a("div",{class:"quota-used",style:`width: ${Math.min(s.percentUsed,100)}%`})}),a("p",{class:"quota-text",children:[ze(s.usage)," / ",ze(s.quota)," used (",s.percentUsed.toFixed(1),"%)"]}),!d&&xe()&&a("button",{class:"btn-secondary btn-sm",onClick:y,children:"Request Persistent Storage"})]})]}),a("div",{class:"file-input-section",children:[a("label",{class:"file-input-label",children:[a("input",{type:"file",accept:".mgx.sqlite,.sqlite",onChange:_,disabled:h,style:"display: none"}),a("button",{class:"btn-primary",disabled:h,children:h?"Loading...":"Select File from Device"})]}),a("p",{class:"help-text",children:"Choose a .mgx.sqlite or .sqlite file from your device"})]}),xe()&&r.length>0&&a("div",{class:"opfs-files-section",children:[a("h3",{children:"Stored on Device"}),a("ul",{class:"opfs-files-list",children:r.map(g=>a("li",{class:"opfs-file-item",children:[a("button",{class:"opfs-file-button",onClick:()=>b(g.path),disabled:h,children:a("div",{class:"file-info",children:[a("span",{class:"file-name",children:g.path}),a("span",{class:"file-meta",children:[ze(g.size)," "," ",new Date(g.lastModified).toLocaleDateString()]})]})}),a("button",{class:"btn-remove",onClick:T=>v(g.path,T),title:"Remove from device","aria-label":"Remove from device",children:""})]},g.path))})]}),!xe()&&a("div",{class:"opfs-warning",children:a("p",{children:[a("strong",{children:"Note:"})," Your browser doesn't support persistent storage. Files will only be kept in memory and lost when you close the tab."]})})]})}function Ur(t={}){const{autoLoad:e=!1,maxHops:n=2,limit:r=50}=t,[i,s]=N(null),[l,h]=N(null),[p,d]=N(void 0),[m,o]=N(!1),[u,f]=N(null),_=async(L,A)=>{o(!0),f(null),h(L),d(A);try{const P=await oe().graphHops(L,A,n,r);s(P),console.log("[Graph] Loaded:",P.nodes.length,"nodes,",P.edges.length,"edges")}catch(H){const P=String(H);f(P),console.error("[Graph] Failed to load:",H)}finally{o(!1)}},b=async L=>{await _(L,p)},v=async L=>{l&&await _(l,L)},y=()=>{s(null),h(null),d(void 0),f(null)},g=()=>i?Array.from(new Set(i.edges.map(L=>L.predicate))):[],T=L=>i==null?void 0:i.nodes.find(A=>A.gid===L),S=L=>i?i.edges.filter(A=>A.fromGid===L):[];return K(()=>{e&&l&&_(l,p)},[e]),{graphData:i,seedGid:l,predicate:p,loading:m,error:u,predicates:g(),nodeCount:(i==null?void 0:i.nodes.length)||0,edgeCount:(i==null?void 0:i.edges.length)||0,loadGraph:_,navigateToNode:b,filterByPredicate:v,clear:y,getNode:T,getNodeEdges:S}}function Hr({nodes:t,edges:e,seedGid:n,onNodeClick:r,width:i=800,height:s=600}){const[l,h]=N(new Map),p=We();return K(()=>{const d=new Map,m=i/2,o=s/2;t.forEach((u,f)=>{const _=f/t.length*2*Math.PI,b=Math.min(i,s)/3;d.set(u.gid,{gid:u.gid,x:m+b*Math.cos(_),y:o+b*Math.sin(_),vx:0,vy:0})}),h(d)},[t,i,s]),K(()=>{if(l.size===0)return;const d=()=>{const o=new Map(l),u=.3;o.forEach(f=>{o.forEach(_=>{if(f.gid===_.gid)return;const b=_.x-f.x,v=_.y-f.y,y=b*b+v*v+1,g=Math.sqrt(y),T=2e3/y;f.vx-=b/g*T*u,f.vy-=v/g*T*u})}),e.forEach(f=>{const _=o.get(f.fromGid),b=o.get(f.toGid);if(!_||!b)return;const v=b.x-_.x,y=b.y-_.y,g=Math.sqrt(v*v+y*y)+1,T=g*.01;_.vx+=v/g*T*u,_.vy+=y/g*T*u,b.vx-=v/g*T*u,b.vy-=y/g*T*u}),o.forEach(f=>{f.x+=f.vx,f.y+=f.vy,f.vx*=.8,f.vy*=.8,f.x=Math.max(30,Math.min(i-30,f.x)),f.y=Math.max(30,Math.min(s-30,f.y))}),h(o),p.current=requestAnimationFrame(d)};p.current=requestAnimationFrame(d);const m=setTimeout(()=>{p.current&&cancelAnimationFrame(p.current)},3e3);return()=>{p.current&&cancelAnimationFrame(p.current),clearTimeout(m)}},[e,i,s]),a("svg",{width:i,height:s,className:"graph-view",style:{border:"1px solid var(--color-border)",borderRadius:"8px"},children:[a("g",{className:"graph-edges",children:e.map((d,m)=>{const o=l.get(d.fromGid),u=l.get(d.toGid);return!o||!u?null:a("line",{x1:o.x,y1:o.y,x2:u.x,y2:u.y,stroke:"#94a3b8",strokeWidth:Math.max(1,d.weight*2),strokeOpacity:.6,markerEnd:"url(#arrowhead)"},`${d.fromGid}-${d.toGid}-${m}`)})}),a("defs",{children:a("marker",{id:"arrowhead",markerWidth:"10",markerHeight:"10",refX:"9",refY:"3",orient:"auto",markerUnits:"strokeWidth",children:a("path",{d:"M0,0 L0,6 L9,3 z",fill:"#94a3b8"})})}),a("g",{className:"graph-nodes",children:t.map(d=>{const m=l.get(d.gid);if(!m)return null;const o=d.gid===n,u=o?12:8,f=o?"#3b82f6":"#64748b";return a("g",{className:"graph-node",onClick:()=>r==null?void 0:r(d.gid),style:{cursor:r?"pointer":"default"},children:[a("circle",{cx:m.x,cy:m.y,r:u,fill:f,stroke:"#ffffff",strokeWidth:2,opacity:.9}),a("text",{x:m.x,y:m.y-u-5,textAnchor:"middle",fontSize:"11",fill:"var(--color-fg)",style:{pointerEvents:"none",userSelect:"none"},children:d.title||`Page ${d.pageNo}`})]},d.gid)})})]})}function qr({nodes:t,edges:e,seedGid:n,onNodeClick:r,loading:i,error:s}){return i?a("div",{className:"graph-panel-loading",children:[a("div",{className:"spinner"}),a("p",{children:"Loading graph..."})]}):s?a("div",{className:"graph-panel-error",children:a("p",{children:["Error: ",s]})}):t.length===0?a("div",{className:"graph-panel-empty",children:[a("p",{children:"No graph data to display"}),a("p",{className:"hint",children:"Search for a page or select a result to explore its connections"})]}):a("div",{className:"graph-panel",children:[a("div",{className:"graph-info",children:[a("span",{children:[t.length," nodes"]}),a("span",{children:[e.length," edges"]})]}),a(Hr,{nodes:t,edges:e,seedGid:n,onNodeClick:r,width:800,height:600})]})}function $r({predicates:t,selectedPredicate:e,onPredicateChange:n,onReset:r}){return a("div",{className:"graph-controls",children:[a("div",{className:"graph-controls-section",children:[a("label",{className:"graph-controls-label",children:"Filter by Relationship:"}),a("select",{className:"graph-controls-select",value:e||"",onChange:i=>{const s=i.target.value;n(s||void 0)},children:[a("option",{value:"",children:"All Relationships"}),t.map(i=>a("option",{value:i,children:i},i))]})]}),r&&a("button",{className:"btn-secondary btn-sm",onClick:r,children:"Reset View"})]})}function Gr({nodeCount:t,edgeCount:e,predicateCount:n,seedNode:r}){return a("div",{className:"graph-stats",children:[a("div",{className:"graph-stat",children:[a("span",{className:"graph-stat-label",children:"Nodes:"}),a("span",{className:"graph-stat-value",children:t})]}),a("div",{className:"graph-stat",children:[a("span",{className:"graph-stat-label",children:"Edges:"}),a("span",{className:"graph-stat-value",children:e})]}),a("div",{className:"graph-stat",children:[a("span",{className:"graph-stat-label",children:"Relationships:"}),a("span",{className:"graph-stat-value",children:n})]}),r&&a("div",{className:"graph-stat",children:[a("span",{className:"graph-stat-label",children:"Seed:"}),a("span",{className:"graph-stat-value",children:r})]})]})}function Wr(t={}){const{autoLoadCheckpoints:e=!1}=t,[n,r]=N([]),[i,s]=N(null),[l,h]=N(!1),[p,d]=N(!1),[m,o]=N(null),u=async()=>{h(!0),o(null);try{const v=await oe().getCheckpoints();r(v),console.log("[Provenance] Loaded",v.length,"checkpoints")}catch(b){const v=String(b);o(v),console.error("[Provenance] Failed to load checkpoints:",b)}finally{h(!1)}},f=async b=>{d(!0),o(null);try{const y=await oe().verifyPage(b);s(y),console.log("[Provenance] Verification result:",y)}catch(v){const y=String(v);o(y),console.error("[Provenance] Failed to verify page:",v)}finally{d(!1)}},_=()=>{s(null)};return K(()=>{e&&u()},[e]),{checkpoints:n,verificationResult:i,loading:l,verifying:p,error:m,checkpointCount:n.length,latestCheckpoint:n[0]||null,loadCheckpoints:u,verifyPage:f,clearVerification:_}}function zr({checkpoint:t,isLatest:e}){return a("div",{className:`checkpoint-item ${e?"checkpoint-latest":""}`,children:[a("div",{className:"checkpoint-header",children:[a("div",{className:"checkpoint-epoch",children:[e&&a("span",{className:"checkpoint-badge",children:"Latest"}),a("span",{className:"checkpoint-epoch-value",children:["Epoch ",t.epoch]})]}),a("div",{className:"checkpoint-date",children:new Date(t.createdTs).toLocaleString()})]}),a("div",{className:"checkpoint-body",children:[a("div",{className:"checkpoint-field",children:[a("span",{className:"field-label",children:"Merkle Root:"}),a("code",{className:"field-value",title:t.merkleRoot,children:[t.merkleRoot.substring(0,16),"..."]})]}),a("div",{className:"checkpoint-field",children:[a("span",{className:"field-label",children:"Pages:"}),a("span",{className:"field-value",children:t.pagesCount})]}),t.anchors&&t.anchors.length>0&&a("div",{className:"checkpoint-field",children:[a("span",{className:"field-label",children:"Anchors:"}),a("span",{className:"field-value",children:t.anchors.length})]})]})]})}function Br({checkpoints:t,loading:e,error:n}){return e?a("div",{className:"checkpoint-timeline-loading",children:[a("div",{className:"spinner"}),a("p",{children:"Loading checkpoints..."})]}):n?a("div",{className:"checkpoint-timeline-error",children:a("p",{children:["Error: ",n]})}):t.length===0?a("div",{className:"checkpoint-timeline-empty",children:[a("p",{children:"No checkpoints found"}),a("p",{className:"hint",children:"This capsule has not been checkpointed yet"})]}):a("div",{className:"checkpoint-timeline",children:t.map((r,i)=>a(zr,{checkpoint:r,isLatest:i===0},r.epoch))})}function Xr({result:t,verifying:e,onVerify:n}){return e?a("div",{className:"verification-panel verification-loading",children:[a("div",{className:"spinner"}),a("p",{children:"Verifying page integrity..."})]}):t?a("div",{className:`verification-panel ${t.verified?"verification-success":"verification-failure"}`,children:[a("div",{className:"verification-header",children:a("div",{className:"verification-status",children:t.verified?a(le,{children:[a("span",{className:"status-icon",children:""}),a("span",{className:"status-text",children:"Verified"})]}):a(le,{children:[a("span",{className:"status-icon",children:""}),a("span",{className:"status-text",children:"Verification Failed"})]})})}),a("div",{className:"verification-body",children:[a("div",{className:"verification-field",children:[a("span",{className:"field-label",children:"Content SHA:"}),a("code",{className:"field-value",title:t.contentSha,children:[t.contentSha.substring(0,16),"..."]})]}),t.expectedSha&&a("div",{className:"verification-field",children:[a("span",{className:"field-label",children:"Expected SHA:"}),a("code",{className:"field-value",title:t.expectedSha,children:[t.expectedSha.substring(0,16),"..."]})]}),t.epoch&&a("div",{className:"verification-field",children:[a("span",{className:"field-label",children:"Checkpoint Epoch:"}),a("span",{className:"field-value",children:t.epoch})]}),t.merkleRoot&&a("div",{className:"verification-field",children:[a("span",{className:"field-label",children:"Merkle Root:"}),a("code",{className:"field-value",title:t.merkleRoot,children:[t.merkleRoot.substring(0,16),"..."]})]}),t.signer&&a("div",{className:"verification-field",children:[a("span",{className:"field-label",children:"Signer:"}),a("code",{className:"field-value",children:t.signer})]}),t.signature&&a("div",{className:"verification-field",children:[a("span",{className:"field-label",children:"Signature:"}),a("code",{className:"field-value",title:t.signature,children:[t.signature.substring(0,16),"..."]})]})]}),n&&a("div",{className:"verification-footer",children:a("button",{className:"btn-secondary btn-sm",onClick:n,children:"Verify Again"})})]}):a("div",{className:"verification-panel verification-empty",children:[a("p",{children:'Click "Verify Page" to check integrity'}),n&&a("button",{className:"btn-primary btn-sm",onClick:n,children:"Verify Page"})]})}function Vr({checkpoints:t,verificationResult:e,loading:n,verifying:r,error:i,onVerify:s}){const[l,h]=N("checkpoints");return a("div",{className:"provenance-panel",children:[a("div",{className:"provenance-header",children:a("h3",{children:"Provenance & Trust"})}),a("div",{className:"provenance-tabs",children:[a("button",{className:`provenance-tab ${l==="checkpoints"?"active":""}`,onClick:()=>h("checkpoints"),children:[" Checkpoints (",t.length,")"]}),a("button",{className:`provenance-tab ${l==="verification"?"active":""}`,onClick:()=>h("verification"),children:" Verification"})]}),a("div",{className:"provenance-content",children:[l==="checkpoints"&&a(Br,{checkpoints:t,loading:n,error:i}),l==="verification"&&a(Xr,{result:e,verifying:r,onVerify:s})]})]})}function Yr(t){const{onFocusSearch:e,onToggleLlm:n,onEscape:r}=t;K(()=>{function i(s){const l=s.target,h=l.tagName==="INPUT"||l.tagName==="TEXTAREA"||l.isContentEditable;if(s.key==="/"&&!h){s.preventDefault(),e==null||e();return}if((s.ctrlKey||s.metaKey)&&s.key==="l"){s.preventDefault(),n==null||n();return}if(s.key==="Escape"){r==null||r();return}}return window.addEventListener("keydown",i),()=>{window.removeEventListener("keydown",i)}},[e,n,r])}function Qr(){const[t,e]=N(q.getInfo()),[n,r]=N(q.getModality()),[i,s]=N(q.getEnvelopeStats());return K(()=>{const f=ce.subscribe("capsule.loaded",()=>{e(q.getInfo()),r(q.getModality()),s(q.getEnvelopeStats())}),_=ce.subscribe("capsule.unloaded",()=>{e(null),r("static"),s(null)}),b=ce.subscribe("envelope.stats",v=>{s(v)});return()=>{f(),_(),b()}},[]),{info:t,modality:n,isDynamic:n==="dynamic",envelopeStats:i,enableDynamicMode:async()=>{await q.enableDynamicMode(),r("dynamic")},saveGlyphCase:async()=>q.saveGlyphCase(),exportGlyphCase:async()=>q.exportGlyphCase(),exportEnvelopeSidecar:async()=>q.exportEnvelopeSidecar(),clearEnvelope:async()=>{await q.clearEnvelope(),s(q.getEnvelopeStats())},verifyEnvelope:async()=>q.verifyEnvelope(),setModalityPreference:f=>{q.setModalityPreference(f)}}}function jr({modality:t,envelopeStats:e,envelopeExtracted:n,onEnableDynamic:r,onSaveGlyphCase:i,onClearEnvelope:s,onVerifyEnvelope:l}){const[h,p]=N(!1),[d,m]=N(!1),o=async()=>{if(r){m(!0);try{await r()}catch(v){console.error("Failed to enable dynamic mode:",v),alert(`Failed to enable dynamic mode: ${v}`)}finally{m(!1)}}},u=async()=>{if(i){m(!0);try{await i(),p(!1)}catch(v){console.error("Failed to save GlyphCase:",v),alert(`Failed to save GlyphCase: ${v}`)}finally{m(!1)}}},f=async()=>{if(!(!s||!confirm(`Are you sure you want to clear all envelope data?

This will delete:
 ${(e==null?void 0:e.retrievalCount)||0} retrieval logs
 ${(e==null?void 0:e.feedbackCount)||0} feedback entries
 ${(e==null?void 0:e.embeddingCount)||0} contextual embeddings
 ${(e==null?void 0:e.summaryCount)||0} context summaries

This action cannot be undone.`))){m(!0);try{await s(),p(!1)}catch(y){console.error("Failed to clear envelope:",y),alert(`Failed to clear envelope: ${y}`)}finally{m(!1)}}},_=async()=>{if(l){m(!0);try{await l(),p(!1)}catch(v){console.error("Failed to verify envelope:",v),alert(`Failed to verify envelope: ${v}`)}finally{m(!1)}}},b=t==="dynamic";return a("div",{className:"modality-badge",children:[a("button",{className:`modality-badge-button ${t}`,onClick:()=>p(!h),title:b?"Dynamic GlyphCase - Click for options":"Static GlyphCase - Click for options",children:b?" Dynamic":" Static"}),h&&a("div",{className:"modality-menu",children:[a("div",{className:"modality-menu-header",children:[a("h3",{children:b?"Dynamic Mode":"Static Mode"}),a("button",{className:"modality-menu-close",onClick:()=>p(!1),children:""})]}),b?a("div",{className:"modality-menu-content",children:[a("p",{className:"modality-description",children:"This GlyphCase has an active Envelope for episodic memory."}),n&&a("p",{className:"envelope-hint",style:{marginBottom:"1rem",fontSize:"0.9em",color:"#6b7280"},children:" Opened from canonical .gcase+ format (Core + Envelope in single file)"}),e&&a("div",{className:"envelope-stats",children:[a("h4",{children:"Envelope Statistics:"}),a("div",{className:"envelope-stats-grid",children:[a("div",{className:"envelope-stat",children:[a("span",{className:"envelope-stat-label",children:"Retrievals"}),a("span",{className:"envelope-stat-value",children:e.retrievalCount})]}),a("div",{className:"envelope-stat",children:[a("span",{className:"envelope-stat-label",children:"Feedbacks"}),a("span",{className:"envelope-stat-value",children:e.feedbackCount})]}),a("div",{className:"envelope-stat",children:[a("span",{className:"envelope-stat-label",children:"Embeddings"}),a("span",{className:"envelope-stat-value",children:e.embeddingCount})]}),a("div",{className:"envelope-stat",children:[a("span",{className:"envelope-stat-label",children:"Summaries"}),a("span",{className:"envelope-stat-value",children:e.summaryCount})]})]}),e.firstActivity&&a("p",{className:"envelope-activity",children:[a("strong",{children:"Active since:"})," ",new Date(e.firstActivity).toLocaleString()]})]}),a("div",{className:"envelope-actions",children:[a("button",{className:"btn-secondary btn-sm",onClick:_,disabled:d,children:d?"Verifying...":" Verify Integrity"}),a("button",{className:"btn-secondary btn-sm",onClick:u,disabled:d,children:d?"Saving...":" Save GlyphCase"}),a("button",{className:"btn-danger btn-sm",onClick:f,disabled:d,children:d?"Clearing...":" Clear Envelope"})]}),a("p",{className:"envelope-hint",children:" Save GlyphCase exports a single .gcase+ file with Core + Envelope merged together."})]}):a("div",{className:"modality-menu-content",children:[a("p",{className:"modality-description",children:"This GlyphCase is in static mode. All data is read-only."}),a("div",{className:"modality-info",children:[a("h4",{children:"Enable Dynamic Mode to:"}),a("ul",{children:[a("li",{children:"Log search queries and results"}),a("li",{children:"Provide feedback on retrievals"}),a("li",{children:"Generate contextual summaries"}),a("li",{children:"Build adaptive memory over time"})]})]}),a("button",{className:"btn-primary",onClick:o,disabled:d,children:d?"Enabling...":"Enable Dynamic Mode"})]})]}),h&&a("div",{className:"modality-menu-backdrop",onClick:()=>p(!1)})]})}function Kr(t){return t.startsWith("asset://")?{protocol:"asset",path:t.slice(8)}:null}const Ft=new Map,Zr=new Map;async function Jr(t){if(Ft.has(t))return Ft.get(t);const e=Kr(t);if(!e)return console.error("[Assets] Invalid asset URL:",t),null;try{const r=await oe().getPageBlob(e.path);if(!r||r.size===0)return console.warn("[Assets] Asset not found or empty:",e.path),null;const i=URL.createObjectURL(r);return Ft.set(t,i),Zr.set(t,r),console.log("[Assets] Loaded:",e.path,`(${r.size} bytes, ${r.type||"unknown type"})`),i}catch(n){return console.error("[Assets] Failed to load asset:",t,n),null}}function ei(t){const[e,n]=N(null);return K(()=>{if(!t){n(null);return}if(!t.startsWith("asset://")){n(t);return}Jr(t).then(n)},[t]),e}function ti({gid:t,onClose:e}){const[n,r]=N(null),[i,s]=N(!0),[l,h]=N(null);K(()=>{(async()=>{s(!0),h(null);try{const u=await oe().query("SELECT gid, doc_id, page_no, title, tags, updated_ts FROM meta_index WHERE gid = ? LIMIT 1",[t]);u.length>0?r(u[0]):h("Page not found")}catch(o){h(String(o)),console.error("[PagePreview] Failed to load page:",o)}finally{s(!1)}})()},[t]);const p=n?`asset://glyphs/page_${String(n.pageNo).padStart(4,"0")}.mgx.png`:void 0,d=ei(p);return i?a("div",{className:"page-preview",children:a("div",{className:"page-preview-loading",children:[a("div",{className:"spinner"}),a("p",{children:"Loading page..."})]})}):l||!n?a("div",{className:"page-preview",children:a("div",{className:"page-preview-error",children:[a("p",{children:["Error: ",l||"Page not found"]}),e&&a("button",{className:"btn-secondary",onClick:e,children:"Close"})]})}):a("div",{className:"page-preview",children:[a("div",{className:"page-preview-header",children:[a("div",{className:"page-preview-title",children:[a("span",{className:"page-number",children:["Page ",n.pageNo]}),a("h3",{children:n.title||"(Untitled)"})]}),e&&a("button",{className:"btn-icon",onClick:e,title:"Close preview",children:""})]}),a("div",{className:"page-preview-content",children:d?a("img",{src:d,alt:`Page ${n.pageNo}`,className:"page-image"}):a("div",{className:"page-preview-placeholder",children:a("p",{children:"No image available for this page"})})}),a("div",{className:"page-preview-metadata",children:a("dl",{children:[a("dt",{children:"GID:"}),a("dd",{children:a("code",{title:n.gid,children:[n.gid.substring(0,16),"..."]})}),n.tags&&a(le,{children:[a("dt",{children:"Tags:"}),a("dd",{children:n.tags})]}),a("dt",{children:"Updated:"}),a("dd",{children:new Date(n.updatedTs).toLocaleString()})]})})]})}function ni({selectedGid:t,onClose:e}){return t?a(ti,{gid:t,onClose:e}):a("div",{className:"page-preview-panel-empty",children:a("p",{children:"Select a search result to preview the page"})})}function ai({config:t,children:e}){return a("div",{className:"layout-landing",children:[a("section",{className:"hero",children:[a("div",{className:"hero-content",children:[t.logo_asset&&a("img",{src:t.logo_asset,alt:"Logo",className:"hero-logo"}),a("h1",{className:"hero-title",children:t.hero_title||t.site_title||"Welcome"}),t.hero_subtitle&&a("p",{className:"hero-subtitle",children:t.hero_subtitle})]}),t.hero_image&&a("div",{className:"hero-background",style:{backgroundImage:`url(${t.hero_image})`}})]}),a("main",{className:"landing-main",children:e})]})}function ri({config:t,navigation:e,currentPage:n,children:r}){const i=e.filter(s=>s.menu==="sidebar");return a("div",{className:"layout-docs",children:[a("aside",{className:"docs-sidebar",children:a("nav",{className:"docs-nav",children:[a("div",{className:"docs-nav-header",children:[t.logo_asset&&a("img",{src:t.logo_asset,alt:"Logo",className:"docs-logo"}),a("h3",{children:t.site_title||"Documentation"})]}),a("ul",{className:"docs-nav-list",children:i.map(s=>a("li",{className:"docs-nav-item",children:a("a",{href:`#${s.to_slug}`,className:(n==null?void 0:n.slug)===s.to_slug?"active":"",children:[s.icon_asset&&a("img",{src:s.icon_asset,alt:"",className:"nav-icon"}),s.label]})},s.to_slug))})]})}),a("main",{className:"docs-main",children:[n&&a("div",{className:"docs-breadcrumbs",children:[a("a",{href:"#/",children:"Home"}),n.category&&a(le,{children:[a("span",{children:" / "}),a("span",{children:n.category})]}),a("span",{children:" / "}),a("span",{children:n.title})]}),a("article",{className:"docs-content",children:[n&&a("h1",{children:n.title}),r]})]})]})}function ua({config:t,children:e}){return a("div",{className:"layout-dashboard",children:[a("header",{className:"dashboard-header",children:a("h1",{children:t.site_title||"Dashboard"})}),a("main",{className:"dashboard-content",children:e})]})}function ha({config:t,title:e,children:n}){return a("div",{className:"layout-simple",children:[a("header",{className:"simple-header",children:[t.logo_asset&&a("img",{src:t.logo_asset,alt:"Logo",className:"simple-logo"}),e&&a("h1",{children:e})]}),a("main",{className:"simple-content",children:n}),a("footer",{className:"simple-footer",children:a("p",{children:"Powered by GlyphCase"})})]})}function ii({topBar:t,leftSidebar:e,centerPanel:n,rightSidebar:r,showLeftSidebar:i=!0,showRightSidebar:s=!1}){return a("div",{className:"capsule-layout",children:[a("div",{className:"capsule-topbar",children:t}),a("div",{className:"capsule-content",children:[i&&e&&a("aside",{className:"capsule-sidebar capsule-sidebar-left",children:e}),a("main",{className:"capsule-main",children:n}),s&&r&&a("aside",{className:"capsule-sidebar capsule-sidebar-right",children:r})]})]})}function si({capsuleName:t,onClose:e,actions:n}){return a("div",{className:"topbar-content",children:[a("div",{className:"topbar-left",children:a("h2",{className:"topbar-title",children:[" ",t]})}),a("div",{className:"topbar-right",children:[n,e&&a("button",{className:"btn-secondary btn-sm",onClick:e,children:"Close Capsule"})]})]})}function li({title:t,children:e,onClear:n,hasActiveFilters:r=!1}){return a("div",{className:"filter-panel",children:[a("div",{className:"filter-panel-header",children:[a("h3",{children:t}),r&&n&&a("button",{className:"btn-link btn-sm",onClick:n,children:"Clear All"})]}),a("div",{className:"filter-panel-content",children:e})]})}function oi({limit:t=50}){const[e,n]=N([]),[r,i]=N(!1),[s,l]=N(null);K(()=>{h()},[t]);const h=async()=>{if(!q.isDynamic()){n([]);return}i(!0),l(null);try{const u=q.getEnvelope();if(!u.isOpen()){n([]);return}const f=u.getRecentActivity(t);n(f)}catch(u){l(String(u)),console.error("[EnvelopeTimeline] Failed to load:",u)}finally{i(!1)}},p=u=>{switch(u){case"retrieval":return"";case"feedback":return"";case"summary":return"";default:return""}},d=u=>{switch(u){case"retrieval":return"timeline-event-retrieval";case"feedback":return"timeline-event-feedback";case"summary":return"timeline-event-summary";default:return""}},m=u=>u===null?"":u===1?" Helpful":u===-1?" Not helpful":" Neutral",o=u=>{try{const f=new Date(u),b=new Date().getTime()-f.getTime(),v=Math.floor(b/6e4);if(v<1)return"Just now";if(v<60)return`${v}m ago`;const y=Math.floor(v/60);if(y<24)return`${y}h ago`;const g=Math.floor(y/24);return g<7?`${g}d ago`:f.toLocaleDateString()}catch{return u}};return q.isDynamic()?r?a("div",{className:"envelope-timeline",children:a("div",{className:"timeline-loading",children:[a("div",{className:"spinner"}),a("p",{children:"Loading timeline..."})]})}):s?a("div",{className:"envelope-timeline",children:a("div",{className:"timeline-error",children:[a("p",{children:" Failed to load timeline"}),a("p",{className:"error-message",children:s}),a("button",{className:"btn-secondary btn-sm",onClick:h,children:"Retry"})]})}):e.length===0?a("div",{className:"envelope-timeline",children:a("div",{className:"timeline-empty",children:[a("p",{children:"No activity yet."}),a("p",{className:"timeline-hint",children:"Search, give feedback, or generate summaries to populate the timeline."})]})}):a("div",{className:"envelope-timeline",children:[a("div",{className:"timeline-header",children:[a("h3",{children:" Activity Timeline"}),a("span",{className:"timeline-count",children:[e.length," events"]})]}),a("div",{className:"timeline-events",children:e.map((u,f)=>a("div",{className:`timeline-event ${d(u.eventType)}`,children:[a("div",{className:"timeline-event-icon",children:p(u.eventType)}),a("div",{className:"timeline-event-content",children:[a("div",{className:"timeline-event-header",children:[a("span",{className:"timeline-event-type",children:u.eventType.charAt(0).toUpperCase()+u.eventType.slice(1)}),a("span",{className:"timeline-event-time",children:o(u.timestamp)})]}),a("div",{className:"timeline-event-description",children:u.description}),u.eventType==="feedback"&&u.value!==null&&a("div",{className:"timeline-event-meta",children:m(u.value)}),u.eventType==="summary"&&u.value!==null&&a("div",{className:"timeline-event-meta",children:["Relevance: ",(u.value*100).toFixed(0),"%"]})]})]},`${u.id}-${f}`))}),a("div",{className:"timeline-footer",children:a("button",{className:"btn-secondary btn-sm",onClick:h,children:"Refresh Timeline"})})]}):a("div",{className:"envelope-timeline",children:a("div",{className:"timeline-empty",children:[a("p",{children:"Timeline is only available in Dynamic mode."}),a("p",{className:"timeline-hint",children:"Enable Dynamic mode to start tracking activity."})]})})}class be extends Ge{constructor(n){super(n);x(this,"reset",()=>{this.setState({hasError:!1,error:null})});this.state={hasError:!1,error:null}}static getDerivedStateFromError(n){return{hasError:!0,error:n}}componentDidCatch(n,r){const{name:i="Unknown"}=this.props;console.error(`[ErrorBoundary:${i}]`,n,r)}render(){const{hasError:n,error:r}=this.state,{children:i,fallback:s,name:l="Component"}=this.props;return n&&r?s?s(r,this.reset):a("div",{className:"error-boundary",children:a("div",{className:"error-boundary-content",children:[a("h3",{children:[" ",l," Error"]}),a("p",{className:"error-message",children:r.message}),a("button",{className:"btn-secondary",onClick:this.reset,children:"Try Again"}),!1]})}):i}}function ci({capsuleInfo:t,onClose:e}){var H,P;const[n,r]=N("search"),[i,s]=N(null),[l,h]=N(!1),[p,d]=N(!1),m=ra({defaultMode:"fts"}),o=ca({autoLoad:!0}),u=Ur({maxHops:2,limit:50}),f=Wr({autoLoadCheckpoints:!0}),_=da({}),b=Qr();Yr({onFocusSearch:()=>{const O=document.querySelector('input[name="query"]');O==null||O.focus(),O==null||O.select()},onToggleLlm:()=>{_.toggle()},onEscape:()=>{document.activeElement instanceof HTMLElement&&document.activeElement.blur()}});const v=O=>{s(O)},y=O=>{u.navigateToNode(O),s(O)},g=O=>{r("graph"),u.loadGraph(O),s(O)},T=()=>{m.clearFilter(),m.lastQuery&&m.search(m.lastQuery)},S=()=>{i&&(f.verifyPage(i),h(!0))},L=async()=>{_.enabled&&m.results&&m.results.length>0&&m.lastQuery&&(_.clearReasoning(),await _.reason(m.lastQuery,m.results,1500))};K(()=>{_.enabled&&m.results&&m.results.length>0&&m.lastQuery&&(!_.reasoning||_.reasoning.usedSnippets.length===0)&&L()},[_.enabled,m.results,m.lastQuery]);const A=!!(m.entityFilter.entityType||m.entityFilter.entityValue);return a(ii,{topBar:a(si,{capsuleName:t.fileName,onClose:e,actions:a(le,{children:[a("div",{className:"capsule-stats",children:[a("span",{children:[t.pageCount," pages"]}),a("span",{children:[t.entityCount," entities"]}),a("span",{children:[t.edgeCount," edges"]})]}),a(jr,{modality:b.modality,envelopeStats:b.envelopeStats,envelopeExtracted:(H=b.info)==null?void 0:H.envelopeExtracted,onEnableDynamic:b.enableDynamicMode,onSaveGlyphCase:async()=>{var R;const O=await b.saveGlyphCase(),he=URL.createObjectURL(O),M=document.createElement("a");M.href=he;const ae=b.modality==="dynamic"?".gcase+":".gcase",U=(((R=b.info)==null?void 0:R.fileName)||"glyphcase").replace(/\.(db|gcase|gcase\+)$/,"");M.download=`${U}${ae}`,M.click(),URL.revokeObjectURL(he)},onClearEnvelope:b.clearEnvelope,onVerifyEnvelope:async()=>{const O=await b.verifyEnvelope();O&&(O.valid?alert(` Envelope integrity verified!

The hash chain is intact.`):alert(` Envelope integrity check failed:

${O.errors.join(`
`)}`))}}),a("button",{className:`btn-secondary btn-sm ${_.enabled?"active":""}`,onClick:_.toggle,disabled:_.loading,title:(P=_.modelInfo)!=null&&P.loaded?"LLM Ready":"Click to load LLM",children:[" ",_.enabled?"LLM On":"LLM Off"]}),a("button",{className:`btn-secondary btn-sm ${l?"active":""}`,onClick:()=>h(!l),children:[l?"":""," Provenance"]}),b.isDynamic&&a("button",{className:`btn-secondary btn-sm ${p?"active":""}`,onClick:()=>d(!p),children:[p?"":""," Timeline"]})]})}),leftSidebar:a(be,{name:"EntityPanel",children:a(li,{title:"Entity Filters",onClear:T,hasActiveFilters:A,children:[A&&a("div",{className:"active-filters",children:[a("p",{className:"filter-label",children:"Active Filter:"}),m.entityFilter.entityType&&a("span",{className:"filter-tag",children:["Type: ",m.entityFilter.entityType]}),m.entityFilter.entityValue&&a("span",{className:"filter-tag",children:["Value: ",m.entityFilter.entityValue]})]}),a(wr,{entities:o.entities,types:o.types,selectedType:o.selectedType,totalCount:o.totalCount,onSelectType:o.selectType,getTypeCount:o.getTypeCount,show:!0,maxDisplay:20})]})}),centerPanel:a("div",{className:"capsule-center",children:[a("div",{className:"view-mode-tabs",children:[a("button",{className:`tab-btn ${n==="search"?"active":""}`,onClick:()=>r("search"),children:" Search"}),a("button",{className:`tab-btn ${n==="graph"?"active":""}`,onClick:()=>r("graph"),children:" Graph"})]}),n==="search"&&a(le,{children:[a(be,{name:"SearchPanel",children:a(Nr,{mode:m.mode,results:m.results,lastQuery:m.lastQuery,loading:m.loading,onSearch:m.search,onModeChange:m.changeMode,onResultClick:v,showModeToggle:!0,placeholder:"Search the capsule...",searchHint:'Try: "vector search", "LEANN", "SQLite", or "hybrid retrieval"',searchHistory:m.searchHistory,onClearHistory:m.clearHistory})}),a(be,{name:"LLM",children:[_.enabled&&m.results&&m.results.length>0&&a("div",{className:"llm-section",children:[a("div",{className:"llm-temperature-control",children:[a("label",{htmlFor:"temperature-slider",className:"temperature-label",children:["Creativity:",a("input",{id:"temperature-slider",type:"range",min:"0",max:"1",step:"0.1",value:_.temperature,onChange:O=>_.setTemperature(parseFloat(O.currentTarget.value)),className:"temperature-slider"}),a("span",{className:"temperature-value",children:_.temperature.toFixed(1)})]}),a("small",{className:"temperature-hint",children:[_.temperature<.3&&" Very factual",_.temperature>=.3&&_.temperature<.6&&" Mostly factual",_.temperature>=.6&&_.temperature<.8&&" Balanced",_.temperature>=.8&&" Creative"]})]}),_.progress&&a("div",{className:"llm-progress-bar",children:[a("div",{className:"llm-progress-info",children:[a("span",{children:[" ",_.progress.message]}),a("span",{children:[(_.progress.progress*100).toFixed(0),"%"]})]}),a("div",{className:"llm-progress-track",children:a("div",{className:"llm-progress-fill",style:{width:`${_.progress.progress*100}%`}})})]}),_.isStreaming&&_.streamingText&&a("div",{className:"streaming-output",children:[a("div",{className:"streaming-header",children:[a("span",{className:"streaming-indicator",children:" Streaming..."}),a("button",{className:"btn-secondary btn-sm abort-btn",onClick:()=>_.abortReasoning(),title:"Stop reasoning",children:" Stop"})]}),a("div",{className:"streaming-text",children:[_.streamingText,a("span",{className:"streaming-cursor",children:""})]})]}),_.reasoning&&a(Rr,{reasoning:_.reasoning,searchResults:m.results,loading:_.loading}),_.loading&&!_.reasoning&&!_.progress&&!_.isStreaming&&a("div",{className:"reasoning-loading",children:[a("div",{className:"spinner"}),a("p",{children:"LLM is reasoning over search results..."}),_.elapsedTime>0&&a("p",{className:"inference-time",children:["Elapsed: ",_.elapsedTime.toFixed(1),"s",_.elapsedTime>3&&"  Typically takes 2-5s"]})]}),_.error&&a("div",{className:"llm-error-panel",children:[a("strong",{children:" LLM Error:"})," ",_.error,a("button",{className:"btn-secondary btn-sm",onClick:L,disabled:_.loading,style:{marginLeft:"1rem"},children:_.loading?"Retrying...":"Try Again"})]})]}),_.enabled&&(!m.results||m.results.length===0)&&m.lastQuery&&a("div",{className:"llm-no-results",children:a("p",{children:" LLM needs search results to reason. Try searching first!"})})]})]}),n==="graph"&&a(be,{name:"GraphPanel",children:a("div",{className:"graph-view-container",children:[!u.graphData&&a("div",{className:"graph-view-empty",children:[a("p",{children:"Select a search result to explore its graph connections"}),a("p",{className:"hint",children:"Or switch to Search tab to find pages"})]}),u.graphData&&a(le,{children:[a(Gr,{nodeCount:u.nodeCount,edgeCount:u.edgeCount,predicateCount:u.predicates.length,seedNode:u.seedGid||void 0}),a($r,{predicates:u.predicates,selectedPredicate:u.predicate,onPredicateChange:u.filterByPredicate,onReset:u.clear}),a(qr,{nodes:u.graphData.nodes,edges:u.graphData.edges,seedGid:u.seedGid||void 0,onNodeClick:y,loading:u.loading,error:u.error})]})]})}),i&&a(be,{name:"PagePreview",children:a("div",{className:"page-preview-section",children:[a("div",{className:"page-preview-header-actions",children:[a("h3",{children:"Page Preview"}),a("div",{className:"page-preview-actions",children:[n==="search"&&a("button",{className:"btn-secondary btn-sm",onClick:()=>g(i),children:"Explore Graph"}),a("button",{className:"btn-primary btn-sm",onClick:S,disabled:f.verifying,children:f.verifying?"Verifying...":"Verify Page"})]})]}),a(ni,{selectedGid:i,onClose:()=>s(null)})]})})]}),rightSidebar:a(le,{children:[l&&a(be,{name:"ProvenancePanel",children:a(Vr,{checkpoints:f.checkpoints,verificationResult:f.verificationResult,loading:f.loading,verifying:f.verifying,error:f.error,onVerify:S})}),p&&b.isDynamic&&a(be,{name:"EnvelopeTimeline",children:a(oi,{limit:100})})]}),showLeftSidebar:!0,showRightSidebar:l||p})}async function di(t){const n=(await t.query("SELECT name FROM sqlite_master WHERE type='table'")).map(u=>u.name),r=n.includes("_ui_pages"),i=n.includes("_ui_dashboards"),s=n.includes("_ui_navigation"),l=n.includes("_ui_params"),h=n.includes("_meta_manifest"),p=n.includes("sqlar"),d=n.some(u=>u.startsWith("fts_"));let m="1.0";if(h)try{const u=await t.query("SELECT value FROM _meta_manifest WHERE key='gcui'");u.length>0&&(m=u[0].value)}catch(u){console.warn("Failed to read GCUI version:",u)}let o;return r&&i?o="hybrid":r?o="website":i?o="dashboard":o="generic",{version:m,hasWebsite:r,hasDashboards:i,hasNavigation:s,hasParams:l,hasFTS:d,hasAssets:p,mode:o}}async function ui(t){try{const e=await t.query("SELECT key, value FROM _meta_manifest");if(e.length===0)return null;const n={gcui:"1.0",capsule_kind:"sqlar"};return e.forEach(r=>{n[r.key]=r.value}),n}catch(e){return console.warn("Failed to load manifest:",e),null}}async function hi(t){try{const e=await t.query("SELECT key, value FROM _ui_config"),n={};return e.forEach(r=>{n[r.key]=r.value}),n}catch(e){return console.warn("Failed to load config:",e),{}}}async function pi(t){try{return(await t.query("SELECT slug, title, content, layout, category, order_index FROM _ui_pages ORDER BY order_index ASC, slug ASC")).map(n=>({slug:n.slug,title:n.title,content:n.content||void 0,layout:n.layout||void 0,category:n.category||void 0,order_index:n.order_index||void 0}))}catch(e){return console.warn("Failed to load pages:",e),[]}}async function mi(t){try{return(await t.query("SELECT menu, label, to_slug, order_index, icon_asset FROM _ui_navigation ORDER BY menu, order_index ASC")).map(n=>({menu:n.menu,label:n.label,to_slug:n.to_slug,order_index:n.order_index||void 0,icon_asset:n.icon_asset||void 0}))}catch(e){return console.warn("Failed to load navigation:",e),[]}}async function fi(t){try{return(await t.query("SELECT name, query, grammar, config FROM _ui_dashboards")).map(n=>({name:n.name,query:n.query,grammar:n.grammar||void 0,config:n.config||void 0}))}catch(e){return console.warn("Failed to load dashboards:",e),[]}}async function gi(t){const e=await di(t),n=await ui(t)||{gcui:e.version,capsule_kind:"sqlar"},r=await hi(t),i=e.hasWebsite?await pi(t):[],s=e.hasNavigation?await mi(t):[],l=e.hasDashboards?await fi(t):[];return{manifest:n,capabilities:e,config:r,pages:i,navigation:s,dashboards:l}}function _i({data:t,config:e,width:n=600,height:r=400}){if(!t||t.length===0)return a("div",{className:"chart-empty",style:{width:n,height:r},children:a("p",{children:"No data to display"})});switch(e.mark){case"bar":return a(yi,{data:t,config:e,width:n,height:r});case"line":return a(vi,{data:t,config:e,width:n,height:r});case"point":return a(Ei,{data:t,config:e,width:n,height:r});case"area":return a(bi,{data:t,config:e,width:n,height:r});default:return a("div",{className:"chart-unsupported",style:{width:n,height:r},children:[a("p",{children:["Unsupported chart type: ",e.mark]}),a("p",{children:"Showing data as table:"}),a(Ti,{data:t})]})}}function yi({data:t,config:e,width:n,height:r}){var d,m;const{encoding:i}=e,s=((d=i.x)==null?void 0:d.field)||Object.keys(t[0])[0],l=((m=i.y)==null?void 0:m.field)||Object.keys(t[0])[1],h=Math.max(...t.map(o=>Number(o[l])||0)),p=Math.max(20,(n-100)/t.length-10);return a("div",{className:"chart chart-bar",style:{width:n,height:r},children:[e.title&&a("h4",{className:"chart-title",children:e.title}),a("div",{className:"chart-container",style:{height:r-60},children:a("div",{className:"chart-bars",style:{display:"flex",alignItems:"flex-end",height:"100%",gap:"8px"},children:t.map((o,u)=>{const f=Number(o[l])||0,_=f/h*(r-100);return a("div",{className:"chart-bar-item",style:{textAlign:"center"},children:[a("div",{className:"bar",style:{width:p,height:_,backgroundColor:"#6366f1",borderRadius:"4px 4px 0 0"},title:`${o[s]}: ${f}`}),a("div",{className:"bar-label",style:{fontSize:"12px",marginTop:"4px",maxWidth:p,overflow:"hidden",textOverflow:"ellipsis"},children:String(o[s]).slice(0,10)})]},u)})})}),a("div",{className:"chart-legend",style:{fontSize:"12px",marginTop:"8px",textAlign:"center"},children:[a("strong",{children:l})," by ",a("strong",{children:s})]})]})}function vi({data:t,config:e,width:n,height:r}){var v,y;const{encoding:i}=e,s=((v=i.x)==null?void 0:v.field)||Object.keys(t[0])[0],l=((y=i.y)==null?void 0:y.field)||Object.keys(t[0])[1],h=t.map(g=>Number(g[l])||0),p=Math.max(...h),d=Math.min(...h),m=p-d||1,o=n-80,u=r-100,f=o/(t.length-1||1),_=t.map((g,T)=>{const S=40+T*f,L=Number(g[l])||0,A=u-(L-d)/m*u+20;return{x:S,y:A,value:L,label:g[s]}}),b=_.map((g,T)=>`${T===0?"M":"L"} ${g.x} ${g.y}`).join(" ");return a("div",{className:"chart chart-line",style:{width:n,height:r},children:[e.title&&a("h4",{className:"chart-title",children:e.title}),a("svg",{width:n,height:r-40,style:{overflow:"visible"},children:[[0,.25,.5,.75,1].map(g=>{const T=u-g*u+20,S=d+g*m;return a("g",{children:[a("line",{x1:40,y1:T,x2:n-40,y2:T,stroke:"#e5e7eb",strokeWidth:1}),a("text",{x:10,y:T+4,fontSize:10,fill:"#666",children:S.toFixed(0)})]},g)}),a("path",{d:b,fill:"none",stroke:"#6366f1",strokeWidth:2}),_.map((g,T)=>a("circle",{cx:g.x,cy:g.y,r:4,fill:"#6366f1",children:a("title",{children:`${g.label}: ${g.value}`})},T)),_.map((g,T)=>a("text",{x:g.x,y:u+40,fontSize:10,fill:"#666",textAnchor:"middle",children:String(g.label).slice(0,8)},T))]}),a("div",{className:"chart-legend",style:{fontSize:"12px",textAlign:"center"},children:[a("strong",{children:l})," over ",a("strong",{children:s})]})]})}function Ei({data:t,config:e,width:n,height:r}){var y,g;const{encoding:i}=e,s=((y=i.x)==null?void 0:y.field)||Object.keys(t[0])[0],l=((g=i.y)==null?void 0:g.field)||Object.keys(t[0])[1],h=t.map(T=>Number(T[s])||0),p=t.map(T=>Number(T[l])||0),d=Math.min(...h),m=Math.max(...h),o=Math.min(...p),u=Math.max(...p),f=m-d||1,_=u-o||1,b=n-80,v=r-100;return a("div",{className:"chart chart-scatter",style:{width:n,height:r},children:[e.title&&a("h4",{className:"chart-title",children:e.title}),a("svg",{width:n,height:r-40,children:[[0,.25,.5,.75,1].map(T=>{const S=v-T*v+20;return a("line",{x1:40,y1:S,x2:n-40,y2:S,stroke:"#e5e7eb",strokeWidth:1},T)}),t.map((T,S)=>{const L=Number(T[s])||0,A=Number(T[l])||0,H=40+(L-d)/f*b,P=v-(A-o)/_*v+20;return a("circle",{cx:H,cy:P,r:5,fill:"#6366f1",opacity:.7,children:a("title",{children:`${s}: ${L}, ${l}: ${A}`})},S)})]}),a("div",{className:"chart-legend",style:{fontSize:"12px",textAlign:"center"},children:[a("strong",{children:l})," vs ",a("strong",{children:s})]})]})}function bi({data:t,config:e,width:n,height:r}){var y,g;const{encoding:i}=e,s=((y=i.x)==null?void 0:y.field)||Object.keys(t[0])[0],l=((g=i.y)==null?void 0:g.field)||Object.keys(t[0])[1],h=t.map(T=>Number(T[l])||0),p=Math.max(...h),d=Math.min(...h),m=p-d||1,o=n-80,u=r-100,f=o/(t.length-1||1),b=t.map((T,S)=>{const L=40+S*f,A=Number(T[l])||0,H=u-(A-d)/m*u+20;return{x:L,y:H}}).map((T,S)=>`${S===0?"M":"L"} ${T.x} ${T.y}`).join(" "),v=`${b} L ${n-40} ${u+20} L 40 ${u+20} Z`;return a("div",{className:"chart chart-area",style:{width:n,height:r},children:[e.title&&a("h4",{className:"chart-title",children:e.title}),a("svg",{width:n,height:r-40,children:[a("path",{d:v,fill:"#6366f1",opacity:.3}),a("path",{d:b,fill:"none",stroke:"#6366f1",strokeWidth:2})]}),a("div",{className:"chart-legend",style:{fontSize:"12px",textAlign:"center"},children:[a("strong",{children:l})," over ",a("strong",{children:s})]})]})}function Ti({data:t}){if(t.length===0)return null;const e=Object.keys(t[0]);return a("table",{className:"data-table",style:{width:"100%",borderCollapse:"collapse",fontSize:"12px"},children:[a("thead",{children:a("tr",{children:e.map(n=>a("th",{style:{borderBottom:"2px solid #ddd",padding:"8px",textAlign:"left"},children:n},n))})}),a("tbody",{children:t.slice(0,10).map((n,r)=>a("tr",{children:e.map(i=>a("td",{style:{borderBottom:"1px solid #eee",padding:"6px"},children:String(n[i])},i))},r))})]})}function pa({dashboards:t}){return t.length===0?a("div",{className:"dashboard-empty",children:a("p",{children:"No dashboards defined"})}):a("div",{className:"dashboard-grid",children:t.map(e=>a(Ni,{dashboard:e},e.name))})}function Ni({dashboard:t}){const[e,n]=N(null),[r,i]=N(!1),[s,l]=N(null);K(()=>{h()},[t.query]);const h=async()=>{i(!0),l(null);try{const m=await oe().query(t.query);n(m)}catch(d){l(String(d)),console.error(`[Dashboard] Failed to load ${t.name}:`,d)}finally{i(!1)}};if(r)return a("div",{className:"dashboard-panel loading",children:[a("div",{className:"spinner"}),a("p",{children:["Loading ",t.name,"..."]})]});if(s)return a("div",{className:"dashboard-panel error",children:[a("h4",{children:t.name}),a("p",{className:"error-message",children:["Error: ",s]}),a("details",{children:[a("summary",{children:"Query"}),a("pre",{children:t.query})]})]});if(!e||e.length===0)return a("div",{className:"dashboard-panel empty",children:[a("h4",{children:t.name}),a("p",{children:"No data"})]});let p=null;if(t.config)try{p=JSON.parse(t.config)}catch(d){console.error(`[Dashboard] Invalid config for ${t.name}:`,d)}return!p||t.grammar!=="vegalite-lite-v1"?a("div",{className:"dashboard-panel table",children:[a("h4",{children:t.name}),a(Si,{data:e})]}):a("div",{className:"dashboard-panel chart",children:a(_i,{data:e,config:p,width:600,height:400})})}function Si({data:t}){const e=Object.keys(t[0]||{});return a("div",{style:{overflowX:"auto"},children:a("table",{className:"dashboard-table",style:{width:"100%",borderCollapse:"collapse",fontSize:"14px"},children:[a("thead",{children:a("tr",{children:e.map(n=>a("th",{style:{borderBottom:"2px solid #ddd",padding:"12px",textAlign:"left",fontWeight:600},children:n},n))})}),a("tbody",{children:t.map((n,r)=>a("tr",{style:{borderBottom:"1px solid #eee"},children:e.map(i=>a("td",{style:{padding:"10px"},children:String(n[i])},i))},r))})]})})}function Ci({content:t}){const e=wi(t),n=Kt.sanitize(e,{ALLOWED_TAGS:["h1","h2","h3","h4","h5","h6","p","br","strong","em","code","pre","a","ul","ol","li"],ALLOWED_ATTR:["href"],ALLOW_DATA_ATTR:!1});return a("div",{className:"markdown-content",dangerouslySetInnerHTML:{__html:n}})}function wi(t){let e=t;return e=e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;"),e=e.replace(/^### (.*$)/gim,"<h3>$1</h3>"),e=e.replace(/^## (.*$)/gim,"<h2>$1</h2>"),e=e.replace(/^# (.*$)/gim,"<h1>$1</h1>"),e=e.replace(/\*\*(.*?)\*\*/g,"<strong>$1</strong>"),e=e.replace(/\*(.*?)\*/g,"<em>$1</em>"),e=e.replace(/`(.*?)`/g,"<code>$1</code>"),e=e.replace(/\[(.*?)\]\((.*?)\)/g,'<a href="$2">$1</a>'),e=e.replace(/```(.*?)\n([\s\S]*?)```/g,"<pre><code>$2</code></pre>"),e=e.replace(/^\- (.*$)/gim,"<li>$1</li>"),e=e.replace(/(<li>.*<\/li>)/s,"<ul>$1</ul>"),e=e.replace(/^\d+\. (.*$)/gim,"<li>$1</li>"),e=e.split(`

`).map(r=>r.startsWith("<h")||r.startsWith("<ul>")||r.startsWith("<ol>")||r.startsWith("<pre>")||r.startsWith("<li>")?r:`<p>${r}</p>`).join(`
`),e=e.replace(/\n/g,"<br>"),e}function Li({context:t}){const[e,n]=N("/");K(()=>{const i=()=>{const s=window.location.hash.slice(1);n(s||"/")};return window.addEventListener("hashchange",i),i(),()=>window.removeEventListener("hashchange",i)},[]);const r=t.pages.find(i=>i.slug===e)||t.pages[0];return r?a(Ai,{page:r,context:t}):t.dashboards.length>0?a(ua,{config:t.config,children:a(pa,{dashboards:t.dashboards})}):a(ha,{config:t.config,title:"404 Not Found",children:[a("p",{children:["Page not found: ",e]}),a("p",{children:a("a",{href:"#/",children:"Go home"})})]})}function Ai({page:t,context:e}){const n=t.layout||"simple",r=t.content?a(Ci,{content:t.content}):a("p",{children:"No content"});switch(n){case"landing":return a(ai,{config:e.config,children:r});case"docs":return a(ri,{config:e.config,navigation:e.navigation,currentPage:t,children:r});case"dashboard":return a(ua,{config:e.config,children:[r,e.dashboards.length>0&&a(pa,{dashboards:e.dashboards})]});case"simple":default:return a(ha,{config:e.config,title:t.title,children:r})}}const Ri={mode:"website",bundledCapsule:"/memglyph-demo.mgx.sqlite",branding:{title:"Memglyph",tagline:"Your knowledge, crystallized",logoUrl:"/logo.svg"},features:{llm:{enabled:!0,autoReason:!1,defaultModel:"qwen3-0.6b",maxTokens:256},search:{defaultMode:"hybrid",enabledModes:["fts","hybrid"],showModeToggle:!1},graph:{enabled:!0,maxHops:2,defaultMaxHops:1},upload:{enabled:!1,acceptedExtensions:[]},gcui:{enabled:!0,fallbackToGeneric:!1},pwa:{enabled:!0,offlineMode:!0}},ui:{showLanding:!0,theme:"documentation"}},ki={mode:"viewer",bundledCapsule:"/memglyph-demo.mgx.sqlite",branding:{title:"SQLAR Viewer",tagline:"Query your knowledge capsules",logoUrl:"/sqlar-logo.svg"},features:{llm:{enabled:!0,autoReason:!1,defaultModel:"qwen3-0.6b",maxTokens:256},search:{defaultMode:"hybrid",enabledModes:["fts","hybrid","graph"],showModeToggle:!0},graph:{enabled:!0,maxHops:3,defaultMaxHops:2},upload:{enabled:!0,acceptedExtensions:[".sqlite",".sqlar",".db",".mgx.sqlite"]},gcui:{enabled:!0,fallbackToGeneric:!0},pwa:{enabled:!0,offlineMode:!0}},ui:{showLanding:!1,theme:"tool"}};function Oi(){return"website"}function xi(){return Oi()==="viewer"?ki:Ri}function Mi(){const t=xi(),[e,n]=N(null),[r,i]=N(null),[s,l]=N(!1),[h,p]=N(null),[d,m]=N(!1);ra({defaultMode:t.features.search.defaultMode});const o=ca({autoLoad:!1});return da({}),K(()=>{e&&(o.loadEntities(),(async()=>{try{const y=oe(),g=await gi(y);console.log("[GCUI] Detected capabilities:",g.capabilities),g.capabilities.mode!=="generic"?(i(g),console.log("[GCUI] Rendering in",g.capabilities.mode,"mode")):(console.log("[GCUI] No GCUI tables found, using legacy mode"),i(null))}catch(y){console.warn("[GCUI] Detection failed, using legacy mode:",y),i(null)}})())},[e]),a("div",{className:"app",children:[a("header",{className:"app-header",children:[a("h1",{children:"GlyphCase Explorer"}),a("p",{children:"Hybrid Retrieval + Dynamic Memory for MemGlyph"})]}),a("main",{className:"app-main",children:e?r&&t.features.gcui.enabled?a("div",{className:"gcui-mode",children:a(Li,{context:r})}):a(ci,{capsuleInfo:e,onClose:()=>n(null)}):a("div",{className:"welcome",children:[h&&a("div",{className:"error",style:"max-width: 600px; margin: 1rem auto;",children:[a("strong",{children:"Error:"})," ",h]}),a(Pr,{onFileSelected:async(v,y)=>{l(!0),p(null);try{const T=await oe().openFromFile(v);n(T),console.log("Capsule opened:",T)}catch(g){p(String(g)),console.error("Failed to open file:",g)}finally{l(!1)}},onOpfsFileSelected:async v=>{l(!0),p(null);try{const g=await oe().openFromOpfs(v);n(g),console.log("Capsule opened from OPFS:",g)}catch(y){p(String(y)),console.error("Failed to open from OPFS:",y)}finally{l(!1)}},onError:v=>{p(v)}}),a("div",{style:"text-align: center; margin-top: 1.5rem;",children:[a("p",{style:"margin-bottom: 0.5rem; opacity: 0.7;",children:"Or try the demo:"}),a("button",{className:"btn-secondary",onClick:async()=>{l(!0),p(null);try{const y=await oe().openDemo();n(y),console.log("Capsule info:",y)}catch(v){p(String(v)),console.error("Failed to open capsule:",v)}finally{l(!1)}},disabled:s,children:s?"Loading Demo...":"Load Demo Capsule"})]})]})}),a("footer",{className:"app-footer",children:a("p",{children:"Built with Preact + SQLite WASM + OPFS"})})]})}ka(a(Mi,{}),document.getElementById("app"));
