var Jr=Object.defineProperty;var Kr=(t,e,n)=>e in t?Jr(t,e,{enumerable:!0,configurable:!0,writable:!0,value:n}):t[e]=n;var A=(t,e,n)=>Kr(t,typeof e!="symbol"?e+"":e,n);(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const a of document.querySelectorAll('link[rel="modulepreload"]'))i(a);new MutationObserver(a=>{for(const o of a)if(o.type==="childList")for(const s of o.addedNodes)s.tagName==="LINK"&&s.rel==="modulepreload"&&i(s)}).observe(document,{childList:!0,subtree:!0});function n(a){const o={};return a.integrity&&(o.integrity=a.integrity),a.referrerPolicy&&(o.referrerPolicy=a.referrerPolicy),a.crossOrigin==="use-credentials"?o.credentials="include":a.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function i(a){if(a.ep)return;a.ep=!0;const o=n(a);fetch(a.href,o)}})();var Ct,D,pr,Ae,Hn,fr,mr,gr,hn,en,tn,nt={},yr=[],Zr=/acit|ex(?:s|g|n|p|$)|rph|grid|ows|mnc|ntw|ine[ch]|zoo|^ord|itera/i,Lt=Array.isArray;function ve(t,e){for(var n in e)t[n]=e[n];return t}function pn(t){t&&t.parentNode&&t.parentNode.removeChild(t)}function ei(t,e,n){var i,a,o,s={};for(o in e)o=="key"?i=e[o]:o=="ref"?a=e[o]:s[o]=e[o];if(arguments.length>2&&(s.children=arguments.length>3?Ct.call(arguments,2):n),typeof t=="function"&&t.defaultProps!=null)for(o in t.defaultProps)s[o]===void 0&&(s[o]=t.defaultProps[o]);return _t(t,s,i,a,null)}function _t(t,e,n,i,a){var o={type:t,props:e,key:n,ref:i,__k:null,__:null,__b:0,__e:null,__c:null,constructor:void 0,__v:a??++pr,__i:-1,__u:0};return a==null&&D.vnode!=null&&D.vnode(o),o}function oe(t){return t.children}function Je(t,e){this.props=t,this.context=e}function qe(t,e){if(e==null)return t.__?qe(t.__,t.__i+1):null;for(var n;e<t.__k.length;e++)if((n=t.__k[e])!=null&&n.__e!=null)return n.__e;return typeof t.type=="function"?qe(t):null}function _r(t){var e,n;if((t=t.__)!=null&&t.__c!=null){for(t.__e=t.__c.base=null,e=0;e<t.__k.length;e++)if((n=t.__k[e])!=null&&n.__e!=null){t.__e=t.__c.base=n.__e;break}return _r(t)}}function qn(t){(!t.__d&&(t.__d=!0)&&Ae.push(t)&&!bt.__r++||Hn!=D.debounceRendering)&&((Hn=D.debounceRendering)||fr)(bt)}function bt(){for(var t,e,n,i,a,o,s,l=1;Ae.length;)Ae.length>l&&Ae.sort(mr),t=Ae.shift(),l=Ae.length,t.__d&&(n=void 0,i=void 0,a=(i=(e=t).__v).__e,o=[],s=[],e.__P&&((n=ve({},i)).__v=i.__v+1,D.vnode&&D.vnode(n),fn(e.__P,n,i,e.__n,e.__P.namespaceURI,32&i.__u?[a]:null,o,a??qe(i),!!(32&i.__u),s),n.__v=i.__v,n.__.__k[n.__i]=n,br(o,n,s),i.__e=i.__=null,n.__e!=a&&_r(n)));bt.__r=0}function vr(t,e,n,i,a,o,s,l,u,c,f){var d,p,m,g,E,v,_,y=i&&i.__k||yr,T=e.length;for(u=ti(n,e,y,u,T),d=0;d<T;d++)(m=n.__k[d])!=null&&(p=m.__i==-1?nt:y[m.__i]||nt,m.__i=d,v=fn(t,m,p,a,o,s,l,u,c,f),g=m.__e,m.ref&&p.ref!=m.ref&&(p.ref&&mn(p.ref,null,m),f.push(m.ref,m.__c||g,m)),E==null&&g!=null&&(E=g),(_=!!(4&m.__u))||p.__k===m.__k?u=Er(m,u,t,_):typeof m.type=="function"&&v!==void 0?u=v:g&&(u=g.nextSibling),m.__u&=-7);return n.__e=E,u}function ti(t,e,n,i,a){var o,s,l,u,c,f=n.length,d=f,p=0;for(t.__k=new Array(a),o=0;o<a;o++)(s=e[o])!=null&&typeof s!="boolean"&&typeof s!="function"?(u=o+p,(s=t.__k[o]=typeof s=="string"||typeof s=="number"||typeof s=="bigint"||s.constructor==String?_t(null,s,null,null,null):Lt(s)?_t(oe,{children:s},null,null,null):s.constructor==null&&s.__b>0?_t(s.type,s.props,s.key,s.ref?s.ref:null,s.__v):s).__=t,s.__b=t.__b+1,l=null,(c=s.__i=ni(s,n,u,d))!=-1&&(d--,(l=n[c])&&(l.__u|=2)),l==null||l.__v==null?(c==-1&&(a>f?p--:a<f&&p++),typeof s.type!="function"&&(s.__u|=4)):c!=u&&(c==u-1?p--:c==u+1?p++:(c>u?p--:p++,s.__u|=4))):t.__k[o]=null;if(d)for(o=0;o<f;o++)(l=n[o])!=null&&!(2&l.__u)&&(l.__e==i&&(i=qe(l)),Nr(l,l));return i}function Er(t,e,n,i){var a,o;if(typeof t.type=="function"){for(a=t.__k,o=0;a&&o<a.length;o++)a[o]&&(a[o].__=t,e=Er(a[o],e,n,i));return e}t.__e!=e&&(i&&(e&&t.type&&!e.parentNode&&(e=qe(t)),n.insertBefore(t.__e,e||null)),e=t.__e);do e=e&&e.nextSibling;while(e!=null&&e.nodeType==8);return e}function ni(t,e,n,i){var a,o,s,l=t.key,u=t.type,c=e[n],f=c!=null&&(2&c.__u)==0;if(c===null&&t.key==null||f&&l==c.key&&u==c.type)return n;if(i>(f?1:0)){for(a=n-1,o=n+1;a>=0||o<e.length;)if((c=e[s=a>=0?a--:o++])!=null&&!(2&c.__u)&&l==c.key&&u==c.type)return s}return-1}function Gn(t,e,n){e[0]=="-"?t.setProperty(e,n??""):t[e]=n==null?"":typeof n!="number"||Zr.test(e)?n:n+"px"}function ut(t,e,n,i,a){var o,s;e:if(e=="style")if(typeof n=="string")t.style.cssText=n;else{if(typeof i=="string"&&(t.style.cssText=i=""),i)for(e in i)n&&e in n||Gn(t.style,e,"");if(n)for(e in n)i&&n[e]==i[e]||Gn(t.style,e,n[e])}else if(e[0]=="o"&&e[1]=="n")o=e!=(e=e.replace(gr,"$1")),s=e.toLowerCase(),e=s in t||e=="onFocusOut"||e=="onFocusIn"?s.slice(2):e.slice(2),t.l||(t.l={}),t.l[e+o]=n,n?i?n.u=i.u:(n.u=hn,t.addEventListener(e,o?tn:en,o)):t.removeEventListener(e,o?tn:en,o);else{if(a=="http://www.w3.org/2000/svg")e=e.replace(/xlink(H|:h)/,"h").replace(/sName$/,"s");else if(e!="width"&&e!="height"&&e!="href"&&e!="list"&&e!="form"&&e!="tabIndex"&&e!="download"&&e!="rowSpan"&&e!="colSpan"&&e!="role"&&e!="popover"&&e in t)try{t[e]=n??"";break e}catch{}typeof n=="function"||(n==null||n===!1&&e[4]!="-"?t.removeAttribute(e):t.setAttribute(e,e=="popover"&&n==1?"":n))}}function Bn(t){return function(e){if(this.l){var n=this.l[e.type+t];if(e.t==null)e.t=hn++;else if(e.t<n.u)return;return n(D.event?D.event(e):e)}}}function fn(t,e,n,i,a,o,s,l,u,c){var f,d,p,m,g,E,v,_,y,T,S,L,R,B,q,I,he,M=e.type;if(e.constructor!=null)return null;128&n.__u&&(u=!!(32&n.__u),o=[l=e.__e=n.__e]),(f=D.__b)&&f(e);e:if(typeof M=="function")try{if(_=e.props,y="prototype"in M&&M.prototype.render,T=(f=M.contextType)&&i[f.__c],S=f?T?T.props.value:f.__:i,n.__c?v=(d=e.__c=n.__c).__=d.__E:(y?e.__c=d=new M(_,S):(e.__c=d=new Je(_,S),d.constructor=M,d.render=ii),T&&T.sub(d),d.props=_,d.state||(d.state={}),d.context=S,d.__n=i,p=d.__d=!0,d.__h=[],d._sb=[]),y&&d.__s==null&&(d.__s=d.state),y&&M.getDerivedStateFromProps!=null&&(d.__s==d.state&&(d.__s=ve({},d.__s)),ve(d.__s,M.getDerivedStateFromProps(_,d.__s))),m=d.props,g=d.state,d.__v=e,p)y&&M.getDerivedStateFromProps==null&&d.componentWillMount!=null&&d.componentWillMount(),y&&d.componentDidMount!=null&&d.__h.push(d.componentDidMount);else{if(y&&M.getDerivedStateFromProps==null&&_!==m&&d.componentWillReceiveProps!=null&&d.componentWillReceiveProps(_,S),!d.__e&&d.shouldComponentUpdate!=null&&d.shouldComponentUpdate(_,d.__s,S)===!1||e.__v==n.__v){for(e.__v!=n.__v&&(d.props=_,d.state=d.__s,d.__d=!1),e.__e=n.__e,e.__k=n.__k,e.__k.some(function(re){re&&(re.__=e)}),L=0;L<d._sb.length;L++)d.__h.push(d._sb[L]);d._sb=[],d.__h.length&&s.push(d);break e}d.componentWillUpdate!=null&&d.componentWillUpdate(_,d.__s,S),y&&d.componentDidUpdate!=null&&d.__h.push(function(){d.componentDidUpdate(m,g,E)})}if(d.context=S,d.props=_,d.__P=t,d.__e=!1,R=D.__r,B=0,y){for(d.state=d.__s,d.__d=!1,R&&R(e),f=d.render(d.props,d.state,d.context),q=0;q<d._sb.length;q++)d.__h.push(d._sb[q]);d._sb=[]}else do d.__d=!1,R&&R(e),f=d.render(d.props,d.state,d.context),d.state=d.__s;while(d.__d&&++B<25);d.state=d.__s,d.getChildContext!=null&&(i=ve(ve({},i),d.getChildContext())),y&&!p&&d.getSnapshotBeforeUpdate!=null&&(E=d.getSnapshotBeforeUpdate(m,g)),I=f,f!=null&&f.type===oe&&f.key==null&&(I=Tr(f.props.children)),l=vr(t,Lt(I)?I:[I],e,n,i,a,o,s,l,u,c),d.base=e.__e,e.__u&=-161,d.__h.length&&s.push(d),v&&(d.__E=d.__=null)}catch(re){if(e.__v=null,u||o!=null)if(re.then){for(e.__u|=u?160:128;l&&l.nodeType==8&&l.nextSibling;)l=l.nextSibling;o[o.indexOf(l)]=null,e.__e=l}else{for(he=o.length;he--;)pn(o[he]);nn(e)}else e.__e=n.__e,e.__k=n.__k,re.then||nn(e);D.__e(re,e,n)}else o==null&&e.__v==n.__v?(e.__k=n.__k,e.__e=n.__e):l=e.__e=ri(n.__e,e,n,i,a,o,s,u,c);return(f=D.diffed)&&f(e),128&e.__u?void 0:l}function nn(t){t&&t.__c&&(t.__c.__e=!0),t&&t.__k&&t.__k.forEach(nn)}function br(t,e,n){for(var i=0;i<n.length;i++)mn(n[i],n[++i],n[++i]);D.__c&&D.__c(e,t),t.some(function(a){try{t=a.__h,a.__h=[],t.some(function(o){o.call(a)})}catch(o){D.__e(o,a.__v)}})}function Tr(t){return typeof t!="object"||t==null||t.__b&&t.__b>0?t:Lt(t)?t.map(Tr):ve({},t)}function ri(t,e,n,i,a,o,s,l,u){var c,f,d,p,m,g,E,v=n.props,_=e.props,y=e.type;if(y=="svg"?a="http://www.w3.org/2000/svg":y=="math"?a="http://www.w3.org/1998/Math/MathML":a||(a="http://www.w3.org/1999/xhtml"),o!=null){for(c=0;c<o.length;c++)if((m=o[c])&&"setAttribute"in m==!!y&&(y?m.localName==y:m.nodeType==3)){t=m,o[c]=null;break}}if(t==null){if(y==null)return document.createTextNode(_);t=document.createElementNS(a,y,_.is&&_),l&&(D.__m&&D.__m(e,o),l=!1),o=null}if(y==null)v===_||l&&t.data==_||(t.data=_);else{if(o=o&&Ct.call(t.childNodes),v=n.props||nt,!l&&o!=null)for(v={},c=0;c<t.attributes.length;c++)v[(m=t.attributes[c]).name]=m.value;for(c in v)if(m=v[c],c!="children"){if(c=="dangerouslySetInnerHTML")d=m;else if(!(c in _)){if(c=="value"&&"defaultValue"in _||c=="checked"&&"defaultChecked"in _)continue;ut(t,c,null,m,a)}}for(c in _)m=_[c],c=="children"?p=m:c=="dangerouslySetInnerHTML"?f=m:c=="value"?g=m:c=="checked"?E=m:l&&typeof m!="function"||v[c]===m||ut(t,c,m,v[c],a);if(f)l||d&&(f.__html==d.__html||f.__html==t.innerHTML)||(t.innerHTML=f.__html),e.__k=[];else if(d&&(t.innerHTML=""),vr(e.type=="template"?t.content:t,Lt(p)?p:[p],e,n,i,y=="foreignObject"?"http://www.w3.org/1999/xhtml":a,o,s,o?o[0]:n.__k&&qe(n,0),l,u),o!=null)for(c=o.length;c--;)pn(o[c]);l||(c="value",y=="progress"&&g==null?t.removeAttribute("value"):g!=null&&(g!==t[c]||y=="progress"&&!g||y=="option"&&g!=v[c])&&ut(t,c,g,v[c],a),c="checked",E!=null&&E!=t[c]&&ut(t,c,E,v[c],a))}return t}function mn(t,e,n){try{if(typeof t=="function"){var i=typeof t.__u=="function";i&&t.__u(),i&&e==null||(t.__u=t(e))}else t.current=e}catch(a){D.__e(a,n)}}function Nr(t,e,n){var i,a;if(D.unmount&&D.unmount(t),(i=t.ref)&&(i.current&&i.current!=t.__e||mn(i,null,e)),(i=t.__c)!=null){if(i.componentWillUnmount)try{i.componentWillUnmount()}catch(o){D.__e(o,e)}i.base=i.__P=null}if(i=t.__k)for(a=0;a<i.length;a++)i[a]&&Nr(i[a],e,n||typeof t.type!="function");n||pn(t.__e),t.__c=t.__=t.__e=void 0}function ii(t,e,n){return this.constructor(t,n)}function ai(t,e,n){var i,a,o,s;e==document&&(e=document.documentElement),D.__&&D.__(t,e),a=(i=!1)?null:e.__k,o=[],s=[],fn(e,t=e.__k=ei(oe,null,[t]),a||nt,nt,e.namespaceURI,a?null:e.firstChild?Ct.call(e.childNodes):null,o,a?a.__e:e.firstChild,i,s),br(o,t,s)}Ct=yr.slice,D={__e:function(t,e,n,i){for(var a,o,s;e=e.__;)if((a=e.__c)&&!a.__)try{if((o=a.constructor)&&o.getDerivedStateFromError!=null&&(a.setState(o.getDerivedStateFromError(t)),s=a.__d),a.componentDidCatch!=null&&(a.componentDidCatch(t,i||{}),s=a.__d),s)return a.__E=a}catch(l){t=l}throw t}},pr=0,Je.prototype.setState=function(t,e){var n;n=this.__s!=null&&this.__s!=this.state?this.__s:this.__s=ve({},this.state),typeof t=="function"&&(t=t(ve({},n),this.props)),t&&ve(n,t),t!=null&&this.__v&&(e&&this._sb.push(e),qn(this))},Je.prototype.forceUpdate=function(t){this.__v&&(this.__e=!0,t&&this.__h.push(t),qn(this))},Je.prototype.render=oe,Ae=[],fr=typeof Promise=="function"?Promise.prototype.then.bind(Promise.resolve()):setTimeout,mr=function(t,e){return t.__v.__b-e.__v.__b},bt.__r=0,gr=/(PointerCapture)$|Capture$/i,hn=0,en=Bn(!1),tn=Bn(!0);var si=0;function r(t,e,n,i,a,o){e||(e={});var s,l,u=e;if("ref"in u)for(l in u={},e)l=="ref"?s=e[l]:u[l]=e[l];var c={type:t,props:u,key:n,ref:s,__k:null,__:null,__b:0,__e:null,__c:null,constructor:void 0,__v:--si,__i:-1,__u:0,__source:a,__self:o};if(typeof t=="function"&&(s=t.defaultProps))for(l in s)u[l]===void 0&&(u[l]=s[l]);return D.vnode&&D.vnode(c),c}var rt,z,Ut,zn,Tt=0,Sr=[],V=D,Wn=V.__b,Xn=V.__r,Vn=V.diffed,Yn=V.__c,Qn=V.unmount,jn=V.__;function gn(t,e){V.__h&&V.__h(z,t,Tt||e),Tt=0;var n=z.__H||(z.__H={__:[],__h:[]});return t>=n.__.length&&n.__.push({}),n.__[t]}function N(t){return Tt=1,oi(Cr,t)}function oi(t,e,n){var i=gn(rt++,2);if(i.t=t,!i.__c&&(i.__=[Cr(void 0,e),function(l){var u=i.__N?i.__N[0]:i.__[0],c=i.t(u,l);u!==c&&(i.__N=[c,i.__[1]],i.__c.setState({}))}],i.__c=z,!z.__f)){var a=function(l,u,c){if(!i.__c.__H)return!0;var f=i.__c.__H.__.filter(function(p){return!!p.__c});if(f.every(function(p){return!p.__N}))return!o||o.call(this,l,u,c);var d=i.__c.props!==l;return f.forEach(function(p){if(p.__N){var m=p.__[0];p.__=p.__N,p.__N=void 0,m!==p.__[0]&&(d=!0)}}),o&&o.call(this,l,u,c)||d};z.__f=!0;var o=z.shouldComponentUpdate,s=z.componentWillUpdate;z.componentWillUpdate=function(l,u,c){if(this.__e){var f=o;o=void 0,a(l,u,c),o=f}s&&s.call(this,l,u,c)},z.shouldComponentUpdate=a}return i.__N||i.__}function j(t,e){var n=gn(rt++,3);!V.__s&&wr(n.__H,e)&&(n.__=t,n.u=e,z.__H.__h.push(n))}function Ke(t){return Tt=5,li(function(){return{current:t}},[])}function li(t,e){var n=gn(rt++,7);return wr(n.__H,e)&&(n.__=t(),n.__H=e,n.__h=t),n.__}function ci(){for(var t;t=Sr.shift();)if(t.__P&&t.__H)try{t.__H.__h.forEach(vt),t.__H.__h.forEach(rn),t.__H.__h=[]}catch(e){t.__H.__h=[],V.__e(e,t.__v)}}V.__b=function(t){z=null,Wn&&Wn(t)},V.__=function(t,e){t&&e.__k&&e.__k.__m&&(t.__m=e.__k.__m),jn&&jn(t,e)},V.__r=function(t){Xn&&Xn(t),rt=0;var e=(z=t.__c).__H;e&&(Ut===z?(e.__h=[],z.__h=[],e.__.forEach(function(n){n.__N&&(n.__=n.__N),n.u=n.__N=void 0})):(e.__h.forEach(vt),e.__h.forEach(rn),e.__h=[],rt=0)),Ut=z},V.diffed=function(t){Vn&&Vn(t);var e=t.__c;e&&e.__H&&(e.__H.__h.length&&(Sr.push(e)!==1&&zn===V.requestAnimationFrame||((zn=V.requestAnimationFrame)||di)(ci)),e.__H.__.forEach(function(n){n.u&&(n.__H=n.u),n.u=void 0})),Ut=z=null},V.__c=function(t,e){e.some(function(n){try{n.__h.forEach(vt),n.__h=n.__h.filter(function(i){return!i.__||rn(i)})}catch(i){e.some(function(a){a.__h&&(a.__h=[])}),e=[],V.__e(i,n.__v)}}),Yn&&Yn(t,e)},V.unmount=function(t){Qn&&Qn(t);var e,n=t.__c;n&&n.__H&&(n.__H.__.forEach(function(i){try{vt(i)}catch(a){e=a}}),n.__H=void 0,e&&V.__e(e,n.__v))};var Jn=typeof requestAnimationFrame=="function";function di(t){var e,n=function(){clearTimeout(i),Jn&&cancelAnimationFrame(e),setTimeout(t)},i=setTimeout(n,35);Jn&&(e=requestAnimationFrame(n))}function vt(t){var e=z,n=t.__c;typeof n=="function"&&(t.__c=void 0,n()),z=e}function rn(t){var e=z;t.__c=t.__(),z=e}function wr(t,e){return!t||t.length!==e.length||e.some(function(n,i){return n!==t[i]})}function Cr(t,e){return typeof e=="function"?e(t):e}const ui={maxQueueSize:50,defaultTimeout:1e4,maxTimeout:3e4};class hi{constructor(e={}){A(this,"queue",[]);A(this,"processing",!1);A(this,"nextId",1);A(this,"config");A(this,"stats",{totalProcessed:0,totalTimeouts:0,totalErrors:0});this.config={...ui,...e}}async enqueue(e,n){if(this.queue.length>=this.config.maxQueueSize)throw new Error(`Query queue full (${this.config.maxQueueSize} items). Too many pending queries.`);const i=Math.min(n||this.config.defaultTimeout,this.config.maxTimeout);return new Promise((a,o)=>{const s={id:this.nextId++,execute:e,resolve:a,reject:o,timeout:i,enqueuedAt:Date.now()};this.queue.push(s),this.processing||this.processQueue()})}async processQueue(){if(!(this.processing||this.queue.length===0)){for(this.processing=!0;this.queue.length>0;){const e=this.queue.shift();try{await this.executeWithTimeout(e)}catch{}}this.processing=!1}}async executeWithTimeout(e){const n=new Promise((i,a)=>{setTimeout(()=>{a(new Error(`Query ${e.id} timed out after ${e.timeout}ms`))},e.timeout)});try{const i=await Promise.race([e.execute(),n]);this.stats.totalProcessed++,e.resolve(i)}catch(i){i instanceof Error&&i.message.includes("timed out")?(this.stats.totalTimeouts++,console.warn(`[QueryQueue] Query ${e.id} timed out`,{timeout:e.timeout,waitTime:Date.now()-e.enqueuedAt})):this.stats.totalErrors++,e.reject(i)}}getStats(){return{queueLength:this.queue.length,busy:this.processing,totalProcessed:this.stats.totalProcessed,totalTimeouts:this.stats.totalTimeouts,totalErrors:this.stats.totalErrors}}isBusy(){return this.processing||this.queue.length>0}clear(){const e=new Error("Query queue cleared");for(const n of this.queue)n.reject(e);this.queue=[]}get length(){return this.queue.length}}let Ht=null;function an(t){return Ht||(Ht=new hi(t)),Ht}function pi(t,e){return an().enqueue(t,e)}class Lr{constructor(){A(this,"worker",null);A(this,"nextId",1);A(this,"pending",new Map);this.initWorker()}initWorker(){this.worker=new Worker(new URL("/assets/sqlite.worker-CxyBnLSe.js",import.meta.url),{type:"module"}),this.worker.onmessage=e=>{const n=e.data;if("type"in n&&n.type==="READY"){console.log("[DbClient] Worker ready");return}const{id:i,response:a}=n,o=this.pending.get(i);o&&(this.pending.delete(i),o.resolve(a))},this.worker.onerror=e=>{console.error("[DbClient] Worker error:",e);for(const n of this.pending.values())n.reject(new Error("Worker error"));this.pending.clear()}}async sendRequest(e,n=1e4){if(!this.worker)throw new Error("Worker not initialized");const i=this.nextId++;return pi(async()=>new Promise((a,o)=>{const s=setTimeout(()=>{this.pending.delete(i),o(new Error(`Request ${e.type} timed out after ${n}ms`))},n);this.pending.set(i,{resolve:u=>{clearTimeout(s),u.ok?a(u.data):o(new Error(u.error))},reject:u=>{clearTimeout(s),o(u)},timeout:s});const l={id:i,request:e};this.worker.postMessage(l)}),n)}async openFromFile(e){return this.sendRequest({type:"OPEN_FROM_FILE",file:e})}async openFromOpfs(e){return this.sendRequest({type:"OPEN_FROM_OPFS",path:e})}async openDemo(){return this.sendRequest({type:"OPEN_DEMO"})}async saveToOpfs(e){return this.sendRequest({type:"SAVE_TO_OPFS",path:e})}async removeFromOpfs(e){return this.sendRequest({type:"REMOVE_FROM_OPFS",path:e})}async listOpfsFiles(){return this.sendRequest({type:"LIST_OPFS_FILES"})}async close(){return this.sendRequest({type:"CLOSE"})}async searchFts(e,n=20,i,a){return this.sendRequest({type:"FTS_SEARCH",query:e,limit:n,entityType:i,entityValue:a})}async searchHybrid(e,n=20,i){return this.sendRequest({type:"HYBRID_SEARCH",query:e,limit:n,weights:i})}async listEntities(e,n=100){return this.sendRequest({type:"LIST_ENTITIES",entityType:e,limit:n})}async getPageList(e=100,n=0){return this.sendRequest({type:"GET_PAGE_LIST",limit:e,offset:n})}async getPageBlob(e){return this.sendRequest({type:"GET_PAGE_BLOB",name:e})}async verifyPage(e){return this.sendRequest({type:"VERIFY_PAGE",gid:e})}async getCheckpoints(){return this.sendRequest({type:"GET_CHECKPOINTS"})}async graphHops(e,n,i,a){return this.sendRequest({type:"GRAPH_HOPS",seedGid:e,predicate:n,maxHops:i,limit:a})}async query(e,n=[]){return this.sendRequest({type:"QUERY",sql:e,params:n})}async exportDatabase(){return this.sendRequest({type:"EXPORT_DATABASE"})}async hasEnvelopeTables(e){return this.sendRequest({type:"HAS_ENVELOPE_TABLES",fileBytes:e})}async extractEnvelope(e){return this.sendRequest({type:"EXTRACT_ENVELOPE",file:e})}async mergeWithEnvelope(e){return this.sendRequest({type:"MERGE_ENVELOPE",file:e})}getQueueStats(){return an().getStats()}isQueueBusy(){return an().isBusy()}terminate(){this.worker&&(this.worker.terminate(),this.worker=null);for(const e of this.pending.values())clearTimeout(e.timeout),e.reject(new Error("Worker terminated"));this.pending.clear()}}let qt=null;function le(){return qt||(qt=new Lr),qt}class fi{constructor(){A(this,"bus",new EventTarget);A(this,"topics",new Set);A(this,"eventLog",[]);A(this,"maxLogSize",100)}publish(e,n){this.topics.add(e);const i={topic:e,data:n,timestamp:Date.now()};this.bus.dispatchEvent(new CustomEvent(e,{detail:i}))}subscribe(e,n){const i=a=>{const o=a;n(o.detail.data,o.detail)};return this.bus.addEventListener(e,i),()=>{this.bus.removeEventListener(e,i)}}subscribeMany(e,n){const i=e.map(a=>this.subscribe(a,(o,s)=>n(a,o,s)));return()=>{i.forEach(a=>a())}}getActiveTopics(){return Array.from(this.topics)}getRecentEvents(e){return[]}clearEventLog(){this.eventLog=[]}getStats(){const e={};return{activeTopics:this.topics.size,eventLogSize:this.eventLog.length,topicCounts:e}}}const ce=new fi,mi=t=>ce.publish("retrieval.query",t),gi=t=>ce.publish("retrieval.result",t),yi=t=>ce.publish("llm.prompt",t),_i=t=>ce.publish("llm.output",t),vi=t=>ce.publish("llm.citation",t),Ei=t=>ce.publish("feedback.signal",t),Kn=t=>ce.publish("capsule.loaded",t),bi=()=>ce.publish("capsule.unloaded",{}),Ti=`-- GlyphCase Envelope Schema v1.1
-- Append-only episodic memory layer for Dynamic GlyphCases
-- This schema represents the mutable, hash-chained memory buffer
-- that sits alongside the immutable Core.

-- ============================================================================
-- METADATA
-- ============================================================================

-- Envelope metadata and configuration
CREATE TABLE IF NOT EXISTS _envelope_meta (
  key TEXT PRIMARY KEY,
  value TEXT NOT NULL
) STRICT;

-- Core metadata values:
-- 'gcase_id' - SHA256 hash of the Core capsule this envelope is linked to
-- 'created_at' - ISO8601 timestamp of envelope creation
-- 'format_version' - Envelope schema version (1.1)
-- 'last_hash' - Most recent hash in the chain

-- ============================================================================
-- HASH CHAIN (Merkle Integrity)
-- ============================================================================

-- Hash chain for append-only integrity verification
-- Each block represents a batch of appends with a Merkle root
CREATE TABLE IF NOT EXISTS _env_chain (
  seq INTEGER PRIMARY KEY AUTOINCREMENT,
  block_hash TEXT NOT NULL UNIQUE,
  parent_hash TEXT NOT NULL,
  block_type TEXT NOT NULL, -- 'retrieval' | 'embedding' | 'feedback' | 'summary' | 'log'
  row_count INTEGER NOT NULL DEFAULT 1,
  created_at TEXT NOT NULL DEFAULT (datetime('now'))
) STRICT;

CREATE INDEX IF NOT EXISTS idx_chain_block_type ON _env_chain(block_type);
CREATE INDEX IF NOT EXISTS idx_chain_created_at ON _env_chain(created_at);

-- ============================================================================
-- RETRIEVAL LOGS
-- ============================================================================

-- Logs every search/retrieval operation performed
-- Enables learning from query patterns and improving relevance
CREATE TABLE IF NOT EXISTS env_retrieval_log (
  id TEXT PRIMARY KEY,
  seq INTEGER NOT NULL REFERENCES _env_chain(seq),
  ts TEXT NOT NULL DEFAULT (datetime('now')),
  query_text TEXT NOT NULL,
  query_type TEXT NOT NULL CHECK(query_type IN ('fts', 'vector', 'hybrid', 'graph')),
  top_docs TEXT, -- JSON array of {gid, score, snippet}
  hit_count INTEGER NOT NULL DEFAULT 0,
  parent_hash TEXT NOT NULL
) STRICT;

CREATE INDEX IF NOT EXISTS idx_retrieval_ts ON env_retrieval_log(ts);
CREATE INDEX IF NOT EXISTS idx_retrieval_type ON env_retrieval_log(query_type);
CREATE INDEX IF NOT EXISTS idx_retrieval_query ON env_retrieval_log(query_text);

-- ============================================================================
-- CONTEXTUAL EMBEDDINGS
-- ============================================================================

-- Runtime-generated embeddings for queries, responses, and context
-- Provides adaptive semantic memory beyond the canonical Core vectors
CREATE TABLE IF NOT EXISTS env_embeddings (
  id TEXT PRIMARY KEY,
  seq INTEGER NOT NULL REFERENCES _env_chain(seq),
  source TEXT NOT NULL, -- 'user_query' | 'llm_response' | 'context_window' | 'feedback_cluster'
  vector BLOB NOT NULL,
  metadata TEXT, -- JSON metadata about this embedding
  created_at TEXT NOT NULL DEFAULT (datetime('now')),
  parent_hash TEXT NOT NULL
) STRICT;

CREATE INDEX IF NOT EXISTS idx_embeddings_source ON env_embeddings(source);
CREATE INDEX IF NOT EXISTS idx_embeddings_created ON env_embeddings(created_at);

-- ============================================================================
-- USER FEEDBACK
-- ============================================================================

-- User ratings and feedback on retrievals and responses
-- Enables learning from human signals and improving relevance over time
CREATE TABLE IF NOT EXISTS env_feedback (
  id TEXT PRIMARY KEY,
  seq INTEGER NOT NULL REFERENCES _env_chain(seq),
  retrieval_id TEXT REFERENCES env_retrieval_log(id),
  rating INTEGER NOT NULL CHECK(rating IN (-1, 0, 1)), -- -1 (bad) | 0 (neutral) | 1 (good)
  notes TEXT,
  created_at TEXT NOT NULL DEFAULT (datetime('now')),
  parent_hash TEXT NOT NULL
) STRICT;

CREATE INDEX IF NOT EXISTS idx_feedback_rating ON env_feedback(rating);
CREATE INDEX IF NOT EXISTS idx_feedback_retrieval ON env_feedback(retrieval_id);
CREATE INDEX IF NOT EXISTS idx_feedback_created ON env_feedback(created_at);

-- ============================================================================
-- CONTEXT SUMMARIES
-- ============================================================================

-- LLM-generated context summaries and insights
-- Captures high-level understanding and reasoning patterns
CREATE TABLE IF NOT EXISTS env_context_summaries (
  id TEXT PRIMARY KEY,
  seq INTEGER NOT NULL REFERENCES _env_chain(seq),
  summary TEXT NOT NULL,
  relevance REAL NOT NULL CHECK(relevance >= 0.0 AND relevance <= 1.0),
  source_retrievals TEXT, -- JSON array of retrieval_log IDs
  created_at TEXT NOT NULL DEFAULT (datetime('now')),
  parent_hash TEXT NOT NULL
) STRICT;

CREATE INDEX IF NOT EXISTS idx_summaries_relevance ON env_context_summaries(relevance);
CREATE INDEX IF NOT EXISTS idx_summaries_created ON env_context_summaries(created_at);

-- ============================================================================
-- OBSERVABILITY LOGS
-- ============================================================================

-- System and application logs for debugging, analytics, and audit trails
-- Captures errors, warnings, performance issues, and system events
CREATE TABLE IF NOT EXISTS env_logs (
  id TEXT PRIMARY KEY,
  seq INTEGER NOT NULL REFERENCES _env_chain(seq),
  level TEXT NOT NULL CHECK(level IN ('debug', 'info', 'warn', 'error', 'fatal')),
  logger TEXT NOT NULL, -- Hierarchical logger name: 'search.fts', 'llm.inference'
  message TEXT NOT NULL,
  context TEXT, -- JSON with structured metadata
  created_at TEXT NOT NULL DEFAULT (datetime('now')),
  parent_hash TEXT NOT NULL
) STRICT;

CREATE INDEX IF NOT EXISTS idx_env_logs_level ON env_logs(level);
CREATE INDEX IF NOT EXISTS idx_env_logs_logger ON env_logs(logger);
CREATE INDEX IF NOT EXISTS idx_env_logs_created ON env_logs(created_at);
CREATE INDEX IF NOT EXISTS idx_env_logs_seq ON env_logs(seq);

-- ============================================================================
-- VIEWS
-- ============================================================================

-- Recent activity view (last 100 events)
CREATE VIEW IF NOT EXISTS v_recent_activity AS
SELECT
  'retrieval' as event_type,
  id,
  ts as timestamp,
  query_text as description,
  hit_count as value
FROM env_retrieval_log
UNION ALL
SELECT
  'feedback' as event_type,
  id,
  created_at as timestamp,
  notes as description,
  rating as value
FROM env_feedback
UNION ALL
SELECT
  'summary' as event_type,
  id,
  created_at as timestamp,
  substr(summary, 1, 100) as description,
  relevance as value
FROM env_context_summaries
UNION ALL
SELECT
  'log' as event_type,
  id,
  created_at as timestamp,
  '[' || level || '] ' || logger || ': ' || message as description,
  NULL as value
FROM env_logs
WHERE level IN ('warn', 'error', 'fatal')
ORDER BY timestamp DESC
LIMIT 100;

-- Envelope statistics view
CREATE VIEW IF NOT EXISTS v_envelope_stats AS
SELECT
  (SELECT COUNT(*) FROM env_retrieval_log) as retrieval_count,
  (SELECT COUNT(*) FROM env_embeddings) as embedding_count,
  (SELECT COUNT(*) FROM env_feedback) as feedback_count,
  (SELECT COUNT(*) FROM env_context_summaries) as summary_count,
  (SELECT COUNT(*) FROM env_logs) as log_count,
  (SELECT COUNT(*) FROM _env_chain) as chain_length,
  (SELECT MIN(ts) FROM env_retrieval_log) as first_activity,
  (SELECT MAX(ts) FROM env_retrieval_log) as last_activity;

-- Search analytics view
CREATE VIEW IF NOT EXISTS v_search_analytics AS
SELECT
  COUNT(*) as total_queries,
  COUNT(CASE WHEN hit_count = 0 THEN 1 END) as zero_result_queries,
  COUNT(CASE WHEN hit_count > 0 THEN 1 END) as successful_queries,
  ROUND(COUNT(CASE WHEN hit_count = 0 THEN 1 END) * 100.0 / COUNT(*), 2) as zero_result_rate,
  AVG(hit_count) as avg_hit_count,
  COUNT(DISTINCT query_text) as unique_queries,
  query_type,
  date(ts) as query_date
FROM env_retrieval_log
GROUP BY query_type, query_date
ORDER BY query_date DESC;

-- Zero-result queries view (for improving search)
CREATE VIEW IF NOT EXISTS v_zero_result_queries AS
SELECT
  query_text,
  query_type,
  ts,
  COUNT(*) as attempt_count
FROM env_retrieval_log
WHERE hit_count = 0
GROUP BY query_text, query_type
ORDER BY attempt_count DESC, ts DESC;
`,ye={QUERY_TEXT:10*1024,TOP_DOCS_JSON:100*1024,FEEDBACK_NOTES:50*1024,SUMMARY_TEXT:100*1024,EMBEDDING_DIMS:1e4,METADATA_JSON:50*1024,LOG_MESSAGE:10*1024,LOG_CONTEXT:50*1024};function Ce(t,e){const n=new TextEncoder,i=new TextDecoder;let a=n.encode(t);if(a.length<=e)return t;const o=a.slice(0,e-3);return i.decode(o)+"..."}async function We(t){const e=JSON.stringify({table:t.table,id:t.rowId,data:sn(t.data),parent:t.parentHash,ts:t.timestamp}),i=new TextEncoder().encode(e),a=await crypto.subtle.digest("SHA-256",i);return Array.from(new Uint8Array(a)).map(s=>s.toString(16).padStart(2,"0")).join("")}function sn(t){if(t instanceof Float32Array)return{__type:"Float32Array",values:Array.from(t)};if(Array.isArray(t))return t.map(sn);if(t&&typeof t=="object"){const e={};for(const[n,i]of Object.entries(t))e[n]=sn(i);return e}return t}class ht{constructor(e,n){A(this,"lastHash");A(this,"db");A(this,"genesis","0".repeat(64));this.db=e,this.lastHash=n||this.genesis}getCurrentHash(){return this.lastHash}async appendRetrieval(e){const n=Ce(e.query_text,ye.QUERY_TEXT),i=e.top_docs?JSON.stringify(e.top_docs):null,a=i?Ce(i,ye.TOP_DOCS_JSON):null,o=new Date().toISOString(),s=await We({table:"retrieval_log",rowId:e.id,data:{...e,query_text:n},parentHash:this.lastHash,timestamp:o}),l=this.db.prepare(`
      INSERT INTO env_retrieval_log
      (id, query_text, query_type, top_docs, hit_count, parent_hash, ts)
      VALUES (?, ?, ?, ?, ?, ?, ?)
    `);try{l.bind([e.id,n,e.query_type,a,e.hit_count,this.lastHash,o]),l.step()}finally{l.finalize()}return await this.recordChainBlock(s,"retrieval",1),this.lastHash=s,s}async appendEmbedding(e){if(e.vector.length>ye.EMBEDDING_DIMS)throw new Error(`Embedding vector too large: ${e.vector.length} dimensions (limit: ${ye.EMBEDDING_DIMS})`);const n=e.metadata?JSON.stringify(e.metadata):null,i=n?Ce(n,ye.METADATA_JSON):null,a=new Date().toISOString(),o=await We({table:"embeddings",rowId:e.id,data:e,parentHash:this.lastHash,timestamp:a}),s=new Uint8Array(e.vector.buffer),l=this.db.prepare(`
      INSERT INTO env_embeddings
      (id, source, vector, metadata, parent_hash, created_at)
      VALUES (?, ?, ?, ?, ?, ?)
    `);try{l.bind([e.id,e.source,s,i,this.lastHash,a]),l.step()}finally{l.finalize()}return await this.recordChainBlock(o,"embedding",1),this.lastHash=o,o}async appendFeedback(e){const n=e.notes?Ce(e.notes,ye.FEEDBACK_NOTES):null,i=new Date().toISOString(),a=await We({table:"feedback",rowId:e.id,data:{...e,notes:n||void 0},parentHash:this.lastHash,timestamp:i}),o=this.db.prepare(`
      INSERT INTO env_feedback
      (id, retrieval_id, rating, notes, parent_hash, created_at)
      VALUES (?, ?, ?, ?, ?, ?)
    `);try{o.bind([e.id,e.retrieval_id||null,e.rating,n,this.lastHash,i]),o.step()}finally{o.finalize()}return await this.recordChainBlock(a,"feedback",1),this.lastHash=a,a}async appendSummary(e){const n=Ce(e.summary,ye.SUMMARY_TEXT),i=new Date().toISOString(),a=await We({table:"summaries",rowId:e.id,data:{...e,summary:n},parentHash:this.lastHash,timestamp:i}),o=this.db.prepare(`
      INSERT INTO env_context_summaries
      (id, summary, relevance, source_retrievals, parent_hash, created_at)
      VALUES (?, ?, ?, ?, ?, ?)
    `);try{o.bind([e.id,n,e.relevance,e.source_retrievals?JSON.stringify(e.source_retrievals):null,this.lastHash,i]),o.step()}finally{o.finalize()}return await this.recordChainBlock(a,"summary",1),this.lastHash=a,a}async appendLog(e){const n=Ce(e.message,ye.LOG_MESSAGE),i=e.context?JSON.stringify(e.context):null,a=i?Ce(i,ye.LOG_CONTEXT):null,o=new Date().toISOString(),s=await We({table:"logs",rowId:e.id,data:{...e,message:n},parentHash:this.lastHash,timestamp:o}),l=this.db.prepare(`
      INSERT INTO env_logs
      (id, level, logger, message, context, parent_hash, created_at)
      VALUES (?, ?, ?, ?, ?, ?, ?)
    `);try{l.bind([e.id,e.level,e.logger,n,a,this.lastHash,o]),l.step()}finally{l.finalize()}return await this.recordChainBlock(s,"log",1),this.lastHash=s,s}async recordChainBlock(e,n,i){const a=this.db.prepare(`
      INSERT INTO _env_chain (block_hash, parent_hash, block_type, row_count)
      VALUES (?, ?, ?, ?)
    `);try{a.bind([e,this.lastHash,n,i]),a.step();const s=this.db.prepare("SELECT last_insert_rowid()");try{s.step();const l=s.get([])[0],u=n==="retrieval"?"retrieval_log":n==="embedding"?"embeddings":n==="feedback"?"feedback":n==="summary"?"context_summaries":"logs",c=this.db.prepare(`
          UPDATE env_${u}
          SET seq = ?
          WHERE parent_hash = ?
        `);try{c.bind([l,this.lastHash]),c.step()}finally{c.finalize()}}finally{s.finalize()}}finally{a.finalize()}const o=this.db.prepare(`
      INSERT OR REPLACE INTO _envelope_meta (key, value) VALUES ('last_hash', ?)
    `);try{o.bind([e]),o.step()}finally{o.finalize()}}async verifyChain(){const e=[],n=this.db.prepare(`
      SELECT seq, block_hash, parent_hash, block_type
      FROM _env_chain
      ORDER BY seq ASC
    `),i=[];try{for(;n.step();){const a=n.get([]);i.push({seq:a[0],block_hash:a[1],parent_hash:a[2],block_type:a[3],row_count:0,created_at:""})}}finally{n.finalize()}for(let a=1;a<i.length;a++){const o=i[a],s=i[a-1];o.parent_hash!==s.block_hash&&e.push(`Chain break at seq ${o.seq}: parent_hash ${o.parent_hash} does not match previous block_hash ${s.block_hash}`)}return{valid:e.length===0,errors:e}}getChainStats(){const e=this.db.prepare(`
      SELECT block_type, COUNT(*) as count
      FROM _env_chain
      GROUP BY block_type
    `),n={};try{for(;e.step();){const o=e.get([]);n[o[0]]=o[1]}}finally{e.finalize()}const i=this.db.prepare("SELECT COUNT(*) FROM _env_chain");let a=0;try{i.step(),a=i.get([])[0]}finally{i.finalize()}return{length:a,currentHash:this.lastHash,types:n}}}function At(t="env"){const e=Date.now().toString(36),n=Math.random().toString(36).substring(2,9);return`${t}_${e}_${n}`}async function pt(t){const e=await t.arrayBuffer(),n=await crypto.subtle.digest("SHA-256",e);return Array.from(new Uint8Array(n)).map(a=>a.toString(16).padStart(2,"0")).join("")}class Nt{constructor(){A(this,"db",null);A(this,"writer",null);A(this,"gcaseId",null);A(this,"opfsPath",null);A(this,"sqlite3",null)}static async exists(e){try{const n=await pt(e),i=`/envelopes/${n}.db`;return await(await(await navigator.storage.getDirectory()).getDirectoryHandle("envelopes",{create:!1})).getFileHandle(`${n}.db`,{create:!1}),!0}catch{return!1}}static hasEnvelopeTables(e,n){const i=new e.oo1.DB(":memory:");try{if(e.capi.sqlite3_deserialize(i.pointer,"main",n,n.byteLength,n.byteLength,e.capi.SQLITE_DESERIALIZE_FREEONCLOSE|e.capi.SQLITE_DESERIALIZE_RESIZEABLE)!==0)return!1;const o=i.prepare(`
        SELECT COUNT(*) FROM sqlite_master
        WHERE type='table' AND name='_envelope_meta'
      `);try{if(o.step())return o.get([])[0]>0}finally{o.finalize()}return!1}catch(a){return console.warn("[Envelope] Error checking for envelope tables:",a),!1}finally{i.close()}}async extractFromCanonical(e,n,i){this.sqlite3=n,this.gcaseId=await pt(e),this.opfsPath=`/envelopes/${this.gcaseId}.db`,console.log("[Envelope] Extracting envelope from canonical .gcase+ file..."),await(await navigator.storage.getDirectory()).getDirectoryHandle("envelopes",{create:!0}),this.db=new n.oo1.OpfsDb(this.opfsPath,"c");const o=new n.oo1.DB(":memory:");try{const u=n.capi.sqlite3_deserialize(o.pointer,"main",i,i.byteLength,i.byteLength,n.capi.SQLITE_DESERIALIZE_FREEONCLOSE|n.capi.SQLITE_DESERIALIZE_RESIZEABLE);if(u!==0)throw new Error(`Failed to deserialize source database: ${u}`);o.exec(`ATTACH DATABASE '${this.opfsPath}' AS sidecar`);const c=["_envelope_meta","_env_chain","env_retrieval_log","env_embeddings","env_feedback","env_context_summaries"];for(const p of c){const m=o.prepare(`
          SELECT sql FROM main.sqlite_master
          WHERE type='table' AND name=?
        `);try{if(m.bind([p]),m.step()){const g=m.get([])[0];if(g){const E=g.replace(/CREATE TABLE/,"CREATE TABLE sidecar.");o.exec(E),console.log(`[Envelope] Created sidecar table: ${p}`),o.exec(`INSERT INTO sidecar.${p} SELECT * FROM main.${p}`);const v=o.prepare(`SELECT COUNT(*) FROM sidecar.${p}`);try{v.step();const _=v.get([])[0];console.log(`[Envelope] Copied ${_} rows to ${p}`)}finally{v.finalize()}}}}finally{m.finalize()}}const f=["v_recent_activity","v_envelope_stats","v_search_analytics","v_zero_result_queries"];for(const p of f){const m=o.prepare(`
          SELECT sql FROM main.sqlite_master
          WHERE type='view' AND name=?
        `);try{if(m.bind([p]),m.step()){const g=m.get([])[0];if(g){const E=g.replace(/CREATE VIEW/,"CREATE VIEW sidecar.");o.exec(E),console.log(`[Envelope] Created view: ${p}`)}}}finally{m.finalize()}}const d=o.prepare(`
        SELECT sql FROM main.sqlite_master
        WHERE type='index' AND sql IS NOT NULL AND name LIKE 'idx_%'
      `);try{for(;d.step();){const p=d.get([])[0];if(p&&(p.includes("env_")||p.includes("_env_")))try{const m=p.replace(/ON\s+(\w+)/,"ON sidecar.$1");o.exec(m)}catch(m){console.warn("[Envelope] Index copy failed:",m)}}}finally{d.finalize()}o.exec("DETACH DATABASE sidecar"),console.log("[Envelope] Extraction complete")}finally{o.close()}const s=this.db.prepare(`
      SELECT value FROM _envelope_meta WHERE key = 'last_hash'
    `);let l="0".repeat(64);try{s.step()&&(l=s.get([])[0])}finally{s.finalize()}this.writer=new ht(this.db,l),console.log(`[Envelope] Extracted envelope for ${this.gcaseId}`)}async create(e,n){this.sqlite3=n,this.gcaseId=await pt(e),this.opfsPath=`/envelopes/${this.gcaseId}.db`,await(await navigator.storage.getDirectory()).getDirectoryHandle("envelopes",{create:!0}),this.db=new n.oo1.OpfsDb(this.opfsPath,"c"),this.db.exec(Ti);const a=new Date().toISOString(),o="0".repeat(64),s=this.db.prepare(`
      INSERT INTO _envelope_meta (key, value) VALUES
      ('gcase_id', ?),
      ('created_at', ?),
      ('format_version', '1.1'),
      ('last_hash', ?)
    `);try{s.bind([this.gcaseId,a,o]),s.step()}finally{s.finalize()}this.writer=new ht(this.db,o),console.log(`[Envelope] Created new envelope for ${this.gcaseId}`)}async load(e,n){this.sqlite3=n,this.gcaseId=await pt(e),this.opfsPath=`/envelopes/${this.gcaseId}.db`,this.db=new n.oo1.OpfsDb(this.opfsPath,"w");const i=this.db.prepare(`
      SELECT value FROM _envelope_meta WHERE key = 'last_hash'
    `);let a="0".repeat(64);try{i.step()&&(a=i.get([])[0])}finally{i.finalize()}this.writer=new ht(this.db,a),console.log(`[Envelope] Loaded existing envelope for ${this.gcaseId}`)}async open(e,n){await Nt.exists(e)?await this.load(e,n):await this.create(e,n)}close(){this.db&&(this.db.close(),this.db=null,this.writer=null,this.gcaseId=null,console.log("[Envelope] Closed envelope database"))}getWriter(){return this.writer}getStats(){if(!this.db)return null;const e=this.db.prepare("SELECT * FROM v_envelope_stats");try{if(e.step()){const n=e.get([]);return{retrievalCount:n[0]||0,embeddingCount:n[1]||0,feedbackCount:n[2]||0,summaryCount:n[3]||0,chainLength:n[4]||0,firstActivity:n[5]||null,lastActivity:n[6]||null}}}finally{e.finalize()}return null}getMeta(){if(!this.db)return null;const e=this.db.prepare("SELECT key, value FROM _envelope_meta"),n={};try{for(;e.step();){const i=e.get([]);n[i[0]]=i[1]}}finally{e.finalize()}return{gcaseId:n.gcase_id||"",createdAt:n.created_at||"",formatVersion:n.format_version||"1.1",lastHash:n.last_hash||""}}async clear(){if(!this.db)return;this.db.exec(`
      DELETE FROM env_retrieval_log;
      DELETE FROM env_embeddings;
      DELETE FROM env_feedback;
      DELETE FROM env_context_summaries;
      DELETE FROM _env_chain;
    `);const e="0".repeat(64),n=this.db.prepare(`
      UPDATE _envelope_meta SET value = ? WHERE key = 'last_hash'
    `);try{n.bind([e]),n.step()}finally{n.finalize()}this.writer=new ht(this.db,e),console.log("[Envelope] Cleared all envelope data")}async exportSidecar(){if(!this.db||!this.opfsPath)throw new Error("No envelope sidecar open");return await(await(await(await navigator.storage.getDirectory()).getDirectoryHandle("envelopes")).getFileHandle(`${this.gcaseId}.db`)).getFile()}getRecentActivity(e=20){if(!this.db)return[];const n=this.db.prepare(`
      SELECT event_type, id, timestamp, description, value
      FROM v_recent_activity
      LIMIT ?
    `),i=[];try{for(n.bind([e]);n.step();){const a=n.get([]);i.push({eventType:a[0],id:a[1],timestamp:a[2],description:a[3],value:a[4]})}}finally{n.finalize()}return i}async verify(){return this.writer?this.writer.verifyChain():{valid:!1,errors:["No envelope writer available"]}}getDatabase(){return this.db}isOpen(){return this.db!==null}getOpfsPath(){return this.opfsPath}getGCaseId(){return this.gcaseId}async mergeWithCore(e){if(!this.db||!this.opfsPath||!this.sqlite3)throw new Error("No envelope sidecar open or sqlite3 not available");console.log(`[Envelope] Merging Core (${e.byteLength} bytes) with Envelope sidecar...`);const n=new this.sqlite3.oo1.DB(":memory:");try{const i=this.sqlite3.capi.sqlite3_deserialize(n.pointer,"main",e,e.byteLength,e.byteLength,this.sqlite3.capi.SQLITE_DESERIALIZE_FREEONCLOSE|this.sqlite3.capi.SQLITE_DESERIALIZE_RESIZEABLE);if(i!==0)throw new Error(`Failed to deserialize Core database: ${i}`);console.log("[Envelope] Core database loaded into memory"),n.exec(`ATTACH DATABASE '${this.opfsPath}' AS envelope`),console.log("[Envelope] Attached sidecar database");const a=["_envelope_meta","_env_chain","env_retrieval_log","env_embeddings","env_feedback","env_context_summaries"];for(const u of a){const c=n.prepare(`
          SELECT sql FROM envelope.sqlite_master
          WHERE type='table' AND name=?
        `);try{if(c.bind([u]),c.step()){const f=c.get([])[0];if(f){n.exec(f),console.log(`[Envelope] Created table: ${u}`),n.exec(`INSERT INTO main.${u} SELECT * FROM envelope.${u}`);const d=n.prepare(`SELECT COUNT(*) FROM main.${u}`);try{d.step();const p=d.get([])[0];console.log(`[Envelope] Copied ${p} rows to ${u}`)}finally{d.finalize()}}}}finally{c.finalize()}}const o=["v_recent_activity","v_envelope_stats","v_search_analytics","v_zero_result_queries"];for(const u of o){const c=n.prepare(`
          SELECT sql FROM envelope.sqlite_master
          WHERE type='view' AND name=?
        `);try{if(c.bind([u]),c.step()){const f=c.get([])[0];f&&(n.exec(f),console.log(`[Envelope] Created view: ${u}`))}}finally{c.finalize()}}const s=n.prepare(`
        SELECT sql FROM envelope.sqlite_master
        WHERE type='index' AND sql IS NOT NULL
      `);try{for(;s.step();){const u=s.get([])[0];if(u)try{n.exec(u)}catch(c){console.warn("[Envelope] Index already exists or failed:",c)}}}finally{s.finalize()}n.exec("DETACH DATABASE envelope"),console.log("[Envelope] Detached sidecar");const l=this.sqlite3.capi.sqlite3_js_db_export(n.pointer);if(!l)throw new Error("Failed to export merged database");return console.log(`[Envelope] Merged database exported: ${l.byteLength} bytes`),new Blob([l],{type:"application/x-sqlite3"})}finally{n.close()}}}class Ni{constructor(){A(this,"dbClient");A(this,"envelopeManager");A(this,"currentModality","static");A(this,"currentFile",null);A(this,"currentInfo",null);this.dbClient=new Lr,this.envelopeManager=new Nt}getModalityPreference(){return localStorage.getItem("glyphcase.modality")||"auto"}setModalityPreference(e){localStorage.setItem("glyphcase.modality",e)}async detectModality(e){const n=this.getModalityPreference();return n==="static"?"static":n==="dynamic"||await Nt.exists(e)?"dynamic":"static"}async openFromFile(e,n){this.currentFile=e,e.name.endsWith(".gcasex")&&(console.info("[GlyphCase] Active GlyphCase detected (.gcasex)"),console.info("[GlyphCase] WASM apps are not supported in PWA - treating as Dynamic mode"),console.info("[GlyphCase] All content and envelope data will be accessible"));const i=new Uint8Array(await e.arrayBuffer()),a=await this.dbClient.hasEnvelopeTables(i);a&&(console.log("[GlyphCase] Detected canonical file with embedded envelope tables"),await this.dbClient.extractEnvelope(e),console.log("[GlyphCase] Envelope extracted to runtime sidecar"));const o=await this.dbClient.openFromFile(e);let s;n!==void 0?s=n?"dynamic":"static":a?s="dynamic":s=await this.detectModality(e),this.currentModality=s;let l;return s==="dynamic"&&(l=this.envelopeManager.getStats()||void 0,console.log("[GlyphCase] Dynamic mode active with envelope sidecar")),this.currentInfo={...o,modality:s,envelopeStats:l,envelopeExtracted:a},Kn({gid:o.docId||"unknown",title:o.title||"Untitled",modality:s}),this.currentInfo}async openDemo(){const e=await this.dbClient.openDemo();return this.currentModality="static",this.currentInfo={...e,modality:"static"},Kn({gid:e.docId||"demo",title:e.title||"Demo",modality:"static"}),this.currentInfo}async enableDynamicMode(){if(!this.currentFile)throw new Error("No capsule loaded");if(this.currentModality==="dynamic"){console.log("[GlyphCase] Already in dynamic mode");return}this.currentModality="dynamic",this.currentInfo&&(this.currentInfo.modality="dynamic"),console.log("[GlyphCase] Enabled dynamic mode")}getModality(){return this.currentModality}getInfo(){return this.currentInfo}isDynamic(){return this.currentModality==="dynamic"}getCore(){return this.dbClient}getEnvelope(){return this.envelopeManager}getStream(){return ce}async close(){this.envelopeManager.isOpen()&&this.envelopeManager.close(),await this.dbClient.close(),this.currentModality="static",this.currentFile=null,this.currentInfo=null,bi()}async saveGlyphCase(){if(!this.currentFile)throw new Error("No capsule loaded");if(this.currentModality==="static"){console.log("[GlyphCase] Saving Standard GlyphCase (Core only)");const n=await this.dbClient.exportDatabase();return new Blob([n],{type:"application/x-sqlite3"})}console.log("[GlyphCase] Saving Dynamic GlyphCase (.gcase+)");const e=await this.dbClient.mergeWithEnvelope(this.currentFile);return new Blob([e],{type:"application/x-sqlite3"})}async exportGlyphCase(){return this.saveGlyphCase()}async exportEnvelopeSidecar(){return this.envelopeManager.isOpen()?this.envelopeManager.exportSidecar():null}async clearEnvelope(){this.envelopeManager.isOpen()&&(await this.envelopeManager.clear(),this.currentInfo&&(this.currentInfo.envelopeStats=this.envelopeManager.getStats()||void 0))}getEnvelopeStats(){return this.envelopeManager.getStats()}async verifyEnvelope(){return this.envelopeManager.isOpen()?this.envelopeManager.verify():null}}const $=new Ni;function Ar(t={}){const{defaultMode:e="hybrid",maxResults:n=10,maxGraphHops:i=2,debounceMs:a=300}=t,[o,s]=N(e),[l,u]=N(null),[c,f]=N(""),[d,p]=N(!1),[m,g]=N(null),[E,v]=N({}),[_,y]=N(""),[T,S]=N(()=>{try{const k=localStorage.getItem("memglyph-search-history");return k?JSON.parse(k):[]}catch{return[]}}),L=Ke(null);j(()=>{if(_.trim())return L.current&&clearTimeout(L.current),L.current=window.setTimeout(()=>{q(_)},a),()=>{L.current&&clearTimeout(L.current)}},[_,o,E]);const R=k=>{if(!k.trim())return;const ae=k.trim();S(Z=>{const W=Z.filter(Y=>Y!==ae),se=[ae,...W].slice(0,10);try{localStorage.setItem("memglyph-search-history",JSON.stringify(se))}catch(Y){console.warn("[Search] Failed to save history:",Y)}return se})},B=()=>{S([]);try{localStorage.removeItem("memglyph-search-history")}catch(k){console.warn("[Search] Failed to clear history:",k)}},q=async k=>{if(!k.trim())return;p(!0),g(null),f(k),R(k);const ae=performance.now();try{const Z=le();mi({query:k,type:o,limit:n});let W=[];switch(o){case"fts":W=await wi(Z,k,n,E);break;case"hybrid":W=await Z.searchHybrid(k,n);break;case"graph":W=await Ci(Z,k,n,i,E);break;default:throw new Error(`Unknown search mode: ${o}`)}const se=performance.now()-ae;return gi({query:k,type:o,results:W.map(Y=>({gid:Y.gid,score:Y.scores.final,snippet:Y.snippet||void 0})),executionTime:se}),$.isDynamic()&&await Si(k,o,W),u(W),console.log(`[Search] ${o} mode: ${W.length} results in ${se.toFixed(0)}ms`),W}catch(Z){const W=String(Z);return g(W),console.error("[Search] Failed:",Z),[]}finally{p(!1)}};return{mode:o,results:l,lastQuery:c,loading:d,error:m,entityFilter:E,searchHistory:T,search:k=>{y(k)},searchImmediate:k=>(L.current&&clearTimeout(L.current),y(""),q(k)),clear:()=>{u(null),f(""),g(null),y(""),L.current&&clearTimeout(L.current)},changeMode:k=>{s(k),u(null)},setFilter:k=>{v(k),u(null)},clearFilter:()=>{v({}),u(null)},clearHistory:B}}async function Si(t,e,n){try{const i=$.getEnvelope();if(!i.isOpen()){console.warn("[Search] Envelope not open, skipping log");return}const a=i.getWriter();if(!a){console.warn("[Search] No envelope writer available");return}await a.appendRetrieval({id:At("ret"),query_text:t,query_type:e,top_docs:n.slice(0,10).map(o=>({gid:o.gid,score:o.scores.final,snippet:o.snippet||void 0})),hit_count:n.length}),console.log(`[Search] Logged retrieval to envelope: ${n.length} results`)}catch(i){console.error("[Search] Failed to log to envelope:",i)}}async function wi(t,e,n,i){return(await t.searchFts(e,n,i.entityType,i.entityValue)).map(o=>({gid:o.gid,pageNo:o.pageNo,title:o.title,snippet:o.snippet,scores:{fts:o.score,vector:0,entity:0,graph:0,final:o.score}}))}async function Ci(t,e,n,i,a){const o=await t.searchFts(e,3,a.entityType,a.entityValue);if(o.length===0)return[];const s=o[0].gid,l=await t.graphHops(s,void 0,i,n),u=l.nodes.map(c=>{const f=l.distances[c.gid]||0,d=o.find(p=>p.gid===c.gid);return{gid:c.gid,pageNo:c.pageNo,title:c.title,snippet:(d==null?void 0:d.snippet)||null,scores:{fts:(d==null?void 0:d.score)||0,vector:0,entity:0,graph:1/(f+1),final:((d==null?void 0:d.score)||0)*.3+1/(f+1)*.7}}});return u.sort((c,f)=>f.scores.final-c.scores.final),u}/*! @license DOMPurify 3.3.0 | (c) Cure53 and other contributors | Released under the Apache license 2.0 and Mozilla Public License 2.0 | github.com/cure53/DOMPurify/blob/3.3.0/LICENSE */const{entries:Rr,setPrototypeOf:Zn,isFrozen:Li,getPrototypeOf:Ai,getOwnPropertyDescriptor:Ri}=Object;let{freeze:te,seal:de,create:on}=Object,{apply:ln,construct:cn}=typeof Reflect<"u"&&Reflect;te||(te=function(e){return e});de||(de=function(e){return e});ln||(ln=function(e,n){for(var i=arguments.length,a=new Array(i>2?i-2:0),o=2;o<i;o++)a[o-2]=arguments[o];return e.apply(n,a)});cn||(cn=function(e){for(var n=arguments.length,i=new Array(n>1?n-1:0),a=1;a<n;a++)i[a-1]=arguments[a];return new e(...i)});const ft=ne(Array.prototype.forEach),Oi=ne(Array.prototype.lastIndexOf),er=ne(Array.prototype.pop),Xe=ne(Array.prototype.push),ki=ne(Array.prototype.splice),Et=ne(String.prototype.toLowerCase),Gt=ne(String.prototype.toString),Bt=ne(String.prototype.match),Ve=ne(String.prototype.replace),xi=ne(String.prototype.indexOf),Ii=ne(String.prototype.trim),ue=ne(Object.prototype.hasOwnProperty),ee=ne(RegExp.prototype.test),Ye=Mi(TypeError);function ne(t){return function(e){e instanceof RegExp&&(e.lastIndex=0);for(var n=arguments.length,i=new Array(n>1?n-1:0),a=1;a<n;a++)i[a-1]=arguments[a];return ln(t,e,i)}}function Mi(t){return function(){for(var e=arguments.length,n=new Array(e),i=0;i<e;i++)n[i]=arguments[i];return cn(t,n)}}function x(t,e){let n=arguments.length>2&&arguments[2]!==void 0?arguments[2]:Et;Zn&&Zn(t,null);let i=e.length;for(;i--;){let a=e[i];if(typeof a=="string"){const o=n(a);o!==a&&(Li(e)||(e[i]=o),a=o)}t[a]=!0}return t}function Di(t){for(let e=0;e<t.length;e++)ue(t,e)||(t[e]=null);return t}function _e(t){const e=on(null);for(const[n,i]of Rr(t))ue(t,n)&&(Array.isArray(i)?e[n]=Di(i):i&&typeof i=="object"&&i.constructor===Object?e[n]=_e(i):e[n]=i);return e}function Qe(t,e){for(;t!==null;){const i=Ri(t,e);if(i){if(i.get)return ne(i.get);if(typeof i.value=="function")return ne(i.value)}t=Ai(t)}function n(){return null}return n}const tr=te(["a","abbr","acronym","address","area","article","aside","audio","b","bdi","bdo","big","blink","blockquote","body","br","button","canvas","caption","center","cite","code","col","colgroup","content","data","datalist","dd","decorator","del","details","dfn","dialog","dir","div","dl","dt","element","em","fieldset","figcaption","figure","font","footer","form","h1","h2","h3","h4","h5","h6","head","header","hgroup","hr","html","i","img","input","ins","kbd","label","legend","li","main","map","mark","marquee","menu","menuitem","meter","nav","nobr","ol","optgroup","option","output","p","picture","pre","progress","q","rp","rt","ruby","s","samp","search","section","select","shadow","slot","small","source","spacer","span","strike","strong","style","sub","summary","sup","table","tbody","td","template","textarea","tfoot","th","thead","time","tr","track","tt","u","ul","var","video","wbr"]),zt=te(["svg","a","altglyph","altglyphdef","altglyphitem","animatecolor","animatemotion","animatetransform","circle","clippath","defs","desc","ellipse","enterkeyhint","exportparts","filter","font","g","glyph","glyphref","hkern","image","inputmode","line","lineargradient","marker","mask","metadata","mpath","part","path","pattern","polygon","polyline","radialgradient","rect","stop","style","switch","symbol","text","textpath","title","tref","tspan","view","vkern"]),Wt=te(["feBlend","feColorMatrix","feComponentTransfer","feComposite","feConvolveMatrix","feDiffuseLighting","feDisplacementMap","feDistantLight","feDropShadow","feFlood","feFuncA","feFuncB","feFuncG","feFuncR","feGaussianBlur","feImage","feMerge","feMergeNode","feMorphology","feOffset","fePointLight","feSpecularLighting","feSpotLight","feTile","feTurbulence"]),Fi=te(["animate","color-profile","cursor","discard","font-face","font-face-format","font-face-name","font-face-src","font-face-uri","foreignobject","hatch","hatchpath","mesh","meshgradient","meshpatch","meshrow","missing-glyph","script","set","solidcolor","unknown","use"]),Xt=te(["math","menclose","merror","mfenced","mfrac","mglyph","mi","mlabeledtr","mmultiscripts","mn","mo","mover","mpadded","mphantom","mroot","mrow","ms","mspace","msqrt","mstyle","msub","msup","msubsup","mtable","mtd","mtext","mtr","munder","munderover","mprescripts"]),Pi=te(["maction","maligngroup","malignmark","mlongdiv","mscarries","mscarry","msgroup","mstack","msline","msrow","semantics","annotation","annotation-xml","mprescripts","none"]),nr=te(["#text"]),rr=te(["accept","action","align","alt","autocapitalize","autocomplete","autopictureinpicture","autoplay","background","bgcolor","border","capture","cellpadding","cellspacing","checked","cite","class","clear","color","cols","colspan","controls","controlslist","coords","crossorigin","datetime","decoding","default","dir","disabled","disablepictureinpicture","disableremoteplayback","download","draggable","enctype","enterkeyhint","exportparts","face","for","headers","height","hidden","high","href","hreflang","id","inert","inputmode","integrity","ismap","kind","label","lang","list","loading","loop","low","max","maxlength","media","method","min","minlength","multiple","muted","name","nonce","noshade","novalidate","nowrap","open","optimum","part","pattern","placeholder","playsinline","popover","popovertarget","popovertargetaction","poster","preload","pubdate","radiogroup","readonly","rel","required","rev","reversed","role","rows","rowspan","spellcheck","scope","selected","shape","size","sizes","slot","span","srclang","start","src","srcset","step","style","summary","tabindex","title","translate","type","usemap","valign","value","width","wrap","xmlns","slot"]),Vt=te(["accent-height","accumulate","additive","alignment-baseline","amplitude","ascent","attributename","attributetype","azimuth","basefrequency","baseline-shift","begin","bias","by","class","clip","clippathunits","clip-path","clip-rule","color","color-interpolation","color-interpolation-filters","color-profile","color-rendering","cx","cy","d","dx","dy","diffuseconstant","direction","display","divisor","dur","edgemode","elevation","end","exponent","fill","fill-opacity","fill-rule","filter","filterunits","flood-color","flood-opacity","font-family","font-size","font-size-adjust","font-stretch","font-style","font-variant","font-weight","fx","fy","g1","g2","glyph-name","glyphref","gradientunits","gradienttransform","height","href","id","image-rendering","in","in2","intercept","k","k1","k2","k3","k4","kerning","keypoints","keysplines","keytimes","lang","lengthadjust","letter-spacing","kernelmatrix","kernelunitlength","lighting-color","local","marker-end","marker-mid","marker-start","markerheight","markerunits","markerwidth","maskcontentunits","maskunits","max","mask","mask-type","media","method","mode","min","name","numoctaves","offset","operator","opacity","order","orient","orientation","origin","overflow","paint-order","path","pathlength","patterncontentunits","patterntransform","patternunits","points","preservealpha","preserveaspectratio","primitiveunits","r","rx","ry","radius","refx","refy","repeatcount","repeatdur","restart","result","rotate","scale","seed","shape-rendering","slope","specularconstant","specularexponent","spreadmethod","startoffset","stddeviation","stitchtiles","stop-color","stop-opacity","stroke-dasharray","stroke-dashoffset","stroke-linecap","stroke-linejoin","stroke-miterlimit","stroke-opacity","stroke","stroke-width","style","surfacescale","systemlanguage","tabindex","tablevalues","targetx","targety","transform","transform-origin","text-anchor","text-decoration","text-rendering","textlength","type","u1","u2","unicode","values","viewbox","visibility","version","vert-adv-y","vert-origin-x","vert-origin-y","width","word-spacing","wrap","writing-mode","xchannelselector","ychannelselector","x","x1","x2","xmlns","y","y1","y2","z","zoomandpan"]),ir=te(["accent","accentunder","align","bevelled","close","columnsalign","columnlines","columnspan","denomalign","depth","dir","display","displaystyle","encoding","fence","frame","height","href","id","largeop","length","linethickness","lspace","lquote","mathbackground","mathcolor","mathsize","mathvariant","maxsize","minsize","movablelimits","notation","numalign","open","rowalign","rowlines","rowspacing","rowspan","rspace","rquote","scriptlevel","scriptminsize","scriptsizemultiplier","selection","separator","separators","stretchy","subscriptshift","supscriptshift","symmetric","voffset","width","xmlns"]),mt=te(["xlink:href","xml:id","xlink:title","xml:space","xmlns:xlink"]),$i=de(/\{\{[\w\W]*|[\w\W]*\}\}/gm),Ui=de(/<%[\w\W]*|[\w\W]*%>/gm),Hi=de(/\$\{[\w\W]*/gm),qi=de(/^data-[\-\w.\u00B7-\uFFFF]+$/),Gi=de(/^aria-[\-\w]+$/),Or=de(/^(?:(?:(?:f|ht)tps?|mailto|tel|callto|sms|cid|xmpp|matrix):|[^a-z]|[a-z+.\-]+(?:[^a-z+.\-:]|$))/i),Bi=de(/^(?:\w+script|data):/i),zi=de(/[\u0000-\u0020\u00A0\u1680\u180E\u2000-\u2029\u205F\u3000]/g),kr=de(/^html$/i),Wi=de(/^[a-z][.\w]*(-[.\w]+)+$/i);var ar=Object.freeze({__proto__:null,ARIA_ATTR:Gi,ATTR_WHITESPACE:zi,CUSTOM_ELEMENT:Wi,DATA_ATTR:qi,DOCTYPE_NAME:kr,ERB_EXPR:Ui,IS_ALLOWED_URI:Or,IS_SCRIPT_OR_DATA:Bi,MUSTACHE_EXPR:$i,TMPLIT_EXPR:Hi});const je={element:1,text:3,progressingInstruction:7,comment:8,document:9},Xi=function(){return typeof window>"u"?null:window},Vi=function(e,n){if(typeof e!="object"||typeof e.createPolicy!="function")return null;let i=null;const a="data-tt-policy-suffix";n&&n.hasAttribute(a)&&(i=n.getAttribute(a));const o="dompurify"+(i?"#"+i:"");try{return e.createPolicy(o,{createHTML(s){return s},createScriptURL(s){return s}})}catch{return console.warn("TrustedTypes policy "+o+" could not be created."),null}},sr=function(){return{afterSanitizeAttributes:[],afterSanitizeElements:[],afterSanitizeShadowDOM:[],beforeSanitizeAttributes:[],beforeSanitizeElements:[],beforeSanitizeShadowDOM:[],uponSanitizeAttribute:[],uponSanitizeElement:[],uponSanitizeShadowNode:[]}};function xr(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:Xi();const e=C=>xr(C);if(e.version="3.3.0",e.removed=[],!t||!t.document||t.document.nodeType!==je.document||!t.Element)return e.isSupported=!1,e;let{document:n}=t;const i=n,a=i.currentScript,{DocumentFragment:o,HTMLTemplateElement:s,Node:l,Element:u,NodeFilter:c,NamedNodeMap:f=t.NamedNodeMap||t.MozNamedAttrMap,HTMLFormElement:d,DOMParser:p,trustedTypes:m}=t,g=u.prototype,E=Qe(g,"cloneNode"),v=Qe(g,"remove"),_=Qe(g,"nextSibling"),y=Qe(g,"childNodes"),T=Qe(g,"parentNode");if(typeof s=="function"){const C=n.createElement("template");C.content&&C.content.ownerDocument&&(n=C.content.ownerDocument)}let S,L="";const{implementation:R,createNodeIterator:B,createDocumentFragment:q,getElementsByTagName:I}=n,{importNode:he}=i;let M=sr();e.isSupported=typeof Rr=="function"&&typeof T=="function"&&R&&R.createHTMLDocument!==void 0;const{MUSTACHE_EXPR:re,ERB_EXPR:Re,TMPLIT_EXPR:F,DATA_ATTR:k,ARIA_ATTR:ae,IS_SCRIPT_OR_DATA:Z,ATTR_WHITESPACE:W,CUSTOM_ELEMENT:se}=ar;let{IS_ALLOWED_URI:Y}=ar,U=null;const Ee=x({},[...tr,...zt,...Wt,...Xt,...nr]);let O=null;const Te=x({},[...rr,...Vt,...ir,...mt]);let G=Object.seal(on(null,{tagNameCheck:{writable:!0,configurable:!1,enumerable:!0,value:null},attributeNameCheck:{writable:!0,configurable:!1,enumerable:!0,value:null},allowCustomizedBuiltInElements:{writable:!0,configurable:!1,enumerable:!0,value:!1}})),Ne=null,Ge=null;const Oe=Object.seal(on(null,{tagCheck:{writable:!0,configurable:!1,enumerable:!0,value:null},attributeCheck:{writable:!0,configurable:!1,enumerable:!0,value:null}}));let vn=!0,Rt=!0,En=!1,bn=!0,ke=!1,it=!0,Se=!1,Ot=!1,kt=!1,xe=!1,at=!1,st=!1,Tn=!0,Nn=!1;const Br="user-content-";let xt=!0,Be=!1,Ie={},Me=null;const Sn=x({},["annotation-xml","audio","colgroup","desc","foreignobject","head","iframe","math","mi","mn","mo","ms","mtext","noembed","noframes","noscript","plaintext","script","style","svg","template","thead","title","video","xmp"]);let wn=null;const Cn=x({},["audio","video","img","source","image","track"]);let It=null;const Ln=x({},["alt","class","for","id","label","name","pattern","placeholder","role","summary","title","value","style","xmlns"]),ot="http://www.w3.org/1998/Math/MathML",lt="http://www.w3.org/2000/svg",fe="http://www.w3.org/1999/xhtml";let De=fe,Mt=!1,Dt=null;const zr=x({},[ot,lt,fe],Gt);let ct=x({},["mi","mo","mn","ms","mtext"]),dt=x({},["annotation-xml"]);const Wr=x({},["title","style","font","a","script"]);let ze=null;const Xr=["application/xhtml+xml","text/html"],Vr="text/html";let Q=null,Fe=null;const Yr=n.createElement("form"),An=function(h){return h instanceof RegExp||h instanceof Function},Ft=function(){let h=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};if(!(Fe&&Fe===h)){if((!h||typeof h!="object")&&(h={}),h=_e(h),ze=Xr.indexOf(h.PARSER_MEDIA_TYPE)===-1?Vr:h.PARSER_MEDIA_TYPE,Q=ze==="application/xhtml+xml"?Gt:Et,U=ue(h,"ALLOWED_TAGS")?x({},h.ALLOWED_TAGS,Q):Ee,O=ue(h,"ALLOWED_ATTR")?x({},h.ALLOWED_ATTR,Q):Te,Dt=ue(h,"ALLOWED_NAMESPACES")?x({},h.ALLOWED_NAMESPACES,Gt):zr,It=ue(h,"ADD_URI_SAFE_ATTR")?x(_e(Ln),h.ADD_URI_SAFE_ATTR,Q):Ln,wn=ue(h,"ADD_DATA_URI_TAGS")?x(_e(Cn),h.ADD_DATA_URI_TAGS,Q):Cn,Me=ue(h,"FORBID_CONTENTS")?x({},h.FORBID_CONTENTS,Q):Sn,Ne=ue(h,"FORBID_TAGS")?x({},h.FORBID_TAGS,Q):_e({}),Ge=ue(h,"FORBID_ATTR")?x({},h.FORBID_ATTR,Q):_e({}),Ie=ue(h,"USE_PROFILES")?h.USE_PROFILES:!1,vn=h.ALLOW_ARIA_ATTR!==!1,Rt=h.ALLOW_DATA_ATTR!==!1,En=h.ALLOW_UNKNOWN_PROTOCOLS||!1,bn=h.ALLOW_SELF_CLOSE_IN_ATTR!==!1,ke=h.SAFE_FOR_TEMPLATES||!1,it=h.SAFE_FOR_XML!==!1,Se=h.WHOLE_DOCUMENT||!1,xe=h.RETURN_DOM||!1,at=h.RETURN_DOM_FRAGMENT||!1,st=h.RETURN_TRUSTED_TYPE||!1,kt=h.FORCE_BODY||!1,Tn=h.SANITIZE_DOM!==!1,Nn=h.SANITIZE_NAMED_PROPS||!1,xt=h.KEEP_CONTENT!==!1,Be=h.IN_PLACE||!1,Y=h.ALLOWED_URI_REGEXP||Or,De=h.NAMESPACE||fe,ct=h.MATHML_TEXT_INTEGRATION_POINTS||ct,dt=h.HTML_INTEGRATION_POINTS||dt,G=h.CUSTOM_ELEMENT_HANDLING||{},h.CUSTOM_ELEMENT_HANDLING&&An(h.CUSTOM_ELEMENT_HANDLING.tagNameCheck)&&(G.tagNameCheck=h.CUSTOM_ELEMENT_HANDLING.tagNameCheck),h.CUSTOM_ELEMENT_HANDLING&&An(h.CUSTOM_ELEMENT_HANDLING.attributeNameCheck)&&(G.attributeNameCheck=h.CUSTOM_ELEMENT_HANDLING.attributeNameCheck),h.CUSTOM_ELEMENT_HANDLING&&typeof h.CUSTOM_ELEMENT_HANDLING.allowCustomizedBuiltInElements=="boolean"&&(G.allowCustomizedBuiltInElements=h.CUSTOM_ELEMENT_HANDLING.allowCustomizedBuiltInElements),ke&&(Rt=!1),at&&(xe=!0),Ie&&(U=x({},nr),O=[],Ie.html===!0&&(x(U,tr),x(O,rr)),Ie.svg===!0&&(x(U,zt),x(O,Vt),x(O,mt)),Ie.svgFilters===!0&&(x(U,Wt),x(O,Vt),x(O,mt)),Ie.mathMl===!0&&(x(U,Xt),x(O,ir),x(O,mt))),h.ADD_TAGS&&(typeof h.ADD_TAGS=="function"?Oe.tagCheck=h.ADD_TAGS:(U===Ee&&(U=_e(U)),x(U,h.ADD_TAGS,Q))),h.ADD_ATTR&&(typeof h.ADD_ATTR=="function"?Oe.attributeCheck=h.ADD_ATTR:(O===Te&&(O=_e(O)),x(O,h.ADD_ATTR,Q))),h.ADD_URI_SAFE_ATTR&&x(It,h.ADD_URI_SAFE_ATTR,Q),h.FORBID_CONTENTS&&(Me===Sn&&(Me=_e(Me)),x(Me,h.FORBID_CONTENTS,Q)),xt&&(U["#text"]=!0),Se&&x(U,["html","head","body"]),U.table&&(x(U,["tbody"]),delete Ne.tbody),h.TRUSTED_TYPES_POLICY){if(typeof h.TRUSTED_TYPES_POLICY.createHTML!="function")throw Ye('TRUSTED_TYPES_POLICY configuration option must provide a "createHTML" hook.');if(typeof h.TRUSTED_TYPES_POLICY.createScriptURL!="function")throw Ye('TRUSTED_TYPES_POLICY configuration option must provide a "createScriptURL" hook.');S=h.TRUSTED_TYPES_POLICY,L=S.createHTML("")}else S===void 0&&(S=Vi(m,a)),S!==null&&typeof L=="string"&&(L=S.createHTML(""));te&&te(h),Fe=h}},Rn=x({},[...zt,...Wt,...Fi]),On=x({},[...Xt,...Pi]),Qr=function(h){let b=T(h);(!b||!b.tagName)&&(b={namespaceURI:De,tagName:"template"});const w=Et(h.tagName),H=Et(b.tagName);return Dt[h.namespaceURI]?h.namespaceURI===lt?b.namespaceURI===fe?w==="svg":b.namespaceURI===ot?w==="svg"&&(H==="annotation-xml"||ct[H]):!!Rn[w]:h.namespaceURI===ot?b.namespaceURI===fe?w==="math":b.namespaceURI===lt?w==="math"&&dt[H]:!!On[w]:h.namespaceURI===fe?b.namespaceURI===lt&&!dt[H]||b.namespaceURI===ot&&!ct[H]?!1:!On[w]&&(Wr[w]||!Rn[w]):!!(ze==="application/xhtml+xml"&&Dt[h.namespaceURI]):!1},pe=function(h){Xe(e.removed,{element:h});try{T(h).removeChild(h)}catch{v(h)}},we=function(h,b){try{Xe(e.removed,{attribute:b.getAttributeNode(h),from:b})}catch{Xe(e.removed,{attribute:null,from:b})}if(b.removeAttribute(h),h==="is")if(xe||at)try{pe(b)}catch{}else try{b.setAttribute(h,"")}catch{}},kn=function(h){let b=null,w=null;if(kt)h="<remove></remove>"+h;else{const X=Bt(h,/^[\r\n\t ]+/);w=X&&X[0]}ze==="application/xhtml+xml"&&De===fe&&(h='<html xmlns="http://www.w3.org/1999/xhtml"><head></head><body>'+h+"</body></html>");const H=S?S.createHTML(h):h;if(De===fe)try{b=new p().parseFromString(H,ze)}catch{}if(!b||!b.documentElement){b=R.createDocument(De,"template",null);try{b.documentElement.innerHTML=Mt?L:H}catch{}}const K=b.body||b.documentElement;return h&&w&&K.insertBefore(n.createTextNode(w),K.childNodes[0]||null),De===fe?I.call(b,Se?"html":"body")[0]:Se?b.documentElement:K},xn=function(h){return B.call(h.ownerDocument||h,h,c.SHOW_ELEMENT|c.SHOW_COMMENT|c.SHOW_TEXT|c.SHOW_PROCESSING_INSTRUCTION|c.SHOW_CDATA_SECTION,null)},Pt=function(h){return h instanceof d&&(typeof h.nodeName!="string"||typeof h.textContent!="string"||typeof h.removeChild!="function"||!(h.attributes instanceof f)||typeof h.removeAttribute!="function"||typeof h.setAttribute!="function"||typeof h.namespaceURI!="string"||typeof h.insertBefore!="function"||typeof h.hasChildNodes!="function")},In=function(h){return typeof l=="function"&&h instanceof l};function me(C,h,b){ft(C,w=>{w.call(e,h,b,Fe)})}const Mn=function(h){let b=null;if(me(M.beforeSanitizeElements,h,null),Pt(h))return pe(h),!0;const w=Q(h.nodeName);if(me(M.uponSanitizeElement,h,{tagName:w,allowedTags:U}),it&&h.hasChildNodes()&&!In(h.firstElementChild)&&ee(/<[/\w!]/g,h.innerHTML)&&ee(/<[/\w!]/g,h.textContent)||h.nodeType===je.progressingInstruction||it&&h.nodeType===je.comment&&ee(/<[/\w]/g,h.data))return pe(h),!0;if(!(Oe.tagCheck instanceof Function&&Oe.tagCheck(w))&&(!U[w]||Ne[w])){if(!Ne[w]&&Fn(w)&&(G.tagNameCheck instanceof RegExp&&ee(G.tagNameCheck,w)||G.tagNameCheck instanceof Function&&G.tagNameCheck(w)))return!1;if(xt&&!Me[w]){const H=T(h)||h.parentNode,K=y(h)||h.childNodes;if(K&&H){const X=K.length;for(let ie=X-1;ie>=0;--ie){const ge=E(K[ie],!0);ge.__removalCount=(h.__removalCount||0)+1,H.insertBefore(ge,_(h))}}}return pe(h),!0}return h instanceof u&&!Qr(h)||(w==="noscript"||w==="noembed"||w==="noframes")&&ee(/<\/no(script|embed|frames)/i,h.innerHTML)?(pe(h),!0):(ke&&h.nodeType===je.text&&(b=h.textContent,ft([re,Re,F],H=>{b=Ve(b,H," ")}),h.textContent!==b&&(Xe(e.removed,{element:h.cloneNode()}),h.textContent=b)),me(M.afterSanitizeElements,h,null),!1)},Dn=function(h,b,w){if(Tn&&(b==="id"||b==="name")&&(w in n||w in Yr))return!1;if(!(Rt&&!Ge[b]&&ee(k,b))){if(!(vn&&ee(ae,b))){if(!(Oe.attributeCheck instanceof Function&&Oe.attributeCheck(b,h))){if(!O[b]||Ge[b]){if(!(Fn(h)&&(G.tagNameCheck instanceof RegExp&&ee(G.tagNameCheck,h)||G.tagNameCheck instanceof Function&&G.tagNameCheck(h))&&(G.attributeNameCheck instanceof RegExp&&ee(G.attributeNameCheck,b)||G.attributeNameCheck instanceof Function&&G.attributeNameCheck(b,h))||b==="is"&&G.allowCustomizedBuiltInElements&&(G.tagNameCheck instanceof RegExp&&ee(G.tagNameCheck,w)||G.tagNameCheck instanceof Function&&G.tagNameCheck(w))))return!1}else if(!It[b]){if(!ee(Y,Ve(w,W,""))){if(!((b==="src"||b==="xlink:href"||b==="href")&&h!=="script"&&xi(w,"data:")===0&&wn[h])){if(!(En&&!ee(Z,Ve(w,W,"")))){if(w)return!1}}}}}}}return!0},Fn=function(h){return h!=="annotation-xml"&&Bt(h,se)},Pn=function(h){me(M.beforeSanitizeAttributes,h,null);const{attributes:b}=h;if(!b||Pt(h))return;const w={attrName:"",attrValue:"",keepAttr:!0,allowedAttributes:O,forceKeepAttr:void 0};let H=b.length;for(;H--;){const K=b[H],{name:X,namespaceURI:ie,value:ge}=K,Pe=Q(X),$t=ge;let J=X==="value"?$t:Ii($t);if(w.attrName=Pe,w.attrValue=J,w.keepAttr=!0,w.forceKeepAttr=void 0,me(M.uponSanitizeAttribute,h,w),J=w.attrValue,Nn&&(Pe==="id"||Pe==="name")&&(we(X,h),J=Br+J),it&&ee(/((--!?|])>)|<\/(style|title|textarea)/i,J)){we(X,h);continue}if(Pe==="attributename"&&Bt(J,"href")){we(X,h);continue}if(w.forceKeepAttr)continue;if(!w.keepAttr){we(X,h);continue}if(!bn&&ee(/\/>/i,J)){we(X,h);continue}ke&&ft([re,Re,F],Un=>{J=Ve(J,Un," ")});const $n=Q(h.nodeName);if(!Dn($n,Pe,J)){we(X,h);continue}if(S&&typeof m=="object"&&typeof m.getAttributeType=="function"&&!ie)switch(m.getAttributeType($n,Pe)){case"TrustedHTML":{J=S.createHTML(J);break}case"TrustedScriptURL":{J=S.createScriptURL(J);break}}if(J!==$t)try{ie?h.setAttributeNS(ie,X,J):h.setAttribute(X,J),Pt(h)?pe(h):er(e.removed)}catch{we(X,h)}}me(M.afterSanitizeAttributes,h,null)},jr=function C(h){let b=null;const w=xn(h);for(me(M.beforeSanitizeShadowDOM,h,null);b=w.nextNode();)me(M.uponSanitizeShadowNode,b,null),Mn(b),Pn(b),b.content instanceof o&&C(b.content);me(M.afterSanitizeShadowDOM,h,null)};return e.sanitize=function(C){let h=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{},b=null,w=null,H=null,K=null;if(Mt=!C,Mt&&(C="<!-->"),typeof C!="string"&&!In(C))if(typeof C.toString=="function"){if(C=C.toString(),typeof C!="string")throw Ye("dirty is not a string, aborting")}else throw Ye("toString is not a function");if(!e.isSupported)return C;if(Ot||Ft(h),e.removed=[],typeof C=="string"&&(Be=!1),Be){if(C.nodeName){const ge=Q(C.nodeName);if(!U[ge]||Ne[ge])throw Ye("root node is forbidden and cannot be sanitized in-place")}}else if(C instanceof l)b=kn("<!---->"),w=b.ownerDocument.importNode(C,!0),w.nodeType===je.element&&w.nodeName==="BODY"||w.nodeName==="HTML"?b=w:b.appendChild(w);else{if(!xe&&!ke&&!Se&&C.indexOf("<")===-1)return S&&st?S.createHTML(C):C;if(b=kn(C),!b)return xe?null:st?L:""}b&&kt&&pe(b.firstChild);const X=xn(Be?C:b);for(;H=X.nextNode();)Mn(H),Pn(H),H.content instanceof o&&jr(H.content);if(Be)return C;if(xe){if(at)for(K=q.call(b.ownerDocument);b.firstChild;)K.appendChild(b.firstChild);else K=b;return(O.shadowroot||O.shadowrootmode)&&(K=he.call(i,K,!0)),K}let ie=Se?b.outerHTML:b.innerHTML;return Se&&U["!doctype"]&&b.ownerDocument&&b.ownerDocument.doctype&&b.ownerDocument.doctype.name&&ee(kr,b.ownerDocument.doctype.name)&&(ie="<!DOCTYPE "+b.ownerDocument.doctype.name+`>
`+ie),ke&&ft([re,Re,F],ge=>{ie=Ve(ie,ge," ")}),S&&st?S.createHTML(ie):ie},e.setConfig=function(){let C=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};Ft(C),Ot=!0},e.clearConfig=function(){Fe=null,Ot=!1},e.isValidAttribute=function(C,h,b){Fe||Ft({});const w=Q(C),H=Q(h);return Dn(w,H,b)},e.addHook=function(C,h){typeof h=="function"&&Xe(M[C],h)},e.removeHook=function(C,h){if(h!==void 0){const b=Oi(M[C],h);return b===-1?void 0:ki(M[C],b,1)[0]}return er(M[C])},e.removeHooks=function(C){M[C]=[]},e.removeAllHooks=function(){M=sr()},e}var yn=xr();function Yi({mode:t,onModeChange:e,showToggle:n=!0}){return n?r("div",{className:"search-mode-toggle",children:[r("button",{className:`mode-btn ${t==="fts"?"active":""}`,onClick:()=>e("fts"),children:" FTS Only"}),r("button",{className:`mode-btn ${t==="hybrid"?"active":""}`,onClick:()=>e("hybrid"),children:" Hybrid"}),r("button",{className:`mode-btn ${t==="graph"?"active":""}`,onClick:()=>e("graph"),children:" Graph"})]}):null}function Qi({onSearch:t,loading:e,placeholder:n,searchHistory:i,onClearHistory:a}){return r(oe,{children:[r("form",{onSubmit:o=>{o.preventDefault();const l=new FormData(o.currentTarget).get("query");l!=null&&l.trim()&&t(l.trim())},children:r("div",{className:"search-bar",children:[r("input",{type:"text",name:"query",placeholder:n||"Search the capsule...",className:"search-input",disabled:e}),r("button",{type:"submit",className:"btn-search",disabled:e,children:e?"Searching...":"Search"})]})}),i&&i.length>0&&r("div",{className:"search-history",children:[r("div",{className:"search-history-header",children:[r("span",{className:"search-history-label",children:"Recent searches:"}),a&&r("button",{className:"search-history-clear",onClick:a,type:"button",children:"Clear"})]}),r("div",{className:"search-history-items",children:i.map((o,s)=>r("button",{className:"search-history-item",onClick:()=>t(o),type:"button",children:o},s))})]})]})}function ji({resultGid:t,retrievalId:e}){const[n,i]=N(null),[a,o]=N(!1),s=async l=>{o(!0);try{if(Ei({retrievalId:e,rating:l,notes:void 0}),$.isDynamic()){const c=$.getEnvelope().getWriter();c&&await c.appendFeedback({id:At("fb"),retrieval_id:e,rating:l,notes:void 0})}i(l)}catch(u){console.error("[Feedback] Failed to submit feedback:",u)}finally{o(!1)}};return $.isDynamic()?r("div",{className:"result-feedback",children:[r("button",{className:`feedback-btn ${n===1?"feedback-btn-active-positive":""}`,onClick:l=>{l.stopPropagation(),s(1)},disabled:a||n!==null,title:"Helpful result",children:""}),r("button",{className:`feedback-btn ${n===-1?"feedback-btn-active-negative":""}`,onClick:l=>{l.stopPropagation(),s(-1)},disabled:a||n!==null,title:"Not helpful",children:""})]}):null}function Ji({results:t,query:e,onResultClick:n,retrievalId:i}){return r("div",{className:"search-results",children:[r("p",{className:"results-header",children:["Found ",t.length," results for ",r("strong",{children:['"',e,'"']})]}),t.map(a=>r("div",{className:`result-item ${n?"result-item-clickable":""}`,onClick:()=>n==null?void 0:n(a.gid),style:{cursor:n?"pointer":"default"},children:[r("div",{className:"result-header",children:[r("span",{className:"result-page",children:["Page ",a.pageNo]}),r("span",{className:"result-score",children:["Score: ",a.scores.final.toFixed(3)]}),r(ji,{resultGid:a.gid,retrievalId:i})]}),r("h4",{className:"result-title",children:a.title}),a.snippet&&r("p",{className:"result-snippet",dangerouslySetInnerHTML:{__html:yn.sanitize(a.snippet,{ALLOWED_TAGS:["mark","strong","em","b","i"],ALLOWED_ATTR:[]})}}),r("div",{className:"result-scores",children:[r("span",{children:["FTS: ",a.scores.fts.toFixed(2)]}),r("span",{children:["Entity: ",a.scores.entity.toFixed(2)]}),r("span",{children:["Graph: ",a.scores.graph.toFixed(2)]})]})]},a.gid))]})}function Ki({mode:t,results:e,lastQuery:n,loading:i,onSearch:a,onModeChange:o,onResultClick:s,showModeToggle:l=!0,placeholder:u,searchHint:c,searchHistory:f,onClearHistory:d}){return r("div",{className:"search-section",children:[r("div",{className:"search-header",children:r("h3",{children:" Search"})}),r(Yi,{mode:t,onModeChange:o,showToggle:l}),c&&r("p",{className:"search-hint",children:c}),r("div",{className:"keyboard-shortcuts-hint",children:[r("span",{className:"shortcut-item",children:[r("kbd",{children:"/"})," Focus search"]}),r("span",{className:"shortcut-item",children:[r("kbd",{children:"Ctrl+L"})," Toggle LLM"]}),r("span",{className:"shortcut-item",children:[r("kbd",{children:"Esc"})," Clear focus"]})]}),r(Qi,{onSearch:a,loading:i,placeholder:u,searchHistory:f,onClearHistory:d}),e&&e.length>0&&r(Ji,{results:e,query:n,onResultClick:s}),e&&e.length===0&&r("div",{className:"no-results",children:[r("p",{children:["No results found for ",r("strong",{children:['"',n,'"']})]}),r("p",{className:"search-hint",children:"Try different keywords or search terms."})]})]})}function Ir(t={}){const{autoLoad:e=!0,maxEntities:n=50}=t,[i,a]=N([]),[o,s]=N(null),[l,u]=N(!1),[c,f]=N(null),d=async()=>{u(!0),f(null);try{const y=await le().listEntities(void 0,n);a(y),console.log("[Entities] Loaded:",y.length)}catch(_){const y=String(_);f(y),console.error("[Entities] Failed to load:",_)}finally{u(!1)}};j(()=>{e&&d()},[e]);const p=_=>{s(_)},m=()=>Array.from(new Set(i.map(_=>_.entityType))),g=()=>o?i.filter(_=>_.entityType===o):i,E=_=>i.filter(y=>y.entityType===_).reduce((y,T)=>y+T.count,0),v=()=>i.reduce((_,y)=>_+y.count,0);return{entities:i,selectedType:o,loading:l,error:c,types:m(),filteredEntities:g(),totalCount:v(),loadEntities:d,selectType:p,getTypeCount:E}}function Zi({types:t,selectedType:e,totalCount:n,onSelectType:i,getTypeCount:a}){return r("div",{className:"entity-filters",children:[r("button",{className:`entity-filter ${e===null?"active":""}`,onClick:()=>i(null),children:["All (",n,")"]}),t.map(o=>{const s=a(o);return r("button",{className:`entity-filter ${e===o?"active":""}`,onClick:()=>i(o),children:[o," (",s,")"]},o)})]})}function ea({entities:t,maxDisplay:e=20}){const n=t.slice(0,e);return r("div",{className:"entity-list",children:[n.map(i=>r("div",{className:"entity-item",children:[r("span",{className:"entity-type",children:i.entityType}),r("span",{className:"entity-value",children:i.normalizedValue}),r("span",{className:"entity-count",children:i.count})]},`${i.entityType}-${i.normalizedValue}`)),t.length>e&&r("div",{className:"entity-item entity-more",children:r("span",{className:"entity-value",children:["... and ",t.length-e," more"]})})]})}function ta({entities:t,types:e,selectedType:n,totalCount:i,onSelectType:a,getTypeCount:o,show:s=!0,maxDisplay:l=20}){if(!s||t.length===0)return null;const u=n?t.filter(c=>c.entityType===n):t;return r("div",{className:"entity-panel",children:[r("h4",{children:"Filter by Entity Type"}),r(Zi,{types:e,selectedType:n,totalCount:i,onSelectType:a,getTypeCount:o}),r(ea,{entities:u,maxDisplay:l})]})}class na{constructor(){A(this,"worker",null);A(this,"nextId",1);A(this,"pending",new Map);A(this,"progressCallback",null);A(this,"streamTokenCallback",null);A(this,"streamCompleteCallback",null);A(this,"streamErrorCallback",null);this.initWorker()}initWorker(){this.worker=new Worker(new URL("/assets/llm.worker-BiRl8TFV.js",import.meta.url),{type:"module"}),this.worker.onmessage=e=>{const n=e.data;if("type"in n&&n.type==="READY"){console.log("[LlmClient] Worker ready");return}if("type"in n&&n.type==="PROGRESS"){this.progressCallback&&this.progressCallback(n.data);return}if("type"in n&&n.type==="STREAM_TOKEN"){this.streamTokenCallback&&this.streamTokenCallback(n.token,n.piece);return}if("type"in n&&n.type==="STREAM_COMPLETE"){this.streamCompleteCallback&&this.streamCompleteCallback();return}if("type"in n&&n.type==="STREAM_ERROR"){this.streamErrorCallback&&this.streamErrorCallback(n.error);return}const{id:i,response:a}=n,o=this.pending.get(i);o&&(this.pending.delete(i),o.resolve(a))},this.worker.onerror=e=>{console.error("[LlmClient] Worker error:",e);for(const n of this.pending.values())n.reject(new Error("Worker error"));this.pending.clear()}}async sendRequest(e){if(!this.worker)throw new Error("Worker not initialized");const n=this.nextId++;return new Promise((i,a)=>{this.pending.set(n,{resolve:s=>{s.ok?i(s.data):a(new Error(s.error))},reject:a});const o={id:n,request:e};this.worker.postMessage(o)})}onProgress(e){this.progressCallback=e}onStreamToken(e){this.streamTokenCallback=e}onStreamComplete(e){this.streamCompleteCallback=e}onStreamError(e){this.streamErrorCallback=e}async abortReasoning(){return this.sendRequest({type:"ABORT_REASONING"})}async loadModel(e){return this.sendRequest({type:"LOAD_MODEL",modelUrl:e})}async reason(e){return this.sendRequest({type:"REASON",request:e})}async unloadModel(){return this.sendRequest({type:"UNLOAD_MODEL"})}async getStatus(){return this.sendRequest({type:"GET_STATUS"})}terminate(){this.worker&&(this.worker.terminate(),this.worker=null),this.pending.clear(),this.progressCallback=null,this.streamTokenCallback=null,this.streamCompleteCallback=null,this.streamErrorCallback=null}}let Yt=null;function gt(){return Yt||(Yt=new na),Yt}const ra={"0.6b":"https://huggingface.co/unsloth/Qwen3-0.6B-GGUF/resolve/main/Qwen3-0.6B-Q4_K_M.gguf","1.5b":"https://huggingface.co/ggml-org/Qwen2.5-1.5B-Instruct-GGUF/resolve/main/qwen2.5-1.5b-instruct-q4_k_m.gguf"};function Mr(t={}){const[e,n]=N(!1),[i,a]=N(null),[o,s]=N(!1),[l,u]=N(null),[c,f]=N(null),[d,p]=N(null),[m,g]=N(0),[E,v]=N(.7),[_,y]=N(!1),[T,S]=N(""),L=Ke(0),R=Ke(null),B=Ke(0),q=5e3;j(()=>{if(o&&!l)return L.current=Date.now(),g(0),R.current=window.setInterval(()=>{const F=(Date.now()-L.current)/1e3;g(F)},100),()=>{R.current&&clearInterval(R.current)};R.current&&(clearInterval(R.current),R.current=null),g(0)},[o,l]);const I=async()=>{s(!0),p(null),u(null);try{const F=gt();F.onProgress(ae=>{u(ae)}),F.onStreamToken((ae,Z)=>{S(W=>W+Z)}),F.onStreamComplete(()=>{y(!1)}),F.onStreamError(ae=>{p(ae),y(!1),S("")});const k=await F.loadModel(ra["0.6b"]);a(k),u(null),console.log("[LLM] Model loaded:",k)}catch(F){const k=String(F);p(k),console.error("[LLM] Failed to load model:",F)}finally{s(!1)}};return{enabled:e,modelInfo:i,loading:o,progress:l,reasoning:c,error:d,elapsedTime:m,temperature:E,isStreaming:_,streamingText:T,toggle:async()=>{if(!e)i!=null&&i.loaded||await I(),n(!0);else if(n(!1),f(null),i!=null&&i.loaded)try{await gt().unloadModel(),a({...i,loaded:!1}),console.log("[LLM] Model unloaded successfully")}catch(F){console.error("[LLM] Failed to unload model:",F)}},loadModel:I,reason:async(F,k,ae=256)=>{if(!(i!=null&&i.loaded)){console.warn("[LLM] Cannot reason: model not loaded");return}const Z=Date.now(),W=Z-B.current;if(W<q){const Y=`Please wait ${Math.ceil((q-W)/1e3)}s before making another query (rate limit: 1 query per 5 seconds)`;p(Y),console.warn("[LLM] Rate limit hit:",Y);return}B.current=Z,s(!0),p(null),y(!0),S("");try{const se=gt(),Y=k.slice(0,5).map(O=>({gid:O.gid,pageNo:O.pageNo,title:O.title,text:O.snippet||"",score:O.scores.final}));yi({prompt:F,context:Y.map(O=>O.text),model:i.modelId});const U=await se.reason({question:F,snippets:Y,maxTokens:ae,temperature:E}),Ee=U.usedSnippets.map(O=>Y.find(Te=>Te.gid===O)).filter(O=>O!==void 0);if(_i({response:U.answer,citations:Ee.map(O=>({gid:O.gid,pageNo:O.pageNo})),model:i.modelId}),Ee.forEach(O=>{vi({gid:O.gid,pageNo:O.pageNo,title:O.title||void 0,snippet:O.text})}),$.isDynamic()){const O=$.getEnvelope();if(O.isOpen()){const Te=O.getWriter();if(Te){const G=Ee.length>0?Ee.reduce((Ne,Ge)=>Ne+Ge.score,0)/Ee.length:1;await Te.appendSummary({id:At("llm"),summary:U.answer,relevance:G,source_retrievals:U.usedSnippets})}}}f(U),y(!1),console.log("[LLM] Reasoning complete:",U)}catch(se){const Y=String(se);p(Y),y(!1),S(""),console.error("[LLM] Reasoning failed:",se)}finally{s(!1)}},clearReasoning:()=>{f(null)},abortReasoning:async()=>{try{await gt().abortReasoning(),y(!1),S(""),s(!1),console.log("[LLM] Reasoning aborted")}catch(F){console.error("[LLM] Failed to abort reasoning:",F)}},setTemperature:v}}function ia({reasoning:t,searchResults:e,loading:n}){const[i,a]=N(null);return n&&!t?r("div",{className:"reasoning-loading",children:[r("div",{className:"spinner"}),r("p",{children:"LLM is reasoning..."})]}):t?r("div",{className:"reasoning-output",children:[r("div",{className:"reasoning-header",children:[r("h4",{children:" LLM Reasoning"}),r("span",{className:"reasoning-meta",children:[t.inferenceTimeMs.toFixed(0),"ms  ",t.tokensGenerated," tokens"]})]}),r("div",{className:"reasoning-answer",children:t.answer}),t.usedSnippets.length>0&&r("div",{className:"reasoning-citations",children:[r("strong",{children:" Cited sources:"}),t.usedSnippets.map(o=>{const s=e==null?void 0:e.find(l=>l.gid===o);return r("span",{className:"citation",onMouseEnter:()=>a(o),onMouseLeave:()=>a(null),style:{position:"relative"},children:["Page ",(s==null?void 0:s.pageNo)||"?",i===o&&s&&r("div",{className:"citation-tooltip",children:[r("div",{className:"citation-tooltip-title",children:s.title}),s.snippet&&r("div",{className:"citation-tooltip-snippet",dangerouslySetInnerHTML:{__html:yn.sanitize(s.snippet,{ALLOWED_TAGS:["mark","strong","em","b","i"],ALLOWED_ATTR:[]})}}),r("div",{className:"citation-tooltip-meta",children:["Score: ",s.scores.final.toFixed(3),"  GID: ",o.slice(0,8),"..."]})]})]},o)})]})]}):null}function He(){return typeof navigator<"u"&&"storage"in navigator&&"getDirectory"in navigator.storage}async function aa(){if(!He())throw new Error("OPFS not supported in this browser");return await navigator.storage.getDirectory()}async function sa(){return await(await aa()).getDirectoryHandle("capsules",{create:!0})}function oa(t){const e=t.replace(/[^a-z0-9._-]/gi,"-");return e.endsWith(".mgx.sqlite")?e:`${e}.mgx.sqlite`}async function la(t,e){if(!He())throw new Error("OPFS not supported - cannot persist file");const n=await sa(),i=e||oa(t.name),o=await(await n.getFileHandle(i,{create:!0})).createWritable();try{return await o.write(t),await o.close(),console.log(`[OPFS] Copied file to ${i} (${t.size} bytes)`),{path:i,size:t.size}}catch(s){throw await o.close(),s}}async function ca(){if(!navigator.storage||!navigator.storage.estimate)return null;try{const t=await navigator.storage.estimate(),e=t.usage||0,n=t.quota||0;return{usage:e,quota:n,available:n-e,percentUsed:n>0?e/n*100:0}}catch(t){return console.error("[OPFS] Failed to get storage quota:",t),null}}async function da(){if(!navigator.storage||!navigator.storage.persist)return!1;try{const t=await navigator.storage.persist();return console.log(`[OPFS] Persistent storage: ${t}`),t}catch(t){return console.error("[OPFS] Failed to request persistent storage:",t),!1}}function Ze(t){if(t===0)return"0 B";const e=1024,n=["B","KB","MB","GB"],i=Math.floor(Math.log(t)/Math.log(e));return`${(t/Math.pow(e,i)).toFixed(2)} ${n[i]}`}async function ua(t,e=500*1024*1024){if(t.size===0)return{valid:!1,error:"File is empty"};if(t.size>e)return{valid:!1,error:`File too large (${Ze(t.size)} > ${Ze(e)})`};const n=t.name.toLowerCase();if(!n.endsWith(".mgx.sqlite")&&!n.endsWith(".sqlite"))return{valid:!1,error:"File must have .mgx.sqlite or .sqlite extension"};try{const i=await t.slice(0,16).arrayBuffer();if(!new TextDecoder().decode(i).startsWith("SQLite format 3"))return{valid:!1,error:"Not a valid SQLite file (invalid header)"}}catch(i){return{valid:!1,error:`Failed to read file header: ${i}`}}return{valid:!0}}function ha({onFileSelected:t,onOpfsFileSelected:e,onError:n}){const[i,a]=N([]),[o,s]=N(null),[l,u]=N(!1),[c,f]=N(!1),d=le();j(()=>{p(),m()},[]);async function p(){try{const y=await d.listOpfsFiles();a(y)}catch(y){console.error("[FilePicker] Failed to list OPFS files:",y)}}async function m(){var y,T;try{const S=await ca();s(S);const L=await((T=(y=navigator.storage)==null?void 0:y.persisted)==null?void 0:T.call(y));f(L||!1)}catch(S){console.error("[FilePicker] Failed to get quota:",S)}}async function g(y){var L;const T=y.target,S=(L=T.files)==null?void 0:L[0];if(S){u(!0);try{const R=await ua(S);if(!R.valid){n(R.error),u(!1);return}if(He()){const{path:B}=await la(S);await p(),await m(),t(S,B)}else t(S)}catch(R){n(`Failed to load file: ${R}`)}finally{u(!1),T.value=""}}}async function E(y){u(!0);try{e(y)}catch(T){n(`Failed to open from OPFS: ${T}`)}finally{u(!1)}}async function v(y,T){if(T.stopPropagation(),!!confirm(`Remove "${y}" from device storage?`))try{await d.removeFromOpfs(y),await p(),await m()}catch(S){n(`Failed to remove file: ${S}`)}}async function _(){try{await da()?f(!0):n("Persistent storage not granted. Files may be evicted under storage pressure.")}catch(y){n(`Failed to request persistence: ${y}`)}}return r("div",{class:"file-picker",children:[r("div",{class:"file-picker-header",children:[r("h2",{children:"Open Capsule"}),o&&r("div",{class:"storage-quota",children:[r("div",{class:"quota-bar",children:r("div",{class:"quota-used",style:`width: ${Math.min(o.percentUsed,100)}%`})}),r("p",{class:"quota-text",children:[Ze(o.usage)," / ",Ze(o.quota)," used (",o.percentUsed.toFixed(1),"%)"]}),!c&&He()&&r("button",{class:"btn-secondary btn-sm",onClick:_,children:"Request Persistent Storage"})]})]}),r("div",{class:"file-input-section",children:[r("label",{class:"file-input-label",children:[r("input",{type:"file",accept:".mgx.sqlite,.sqlite",onChange:g,disabled:l,style:"display: none"}),r("button",{class:"btn-primary",disabled:l,children:l?"Loading...":"Select File from Device"})]}),r("p",{class:"help-text",children:"Choose a .mgx.sqlite or .sqlite file from your device"})]}),He()&&i.length>0&&r("div",{class:"opfs-files-section",children:[r("h3",{children:"Stored on Device"}),r("ul",{class:"opfs-files-list",children:i.map(y=>r("li",{class:"opfs-file-item",children:[r("button",{class:"opfs-file-button",onClick:()=>E(y.path),disabled:l,children:r("div",{class:"file-info",children:[r("span",{class:"file-name",children:y.path}),r("span",{class:"file-meta",children:[Ze(y.size)," "," ",new Date(y.lastModified).toLocaleDateString()]})]})}),r("button",{class:"btn-remove",onClick:T=>v(y.path,T),title:"Remove from device","aria-label":"Remove from device",children:""})]},y.path))})]}),!He()&&r("div",{class:"opfs-warning",children:r("p",{children:[r("strong",{children:"Note:"})," Your browser doesn't support persistent storage. Files will only be kept in memory and lost when you close the tab."]})})]})}function pa(t={}){const{autoLoad:e=!1,maxHops:n=2,limit:i=50}=t,[a,o]=N(null),[s,l]=N(null),[u,c]=N(void 0),[f,d]=N(!1),[p,m]=N(null),g=async(L,R)=>{d(!0),m(null),l(L),c(R);try{const q=await le().graphHops(L,R,n,i);o(q),console.log("[Graph] Loaded:",q.nodes.length,"nodes,",q.edges.length,"edges")}catch(B){const q=String(B);m(q),console.error("[Graph] Failed to load:",B)}finally{d(!1)}},E=async L=>{await g(L,u)},v=async L=>{s&&await g(s,L)},_=()=>{o(null),l(null),c(void 0),m(null)},y=()=>a?Array.from(new Set(a.edges.map(L=>L.predicate))):[],T=L=>a==null?void 0:a.nodes.find(R=>R.gid===L),S=L=>a?a.edges.filter(R=>R.fromGid===L):[];return j(()=>{e&&s&&g(s,u)},[e]),{graphData:a,seedGid:s,predicate:u,loading:f,error:p,predicates:y(),nodeCount:(a==null?void 0:a.nodes.length)||0,edgeCount:(a==null?void 0:a.edges.length)||0,loadGraph:g,navigateToNode:E,filterByPredicate:v,clear:_,getNode:T,getNodeEdges:S}}function fa({nodes:t,edges:e,seedGid:n,onNodeClick:i,width:a=800,height:o=600}){const[s,l]=N(new Map),u=Ke();return j(()=>{const c=new Map,f=a/2,d=o/2;t.forEach((p,m)=>{const g=m/t.length*2*Math.PI,E=Math.min(a,o)/3;c.set(p.gid,{gid:p.gid,x:f+E*Math.cos(g),y:d+E*Math.sin(g),vx:0,vy:0})}),l(c)},[t,a,o]),j(()=>{if(s.size===0)return;const c=()=>{const d=new Map(s),p=.3;d.forEach(m=>{d.forEach(g=>{if(m.gid===g.gid)return;const E=g.x-m.x,v=g.y-m.y,_=E*E+v*v+1,y=Math.sqrt(_),T=2e3/_;m.vx-=E/y*T*p,m.vy-=v/y*T*p})}),e.forEach(m=>{const g=d.get(m.fromGid),E=d.get(m.toGid);if(!g||!E)return;const v=E.x-g.x,_=E.y-g.y,y=Math.sqrt(v*v+_*_)+1,T=y*.01;g.vx+=v/y*T*p,g.vy+=_/y*T*p,E.vx-=v/y*T*p,E.vy-=_/y*T*p}),d.forEach(m=>{m.x+=m.vx,m.y+=m.vy,m.vx*=.8,m.vy*=.8,m.x=Math.max(30,Math.min(a-30,m.x)),m.y=Math.max(30,Math.min(o-30,m.y))}),l(d),u.current=requestAnimationFrame(c)};u.current=requestAnimationFrame(c);const f=setTimeout(()=>{u.current&&cancelAnimationFrame(u.current)},3e3);return()=>{u.current&&cancelAnimationFrame(u.current),clearTimeout(f)}},[e,a,o]),r("svg",{width:a,height:o,className:"graph-view",style:{border:"1px solid var(--color-border)",borderRadius:"8px"},children:[r("g",{className:"graph-edges",children:e.map((c,f)=>{const d=s.get(c.fromGid),p=s.get(c.toGid);return!d||!p?null:r("line",{x1:d.x,y1:d.y,x2:p.x,y2:p.y,stroke:"#94a3b8",strokeWidth:Math.max(1,c.weight*2),strokeOpacity:.6,markerEnd:"url(#arrowhead)"},`${c.fromGid}-${c.toGid}-${f}`)})}),r("defs",{children:r("marker",{id:"arrowhead",markerWidth:"10",markerHeight:"10",refX:"9",refY:"3",orient:"auto",markerUnits:"strokeWidth",children:r("path",{d:"M0,0 L0,6 L9,3 z",fill:"#94a3b8"})})}),r("g",{className:"graph-nodes",children:t.map(c=>{const f=s.get(c.gid);if(!f)return null;const d=c.gid===n,p=d?12:8,m=d?"#3b82f6":"#64748b";return r("g",{className:"graph-node",onClick:()=>i==null?void 0:i(c.gid),style:{cursor:i?"pointer":"default"},children:[r("circle",{cx:f.x,cy:f.y,r:p,fill:m,stroke:"#ffffff",strokeWidth:2,opacity:.9}),r("text",{x:f.x,y:f.y-p-5,textAnchor:"middle",fontSize:"11",fill:"var(--color-fg)",style:{pointerEvents:"none",userSelect:"none"},children:c.title||`Page ${c.pageNo}`})]},c.gid)})})]})}function ma({nodes:t,edges:e,seedGid:n,onNodeClick:i,loading:a,error:o}){return a?r("div",{className:"graph-panel-loading",children:[r("div",{className:"spinner"}),r("p",{children:"Loading graph..."})]}):o?r("div",{className:"graph-panel-error",children:r("p",{children:["Error: ",o]})}):t.length===0?r("div",{className:"graph-panel-empty",children:[r("p",{children:"No graph data to display"}),r("p",{className:"hint",children:"Search for a page or select a result to explore its connections"})]}):r("div",{className:"graph-panel",children:[r("div",{className:"graph-info",children:[r("span",{children:[t.length," nodes"]}),r("span",{children:[e.length," edges"]})]}),r(fa,{nodes:t,edges:e,seedGid:n,onNodeClick:i,width:800,height:600})]})}function ga({predicates:t,selectedPredicate:e,onPredicateChange:n,onReset:i}){return r("div",{className:"graph-controls",children:[r("div",{className:"graph-controls-section",children:[r("label",{className:"graph-controls-label",children:"Filter by Relationship:"}),r("select",{className:"graph-controls-select",value:e||"",onChange:a=>{const o=a.target.value;n(o||void 0)},children:[r("option",{value:"",children:"All Relationships"}),t.map(a=>r("option",{value:a,children:a},a))]})]}),i&&r("button",{className:"btn-secondary btn-sm",onClick:i,children:"Reset View"})]})}function ya({nodeCount:t,edgeCount:e,predicateCount:n,seedNode:i}){return r("div",{className:"graph-stats",children:[r("div",{className:"graph-stat",children:[r("span",{className:"graph-stat-label",children:"Nodes:"}),r("span",{className:"graph-stat-value",children:t})]}),r("div",{className:"graph-stat",children:[r("span",{className:"graph-stat-label",children:"Edges:"}),r("span",{className:"graph-stat-value",children:e})]}),r("div",{className:"graph-stat",children:[r("span",{className:"graph-stat-label",children:"Relationships:"}),r("span",{className:"graph-stat-value",children:n})]}),i&&r("div",{className:"graph-stat",children:[r("span",{className:"graph-stat-label",children:"Seed:"}),r("span",{className:"graph-stat-value",children:i})]})]})}function _a(t={}){const{autoLoadCheckpoints:e=!1}=t,[n,i]=N([]),[a,o]=N(null),[s,l]=N(!1),[u,c]=N(!1),[f,d]=N(null),p=async()=>{l(!0),d(null);try{const v=await le().getCheckpoints();i(v),console.log("[Provenance] Loaded",v.length,"checkpoints")}catch(E){const v=String(E);d(v),console.error("[Provenance] Failed to load checkpoints:",E)}finally{l(!1)}},m=async E=>{c(!0),d(null);try{const _=await le().verifyPage(E);o(_),console.log("[Provenance] Verification result:",_)}catch(v){const _=String(v);d(_),console.error("[Provenance] Failed to verify page:",v)}finally{c(!1)}},g=()=>{o(null)};return j(()=>{e&&p()},[e]),{checkpoints:n,verificationResult:a,loading:s,verifying:u,error:f,checkpointCount:n.length,latestCheckpoint:n[0]||null,loadCheckpoints:p,verifyPage:m,clearVerification:g}}function va({checkpoint:t,isLatest:e}){return r("div",{className:`checkpoint-item ${e?"checkpoint-latest":""}`,children:[r("div",{className:"checkpoint-header",children:[r("div",{className:"checkpoint-epoch",children:[e&&r("span",{className:"checkpoint-badge",children:"Latest"}),r("span",{className:"checkpoint-epoch-value",children:["Epoch ",t.epoch]})]}),r("div",{className:"checkpoint-date",children:new Date(t.createdTs).toLocaleString()})]}),r("div",{className:"checkpoint-body",children:[r("div",{className:"checkpoint-field",children:[r("span",{className:"field-label",children:"Merkle Root:"}),r("code",{className:"field-value",title:t.merkleRoot,children:[t.merkleRoot.substring(0,16),"..."]})]}),r("div",{className:"checkpoint-field",children:[r("span",{className:"field-label",children:"Pages:"}),r("span",{className:"field-value",children:t.pagesCount})]}),t.anchors&&t.anchors.length>0&&r("div",{className:"checkpoint-field",children:[r("span",{className:"field-label",children:"Anchors:"}),r("span",{className:"field-value",children:t.anchors.length})]})]})]})}function Ea({checkpoints:t,loading:e,error:n}){return e?r("div",{className:"checkpoint-timeline-loading",children:[r("div",{className:"spinner"}),r("p",{children:"Loading checkpoints..."})]}):n?r("div",{className:"checkpoint-timeline-error",children:r("p",{children:["Error: ",n]})}):t.length===0?r("div",{className:"checkpoint-timeline-empty",children:[r("p",{children:"No checkpoints found"}),r("p",{className:"hint",children:"This capsule has not been checkpointed yet"})]}):r("div",{className:"checkpoint-timeline",children:t.map((i,a)=>r(va,{checkpoint:i,isLatest:a===0},i.epoch))})}function ba({result:t,verifying:e,onVerify:n}){return e?r("div",{className:"verification-panel verification-loading",children:[r("div",{className:"spinner"}),r("p",{children:"Verifying page integrity..."})]}):t?r("div",{className:`verification-panel ${t.verified?"verification-success":"verification-failure"}`,children:[r("div",{className:"verification-header",children:r("div",{className:"verification-status",children:t.verified?r(oe,{children:[r("span",{className:"status-icon",children:""}),r("span",{className:"status-text",children:"Verified"})]}):r(oe,{children:[r("span",{className:"status-icon",children:""}),r("span",{className:"status-text",children:"Verification Failed"})]})})}),r("div",{className:"verification-body",children:[r("div",{className:"verification-field",children:[r("span",{className:"field-label",children:"Content SHA:"}),r("code",{className:"field-value",title:t.contentSha,children:[t.contentSha.substring(0,16),"..."]})]}),t.expectedSha&&r("div",{className:"verification-field",children:[r("span",{className:"field-label",children:"Expected SHA:"}),r("code",{className:"field-value",title:t.expectedSha,children:[t.expectedSha.substring(0,16),"..."]})]}),t.epoch&&r("div",{className:"verification-field",children:[r("span",{className:"field-label",children:"Checkpoint Epoch:"}),r("span",{className:"field-value",children:t.epoch})]}),t.merkleRoot&&r("div",{className:"verification-field",children:[r("span",{className:"field-label",children:"Merkle Root:"}),r("code",{className:"field-value",title:t.merkleRoot,children:[t.merkleRoot.substring(0,16),"..."]})]}),t.signer&&r("div",{className:"verification-field",children:[r("span",{className:"field-label",children:"Signer:"}),r("code",{className:"field-value",children:t.signer})]}),t.signature&&r("div",{className:"verification-field",children:[r("span",{className:"field-label",children:"Signature:"}),r("code",{className:"field-value",title:t.signature,children:[t.signature.substring(0,16),"..."]})]})]}),n&&r("div",{className:"verification-footer",children:r("button",{className:"btn-secondary btn-sm",onClick:n,children:"Verify Again"})})]}):r("div",{className:"verification-panel verification-empty",children:[r("p",{children:'Click "Verify Page" to check integrity'}),n&&r("button",{className:"btn-primary btn-sm",onClick:n,children:"Verify Page"})]})}function Ta({checkpoints:t,verificationResult:e,loading:n,verifying:i,error:a,onVerify:o}){const[s,l]=N("checkpoints");return r("div",{className:"provenance-panel",children:[r("div",{className:"provenance-header",children:r("h3",{children:"Provenance & Trust"})}),r("div",{className:"provenance-tabs",children:[r("button",{className:`provenance-tab ${s==="checkpoints"?"active":""}`,onClick:()=>l("checkpoints"),children:[" Checkpoints (",t.length,")"]}),r("button",{className:`provenance-tab ${s==="verification"?"active":""}`,onClick:()=>l("verification"),children:" Verification"})]}),r("div",{className:"provenance-content",children:[s==="checkpoints"&&r(Ea,{checkpoints:t,loading:n,error:a}),s==="verification"&&r(ba,{result:e,verifying:i,onVerify:o})]})]})}function Na(t){const{onFocusSearch:e,onToggleLlm:n,onEscape:i}=t;j(()=>{function a(o){const s=o.target,l=s.tagName==="INPUT"||s.tagName==="TEXTAREA"||s.isContentEditable;if(o.key==="/"&&!l){o.preventDefault(),e==null||e();return}if((o.ctrlKey||o.metaKey)&&o.key==="l"){o.preventDefault(),n==null||n();return}if(o.key==="Escape"){i==null||i();return}}return window.addEventListener("keydown",a),()=>{window.removeEventListener("keydown",a)}},[e,n,i])}function Sa(){const[t,e]=N($.getInfo()),[n,i]=N($.getModality()),[a,o]=N($.getEnvelopeStats());return j(()=>{const m=ce.subscribe("capsule.loaded",()=>{e($.getInfo()),i($.getModality()),o($.getEnvelopeStats())}),g=ce.subscribe("capsule.unloaded",()=>{e(null),i("static"),o(null)}),E=ce.subscribe("envelope.stats",v=>{o(v)});return()=>{m(),g(),E()}},[]),{info:t,modality:n,isDynamic:n==="dynamic",envelopeStats:a,enableDynamicMode:async()=>{await $.enableDynamicMode(),i("dynamic")},saveGlyphCase:async()=>$.saveGlyphCase(),exportGlyphCase:async()=>$.exportGlyphCase(),exportEnvelopeSidecar:async()=>$.exportEnvelopeSidecar(),clearEnvelope:async()=>{await $.clearEnvelope(),o($.getEnvelopeStats())},verifyEnvelope:async()=>$.verifyEnvelope(),setModalityPreference:m=>{$.setModalityPreference(m)}}}function wa({modality:t,envelopeStats:e,envelopeExtracted:n,onEnableDynamic:i,onSaveGlyphCase:a,onClearEnvelope:o,onVerifyEnvelope:s}){const[l,u]=N(!1),[c,f]=N(!1),d=async()=>{if(i){f(!0);try{await i()}catch(v){console.error("Failed to enable dynamic mode:",v),alert(`Failed to enable dynamic mode: ${v}`)}finally{f(!1)}}},p=async()=>{if(a){f(!0);try{await a(),u(!1)}catch(v){console.error("Failed to save GlyphCase:",v),alert(`Failed to save GlyphCase: ${v}`)}finally{f(!1)}}},m=async()=>{if(!(!o||!confirm(`Are you sure you want to clear all envelope data?

This will delete:
 ${(e==null?void 0:e.retrievalCount)||0} retrieval logs
 ${(e==null?void 0:e.feedbackCount)||0} feedback entries
 ${(e==null?void 0:e.embeddingCount)||0} contextual embeddings
 ${(e==null?void 0:e.summaryCount)||0} context summaries

This action cannot be undone.`))){f(!0);try{await o(),u(!1)}catch(_){console.error("Failed to clear envelope:",_),alert(`Failed to clear envelope: ${_}`)}finally{f(!1)}}},g=async()=>{if(s){f(!0);try{await s(),u(!1)}catch(v){console.error("Failed to verify envelope:",v),alert(`Failed to verify envelope: ${v}`)}finally{f(!1)}}},E=t==="dynamic";return r("div",{className:"modality-badge",children:[r("button",{className:`modality-badge-button ${t}`,onClick:()=>u(!l),title:E?"Dynamic GlyphCase - Click for options":"Static GlyphCase - Click for options",children:E?" Dynamic":" Static"}),l&&r("div",{className:"modality-menu",children:[r("div",{className:"modality-menu-header",children:[r("h3",{children:E?"Dynamic Mode":"Static Mode"}),r("button",{className:"modality-menu-close",onClick:()=>u(!1),children:""})]}),E?r("div",{className:"modality-menu-content",children:[r("p",{className:"modality-description",children:"This GlyphCase has an active Envelope for episodic memory."}),n&&r("p",{className:"envelope-hint",style:{marginBottom:"1rem",fontSize:"0.9em",color:"#6b7280"},children:" Opened from canonical .gcase+ format (Core + Envelope in single file)"}),e&&r("div",{className:"envelope-stats",children:[r("h4",{children:"Envelope Statistics:"}),r("div",{className:"envelope-stats-grid",children:[r("div",{className:"envelope-stat",children:[r("span",{className:"envelope-stat-label",children:"Retrievals"}),r("span",{className:"envelope-stat-value",children:e.retrievalCount})]}),r("div",{className:"envelope-stat",children:[r("span",{className:"envelope-stat-label",children:"Feedbacks"}),r("span",{className:"envelope-stat-value",children:e.feedbackCount})]}),r("div",{className:"envelope-stat",children:[r("span",{className:"envelope-stat-label",children:"Embeddings"}),r("span",{className:"envelope-stat-value",children:e.embeddingCount})]}),r("div",{className:"envelope-stat",children:[r("span",{className:"envelope-stat-label",children:"Summaries"}),r("span",{className:"envelope-stat-value",children:e.summaryCount})]})]}),e.firstActivity&&r("p",{className:"envelope-activity",children:[r("strong",{children:"Active since:"})," ",new Date(e.firstActivity).toLocaleString()]})]}),r("div",{className:"envelope-actions",children:[r("button",{className:"btn-secondary btn-sm",onClick:g,disabled:c,children:c?"Verifying...":" Verify Integrity"}),r("button",{className:"btn-secondary btn-sm",onClick:p,disabled:c,children:c?"Saving...":" Save GlyphCase"}),r("button",{className:"btn-danger btn-sm",onClick:m,disabled:c,children:c?"Clearing...":" Clear Envelope"})]}),r("p",{className:"envelope-hint",children:" Save GlyphCase creates a single .gcase+ file with Core + Envelope merged together."})]}):r("div",{className:"modality-menu-content",children:[r("p",{className:"modality-description",children:"This GlyphCase is in static mode. All data is read-only."}),r("div",{className:"modality-info",children:[r("h4",{children:"Enable Dynamic Mode to:"}),r("ul",{children:[r("li",{children:"Log search queries and results"}),r("li",{children:"Provide feedback on retrievals"}),r("li",{children:"Generate contextual summaries"}),r("li",{children:"Build adaptive memory over time"})]})]}),r("button",{className:"btn-primary",onClick:d,disabled:c,children:c?"Enabling...":"Enable Dynamic Mode"})]})]}),l&&r("div",{className:"modality-menu-backdrop",onClick:()=>u(!1)})]})}function Ca(t){return t.startsWith("asset://")?{protocol:"asset",path:t.slice(8)}:null}const Qt=new Map,La=new Map;async function Aa(t){if(Qt.has(t))return Qt.get(t);const e=Ca(t);if(!e)return console.error("[Assets] Invalid asset URL:",t),null;try{const i=await le().getPageBlob(e.path);if(!i||i.size===0)return console.warn("[Assets] Asset not found or empty:",e.path),null;const a=URL.createObjectURL(i);return Qt.set(t,a),La.set(t,i),console.log("[Assets] Loaded:",e.path,`(${i.size} bytes, ${i.type||"unknown type"})`),a}catch(n){return console.error("[Assets] Failed to load asset:",t,n),null}}function Ra(t){const[e,n]=N(null);return j(()=>{if(!t){n(null);return}if(!t.startsWith("asset://")){n(t);return}Aa(t).then(n)},[t]),e}function Oa({gid:t,onClose:e}){const[n,i]=N(null),[a,o]=N(!0),[s,l]=N(null);j(()=>{(async()=>{o(!0),l(null);try{const p=await le().query("SELECT gid, doc_id, page_no, title, tags, updated_ts FROM meta_index WHERE gid = ? LIMIT 1",[t]);p.length>0?i(p[0]):l("Page not found")}catch(d){l(String(d)),console.error("[PagePreview] Failed to load page:",d)}finally{o(!1)}})()},[t]);const u=n?`asset://glyphs/page_${String(n.pageNo).padStart(4,"0")}.mgx.png`:void 0,c=Ra(u);return a?r("div",{className:"page-preview",children:r("div",{className:"page-preview-loading",children:[r("div",{className:"spinner"}),r("p",{children:"Loading page..."})]})}):s||!n?r("div",{className:"page-preview",children:r("div",{className:"page-preview-error",children:[r("p",{children:["Error: ",s||"Page not found"]}),e&&r("button",{className:"btn-secondary",onClick:e,children:"Close"})]})}):r("div",{className:"page-preview",children:[r("div",{className:"page-preview-header",children:[r("div",{className:"page-preview-title",children:[r("span",{className:"page-number",children:["Page ",n.pageNo]}),r("h3",{children:n.title||"(Untitled)"})]}),e&&r("button",{className:"btn-icon",onClick:e,title:"Close preview",children:""})]}),r("div",{className:"page-preview-content",children:c?r("img",{src:c,alt:`Page ${n.pageNo}`,className:"page-image"}):r("div",{className:"page-preview-placeholder",children:r("p",{children:"No image available for this page"})})}),r("div",{className:"page-preview-metadata",children:r("dl",{children:[r("dt",{children:"GID:"}),r("dd",{children:r("code",{title:n.gid,children:[n.gid.substring(0,16),"..."]})}),n.tags&&r(oe,{children:[r("dt",{children:"Tags:"}),r("dd",{children:n.tags})]}),r("dt",{children:"Updated:"}),r("dd",{children:new Date(n.updatedTs).toLocaleString()})]})})]})}function ka({selectedGid:t,onClose:e}){return t?r(Oa,{gid:t,onClose:e}):r("div",{className:"page-preview-panel-empty",children:r("p",{children:"Select a search result to preview the page"})})}function xa({config:t,children:e}){return r("div",{className:"layout-landing",children:[r("section",{className:"hero",children:[r("div",{className:"hero-content",children:[t.logo_asset&&r("img",{src:t.logo_asset,alt:"Logo",className:"hero-logo"}),r("h1",{className:"hero-title",children:t.hero_title||t.site_title||"Welcome"}),t.hero_subtitle&&r("p",{className:"hero-subtitle",children:t.hero_subtitle})]}),t.hero_image&&r("div",{className:"hero-background",style:{backgroundImage:`url(${t.hero_image})`}})]}),r("main",{className:"landing-main",children:e})]})}function Ia({config:t,navigation:e,currentPage:n,children:i}){const a=e.filter(o=>o.menu==="sidebar");return r("div",{className:"layout-docs",children:[r("aside",{className:"docs-sidebar",children:r("nav",{className:"docs-nav",children:[r("div",{className:"docs-nav-header",children:[t.logo_asset&&r("img",{src:t.logo_asset,alt:"Logo",className:"docs-logo"}),r("h3",{children:t.site_title||"Documentation"})]}),r("ul",{className:"docs-nav-list",children:a.map(o=>r("li",{className:"docs-nav-item",children:r("a",{href:`#${o.to_slug}`,className:(n==null?void 0:n.slug)===o.to_slug?"active":"",children:[o.icon_asset&&r("img",{src:o.icon_asset,alt:"",className:"nav-icon"}),o.label]})},o.to_slug))})]})}),r("main",{className:"docs-main",children:[n&&r("div",{className:"docs-breadcrumbs",children:[r("a",{href:"#/",children:"Home"}),n.category&&r(oe,{children:[r("span",{children:" / "}),r("span",{children:n.category})]}),r("span",{children:" / "}),r("span",{children:n.title})]}),r("article",{className:"docs-content",children:[n&&r("h1",{children:n.title}),i]})]})]})}function Dr({config:t,children:e}){return r("div",{className:"layout-dashboard",children:[r("header",{className:"dashboard-header",children:r("h1",{children:t.site_title||"Dashboard"})}),r("main",{className:"dashboard-content",children:e})]})}function Fr({config:t,title:e,children:n}){return r("div",{className:"layout-simple",children:[r("header",{className:"simple-header",children:[t.logo_asset&&r("img",{src:t.logo_asset,alt:"Logo",className:"simple-logo"}),e&&r("h1",{children:e})]}),r("main",{className:"simple-content",children:n}),r("footer",{className:"simple-footer",children:r("p",{children:"Powered by GlyphCase"})})]})}function Ma({topBar:t,leftSidebar:e,centerPanel:n,rightSidebar:i,showLeftSidebar:a=!0,showRightSidebar:o=!1}){return r("div",{className:"capsule-layout",children:[r("div",{className:"capsule-topbar",children:t}),r("div",{className:"capsule-content",children:[a&&e&&r("aside",{className:"capsule-sidebar capsule-sidebar-left",children:e}),r("main",{className:"capsule-main",children:n}),o&&i&&r("aside",{className:"capsule-sidebar capsule-sidebar-right",children:i})]})]})}function Da({capsuleName:t,onClose:e,actions:n}){return r("div",{className:"topbar-content",children:[r("div",{className:"topbar-left",children:r("h2",{className:"topbar-title",children:[" ",t]})}),r("div",{className:"topbar-right",children:[n,e&&r("button",{className:"btn-secondary btn-sm",onClick:e,children:"Close Capsule"})]})]})}function Fa({title:t,children:e,onClear:n,hasActiveFilters:i=!1}){return r("div",{className:"filter-panel",children:[r("div",{className:"filter-panel-header",children:[r("h3",{children:t}),i&&n&&r("button",{className:"btn-link btn-sm",onClick:n,children:"Clear All"})]}),r("div",{className:"filter-panel-content",children:e})]})}function Pa({limit:t=50}){const[e,n]=N([]),[i,a]=N(!1),[o,s]=N(null);j(()=>{l()},[t]);const l=async()=>{if(!$.isDynamic()){n([]);return}a(!0),s(null);try{const p=$.getEnvelope();if(!p.isOpen()){n([]);return}const m=p.getRecentActivity(t);n(m)}catch(p){s(String(p)),console.error("[EnvelopeTimeline] Failed to load:",p)}finally{a(!1)}},u=p=>{switch(p){case"retrieval":return"";case"feedback":return"";case"summary":return"";default:return""}},c=p=>{switch(p){case"retrieval":return"timeline-event-retrieval";case"feedback":return"timeline-event-feedback";case"summary":return"timeline-event-summary";default:return""}},f=p=>p===null?"":p===1?" Helpful":p===-1?" Not helpful":" Neutral",d=p=>{try{const m=new Date(p),E=new Date().getTime()-m.getTime(),v=Math.floor(E/6e4);if(v<1)return"Just now";if(v<60)return`${v}m ago`;const _=Math.floor(v/60);if(_<24)return`${_}h ago`;const y=Math.floor(_/24);return y<7?`${y}d ago`:m.toLocaleDateString()}catch{return p}};return $.isDynamic()?i?r("div",{className:"envelope-timeline",children:r("div",{className:"timeline-loading",children:[r("div",{className:"spinner"}),r("p",{children:"Loading timeline..."})]})}):o?r("div",{className:"envelope-timeline",children:r("div",{className:"timeline-error",children:[r("p",{children:" Failed to load timeline"}),r("p",{className:"error-message",children:o}),r("button",{className:"btn-secondary btn-sm",onClick:l,children:"Retry"})]})}):e.length===0?r("div",{className:"envelope-timeline",children:r("div",{className:"timeline-empty",children:[r("p",{children:"No activity yet."}),r("p",{className:"timeline-hint",children:"Search, give feedback, or generate summaries to populate the timeline."})]})}):r("div",{className:"envelope-timeline",children:[r("div",{className:"timeline-header",children:[r("h3",{children:" Activity Timeline"}),r("span",{className:"timeline-count",children:[e.length," events"]})]}),r("div",{className:"timeline-events",children:e.map((p,m)=>r("div",{className:`timeline-event ${c(p.eventType)}`,children:[r("div",{className:"timeline-event-icon",children:u(p.eventType)}),r("div",{className:"timeline-event-content",children:[r("div",{className:"timeline-event-header",children:[r("span",{className:"timeline-event-type",children:p.eventType.charAt(0).toUpperCase()+p.eventType.slice(1)}),r("span",{className:"timeline-event-time",children:d(p.timestamp)})]}),r("div",{className:"timeline-event-description",children:p.description}),p.eventType==="feedback"&&p.value!==null&&r("div",{className:"timeline-event-meta",children:f(p.value)}),p.eventType==="summary"&&p.value!==null&&r("div",{className:"timeline-event-meta",children:["Relevance: ",(p.value*100).toFixed(0),"%"]})]})]},`${p.id}-${m}`))}),r("div",{className:"timeline-footer",children:r("button",{className:"btn-secondary btn-sm",onClick:l,children:"Refresh Timeline"})})]}):r("div",{className:"envelope-timeline",children:r("div",{className:"timeline-empty",children:[r("p",{children:"Timeline is only available in Dynamic mode."}),r("p",{className:"timeline-hint",children:"Enable Dynamic mode to start tracking activity."})]})})}class Le extends Je{constructor(n){super(n);A(this,"reset",()=>{this.setState({hasError:!1,error:null})});this.state={hasError:!1,error:null}}static getDerivedStateFromError(n){return{hasError:!0,error:n}}componentDidCatch(n,i){const{name:a="Unknown"}=this.props;console.error(`[ErrorBoundary:${a}]`,n,i)}render(){const{hasError:n,error:i}=this.state,{children:a,fallback:o,name:s="Component"}=this.props;return n&&i?o?o(i,this.reset):r("div",{className:"error-boundary",children:r("div",{className:"error-boundary-content",children:[r("h3",{children:[" ",s," Error"]}),r("p",{className:"error-message",children:i.message}),r("button",{className:"btn-secondary",onClick:this.reset,children:"Try Again"}),!1]})}):a}}function $a({capsuleInfo:t,onClose:e}){var B,q;const[n,i]=N("search"),[a,o]=N(null),[s,l]=N(!1),[u,c]=N(!1),f=Ar({defaultMode:"fts"}),d=Ir({autoLoad:!0}),p=pa({maxHops:2,limit:50}),m=_a({autoLoadCheckpoints:!0}),g=Mr({}),E=Sa();Na({onFocusSearch:()=>{const I=document.querySelector('input[name="query"]');I==null||I.focus(),I==null||I.select()},onToggleLlm:()=>{g.toggle()},onEscape:()=>{document.activeElement instanceof HTMLElement&&document.activeElement.blur()}});const v=I=>{o(I)},_=I=>{p.navigateToNode(I),o(I)},y=I=>{i("graph"),p.loadGraph(I),o(I)},T=()=>{f.clearFilter(),f.lastQuery&&f.search(f.lastQuery)},S=()=>{a&&(m.verifyPage(a),l(!0))},L=async()=>{g.enabled&&f.results&&f.results.length>0&&f.lastQuery&&(g.clearReasoning(),await g.reason(f.lastQuery,f.results,1500))};j(()=>{g.enabled&&f.results&&f.results.length>0&&f.lastQuery&&(!g.reasoning||g.reasoning.usedSnippets.length===0)&&L()},[g.enabled,f.results,f.lastQuery]);const R=!!(f.entityFilter.entityType||f.entityFilter.entityValue);return r(Ma,{topBar:r(Da,{capsuleName:t.fileName,onClose:e,actions:r(oe,{children:[r("div",{className:"capsule-stats",children:[r("span",{children:[t.pageCount," pages"]}),r("span",{children:[t.entityCount," entities"]}),r("span",{children:[t.edgeCount," edges"]})]}),r(wa,{modality:E.modality,envelopeStats:E.envelopeStats,envelopeExtracted:(B=E.info)==null?void 0:B.envelopeExtracted,onEnableDynamic:E.enableDynamicMode,onSaveGlyphCase:async()=>{var k;const I=await E.saveGlyphCase(),he=URL.createObjectURL(I),M=document.createElement("a");M.href=he;const re=E.modality==="dynamic"?".gcase+":".gcase",F=(((k=E.info)==null?void 0:k.fileName)||"glyphcase").replace(/\.(db|gcase|gcase\+)$/,"");M.download=`${F}${re}`,M.click(),URL.revokeObjectURL(he)},onClearEnvelope:E.clearEnvelope,onVerifyEnvelope:async()=>{const I=await E.verifyEnvelope();I&&(I.valid?alert(` Envelope integrity verified!

The hash chain is intact.`):alert(` Envelope integrity check failed:

${I.errors.join(`
`)}`))}}),r("button",{className:`btn-secondary btn-sm ${g.enabled?"active":""}`,onClick:g.toggle,disabled:g.loading,title:(q=g.modelInfo)!=null&&q.loaded?"LLM Ready":"Click to load LLM",children:[" ",g.enabled?"LLM On":"LLM Off"]}),r("button",{className:`btn-secondary btn-sm ${s?"active":""}`,onClick:()=>l(!s),children:[s?"":""," Provenance"]}),E.isDynamic&&r("button",{className:`btn-secondary btn-sm ${u?"active":""}`,onClick:()=>c(!u),children:[u?"":""," Timeline"]})]})}),leftSidebar:r(Le,{name:"EntityPanel",children:r(Fa,{title:"Entity Filters",onClear:T,hasActiveFilters:R,children:[R&&r("div",{className:"active-filters",children:[r("p",{className:"filter-label",children:"Active Filter:"}),f.entityFilter.entityType&&r("span",{className:"filter-tag",children:["Type: ",f.entityFilter.entityType]}),f.entityFilter.entityValue&&r("span",{className:"filter-tag",children:["Value: ",f.entityFilter.entityValue]})]}),r(ta,{entities:d.entities,types:d.types,selectedType:d.selectedType,totalCount:d.totalCount,onSelectType:d.selectType,getTypeCount:d.getTypeCount,show:!0,maxDisplay:20})]})}),centerPanel:r("div",{className:"capsule-center",children:[r("div",{className:"view-mode-tabs",children:[r("button",{className:`tab-btn ${n==="search"?"active":""}`,onClick:()=>i("search"),children:" Search"}),r("button",{className:`tab-btn ${n==="graph"?"active":""}`,onClick:()=>i("graph"),children:" Graph"})]}),n==="search"&&r(oe,{children:[r(Le,{name:"SearchPanel",children:r(Ki,{mode:f.mode,results:f.results,lastQuery:f.lastQuery,loading:f.loading,onSearch:f.search,onModeChange:f.changeMode,onResultClick:v,showModeToggle:!0,placeholder:"Search the capsule...",searchHint:'Try: "vector search", "LEANN", "SQLite", or "hybrid retrieval"',searchHistory:f.searchHistory,onClearHistory:f.clearHistory})}),r(Le,{name:"LLM",children:[g.enabled&&f.results&&f.results.length>0&&r("div",{className:"llm-section",children:[r("div",{className:"llm-temperature-control",children:[r("label",{htmlFor:"temperature-slider",className:"temperature-label",children:["Creativity:",r("input",{id:"temperature-slider",type:"range",min:"0",max:"1",step:"0.1",value:g.temperature,onChange:I=>g.setTemperature(parseFloat(I.currentTarget.value)),className:"temperature-slider"}),r("span",{className:"temperature-value",children:g.temperature.toFixed(1)})]}),r("small",{className:"temperature-hint",children:[g.temperature<.3&&" Very factual",g.temperature>=.3&&g.temperature<.6&&" Mostly factual",g.temperature>=.6&&g.temperature<.8&&" Balanced",g.temperature>=.8&&" Creative"]})]}),g.progress&&r("div",{className:"llm-progress-bar",children:[r("div",{className:"llm-progress-info",children:[r("span",{children:[" ",g.progress.message]}),r("span",{children:[(g.progress.progress*100).toFixed(0),"%"]})]}),r("div",{className:"llm-progress-track",children:r("div",{className:"llm-progress-fill",style:{width:`${g.progress.progress*100}%`}})})]}),g.isStreaming&&g.streamingText&&r("div",{className:"streaming-output",children:[r("div",{className:"streaming-header",children:[r("span",{className:"streaming-indicator",children:" Streaming..."}),r("button",{className:"btn-secondary btn-sm abort-btn",onClick:()=>g.abortReasoning(),title:"Stop reasoning",children:" Stop"})]}),r("div",{className:"streaming-text",children:[g.streamingText,r("span",{className:"streaming-cursor",children:""})]})]}),g.reasoning&&r(ia,{reasoning:g.reasoning,searchResults:f.results,loading:g.loading}),g.loading&&!g.reasoning&&!g.progress&&!g.isStreaming&&r("div",{className:"reasoning-loading",children:[r("div",{className:"spinner"}),r("p",{children:"LLM is reasoning over search results..."}),g.elapsedTime>0&&r("p",{className:"inference-time",children:["Elapsed: ",g.elapsedTime.toFixed(1),"s",g.elapsedTime>3&&"  Typically takes 2-5s"]})]}),g.error&&r("div",{className:"llm-error-panel",children:[r("strong",{children:" LLM Error:"})," ",g.error,r("button",{className:"btn-secondary btn-sm",onClick:L,disabled:g.loading,style:{marginLeft:"1rem"},children:g.loading?"Retrying...":"Try Again"})]})]}),g.enabled&&(!f.results||f.results.length===0)&&f.lastQuery&&r("div",{className:"llm-no-results",children:r("p",{children:" LLM needs search results to reason. Try searching first!"})})]})]}),n==="graph"&&r(Le,{name:"GraphPanel",children:r("div",{className:"graph-view-container",children:[!p.graphData&&r("div",{className:"graph-view-empty",children:[r("p",{children:"Select a search result to explore its graph connections"}),r("p",{className:"hint",children:"Or switch to Search tab to find pages"})]}),p.graphData&&r(oe,{children:[r(ya,{nodeCount:p.nodeCount,edgeCount:p.edgeCount,predicateCount:p.predicates.length,seedNode:p.seedGid||void 0}),r(ga,{predicates:p.predicates,selectedPredicate:p.predicate,onPredicateChange:p.filterByPredicate,onReset:p.clear}),r(ma,{nodes:p.graphData.nodes,edges:p.graphData.edges,seedGid:p.seedGid||void 0,onNodeClick:_,loading:p.loading,error:p.error})]})]})}),a&&r(Le,{name:"PagePreview",children:r("div",{className:"page-preview-section",children:[r("div",{className:"page-preview-header-actions",children:[r("h3",{children:"Page Preview"}),r("div",{className:"page-preview-actions",children:[n==="search"&&r("button",{className:"btn-secondary btn-sm",onClick:()=>y(a),children:"Explore Graph"}),r("button",{className:"btn-primary btn-sm",onClick:S,disabled:m.verifying,children:m.verifying?"Verifying...":"Verify Page"})]})]}),r(ka,{selectedGid:a,onClose:()=>o(null)})]})})]}),rightSidebar:r(oe,{children:[s&&r(Le,{name:"ProvenancePanel",children:r(Ta,{checkpoints:m.checkpoints,verificationResult:m.verificationResult,loading:m.loading,verifying:m.verifying,error:m.error,onVerify:S})}),u&&E.isDynamic&&r(Le,{name:"EnvelopeTimeline",children:r(Pa,{limit:100})})]}),showLeftSidebar:!0,showRightSidebar:s||u})}async function Ua(t){const n=(await t.query("SELECT name FROM sqlite_master WHERE type='table'")).map(p=>p.name),i=n.includes("_ui_pages"),a=n.includes("_ui_dashboards"),o=n.includes("_ui_navigation"),s=n.includes("_ui_params"),l=n.includes("_meta_manifest"),u=n.includes("sqlar"),c=n.some(p=>p.startsWith("fts_"));let f="1.0";if(l)try{const p=await t.query("SELECT value FROM _meta_manifest WHERE key='gcui'");p.length>0&&(f=p[0].value)}catch(p){console.warn("Failed to read GCUI version:",p)}let d;return i&&a?d="hybrid":i?d="website":a?d="dashboard":d="generic",{version:f,hasWebsite:i,hasDashboards:a,hasNavigation:o,hasParams:s,hasFTS:c,hasAssets:u,mode:d}}async function Ha(t){try{const e=await t.query("SELECT key, value FROM _meta_manifest");if(e.length===0)return null;const n={gcui:"1.0",capsule_kind:"sqlar"};return e.forEach(i=>{n[i.key]=i.value}),n}catch(e){return console.warn("Failed to load manifest:",e),null}}async function qa(t){try{const e=await t.query("SELECT key, value FROM _ui_config"),n={};return e.forEach(i=>{n[i.key]=i.value}),n}catch(e){return console.warn("Failed to load config:",e),{}}}async function Ga(t){try{return(await t.query("SELECT slug, title, content, layout, category, order_index FROM _ui_pages ORDER BY order_index ASC, slug ASC")).map(n=>({slug:n.slug,title:n.title,content:n.content||void 0,layout:n.layout||void 0,category:n.category||void 0,order_index:n.order_index||void 0}))}catch(e){return console.warn("Failed to load pages:",e),[]}}async function Ba(t){try{return(await t.query("SELECT menu, label, to_slug, order_index, icon_asset FROM _ui_navigation ORDER BY menu, order_index ASC")).map(n=>({menu:n.menu,label:n.label,to_slug:n.to_slug,order_index:n.order_index||void 0,icon_asset:n.icon_asset||void 0}))}catch(e){return console.warn("Failed to load navigation:",e),[]}}async function za(t){try{return(await t.query("SELECT name, query, grammar, config FROM _ui_dashboards")).map(n=>({name:n.name,query:n.query,grammar:n.grammar||void 0,config:n.config||void 0}))}catch(e){return console.warn("Failed to load dashboards:",e),[]}}async function Wa(t){const e=await Ua(t),n=await Ha(t)||{gcui:e.version,capsule_kind:"sqlar"},i=await qa(t),a=e.hasWebsite?await Ga(t):[],o=e.hasNavigation?await Ba(t):[],s=e.hasDashboards?await za(t):[];return{manifest:n,capabilities:e,config:i,pages:a,navigation:o,dashboards:s}}function Xa({data:t,config:e,width:n=600,height:i=400}){if(!t||t.length===0)return r("div",{className:"chart-empty",style:{width:n,height:i},children:r("p",{children:"No data to display"})});switch(e.mark){case"bar":return r(Va,{data:t,config:e,width:n,height:i});case"line":return r(Ya,{data:t,config:e,width:n,height:i});case"point":return r(Qa,{data:t,config:e,width:n,height:i});case"area":return r(ja,{data:t,config:e,width:n,height:i});default:return r("div",{className:"chart-unsupported",style:{width:n,height:i},children:[r("p",{children:["Unsupported chart type: ",e.mark]}),r("p",{children:"Showing data as table:"}),r(Ja,{data:t})]})}}function Va({data:t,config:e,width:n,height:i}){var c,f;const{encoding:a}=e,o=((c=a.x)==null?void 0:c.field)||Object.keys(t[0])[0],s=((f=a.y)==null?void 0:f.field)||Object.keys(t[0])[1],l=Math.max(...t.map(d=>Number(d[s])||0)),u=Math.max(20,(n-100)/t.length-10);return r("div",{className:"chart chart-bar",style:{width:n,height:i},children:[e.title&&r("h4",{className:"chart-title",children:e.title}),r("div",{className:"chart-container",style:{height:i-60},children:r("div",{className:"chart-bars",style:{display:"flex",alignItems:"flex-end",height:"100%",gap:"8px"},children:t.map((d,p)=>{const m=Number(d[s])||0,g=m/l*(i-100);return r("div",{className:"chart-bar-item",style:{textAlign:"center"},children:[r("div",{className:"bar",style:{width:u,height:g,backgroundColor:"#6366f1",borderRadius:"4px 4px 0 0"},title:`${d[o]}: ${m}`}),r("div",{className:"bar-label",style:{fontSize:"12px",marginTop:"4px",maxWidth:u,overflow:"hidden",textOverflow:"ellipsis"},children:String(d[o]).slice(0,10)})]},p)})})}),r("div",{className:"chart-legend",style:{fontSize:"12px",marginTop:"8px",textAlign:"center"},children:[r("strong",{children:s})," by ",r("strong",{children:o})]})]})}function Ya({data:t,config:e,width:n,height:i}){var v,_;const{encoding:a}=e,o=((v=a.x)==null?void 0:v.field)||Object.keys(t[0])[0],s=((_=a.y)==null?void 0:_.field)||Object.keys(t[0])[1],l=t.map(y=>Number(y[s])||0),u=Math.max(...l),c=Math.min(...l),f=u-c||1,d=n-80,p=i-100,m=d/(t.length-1||1),g=t.map((y,T)=>{const S=40+T*m,L=Number(y[s])||0,R=p-(L-c)/f*p+20;return{x:S,y:R,value:L,label:y[o]}}),E=g.map((y,T)=>`${T===0?"M":"L"} ${y.x} ${y.y}`).join(" ");return r("div",{className:"chart chart-line",style:{width:n,height:i},children:[e.title&&r("h4",{className:"chart-title",children:e.title}),r("svg",{width:n,height:i-40,style:{overflow:"visible"},children:[[0,.25,.5,.75,1].map(y=>{const T=p-y*p+20,S=c+y*f;return r("g",{children:[r("line",{x1:40,y1:T,x2:n-40,y2:T,stroke:"#e5e7eb",strokeWidth:1}),r("text",{x:10,y:T+4,fontSize:10,fill:"#666",children:S.toFixed(0)})]},y)}),r("path",{d:E,fill:"none",stroke:"#6366f1",strokeWidth:2}),g.map((y,T)=>r("circle",{cx:y.x,cy:y.y,r:4,fill:"#6366f1",children:r("title",{children:`${y.label}: ${y.value}`})},T)),g.map((y,T)=>r("text",{x:y.x,y:p+40,fontSize:10,fill:"#666",textAnchor:"middle",children:String(y.label).slice(0,8)},T))]}),r("div",{className:"chart-legend",style:{fontSize:"12px",textAlign:"center"},children:[r("strong",{children:s})," over ",r("strong",{children:o})]})]})}function Qa({data:t,config:e,width:n,height:i}){var _,y;const{encoding:a}=e,o=((_=a.x)==null?void 0:_.field)||Object.keys(t[0])[0],s=((y=a.y)==null?void 0:y.field)||Object.keys(t[0])[1],l=t.map(T=>Number(T[o])||0),u=t.map(T=>Number(T[s])||0),c=Math.min(...l),f=Math.max(...l),d=Math.min(...u),p=Math.max(...u),m=f-c||1,g=p-d||1,E=n-80,v=i-100;return r("div",{className:"chart chart-scatter",style:{width:n,height:i},children:[e.title&&r("h4",{className:"chart-title",children:e.title}),r("svg",{width:n,height:i-40,children:[[0,.25,.5,.75,1].map(T=>{const S=v-T*v+20;return r("line",{x1:40,y1:S,x2:n-40,y2:S,stroke:"#e5e7eb",strokeWidth:1},T)}),t.map((T,S)=>{const L=Number(T[o])||0,R=Number(T[s])||0,B=40+(L-c)/m*E,q=v-(R-d)/g*v+20;return r("circle",{cx:B,cy:q,r:5,fill:"#6366f1",opacity:.7,children:r("title",{children:`${o}: ${L}, ${s}: ${R}`})},S)})]}),r("div",{className:"chart-legend",style:{fontSize:"12px",textAlign:"center"},children:[r("strong",{children:s})," vs ",r("strong",{children:o})]})]})}function ja({data:t,config:e,width:n,height:i}){var _,y;const{encoding:a}=e,o=((_=a.x)==null?void 0:_.field)||Object.keys(t[0])[0],s=((y=a.y)==null?void 0:y.field)||Object.keys(t[0])[1],l=t.map(T=>Number(T[s])||0),u=Math.max(...l),c=Math.min(...l),f=u-c||1,d=n-80,p=i-100,m=d/(t.length-1||1),E=t.map((T,S)=>{const L=40+S*m,R=Number(T[s])||0,B=p-(R-c)/f*p+20;return{x:L,y:B}}).map((T,S)=>`${S===0?"M":"L"} ${T.x} ${T.y}`).join(" "),v=`${E} L ${n-40} ${p+20} L 40 ${p+20} Z`;return r("div",{className:"chart chart-area",style:{width:n,height:i},children:[e.title&&r("h4",{className:"chart-title",children:e.title}),r("svg",{width:n,height:i-40,children:[r("path",{d:v,fill:"#6366f1",opacity:.3}),r("path",{d:E,fill:"none",stroke:"#6366f1",strokeWidth:2})]}),r("div",{className:"chart-legend",style:{fontSize:"12px",textAlign:"center"},children:[r("strong",{children:s})," over ",r("strong",{children:o})]})]})}function Ja({data:t}){if(t.length===0)return null;const e=Object.keys(t[0]);return r("table",{className:"data-table",style:{width:"100%",borderCollapse:"collapse",fontSize:"12px"},children:[r("thead",{children:r("tr",{children:e.map(n=>r("th",{style:{borderBottom:"2px solid #ddd",padding:"8px",textAlign:"left"},children:n},n))})}),r("tbody",{children:t.slice(0,10).map((n,i)=>r("tr",{children:e.map(a=>r("td",{style:{borderBottom:"1px solid #eee",padding:"6px"},children:String(n[a])},a))},i))})]})}function Pr({dashboards:t}){return t.length===0?r("div",{className:"dashboard-empty",children:r("p",{children:"No dashboards defined"})}):r("div",{className:"dashboard-grid",children:t.map(e=>r(Ka,{dashboard:e},e.name))})}function Ka({dashboard:t}){const[e,n]=N(null),[i,a]=N(!1),[o,s]=N(null);j(()=>{l()},[t.query]);const l=async()=>{a(!0),s(null);try{const f=await le().query(t.query);n(f)}catch(c){s(String(c)),console.error(`[Dashboard] Failed to load ${t.name}:`,c)}finally{a(!1)}};if(i)return r("div",{className:"dashboard-panel loading",children:[r("div",{className:"spinner"}),r("p",{children:["Loading ",t.name,"..."]})]});if(o)return r("div",{className:"dashboard-panel error",children:[r("h4",{children:t.name}),r("p",{className:"error-message",children:["Error: ",o]}),r("details",{children:[r("summary",{children:"Query"}),r("pre",{children:t.query})]})]});if(!e||e.length===0)return r("div",{className:"dashboard-panel empty",children:[r("h4",{children:t.name}),r("p",{children:"No data"})]});let u=null;if(t.config)try{u=JSON.parse(t.config)}catch(c){console.error(`[Dashboard] Invalid config for ${t.name}:`,c)}return!u||t.grammar!=="vegalite-lite-v1"?r("div",{className:"dashboard-panel table",children:[r("h4",{children:t.name}),r(Za,{data:e})]}):r("div",{className:"dashboard-panel chart",children:r(Xa,{data:e,config:u,width:600,height:400})})}function Za({data:t}){const e=Object.keys(t[0]||{});return r("div",{style:{overflowX:"auto"},children:r("table",{className:"dashboard-table",style:{width:"100%",borderCollapse:"collapse",fontSize:"14px"},children:[r("thead",{children:r("tr",{children:e.map(n=>r("th",{style:{borderBottom:"2px solid #ddd",padding:"12px",textAlign:"left",fontWeight:600},children:n},n))})}),r("tbody",{children:t.map((n,i)=>r("tr",{style:{borderBottom:"1px solid #eee"},children:e.map(a=>r("td",{style:{padding:"10px"},children:String(n[a])},a))},i))})]})})}function es({content:t}){const e=ts(t),n=yn.sanitize(e,{ALLOWED_TAGS:["h1","h2","h3","h4","h5","h6","p","br","strong","em","code","pre","a","ul","ol","li"],ALLOWED_ATTR:["href"],ALLOW_DATA_ATTR:!1});return r("div",{className:"markdown-content",dangerouslySetInnerHTML:{__html:n}})}function ts(t){let e=t;return e=e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;"),e=e.replace(/^### (.*$)/gim,"<h3>$1</h3>"),e=e.replace(/^## (.*$)/gim,"<h2>$1</h2>"),e=e.replace(/^# (.*$)/gim,"<h1>$1</h1>"),e=e.replace(/\*\*(.*?)\*\*/g,"<strong>$1</strong>"),e=e.replace(/\*(.*?)\*/g,"<em>$1</em>"),e=e.replace(/`(.*?)`/g,"<code>$1</code>"),e=e.replace(/\[(.*?)\]\((.*?)\)/g,'<a href="$2">$1</a>'),e=e.replace(/```(.*?)\n([\s\S]*?)```/g,"<pre><code>$2</code></pre>"),e=e.replace(/^\- (.*$)/gim,"<li>$1</li>"),e=e.replace(/(<li>.*<\/li>)/s,"<ul>$1</ul>"),e=e.replace(/^\d+\. (.*$)/gim,"<li>$1</li>"),e=e.split(`

`).map(i=>i.startsWith("<h")||i.startsWith("<ul>")||i.startsWith("<ol>")||i.startsWith("<pre>")||i.startsWith("<li>")?i:`<p>${i}</p>`).join(`
`),e=e.replace(/\n/g,"<br>"),e}function ns({context:t}){const[e,n]=N("/");j(()=>{const a=()=>{const o=window.location.hash.slice(1);n(o||"/")};return window.addEventListener("hashchange",a),a(),()=>window.removeEventListener("hashchange",a)},[]);const i=t.pages.find(a=>a.slug===e)||t.pages[0];return i?r(rs,{page:i,context:t}):t.dashboards.length>0?r(Dr,{config:t.config,children:r(Pr,{dashboards:t.dashboards})}):r(Fr,{config:t.config,title:"404 Not Found",children:[r("p",{children:["Page not found: ",e]}),r("p",{children:r("a",{href:"#/",children:"Go home"})})]})}function rs({page:t,context:e}){const n=t.layout||"simple",i=t.content?r(es,{content:t.content}):r("p",{children:"No content"});switch(n){case"landing":return r(xa,{config:e.config,children:i});case"docs":return r(Ia,{config:e.config,navigation:e.navigation,currentPage:t,children:i});case"dashboard":return r(Dr,{config:e.config,children:[i,e.dashboards.length>0&&r(Pr,{dashboards:e.dashboards})]});case"simple":default:return r(Fr,{config:e.config,title:t.title,children:i})}}const is={mode:"website",bundledCapsule:"/memglyph-demo.mgx.sqlite",branding:{title:"Memglyph",tagline:"Your knowledge, crystallized",logoUrl:"/logo.svg"},features:{llm:{enabled:!0,autoReason:!1,defaultModel:"qwen3-0.6b",maxTokens:256},search:{defaultMode:"hybrid",enabledModes:["fts","hybrid"],showModeToggle:!1},graph:{enabled:!0,maxHops:2,defaultMaxHops:1},upload:{enabled:!1,acceptedExtensions:[]},gcui:{enabled:!0,fallbackToGeneric:!1},pwa:{enabled:!0,offlineMode:!0}},ui:{showLanding:!0,theme:"documentation"}},as={mode:"viewer",bundledCapsule:"/memglyph-demo.mgx.sqlite",branding:{title:"SQLAR Viewer",tagline:"Query your knowledge capsules",logoUrl:"/sqlar-logo.svg"},features:{llm:{enabled:!0,autoReason:!1,defaultModel:"qwen3-0.6b",maxTokens:256},search:{defaultMode:"hybrid",enabledModes:["fts","hybrid","graph"],showModeToggle:!0},graph:{enabled:!0,maxHops:3,defaultMaxHops:2},upload:{enabled:!0,acceptedExtensions:[".sqlite",".sqlar",".db",".mgx.sqlite"]},gcui:{enabled:!0,fallbackToGeneric:!0},pwa:{enabled:!0,offlineMode:!0}},ui:{showLanding:!1,theme:"tool"}};function ss(){return"website"}function os(){return ss()==="viewer"?as:is}function ls(t){return typeof t=="function"?t:cs(t)}function cs(t){if(t==null)return()=>!1;if(t==="fatal")return e=>e.level==="fatal";if(t==="error")return e=>e.level==="fatal"||e.level==="error";if(t==="warning")return e=>e.level==="fatal"||e.level==="error"||e.level==="warning";if(t==="info")return e=>e.level==="fatal"||e.level==="error"||e.level==="warning"||e.level==="info";if(t==="debug")return e=>e.level==="fatal"||e.level==="error"||e.level==="warning"||e.level==="info"||e.level==="debug";if(t==="trace")return()=>!0;throw new TypeError(`Invalid log level: ${t}.`)}const or=["trace","debug","info","warning","error","fatal"];function lr(t,e){const n=or.indexOf(t);if(n<0)throw new TypeError(`Invalid log level: ${JSON.stringify(t)}.`);const i=or.indexOf(e);if(i<0)throw new TypeError(`Invalid log level: ${JSON.stringify(e)}.`);return n-i}const jt=Symbol.for("logtape.rootLogger");var et=class be{constructor(e,n){A(this,"parent");A(this,"children");A(this,"category");A(this,"sinks");A(this,"parentSinks","inherit");A(this,"filters");A(this,"lowestLevel","trace");A(this,"contextLocalStorage");this.parent=e,this.children={},this.category=n,this.sinks=[],this.filters=[]}static getLogger(e=[]){let n=jt in globalThis?globalThis[jt]??null:null;return n==null&&(n=new be(null,[]),globalThis[jt]=n),typeof e=="string"?n.getChild(e):e.length===0?n:n.getChild(e)}getChild(e){const n=typeof e=="string"?e:e[0],i=this.children[n];let a=i instanceof be?i:i==null?void 0:i.deref();return a==null&&(a=new be(this,[...this.category,n]),this.children[n]="WeakRef"in globalThis?new WeakRef(a):a),typeof e=="string"||e.length===1?a:a.getChild(e.slice(1))}reset(){for(;this.sinks.length>0;)this.sinks.shift();for(this.parentSinks="inherit";this.filters.length>0;)this.filters.shift();this.lowestLevel="trace"}resetDescendants(){for(const e of Object.values(this.children)){const n=e instanceof be?e:e.deref();n!=null&&n.resetDescendants()}this.reset()}with(e){return new ds(this,{...e})}filter(e){var n;for(const i of this.filters)if(!i(e))return!1;return this.filters.length<1?((n=this.parent)==null?void 0:n.filter(e))??!0:!0}*getSinks(e){if(!(this.lowestLevel===null||lr(e,this.lowestLevel)<0)){if(this.parent!=null&&this.parentSinks==="inherit")for(const n of this.parent.getSinks(e))yield n;for(const n of this.sinks)yield n}}emit(e,n){const i="category"in e?e:{...e,category:this.category};if(!(this.lowestLevel===null||lr(i.level,this.lowestLevel)<0||!this.filter(i))){for(const a of this.getSinks(i.level))if(!(n!=null&&n.has(a)))try{a(i)}catch(o){const s=new Set(n);s.add(a),us.log("fatal","Failed to emit a log record to sink {sink}: {error}",{sink:a,error:o,record:i},s)}}}log(e,n,i,a){var u;const o=((u=be.getLogger().contextLocalStorage)==null?void 0:u.getStore())??{};let s;const l=typeof i=="function"?{category:this.category,level:e,timestamp:Date.now(),get message(){return cr(n,this.properties)},rawMessage:n,get properties(){return s==null&&(s={...o,...i()}),s}}:{category:this.category,level:e,timestamp:Date.now(),message:cr(n,{...o,...i}),rawMessage:n,properties:{...o,...i}};this.emit(l,a)}logLazily(e,n,i={}){var u;const a=((u=be.getLogger().contextLocalStorage)==null?void 0:u.getStore())??{};let o,s;function l(){if((s==null||o==null)&&(s=n((c,...f)=>(o=c,dr(c,f))),o==null))throw new TypeError("No log record was made.");return[s,o]}this.emit({category:this.category,level:e,get message(){return l()[0]},get rawMessage(){return l()[1]},timestamp:Date.now(),properties:{...a,...i}})}logTemplate(e,n,i,a={}){var s;const o=((s=be.getLogger().contextLocalStorage)==null?void 0:s.getStore())??{};this.emit({category:this.category,level:e,message:dr(n,i),rawMessage:n,timestamp:Date.now(),properties:{...o,...a}})}trace(e,...n){typeof e=="string"?this.log("trace",e,n[0]??{}):typeof e=="function"?this.logLazily("trace",e):Array.isArray(e)?this.logTemplate("trace",e,n):this.log("trace","{*}",e)}debug(e,...n){typeof e=="string"?this.log("debug",e,n[0]??{}):typeof e=="function"?this.logLazily("debug",e):Array.isArray(e)?this.logTemplate("debug",e,n):this.log("debug","{*}",e)}info(e,...n){typeof e=="string"?this.log("info",e,n[0]??{}):typeof e=="function"?this.logLazily("info",e):Array.isArray(e)?this.logTemplate("info",e,n):this.log("info","{*}",e)}warn(e,...n){typeof e=="string"?this.log("warning",e,n[0]??{}):typeof e=="function"?this.logLazily("warning",e):Array.isArray(e)?this.logTemplate("warning",e,n):this.log("warning","{*}",e)}warning(e,...n){this.warn(e,...n)}error(e,...n){typeof e=="string"?this.log("error",e,n[0]??{}):typeof e=="function"?this.logLazily("error",e):Array.isArray(e)?this.logTemplate("error",e,n):this.log("error","{*}",e)}fatal(e,...n){typeof e=="string"?this.log("fatal",e,n[0]??{}):typeof e=="function"?this.logLazily("fatal",e):Array.isArray(e)?this.logTemplate("fatal",e,n):this.log("fatal","{*}",e)}},ds=class $r{constructor(e,n){A(this,"logger");A(this,"properties");this.logger=e,this.properties=n}get category(){return this.logger.category}get parent(){return this.logger.parent}getChild(e){return this.logger.getChild(e).with(this.properties)}with(e){return new $r(this.logger,{...this.properties,...e})}log(e,n,i,a){this.logger.log(e,n,typeof i=="function"?()=>({...this.properties,...i()}):{...this.properties,...i},a)}logLazily(e,n){this.logger.logLazily(e,n,this.properties)}logTemplate(e,n,i){this.logger.logTemplate(e,n,i,this.properties)}emit(e){const n={...e,properties:{...this.properties,...e.properties}};this.logger.emit(n)}trace(e,...n){typeof e=="string"?this.log("trace",e,n[0]??{}):typeof e=="function"?this.logLazily("trace",e):Array.isArray(e)?this.logTemplate("trace",e,n):this.log("trace","{*}",e)}debug(e,...n){typeof e=="string"?this.log("debug",e,n[0]??{}):typeof e=="function"?this.logLazily("debug",e):Array.isArray(e)?this.logTemplate("debug",e,n):this.log("debug","{*}",e)}info(e,...n){typeof e=="string"?this.log("info",e,n[0]??{}):typeof e=="function"?this.logLazily("info",e):Array.isArray(e)?this.logTemplate("info",e,n):this.log("info","{*}",e)}warn(e,...n){typeof e=="string"?this.log("warning",e,n[0]??{}):typeof e=="function"?this.logLazily("warning",e):Array.isArray(e)?this.logTemplate("warning",e,n):this.log("warning","{*}",e)}warning(e,...n){this.warn(e,...n)}error(e,...n){typeof e=="string"?this.log("error",e,n[0]??{}):typeof e=="function"?this.logLazily("error",e):Array.isArray(e)?this.logTemplate("error",e,n):this.log("error","{*}",e)}fatal(e,...n){typeof e=="string"?this.log("fatal",e,n[0]??{}):typeof e=="function"?this.logLazily("fatal",e):Array.isArray(e)?this.logTemplate("fatal",e,n):this.log("fatal","{*}",e)}};const us=et.getLogger(["logtape","meta"]);function hs(t){return t.includes(".")||t.includes("[")||t.includes("?.")}function ps(t,e){if(!(e==="__proto__"||e==="prototype"||e==="constructor")&&(typeof t=="object"||typeof t=="function")&&t!==null)return Object.prototype.hasOwnProperty.call(t,e)?t[e]:void 0}function fs(t,e){const n=t.length;let i=e;if(i>=n)return null;let a;if(t[i]==="["){if(i++,i>=n)return null;if(t[i]==='"'||t[i]==="'"){const o=t[i];i++;let s="";for(;i<n&&t[i]!==o;)if(t[i]==="\\"){if(i++,i<n){const l=t[i];switch(l){case"n":s+=`
`;break;case"t":s+="	";break;case"r":s+="\r";break;case"b":s+="\b";break;case"f":s+="\f";break;case"v":s+="\v";break;case"0":s+="\0";break;case"\\":s+="\\";break;case'"':s+='"';break;case"'":s+="'";break;case"u":if(i+4<n){const u=t.slice(i+1,i+5),c=Number.parseInt(u,16);Number.isNaN(c)?s+=l:(s+=String.fromCharCode(c),i+=4)}else s+=l;break;default:s+=l}i++}}else s+=t[i],i++;if(i>=n)return null;a=s,i++}else{const o=i;for(;i<n&&t[i]!=="]"&&t[i]!=="'"&&t[i]!=='"';)i++;if(i>=n)return null;const s=t.slice(o,i);if(s.length===0)return null;const l=Number(s);a=Number.isNaN(l)?s:l}for(;i<n&&t[i]!=="]";)i++;i<n&&i++}else{const o=i;for(;i<n&&t[i]!=="."&&t[i]!=="["&&t[i]!=="?"&&t[i]!=="]";)i++;if(a=t.slice(o,i),a.length===0)return null}return i<n&&t[i]==="."&&i++,{segment:a,nextIndex:i}}function ms(t,e){if(typeof e=="string")return ps(t,e);if(Array.isArray(t)&&e>=0&&e<t.length)return t[e]}function gs(t,e){if(t==null||e.length===0||e.endsWith("."))return;let n=t,i=0;const a=e.length;for(;i<a;){if(e.slice(i,i+2)==="?."){if(i+=2,n==null)return}else if(n==null)return;const s=fs(e,i);if(s===null)return;const{segment:l,nextIndex:u}=s;if(i=u,n=ms(n,l),n===void 0)return}return n}function cr(t,e){const n=t.length;if(n===0)return[""];if(!t.includes("{"))return[t];const i=[];let a=0;for(let s=0;s<n;s++){const l=t[s];if(l==="{"){if((s+1<n?t[s+1]:"")==="{"){s++;continue}const c=t.indexOf("}",s+1);if(c===-1)continue;const f=t.slice(a,s);i.push(f.replace(/{{/g,"{").replace(/}}/g,"}"));const d=t.slice(s+1,c);let p;const m=d.trim();m==="*"?p=d in e?e[d]:"*"in e?e["*"]:e:(d!==m?p=d in e?e[d]:e[m]:p=e[d],p===void 0&&hs(m)&&(p=gs(e,m))),i.push(p),s=c,a=s+1}else l==="}"&&s+1<n&&t[s+1]==="}"&&s++}const o=t.slice(a);return i.push(o.replace(/{{/g,"{").replace(/}}/g,"}")),i}function dr(t,e){const n=[];for(let i=0;i<t.length;i++)n.push(t[i]),i<e.length&&n.push(e[i]);return n}function dn(t,e){const n=(e==null?void 0:e.compact)===!0?void 0:2;return JSON.stringify(t,null,n)}const ys=Object.freeze(Object.defineProperty({__proto__:null,inspect:dn},Symbol.toStringTag,{value:"Module"})),Ur={trace:"TRC",debug:"DBG",info:"INF",warning:"WRN",error:"ERR",fatal:"FTL"},ur=typeof document<"u"||typeof navigator<"u"&&navigator.product==="ReactNative"?t=>JSON.stringify(t):"Deno"in globalThis&&"inspect"in globalThis.Deno&&typeof globalThis.Deno.inspect=="function"?(t,e)=>globalThis.Deno.inspect(t,{strAbbreviateSize:1/0,iterableLimit:1/0,...e}):ys!=null&&typeof dn=="function"?(t,e)=>dn(t,{...e}):t=>JSON.stringify(t);function P(t){return t<10?`0${t}`:`${t}`}function $e(t){return t<10?`00${t}`:t<100?`0${t}`:`${t}`}const yt={"date-time-timezone":t=>{const e=new Date(t),n=e.getUTCFullYear(),i=P(e.getUTCMonth()+1),a=P(e.getUTCDate()),o=P(e.getUTCHours()),s=P(e.getUTCMinutes()),l=P(e.getUTCSeconds()),u=$e(e.getUTCMilliseconds());return`${n}-${i}-${a} ${o}:${s}:${l}.${u} +00:00`},"date-time-tz":t=>{const e=new Date(t),n=e.getUTCFullYear(),i=P(e.getUTCMonth()+1),a=P(e.getUTCDate()),o=P(e.getUTCHours()),s=P(e.getUTCMinutes()),l=P(e.getUTCSeconds()),u=$e(e.getUTCMilliseconds());return`${n}-${i}-${a} ${o}:${s}:${l}.${u} +00`},"date-time":t=>{const e=new Date(t),n=e.getUTCFullYear(),i=P(e.getUTCMonth()+1),a=P(e.getUTCDate()),o=P(e.getUTCHours()),s=P(e.getUTCMinutes()),l=P(e.getUTCSeconds()),u=$e(e.getUTCMilliseconds());return`${n}-${i}-${a} ${o}:${s}:${l}.${u}`},"time-timezone":t=>{const e=new Date(t),n=P(e.getUTCHours()),i=P(e.getUTCMinutes()),a=P(e.getUTCSeconds()),o=$e(e.getUTCMilliseconds());return`${n}:${i}:${a}.${o} +00:00`},"time-tz":t=>{const e=new Date(t),n=P(e.getUTCHours()),i=P(e.getUTCMinutes()),a=P(e.getUTCSeconds()),o=$e(e.getUTCMilliseconds());return`${n}:${i}:${a}.${o} +00`},time:t=>{const e=new Date(t),n=P(e.getUTCHours()),i=P(e.getUTCMinutes()),a=P(e.getUTCSeconds()),o=$e(e.getUTCMilliseconds());return`${n}:${i}:${a}.${o}`},date:t=>{const e=new Date(t),n=e.getUTCFullYear(),i=P(e.getUTCMonth()+1),a=P(e.getUTCDate());return`${n}-${i}-${a}`},rfc3339:t=>new Date(t).toISOString(),none:()=>null},Ue={ABBR:Ur,abbr:{trace:"trc",debug:"dbg",info:"inf",warning:"wrn",error:"err",fatal:"ftl"},FULL:{trace:"TRACE",debug:"DEBUG",info:"INFO",warning:"WARNING",error:"ERROR",fatal:"FATAL"},full:{trace:"trace",debug:"debug",info:"info",warning:"warning",error:"error",fatal:"fatal"},L:{trace:"T",debug:"D",info:"I",warning:"W",error:"E",fatal:"F"},l:{trace:"t",debug:"d",info:"i",warning:"w",error:"e",fatal:"f"}};function Hr(t={}){const e=(()=>{const s=t.timestamp;return s==null?yt["date-time-timezone"]:s==="disabled"?yt.none:typeof s=="string"&&s in yt?yt[s]:s})(),n=t.category??"",i=t.value?s=>t.value(s,ur):ur,a=(()=>{const s=t.level;return s==null||s==="ABBR"?l=>Ue.ABBR[l]:s==="abbr"?l=>Ue.abbr[l]:s==="FULL"?l=>Ue.FULL[l]:s==="full"?l=>Ue.full[l]:s==="L"?l=>Ue.L[l]:s==="l"?l=>Ue.l[l]:s})(),o=t.format??(({timestamp:s,level:l,category:u,message:c})=>`${s?`${s} `:""}[${l}] ${u}: ${c}`);return s=>{const l=s.message,u=l.length;let c;if(u===1)c=l[0];else if(u<=6){c="";for(let g=0;g<u;g++)c+=g%2===0?l[g]:i(l[g])}else{const g=new Array(u);for(let E=0;E<u;E++)g[E]=E%2===0?l[E]:i(l[E]);c=g.join("")}const f=e(s.timestamp),d=a(s.level),p=typeof n=="function"?n(s.category):s.category.join(n);return`${o({timestamp:f,level:d,category:p,message:c,record:s})}
`}}Hr();const Jt="\x1B[0m",Kt={black:"\x1B[30m",red:"\x1B[31m",green:"\x1B[32m",yellow:"\x1B[33m",blue:"\x1B[34m",magenta:"\x1B[35m",cyan:"\x1B[36m",white:"\x1B[37m"},Zt={bold:"\x1B[1m",dim:"\x1B[2m",italic:"\x1B[3m",underline:"\x1B[4m",strikethrough:"\x1B[9m"},_s={trace:null,debug:"blue",info:"green",warning:"yellow",error:"red",fatal:"magenta"};function vs(t={}){const e=t.format,n=typeof t.timestampStyle>"u"?"dim":t.timestampStyle,i=t.timestampColor??null,a=`${n==null?"":Zt[n]}${i==null?"":Kt[i]}`,o=n==null&&i==null?"":Jt,s=typeof t.levelStyle>"u"?"bold":t.levelStyle,l=t.levelColors??_s,u=typeof t.categoryStyle>"u"?"dim":t.categoryStyle,c=t.categoryColor??null,f=`${u==null?"":Zt[u]}${c==null?"":Kt[c]}`,d=u==null&&c==null?"":Jt;return Hr({timestamp:"date-time-tz",value(p,m){return m(p,{colors:!0})},...t,format({timestamp:p,level:m,category:g,message:E,record:v}){const _=l[v.level];return p=`${a}${p}${o}`,m=`${s==null?"":Zt[s]}${_==null?"":Kt[_]}${m}${s==null&&_==null?"":Jt}`,e==null?`${p} ${m} ${f}${g}:${d} ${E}`:e({timestamp:p,level:m,category:`${f}${g}${d}`,message:E,record:v})}})}vs();function Es(t={}){if(!t.categorySeparator&&!t.message&&!t.properties)return s=>{if(s.message.length===3)return JSON.stringify({"@timestamp":new Date(s.timestamp).toISOString(),level:s.level==="warning"?"WARN":s.level.toUpperCase(),message:s.message[0]+JSON.stringify(s.message[1])+s.message[2],logger:s.category.join("."),properties:s.properties})+`
`;if(s.message.length===1)return JSON.stringify({"@timestamp":new Date(s.timestamp).toISOString(),level:s.level==="warning"?"WARN":s.level.toUpperCase(),message:s.message[0],logger:s.category.join("."),properties:s.properties})+`
`;let l=s.message[0];for(let u=1;u<s.message.length;u++)l+=u&1?JSON.stringify(s.message[u]):s.message[u];return JSON.stringify({"@timestamp":new Date(s.timestamp).toISOString(),level:s.level==="warning"?"WARN":s.level.toUpperCase(),message:l,logger:s.category.join("."),properties:s.properties})+`
`};const e=t.message==="template",n=t.properties??"nest:properties";let i;if(typeof t.categorySeparator=="function")i=t.categorySeparator;else{const s=t.categorySeparator??".";i=l=>l.join(s)}let a;if(n==="flatten")a=s=>s;else if(n.startsWith("prepend:")){const s=n.substring(8);if(s==="")throw new TypeError(`Invalid properties option: ${JSON.stringify(n)}. It must be of the form "prepend:<prefix>" where <prefix> is a non-empty string.`);a=l=>{const u={};for(const c in l)u[`${s}${c}`]=l[c];return u}}else if(n.startsWith("nest:")){const s=n.substring(5);a=l=>({[s]:l})}else throw new TypeError(`Invalid properties option: ${JSON.stringify(n)}. It must be "flatten", "prepend:<prefix>", or "nest:<key>".`);let o;return e?o=s=>{if(typeof s.rawMessage=="string")return s.rawMessage;let l="";for(let u=0;u<s.rawMessage.length;u++)l+=u%2<1?s.rawMessage[u]:"{}";return l}:o=s=>{const l=s.message.length;if(l===1)return s.message[0];let u="";for(let c=0;c<l;c++)u+=c%2<1?s.message[c]:JSON.stringify(s.message[c]);return u},s=>JSON.stringify({"@timestamp":new Date(s.timestamp).toISOString(),level:s.level==="warning"?"WARN":s.level.toUpperCase(),message:o(s),logger:i(s.category),...a(s.properties)})+`
`}Es();const bs={trace:"background-color: gray; color: white;",debug:"background-color: gray; color: white;",info:"background-color: white; color: black;",warning:"background-color: orange; color: black;",error:"background-color: red; color: white;",fatal:"background-color: maroon; color: white;"};function Ts(t){let e="";const n=[];for(let o=0;o<t.message.length;o++)o%2===0?e+=t.message[o]:(e+="%o",n.push(t.message[o]));const i=new Date(t.timestamp);return[`%c${`${i.getUTCHours().toString().padStart(2,"0")}:${i.getUTCMinutes().toString().padStart(2,"0")}:${i.getUTCSeconds().toString().padStart(2,"0")}.${i.getUTCMilliseconds().toString().padStart(3,"0")}`} %c${Ur[t.level]}%c %c${t.category.join("")} %c${e}`,"color: gray;",bs[t.level],"background-color: default;","color: gray;","color: default;",...n]}function qr(t={}){const e=t.formatter??Ts,n={trace:"debug",debug:"debug",info:"info",warning:"warn",error:"error",fatal:"error",...t.levelMap??{}},i=t.console??globalThis.console,a=_=>{const y=e(_),T=n[_.level];if(T===void 0)throw new TypeError(`Invalid log level: ${_.level}.`);if(typeof y=="string"){const S=y.replace(/\r?\n$/,"");i[T](S)}else i[T](...y)};if(!t.nonBlocking)return a;const o=t.nonBlocking===!0?{}:t.nonBlocking,s=o.bufferSize??100,l=o.flushInterval??100,u=[];let c=null,f=!1,d=!1;const p=s*2;function m(){if(u.length===0)return;const _=u.splice(0);for(const y of _)try{a(y)}catch{}}function g(){d||(d=!0,setTimeout(()=>{d=!1,m()},0))}function E(){c!==null||f||(c=setInterval(()=>{m()},l))}const v=_=>{f||(u.length>=p&&u.shift(),u.push(_),u.length>=s?g():c===null&&E())};return v[Symbol.dispose]=()=>{f=!0,c!==null&&(clearInterval(c),c=null),m()},v}let _n=null;const Gr=new Set,St=new Set,wt=new Set;function Ns(t){return t.category.length===0||t.category.length===1&&t.category[0]==="logtape"||t.category.length===2&&t.category[0]==="logtape"&&t.category[1]==="meta"}async function Ss(t){if(_n!=null&&!t.reset)throw new tt("Already configured; if you want to reset, turn on the reset flag.");await hr();try{ws(t,!0)}catch(e){throw e instanceof tt&&await hr(),e}}function ws(t,e){var o;_n=t;let n=!1;const i=new Set;for(const s of t.loggers){Ns(s)&&(n=!0);const l=Array.isArray(s.category)?JSON.stringify(s.category):JSON.stringify([s.category]);if(i.has(l))throw new tt(`Duplicate logger configuration for category: ${l}. Each category can only be configured once.`);i.add(l);const u=et.getLogger(s.category);for(const c of s.sinks??[]){const f=t.sinks[c];if(!f)throw new tt(`Sink not found: ${c}.`);u.sinks.push(f)}u.parentSinks=s.parentSinks??"inherit",s.lowestLevel!==void 0&&(u.lowestLevel=s.lowestLevel);for(const c of s.filters??[]){const f=(o=t.filters)==null?void 0:o[c];if(f===void 0)throw new tt(`Filter not found: ${c}.`);u.filters.push(ls(f))}Gr.add(u)}et.getLogger().contextLocalStorage=t.contextLocalStorage;for(const s of Object.values(t.sinks))Symbol.asyncDispose in s&&wt.add(s),Symbol.dispose in s&&St.add(s);for(const s of Object.values(t.filters??{}))s==null||typeof s=="string"||(Symbol.asyncDispose in s&&wt.add(s),Symbol.dispose in s&&St.add(s));if(typeof globalThis.EdgeRuntime!="string"&&"process"in globalThis&&!("Deno"in globalThis)){const s=globalThis.process,l=s==null?void 0:s.on;typeof l=="function"&&l.call(s,"exit",un)}else addEventListener("unload",un);const a=et.getLogger(["logtape","meta"]);n||a.sinks.push(qr()),a.info("LogTape loggers are configured.  Note that LogTape itself uses the meta logger, which has category {metaLoggerCategory}.  The meta logger purposes to log internal errors such as sink exceptions.  If you are seeing this message, the meta logger is automatically configured.  It's recommended to configure the meta logger with a separate sink so that you can easily notice if logging itself fails or is misconfigured.  To turn off this message, configure the meta logger with higher log levels than {dismissLevel}.  See also <https://logtape.org/manual/categories#meta-logger>.",{metaLoggerCategory:["logtape","meta"],dismissLevel:"info"})}async function hr(){await un(),Cs()}function Cs(){const t=et.getLogger([]);t.resetDescendants(),delete t.contextLocalStorage,Gr.clear(),_n=null}async function un(){Ls();const t=[];for(const e of wt)t.push(e[Symbol.asyncDispose]()),wt.delete(e);await Promise.all(t)}function Ls(){for(const t of St)t[Symbol.dispose]();St.clear()}var tt=class extends Error{constructor(t){super(t),this.name="ConfigureError"}};class As{async log(e){try{if(!$.isDynamic())return;const n=$.getEnvelope();if(!n.isOpen())return;const i=n.getWriter();if(!i)return;await i.appendLog({id:At("log"),level:e.level,logger:e.category.join("."),message:e.message,context:e.properties||void 0})}catch(n){console.error("[LogTape] Failed to write to envelope:",n)}}}function Rs(){Ss({sinks:{console:qr(),envelope:new As},loggers:[{category:["search"],level:"info",sinks:["console","envelope"]},{category:["llm"],level:"info",sinks:["console","envelope"]},{category:["envelope"],level:"info",sinks:["console","envelope"]},{category:["glyphcase"],level:"info",sinks:["console","envelope"]},{category:["debug"],level:"debug",sinks:["console"]},{category:[],level:"error",sinks:["console","envelope"]}]}),console.log("[Logging] LogTape initialized with console and envelope sinks")}function Os(){const t=os(),[e,n]=N(null),[i,a]=N(null),[o,s]=N(!1),[l,u]=N(null),[c,f]=N(!1);Ar({defaultMode:t.features.search.defaultMode});const d=Ir({autoLoad:!1});return Mr({}),j(()=>{Rs()},[]),j(()=>{e&&(d.loadEntities(),(async()=>{try{const _=le(),y=await Wa(_);console.log("[GCUI] Detected capabilities:",y.capabilities),y.capabilities.mode!=="generic"?(a(y),console.log("[GCUI] Rendering in",y.capabilities.mode,"mode")):(console.log("[GCUI] No GCUI tables found, using legacy mode"),a(null))}catch(_){console.warn("[GCUI] Detection failed, using legacy mode:",_),a(null)}})())},[e]),r("div",{className:"app",children:[r("header",{className:"app-header",children:[r("h1",{children:"GlyphCase Explorer"}),r("p",{children:"Hybrid Retrieval + Dynamic Memory for MemGlyph"})]}),r("main",{className:"app-main",children:e?i&&t.features.gcui.enabled?r("div",{className:"gcui-mode",children:r(ns,{context:i})}):r($a,{capsuleInfo:e,onClose:()=>n(null)}):r("div",{className:"welcome",children:[l&&r("div",{className:"error",style:"max-width: 600px; margin: 1rem auto;",children:[r("strong",{children:"Error:"})," ",l]}),r(ha,{onFileSelected:async(v,_)=>{s(!0),u(null);try{const T=await le().openFromFile(v);n(T),console.log("Capsule opened:",T)}catch(y){u(String(y)),console.error("Failed to open file:",y)}finally{s(!1)}},onOpfsFileSelected:async v=>{s(!0),u(null);try{const y=await le().openFromOpfs(v);n(y),console.log("Capsule opened from OPFS:",y)}catch(_){u(String(_)),console.error("Failed to open from OPFS:",_)}finally{s(!1)}},onError:v=>{u(v)}}),r("div",{style:"text-align: center; margin-top: 1.5rem;",children:[r("p",{style:"margin-bottom: 0.5rem; opacity: 0.7;",children:"Or try the demo:"}),r("button",{className:"btn-secondary",onClick:async()=>{s(!0),u(null);try{const _=await le().openDemo();n(_),console.log("Capsule info:",_)}catch(v){u(String(v)),console.error("Failed to open capsule:",v)}finally{s(!1)}},disabled:o,children:o?"Loading Demo...":"Load Demo Capsule"})]})]})}),r("footer",{className:"app-footer",children:r("p",{children:"Built with Preact + SQLite WASM + OPFS"})})]})}ai(r(Os,{}),document.getElementById("app"));
