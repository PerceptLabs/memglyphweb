var Nr=Object.defineProperty;var Tr=(t,e,r)=>e in t?Nr(t,e,{enumerable:!0,configurable:!0,writable:!0,value:r}):t[e]=r;var M=(t,e,r)=>Tr(t,typeof e!="symbol"?e+"":e,r);(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))a(i);new MutationObserver(i=>{for(const s of i)if(s.type==="childList")for(const l of s.addedNodes)l.tagName==="LINK"&&l.rel==="modulepreload"&&a(l)}).observe(document,{childList:!0,subtree:!0});function r(i){const s={};return i.integrity&&(s.integrity=i.integrity),i.referrerPolicy&&(s.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?s.credentials="include":i.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function a(i){if(i.ep)return;i.ep=!0;const s=r(i);fetch(i.href,s)}})();var dt,I,Gn,Ne,En,Wn,zn,Bn,Xt,Pt,Ut,Be={},Xn=[],Sr=/acit|ex(?:s|g|n|p|$)|rph|grid|ows|mnc|ntw|ine[ch]|zoo|^ord|itera/i,ut=Array.isArray;function ye(t,e){for(var r in e)t[r]=e[r];return t}function Vt(t){t&&t.parentNode&&t.parentNode.removeChild(t)}function wr(t,e,r){var a,i,s,l={};for(s in e)s=="key"?a=e[s]:s=="ref"?i=e[s]:l[s]=e[s];if(arguments.length>2&&(l.children=arguments.length>3?dt.call(arguments,2):r),typeof t=="function"&&t.defaultProps!=null)for(s in t.defaultProps)l[s]===void 0&&(l[s]=t.defaultProps[s]);return at(t,l,a,i,null)}function at(t,e,r,a,i){var s={type:t,props:e,key:r,ref:a,__k:null,__:null,__b:0,__e:null,__c:null,constructor:void 0,__v:i??++Gn,__i:-1,__u:0};return i==null&&I.vnode!=null&&I.vnode(s),s}function se(t){return t.children}function Ge(t,e){this.props=t,this.context=e}function Me(t,e){if(e==null)return t.__?Me(t.__,t.__i+1):null;for(var r;e<t.__k.length;e++)if((r=t.__k[e])!=null&&r.__e!=null)return r.__e;return typeof t.type=="function"?Me(t):null}function Vn(t){var e,r;if((t=t.__)!=null&&t.__c!=null){for(t.__e=t.__c.base=null,e=0;e<t.__k.length;e++)if((r=t.__k[e])!=null&&r.__e!=null){t.__e=t.__c.base=r.__e;break}return Vn(t)}}function Nn(t){(!t.__d&&(t.__d=!0)&&Ne.push(t)&&!lt.__r++||En!=I.debounceRendering)&&((En=I.debounceRendering)||Wn)(lt)}function lt(){for(var t,e,r,a,i,s,l,u=1;Ne.length;)Ne.length>u&&Ne.sort(zn),t=Ne.shift(),u=Ne.length,t.__d&&(r=void 0,a=void 0,i=(a=(e=t).__v).__e,s=[],l=[],e.__P&&((r=ye({},a)).__v=a.__v+1,I.vnode&&I.vnode(r),Yt(e.__P,r,a,e.__n,e.__P.namespaceURI,32&a.__u?[i]:null,s,i??Me(a),!!(32&a.__u),l),r.__v=a.__v,r.__.__k[r.__i]=r,jn(s,r,l),a.__e=a.__=null,r.__e!=i&&Vn(r)));lt.__r=0}function Yn(t,e,r,a,i,s,l,u,p,d,m){var c,h,_,g,E,b,y,f=a&&a.__k||Xn,N=e.length;for(p=Cr(r,e,f,p,N),c=0;c<N;c++)(_=r.__k[c])!=null&&(h=_.__i==-1?Be:f[_.__i]||Be,_.__i=c,b=Yt(t,_,h,i,s,l,u,p,d,m),g=_.__e,_.ref&&h.ref!=_.ref&&(h.ref&&Qt(h.ref,null,_),m.push(_.ref,_.__c||g,_)),E==null&&g!=null&&(E=g),(y=!!(4&_.__u))||h.__k===_.__k?p=Qn(_,p,t,y):typeof _.type=="function"&&b!==void 0?p=b:g&&(p=g.nextSibling),_.__u&=-7);return r.__e=E,p}function Cr(t,e,r,a,i){var s,l,u,p,d,m=r.length,c=m,h=0;for(t.__k=new Array(i),s=0;s<i;s++)(l=e[s])!=null&&typeof l!="boolean"&&typeof l!="function"?(p=s+h,(l=t.__k[s]=typeof l=="string"||typeof l=="number"||typeof l=="bigint"||l.constructor==String?at(null,l,null,null,null):ut(l)?at(se,{children:l},null,null,null):l.constructor==null&&l.__b>0?at(l.type,l.props,l.key,l.ref?l.ref:null,l.__v):l).__=t,l.__b=t.__b+1,u=null,(d=l.__i=Lr(l,r,p,c))!=-1&&(c--,(u=r[d])&&(u.__u|=2)),u==null||u.__v==null?(d==-1&&(i>m?h--:i<m&&h++),typeof l.type!="function"&&(l.__u|=4)):d!=p&&(d==p-1?h--:d==p+1?h++:(d>p?h--:h++,l.__u|=4))):t.__k[s]=null;if(c)for(s=0;s<m;s++)(u=r[s])!=null&&!(2&u.__u)&&(u.__e==a&&(a=Me(u)),Jn(u,u));return a}function Qn(t,e,r,a){var i,s;if(typeof t.type=="function"){for(i=t.__k,s=0;i&&s<i.length;s++)i[s]&&(i[s].__=t,e=Qn(i[s],e,r,a));return e}t.__e!=e&&(a&&(e&&t.type&&!e.parentNode&&(e=Me(t)),r.insertBefore(t.__e,e||null)),e=t.__e);do e=e&&e.nextSibling;while(e!=null&&e.nodeType==8);return e}function Lr(t,e,r,a){var i,s,l,u=t.key,p=t.type,d=e[r],m=d!=null&&(2&d.__u)==0;if(d===null&&t.key==null||m&&u==d.key&&p==d.type)return r;if(a>(m?1:0)){for(i=r-1,s=r+1;i>=0||s<e.length;)if((d=e[l=i>=0?i--:s++])!=null&&!(2&d.__u)&&u==d.key&&p==d.type)return l}return-1}function Tn(t,e,r){e[0]=="-"?t.setProperty(e,r??""):t[e]=r==null?"":typeof r!="number"||Sr.test(e)?r:r+"px"}function et(t,e,r,a,i){var s,l;e:if(e=="style")if(typeof r=="string")t.style.cssText=r;else{if(typeof a=="string"&&(t.style.cssText=a=""),a)for(e in a)r&&e in r||Tn(t.style,e,"");if(r)for(e in r)a&&r[e]==a[e]||Tn(t.style,e,r[e])}else if(e[0]=="o"&&e[1]=="n")s=e!=(e=e.replace(Bn,"$1")),l=e.toLowerCase(),e=l in t||e=="onFocusOut"||e=="onFocusIn"?l.slice(2):e.slice(2),t.l||(t.l={}),t.l[e+s]=r,r?a?r.u=a.u:(r.u=Xt,t.addEventListener(e,s?Ut:Pt,s)):t.removeEventListener(e,s?Ut:Pt,s);else{if(i=="http://www.w3.org/2000/svg")e=e.replace(/xlink(H|:h)/,"h").replace(/sName$/,"s");else if(e!="width"&&e!="height"&&e!="href"&&e!="list"&&e!="form"&&e!="tabIndex"&&e!="download"&&e!="rowSpan"&&e!="colSpan"&&e!="role"&&e!="popover"&&e in t)try{t[e]=r??"";break e}catch{}typeof r=="function"||(r==null||r===!1&&e[4]!="-"?t.removeAttribute(e):t.setAttribute(e,e=="popover"&&r==1?"":r))}}function Sn(t){return function(e){if(this.l){var r=this.l[e.type+t];if(e.t==null)e.t=Xt++;else if(e.t<r.u)return;return r(I.event?I.event(e):e)}}}function Yt(t,e,r,a,i,s,l,u,p,d){var m,c,h,_,g,E,b,y,f,N,S,L,k,P,A,ne,ue,x=e.type;if(e.constructor!=null)return null;128&r.__u&&(p=!!(32&r.__u),s=[u=e.__e=r.__e]),(m=I.__b)&&m(e);e:if(typeof x=="function")try{if(y=e.props,f="prototype"in x&&x.prototype.render,N=(m=x.contextType)&&a[m.__c],S=m?N?N.props.value:m.__:a,r.__c?b=(c=e.__c=r.__c).__=c.__E:(f?e.__c=c=new x(y,S):(e.__c=c=new Ge(y,S),c.constructor=x,c.render=kr),N&&N.sub(c),c.props=y,c.state||(c.state={}),c.context=S,c.__n=a,h=c.__d=!0,c.__h=[],c._sb=[]),f&&c.__s==null&&(c.__s=c.state),f&&x.getDerivedStateFromProps!=null&&(c.__s==c.state&&(c.__s=ye({},c.__s)),ye(c.__s,x.getDerivedStateFromProps(y,c.__s))),_=c.props,g=c.state,c.__v=e,h)f&&x.getDerivedStateFromProps==null&&c.componentWillMount!=null&&c.componentWillMount(),f&&c.componentDidMount!=null&&c.__h.push(c.componentDidMount);else{if(f&&x.getDerivedStateFromProps==null&&y!==_&&c.componentWillReceiveProps!=null&&c.componentWillReceiveProps(y,S),!c.__e&&c.shouldComponentUpdate!=null&&c.shouldComponentUpdate(y,c.__s,S)===!1||e.__v==r.__v){for(e.__v!=r.__v&&(c.props=y,c.state=c.__s,c.__d=!1),e.__e=r.__e,e.__k=r.__k,e.__k.some(function(oe){oe&&(oe.__=e)}),L=0;L<c._sb.length;L++)c.__h.push(c._sb[L]);c._sb=[],c.__h.length&&l.push(c);break e}c.componentWillUpdate!=null&&c.componentWillUpdate(y,c.__s,S),f&&c.componentDidUpdate!=null&&c.__h.push(function(){c.componentDidUpdate(_,g,E)})}if(c.context=S,c.props=y,c.__P=t,c.__e=!1,k=I.__r,P=0,f){for(c.state=c.__s,c.__d=!1,k&&k(e),m=c.render(c.props,c.state,c.context),A=0;A<c._sb.length;A++)c.__h.push(c._sb[A]);c._sb=[]}else do c.__d=!1,k&&k(e),m=c.render(c.props,c.state,c.context),c.state=c.__s;while(c.__d&&++P<25);c.state=c.__s,c.getChildContext!=null&&(a=ye(ye({},a),c.getChildContext())),f&&!h&&c.getSnapshotBeforeUpdate!=null&&(E=c.getSnapshotBeforeUpdate(_,g)),ne=m,m!=null&&m.type===se&&m.key==null&&(ne=Kn(m.props.children)),u=Yn(t,ut(ne)?ne:[ne],e,r,a,i,s,l,u,p,d),c.base=e.__e,e.__u&=-161,c.__h.length&&l.push(c),b&&(c.__E=c.__=null)}catch(oe){if(e.__v=null,p||s!=null)if(oe.then){for(e.__u|=p?160:128;u&&u.nodeType==8&&u.nextSibling;)u=u.nextSibling;s[s.indexOf(u)]=null,e.__e=u}else{for(ue=s.length;ue--;)Vt(s[ue]);Ht(e)}else e.__e=r.__e,e.__k=r.__k,oe.then||Ht(e);I.__e(oe,e,r)}else s==null&&e.__v==r.__v?(e.__k=r.__k,e.__e=r.__e):u=e.__e=Ar(r.__e,e,r,a,i,s,l,p,d);return(m=I.diffed)&&m(e),128&e.__u?void 0:u}function Ht(t){t&&t.__c&&(t.__c.__e=!0),t&&t.__k&&t.__k.forEach(Ht)}function jn(t,e,r){for(var a=0;a<r.length;a++)Qt(r[a],r[++a],r[++a]);I.__c&&I.__c(e,t),t.some(function(i){try{t=i.__h,i.__h=[],t.some(function(s){s.call(i)})}catch(s){I.__e(s,i.__v)}})}function Kn(t){return typeof t!="object"||t==null||t.__b&&t.__b>0?t:ut(t)?t.map(Kn):ye({},t)}function Ar(t,e,r,a,i,s,l,u,p){var d,m,c,h,_,g,E,b=r.props,y=e.props,f=e.type;if(f=="svg"?i="http://www.w3.org/2000/svg":f=="math"?i="http://www.w3.org/1998/Math/MathML":i||(i="http://www.w3.org/1999/xhtml"),s!=null){for(d=0;d<s.length;d++)if((_=s[d])&&"setAttribute"in _==!!f&&(f?_.localName==f:_.nodeType==3)){t=_,s[d]=null;break}}if(t==null){if(f==null)return document.createTextNode(y);t=document.createElementNS(i,f,y.is&&y),u&&(I.__m&&I.__m(e,s),u=!1),s=null}if(f==null)b===y||u&&t.data==y||(t.data=y);else{if(s=s&&dt.call(t.childNodes),b=r.props||Be,!u&&s!=null)for(b={},d=0;d<t.attributes.length;d++)b[(_=t.attributes[d]).name]=_.value;for(d in b)if(_=b[d],d!="children"){if(d=="dangerouslySetInnerHTML")c=_;else if(!(d in y)){if(d=="value"&&"defaultValue"in y||d=="checked"&&"defaultChecked"in y)continue;et(t,d,null,_,i)}}for(d in y)_=y[d],d=="children"?h=_:d=="dangerouslySetInnerHTML"?m=_:d=="value"?g=_:d=="checked"?E=_:u&&typeof _!="function"||b[d]===_||et(t,d,_,b[d],i);if(m)u||c&&(m.__html==c.__html||m.__html==t.innerHTML)||(t.innerHTML=m.__html),e.__k=[];else if(c&&(t.innerHTML=""),Yn(e.type=="template"?t.content:t,ut(h)?h:[h],e,r,a,f=="foreignObject"?"http://www.w3.org/1999/xhtml":i,s,l,s?s[0]:r.__k&&Me(r,0),u,p),s!=null)for(d=s.length;d--;)Vt(s[d]);u||(d="value",f=="progress"&&g==null?t.removeAttribute("value"):g!=null&&(g!==t[d]||f=="progress"&&!g||f=="option"&&g!=b[d])&&et(t,d,g,b[d],i),d="checked",E!=null&&E!=t[d]&&et(t,d,E,b[d],i))}return t}function Qt(t,e,r){try{if(typeof t=="function"){var a=typeof t.__u=="function";a&&t.__u(),a&&e==null||(t.__u=t(e))}else t.current=e}catch(i){I.__e(i,r)}}function Jn(t,e,r){var a,i;if(I.unmount&&I.unmount(t),(a=t.ref)&&(a.current&&a.current!=t.__e||Qt(a,null,e)),(a=t.__c)!=null){if(a.componentWillUnmount)try{a.componentWillUnmount()}catch(s){I.__e(s,e)}a.base=a.__P=null}if(a=t.__k)for(i=0;i<a.length;i++)a[i]&&Jn(a[i],e,r||typeof t.type!="function");r||Vt(t.__e),t.__c=t.__=t.__e=void 0}function kr(t,e,r){return this.constructor(t,r)}function Rr(t,e,r){var a,i,s,l;e==document&&(e=document.documentElement),I.__&&I.__(t,e),i=(a=!1)?null:e.__k,s=[],l=[],Yt(e,t=e.__k=wr(se,null,[t]),i||Be,Be,e.namespaceURI,i?null:e.firstChild?dt.call(e.childNodes):null,s,i?i.__e:e.firstChild,a,l),jn(s,t,l)}dt=Xn.slice,I={__e:function(t,e,r,a){for(var i,s,l;e=e.__;)if((i=e.__c)&&!i.__)try{if((s=i.constructor)&&s.getDerivedStateFromError!=null&&(i.setState(s.getDerivedStateFromError(t)),l=i.__d),i.componentDidCatch!=null&&(i.componentDidCatch(t,a||{}),l=i.__d),l)return i.__E=i}catch(u){t=u}throw t}},Gn=0,Ge.prototype.setState=function(t,e){var r;r=this.__s!=null&&this.__s!=this.state?this.__s:this.__s=ye({},this.state),typeof t=="function"&&(t=t(ye({},r),this.props)),t&&ye(r,t),t!=null&&this.__v&&(e&&this._sb.push(e),Nn(this))},Ge.prototype.forceUpdate=function(t){this.__v&&(this.__e=!0,t&&this.__h.push(t),Nn(this))},Ge.prototype.render=se,Ne=[],Wn=typeof Promise=="function"?Promise.prototype.then.bind(Promise.resolve()):setTimeout,zn=function(t,e){return t.__v.__b-e.__v.__b},lt.__r=0,Bn=/(PointerCapture)$|Capture$/i,Xt=0,Pt=Sn(!1),Ut=Sn(!0);var Or=0;function n(t,e,r,a,i,s){e||(e={});var l,u,p=e;if("ref"in p)for(u in p={},e)u=="ref"?l=e[u]:p[u]=e[u];var d={type:t,props:p,key:r,ref:l,__k:null,__:null,__b:0,__e:null,__c:null,constructor:void 0,__v:--Or,__i:-1,__u:0,__source:i,__self:s};if(typeof t=="function"&&(l=t.defaultProps))for(u in l)p[u]===void 0&&(p[u]=l[u]);return I.vnode&&I.vnode(d),d}var Xe,$,Tt,wn,ot=0,Zn=[],z=I,Cn=z.__b,Ln=z.__r,An=z.diffed,kn=z.__c,Rn=z.unmount,On=z.__;function jt(t,e){z.__h&&z.__h($,t,ot||e),ot=0;var r=$.__H||($.__H={__:[],__h:[]});return t>=r.__.length&&r.__.push({}),r.__[t]}function T(t){return ot=1,Mr(tr,t)}function Mr(t,e,r){var a=jt(Xe++,2);if(a.t=t,!a.__c&&(a.__=[tr(void 0,e),function(u){var p=a.__N?a.__N[0]:a.__[0],d=a.t(p,u);p!==d&&(a.__N=[d,a.__[1]],a.__c.setState({}))}],a.__c=$,!$.__f)){var i=function(u,p,d){if(!a.__c.__H)return!0;var m=a.__c.__H.__.filter(function(h){return!!h.__c});if(m.every(function(h){return!h.__N}))return!s||s.call(this,u,p,d);var c=a.__c.props!==u;return m.forEach(function(h){if(h.__N){var _=h.__[0];h.__=h.__N,h.__N=void 0,_!==h.__[0]&&(c=!0)}}),s&&s.call(this,u,p,d)||c};$.__f=!0;var s=$.shouldComponentUpdate,l=$.componentWillUpdate;$.componentWillUpdate=function(u,p,d){if(this.__e){var m=s;s=void 0,i(u,p,d),s=m}l&&l.call(this,u,p,d)},$.shouldComponentUpdate=i}return a.__N||a.__}function j(t,e){var r=jt(Xe++,3);!z.__s&&er(r.__H,e)&&(r.__=t,r.u=e,$.__H.__h.push(r))}function We(t){return ot=5,xr(function(){return{current:t}},[])}function xr(t,e){var r=jt(Xe++,7);return er(r.__H,e)&&(r.__=t(),r.__H=e,r.__h=t),r.__}function Ir(){for(var t;t=Zn.shift();)if(t.__P&&t.__H)try{t.__H.__h.forEach(it),t.__H.__h.forEach($t),t.__H.__h=[]}catch(e){t.__H.__h=[],z.__e(e,t.__v)}}z.__b=function(t){$=null,Cn&&Cn(t)},z.__=function(t,e){t&&e.__k&&e.__k.__m&&(t.__m=e.__k.__m),On&&On(t,e)},z.__r=function(t){Ln&&Ln(t),Xe=0;var e=($=t.__c).__H;e&&(Tt===$?(e.__h=[],$.__h=[],e.__.forEach(function(r){r.__N&&(r.__=r.__N),r.u=r.__N=void 0})):(e.__h.forEach(it),e.__h.forEach($t),e.__h=[],Xe=0)),Tt=$},z.diffed=function(t){An&&An(t);var e=t.__c;e&&e.__H&&(e.__H.__h.length&&(Zn.push(e)!==1&&wn===z.requestAnimationFrame||((wn=z.requestAnimationFrame)||Dr)(Ir)),e.__H.__.forEach(function(r){r.u&&(r.__H=r.u),r.u=void 0})),Tt=$=null},z.__c=function(t,e){e.some(function(r){try{r.__h.forEach(it),r.__h=r.__h.filter(function(a){return!a.__||$t(a)})}catch(a){e.some(function(i){i.__h&&(i.__h=[])}),e=[],z.__e(a,r.__v)}}),kn&&kn(t,e)},z.unmount=function(t){Rn&&Rn(t);var e,r=t.__c;r&&r.__H&&(r.__H.__.forEach(function(a){try{it(a)}catch(i){e=i}}),r.__H=void 0,e&&z.__e(e,r.__v))};var Mn=typeof requestAnimationFrame=="function";function Dr(t){var e,r=function(){clearTimeout(a),Mn&&cancelAnimationFrame(e),setTimeout(t)},a=setTimeout(r,35);Mn&&(e=requestAnimationFrame(r))}function it(t){var e=$,r=t.__c;typeof r=="function"&&(t.__c=void 0,r()),$=e}function $t(t){var e=$;t.__c=t.__(),$=e}function er(t,e){return!t||t.length!==e.length||e.some(function(r,a){return r!==t[a]})}function tr(t,e){return typeof e=="function"?e(t):e}const Fr={maxQueueSize:50,defaultTimeout:1e4,maxTimeout:3e4};class Pr{constructor(e={}){M(this,"queue",[]);M(this,"processing",!1);M(this,"nextId",1);M(this,"config");M(this,"stats",{totalProcessed:0,totalTimeouts:0,totalErrors:0});this.config={...Fr,...e}}async enqueue(e,r){if(this.queue.length>=this.config.maxQueueSize)throw new Error(`Query queue full (${this.config.maxQueueSize} items). Too many pending queries.`);const a=Math.min(r||this.config.defaultTimeout,this.config.maxTimeout);return new Promise((i,s)=>{const l={id:this.nextId++,execute:e,resolve:i,reject:s,timeout:a,enqueuedAt:Date.now()};this.queue.push(l),this.processing||this.processQueue()})}async processQueue(){if(!(this.processing||this.queue.length===0)){for(this.processing=!0;this.queue.length>0;){const e=this.queue.shift();try{await this.executeWithTimeout(e)}catch{}}this.processing=!1}}async executeWithTimeout(e){const r=new Promise((a,i)=>{setTimeout(()=>{i(new Error(`Query ${e.id} timed out after ${e.timeout}ms`))},e.timeout)});try{const a=await Promise.race([e.execute(),r]);this.stats.totalProcessed++,e.resolve(a)}catch(a){a instanceof Error&&a.message.includes("timed out")?(this.stats.totalTimeouts++,console.warn(`[QueryQueue] Query ${e.id} timed out`,{timeout:e.timeout,waitTime:Date.now()-e.enqueuedAt})):this.stats.totalErrors++,e.reject(a)}}getStats(){return{queueLength:this.queue.length,busy:this.processing,totalProcessed:this.stats.totalProcessed,totalTimeouts:this.stats.totalTimeouts,totalErrors:this.stats.totalErrors}}isBusy(){return this.processing||this.queue.length>0}clear(){const e=new Error("Query queue cleared");for(const r of this.queue)r.reject(e);this.queue=[]}get length(){return this.queue.length}}let St=null;function qt(t){return St||(St=new Pr(t)),St}function Ur(t,e){return qt().enqueue(t,e)}class nr{constructor(){M(this,"worker",null);M(this,"nextId",1);M(this,"pending",new Map);this.initWorker()}initWorker(){this.worker=new Worker(new URL("/assets/sqlite.worker-B4LSZETD.js",import.meta.url),{type:"module"}),this.worker.onmessage=e=>{const r=e.data;if("type"in r&&r.type==="READY"){console.log("[DbClient] Worker ready");return}const{id:a,response:i}=r,s=this.pending.get(a);s&&(this.pending.delete(a),s.resolve(i))},this.worker.onerror=e=>{console.error("[DbClient] Worker error:",e);for(const r of this.pending.values())r.reject(new Error("Worker error"));this.pending.clear()}}async sendRequest(e,r=1e4){if(!this.worker)throw new Error("Worker not initialized");const a=this.nextId++;return Ur(async()=>new Promise((i,s)=>{const l=setTimeout(()=>{this.pending.delete(a),s(new Error(`Request ${e.type} timed out after ${r}ms`))},r);this.pending.set(a,{resolve:p=>{clearTimeout(l),p.ok?i(p.data):s(new Error(p.error))},reject:p=>{clearTimeout(l),s(p)},timeout:l});const u={id:a,request:e};this.worker.postMessage(u)}),r)}async openFromFile(e){return this.sendRequest({type:"OPEN_FROM_FILE",file:e})}async openFromOpfs(e){return this.sendRequest({type:"OPEN_FROM_OPFS",path:e})}async openDemo(){return this.sendRequest({type:"OPEN_DEMO"})}async saveToOpfs(e){return this.sendRequest({type:"SAVE_TO_OPFS",path:e})}async removeFromOpfs(e){return this.sendRequest({type:"REMOVE_FROM_OPFS",path:e})}async listOpfsFiles(){return this.sendRequest({type:"LIST_OPFS_FILES"})}async close(){return this.sendRequest({type:"CLOSE"})}async searchFts(e,r=20,a,i){return this.sendRequest({type:"FTS_SEARCH",query:e,limit:r,entityType:a,entityValue:i})}async searchHybrid(e,r=20,a){return this.sendRequest({type:"HYBRID_SEARCH",query:e,limit:r,weights:a})}async listEntities(e,r=100){return this.sendRequest({type:"LIST_ENTITIES",entityType:e,limit:r})}async getPageList(e=100,r=0){return this.sendRequest({type:"GET_PAGE_LIST",limit:e,offset:r})}async getPageBlob(e){return this.sendRequest({type:"GET_PAGE_BLOB",name:e})}async verifyPage(e){return this.sendRequest({type:"VERIFY_PAGE",gid:e})}async getCheckpoints(){return this.sendRequest({type:"GET_CHECKPOINTS"})}async graphHops(e,r,a,i){return this.sendRequest({type:"GRAPH_HOPS",seedGid:e,predicate:r,maxHops:a,limit:i})}getQueueStats(){return qt().getStats()}isQueueBusy(){return qt().isBusy()}terminate(){this.worker&&(this.worker.terminate(),this.worker=null);for(const e of this.pending.values())clearTimeout(e.timeout),e.reject(new Error("Worker terminated"));this.pending.clear()}}let wt=null;function le(){return wt||(wt=new nr),wt}class Hr{constructor(){M(this,"bus",new EventTarget);M(this,"topics",new Set);M(this,"eventLog",[]);M(this,"maxLogSize",100)}publish(e,r){this.topics.add(e);const a={topic:e,data:r,timestamp:Date.now()};this.bus.dispatchEvent(new CustomEvent(e,{detail:a}))}subscribe(e,r){const a=i=>{const s=i;r(s.detail.data,s.detail)};return this.bus.addEventListener(e,a),()=>{this.bus.removeEventListener(e,a)}}subscribeMany(e,r){const a=e.map(i=>this.subscribe(i,(s,l)=>r(i,s,l)));return()=>{a.forEach(i=>i())}}getActiveTopics(){return Array.from(this.topics)}getRecentEvents(e){return[]}clearEventLog(){this.eventLog=[]}getStats(){const e={};return{activeTopics:this.topics.size,eventLogSize:this.eventLog.length,topicCounts:e}}}const ce=new Hr,$r=t=>ce.publish("retrieval.query",t),qr=t=>ce.publish("retrieval.result",t),Gr=t=>ce.publish("llm.prompt",t),Wr=t=>ce.publish("llm.output",t),zr=t=>ce.publish("llm.citation",t),Br=t=>ce.publish("feedback.signal",t),xn=t=>ce.publish("capsule.loaded",t),Xr=()=>ce.publish("capsule.unloaded",{}),Vr=`-- GlyphCase Envelope Schema v1.1
-- Append-only episodic memory layer for Dynamic GlyphCases
-- This schema represents the mutable, hash-chained memory buffer
-- that sits alongside the immutable Core.

-- ============================================================================
-- METADATA
-- ============================================================================

-- Envelope metadata and configuration
CREATE TABLE IF NOT EXISTS _envelope_meta (
  key TEXT PRIMARY KEY,
  value TEXT NOT NULL
) STRICT;

-- Core metadata values:
-- 'gcase_id' - SHA256 hash of the Core capsule this envelope is linked to
-- 'created_at' - ISO8601 timestamp of envelope creation
-- 'format_version' - Envelope schema version (1.1)
-- 'last_hash' - Most recent hash in the chain

-- ============================================================================
-- HASH CHAIN (Merkle Integrity)
-- ============================================================================

-- Hash chain for append-only integrity verification
-- Each block represents a batch of appends with a Merkle root
CREATE TABLE IF NOT EXISTS _env_chain (
  seq INTEGER PRIMARY KEY AUTOINCREMENT,
  block_hash TEXT NOT NULL UNIQUE,
  parent_hash TEXT NOT NULL,
  block_type TEXT NOT NULL, -- 'retrieval' | 'embedding' | 'feedback' | 'summary'
  row_count INTEGER NOT NULL DEFAULT 1,
  created_at TEXT NOT NULL DEFAULT (datetime('now'))
) STRICT;

CREATE INDEX IF NOT EXISTS idx_chain_block_type ON _env_chain(block_type);
CREATE INDEX IF NOT EXISTS idx_chain_created_at ON _env_chain(created_at);

-- ============================================================================
-- RETRIEVAL LOGS
-- ============================================================================

-- Logs every search/retrieval operation performed
-- Enables learning from query patterns and improving relevance
CREATE TABLE IF NOT EXISTS env_retrieval_log (
  id TEXT PRIMARY KEY,
  seq INTEGER NOT NULL REFERENCES _env_chain(seq),
  ts TEXT NOT NULL DEFAULT (datetime('now')),
  query_text TEXT NOT NULL,
  query_type TEXT NOT NULL CHECK(query_type IN ('fts', 'vector', 'hybrid', 'graph')),
  top_docs TEXT, -- JSON array of {gid, score, snippet}
  hit_count INTEGER NOT NULL DEFAULT 0,
  parent_hash TEXT NOT NULL
) STRICT;

CREATE INDEX IF NOT EXISTS idx_retrieval_ts ON env_retrieval_log(ts);
CREATE INDEX IF NOT EXISTS idx_retrieval_type ON env_retrieval_log(query_type);
CREATE INDEX IF NOT EXISTS idx_retrieval_query ON env_retrieval_log(query_text);

-- ============================================================================
-- CONTEXTUAL EMBEDDINGS
-- ============================================================================

-- Runtime-generated embeddings for queries, responses, and context
-- Provides adaptive semantic memory beyond the canonical Core vectors
CREATE TABLE IF NOT EXISTS env_embeddings (
  id TEXT PRIMARY KEY,
  seq INTEGER NOT NULL REFERENCES _env_chain(seq),
  source TEXT NOT NULL, -- 'user_query' | 'llm_response' | 'context_window' | 'feedback_cluster'
  vector BLOB NOT NULL,
  metadata TEXT, -- JSON metadata about this embedding
  created_at TEXT NOT NULL DEFAULT (datetime('now')),
  parent_hash TEXT NOT NULL
) STRICT;

CREATE INDEX IF NOT EXISTS idx_embeddings_source ON env_embeddings(source);
CREATE INDEX IF NOT EXISTS idx_embeddings_created ON env_embeddings(created_at);

-- ============================================================================
-- USER FEEDBACK
-- ============================================================================

-- User ratings and feedback on retrievals and responses
-- Enables learning from human signals and improving relevance over time
CREATE TABLE IF NOT EXISTS env_feedback (
  id TEXT PRIMARY KEY,
  seq INTEGER NOT NULL REFERENCES _env_chain(seq),
  retrieval_id TEXT REFERENCES env_retrieval_log(id),
  rating INTEGER NOT NULL CHECK(rating IN (-1, 0, 1)), -- -1 (bad) | 0 (neutral) | 1 (good)
  notes TEXT,
  created_at TEXT NOT NULL DEFAULT (datetime('now')),
  parent_hash TEXT NOT NULL
) STRICT;

CREATE INDEX IF NOT EXISTS idx_feedback_rating ON env_feedback(rating);
CREATE INDEX IF NOT EXISTS idx_feedback_retrieval ON env_feedback(retrieval_id);
CREATE INDEX IF NOT EXISTS idx_feedback_created ON env_feedback(created_at);

-- ============================================================================
-- CONTEXT SUMMARIES
-- ============================================================================

-- LLM-generated context summaries and insights
-- Captures high-level understanding and reasoning patterns
CREATE TABLE IF NOT EXISTS env_context_summaries (
  id TEXT PRIMARY KEY,
  seq INTEGER NOT NULL REFERENCES _env_chain(seq),
  summary TEXT NOT NULL,
  relevance REAL NOT NULL CHECK(relevance >= 0.0 AND relevance <= 1.0),
  source_retrievals TEXT, -- JSON array of retrieval_log IDs
  created_at TEXT NOT NULL DEFAULT (datetime('now')),
  parent_hash TEXT NOT NULL
) STRICT;

CREATE INDEX IF NOT EXISTS idx_summaries_relevance ON env_context_summaries(relevance);
CREATE INDEX IF NOT EXISTS idx_summaries_created ON env_context_summaries(created_at);

-- ============================================================================
-- VIEWS
-- ============================================================================

-- Recent activity view (last 100 events)
CREATE VIEW IF NOT EXISTS v_recent_activity AS
SELECT
  'retrieval' as event_type,
  id,
  ts as timestamp,
  query_text as description,
  hit_count as value
FROM env_retrieval_log
UNION ALL
SELECT
  'feedback' as event_type,
  id,
  created_at as timestamp,
  notes as description,
  rating as value
FROM env_feedback
UNION ALL
SELECT
  'summary' as event_type,
  id,
  created_at as timestamp,
  substr(summary, 1, 100) as description,
  relevance as value
FROM env_context_summaries
ORDER BY timestamp DESC
LIMIT 100;

-- Envelope statistics view
CREATE VIEW IF NOT EXISTS v_envelope_stats AS
SELECT
  (SELECT COUNT(*) FROM env_retrieval_log) as retrieval_count,
  (SELECT COUNT(*) FROM env_embeddings) as embedding_count,
  (SELECT COUNT(*) FROM env_feedback) as feedback_count,
  (SELECT COUNT(*) FROM env_context_summaries) as summary_count,
  (SELECT COUNT(*) FROM _env_chain) as chain_length,
  (SELECT MIN(ts) FROM env_retrieval_log) as first_activity,
  (SELECT MAX(ts) FROM env_retrieval_log) as last_activity;

-- Search analytics view
CREATE VIEW IF NOT EXISTS v_search_analytics AS
SELECT
  COUNT(*) as total_queries,
  COUNT(CASE WHEN hit_count = 0 THEN 1 END) as zero_result_queries,
  COUNT(CASE WHEN hit_count > 0 THEN 1 END) as successful_queries,
  ROUND(COUNT(CASE WHEN hit_count = 0 THEN 1 END) * 100.0 / COUNT(*), 2) as zero_result_rate,
  AVG(hit_count) as avg_hit_count,
  COUNT(DISTINCT query_text) as unique_queries,
  query_type,
  date(ts) as query_date
FROM env_retrieval_log
GROUP BY query_type, query_date
ORDER BY query_date DESC;

-- Zero-result queries view (for improving search)
CREATE VIEW IF NOT EXISTS v_zero_result_queries AS
SELECT
  query_text,
  query_type,
  ts,
  COUNT(*) as attempt_count
FROM env_retrieval_log
WHERE hit_count = 0
GROUP BY query_text, query_type
ORDER BY attempt_count DESC, ts DESC;
`;async function tt(t){const e=JSON.stringify({table:t.table,id:t.rowId,data:Gt(t.data),parent:t.parentHash,ts:t.timestamp}),a=new TextEncoder().encode(e),i=await crypto.subtle.digest("SHA-256",a);return Array.from(new Uint8Array(i)).map(l=>l.toString(16).padStart(2,"0")).join("")}function Gt(t){if(t instanceof Float32Array)return{__type:"Float32Array",values:Array.from(t)};if(Array.isArray(t))return t.map(Gt);if(t&&typeof t=="object"){const e={};for(const[r,a]of Object.entries(t))e[r]=Gt(a);return e}return t}class Ct{constructor(e,r){M(this,"lastHash");M(this,"db");M(this,"genesis","0".repeat(64));this.db=e,this.lastHash=r||this.genesis}getCurrentHash(){return this.lastHash}async appendRetrieval(e){const r=new Date().toISOString(),a=await tt({table:"retrieval_log",rowId:e.id,data:e,parentHash:this.lastHash,timestamp:r}),i=this.db.prepare(`
      INSERT INTO env_retrieval_log
      (id, query_text, query_type, top_docs, hit_count, parent_hash, ts)
      VALUES (?, ?, ?, ?, ?, ?, ?)
    `);try{i.bind([e.id,e.query_text,e.query_type,e.top_docs?JSON.stringify(e.top_docs):null,e.hit_count,this.lastHash,r]),i.step()}finally{i.finalize()}return await this.recordChainBlock(a,"retrieval",1),this.lastHash=a,a}async appendEmbedding(e){const r=new Date().toISOString(),a=await tt({table:"embeddings",rowId:e.id,data:e,parentHash:this.lastHash,timestamp:r}),i=new Uint8Array(e.vector.buffer),s=this.db.prepare(`
      INSERT INTO env_embeddings
      (id, source, vector, metadata, parent_hash, created_at)
      VALUES (?, ?, ?, ?, ?, ?)
    `);try{s.bind([e.id,e.source,i,e.metadata?JSON.stringify(e.metadata):null,this.lastHash,r]),s.step()}finally{s.finalize()}return await this.recordChainBlock(a,"embedding",1),this.lastHash=a,a}async appendFeedback(e){const r=new Date().toISOString(),a=await tt({table:"feedback",rowId:e.id,data:e,parentHash:this.lastHash,timestamp:r}),i=this.db.prepare(`
      INSERT INTO env_feedback
      (id, retrieval_id, rating, notes, parent_hash, created_at)
      VALUES (?, ?, ?, ?, ?, ?)
    `);try{i.bind([e.id,e.retrieval_id||null,e.rating,e.notes||null,this.lastHash,r]),i.step()}finally{i.finalize()}return await this.recordChainBlock(a,"feedback",1),this.lastHash=a,a}async appendSummary(e){const r=new Date().toISOString(),a=await tt({table:"summaries",rowId:e.id,data:e,parentHash:this.lastHash,timestamp:r}),i=this.db.prepare(`
      INSERT INTO env_context_summaries
      (id, summary, relevance, source_retrievals, parent_hash, created_at)
      VALUES (?, ?, ?, ?, ?, ?)
    `);try{i.bind([e.id,e.summary,e.relevance,e.source_retrievals?JSON.stringify(e.source_retrievals):null,this.lastHash,r]),i.step()}finally{i.finalize()}return await this.recordChainBlock(a,"summary",1),this.lastHash=a,a}async recordChainBlock(e,r,a){const i=this.db.prepare(`
      INSERT INTO _env_chain (block_hash, parent_hash, block_type, row_count)
      VALUES (?, ?, ?, ?)
    `);try{i.bind([e,this.lastHash,r,a]),i.step();const l=this.db.prepare("SELECT last_insert_rowid()");try{l.step();const u=l.get([])[0],p=this.db.prepare(`
          UPDATE env_${r==="retrieval"?"retrieval_log":r==="embedding"?"embeddings":r==="feedback"?"feedback":"context_summaries"}
          SET seq = ?
          WHERE parent_hash = ?
        `);try{p.bind([u,this.lastHash]),p.step()}finally{p.finalize()}}finally{l.finalize()}}finally{i.finalize()}const s=this.db.prepare(`
      INSERT OR REPLACE INTO _envelope_meta (key, value) VALUES ('last_hash', ?)
    `);try{s.bind([e]),s.step()}finally{s.finalize()}}async verifyChain(){const e=[],r=this.db.prepare(`
      SELECT seq, block_hash, parent_hash, block_type
      FROM _env_chain
      ORDER BY seq ASC
    `),a=[];try{for(;r.step();){const i=r.get([]);a.push({seq:i[0],block_hash:i[1],parent_hash:i[2],block_type:i[3],row_count:0,created_at:""})}}finally{r.finalize()}for(let i=1;i<a.length;i++){const s=a[i],l=a[i-1];s.parent_hash!==l.block_hash&&e.push(`Chain break at seq ${s.seq}: parent_hash ${s.parent_hash} does not match previous block_hash ${l.block_hash}`)}return{valid:e.length===0,errors:e}}getChainStats(){const e=this.db.prepare(`
      SELECT block_type, COUNT(*) as count
      FROM _env_chain
      GROUP BY block_type
    `),r={};try{for(;e.step();){const s=e.get([]);r[s[0]]=s[1]}}finally{e.finalize()}const a=this.db.prepare("SELECT COUNT(*) FROM _env_chain");let i=0;try{a.step(),i=a.get([])[0]}finally{a.finalize()}return{length:i,currentHash:this.lastHash,types:r}}}function rr(t="env"){const e=Date.now().toString(36),r=Math.random().toString(36).substring(2,9);return`${t}_${e}_${r}`}async function Lt(t){const e=await t.arrayBuffer(),r=await crypto.subtle.digest("SHA-256",e);return Array.from(new Uint8Array(r)).map(i=>i.toString(16).padStart(2,"0")).join("")}class ct{constructor(){M(this,"db",null);M(this,"writer",null);M(this,"gcaseId",null);M(this,"opfsPath",null)}static async exists(e){try{const r=await Lt(e),a=`/envelopes/${r}.db`;return await(await(await navigator.storage.getDirectory()).getDirectoryHandle("envelopes",{create:!1})).getFileHandle(`${r}.db`,{create:!1}),!0}catch{return!1}}async create(e,r){this.gcaseId=await Lt(e),this.opfsPath=`/envelopes/${this.gcaseId}.db`,await(await navigator.storage.getDirectory()).getDirectoryHandle("envelopes",{create:!0}),this.db=new r.oo1.OpfsDb(this.opfsPath,"c"),this.db.exec(Vr);const i=new Date().toISOString(),s="0".repeat(64),l=this.db.prepare(`
      INSERT INTO _envelope_meta (key, value) VALUES
      ('gcase_id', ?),
      ('created_at', ?),
      ('format_version', '1.1'),
      ('last_hash', ?)
    `);try{l.bind([this.gcaseId,i,s]),l.step()}finally{l.finalize()}this.writer=new Ct(this.db,s),console.log(`[Envelope] Created new envelope for ${this.gcaseId}`)}async load(e,r){this.gcaseId=await Lt(e),this.opfsPath=`/envelopes/${this.gcaseId}.db`,this.db=new r.oo1.OpfsDb(this.opfsPath,"w");const a=this.db.prepare(`
      SELECT value FROM _envelope_meta WHERE key = 'last_hash'
    `);let i="0".repeat(64);try{a.step()&&(i=a.get([])[0])}finally{a.finalize()}this.writer=new Ct(this.db,i),console.log(`[Envelope] Loaded existing envelope for ${this.gcaseId}`)}async open(e,r){await ct.exists(e)?await this.load(e,r):await this.create(e,r)}close(){this.db&&(this.db.close(),this.db=null,this.writer=null,this.gcaseId=null,console.log("[Envelope] Closed envelope database"))}getWriter(){return this.writer}getStats(){if(!this.db)return null;const e=this.db.prepare("SELECT * FROM v_envelope_stats");try{if(e.step()){const r=e.get([]);return{retrievalCount:r[0]||0,embeddingCount:r[1]||0,feedbackCount:r[2]||0,summaryCount:r[3]||0,chainLength:r[4]||0,firstActivity:r[5]||null,lastActivity:r[6]||null}}}finally{e.finalize()}return null}getMeta(){if(!this.db)return null;const e=this.db.prepare("SELECT key, value FROM _envelope_meta"),r={};try{for(;e.step();){const a=e.get([]);r[a[0]]=a[1]}}finally{e.finalize()}return{gcaseId:r.gcase_id||"",createdAt:r.created_at||"",formatVersion:r.format_version||"1.1",lastHash:r.last_hash||""}}async clear(){if(!this.db)return;this.db.exec(`
      DELETE FROM env_retrieval_log;
      DELETE FROM env_embeddings;
      DELETE FROM env_feedback;
      DELETE FROM env_context_summaries;
      DELETE FROM _env_chain;
    `);const e="0".repeat(64),r=this.db.prepare(`
      UPDATE _envelope_meta SET value = ? WHERE key = 'last_hash'
    `);try{r.bind([e]),r.step()}finally{r.finalize()}this.writer=new Ct(this.db,e),console.log("[Envelope] Cleared all envelope data")}async export(){if(!this.db||!this.opfsPath)throw new Error("No envelope database open");return await(await(await(await navigator.storage.getDirectory()).getDirectoryHandle("envelopes")).getFileHandle(`${this.gcaseId}.db`)).getFile()}getRecentActivity(e=20){if(!this.db)return[];const r=this.db.prepare(`
      SELECT event_type, id, timestamp, description, value
      FROM v_recent_activity
      LIMIT ?
    `),a=[];try{for(r.bind([e]);r.step();){const i=r.get([]);a.push({eventType:i[0],id:i[1],timestamp:i[2],description:i[3],value:i[4]})}}finally{r.finalize()}return a}async verify(){return this.writer?this.writer.verifyChain():{valid:!1,errors:["No envelope writer available"]}}getDatabase(){return this.db}isOpen(){return this.db!==null}getOpfsPath(){return this.opfsPath}getGCaseId(){return this.gcaseId}}class Yr{constructor(){M(this,"dbClient");M(this,"envelopeManager");M(this,"currentModality","static");M(this,"currentFile",null);M(this,"currentInfo",null);this.dbClient=new nr,this.envelopeManager=new ct}getModalityPreference(){return localStorage.getItem("glyphcase.modality")||"auto"}setModalityPreference(e){localStorage.setItem("glyphcase.modality",e)}async detectModality(e){const r=this.getModalityPreference();return r==="static"?"static":r==="dynamic"||await ct.exists(e)?"dynamic":"static"}async openFromFile(e,r){this.currentFile=e;const a=await this.dbClient.openFromFile(e);let i;r!==void 0?i=r?"dynamic":"static":i=await this.detectModality(e),this.currentModality=i;let s;return i==="dynamic"&&console.log("[GlyphCase] Dynamic mode - envelope will be initialized on first write"),this.currentInfo={...a,modality:i,envelopeStats:s},xn({gid:a.docId||"unknown",title:a.title||"Untitled",modality:i}),this.currentInfo}async openDemo(){const e=await this.dbClient.openDemo();return this.currentModality="static",this.currentInfo={...e,modality:"static"},xn({gid:e.docId||"demo",title:e.title||"Demo",modality:"static"}),this.currentInfo}async enableDynamicMode(){if(!this.currentFile)throw new Error("No capsule loaded");if(this.currentModality==="dynamic"){console.log("[GlyphCase] Already in dynamic mode");return}this.currentModality="dynamic",this.currentInfo&&(this.currentInfo.modality="dynamic"),console.log("[GlyphCase] Enabled dynamic mode")}getModality(){return this.currentModality}getInfo(){return this.currentInfo}isDynamic(){return this.currentModality==="dynamic"}getCore(){return this.dbClient}getEnvelope(){return this.envelopeManager}getStream(){return ce}async close(){this.envelopeManager.isOpen()&&this.envelopeManager.close(),await this.dbClient.close(),this.currentModality="static",this.currentFile=null,this.currentInfo=null,Xr()}async exportEnvelope(){return this.envelopeManager.isOpen()?this.envelopeManager.export():null}async clearEnvelope(){this.envelopeManager.isOpen()&&(await this.envelopeManager.clear(),this.currentInfo&&(this.currentInfo.envelopeStats=this.envelopeManager.getStats()||void 0))}getEnvelopeStats(){return this.envelopeManager.getStats()}async verifyEnvelope(){return this.envelopeManager.isOpen()?this.envelopeManager.verify():null}}const W=new Yr;function ar(t={}){const{defaultMode:e="hybrid",maxResults:r=10,maxGraphHops:a=2,debounceMs:i=300}=t,[s,l]=T(e),[u,p]=T(null),[d,m]=T(""),[c,h]=T(!1),[_,g]=T(null),[E,b]=T({}),[y,f]=T(""),[N,S]=T(()=>{try{const O=localStorage.getItem("memglyph-search-history");return O?JSON.parse(O):[]}catch{return[]}}),L=We(null);j(()=>{if(y.trim())return L.current&&clearTimeout(L.current),L.current=window.setTimeout(()=>{A(y)},i),()=>{L.current&&clearTimeout(L.current)}},[y,s,E]);const k=O=>{if(!O.trim())return;const ae=O.trim();S(J=>{const q=J.filter(B=>B!==ae),ie=[ae,...q].slice(0,10);try{localStorage.setItem("memglyph-search-history",JSON.stringify(ie))}catch(B){console.warn("[Search] Failed to save history:",B)}return ie})},P=()=>{S([]);try{localStorage.removeItem("memglyph-search-history")}catch(O){console.warn("[Search] Failed to clear history:",O)}},A=async O=>{if(!O.trim())return;h(!0),g(null),m(O),k(O);const ae=performance.now();try{const J=le();$r({query:O,type:s,limit:r});let q=[];switch(s){case"fts":q=await jr(J,O,r,E);break;case"hybrid":q=await J.searchHybrid(O,r);break;case"graph":q=await Kr(J,O,r,a,E);break;default:throw new Error(`Unknown search mode: ${s}`)}const ie=performance.now()-ae;return qr({query:O,type:s,results:q.map(B=>({gid:B.gid,score:B.scores.final,snippet:B.snippet||void 0})),executionTime:ie}),W.isDynamic()&&await Qr(O,s,q),p(q),console.log(`[Search] ${s} mode: ${q.length} results in ${ie.toFixed(0)}ms`),q}catch(J){const q=String(J);return g(q),console.error("[Search] Failed:",J),[]}finally{h(!1)}};return{mode:s,results:u,lastQuery:d,loading:c,error:_,entityFilter:E,searchHistory:N,search:O=>{f(O)},searchImmediate:O=>(L.current&&clearTimeout(L.current),f(""),A(O)),clear:()=>{p(null),m(""),g(null),f(""),L.current&&clearTimeout(L.current)},changeMode:O=>{l(O),p(null)},setFilter:O=>{b(O),p(null)},clearFilter:()=>{b({}),p(null)},clearHistory:P}}async function Qr(t,e,r){try{const a=W.getEnvelope();if(!a.isOpen()){console.warn("[Search] Envelope not open, skipping log");return}const i=a.getWriter();if(!i){console.warn("[Search] No envelope writer available");return}await i.appendRetrieval({id:rr("ret"),query_text:t,query_type:e,top_docs:r.slice(0,10).map(s=>({gid:s.gid,score:s.scores.final,snippet:s.snippet||void 0})),hit_count:r.length}),console.log(`[Search] Logged retrieval to envelope: ${r.length} results`)}catch(a){console.error("[Search] Failed to log to envelope:",a)}}async function jr(t,e,r,a){return(await t.searchFts(e,r,a.entityType,a.entityValue)).map(s=>({gid:s.gid,pageNo:s.pageNo,title:s.title,snippet:s.snippet,scores:{fts:s.score,vector:0,entity:0,graph:0,final:s.score}}))}async function Kr(t,e,r,a,i){const s=await t.searchFts(e,3,i.entityType,i.entityValue);if(s.length===0)return[];const l=s[0].gid,u=await t.graphHops(l,void 0,a,r),p=u.nodes.map(d=>{const m=u.distances[d.gid]||0,c=s.find(h=>h.gid===d.gid);return{gid:d.gid,pageNo:d.pageNo,title:d.title,snippet:(c==null?void 0:c.snippet)||null,scores:{fts:(c==null?void 0:c.score)||0,vector:0,entity:0,graph:1/(m+1),final:((c==null?void 0:c.score)||0)*.3+1/(m+1)*.7}}});return p.sort((d,m)=>m.scores.final-d.scores.final),p}/*! @license DOMPurify 3.3.0 | (c) Cure53 and other contributors | Released under the Apache license 2.0 and Mozilla Public License 2.0 | github.com/cure53/DOMPurify/blob/3.3.0/LICENSE */const{entries:ir,setPrototypeOf:In,isFrozen:Jr,getPrototypeOf:Zr,getOwnPropertyDescriptor:ea}=Object;let{freeze:ee,seal:de,create:Wt}=Object,{apply:zt,construct:Bt}=typeof Reflect<"u"&&Reflect;ee||(ee=function(e){return e});de||(de=function(e){return e});zt||(zt=function(e,r){for(var a=arguments.length,i=new Array(a>2?a-2:0),s=2;s<a;s++)i[s-2]=arguments[s];return e.apply(r,i)});Bt||(Bt=function(e){for(var r=arguments.length,a=new Array(r>1?r-1:0),i=1;i<r;i++)a[i-1]=arguments[i];return new e(...a)});const nt=te(Array.prototype.forEach),ta=te(Array.prototype.lastIndexOf),Dn=te(Array.prototype.pop),Pe=te(Array.prototype.push),na=te(Array.prototype.splice),st=te(String.prototype.toLowerCase),At=te(String.prototype.toString),kt=te(String.prototype.match),Ue=te(String.prototype.replace),ra=te(String.prototype.indexOf),aa=te(String.prototype.trim),he=te(Object.prototype.hasOwnProperty),Z=te(RegExp.prototype.test),He=ia(TypeError);function te(t){return function(e){e instanceof RegExp&&(e.lastIndex=0);for(var r=arguments.length,a=new Array(r>1?r-1:0),i=1;i<r;i++)a[i-1]=arguments[i];return zt(t,e,a)}}function ia(t){return function(){for(var e=arguments.length,r=new Array(e),a=0;a<e;a++)r[a]=arguments[a];return Bt(t,r)}}function R(t,e){let r=arguments.length>2&&arguments[2]!==void 0?arguments[2]:st;In&&In(t,null);let a=e.length;for(;a--;){let i=e[a];if(typeof i=="string"){const s=r(i);s!==i&&(Jr(e)||(e[a]=s),i=s)}t[i]=!0}return t}function sa(t){for(let e=0;e<t.length;e++)he(t,e)||(t[e]=null);return t}function _e(t){const e=Wt(null);for(const[r,a]of ir(t))he(t,r)&&(Array.isArray(a)?e[r]=sa(a):a&&typeof a=="object"&&a.constructor===Object?e[r]=_e(a):e[r]=a);return e}function $e(t,e){for(;t!==null;){const a=ea(t,e);if(a){if(a.get)return te(a.get);if(typeof a.value=="function")return te(a.value)}t=Zr(t)}function r(){return null}return r}const Fn=ee(["a","abbr","acronym","address","area","article","aside","audio","b","bdi","bdo","big","blink","blockquote","body","br","button","canvas","caption","center","cite","code","col","colgroup","content","data","datalist","dd","decorator","del","details","dfn","dialog","dir","div","dl","dt","element","em","fieldset","figcaption","figure","font","footer","form","h1","h2","h3","h4","h5","h6","head","header","hgroup","hr","html","i","img","input","ins","kbd","label","legend","li","main","map","mark","marquee","menu","menuitem","meter","nav","nobr","ol","optgroup","option","output","p","picture","pre","progress","q","rp","rt","ruby","s","samp","search","section","select","shadow","slot","small","source","spacer","span","strike","strong","style","sub","summary","sup","table","tbody","td","template","textarea","tfoot","th","thead","time","tr","track","tt","u","ul","var","video","wbr"]),Rt=ee(["svg","a","altglyph","altglyphdef","altglyphitem","animatecolor","animatemotion","animatetransform","circle","clippath","defs","desc","ellipse","enterkeyhint","exportparts","filter","font","g","glyph","glyphref","hkern","image","inputmode","line","lineargradient","marker","mask","metadata","mpath","part","path","pattern","polygon","polyline","radialgradient","rect","stop","style","switch","symbol","text","textpath","title","tref","tspan","view","vkern"]),Ot=ee(["feBlend","feColorMatrix","feComponentTransfer","feComposite","feConvolveMatrix","feDiffuseLighting","feDisplacementMap","feDistantLight","feDropShadow","feFlood","feFuncA","feFuncB","feFuncG","feFuncR","feGaussianBlur","feImage","feMerge","feMergeNode","feMorphology","feOffset","fePointLight","feSpecularLighting","feSpotLight","feTile","feTurbulence"]),la=ee(["animate","color-profile","cursor","discard","font-face","font-face-format","font-face-name","font-face-src","font-face-uri","foreignobject","hatch","hatchpath","mesh","meshgradient","meshpatch","meshrow","missing-glyph","script","set","solidcolor","unknown","use"]),Mt=ee(["math","menclose","merror","mfenced","mfrac","mglyph","mi","mlabeledtr","mmultiscripts","mn","mo","mover","mpadded","mphantom","mroot","mrow","ms","mspace","msqrt","mstyle","msub","msup","msubsup","mtable","mtd","mtext","mtr","munder","munderover","mprescripts"]),oa=ee(["maction","maligngroup","malignmark","mlongdiv","mscarries","mscarry","msgroup","mstack","msline","msrow","semantics","annotation","annotation-xml","mprescripts","none"]),Pn=ee(["#text"]),Un=ee(["accept","action","align","alt","autocapitalize","autocomplete","autopictureinpicture","autoplay","background","bgcolor","border","capture","cellpadding","cellspacing","checked","cite","class","clear","color","cols","colspan","controls","controlslist","coords","crossorigin","datetime","decoding","default","dir","disabled","disablepictureinpicture","disableremoteplayback","download","draggable","enctype","enterkeyhint","exportparts","face","for","headers","height","hidden","high","href","hreflang","id","inert","inputmode","integrity","ismap","kind","label","lang","list","loading","loop","low","max","maxlength","media","method","min","minlength","multiple","muted","name","nonce","noshade","novalidate","nowrap","open","optimum","part","pattern","placeholder","playsinline","popover","popovertarget","popovertargetaction","poster","preload","pubdate","radiogroup","readonly","rel","required","rev","reversed","role","rows","rowspan","spellcheck","scope","selected","shape","size","sizes","slot","span","srclang","start","src","srcset","step","style","summary","tabindex","title","translate","type","usemap","valign","value","width","wrap","xmlns","slot"]),xt=ee(["accent-height","accumulate","additive","alignment-baseline","amplitude","ascent","attributename","attributetype","azimuth","basefrequency","baseline-shift","begin","bias","by","class","clip","clippathunits","clip-path","clip-rule","color","color-interpolation","color-interpolation-filters","color-profile","color-rendering","cx","cy","d","dx","dy","diffuseconstant","direction","display","divisor","dur","edgemode","elevation","end","exponent","fill","fill-opacity","fill-rule","filter","filterunits","flood-color","flood-opacity","font-family","font-size","font-size-adjust","font-stretch","font-style","font-variant","font-weight","fx","fy","g1","g2","glyph-name","glyphref","gradientunits","gradienttransform","height","href","id","image-rendering","in","in2","intercept","k","k1","k2","k3","k4","kerning","keypoints","keysplines","keytimes","lang","lengthadjust","letter-spacing","kernelmatrix","kernelunitlength","lighting-color","local","marker-end","marker-mid","marker-start","markerheight","markerunits","markerwidth","maskcontentunits","maskunits","max","mask","mask-type","media","method","mode","min","name","numoctaves","offset","operator","opacity","order","orient","orientation","origin","overflow","paint-order","path","pathlength","patterncontentunits","patterntransform","patternunits","points","preservealpha","preserveaspectratio","primitiveunits","r","rx","ry","radius","refx","refy","repeatcount","repeatdur","restart","result","rotate","scale","seed","shape-rendering","slope","specularconstant","specularexponent","spreadmethod","startoffset","stddeviation","stitchtiles","stop-color","stop-opacity","stroke-dasharray","stroke-dashoffset","stroke-linecap","stroke-linejoin","stroke-miterlimit","stroke-opacity","stroke","stroke-width","style","surfacescale","systemlanguage","tabindex","tablevalues","targetx","targety","transform","transform-origin","text-anchor","text-decoration","text-rendering","textlength","type","u1","u2","unicode","values","viewbox","visibility","version","vert-adv-y","vert-origin-x","vert-origin-y","width","word-spacing","wrap","writing-mode","xchannelselector","ychannelselector","x","x1","x2","xmlns","y","y1","y2","z","zoomandpan"]),Hn=ee(["accent","accentunder","align","bevelled","close","columnsalign","columnlines","columnspan","denomalign","depth","dir","display","displaystyle","encoding","fence","frame","height","href","id","largeop","length","linethickness","lspace","lquote","mathbackground","mathcolor","mathsize","mathvariant","maxsize","minsize","movablelimits","notation","numalign","open","rowalign","rowlines","rowspacing","rowspan","rspace","rquote","scriptlevel","scriptminsize","scriptsizemultiplier","selection","separator","separators","stretchy","subscriptshift","supscriptshift","symmetric","voffset","width","xmlns"]),rt=ee(["xlink:href","xml:id","xlink:title","xml:space","xmlns:xlink"]),ca=de(/\{\{[\w\W]*|[\w\W]*\}\}/gm),da=de(/<%[\w\W]*|[\w\W]*%>/gm),ua=de(/\$\{[\w\W]*/gm),ha=de(/^data-[\-\w.\u00B7-\uFFFF]+$/),pa=de(/^aria-[\-\w]+$/),sr=de(/^(?:(?:(?:f|ht)tps?|mailto|tel|callto|sms|cid|xmpp|matrix):|[^a-z]|[a-z+.\-]+(?:[^a-z+.\-:]|$))/i),ma=de(/^(?:\w+script|data):/i),fa=de(/[\u0000-\u0020\u00A0\u1680\u180E\u2000-\u2029\u205F\u3000]/g),lr=de(/^html$/i),ga=de(/^[a-z][.\w]*(-[.\w]+)+$/i);var $n=Object.freeze({__proto__:null,ARIA_ATTR:pa,ATTR_WHITESPACE:fa,CUSTOM_ELEMENT:ga,DATA_ATTR:ha,DOCTYPE_NAME:lr,ERB_EXPR:da,IS_ALLOWED_URI:sr,IS_SCRIPT_OR_DATA:ma,MUSTACHE_EXPR:ca,TMPLIT_EXPR:ua});const qe={element:1,text:3,progressingInstruction:7,comment:8,document:9},_a=function(){return typeof window>"u"?null:window},ya=function(e,r){if(typeof e!="object"||typeof e.createPolicy!="function")return null;let a=null;const i="data-tt-policy-suffix";r&&r.hasAttribute(i)&&(a=r.getAttribute(i));const s="dompurify"+(a?"#"+a:"");try{return e.createPolicy(s,{createHTML(l){return l},createScriptURL(l){return l}})}catch{return console.warn("TrustedTypes policy "+s+" could not be created."),null}},qn=function(){return{afterSanitizeAttributes:[],afterSanitizeElements:[],afterSanitizeShadowDOM:[],beforeSanitizeAttributes:[],beforeSanitizeElements:[],beforeSanitizeShadowDOM:[],uponSanitizeAttribute:[],uponSanitizeElement:[],uponSanitizeShadowNode:[]}};function or(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:_a();const e=C=>or(C);if(e.version="3.3.0",e.removed=[],!t||!t.document||t.document.nodeType!==qe.document||!t.Element)return e.isSupported=!1,e;let{document:r}=t;const a=r,i=a.currentScript,{DocumentFragment:s,HTMLTemplateElement:l,Node:u,Element:p,NodeFilter:d,NamedNodeMap:m=t.NamedNodeMap||t.MozNamedAttrMap,HTMLFormElement:c,DOMParser:h,trustedTypes:_}=t,g=p.prototype,E=$e(g,"cloneNode"),b=$e(g,"remove"),y=$e(g,"nextSibling"),f=$e(g,"childNodes"),N=$e(g,"parentNode");if(typeof l=="function"){const C=r.createElement("template");C.content&&C.content.ownerDocument&&(r=C.content.ownerDocument)}let S,L="";const{implementation:k,createNodeIterator:P,createDocumentFragment:A,getElementsByTagName:ne}=r,{importNode:ue}=a;let x=qn();e.isSupported=typeof ir=="function"&&typeof N=="function"&&k&&k.createHTMLDocument!==void 0;const{MUSTACHE_EXPR:oe,ERB_EXPR:xe,TMPLIT_EXPR:U,DATA_ATTR:O,ARIA_ATTR:ae,IS_SCRIPT_OR_DATA:J,ATTR_WHITESPACE:q,CUSTOM_ELEMENT:ie}=$n;let{IS_ALLOWED_URI:B}=$n,D=null;const X=R({},[...Fn,...Rt,...Ot,...Mt,...Pn]);let Y=null;const Jt=R({},[...Un,...xt,...Hn,...rt]);let H=Object.seal(Wt(null,{tagNameCheck:{writable:!0,configurable:!1,enumerable:!0,value:null},attributeNameCheck:{writable:!0,configurable:!1,enumerable:!0,value:null},allowCustomizedBuiltInElements:{writable:!0,configurable:!1,enumerable:!0,value:!1}})),Ie=null,ht=null;const Te=Object.seal(Wt(null,{tagCheck:{writable:!0,configurable:!1,enumerable:!0,value:null},attributeCheck:{writable:!0,configurable:!1,enumerable:!0,value:null}}));let Zt=!0,pt=!0,en=!1,tn=!0,Se=!1,Ve=!0,ve=!1,mt=!1,ft=!1,we=!1,Ye=!1,Qe=!1,nn=!0,rn=!1;const mr="user-content-";let gt=!0,De=!1,Ce={},Le=null;const an=R({},["annotation-xml","audio","colgroup","desc","foreignobject","head","iframe","math","mi","mn","mo","ms","mtext","noembed","noframes","noscript","plaintext","script","style","svg","template","thead","title","video","xmp"]);let sn=null;const ln=R({},["audio","video","img","source","image","track"]);let _t=null;const on=R({},["alt","class","for","id","label","name","pattern","placeholder","role","summary","title","value","style","xmlns"]),je="http://www.w3.org/1998/Math/MathML",Ke="http://www.w3.org/2000/svg",me="http://www.w3.org/1999/xhtml";let Ae=me,yt=!1,vt=null;const fr=R({},[je,Ke,me],At);let Je=R({},["mi","mo","mn","ms","mtext"]),Ze=R({},["annotation-xml"]);const gr=R({},["title","style","font","a","script"]);let Fe=null;const _r=["application/xhtml+xml","text/html"],yr="text/html";let V=null,ke=null;const vr=r.createElement("form"),cn=function(o){return o instanceof RegExp||o instanceof Function},bt=function(){let o=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};if(!(ke&&ke===o)){if((!o||typeof o!="object")&&(o={}),o=_e(o),Fe=_r.indexOf(o.PARSER_MEDIA_TYPE)===-1?yr:o.PARSER_MEDIA_TYPE,V=Fe==="application/xhtml+xml"?At:st,D=he(o,"ALLOWED_TAGS")?R({},o.ALLOWED_TAGS,V):X,Y=he(o,"ALLOWED_ATTR")?R({},o.ALLOWED_ATTR,V):Jt,vt=he(o,"ALLOWED_NAMESPACES")?R({},o.ALLOWED_NAMESPACES,At):fr,_t=he(o,"ADD_URI_SAFE_ATTR")?R(_e(on),o.ADD_URI_SAFE_ATTR,V):on,sn=he(o,"ADD_DATA_URI_TAGS")?R(_e(ln),o.ADD_DATA_URI_TAGS,V):ln,Le=he(o,"FORBID_CONTENTS")?R({},o.FORBID_CONTENTS,V):an,Ie=he(o,"FORBID_TAGS")?R({},o.FORBID_TAGS,V):_e({}),ht=he(o,"FORBID_ATTR")?R({},o.FORBID_ATTR,V):_e({}),Ce=he(o,"USE_PROFILES")?o.USE_PROFILES:!1,Zt=o.ALLOW_ARIA_ATTR!==!1,pt=o.ALLOW_DATA_ATTR!==!1,en=o.ALLOW_UNKNOWN_PROTOCOLS||!1,tn=o.ALLOW_SELF_CLOSE_IN_ATTR!==!1,Se=o.SAFE_FOR_TEMPLATES||!1,Ve=o.SAFE_FOR_XML!==!1,ve=o.WHOLE_DOCUMENT||!1,we=o.RETURN_DOM||!1,Ye=o.RETURN_DOM_FRAGMENT||!1,Qe=o.RETURN_TRUSTED_TYPE||!1,ft=o.FORCE_BODY||!1,nn=o.SANITIZE_DOM!==!1,rn=o.SANITIZE_NAMED_PROPS||!1,gt=o.KEEP_CONTENT!==!1,De=o.IN_PLACE||!1,B=o.ALLOWED_URI_REGEXP||sr,Ae=o.NAMESPACE||me,Je=o.MATHML_TEXT_INTEGRATION_POINTS||Je,Ze=o.HTML_INTEGRATION_POINTS||Ze,H=o.CUSTOM_ELEMENT_HANDLING||{},o.CUSTOM_ELEMENT_HANDLING&&cn(o.CUSTOM_ELEMENT_HANDLING.tagNameCheck)&&(H.tagNameCheck=o.CUSTOM_ELEMENT_HANDLING.tagNameCheck),o.CUSTOM_ELEMENT_HANDLING&&cn(o.CUSTOM_ELEMENT_HANDLING.attributeNameCheck)&&(H.attributeNameCheck=o.CUSTOM_ELEMENT_HANDLING.attributeNameCheck),o.CUSTOM_ELEMENT_HANDLING&&typeof o.CUSTOM_ELEMENT_HANDLING.allowCustomizedBuiltInElements=="boolean"&&(H.allowCustomizedBuiltInElements=o.CUSTOM_ELEMENT_HANDLING.allowCustomizedBuiltInElements),Se&&(pt=!1),Ye&&(we=!0),Ce&&(D=R({},Pn),Y=[],Ce.html===!0&&(R(D,Fn),R(Y,Un)),Ce.svg===!0&&(R(D,Rt),R(Y,xt),R(Y,rt)),Ce.svgFilters===!0&&(R(D,Ot),R(Y,xt),R(Y,rt)),Ce.mathMl===!0&&(R(D,Mt),R(Y,Hn),R(Y,rt))),o.ADD_TAGS&&(typeof o.ADD_TAGS=="function"?Te.tagCheck=o.ADD_TAGS:(D===X&&(D=_e(D)),R(D,o.ADD_TAGS,V))),o.ADD_ATTR&&(typeof o.ADD_ATTR=="function"?Te.attributeCheck=o.ADD_ATTR:(Y===Jt&&(Y=_e(Y)),R(Y,o.ADD_ATTR,V))),o.ADD_URI_SAFE_ATTR&&R(_t,o.ADD_URI_SAFE_ATTR,V),o.FORBID_CONTENTS&&(Le===an&&(Le=_e(Le)),R(Le,o.FORBID_CONTENTS,V)),gt&&(D["#text"]=!0),ve&&R(D,["html","head","body"]),D.table&&(R(D,["tbody"]),delete Ie.tbody),o.TRUSTED_TYPES_POLICY){if(typeof o.TRUSTED_TYPES_POLICY.createHTML!="function")throw He('TRUSTED_TYPES_POLICY configuration option must provide a "createHTML" hook.');if(typeof o.TRUSTED_TYPES_POLICY.createScriptURL!="function")throw He('TRUSTED_TYPES_POLICY configuration option must provide a "createScriptURL" hook.');S=o.TRUSTED_TYPES_POLICY,L=S.createHTML("")}else S===void 0&&(S=ya(_,i)),S!==null&&typeof L=="string"&&(L=S.createHTML(""));ee&&ee(o),ke=o}},dn=R({},[...Rt,...Ot,...la]),un=R({},[...Mt,...oa]),br=function(o){let v=N(o);(!v||!v.tagName)&&(v={namespaceURI:Ae,tagName:"template"});const w=st(o.tagName),F=st(v.tagName);return vt[o.namespaceURI]?o.namespaceURI===Ke?v.namespaceURI===me?w==="svg":v.namespaceURI===je?w==="svg"&&(F==="annotation-xml"||Je[F]):!!dn[w]:o.namespaceURI===je?v.namespaceURI===me?w==="math":v.namespaceURI===Ke?w==="math"&&Ze[F]:!!un[w]:o.namespaceURI===me?v.namespaceURI===Ke&&!Ze[F]||v.namespaceURI===je&&!Je[F]?!1:!un[w]&&(gr[w]||!dn[w]):!!(Fe==="application/xhtml+xml"&&vt[o.namespaceURI]):!1},pe=function(o){Pe(e.removed,{element:o});try{N(o).removeChild(o)}catch{b(o)}},be=function(o,v){try{Pe(e.removed,{attribute:v.getAttributeNode(o),from:v})}catch{Pe(e.removed,{attribute:null,from:v})}if(v.removeAttribute(o),o==="is")if(we||Ye)try{pe(v)}catch{}else try{v.setAttribute(o,"")}catch{}},hn=function(o){let v=null,w=null;if(ft)o="<remove></remove>"+o;else{const G=kt(o,/^[\r\n\t ]+/);w=G&&G[0]}Fe==="application/xhtml+xml"&&Ae===me&&(o='<html xmlns="http://www.w3.org/1999/xhtml"><head></head><body>'+o+"</body></html>");const F=S?S.createHTML(o):o;if(Ae===me)try{v=new h().parseFromString(F,Fe)}catch{}if(!v||!v.documentElement){v=k.createDocument(Ae,"template",null);try{v.documentElement.innerHTML=yt?L:F}catch{}}const K=v.body||v.documentElement;return o&&w&&K.insertBefore(r.createTextNode(w),K.childNodes[0]||null),Ae===me?ne.call(v,ve?"html":"body")[0]:ve?v.documentElement:K},pn=function(o){return P.call(o.ownerDocument||o,o,d.SHOW_ELEMENT|d.SHOW_COMMENT|d.SHOW_TEXT|d.SHOW_PROCESSING_INSTRUCTION|d.SHOW_CDATA_SECTION,null)},Et=function(o){return o instanceof c&&(typeof o.nodeName!="string"||typeof o.textContent!="string"||typeof o.removeChild!="function"||!(o.attributes instanceof m)||typeof o.removeAttribute!="function"||typeof o.setAttribute!="function"||typeof o.namespaceURI!="string"||typeof o.insertBefore!="function"||typeof o.hasChildNodes!="function")},mn=function(o){return typeof u=="function"&&o instanceof u};function fe(C,o,v){nt(C,w=>{w.call(e,o,v,ke)})}const fn=function(o){let v=null;if(fe(x.beforeSanitizeElements,o,null),Et(o))return pe(o),!0;const w=V(o.nodeName);if(fe(x.uponSanitizeElement,o,{tagName:w,allowedTags:D}),Ve&&o.hasChildNodes()&&!mn(o.firstElementChild)&&Z(/<[/\w!]/g,o.innerHTML)&&Z(/<[/\w!]/g,o.textContent)||o.nodeType===qe.progressingInstruction||Ve&&o.nodeType===qe.comment&&Z(/<[/\w]/g,o.data))return pe(o),!0;if(!(Te.tagCheck instanceof Function&&Te.tagCheck(w))&&(!D[w]||Ie[w])){if(!Ie[w]&&_n(w)&&(H.tagNameCheck instanceof RegExp&&Z(H.tagNameCheck,w)||H.tagNameCheck instanceof Function&&H.tagNameCheck(w)))return!1;if(gt&&!Le[w]){const F=N(o)||o.parentNode,K=f(o)||o.childNodes;if(K&&F){const G=K.length;for(let re=G-1;re>=0;--re){const ge=E(K[re],!0);ge.__removalCount=(o.__removalCount||0)+1,F.insertBefore(ge,y(o))}}}return pe(o),!0}return o instanceof p&&!br(o)||(w==="noscript"||w==="noembed"||w==="noframes")&&Z(/<\/no(script|embed|frames)/i,o.innerHTML)?(pe(o),!0):(Se&&o.nodeType===qe.text&&(v=o.textContent,nt([oe,xe,U],F=>{v=Ue(v,F," ")}),o.textContent!==v&&(Pe(e.removed,{element:o.cloneNode()}),o.textContent=v)),fe(x.afterSanitizeElements,o,null),!1)},gn=function(o,v,w){if(nn&&(v==="id"||v==="name")&&(w in r||w in vr))return!1;if(!(pt&&!ht[v]&&Z(O,v))){if(!(Zt&&Z(ae,v))){if(!(Te.attributeCheck instanceof Function&&Te.attributeCheck(v,o))){if(!Y[v]||ht[v]){if(!(_n(o)&&(H.tagNameCheck instanceof RegExp&&Z(H.tagNameCheck,o)||H.tagNameCheck instanceof Function&&H.tagNameCheck(o))&&(H.attributeNameCheck instanceof RegExp&&Z(H.attributeNameCheck,v)||H.attributeNameCheck instanceof Function&&H.attributeNameCheck(v,o))||v==="is"&&H.allowCustomizedBuiltInElements&&(H.tagNameCheck instanceof RegExp&&Z(H.tagNameCheck,w)||H.tagNameCheck instanceof Function&&H.tagNameCheck(w))))return!1}else if(!_t[v]){if(!Z(B,Ue(w,q,""))){if(!((v==="src"||v==="xlink:href"||v==="href")&&o!=="script"&&ra(w,"data:")===0&&sn[o])){if(!(en&&!Z(J,Ue(w,q,"")))){if(w)return!1}}}}}}}return!0},_n=function(o){return o!=="annotation-xml"&&kt(o,ie)},yn=function(o){fe(x.beforeSanitizeAttributes,o,null);const{attributes:v}=o;if(!v||Et(o))return;const w={attrName:"",attrValue:"",keepAttr:!0,allowedAttributes:Y,forceKeepAttr:void 0};let F=v.length;for(;F--;){const K=v[F],{name:G,namespaceURI:re,value:ge}=K,Re=V(G),Nt=ge;let Q=G==="value"?Nt:aa(Nt);if(w.attrName=Re,w.attrValue=Q,w.keepAttr=!0,w.forceKeepAttr=void 0,fe(x.uponSanitizeAttribute,o,w),Q=w.attrValue,rn&&(Re==="id"||Re==="name")&&(be(G,o),Q=mr+Q),Ve&&Z(/((--!?|])>)|<\/(style|title|textarea)/i,Q)){be(G,o);continue}if(Re==="attributename"&&kt(Q,"href")){be(G,o);continue}if(w.forceKeepAttr)continue;if(!w.keepAttr){be(G,o);continue}if(!tn&&Z(/\/>/i,Q)){be(G,o);continue}Se&&nt([oe,xe,U],bn=>{Q=Ue(Q,bn," ")});const vn=V(o.nodeName);if(!gn(vn,Re,Q)){be(G,o);continue}if(S&&typeof _=="object"&&typeof _.getAttributeType=="function"&&!re)switch(_.getAttributeType(vn,Re)){case"TrustedHTML":{Q=S.createHTML(Q);break}case"TrustedScriptURL":{Q=S.createScriptURL(Q);break}}if(Q!==Nt)try{re?o.setAttributeNS(re,G,Q):o.setAttribute(G,Q),Et(o)?pe(o):Dn(e.removed)}catch{be(G,o)}}fe(x.afterSanitizeAttributes,o,null)},Er=function C(o){let v=null;const w=pn(o);for(fe(x.beforeSanitizeShadowDOM,o,null);v=w.nextNode();)fe(x.uponSanitizeShadowNode,v,null),fn(v),yn(v),v.content instanceof s&&C(v.content);fe(x.afterSanitizeShadowDOM,o,null)};return e.sanitize=function(C){let o=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{},v=null,w=null,F=null,K=null;if(yt=!C,yt&&(C="<!-->"),typeof C!="string"&&!mn(C))if(typeof C.toString=="function"){if(C=C.toString(),typeof C!="string")throw He("dirty is not a string, aborting")}else throw He("toString is not a function");if(!e.isSupported)return C;if(mt||bt(o),e.removed=[],typeof C=="string"&&(De=!1),De){if(C.nodeName){const ge=V(C.nodeName);if(!D[ge]||Ie[ge])throw He("root node is forbidden and cannot be sanitized in-place")}}else if(C instanceof u)v=hn("<!---->"),w=v.ownerDocument.importNode(C,!0),w.nodeType===qe.element&&w.nodeName==="BODY"||w.nodeName==="HTML"?v=w:v.appendChild(w);else{if(!we&&!Se&&!ve&&C.indexOf("<")===-1)return S&&Qe?S.createHTML(C):C;if(v=hn(C),!v)return we?null:Qe?L:""}v&&ft&&pe(v.firstChild);const G=pn(De?C:v);for(;F=G.nextNode();)fn(F),yn(F),F.content instanceof s&&Er(F.content);if(De)return C;if(we){if(Ye)for(K=A.call(v.ownerDocument);v.firstChild;)K.appendChild(v.firstChild);else K=v;return(Y.shadowroot||Y.shadowrootmode)&&(K=ue.call(a,K,!0)),K}let re=ve?v.outerHTML:v.innerHTML;return ve&&D["!doctype"]&&v.ownerDocument&&v.ownerDocument.doctype&&v.ownerDocument.doctype.name&&Z(lr,v.ownerDocument.doctype.name)&&(re="<!DOCTYPE "+v.ownerDocument.doctype.name+`>
`+re),Se&&nt([oe,xe,U],ge=>{re=Ue(re,ge," ")}),S&&Qe?S.createHTML(re):re},e.setConfig=function(){let C=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};bt(C),mt=!0},e.clearConfig=function(){ke=null,mt=!1},e.isValidAttribute=function(C,o,v){ke||bt({});const w=V(C),F=V(o);return gn(w,F,v)},e.addHook=function(C,o){typeof o=="function"&&Pe(x[C],o)},e.removeHook=function(C,o){if(o!==void 0){const v=ta(x[C],o);return v===-1?void 0:na(x[C],v,1)[0]}return Dn(x[C])},e.removeHooks=function(C){x[C]=[]},e.removeAllHooks=function(){x=qn()},e}var Kt=or();function va({mode:t,onModeChange:e,showToggle:r=!0}){return r?n("div",{className:"search-mode-toggle",children:[n("button",{className:`mode-btn ${t==="fts"?"active":""}`,onClick:()=>e("fts"),children:" FTS Only"}),n("button",{className:`mode-btn ${t==="hybrid"?"active":""}`,onClick:()=>e("hybrid"),children:" Hybrid"}),n("button",{className:`mode-btn ${t==="graph"?"active":""}`,onClick:()=>e("graph"),children:" Graph"})]}):null}function ba({onSearch:t,loading:e,placeholder:r,searchHistory:a,onClearHistory:i}){return n(se,{children:[n("form",{onSubmit:s=>{s.preventDefault();const u=new FormData(s.currentTarget).get("query");u!=null&&u.trim()&&t(u.trim())},children:n("div",{className:"search-bar",children:[n("input",{type:"text",name:"query",placeholder:r||"Search the capsule...",className:"search-input",disabled:e}),n("button",{type:"submit",className:"btn-search",disabled:e,children:e?"Searching...":"Search"})]})}),a&&a.length>0&&n("div",{className:"search-history",children:[n("div",{className:"search-history-header",children:[n("span",{className:"search-history-label",children:"Recent searches:"}),i&&n("button",{className:"search-history-clear",onClick:i,type:"button",children:"Clear"})]}),n("div",{className:"search-history-items",children:a.map((s,l)=>n("button",{className:"search-history-item",onClick:()=>t(s),type:"button",children:s},l))})]})]})}function Ea({resultGid:t,retrievalId:e}){const[r,a]=T(null),[i,s]=T(!1),l=async u=>{s(!0);try{if(Br({retrievalId:e,rating:u,notes:void 0}),W.isDynamic()){const d=W.getEnvelope().getWriter();d&&await d.appendFeedback({id:rr("fb"),retrieval_id:e,rating:u,notes:void 0})}a(u)}catch(p){console.error("[Feedback] Failed to submit feedback:",p)}finally{s(!1)}};return W.isDynamic()?n("div",{className:"result-feedback",children:[n("button",{className:`feedback-btn ${r===1?"feedback-btn-active-positive":""}`,onClick:u=>{u.stopPropagation(),l(1)},disabled:i||r!==null,title:"Helpful result",children:""}),n("button",{className:`feedback-btn ${r===-1?"feedback-btn-active-negative":""}`,onClick:u=>{u.stopPropagation(),l(-1)},disabled:i||r!==null,title:"Not helpful",children:""})]}):null}function Na({results:t,query:e,onResultClick:r,retrievalId:a}){return n("div",{className:"search-results",children:[n("p",{className:"results-header",children:["Found ",t.length," results for ",n("strong",{children:['"',e,'"']})]}),t.map(i=>n("div",{className:`result-item ${r?"result-item-clickable":""}`,onClick:()=>r==null?void 0:r(i.gid),style:{cursor:r?"pointer":"default"},children:[n("div",{className:"result-header",children:[n("span",{className:"result-page",children:["Page ",i.pageNo]}),n("span",{className:"result-score",children:["Score: ",i.scores.final.toFixed(3)]}),n(Ea,{resultGid:i.gid,retrievalId:a})]}),n("h4",{className:"result-title",children:i.title}),i.snippet&&n("p",{className:"result-snippet",dangerouslySetInnerHTML:{__html:Kt.sanitize(i.snippet,{ALLOWED_TAGS:["mark","strong","em","b","i"],ALLOWED_ATTR:[]})}}),n("div",{className:"result-scores",children:[n("span",{children:["FTS: ",i.scores.fts.toFixed(2)]}),n("span",{children:["Entity: ",i.scores.entity.toFixed(2)]}),n("span",{children:["Graph: ",i.scores.graph.toFixed(2)]})]})]},i.gid))]})}function Ta({mode:t,results:e,lastQuery:r,loading:a,onSearch:i,onModeChange:s,onResultClick:l,showModeToggle:u=!0,placeholder:p,searchHint:d,searchHistory:m,onClearHistory:c}){return n("div",{className:"search-section",children:[n("div",{className:"search-header",children:n("h3",{children:" Search"})}),n(va,{mode:t,onModeChange:s,showToggle:u}),d&&n("p",{className:"search-hint",children:d}),n("div",{className:"keyboard-shortcuts-hint",children:[n("span",{className:"shortcut-item",children:[n("kbd",{children:"/"})," Focus search"]}),n("span",{className:"shortcut-item",children:[n("kbd",{children:"Ctrl+L"})," Toggle LLM"]}),n("span",{className:"shortcut-item",children:[n("kbd",{children:"Esc"})," Clear focus"]})]}),n(ba,{onSearch:i,loading:a,placeholder:p,searchHistory:m,onClearHistory:c}),e&&e.length>0&&n(Na,{results:e,query:r,onResultClick:l}),e&&e.length===0&&n("div",{className:"no-results",children:[n("p",{children:["No results found for ",n("strong",{children:['"',r,'"']})]}),n("p",{className:"search-hint",children:"Try different keywords or search terms."})]})]})}function cr(t={}){const{autoLoad:e=!0,maxEntities:r=50}=t,[a,i]=T([]),[s,l]=T(null),[u,p]=T(!1),[d,m]=T(null),c=async()=>{p(!0),m(null);try{const f=await le().listEntities(void 0,r);i(f),console.log("[Entities] Loaded:",f.length)}catch(y){const f=String(y);m(f),console.error("[Entities] Failed to load:",y)}finally{p(!1)}};j(()=>{e&&c()},[e]);const h=y=>{l(y)},_=()=>Array.from(new Set(a.map(y=>y.entityType))),g=()=>s?a.filter(y=>y.entityType===s):a,E=y=>a.filter(f=>f.entityType===y).reduce((f,N)=>f+N.count,0),b=()=>a.reduce((y,f)=>y+f.count,0);return{entities:a,selectedType:s,loading:u,error:d,types:_(),filteredEntities:g(),totalCount:b(),loadEntities:c,selectType:h,getTypeCount:E}}function Sa({types:t,selectedType:e,totalCount:r,onSelectType:a,getTypeCount:i}){return n("div",{className:"entity-filters",children:[n("button",{className:`entity-filter ${e===null?"active":""}`,onClick:()=>a(null),children:["All (",r,")"]}),t.map(s=>{const l=i(s);return n("button",{className:`entity-filter ${e===s?"active":""}`,onClick:()=>a(s),children:[s," (",l,")"]},s)})]})}function wa({entities:t,maxDisplay:e=20}){const r=t.slice(0,e);return n("div",{className:"entity-list",children:[r.map(a=>n("div",{className:"entity-item",children:[n("span",{className:"entity-type",children:a.entityType}),n("span",{className:"entity-value",children:a.normalizedValue}),n("span",{className:"entity-count",children:a.count})]},`${a.entityType}-${a.normalizedValue}`)),t.length>e&&n("div",{className:"entity-item entity-more",children:n("span",{className:"entity-value",children:["... and ",t.length-e," more"]})})]})}function Ca({entities:t,types:e,selectedType:r,totalCount:a,onSelectType:i,getTypeCount:s,show:l=!0,maxDisplay:u=20}){if(!l||t.length===0)return null;const p=r?t.filter(d=>d.entityType===r):t;return n("div",{className:"entity-panel",children:[n("h4",{children:"Filter by Entity Type"}),n(Sa,{types:e,selectedType:r,totalCount:a,onSelectType:i,getTypeCount:s}),n(wa,{entities:p,maxDisplay:u})]})}class La{constructor(){M(this,"worker",null);M(this,"nextId",1);M(this,"pending",new Map);M(this,"progressCallback",null);M(this,"streamTokenCallback",null);M(this,"streamCompleteCallback",null);M(this,"streamErrorCallback",null);this.initWorker()}initWorker(){this.worker=new Worker(new URL("/assets/llm.worker-BiRl8TFV.js",import.meta.url),{type:"module"}),this.worker.onmessage=e=>{const r=e.data;if("type"in r&&r.type==="READY"){console.log("[LlmClient] Worker ready");return}if("type"in r&&r.type==="PROGRESS"){this.progressCallback&&this.progressCallback(r.data);return}if("type"in r&&r.type==="STREAM_TOKEN"){this.streamTokenCallback&&this.streamTokenCallback(r.token,r.piece);return}if("type"in r&&r.type==="STREAM_COMPLETE"){this.streamCompleteCallback&&this.streamCompleteCallback();return}if("type"in r&&r.type==="STREAM_ERROR"){this.streamErrorCallback&&this.streamErrorCallback(r.error);return}const{id:a,response:i}=r,s=this.pending.get(a);s&&(this.pending.delete(a),s.resolve(i))},this.worker.onerror=e=>{console.error("[LlmClient] Worker error:",e);for(const r of this.pending.values())r.reject(new Error("Worker error"));this.pending.clear()}}async sendRequest(e){if(!this.worker)throw new Error("Worker not initialized");const r=this.nextId++;return new Promise((a,i)=>{this.pending.set(r,{resolve:l=>{l.ok?a(l.data):i(new Error(l.error))},reject:i});const s={id:r,request:e};this.worker.postMessage(s)})}onProgress(e){this.progressCallback=e}onStreamToken(e){this.streamTokenCallback=e}onStreamComplete(e){this.streamCompleteCallback=e}onStreamError(e){this.streamErrorCallback=e}async abortReasoning(){return this.sendRequest({type:"ABORT_REASONING"})}async loadModel(e){return this.sendRequest({type:"LOAD_MODEL",modelUrl:e})}async reason(e){return this.sendRequest({type:"REASON",request:e})}async unloadModel(){return this.sendRequest({type:"UNLOAD_MODEL"})}async getStatus(){return this.sendRequest({type:"GET_STATUS"})}terminate(){this.worker&&(this.worker.terminate(),this.worker=null),this.pending.clear(),this.progressCallback=null,this.streamTokenCallback=null,this.streamCompleteCallback=null,this.streamErrorCallback=null}}let It=null;function Dt(){return It||(It=new La),It}const Aa={"0.6b":"https://huggingface.co/unsloth/Qwen3-0.6B-GGUF/resolve/main/Qwen3-0.6B-Q4_K_M.gguf","1.5b":"https://huggingface.co/ggml-org/Qwen2.5-1.5B-Instruct-GGUF/resolve/main/qwen2.5-1.5b-instruct-q4_k_m.gguf"};function dr(t={}){const[e,r]=T(!1),[a,i]=T(null),[s,l]=T(!1),[u,p]=T(null),[d,m]=T(null),[c,h]=T(null),[_,g]=T(0),[E,b]=T(.7),[y,f]=T(!1),[N,S]=T(""),L=We(0),k=We(null),P=We(0),A=5e3;j(()=>{if(s&&!u)return L.current=Date.now(),g(0),k.current=window.setInterval(()=>{const U=(Date.now()-L.current)/1e3;g(U)},100),()=>{k.current&&clearInterval(k.current)};k.current&&(clearInterval(k.current),k.current=null),g(0)},[s,u]);const ne=async()=>{l(!0),h(null),p(null);try{const U=Dt();U.onProgress(ae=>{p(ae)}),U.onStreamToken((ae,J)=>{S(q=>q+J)}),U.onStreamComplete(()=>{f(!1)}),U.onStreamError(ae=>{h(ae),f(!1),S("")});const O=await U.loadModel(Aa["0.6b"]);i(O),p(null),console.log("[LLM] Model loaded:",O)}catch(U){const O=String(U);h(O),console.error("[LLM] Failed to load model:",U)}finally{l(!1)}};return{enabled:e,modelInfo:a,loading:s,progress:u,reasoning:d,error:c,elapsedTime:_,temperature:E,isStreaming:y,streamingText:N,toggle:async()=>{e?(r(!1),m(null)):(a!=null&&a.loaded||await ne(),r(!0))},loadModel:ne,reason:async(U,O,ae=256)=>{if(!(a!=null&&a.loaded)){console.warn("[LLM] Cannot reason: model not loaded");return}const J=Date.now(),q=J-P.current;if(q<A){const B=`Please wait ${Math.ceil((A-q)/1e3)}s before making another query (rate limit: 1 query per 5 seconds)`;h(B),console.warn("[LLM] Rate limit hit:",B);return}P.current=J,l(!0),h(null),f(!0),S("");try{const ie=Dt(),B=O.slice(0,5).map(X=>({gid:X.gid,pageNo:X.pageNo,title:X.title,text:X.snippet||"",score:X.scores.final}));Gr({prompt:U,context:B.map(X=>X.text),model:a.modelId});const D=await ie.reason({question:U,snippets:B,maxTokens:ae,temperature:E});Wr({response:D.answer,citations:D.usedSnippets.map(X=>({gid:X.gid,pageNo:X.pageNo})),model:a.modelId}),D.usedSnippets.forEach(X=>{zr({gid:X.gid,pageNo:X.pageNo,title:X.title||void 0,snippet:X.text})}),m(D),f(!1),console.log("[LLM] Reasoning complete:",D)}catch(ie){const B=String(ie);h(B),f(!1),S(""),console.error("[LLM] Reasoning failed:",ie)}finally{l(!1)}},clearReasoning:()=>{m(null)},abortReasoning:async()=>{try{await Dt().abortReasoning(),f(!1),S(""),l(!1),console.log("[LLM] Reasoning aborted")}catch(U){console.error("[LLM] Failed to abort reasoning:",U)}},setTemperature:b}}function ka({reasoning:t,searchResults:e,loading:r}){const[a,i]=T(null);return r&&!t?n("div",{className:"reasoning-loading",children:[n("div",{className:"spinner"}),n("p",{children:"LLM is reasoning..."})]}):t?n("div",{className:"reasoning-output",children:[n("div",{className:"reasoning-header",children:[n("h4",{children:" LLM Reasoning"}),n("span",{className:"reasoning-meta",children:[t.inferenceTimeMs.toFixed(0),"ms  ",t.tokensGenerated," tokens"]})]}),n("div",{className:"reasoning-answer",children:t.answer}),t.usedSnippets.length>0&&n("div",{className:"reasoning-citations",children:[n("strong",{children:" Cited sources:"}),t.usedSnippets.map(s=>{const l=e==null?void 0:e.find(u=>u.gid===s);return n("span",{className:"citation",onMouseEnter:()=>i(s),onMouseLeave:()=>i(null),style:{position:"relative"},children:["Page ",(l==null?void 0:l.pageNo)||"?",a===s&&l&&n("div",{className:"citation-tooltip",children:[n("div",{className:"citation-tooltip-title",children:l.title}),l.snippet&&n("div",{className:"citation-tooltip-snippet",dangerouslySetInnerHTML:{__html:Kt.sanitize(l.snippet,{ALLOWED_TAGS:["mark","strong","em","b","i"],ALLOWED_ATTR:[]})}}),n("div",{className:"citation-tooltip-meta",children:["Score: ",l.scores.final.toFixed(3),"  GID: ",s.slice(0,8),"..."]})]})]},s)})]})]}):null}function Oe(){return typeof navigator<"u"&&"storage"in navigator&&"getDirectory"in navigator.storage}async function Ra(){if(!Oe())throw new Error("OPFS not supported in this browser");return await navigator.storage.getDirectory()}async function Oa(){return await(await Ra()).getDirectoryHandle("capsules",{create:!0})}function Ma(t){const e=t.replace(/[^a-z0-9._-]/gi,"-");return e.endsWith(".mgx.sqlite")?e:`${e}.mgx.sqlite`}async function xa(t,e){if(!Oe())throw new Error("OPFS not supported - cannot persist file");const r=await Oa(),a=e||Ma(t.name),s=await(await r.getFileHandle(a,{create:!0})).createWritable();try{return await s.write(t),await s.close(),console.log(`[OPFS] Copied file to ${a} (${t.size} bytes)`),{path:a,size:t.size}}catch(l){throw await s.close(),l}}async function Ia(){if(!navigator.storage||!navigator.storage.estimate)return null;try{const t=await navigator.storage.estimate(),e=t.usage||0,r=t.quota||0;return{usage:e,quota:r,available:r-e,percentUsed:r>0?e/r*100:0}}catch(t){return console.error("[OPFS] Failed to get storage quota:",t),null}}async function Da(){if(!navigator.storage||!navigator.storage.persist)return!1;try{const t=await navigator.storage.persist();return console.log(`[OPFS] Persistent storage: ${t}`),t}catch(t){return console.error("[OPFS] Failed to request persistent storage:",t),!1}}function ze(t){if(t===0)return"0 B";const e=1024,r=["B","KB","MB","GB"],a=Math.floor(Math.log(t)/Math.log(e));return`${(t/Math.pow(e,a)).toFixed(2)} ${r[a]}`}async function Fa(t,e=500*1024*1024){if(t.size===0)return{valid:!1,error:"File is empty"};if(t.size>e)return{valid:!1,error:`File too large (${ze(t.size)} > ${ze(e)})`};const r=t.name.toLowerCase();if(!r.endsWith(".mgx.sqlite")&&!r.endsWith(".sqlite"))return{valid:!1,error:"File must have .mgx.sqlite or .sqlite extension"};try{const a=await t.slice(0,16).arrayBuffer();if(!new TextDecoder().decode(a).startsWith("SQLite format 3"))return{valid:!1,error:"Not a valid SQLite file (invalid header)"}}catch(a){return{valid:!1,error:`Failed to read file header: ${a}`}}return{valid:!0}}function Pa({onFileSelected:t,onOpfsFileSelected:e,onError:r}){const[a,i]=T([]),[s,l]=T(null),[u,p]=T(!1),[d,m]=T(!1),c=le();j(()=>{h(),_()},[]);async function h(){try{const f=await c.listOpfsFiles();i(f)}catch(f){console.error("[FilePicker] Failed to list OPFS files:",f)}}async function _(){var f,N;try{const S=await Ia();l(S);const L=await((N=(f=navigator.storage)==null?void 0:f.persisted)==null?void 0:N.call(f));m(L||!1)}catch(S){console.error("[FilePicker] Failed to get quota:",S)}}async function g(f){var L;const N=f.target,S=(L=N.files)==null?void 0:L[0];if(S){p(!0);try{const k=await Fa(S);if(!k.valid){r(k.error),p(!1);return}if(Oe()){const{path:P}=await xa(S);await h(),await _(),t(S,P)}else t(S)}catch(k){r(`Failed to load file: ${k}`)}finally{p(!1),N.value=""}}}async function E(f){p(!0);try{e(f)}catch(N){r(`Failed to open from OPFS: ${N}`)}finally{p(!1)}}async function b(f,N){if(N.stopPropagation(),!!confirm(`Remove "${f}" from device storage?`))try{await c.removeFromOpfs(f),await h(),await _()}catch(S){r(`Failed to remove file: ${S}`)}}async function y(){try{await Da()?m(!0):r("Persistent storage not granted. Files may be evicted under storage pressure.")}catch(f){r(`Failed to request persistence: ${f}`)}}return n("div",{class:"file-picker",children:[n("div",{class:"file-picker-header",children:[n("h2",{children:"Open Capsule"}),s&&n("div",{class:"storage-quota",children:[n("div",{class:"quota-bar",children:n("div",{class:"quota-used",style:`width: ${Math.min(s.percentUsed,100)}%`})}),n("p",{class:"quota-text",children:[ze(s.usage)," / ",ze(s.quota)," used (",s.percentUsed.toFixed(1),"%)"]}),!d&&Oe()&&n("button",{class:"btn-secondary btn-sm",onClick:y,children:"Request Persistent Storage"})]})]}),n("div",{class:"file-input-section",children:[n("label",{class:"file-input-label",children:[n("input",{type:"file",accept:".mgx.sqlite,.sqlite",onChange:g,disabled:u,style:"display: none"}),n("button",{class:"btn-primary",disabled:u,children:u?"Loading...":"Select File from Device"})]}),n("p",{class:"help-text",children:"Choose a .mgx.sqlite or .sqlite file from your device"})]}),Oe()&&a.length>0&&n("div",{class:"opfs-files-section",children:[n("h3",{children:"Stored on Device"}),n("ul",{class:"opfs-files-list",children:a.map(f=>n("li",{class:"opfs-file-item",children:[n("button",{class:"opfs-file-button",onClick:()=>E(f.path),disabled:u,children:n("div",{class:"file-info",children:[n("span",{class:"file-name",children:f.path}),n("span",{class:"file-meta",children:[ze(f.size)," "," ",new Date(f.lastModified).toLocaleDateString()]})]})}),n("button",{class:"btn-remove",onClick:N=>b(f.path,N),title:"Remove from device","aria-label":"Remove from device",children:""})]},f.path))})]}),!Oe()&&n("div",{class:"opfs-warning",children:n("p",{children:[n("strong",{children:"Note:"})," Your browser doesn't support persistent storage. Files will only be kept in memory and lost when you close the tab."]})})]})}function Ua(t={}){const{autoLoad:e=!1,maxHops:r=2,limit:a=50}=t,[i,s]=T(null),[l,u]=T(null),[p,d]=T(void 0),[m,c]=T(!1),[h,_]=T(null),g=async(L,k)=>{c(!0),_(null),u(L),d(k);try{const A=await le().graphHops(L,k,r,a);s(A),console.log("[Graph] Loaded:",A.nodes.length,"nodes,",A.edges.length,"edges")}catch(P){const A=String(P);_(A),console.error("[Graph] Failed to load:",P)}finally{c(!1)}},E=async L=>{await g(L,p)},b=async L=>{l&&await g(l,L)},y=()=>{s(null),u(null),d(void 0),_(null)},f=()=>i?Array.from(new Set(i.edges.map(L=>L.predicate))):[],N=L=>i==null?void 0:i.nodes.find(k=>k.gid===L),S=L=>i?i.edges.filter(k=>k.fromGid===L):[];return j(()=>{e&&l&&g(l,p)},[e]),{graphData:i,seedGid:l,predicate:p,loading:m,error:h,predicates:f(),nodeCount:(i==null?void 0:i.nodes.length)||0,edgeCount:(i==null?void 0:i.edges.length)||0,loadGraph:g,navigateToNode:E,filterByPredicate:b,clear:y,getNode:N,getNodeEdges:S}}function Ha({nodes:t,edges:e,seedGid:r,onNodeClick:a,width:i=800,height:s=600}){const[l,u]=T(new Map),p=We();return j(()=>{const d=new Map,m=i/2,c=s/2;t.forEach((h,_)=>{const g=_/t.length*2*Math.PI,E=Math.min(i,s)/3;d.set(h.gid,{gid:h.gid,x:m+E*Math.cos(g),y:c+E*Math.sin(g),vx:0,vy:0})}),u(d)},[t,i,s]),j(()=>{if(l.size===0)return;const d=()=>{const c=new Map(l),h=.3;c.forEach(_=>{c.forEach(g=>{if(_.gid===g.gid)return;const E=g.x-_.x,b=g.y-_.y,y=E*E+b*b+1,f=Math.sqrt(y),N=2e3/y;_.vx-=E/f*N*h,_.vy-=b/f*N*h})}),e.forEach(_=>{const g=c.get(_.fromGid),E=c.get(_.toGid);if(!g||!E)return;const b=E.x-g.x,y=E.y-g.y,f=Math.sqrt(b*b+y*y)+1,N=f*.01;g.vx+=b/f*N*h,g.vy+=y/f*N*h,E.vx-=b/f*N*h,E.vy-=y/f*N*h}),c.forEach(_=>{_.x+=_.vx,_.y+=_.vy,_.vx*=.8,_.vy*=.8,_.x=Math.max(30,Math.min(i-30,_.x)),_.y=Math.max(30,Math.min(s-30,_.y))}),u(c),p.current=requestAnimationFrame(d)};p.current=requestAnimationFrame(d);const m=setTimeout(()=>{p.current&&cancelAnimationFrame(p.current)},3e3);return()=>{p.current&&cancelAnimationFrame(p.current),clearTimeout(m)}},[e,i,s]),n("svg",{width:i,height:s,className:"graph-view",style:{border:"1px solid var(--color-border)",borderRadius:"8px"},children:[n("g",{className:"graph-edges",children:e.map((d,m)=>{const c=l.get(d.fromGid),h=l.get(d.toGid);return!c||!h?null:n("line",{x1:c.x,y1:c.y,x2:h.x,y2:h.y,stroke:"#94a3b8",strokeWidth:Math.max(1,d.weight*2),strokeOpacity:.6,markerEnd:"url(#arrowhead)"},`${d.fromGid}-${d.toGid}-${m}`)})}),n("defs",{children:n("marker",{id:"arrowhead",markerWidth:"10",markerHeight:"10",refX:"9",refY:"3",orient:"auto",markerUnits:"strokeWidth",children:n("path",{d:"M0,0 L0,6 L9,3 z",fill:"#94a3b8"})})}),n("g",{className:"graph-nodes",children:t.map(d=>{const m=l.get(d.gid);if(!m)return null;const c=d.gid===r,h=c?12:8,_=c?"#3b82f6":"#64748b";return n("g",{className:"graph-node",onClick:()=>a==null?void 0:a(d.gid),style:{cursor:a?"pointer":"default"},children:[n("circle",{cx:m.x,cy:m.y,r:h,fill:_,stroke:"#ffffff",strokeWidth:2,opacity:.9}),n("text",{x:m.x,y:m.y-h-5,textAnchor:"middle",fontSize:"11",fill:"var(--color-fg)",style:{pointerEvents:"none",userSelect:"none"},children:d.title||`Page ${d.pageNo}`})]},d.gid)})})]})}function $a({nodes:t,edges:e,seedGid:r,onNodeClick:a,loading:i,error:s}){return i?n("div",{className:"graph-panel-loading",children:[n("div",{className:"spinner"}),n("p",{children:"Loading graph..."})]}):s?n("div",{className:"graph-panel-error",children:n("p",{children:["Error: ",s]})}):t.length===0?n("div",{className:"graph-panel-empty",children:[n("p",{children:"No graph data to display"}),n("p",{className:"hint",children:"Search for a page or select a result to explore its connections"})]}):n("div",{className:"graph-panel",children:[n("div",{className:"graph-info",children:[n("span",{children:[t.length," nodes"]}),n("span",{children:[e.length," edges"]})]}),n(Ha,{nodes:t,edges:e,seedGid:r,onNodeClick:a,width:800,height:600})]})}function qa({predicates:t,selectedPredicate:e,onPredicateChange:r,onReset:a}){return n("div",{className:"graph-controls",children:[n("div",{className:"graph-controls-section",children:[n("label",{className:"graph-controls-label",children:"Filter by Relationship:"}),n("select",{className:"graph-controls-select",value:e||"",onChange:i=>{const s=i.target.value;r(s||void 0)},children:[n("option",{value:"",children:"All Relationships"}),t.map(i=>n("option",{value:i,children:i},i))]})]}),a&&n("button",{className:"btn-secondary btn-sm",onClick:a,children:"Reset View"})]})}function Ga({nodeCount:t,edgeCount:e,predicateCount:r,seedNode:a}){return n("div",{className:"graph-stats",children:[n("div",{className:"graph-stat",children:[n("span",{className:"graph-stat-label",children:"Nodes:"}),n("span",{className:"graph-stat-value",children:t})]}),n("div",{className:"graph-stat",children:[n("span",{className:"graph-stat-label",children:"Edges:"}),n("span",{className:"graph-stat-value",children:e})]}),n("div",{className:"graph-stat",children:[n("span",{className:"graph-stat-label",children:"Relationships:"}),n("span",{className:"graph-stat-value",children:r})]}),a&&n("div",{className:"graph-stat",children:[n("span",{className:"graph-stat-label",children:"Seed:"}),n("span",{className:"graph-stat-value",children:a})]})]})}function Wa(t={}){const{autoLoadCheckpoints:e=!1}=t,[r,a]=T([]),[i,s]=T(null),[l,u]=T(!1),[p,d]=T(!1),[m,c]=T(null),h=async()=>{u(!0),c(null);try{const b=await le().getCheckpoints();a(b),console.log("[Provenance] Loaded",b.length,"checkpoints")}catch(E){const b=String(E);c(b),console.error("[Provenance] Failed to load checkpoints:",E)}finally{u(!1)}},_=async E=>{d(!0),c(null);try{const y=await le().verifyPage(E);s(y),console.log("[Provenance] Verification result:",y)}catch(b){const y=String(b);c(y),console.error("[Provenance] Failed to verify page:",b)}finally{d(!1)}},g=()=>{s(null)};return j(()=>{e&&h()},[e]),{checkpoints:r,verificationResult:i,loading:l,verifying:p,error:m,checkpointCount:r.length,latestCheckpoint:r[0]||null,loadCheckpoints:h,verifyPage:_,clearVerification:g}}function za({checkpoint:t,isLatest:e}){return n("div",{className:`checkpoint-item ${e?"checkpoint-latest":""}`,children:[n("div",{className:"checkpoint-header",children:[n("div",{className:"checkpoint-epoch",children:[e&&n("span",{className:"checkpoint-badge",children:"Latest"}),n("span",{className:"checkpoint-epoch-value",children:["Epoch ",t.epoch]})]}),n("div",{className:"checkpoint-date",children:new Date(t.createdTs).toLocaleString()})]}),n("div",{className:"checkpoint-body",children:[n("div",{className:"checkpoint-field",children:[n("span",{className:"field-label",children:"Merkle Root:"}),n("code",{className:"field-value",title:t.merkleRoot,children:[t.merkleRoot.substring(0,16),"..."]})]}),n("div",{className:"checkpoint-field",children:[n("span",{className:"field-label",children:"Pages:"}),n("span",{className:"field-value",children:t.pagesCount})]}),t.anchors&&t.anchors.length>0&&n("div",{className:"checkpoint-field",children:[n("span",{className:"field-label",children:"Anchors:"}),n("span",{className:"field-value",children:t.anchors.length})]})]})]})}function Ba({checkpoints:t,loading:e,error:r}){return e?n("div",{className:"checkpoint-timeline-loading",children:[n("div",{className:"spinner"}),n("p",{children:"Loading checkpoints..."})]}):r?n("div",{className:"checkpoint-timeline-error",children:n("p",{children:["Error: ",r]})}):t.length===0?n("div",{className:"checkpoint-timeline-empty",children:[n("p",{children:"No checkpoints found"}),n("p",{className:"hint",children:"This capsule has not been checkpointed yet"})]}):n("div",{className:"checkpoint-timeline",children:t.map((a,i)=>n(za,{checkpoint:a,isLatest:i===0},a.epoch))})}function Xa({result:t,verifying:e,onVerify:r}){return e?n("div",{className:"verification-panel verification-loading",children:[n("div",{className:"spinner"}),n("p",{children:"Verifying page integrity..."})]}):t?n("div",{className:`verification-panel ${t.verified?"verification-success":"verification-failure"}`,children:[n("div",{className:"verification-header",children:n("div",{className:"verification-status",children:t.verified?n(se,{children:[n("span",{className:"status-icon",children:""}),n("span",{className:"status-text",children:"Verified"})]}):n(se,{children:[n("span",{className:"status-icon",children:""}),n("span",{className:"status-text",children:"Verification Failed"})]})})}),n("div",{className:"verification-body",children:[n("div",{className:"verification-field",children:[n("span",{className:"field-label",children:"Content SHA:"}),n("code",{className:"field-value",title:t.contentSha,children:[t.contentSha.substring(0,16),"..."]})]}),t.expectedSha&&n("div",{className:"verification-field",children:[n("span",{className:"field-label",children:"Expected SHA:"}),n("code",{className:"field-value",title:t.expectedSha,children:[t.expectedSha.substring(0,16),"..."]})]}),t.epoch&&n("div",{className:"verification-field",children:[n("span",{className:"field-label",children:"Checkpoint Epoch:"}),n("span",{className:"field-value",children:t.epoch})]}),t.merkleRoot&&n("div",{className:"verification-field",children:[n("span",{className:"field-label",children:"Merkle Root:"}),n("code",{className:"field-value",title:t.merkleRoot,children:[t.merkleRoot.substring(0,16),"..."]})]}),t.signer&&n("div",{className:"verification-field",children:[n("span",{className:"field-label",children:"Signer:"}),n("code",{className:"field-value",children:t.signer})]}),t.signature&&n("div",{className:"verification-field",children:[n("span",{className:"field-label",children:"Signature:"}),n("code",{className:"field-value",title:t.signature,children:[t.signature.substring(0,16),"..."]})]})]}),r&&n("div",{className:"verification-footer",children:n("button",{className:"btn-secondary btn-sm",onClick:r,children:"Verify Again"})})]}):n("div",{className:"verification-panel verification-empty",children:[n("p",{children:'Click "Verify Page" to check integrity'}),r&&n("button",{className:"btn-primary btn-sm",onClick:r,children:"Verify Page"})]})}function Va({checkpoints:t,verificationResult:e,loading:r,verifying:a,error:i,onVerify:s}){const[l,u]=T("checkpoints");return n("div",{className:"provenance-panel",children:[n("div",{className:"provenance-header",children:n("h3",{children:"Provenance & Trust"})}),n("div",{className:"provenance-tabs",children:[n("button",{className:`provenance-tab ${l==="checkpoints"?"active":""}`,onClick:()=>u("checkpoints"),children:[" Checkpoints (",t.length,")"]}),n("button",{className:`provenance-tab ${l==="verification"?"active":""}`,onClick:()=>u("verification"),children:" Verification"})]}),n("div",{className:"provenance-content",children:[l==="checkpoints"&&n(Ba,{checkpoints:t,loading:r,error:i}),l==="verification"&&n(Xa,{result:e,verifying:a,onVerify:s})]})]})}function Ya(t){const{onFocusSearch:e,onToggleLlm:r,onEscape:a}=t;j(()=>{function i(s){const l=s.target,u=l.tagName==="INPUT"||l.tagName==="TEXTAREA"||l.isContentEditable;if(s.key==="/"&&!u){s.preventDefault(),e==null||e();return}if((s.ctrlKey||s.metaKey)&&s.key==="l"){s.preventDefault(),r==null||r();return}if(s.key==="Escape"){a==null||a();return}}return window.addEventListener("keydown",i),()=>{window.removeEventListener("keydown",i)}},[e,r,a])}function Qa(){const[t,e]=T(W.getInfo()),[r,a]=T(W.getModality()),[i,s]=T(W.getEnvelopeStats());return j(()=>{const c=ce.subscribe("capsule.loaded",()=>{e(W.getInfo()),a(W.getModality()),s(W.getEnvelopeStats())}),h=ce.subscribe("capsule.unloaded",()=>{e(null),a("static"),s(null)}),_=ce.subscribe("envelope.stats",g=>{s(g)});return()=>{c(),h(),_()}},[]),{info:t,modality:r,isDynamic:r==="dynamic",envelopeStats:i,enableDynamicMode:async()=>{await W.enableDynamicMode(),a("dynamic")},exportEnvelope:async()=>W.exportEnvelope(),clearEnvelope:async()=>{await W.clearEnvelope(),s(W.getEnvelopeStats())},verifyEnvelope:async()=>W.verifyEnvelope(),setModalityPreference:c=>{W.setModalityPreference(c)}}}function ja({modality:t,envelopeStats:e,onEnableDynamic:r,onExportEnvelope:a,onClearEnvelope:i,onVerifyEnvelope:s}){const[l,u]=T(!1),[p,d]=T(!1),m=async()=>{if(r){d(!0);try{await r()}catch(E){console.error("Failed to enable dynamic mode:",E),alert(`Failed to enable dynamic mode: ${E}`)}finally{d(!1)}}},c=async()=>{if(a){d(!0);try{await a(),u(!1)}catch(E){console.error("Failed to export envelope:",E),alert(`Failed to export envelope: ${E}`)}finally{d(!1)}}},h=async()=>{if(!(!i||!confirm(`Are you sure you want to clear all envelope data?

This will delete:
 ${(e==null?void 0:e.retrievalCount)||0} retrieval logs
 ${(e==null?void 0:e.feedbackCount)||0} feedback entries
 ${(e==null?void 0:e.embeddingCount)||0} contextual embeddings
 ${(e==null?void 0:e.summaryCount)||0} context summaries

This action cannot be undone.`))){d(!0);try{await i(),u(!1)}catch(b){console.error("Failed to clear envelope:",b),alert(`Failed to clear envelope: ${b}`)}finally{d(!1)}}},_=async()=>{if(s){d(!0);try{await s(),u(!1)}catch(E){console.error("Failed to verify envelope:",E),alert(`Failed to verify envelope: ${E}`)}finally{d(!1)}}},g=t==="dynamic";return n("div",{className:"modality-badge",children:[n("button",{className:`modality-badge-button ${t}`,onClick:()=>u(!l),title:g?"Dynamic GlyphCase - Click for options":"Static GlyphCase - Click for options",children:g?" Dynamic":" Static"}),l&&n("div",{className:"modality-menu",children:[n("div",{className:"modality-menu-header",children:[n("h3",{children:g?"Dynamic Mode":"Static Mode"}),n("button",{className:"modality-menu-close",onClick:()=>u(!1),children:""})]}),g?n("div",{className:"modality-menu-content",children:[n("p",{className:"modality-description",children:"This GlyphCase has an active Envelope for episodic memory."}),e&&n("div",{className:"envelope-stats",children:[n("h4",{children:"Envelope Statistics:"}),n("div",{className:"envelope-stats-grid",children:[n("div",{className:"envelope-stat",children:[n("span",{className:"envelope-stat-label",children:"Retrievals"}),n("span",{className:"envelope-stat-value",children:e.retrievalCount})]}),n("div",{className:"envelope-stat",children:[n("span",{className:"envelope-stat-label",children:"Feedbacks"}),n("span",{className:"envelope-stat-value",children:e.feedbackCount})]}),n("div",{className:"envelope-stat",children:[n("span",{className:"envelope-stat-label",children:"Embeddings"}),n("span",{className:"envelope-stat-value",children:e.embeddingCount})]}),n("div",{className:"envelope-stat",children:[n("span",{className:"envelope-stat-label",children:"Summaries"}),n("span",{className:"envelope-stat-value",children:e.summaryCount})]})]}),e.firstActivity&&n("p",{className:"envelope-activity",children:[n("strong",{children:"Active since:"})," ",new Date(e.firstActivity).toLocaleString()]})]}),n("div",{className:"envelope-actions",children:[n("button",{className:"btn-secondary btn-sm",onClick:_,disabled:p,children:p?"Verifying...":" Verify Integrity"}),n("button",{className:"btn-secondary btn-sm",onClick:c,disabled:p,children:p?"Exporting...":" Export Envelope"}),n("button",{className:"btn-danger btn-sm",onClick:h,disabled:p,children:p?"Clearing...":" Clear Envelope"})]}),n("p",{className:"envelope-hint",children:" Envelope data persists across sessions and can be exported for remint tooling."})]}):n("div",{className:"modality-menu-content",children:[n("p",{className:"modality-description",children:"This GlyphCase is in static mode. All data is read-only."}),n("div",{className:"modality-info",children:[n("h4",{children:"Enable Dynamic Mode to:"}),n("ul",{children:[n("li",{children:"Log search queries and results"}),n("li",{children:"Provide feedback on retrievals"}),n("li",{children:"Generate contextual summaries"}),n("li",{children:"Build adaptive memory over time"})]})]}),n("button",{className:"btn-primary",onClick:m,disabled:p,children:p?"Enabling...":"Enable Dynamic Mode"})]})]}),l&&n("div",{className:"modality-menu-backdrop",onClick:()=>u(!1)})]})}function Ka(t){return t.startsWith("asset://")?{protocol:"asset",path:t.slice(8)}:null}const Ft=new Map,Ja=new Map;async function Za(t){if(Ft.has(t))return Ft.get(t);const e=Ka(t);if(!e)return console.error("[Assets] Invalid asset URL:",t),null;try{const a=await le().getPageBlob(e.path);if(!a||a.size===0)return console.warn("[Assets] Asset not found or empty:",e.path),null;const i=URL.createObjectURL(a);return Ft.set(t,i),Ja.set(t,a),console.log("[Assets] Loaded:",e.path,`(${a.size} bytes, ${a.type||"unknown type"})`),i}catch(r){return console.error("[Assets] Failed to load asset:",t,r),null}}function ei(t){const[e,r]=T(null);return j(()=>{if(!t){r(null);return}if(!t.startsWith("asset://")){r(t);return}Za(t).then(r)},[t]),e}function ti({gid:t,onClose:e}){const[r,a]=T(null),[i,s]=T(!0),[l,u]=T(null);j(()=>{(async()=>{s(!0),u(null);try{const h=await le().query("SELECT gid, doc_id, page_no, title, tags, updated_ts FROM meta_index WHERE gid = ? LIMIT 1",[t]);h.length>0?a(h[0]):u("Page not found")}catch(c){u(String(c)),console.error("[PagePreview] Failed to load page:",c)}finally{s(!1)}})()},[t]);const p=r?`asset://glyphs/page_${String(r.pageNo).padStart(4,"0")}.mgx.png`:void 0,d=ei(p);return i?n("div",{className:"page-preview",children:n("div",{className:"page-preview-loading",children:[n("div",{className:"spinner"}),n("p",{children:"Loading page..."})]})}):l||!r?n("div",{className:"page-preview",children:n("div",{className:"page-preview-error",children:[n("p",{children:["Error: ",l||"Page not found"]}),e&&n("button",{className:"btn-secondary",onClick:e,children:"Close"})]})}):n("div",{className:"page-preview",children:[n("div",{className:"page-preview-header",children:[n("div",{className:"page-preview-title",children:[n("span",{className:"page-number",children:["Page ",r.pageNo]}),n("h3",{children:r.title||"(Untitled)"})]}),e&&n("button",{className:"btn-icon",onClick:e,title:"Close preview",children:""})]}),n("div",{className:"page-preview-content",children:d?n("img",{src:d,alt:`Page ${r.pageNo}`,className:"page-image"}):n("div",{className:"page-preview-placeholder",children:n("p",{children:"No image available for this page"})})}),n("div",{className:"page-preview-metadata",children:n("dl",{children:[n("dt",{children:"GID:"}),n("dd",{children:n("code",{title:r.gid,children:[r.gid.substring(0,16),"..."]})}),r.tags&&n(se,{children:[n("dt",{children:"Tags:"}),n("dd",{children:r.tags})]}),n("dt",{children:"Updated:"}),n("dd",{children:new Date(r.updatedTs).toLocaleString()})]})})]})}function ni({selectedGid:t,onClose:e}){return t?n(ti,{gid:t,onClose:e}):n("div",{className:"page-preview-panel-empty",children:n("p",{children:"Select a search result to preview the page"})})}function ri({config:t,children:e}){return n("div",{className:"layout-landing",children:[n("section",{className:"hero",children:[n("div",{className:"hero-content",children:[t.logo_asset&&n("img",{src:t.logo_asset,alt:"Logo",className:"hero-logo"}),n("h1",{className:"hero-title",children:t.hero_title||t.site_title||"Welcome"}),t.hero_subtitle&&n("p",{className:"hero-subtitle",children:t.hero_subtitle})]}),t.hero_image&&n("div",{className:"hero-background",style:{backgroundImage:`url(${t.hero_image})`}})]}),n("main",{className:"landing-main",children:e})]})}function ai({config:t,navigation:e,currentPage:r,children:a}){const i=e.filter(s=>s.menu==="sidebar");return n("div",{className:"layout-docs",children:[n("aside",{className:"docs-sidebar",children:n("nav",{className:"docs-nav",children:[n("div",{className:"docs-nav-header",children:[t.logo_asset&&n("img",{src:t.logo_asset,alt:"Logo",className:"docs-logo"}),n("h3",{children:t.site_title||"Documentation"})]}),n("ul",{className:"docs-nav-list",children:i.map(s=>n("li",{className:"docs-nav-item",children:n("a",{href:`#${s.to_slug}`,className:(r==null?void 0:r.slug)===s.to_slug?"active":"",children:[s.icon_asset&&n("img",{src:s.icon_asset,alt:"",className:"nav-icon"}),s.label]})},s.to_slug))})]})}),n("main",{className:"docs-main",children:[r&&n("div",{className:"docs-breadcrumbs",children:[n("a",{href:"#/",children:"Home"}),r.category&&n(se,{children:[n("span",{children:" / "}),n("span",{children:r.category})]}),n("span",{children:" / "}),n("span",{children:r.title})]}),n("article",{className:"docs-content",children:[r&&n("h1",{children:r.title}),a]})]})]})}function ur({config:t,children:e}){return n("div",{className:"layout-dashboard",children:[n("header",{className:"dashboard-header",children:n("h1",{children:t.site_title||"Dashboard"})}),n("main",{className:"dashboard-content",children:e})]})}function hr({config:t,title:e,children:r}){return n("div",{className:"layout-simple",children:[n("header",{className:"simple-header",children:[t.logo_asset&&n("img",{src:t.logo_asset,alt:"Logo",className:"simple-logo"}),e&&n("h1",{children:e})]}),n("main",{className:"simple-content",children:r}),n("footer",{className:"simple-footer",children:n("p",{children:"Powered by GlyphCase"})})]})}function ii({topBar:t,leftSidebar:e,centerPanel:r,rightSidebar:a,showLeftSidebar:i=!0,showRightSidebar:s=!1}){return n("div",{className:"capsule-layout",children:[n("div",{className:"capsule-topbar",children:t}),n("div",{className:"capsule-content",children:[i&&e&&n("aside",{className:"capsule-sidebar capsule-sidebar-left",children:e}),n("main",{className:"capsule-main",children:r}),s&&a&&n("aside",{className:"capsule-sidebar capsule-sidebar-right",children:a})]})]})}function si({capsuleName:t,onClose:e,actions:r}){return n("div",{className:"topbar-content",children:[n("div",{className:"topbar-left",children:n("h2",{className:"topbar-title",children:[" ",t]})}),n("div",{className:"topbar-right",children:[r,e&&n("button",{className:"btn-secondary btn-sm",onClick:e,children:"Close Capsule"})]})]})}function li({title:t,children:e,onClear:r,hasActiveFilters:a=!1}){return n("div",{className:"filter-panel",children:[n("div",{className:"filter-panel-header",children:[n("h3",{children:t}),a&&r&&n("button",{className:"btn-link btn-sm",onClick:r,children:"Clear All"})]}),n("div",{className:"filter-panel-content",children:e})]})}function oi({limit:t=50}){const[e,r]=T([]),[a,i]=T(!1),[s,l]=T(null);j(()=>{u()},[t]);const u=async()=>{if(!W.isDynamic()){r([]);return}i(!0),l(null);try{const h=W.getEnvelope();if(!h.isOpen()){r([]);return}const _=h.getRecentActivity(t);r(_)}catch(h){l(String(h)),console.error("[EnvelopeTimeline] Failed to load:",h)}finally{i(!1)}},p=h=>{switch(h){case"retrieval":return"";case"feedback":return"";case"summary":return"";default:return""}},d=h=>{switch(h){case"retrieval":return"timeline-event-retrieval";case"feedback":return"timeline-event-feedback";case"summary":return"timeline-event-summary";default:return""}},m=h=>h===null?"":h===1?" Helpful":h===-1?" Not helpful":" Neutral",c=h=>{try{const _=new Date(h),E=new Date().getTime()-_.getTime(),b=Math.floor(E/6e4);if(b<1)return"Just now";if(b<60)return`${b}m ago`;const y=Math.floor(b/60);if(y<24)return`${y}h ago`;const f=Math.floor(y/24);return f<7?`${f}d ago`:_.toLocaleDateString()}catch{return h}};return W.isDynamic()?a?n("div",{className:"envelope-timeline",children:n("div",{className:"timeline-loading",children:[n("div",{className:"spinner"}),n("p",{children:"Loading timeline..."})]})}):s?n("div",{className:"envelope-timeline",children:n("div",{className:"timeline-error",children:[n("p",{children:" Failed to load timeline"}),n("p",{className:"error-message",children:s}),n("button",{className:"btn-secondary btn-sm",onClick:u,children:"Retry"})]})}):e.length===0?n("div",{className:"envelope-timeline",children:n("div",{className:"timeline-empty",children:[n("p",{children:"No activity yet."}),n("p",{className:"timeline-hint",children:"Search, give feedback, or generate summaries to populate the timeline."})]})}):n("div",{className:"envelope-timeline",children:[n("div",{className:"timeline-header",children:[n("h3",{children:" Activity Timeline"}),n("span",{className:"timeline-count",children:[e.length," events"]})]}),n("div",{className:"timeline-events",children:e.map((h,_)=>n("div",{className:`timeline-event ${d(h.eventType)}`,children:[n("div",{className:"timeline-event-icon",children:p(h.eventType)}),n("div",{className:"timeline-event-content",children:[n("div",{className:"timeline-event-header",children:[n("span",{className:"timeline-event-type",children:h.eventType.charAt(0).toUpperCase()+h.eventType.slice(1)}),n("span",{className:"timeline-event-time",children:c(h.timestamp)})]}),n("div",{className:"timeline-event-description",children:h.description}),h.eventType==="feedback"&&h.value!==null&&n("div",{className:"timeline-event-meta",children:m(h.value)}),h.eventType==="summary"&&h.value!==null&&n("div",{className:"timeline-event-meta",children:["Relevance: ",(h.value*100).toFixed(0),"%"]})]})]},`${h.id}-${_}`))}),n("div",{className:"timeline-footer",children:n("button",{className:"btn-secondary btn-sm",onClick:u,children:"Refresh Timeline"})})]}):n("div",{className:"envelope-timeline",children:n("div",{className:"timeline-empty",children:[n("p",{children:"Timeline is only available in Dynamic mode."}),n("p",{className:"timeline-hint",children:"Enable Dynamic mode to start tracking activity."})]})})}class Ee extends Ge{constructor(r){super(r);M(this,"reset",()=>{this.setState({hasError:!1,error:null})});this.state={hasError:!1,error:null}}static getDerivedStateFromError(r){return{hasError:!0,error:r}}componentDidCatch(r,a){const{name:i="Unknown"}=this.props;console.error(`[ErrorBoundary:${i}]`,r,a)}render(){const{hasError:r,error:a}=this.state,{children:i,fallback:s,name:l="Component"}=this.props;return r&&a?s?s(a,this.reset):n("div",{className:"error-boundary",children:n("div",{className:"error-boundary-content",children:[n("h3",{children:[" ",l," Error"]}),n("p",{className:"error-message",children:a.message}),n("button",{className:"btn-secondary",onClick:this.reset,children:"Try Again"}),!1]})}):i}}function ci({capsuleInfo:t,onClose:e}){var P;const[r,a]=T("search"),[i,s]=T(null),[l,u]=T(!1),[p,d]=T(!1),m=ar({defaultMode:"fts"}),c=cr({autoLoad:!0}),h=Ua({maxHops:2,limit:50}),_=Wa({autoLoadCheckpoints:!0}),g=dr({}),E=Qa();Ya({onFocusSearch:()=>{const A=document.querySelector('input[name="query"]');A==null||A.focus(),A==null||A.select()},onToggleLlm:()=>{g.toggle()},onEscape:()=>{document.activeElement instanceof HTMLElement&&document.activeElement.blur()}});const b=A=>{s(A)},y=A=>{h.navigateToNode(A),s(A)},f=A=>{a("graph"),h.loadGraph(A),s(A)},N=()=>{m.clearFilter(),m.lastQuery&&m.search(m.lastQuery)},S=()=>{i&&(_.verifyPage(i),u(!0))},L=async()=>{g.enabled&&m.results&&m.results.length>0&&m.lastQuery&&(g.clearReasoning(),await g.reason(m.lastQuery,m.results,1500))};j(()=>{g.enabled&&m.results&&m.results.length>0&&m.lastQuery&&(!g.reasoning||g.reasoning.usedSnippets.length===0)&&L()},[g.enabled,m.results,m.lastQuery]);const k=!!(m.entityFilter.entityType||m.entityFilter.entityValue);return n(ii,{topBar:n(si,{capsuleName:t.fileName,onClose:e,actions:n(se,{children:[n("div",{className:"capsule-stats",children:[n("span",{children:[t.pageCount," pages"]}),n("span",{children:[t.entityCount," entities"]}),n("span",{children:[t.edgeCount," edges"]})]}),n(ja,{modality:E.modality,envelopeStats:E.envelopeStats,onEnableDynamic:E.enableDynamicMode,onExportEnvelope:async()=>{const A=await E.exportEnvelope();if(A){const ne=URL.createObjectURL(A),ue=document.createElement("a");ue.href=ne,ue.download=`envelope_${Date.now()}.db`,ue.click(),URL.revokeObjectURL(ne)}},onClearEnvelope:E.clearEnvelope,onVerifyEnvelope:async()=>{const A=await E.verifyEnvelope();A&&(A.valid?alert(` Envelope integrity verified!

The hash chain is intact.`):alert(` Envelope integrity check failed:

${A.errors.join(`
`)}`))}}),n("button",{className:`btn-secondary btn-sm ${g.enabled?"active":""}`,onClick:g.toggle,disabled:g.loading,title:(P=g.modelInfo)!=null&&P.loaded?"LLM Ready":"Click to load LLM",children:[" ",g.enabled?"LLM On":"LLM Off"]}),n("button",{className:`btn-secondary btn-sm ${l?"active":""}`,onClick:()=>u(!l),children:[l?"":""," Provenance"]}),E.isDynamic&&n("button",{className:`btn-secondary btn-sm ${p?"active":""}`,onClick:()=>d(!p),children:[p?"":""," Timeline"]})]})}),leftSidebar:n(Ee,{name:"EntityPanel",children:n(li,{title:"Entity Filters",onClear:N,hasActiveFilters:k,children:[k&&n("div",{className:"active-filters",children:[n("p",{className:"filter-label",children:"Active Filter:"}),m.entityFilter.entityType&&n("span",{className:"filter-tag",children:["Type: ",m.entityFilter.entityType]}),m.entityFilter.entityValue&&n("span",{className:"filter-tag",children:["Value: ",m.entityFilter.entityValue]})]}),n(Ca,{entities:c.entities,types:c.types,selectedType:c.selectedType,totalCount:c.totalCount,onSelectType:c.selectType,getTypeCount:c.getTypeCount,show:!0,maxDisplay:20})]})}),centerPanel:n("div",{className:"capsule-center",children:[n("div",{className:"view-mode-tabs",children:[n("button",{className:`tab-btn ${r==="search"?"active":""}`,onClick:()=>a("search"),children:" Search"}),n("button",{className:`tab-btn ${r==="graph"?"active":""}`,onClick:()=>a("graph"),children:" Graph"})]}),r==="search"&&n(se,{children:[n(Ee,{name:"SearchPanel",children:n(Ta,{mode:m.mode,results:m.results,lastQuery:m.lastQuery,loading:m.loading,onSearch:m.search,onModeChange:m.changeMode,onResultClick:b,showModeToggle:!0,placeholder:"Search the capsule...",searchHint:'Try: "vector search", "LEANN", "SQLite", or "hybrid retrieval"',searchHistory:m.searchHistory,onClearHistory:m.clearHistory})}),n(Ee,{name:"LLM",children:[g.enabled&&m.results&&m.results.length>0&&n("div",{className:"llm-section",children:[n("div",{className:"llm-temperature-control",children:[n("label",{htmlFor:"temperature-slider",className:"temperature-label",children:["Creativity:",n("input",{id:"temperature-slider",type:"range",min:"0",max:"1",step:"0.1",value:g.temperature,onChange:A=>g.setTemperature(parseFloat(A.currentTarget.value)),className:"temperature-slider"}),n("span",{className:"temperature-value",children:g.temperature.toFixed(1)})]}),n("small",{className:"temperature-hint",children:[g.temperature<.3&&" Very factual",g.temperature>=.3&&g.temperature<.6&&" Mostly factual",g.temperature>=.6&&g.temperature<.8&&" Balanced",g.temperature>=.8&&" Creative"]})]}),g.progress&&n("div",{className:"llm-progress-bar",children:[n("div",{className:"llm-progress-info",children:[n("span",{children:[" ",g.progress.message]}),n("span",{children:[(g.progress.progress*100).toFixed(0),"%"]})]}),n("div",{className:"llm-progress-track",children:n("div",{className:"llm-progress-fill",style:{width:`${g.progress.progress*100}%`}})})]}),g.isStreaming&&g.streamingText&&n("div",{className:"streaming-output",children:[n("div",{className:"streaming-header",children:[n("span",{className:"streaming-indicator",children:" Streaming..."}),n("button",{className:"btn-secondary btn-sm abort-btn",onClick:()=>g.abortReasoning(),title:"Stop reasoning",children:" Stop"})]}),n("div",{className:"streaming-text",children:[g.streamingText,n("span",{className:"streaming-cursor",children:""})]})]}),g.reasoning&&n(ka,{reasoning:g.reasoning,searchResults:m.results,loading:g.loading}),g.loading&&!g.reasoning&&!g.progress&&!g.isStreaming&&n("div",{className:"reasoning-loading",children:[n("div",{className:"spinner"}),n("p",{children:"LLM is reasoning over search results..."}),g.elapsedTime>0&&n("p",{className:"inference-time",children:["Elapsed: ",g.elapsedTime.toFixed(1),"s",g.elapsedTime>3&&"  Typically takes 2-5s"]})]}),g.error&&n("div",{className:"llm-error-panel",children:[n("strong",{children:" LLM Error:"})," ",g.error,n("button",{className:"btn-secondary btn-sm",onClick:L,disabled:g.loading,style:{marginLeft:"1rem"},children:g.loading?"Retrying...":"Try Again"})]})]}),g.enabled&&(!m.results||m.results.length===0)&&m.lastQuery&&n("div",{className:"llm-no-results",children:n("p",{children:" LLM needs search results to reason. Try searching first!"})})]})]}),r==="graph"&&n(Ee,{name:"GraphPanel",children:n("div",{className:"graph-view-container",children:[!h.graphData&&n("div",{className:"graph-view-empty",children:[n("p",{children:"Select a search result to explore its graph connections"}),n("p",{className:"hint",children:"Or switch to Search tab to find pages"})]}),h.graphData&&n(se,{children:[n(Ga,{nodeCount:h.nodeCount,edgeCount:h.edgeCount,predicateCount:h.predicates.length,seedNode:h.seedGid||void 0}),n(qa,{predicates:h.predicates,selectedPredicate:h.predicate,onPredicateChange:h.filterByPredicate,onReset:h.clear}),n($a,{nodes:h.graphData.nodes,edges:h.graphData.edges,seedGid:h.seedGid||void 0,onNodeClick:y,loading:h.loading,error:h.error})]})]})}),i&&n(Ee,{name:"PagePreview",children:n("div",{className:"page-preview-section",children:[n("div",{className:"page-preview-header-actions",children:[n("h3",{children:"Page Preview"}),n("div",{className:"page-preview-actions",children:[r==="search"&&n("button",{className:"btn-secondary btn-sm",onClick:()=>f(i),children:"Explore Graph"}),n("button",{className:"btn-primary btn-sm",onClick:S,disabled:_.verifying,children:_.verifying?"Verifying...":"Verify Page"})]})]}),n(ni,{selectedGid:i,onClose:()=>s(null)})]})})]}),rightSidebar:n(se,{children:[l&&n(Ee,{name:"ProvenancePanel",children:n(Va,{checkpoints:_.checkpoints,verificationResult:_.verificationResult,loading:_.loading,verifying:_.verifying,error:_.error,onVerify:S})}),p&&E.isDynamic&&n(Ee,{name:"EnvelopeTimeline",children:n(oi,{limit:100})})]}),showLeftSidebar:!0,showRightSidebar:l||p})}async function di(t){const r=(await t.query("SELECT name FROM sqlite_master WHERE type='table'")).map(h=>h.name),a=r.includes("_ui_pages"),i=r.includes("_ui_dashboards"),s=r.includes("_ui_navigation"),l=r.includes("_ui_params"),u=r.includes("_meta_manifest"),p=r.includes("sqlar"),d=r.some(h=>h.startsWith("fts_"));let m="1.0";if(u)try{const h=await t.query("SELECT value FROM _meta_manifest WHERE key='gcui'");h.length>0&&(m=h[0].value)}catch(h){console.warn("Failed to read GCUI version:",h)}let c;return a&&i?c="hybrid":a?c="website":i?c="dashboard":c="generic",{version:m,hasWebsite:a,hasDashboards:i,hasNavigation:s,hasParams:l,hasFTS:d,hasAssets:p,mode:c}}async function ui(t){try{const e=await t.query("SELECT key, value FROM _meta_manifest");if(e.length===0)return null;const r={gcui:"1.0",capsule_kind:"sqlar"};return e.forEach(a=>{r[a.key]=a.value}),r}catch(e){return console.warn("Failed to load manifest:",e),null}}async function hi(t){try{const e=await t.query("SELECT key, value FROM _ui_config"),r={};return e.forEach(a=>{r[a.key]=a.value}),r}catch(e){return console.warn("Failed to load config:",e),{}}}async function pi(t){try{return(await t.query("SELECT slug, title, content, layout, category, order_index FROM _ui_pages ORDER BY order_index ASC, slug ASC")).map(r=>({slug:r.slug,title:r.title,content:r.content||void 0,layout:r.layout||void 0,category:r.category||void 0,order_index:r.order_index||void 0}))}catch(e){return console.warn("Failed to load pages:",e),[]}}async function mi(t){try{return(await t.query("SELECT menu, label, to_slug, order_index, icon_asset FROM _ui_navigation ORDER BY menu, order_index ASC")).map(r=>({menu:r.menu,label:r.label,to_slug:r.to_slug,order_index:r.order_index||void 0,icon_asset:r.icon_asset||void 0}))}catch(e){return console.warn("Failed to load navigation:",e),[]}}async function fi(t){try{return(await t.query("SELECT name, query, grammar, config FROM _ui_dashboards")).map(r=>({name:r.name,query:r.query,grammar:r.grammar||void 0,config:r.config||void 0}))}catch(e){return console.warn("Failed to load dashboards:",e),[]}}async function gi(t){const e=await di(t),r=await ui(t)||{gcui:e.version,capsule_kind:"sqlar"},a=await hi(t),i=e.hasWebsite?await pi(t):[],s=e.hasNavigation?await mi(t):[],l=e.hasDashboards?await fi(t):[];return{manifest:r,capabilities:e,config:a,pages:i,navigation:s,dashboards:l}}function _i({data:t,config:e,width:r=600,height:a=400}){if(!t||t.length===0)return n("div",{className:"chart-empty",style:{width:r,height:a},children:n("p",{children:"No data to display"})});switch(e.mark){case"bar":return n(yi,{data:t,config:e,width:r,height:a});case"line":return n(vi,{data:t,config:e,width:r,height:a});case"point":return n(bi,{data:t,config:e,width:r,height:a});case"area":return n(Ei,{data:t,config:e,width:r,height:a});default:return n("div",{className:"chart-unsupported",style:{width:r,height:a},children:[n("p",{children:["Unsupported chart type: ",e.mark]}),n("p",{children:"Showing data as table:"}),n(Ni,{data:t})]})}}function yi({data:t,config:e,width:r,height:a}){var d,m;const{encoding:i}=e,s=((d=i.x)==null?void 0:d.field)||Object.keys(t[0])[0],l=((m=i.y)==null?void 0:m.field)||Object.keys(t[0])[1],u=Math.max(...t.map(c=>Number(c[l])||0)),p=Math.max(20,(r-100)/t.length-10);return n("div",{className:"chart chart-bar",style:{width:r,height:a},children:[e.title&&n("h4",{className:"chart-title",children:e.title}),n("div",{className:"chart-container",style:{height:a-60},children:n("div",{className:"chart-bars",style:{display:"flex",alignItems:"flex-end",height:"100%",gap:"8px"},children:t.map((c,h)=>{const _=Number(c[l])||0,g=_/u*(a-100);return n("div",{className:"chart-bar-item",style:{textAlign:"center"},children:[n("div",{className:"bar",style:{width:p,height:g,backgroundColor:"#6366f1",borderRadius:"4px 4px 0 0"},title:`${c[s]}: ${_}`}),n("div",{className:"bar-label",style:{fontSize:"12px",marginTop:"4px",maxWidth:p,overflow:"hidden",textOverflow:"ellipsis"},children:String(c[s]).slice(0,10)})]},h)})})}),n("div",{className:"chart-legend",style:{fontSize:"12px",marginTop:"8px",textAlign:"center"},children:[n("strong",{children:l})," by ",n("strong",{children:s})]})]})}function vi({data:t,config:e,width:r,height:a}){var b,y;const{encoding:i}=e,s=((b=i.x)==null?void 0:b.field)||Object.keys(t[0])[0],l=((y=i.y)==null?void 0:y.field)||Object.keys(t[0])[1],u=t.map(f=>Number(f[l])||0),p=Math.max(...u),d=Math.min(...u),m=p-d||1,c=r-80,h=a-100,_=c/(t.length-1||1),g=t.map((f,N)=>{const S=40+N*_,L=Number(f[l])||0,k=h-(L-d)/m*h+20;return{x:S,y:k,value:L,label:f[s]}}),E=g.map((f,N)=>`${N===0?"M":"L"} ${f.x} ${f.y}`).join(" ");return n("div",{className:"chart chart-line",style:{width:r,height:a},children:[e.title&&n("h4",{className:"chart-title",children:e.title}),n("svg",{width:r,height:a-40,style:{overflow:"visible"},children:[[0,.25,.5,.75,1].map(f=>{const N=h-f*h+20,S=d+f*m;return n("g",{children:[n("line",{x1:40,y1:N,x2:r-40,y2:N,stroke:"#e5e7eb",strokeWidth:1}),n("text",{x:10,y:N+4,fontSize:10,fill:"#666",children:S.toFixed(0)})]},f)}),n("path",{d:E,fill:"none",stroke:"#6366f1",strokeWidth:2}),g.map((f,N)=>n("circle",{cx:f.x,cy:f.y,r:4,fill:"#6366f1",children:n("title",{children:`${f.label}: ${f.value}`})},N)),g.map((f,N)=>n("text",{x:f.x,y:h+40,fontSize:10,fill:"#666",textAnchor:"middle",children:String(f.label).slice(0,8)},N))]}),n("div",{className:"chart-legend",style:{fontSize:"12px",textAlign:"center"},children:[n("strong",{children:l})," over ",n("strong",{children:s})]})]})}function bi({data:t,config:e,width:r,height:a}){var y,f;const{encoding:i}=e,s=((y=i.x)==null?void 0:y.field)||Object.keys(t[0])[0],l=((f=i.y)==null?void 0:f.field)||Object.keys(t[0])[1],u=t.map(N=>Number(N[s])||0),p=t.map(N=>Number(N[l])||0),d=Math.min(...u),m=Math.max(...u),c=Math.min(...p),h=Math.max(...p),_=m-d||1,g=h-c||1,E=r-80,b=a-100;return n("div",{className:"chart chart-scatter",style:{width:r,height:a},children:[e.title&&n("h4",{className:"chart-title",children:e.title}),n("svg",{width:r,height:a-40,children:[[0,.25,.5,.75,1].map(N=>{const S=b-N*b+20;return n("line",{x1:40,y1:S,x2:r-40,y2:S,stroke:"#e5e7eb",strokeWidth:1},N)}),t.map((N,S)=>{const L=Number(N[s])||0,k=Number(N[l])||0,P=40+(L-d)/_*E,A=b-(k-c)/g*b+20;return n("circle",{cx:P,cy:A,r:5,fill:"#6366f1",opacity:.7,children:n("title",{children:`${s}: ${L}, ${l}: ${k}`})},S)})]}),n("div",{className:"chart-legend",style:{fontSize:"12px",textAlign:"center"},children:[n("strong",{children:l})," vs ",n("strong",{children:s})]})]})}function Ei({data:t,config:e,width:r,height:a}){var y,f;const{encoding:i}=e,s=((y=i.x)==null?void 0:y.field)||Object.keys(t[0])[0],l=((f=i.y)==null?void 0:f.field)||Object.keys(t[0])[1],u=t.map(N=>Number(N[l])||0),p=Math.max(...u),d=Math.min(...u),m=p-d||1,c=r-80,h=a-100,_=c/(t.length-1||1),E=t.map((N,S)=>{const L=40+S*_,k=Number(N[l])||0,P=h-(k-d)/m*h+20;return{x:L,y:P}}).map((N,S)=>`${S===0?"M":"L"} ${N.x} ${N.y}`).join(" "),b=`${E} L ${r-40} ${h+20} L 40 ${h+20} Z`;return n("div",{className:"chart chart-area",style:{width:r,height:a},children:[e.title&&n("h4",{className:"chart-title",children:e.title}),n("svg",{width:r,height:a-40,children:[n("path",{d:b,fill:"#6366f1",opacity:.3}),n("path",{d:E,fill:"none",stroke:"#6366f1",strokeWidth:2})]}),n("div",{className:"chart-legend",style:{fontSize:"12px",textAlign:"center"},children:[n("strong",{children:l})," over ",n("strong",{children:s})]})]})}function Ni({data:t}){if(t.length===0)return null;const e=Object.keys(t[0]);return n("table",{className:"data-table",style:{width:"100%",borderCollapse:"collapse",fontSize:"12px"},children:[n("thead",{children:n("tr",{children:e.map(r=>n("th",{style:{borderBottom:"2px solid #ddd",padding:"8px",textAlign:"left"},children:r},r))})}),n("tbody",{children:t.slice(0,10).map((r,a)=>n("tr",{children:e.map(i=>n("td",{style:{borderBottom:"1px solid #eee",padding:"6px"},children:String(r[i])},i))},a))})]})}function pr({dashboards:t}){return t.length===0?n("div",{className:"dashboard-empty",children:n("p",{children:"No dashboards defined"})}):n("div",{className:"dashboard-grid",children:t.map(e=>n(Ti,{dashboard:e},e.name))})}function Ti({dashboard:t}){const[e,r]=T(null),[a,i]=T(!1),[s,l]=T(null);j(()=>{u()},[t.query]);const u=async()=>{i(!0),l(null);try{const m=await le().query(t.query);r(m)}catch(d){l(String(d)),console.error(`[Dashboard] Failed to load ${t.name}:`,d)}finally{i(!1)}};if(a)return n("div",{className:"dashboard-panel loading",children:[n("div",{className:"spinner"}),n("p",{children:["Loading ",t.name,"..."]})]});if(s)return n("div",{className:"dashboard-panel error",children:[n("h4",{children:t.name}),n("p",{className:"error-message",children:["Error: ",s]}),n("details",{children:[n("summary",{children:"Query"}),n("pre",{children:t.query})]})]});if(!e||e.length===0)return n("div",{className:"dashboard-panel empty",children:[n("h4",{children:t.name}),n("p",{children:"No data"})]});let p=null;if(t.config)try{p=JSON.parse(t.config)}catch(d){console.error(`[Dashboard] Invalid config for ${t.name}:`,d)}return!p||t.grammar!=="vegalite-lite-v1"?n("div",{className:"dashboard-panel table",children:[n("h4",{children:t.name}),n(Si,{data:e})]}):n("div",{className:"dashboard-panel chart",children:n(_i,{data:e,config:p,width:600,height:400})})}function Si({data:t}){const e=Object.keys(t[0]||{});return n("div",{style:{overflowX:"auto"},children:n("table",{className:"dashboard-table",style:{width:"100%",borderCollapse:"collapse",fontSize:"14px"},children:[n("thead",{children:n("tr",{children:e.map(r=>n("th",{style:{borderBottom:"2px solid #ddd",padding:"12px",textAlign:"left",fontWeight:600},children:r},r))})}),n("tbody",{children:t.map((r,a)=>n("tr",{style:{borderBottom:"1px solid #eee"},children:e.map(i=>n("td",{style:{padding:"10px"},children:String(r[i])},i))},a))})]})})}function wi({content:t}){const e=Ci(t),r=Kt.sanitize(e,{ALLOWED_TAGS:["h1","h2","h3","h4","h5","h6","p","br","strong","em","code","pre","a","ul","ol","li"],ALLOWED_ATTR:["href"],ALLOW_DATA_ATTR:!1});return n("div",{className:"markdown-content",dangerouslySetInnerHTML:{__html:r}})}function Ci(t){let e=t;return e=e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;"),e=e.replace(/^### (.*$)/gim,"<h3>$1</h3>"),e=e.replace(/^## (.*$)/gim,"<h2>$1</h2>"),e=e.replace(/^# (.*$)/gim,"<h1>$1</h1>"),e=e.replace(/\*\*(.*?)\*\*/g,"<strong>$1</strong>"),e=e.replace(/\*(.*?)\*/g,"<em>$1</em>"),e=e.replace(/`(.*?)`/g,"<code>$1</code>"),e=e.replace(/\[(.*?)\]\((.*?)\)/g,'<a href="$2">$1</a>'),e=e.replace(/```(.*?)\n([\s\S]*?)```/g,"<pre><code>$2</code></pre>"),e=e.replace(/^\- (.*$)/gim,"<li>$1</li>"),e=e.replace(/(<li>.*<\/li>)/s,"<ul>$1</ul>"),e=e.replace(/^\d+\. (.*$)/gim,"<li>$1</li>"),e=e.split(`

`).map(a=>a.startsWith("<h")||a.startsWith("<ul>")||a.startsWith("<ol>")||a.startsWith("<pre>")||a.startsWith("<li>")?a:`<p>${a}</p>`).join(`
`),e=e.replace(/\n/g,"<br>"),e}function Li({context:t}){const[e,r]=T("/");j(()=>{const i=()=>{const s=window.location.hash.slice(1);r(s||"/")};return window.addEventListener("hashchange",i),i(),()=>window.removeEventListener("hashchange",i)},[]);const a=t.pages.find(i=>i.slug===e)||t.pages[0];return a?n(Ai,{page:a,context:t}):t.dashboards.length>0?n(ur,{config:t.config,children:n(pr,{dashboards:t.dashboards})}):n(hr,{config:t.config,title:"404 Not Found",children:[n("p",{children:["Page not found: ",e]}),n("p",{children:n("a",{href:"#/",children:"Go home"})})]})}function Ai({page:t,context:e}){const r=t.layout||"simple",a=t.content?n(wi,{content:t.content}):n("p",{children:"No content"});switch(r){case"landing":return n(ri,{config:e.config,children:a});case"docs":return n(ai,{config:e.config,navigation:e.navigation,currentPage:t,children:a});case"dashboard":return n(ur,{config:e.config,children:[a,e.dashboards.length>0&&n(pr,{dashboards:e.dashboards})]});case"simple":default:return n(hr,{config:e.config,title:t.title,children:a})}}const ki={mode:"website",bundledCapsule:"/memglyph-demo.mgx.sqlite",branding:{title:"Memglyph",tagline:"Your knowledge, crystallized",logoUrl:"/logo.svg"},features:{llm:{enabled:!0,autoReason:!1,defaultModel:"qwen3-0.6b",maxTokens:256},search:{defaultMode:"hybrid",enabledModes:["fts","hybrid"],showModeToggle:!1},graph:{enabled:!0,maxHops:2,defaultMaxHops:1},upload:{enabled:!1,acceptedExtensions:[]},gcui:{enabled:!0,fallbackToGeneric:!1},pwa:{enabled:!0,offlineMode:!0}},ui:{showLanding:!0,theme:"documentation"}},Ri={mode:"viewer",bundledCapsule:"/memglyph-demo.mgx.sqlite",branding:{title:"SQLAR Viewer",tagline:"Query your knowledge capsules",logoUrl:"/sqlar-logo.svg"},features:{llm:{enabled:!0,autoReason:!1,defaultModel:"qwen3-0.6b",maxTokens:256},search:{defaultMode:"hybrid",enabledModes:["fts","hybrid","graph"],showModeToggle:!0},graph:{enabled:!0,maxHops:3,defaultMaxHops:2},upload:{enabled:!0,acceptedExtensions:[".sqlite",".sqlar",".db",".mgx.sqlite"]},gcui:{enabled:!0,fallbackToGeneric:!0},pwa:{enabled:!0,offlineMode:!0}},ui:{showLanding:!1,theme:"tool"}};function Oi(){return"website"}function Mi(){return Oi()==="viewer"?Ri:ki}function xi(){const t=Mi(),[e,r]=T(null),[a,i]=T(null),[s,l]=T(!1),[u,p]=T(null),[d,m]=T(!1);ar({defaultMode:t.features.search.defaultMode});const c=cr({autoLoad:!1});return dr({}),j(()=>{e&&(c.loadEntities(),(async()=>{try{const y=le(),f=await gi(y);console.log("[GCUI] Detected capabilities:",f.capabilities),f.capabilities.mode!=="generic"?(i(f),console.log("[GCUI] Rendering in",f.capabilities.mode,"mode")):(console.log("[GCUI] No GCUI tables found, using legacy mode"),i(null))}catch(y){console.warn("[GCUI] Detection failed, using legacy mode:",y),i(null)}})())},[e]),n("div",{className:"app",children:[n("header",{className:"app-header",children:[n("h1",{children:"GlyphCase Explorer"}),n("p",{children:"Hybrid Retrieval + Dynamic Memory for MemGlyph"})]}),n("main",{className:"app-main",children:e?a&&t.features.gcui.enabled?n("div",{className:"gcui-mode",children:n(Li,{context:a})}):n(ci,{capsuleInfo:e,onClose:()=>r(null)}):n("div",{className:"welcome",children:[u&&n("div",{className:"error",style:"max-width: 600px; margin: 1rem auto;",children:[n("strong",{children:"Error:"})," ",u]}),n(Pa,{onFileSelected:async(b,y)=>{l(!0),p(null);try{const N=await le().openFromFile(b);r(N),console.log("Capsule opened:",N)}catch(f){p(String(f)),console.error("Failed to open file:",f)}finally{l(!1)}},onOpfsFileSelected:async b=>{l(!0),p(null);try{const f=await le().openFromOpfs(b);r(f),console.log("Capsule opened from OPFS:",f)}catch(y){p(String(y)),console.error("Failed to open from OPFS:",y)}finally{l(!1)}},onError:b=>{p(b)}}),n("div",{style:"text-align: center; margin-top: 1.5rem;",children:[n("p",{style:"margin-bottom: 0.5rem; opacity: 0.7;",children:"Or try the demo:"}),n("button",{className:"btn-secondary",onClick:async()=>{l(!0),p(null);try{const y=await le().openDemo();r(y),console.log("Capsule info:",y)}catch(b){p(String(b)),console.error("Failed to open capsule:",b)}finally{l(!1)}},disabled:s,children:s?"Loading Demo...":"Load Demo Capsule"})]})]})}),n("footer",{className:"app-footer",children:n("p",{children:"Built with Preact + SQLite WASM + OPFS"})})]})}Rr(n(xi,{}),document.getElementById("app"));
