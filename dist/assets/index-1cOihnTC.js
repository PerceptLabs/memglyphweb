var Er=Object.defineProperty;var Tr=(t,e,n)=>e in t?Er(t,e,{enumerable:!0,configurable:!0,writable:!0,value:n}):t[e]=n;var x=(t,e,n)=>Tr(t,typeof e!="symbol"?e+"":e,n);(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))a(i);new MutationObserver(i=>{for(const s of i)if(s.type==="childList")for(const o of s.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&a(o)}).observe(document,{childList:!0,subtree:!0});function n(i){const s={};return i.integrity&&(s.integrity=i.integrity),i.referrerPolicy&&(s.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?s.credentials="include":i.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function a(i){if(i.ep)return;i.ep=!0;const s=n(i);fetch(i.href,s)}})();var lt,F,Gn,ve,vn,qn,Wn,zn,Wt,It,Ft,$e={},Bn=[],Nr=/acit|ex(?:s|g|n|p|$)|rph|grid|ows|mnc|ntw|ine[ch]|zoo|^ord|itera/i,ct=Array.isArray;function fe(t,e){for(var n in e)t[n]=e[n];return t}function zt(t){t&&t.parentNode&&t.parentNode.removeChild(t)}function Sr(t,e,n){var a,i,s,o={};for(s in e)s=="key"?a=e[s]:s=="ref"?i=e[s]:o[s]=e[s];if(arguments.length>2&&(o.children=arguments.length>3?lt.call(arguments,2):n),typeof t=="function"&&t.defaultProps!=null)for(s in t.defaultProps)o[s]===void 0&&(o[s]=t.defaultProps[s]);return et(t,o,a,i,null)}function et(t,e,n,a,i){var s={type:t,props:e,key:n,ref:a,__k:null,__:null,__b:0,__e:null,__c:null,constructor:void 0,__v:i??++Gn,__i:-1,__u:0};return i==null&&F.vnode!=null&&F.vnode(s),s}function re(t){return t.children}function tt(t,e){this.props=t,this.context=e}function Re(t,e){if(e==null)return t.__?Re(t.__,t.__i+1):null;for(var n;e<t.__k.length;e++)if((n=t.__k[e])!=null&&n.__e!=null)return n.__e;return typeof t.type=="function"?Re(t):null}function Xn(t){var e,n;if((t=t.__)!=null&&t.__c!=null){for(t.__e=t.__c.base=null,e=0;e<t.__k.length;e++)if((n=t.__k[e])!=null&&n.__e!=null){t.__e=t.__c.base=n.__e;break}return Xn(t)}}function bn(t){(!t.__d&&(t.__d=!0)&&ve.push(t)&&!at.__r++||vn!=F.debounceRendering)&&((vn=F.debounceRendering)||qn)(at)}function at(){for(var t,e,n,a,i,s,o,h=1;ve.length;)ve.length>h&&ve.sort(Wn),t=ve.shift(),h=ve.length,t.__d&&(n=void 0,a=void 0,i=(a=(e=t).__v).__e,s=[],o=[],e.__P&&((n=fe({},a)).__v=a.__v+1,F.vnode&&F.vnode(n),Bt(e.__P,n,a,e.__n,e.__P.namespaceURI,32&a.__u?[i]:null,s,i??Re(a),!!(32&a.__u),o),n.__v=a.__v,n.__.__k[n.__i]=n,Qn(s,n,o),a.__e=a.__=null,n.__e!=i&&Xn(n)));at.__r=0}function Vn(t,e,n,a,i,s,o,h,u,d,f){var c,p,g,b,T,E,y,m=a&&a.__k||Bn,v=e.length;for(u=wr(n,e,m,u,v),c=0;c<v;c++)(g=n.__k[c])!=null&&(p=g.__i==-1?$e:m[g.__i]||$e,g.__i=c,E=Bt(t,g,p,i,s,o,h,u,d,f),b=g.__e,g.ref&&p.ref!=g.ref&&(p.ref&&Xt(p.ref,null,g),f.push(g.ref,g.__c||b,g)),T==null&&b!=null&&(T=b),(y=!!(4&g.__u))||p.__k===g.__k?u=Yn(g,u,t,y):typeof g.type=="function"&&E!==void 0?u=E:b&&(u=b.nextSibling),g.__u&=-7);return n.__e=T,u}function wr(t,e,n,a,i){var s,o,h,u,d,f=n.length,c=f,p=0;for(t.__k=new Array(i),s=0;s<i;s++)(o=e[s])!=null&&typeof o!="boolean"&&typeof o!="function"?(u=s+p,(o=t.__k[s]=typeof o=="string"||typeof o=="number"||typeof o=="bigint"||o.constructor==String?et(null,o,null,null,null):ct(o)?et(re,{children:o},null,null,null):o.constructor==null&&o.__b>0?et(o.type,o.props,o.key,o.ref?o.ref:null,o.__v):o).__=t,o.__b=t.__b+1,h=null,(d=o.__i=Cr(o,n,u,c))!=-1&&(c--,(h=n[d])&&(h.__u|=2)),h==null||h.__v==null?(d==-1&&(i>f?p--:i<f&&p++),typeof o.type!="function"&&(o.__u|=4)):d!=u&&(d==u-1?p--:d==u+1?p++:(d>u?p--:p++,o.__u|=4))):t.__k[s]=null;if(c)for(s=0;s<f;s++)(h=n[s])!=null&&!(2&h.__u)&&(h.__e==a&&(a=Re(h)),Kn(h,h));return a}function Yn(t,e,n,a){var i,s;if(typeof t.type=="function"){for(i=t.__k,s=0;i&&s<i.length;s++)i[s]&&(i[s].__=t,e=Yn(i[s],e,n,a));return e}t.__e!=e&&(a&&(e&&t.type&&!e.parentNode&&(e=Re(t)),n.insertBefore(t.__e,e||null)),e=t.__e);do e=e&&e.nextSibling;while(e!=null&&e.nodeType==8);return e}function Cr(t,e,n,a){var i,s,o,h=t.key,u=t.type,d=e[n],f=d!=null&&(2&d.__u)==0;if(d===null&&t.key==null||f&&h==d.key&&u==d.type)return n;if(a>(f?1:0)){for(i=n-1,s=n+1;i>=0||s<e.length;)if((d=e[o=i>=0?i--:s++])!=null&&!(2&d.__u)&&h==d.key&&u==d.type)return o}return-1}function En(t,e,n){e[0]=="-"?t.setProperty(e,n??""):t[e]=n==null?"":typeof n!="number"||Nr.test(e)?n:n+"px"}function je(t,e,n,a,i){var s,o;e:if(e=="style")if(typeof n=="string")t.style.cssText=n;else{if(typeof a=="string"&&(t.style.cssText=a=""),a)for(e in a)n&&e in n||En(t.style,e,"");if(n)for(e in n)a&&n[e]==a[e]||En(t.style,e,n[e])}else if(e[0]=="o"&&e[1]=="n")s=e!=(e=e.replace(zn,"$1")),o=e.toLowerCase(),e=o in t||e=="onFocusOut"||e=="onFocusIn"?o.slice(2):e.slice(2),t.l||(t.l={}),t.l[e+s]=n,n?a?n.u=a.u:(n.u=Wt,t.addEventListener(e,s?Ft:It,s)):t.removeEventListener(e,s?Ft:It,s);else{if(i=="http://www.w3.org/2000/svg")e=e.replace(/xlink(H|:h)/,"h").replace(/sName$/,"s");else if(e!="width"&&e!="height"&&e!="href"&&e!="list"&&e!="form"&&e!="tabIndex"&&e!="download"&&e!="rowSpan"&&e!="colSpan"&&e!="role"&&e!="popover"&&e in t)try{t[e]=n??"";break e}catch{}typeof n=="function"||(n==null||n===!1&&e[4]!="-"?t.removeAttribute(e):t.setAttribute(e,e=="popover"&&n==1?"":n))}}function Tn(t){return function(e){if(this.l){var n=this.l[e.type+t];if(e.t==null)e.t=Wt++;else if(e.t<n.u)return;return n(F.event?F.event(e):e)}}}function Bt(t,e,n,a,i,s,o,h,u,d){var f,c,p,g,b,T,E,y,m,v,w,A,C,O,M,ne,se,R=e.type;if(e.constructor!=null)return null;128&n.__u&&(u=!!(32&n.__u),s=[h=e.__e=n.__e]),(f=F.__b)&&f(e);e:if(typeof R=="function")try{if(y=e.props,m="prototype"in R&&R.prototype.render,v=(f=R.contextType)&&a[f.__c],w=f?v?v.props.value:f.__:a,n.__c?E=(c=e.__c=n.__c).__=c.__E:(m?e.__c=c=new R(y,w):(e.__c=c=new tt(y,w),c.constructor=R,c.render=Ar),v&&v.sub(c),c.props=y,c.state||(c.state={}),c.context=w,c.__n=a,p=c.__d=!0,c.__h=[],c._sb=[]),m&&c.__s==null&&(c.__s=c.state),m&&R.getDerivedStateFromProps!=null&&(c.__s==c.state&&(c.__s=fe({},c.__s)),fe(c.__s,R.getDerivedStateFromProps(y,c.__s))),g=c.props,b=c.state,c.__v=e,p)m&&R.getDerivedStateFromProps==null&&c.componentWillMount!=null&&c.componentWillMount(),m&&c.componentDidMount!=null&&c.__h.push(c.componentDidMount);else{if(m&&R.getDerivedStateFromProps==null&&y!==g&&c.componentWillReceiveProps!=null&&c.componentWillReceiveProps(y,w),!c.__e&&c.shouldComponentUpdate!=null&&c.shouldComponentUpdate(y,c.__s,w)===!1||e.__v==n.__v){for(e.__v!=n.__v&&(c.props=y,c.state=c.__s,c.__d=!1),e.__e=n.__e,e.__k=n.__k,e.__k.some(function(z){z&&(z.__=e)}),A=0;A<c._sb.length;A++)c.__h.push(c._sb[A]);c._sb=[],c.__h.length&&o.push(c);break e}c.componentWillUpdate!=null&&c.componentWillUpdate(y,c.__s,w),m&&c.componentDidUpdate!=null&&c.__h.push(function(){c.componentDidUpdate(g,b,T)})}if(c.context=w,c.props=y,c.__P=t,c.__e=!1,C=F.__r,O=0,m){for(c.state=c.__s,c.__d=!1,C&&C(e),f=c.render(c.props,c.state,c.context),M=0;M<c._sb.length;M++)c.__h.push(c._sb[M]);c._sb=[]}else do c.__d=!1,C&&C(e),f=c.render(c.props,c.state,c.context),c.state=c.__s;while(c.__d&&++O<25);c.state=c.__s,c.getChildContext!=null&&(a=fe(fe({},a),c.getChildContext())),m&&!p&&c.getSnapshotBeforeUpdate!=null&&(T=c.getSnapshotBeforeUpdate(g,b)),ne=f,f!=null&&f.type===re&&f.key==null&&(ne=jn(f.props.children)),h=Vn(t,ct(ne)?ne:[ne],e,n,a,i,s,o,h,u,d),c.base=e.__e,e.__u&=-161,c.__h.length&&o.push(c),E&&(c.__E=c.__=null)}catch(z){if(e.__v=null,u||s!=null)if(z.then){for(e.__u|=u?160:128;h&&h.nodeType==8&&h.nextSibling;)h=h.nextSibling;s[s.indexOf(h)]=null,e.__e=h}else{for(se=s.length;se--;)zt(s[se]);Dt(e)}else e.__e=n.__e,e.__k=n.__k,z.then||Dt(e);F.__e(z,e,n)}else s==null&&e.__v==n.__v?(e.__k=n.__k,e.__e=n.__e):h=e.__e=Lr(n.__e,e,n,a,i,s,o,u,d);return(f=F.diffed)&&f(e),128&e.__u?void 0:h}function Dt(t){t&&t.__c&&(t.__c.__e=!0),t&&t.__k&&t.__k.forEach(Dt)}function Qn(t,e,n){for(var a=0;a<n.length;a++)Xt(n[a],n[++a],n[++a]);F.__c&&F.__c(e,t),t.some(function(i){try{t=i.__h,i.__h=[],t.some(function(s){s.call(i)})}catch(s){F.__e(s,i.__v)}})}function jn(t){return typeof t!="object"||t==null||t.__b&&t.__b>0?t:ct(t)?t.map(jn):fe({},t)}function Lr(t,e,n,a,i,s,o,h,u){var d,f,c,p,g,b,T,E=n.props,y=e.props,m=e.type;if(m=="svg"?i="http://www.w3.org/2000/svg":m=="math"?i="http://www.w3.org/1998/Math/MathML":i||(i="http://www.w3.org/1999/xhtml"),s!=null){for(d=0;d<s.length;d++)if((g=s[d])&&"setAttribute"in g==!!m&&(m?g.localName==m:g.nodeType==3)){t=g,s[d]=null;break}}if(t==null){if(m==null)return document.createTextNode(y);t=document.createElementNS(i,m,y.is&&y),h&&(F.__m&&F.__m(e,s),h=!1),s=null}if(m==null)E===y||h&&t.data==y||(t.data=y);else{if(s=s&&lt.call(t.childNodes),E=n.props||$e,!h&&s!=null)for(E={},d=0;d<t.attributes.length;d++)E[(g=t.attributes[d]).name]=g.value;for(d in E)if(g=E[d],d!="children"){if(d=="dangerouslySetInnerHTML")c=g;else if(!(d in y)){if(d=="value"&&"defaultValue"in y||d=="checked"&&"defaultChecked"in y)continue;je(t,d,null,g,i)}}for(d in y)g=y[d],d=="children"?p=g:d=="dangerouslySetInnerHTML"?f=g:d=="value"?b=g:d=="checked"?T=g:h&&typeof g!="function"||E[d]===g||je(t,d,g,E[d],i);if(f)h||c&&(f.__html==c.__html||f.__html==t.innerHTML)||(t.innerHTML=f.__html),e.__k=[];else if(c&&(t.innerHTML=""),Vn(e.type=="template"?t.content:t,ct(p)?p:[p],e,n,a,m=="foreignObject"?"http://www.w3.org/1999/xhtml":i,s,o,s?s[0]:n.__k&&Re(n,0),h,u),s!=null)for(d=s.length;d--;)zt(s[d]);h||(d="value",m=="progress"&&b==null?t.removeAttribute("value"):b!=null&&(b!==t[d]||m=="progress"&&!b||m=="option"&&b!=E[d])&&je(t,d,b,E[d],i),d="checked",T!=null&&T!=t[d]&&je(t,d,T,E[d],i))}return t}function Xt(t,e,n){try{if(typeof t=="function"){var a=typeof t.__u=="function";a&&t.__u(),a&&e==null||(t.__u=t(e))}else t.current=e}catch(i){F.__e(i,n)}}function Kn(t,e,n){var a,i;if(F.unmount&&F.unmount(t),(a=t.ref)&&(a.current&&a.current!=t.__e||Xt(a,null,e)),(a=t.__c)!=null){if(a.componentWillUnmount)try{a.componentWillUnmount()}catch(s){F.__e(s,e)}a.base=a.__P=null}if(a=t.__k)for(i=0;i<a.length;i++)a[i]&&Kn(a[i],e,n||typeof t.type!="function");n||zt(t.__e),t.__c=t.__=t.__e=void 0}function Ar(t,e,n){return this.constructor(t,n)}function kr(t,e,n){var a,i,s,o;e==document&&(e=document.documentElement),F.__&&F.__(t,e),i=(a=!1)?null:e.__k,s=[],o=[],Bt(e,t=e.__k=Sr(re,null,[t]),i||$e,$e,e.namespaceURI,i?null:e.firstChild?lt.call(e.childNodes):null,s,i?i.__e:e.firstChild,a,o),Qn(s,t,o)}lt=Bn.slice,F={__e:function(t,e,n,a){for(var i,s,o;e=e.__;)if((i=e.__c)&&!i.__)try{if((s=i.constructor)&&s.getDerivedStateFromError!=null&&(i.setState(s.getDerivedStateFromError(t)),o=i.__d),i.componentDidCatch!=null&&(i.componentDidCatch(t,a||{}),o=i.__d),o)return i.__E=i}catch(h){t=h}throw t}},Gn=0,tt.prototype.setState=function(t,e){var n;n=this.__s!=null&&this.__s!=this.state?this.__s:this.__s=fe({},this.state),typeof t=="function"&&(t=t(fe({},n),this.props)),t&&fe(n,t),t!=null&&this.__v&&(e&&this._sb.push(e),bn(this))},tt.prototype.forceUpdate=function(t){this.__v&&(this.__e=!0,t&&this.__h.push(t),bn(this))},tt.prototype.render=re,ve=[],qn=typeof Promise=="function"?Promise.prototype.then.bind(Promise.resolve()):setTimeout,Wn=function(t,e){return t.__v.__b-e.__v.__b},at.__r=0,zn=/(PointerCapture)$|Capture$/i,Wt=0,It=Tn(!1),Ft=Tn(!0);var Rr=0;function r(t,e,n,a,i,s){e||(e={});var o,h,u=e;if("ref"in u)for(h in u={},e)h=="ref"?o=e[h]:u[h]=e[h];var d={type:t,props:u,key:n,ref:o,__k:null,__:null,__b:0,__e:null,__c:null,constructor:void 0,__v:--Rr,__i:-1,__u:0,__source:i,__self:s};if(typeof t=="function"&&(o=t.defaultProps))for(h in o)u[h]===void 0&&(u[h]=o[h]);return F.vnode&&F.vnode(d),d}var Ge,U,Et,Nn,it=0,Jn=[],G=F,Sn=G.__b,wn=G.__r,Cn=G.diffed,Ln=G.__c,An=G.unmount,kn=G.__;function Vt(t,e){G.__h&&G.__h(U,t,it||e),it=0;var n=U.__H||(U.__H={__:[],__h:[]});return t>=n.__.length&&n.__.push({}),n.__[t]}function S(t){return it=1,Or(er,t)}function Or(t,e,n){var a=Vt(Ge++,2);if(a.t=t,!a.__c&&(a.__=[er(void 0,e),function(h){var u=a.__N?a.__N[0]:a.__[0],d=a.t(u,h);u!==d&&(a.__N=[d,a.__[1]],a.__c.setState({}))}],a.__c=U,!U.__f)){var i=function(h,u,d){if(!a.__c.__H)return!0;var f=a.__c.__H.__.filter(function(p){return!!p.__c});if(f.every(function(p){return!p.__N}))return!s||s.call(this,h,u,d);var c=a.__c.props!==h;return f.forEach(function(p){if(p.__N){var g=p.__[0];p.__=p.__N,p.__N=void 0,g!==p.__[0]&&(c=!0)}}),s&&s.call(this,h,u,d)||c};U.__f=!0;var s=U.shouldComponentUpdate,o=U.componentWillUpdate;U.componentWillUpdate=function(h,u,d){if(this.__e){var f=s;s=void 0,i(h,u,d),s=f}o&&o.call(this,h,u,d)},U.shouldComponentUpdate=i}return a.__N||a.__}function Q(t,e){var n=Vt(Ge++,3);!G.__s&&Zn(n.__H,e)&&(n.__=t,n.u=e,U.__H.__h.push(n))}function st(t){return it=5,xr(function(){return{current:t}},[])}function xr(t,e){var n=Vt(Ge++,7);return Zn(n.__H,e)&&(n.__=t(),n.__H=e,n.__h=t),n.__}function Mr(){for(var t;t=Jn.shift();)if(t.__P&&t.__H)try{t.__H.__h.forEach(nt),t.__H.__h.forEach(Pt),t.__H.__h=[]}catch(e){t.__H.__h=[],G.__e(e,t.__v)}}G.__b=function(t){U=null,Sn&&Sn(t)},G.__=function(t,e){t&&e.__k&&e.__k.__m&&(t.__m=e.__k.__m),kn&&kn(t,e)},G.__r=function(t){wn&&wn(t),Ge=0;var e=(U=t.__c).__H;e&&(Et===U?(e.__h=[],U.__h=[],e.__.forEach(function(n){n.__N&&(n.__=n.__N),n.u=n.__N=void 0})):(e.__h.forEach(nt),e.__h.forEach(Pt),e.__h=[],Ge=0)),Et=U},G.diffed=function(t){Cn&&Cn(t);var e=t.__c;e&&e.__H&&(e.__H.__h.length&&(Jn.push(e)!==1&&Nn===G.requestAnimationFrame||((Nn=G.requestAnimationFrame)||Ir)(Mr)),e.__H.__.forEach(function(n){n.u&&(n.__H=n.u),n.u=void 0})),Et=U=null},G.__c=function(t,e){e.some(function(n){try{n.__h.forEach(nt),n.__h=n.__h.filter(function(a){return!a.__||Pt(a)})}catch(a){e.some(function(i){i.__h&&(i.__h=[])}),e=[],G.__e(a,n.__v)}}),Ln&&Ln(t,e)},G.unmount=function(t){An&&An(t);var e,n=t.__c;n&&n.__H&&(n.__H.__.forEach(function(a){try{nt(a)}catch(i){e=i}}),n.__H=void 0,e&&G.__e(e,n.__v))};var Rn=typeof requestAnimationFrame=="function";function Ir(t){var e,n=function(){clearTimeout(a),Rn&&cancelAnimationFrame(e),setTimeout(t)},a=setTimeout(n,35);Rn&&(e=requestAnimationFrame(n))}function nt(t){var e=U,n=t.__c;typeof n=="function"&&(t.__c=void 0,n()),U=e}function Pt(t){var e=U;t.__c=t.__(),U=e}function Zn(t,e){return!t||t.length!==e.length||e.some(function(n,a){return n!==t[a]})}function er(t,e){return typeof e=="function"?e(t):e}const Fr={maxQueueSize:50,defaultTimeout:1e4,maxTimeout:3e4};class Dr{constructor(e={}){x(this,"queue",[]);x(this,"processing",!1);x(this,"nextId",1);x(this,"config");x(this,"stats",{totalProcessed:0,totalTimeouts:0,totalErrors:0});this.config={...Fr,...e}}async enqueue(e,n){if(this.queue.length>=this.config.maxQueueSize)throw new Error(`Query queue full (${this.config.maxQueueSize} items). Too many pending queries.`);const a=Math.min(n||this.config.defaultTimeout,this.config.maxTimeout);return new Promise((i,s)=>{const o={id:this.nextId++,execute:e,resolve:i,reject:s,timeout:a,enqueuedAt:Date.now()};this.queue.push(o),this.processing||this.processQueue()})}async processQueue(){if(!(this.processing||this.queue.length===0)){for(this.processing=!0;this.queue.length>0;){const e=this.queue.shift();try{await this.executeWithTimeout(e)}catch{}}this.processing=!1}}async executeWithTimeout(e){const n=new Promise((a,i)=>{setTimeout(()=>{i(new Error(`Query ${e.id} timed out after ${e.timeout}ms`))},e.timeout)});try{const a=await Promise.race([e.execute(),n]);this.stats.totalProcessed++,e.resolve(a)}catch(a){a instanceof Error&&a.message.includes("timed out")?(this.stats.totalTimeouts++,console.warn(`[QueryQueue] Query ${e.id} timed out`,{timeout:e.timeout,waitTime:Date.now()-e.enqueuedAt})):this.stats.totalErrors++,e.reject(a)}}getStats(){return{queueLength:this.queue.length,busy:this.processing,totalProcessed:this.stats.totalProcessed,totalTimeouts:this.stats.totalTimeouts,totalErrors:this.stats.totalErrors}}isBusy(){return this.processing||this.queue.length>0}clear(){const e=new Error("Query queue cleared");for(const n of this.queue)n.reject(e);this.queue=[]}get length(){return this.queue.length}}let Tt=null;function Ut(t){return Tt||(Tt=new Dr(t)),Tt}function Pr(t,e){return Ut().enqueue(t,e)}class tr{constructor(){x(this,"worker",null);x(this,"nextId",1);x(this,"pending",new Map);this.initWorker()}initWorker(){this.worker=new Worker(new URL("/assets/sqlite.worker-BP5VJzs3.js",import.meta.url),{type:"module"}),this.worker.onmessage=e=>{const n=e.data;if("type"in n&&n.type==="READY"){console.log("[DbClient] Worker ready");return}const{id:a,response:i}=n,s=this.pending.get(a);s&&(this.pending.delete(a),s.resolve(i))},this.worker.onerror=e=>{console.error("[DbClient] Worker error:",e);for(const n of this.pending.values())n.reject(new Error("Worker error"));this.pending.clear()}}async sendRequest(e,n=1e4){if(!this.worker)throw new Error("Worker not initialized");const a=this.nextId++;return Pr(async()=>new Promise((i,s)=>{const o=setTimeout(()=>{this.pending.delete(a),s(new Error(`Request ${e.type} timed out after ${n}ms`))},n);this.pending.set(a,{resolve:u=>{clearTimeout(o),u.ok?i(u.data):s(new Error(u.error))},reject:u=>{clearTimeout(o),s(u)},timeout:o});const h={id:a,request:e};this.worker.postMessage(h)}),n)}async openFromFile(e){return this.sendRequest({type:"OPEN_FROM_FILE",file:e})}async openFromOpfs(e){return this.sendRequest({type:"OPEN_FROM_OPFS",path:e})}async openDemo(){return this.sendRequest({type:"OPEN_DEMO"})}async saveToOpfs(e){return this.sendRequest({type:"SAVE_TO_OPFS",path:e})}async removeFromOpfs(e){return this.sendRequest({type:"REMOVE_FROM_OPFS",path:e})}async listOpfsFiles(){return this.sendRequest({type:"LIST_OPFS_FILES"})}async close(){return this.sendRequest({type:"CLOSE"})}async searchFts(e,n=20,a,i){return this.sendRequest({type:"FTS_SEARCH",query:e,limit:n,entityType:a,entityValue:i})}async searchHybrid(e,n=20,a){return this.sendRequest({type:"HYBRID_SEARCH",query:e,limit:n,weights:a})}async listEntities(e,n=100){return this.sendRequest({type:"LIST_ENTITIES",entityType:e,limit:n})}async getPageList(e=100,n=0){return this.sendRequest({type:"GET_PAGE_LIST",limit:e,offset:n})}async getPageBlob(e){return this.sendRequest({type:"GET_PAGE_BLOB",name:e})}async verifyPage(e){return this.sendRequest({type:"VERIFY_PAGE",gid:e})}async getCheckpoints(){return this.sendRequest({type:"GET_CHECKPOINTS"})}async graphHops(e,n,a,i){return this.sendRequest({type:"GRAPH_HOPS",seedGid:e,predicate:n,maxHops:a,limit:i})}getQueueStats(){return Ut().getStats()}isQueueBusy(){return Ut().isBusy()}terminate(){this.worker&&(this.worker.terminate(),this.worker=null);for(const e of this.pending.values())clearTimeout(e.timeout),e.reject(new Error("Worker terminated"));this.pending.clear()}}let Nt=null;function te(){return Nt||(Nt=new tr),Nt}class Ur{constructor(){x(this,"bus",new EventTarget);x(this,"topics",new Set);x(this,"eventLog",[]);x(this,"maxLogSize",100)}publish(e,n){this.topics.add(e);const a={topic:e,data:n,timestamp:Date.now()};this.bus.dispatchEvent(new CustomEvent(e,{detail:a}))}subscribe(e,n){const a=i=>{const s=i;n(s.detail.data,s.detail)};return this.bus.addEventListener(e,a),()=>{this.bus.removeEventListener(e,a)}}subscribeMany(e,n){const a=e.map(i=>this.subscribe(i,(s,o)=>n(i,s,o)));return()=>{a.forEach(i=>i())}}getActiveTopics(){return Array.from(this.topics)}getRecentEvents(e){return[]}clearEventLog(){this.eventLog=[]}getStats(){const e={};return{activeTopics:this.topics.size,eventLogSize:this.eventLog.length,topicCounts:e}}}const ae=new Ur,Hr=t=>ae.publish("retrieval.query",t),$r=t=>ae.publish("retrieval.result",t),Gr=t=>ae.publish("llm.prompt",t),qr=t=>ae.publish("llm.output",t),Wr=t=>ae.publish("llm.citation",t),zr=t=>ae.publish("feedback.signal",t),On=t=>ae.publish("capsule.loaded",t),Br=()=>ae.publish("capsule.unloaded",{}),Xr=`-- GlyphCase Envelope Schema v1.1
-- Append-only episodic memory layer for Dynamic GlyphCases
-- This schema represents the mutable, hash-chained memory buffer
-- that sits alongside the immutable Core.

-- ============================================================================
-- METADATA
-- ============================================================================

-- Envelope metadata and configuration
CREATE TABLE IF NOT EXISTS _envelope_meta (
  key TEXT PRIMARY KEY,
  value TEXT NOT NULL
) STRICT;

-- Core metadata values:
-- 'gcase_id' - SHA256 hash of the Core capsule this envelope is linked to
-- 'created_at' - ISO8601 timestamp of envelope creation
-- 'format_version' - Envelope schema version (1.1)
-- 'last_hash' - Most recent hash in the chain

-- ============================================================================
-- HASH CHAIN (Merkle Integrity)
-- ============================================================================

-- Hash chain for append-only integrity verification
-- Each block represents a batch of appends with a Merkle root
CREATE TABLE IF NOT EXISTS _env_chain (
  seq INTEGER PRIMARY KEY AUTOINCREMENT,
  block_hash TEXT NOT NULL UNIQUE,
  parent_hash TEXT NOT NULL,
  block_type TEXT NOT NULL, -- 'retrieval' | 'embedding' | 'feedback' | 'summary'
  row_count INTEGER NOT NULL DEFAULT 1,
  created_at TEXT NOT NULL DEFAULT (datetime('now'))
) STRICT;

CREATE INDEX IF NOT EXISTS idx_chain_block_type ON _env_chain(block_type);
CREATE INDEX IF NOT EXISTS idx_chain_created_at ON _env_chain(created_at);

-- ============================================================================
-- RETRIEVAL LOGS
-- ============================================================================

-- Logs every search/retrieval operation performed
-- Enables learning from query patterns and improving relevance
CREATE TABLE IF NOT EXISTS env_retrieval_log (
  id TEXT PRIMARY KEY,
  seq INTEGER NOT NULL REFERENCES _env_chain(seq),
  ts TEXT NOT NULL DEFAULT (datetime('now')),
  query_text TEXT NOT NULL,
  query_type TEXT NOT NULL CHECK(query_type IN ('fts', 'vector', 'hybrid', 'graph')),
  top_docs TEXT, -- JSON array of {gid, score, snippet}
  hit_count INTEGER NOT NULL DEFAULT 0,
  parent_hash TEXT NOT NULL
) STRICT;

CREATE INDEX IF NOT EXISTS idx_retrieval_ts ON env_retrieval_log(ts);
CREATE INDEX IF NOT EXISTS idx_retrieval_type ON env_retrieval_log(query_type);
CREATE INDEX IF NOT EXISTS idx_retrieval_query ON env_retrieval_log(query_text);

-- ============================================================================
-- CONTEXTUAL EMBEDDINGS
-- ============================================================================

-- Runtime-generated embeddings for queries, responses, and context
-- Provides adaptive semantic memory beyond the canonical Core vectors
CREATE TABLE IF NOT EXISTS env_embeddings (
  id TEXT PRIMARY KEY,
  seq INTEGER NOT NULL REFERENCES _env_chain(seq),
  source TEXT NOT NULL, -- 'user_query' | 'llm_response' | 'context_window' | 'feedback_cluster'
  vector BLOB NOT NULL,
  metadata TEXT, -- JSON metadata about this embedding
  created_at TEXT NOT NULL DEFAULT (datetime('now')),
  parent_hash TEXT NOT NULL
) STRICT;

CREATE INDEX IF NOT EXISTS idx_embeddings_source ON env_embeddings(source);
CREATE INDEX IF NOT EXISTS idx_embeddings_created ON env_embeddings(created_at);

-- ============================================================================
-- USER FEEDBACK
-- ============================================================================

-- User ratings and feedback on retrievals and responses
-- Enables learning from human signals and improving relevance over time
CREATE TABLE IF NOT EXISTS env_feedback (
  id TEXT PRIMARY KEY,
  seq INTEGER NOT NULL REFERENCES _env_chain(seq),
  retrieval_id TEXT REFERENCES env_retrieval_log(id),
  rating INTEGER NOT NULL CHECK(rating IN (-1, 0, 1)), -- -1 (bad) | 0 (neutral) | 1 (good)
  notes TEXT,
  created_at TEXT NOT NULL DEFAULT (datetime('now')),
  parent_hash TEXT NOT NULL
) STRICT;

CREATE INDEX IF NOT EXISTS idx_feedback_rating ON env_feedback(rating);
CREATE INDEX IF NOT EXISTS idx_feedback_retrieval ON env_feedback(retrieval_id);
CREATE INDEX IF NOT EXISTS idx_feedback_created ON env_feedback(created_at);

-- ============================================================================
-- CONTEXT SUMMARIES
-- ============================================================================

-- LLM-generated context summaries and insights
-- Captures high-level understanding and reasoning patterns
CREATE TABLE IF NOT EXISTS env_context_summaries (
  id TEXT PRIMARY KEY,
  seq INTEGER NOT NULL REFERENCES _env_chain(seq),
  summary TEXT NOT NULL,
  relevance REAL NOT NULL CHECK(relevance >= 0.0 AND relevance <= 1.0),
  source_retrievals TEXT, -- JSON array of retrieval_log IDs
  created_at TEXT NOT NULL DEFAULT (datetime('now')),
  parent_hash TEXT NOT NULL
) STRICT;

CREATE INDEX IF NOT EXISTS idx_summaries_relevance ON env_context_summaries(relevance);
CREATE INDEX IF NOT EXISTS idx_summaries_created ON env_context_summaries(created_at);

-- ============================================================================
-- VIEWS
-- ============================================================================

-- Recent activity view (last 100 events)
CREATE VIEW IF NOT EXISTS v_recent_activity AS
SELECT
  'retrieval' as event_type,
  id,
  ts as timestamp,
  query_text as description,
  hit_count as value
FROM env_retrieval_log
UNION ALL
SELECT
  'feedback' as event_type,
  id,
  created_at as timestamp,
  notes as description,
  rating as value
FROM env_feedback
UNION ALL
SELECT
  'summary' as event_type,
  id,
  created_at as timestamp,
  substr(summary, 1, 100) as description,
  relevance as value
FROM env_context_summaries
ORDER BY timestamp DESC
LIMIT 100;

-- Envelope statistics view
CREATE VIEW IF NOT EXISTS v_envelope_stats AS
SELECT
  (SELECT COUNT(*) FROM env_retrieval_log) as retrieval_count,
  (SELECT COUNT(*) FROM env_embeddings) as embedding_count,
  (SELECT COUNT(*) FROM env_feedback) as feedback_count,
  (SELECT COUNT(*) FROM env_context_summaries) as summary_count,
  (SELECT COUNT(*) FROM _env_chain) as chain_length,
  (SELECT MIN(ts) FROM env_retrieval_log) as first_activity,
  (SELECT MAX(ts) FROM env_retrieval_log) as last_activity;
`;async function Ke(t){const e=JSON.stringify({table:t.table,id:t.rowId,data:Ht(t.data),parent:t.parentHash,ts:t.timestamp}),a=new TextEncoder().encode(e),i=await crypto.subtle.digest("SHA-256",a);return Array.from(new Uint8Array(i)).map(o=>o.toString(16).padStart(2,"0")).join("")}function Ht(t){if(t instanceof Float32Array)return{__type:"Float32Array",values:Array.from(t)};if(Array.isArray(t))return t.map(Ht);if(t&&typeof t=="object"){const e={};for(const[n,a]of Object.entries(t))e[n]=Ht(a);return e}return t}class St{constructor(e,n){x(this,"lastHash");x(this,"db");x(this,"genesis","0".repeat(64));this.db=e,this.lastHash=n||this.genesis}getCurrentHash(){return this.lastHash}async appendRetrieval(e){const n=new Date().toISOString(),a=await Ke({table:"retrieval_log",rowId:e.id,data:e,parentHash:this.lastHash,timestamp:n}),i=this.db.prepare(`
      INSERT INTO env_retrieval_log
      (id, query_text, query_type, top_docs, hit_count, parent_hash, ts)
      VALUES (?, ?, ?, ?, ?, ?, ?)
    `);try{i.bind([e.id,e.query_text,e.query_type,e.top_docs?JSON.stringify(e.top_docs):null,e.hit_count,this.lastHash,n]),i.step()}finally{i.finalize()}return await this.recordChainBlock(a,"retrieval",1),this.lastHash=a,a}async appendEmbedding(e){const n=new Date().toISOString(),a=await Ke({table:"embeddings",rowId:e.id,data:e,parentHash:this.lastHash,timestamp:n}),i=new Uint8Array(e.vector.buffer),s=this.db.prepare(`
      INSERT INTO env_embeddings
      (id, source, vector, metadata, parent_hash, created_at)
      VALUES (?, ?, ?, ?, ?, ?)
    `);try{s.bind([e.id,e.source,i,e.metadata?JSON.stringify(e.metadata):null,this.lastHash,n]),s.step()}finally{s.finalize()}return await this.recordChainBlock(a,"embedding",1),this.lastHash=a,a}async appendFeedback(e){const n=new Date().toISOString(),a=await Ke({table:"feedback",rowId:e.id,data:e,parentHash:this.lastHash,timestamp:n}),i=this.db.prepare(`
      INSERT INTO env_feedback
      (id, retrieval_id, rating, notes, parent_hash, created_at)
      VALUES (?, ?, ?, ?, ?, ?)
    `);try{i.bind([e.id,e.retrieval_id||null,e.rating,e.notes||null,this.lastHash,n]),i.step()}finally{i.finalize()}return await this.recordChainBlock(a,"feedback",1),this.lastHash=a,a}async appendSummary(e){const n=new Date().toISOString(),a=await Ke({table:"summaries",rowId:e.id,data:e,parentHash:this.lastHash,timestamp:n}),i=this.db.prepare(`
      INSERT INTO env_context_summaries
      (id, summary, relevance, source_retrievals, parent_hash, created_at)
      VALUES (?, ?, ?, ?, ?, ?)
    `);try{i.bind([e.id,e.summary,e.relevance,e.source_retrievals?JSON.stringify(e.source_retrievals):null,this.lastHash,n]),i.step()}finally{i.finalize()}return await this.recordChainBlock(a,"summary",1),this.lastHash=a,a}async recordChainBlock(e,n,a){const i=this.db.prepare(`
      INSERT INTO _env_chain (block_hash, parent_hash, block_type, row_count)
      VALUES (?, ?, ?, ?)
    `);try{i.bind([e,this.lastHash,n,a]),i.step();const o=this.db.prepare("SELECT last_insert_rowid()");try{o.step();const h=o.get([])[0],u=this.db.prepare(`
          UPDATE env_${n==="retrieval"?"retrieval_log":n==="embedding"?"embeddings":n==="feedback"?"feedback":"context_summaries"}
          SET seq = ?
          WHERE parent_hash = ?
        `);try{u.bind([h,this.lastHash]),u.step()}finally{u.finalize()}}finally{o.finalize()}}finally{i.finalize()}const s=this.db.prepare(`
      INSERT OR REPLACE INTO _envelope_meta (key, value) VALUES ('last_hash', ?)
    `);try{s.bind([e]),s.step()}finally{s.finalize()}}async verifyChain(){const e=[],n=this.db.prepare(`
      SELECT seq, block_hash, parent_hash, block_type
      FROM _env_chain
      ORDER BY seq ASC
    `),a=[];try{for(;n.step();){const i=n.get([]);a.push({seq:i[0],block_hash:i[1],parent_hash:i[2],block_type:i[3],row_count:0,created_at:""})}}finally{n.finalize()}for(let i=1;i<a.length;i++){const s=a[i],o=a[i-1];s.parent_hash!==o.block_hash&&e.push(`Chain break at seq ${s.seq}: parent_hash ${s.parent_hash} does not match previous block_hash ${o.block_hash}`)}return{valid:e.length===0,errors:e}}getChainStats(){const e=this.db.prepare(`
      SELECT block_type, COUNT(*) as count
      FROM _env_chain
      GROUP BY block_type
    `),n={};try{for(;e.step();){const s=e.get([]);n[s[0]]=s[1]}}finally{e.finalize()}const a=this.db.prepare("SELECT COUNT(*) FROM _env_chain");let i=0;try{a.step(),i=a.get([])[0]}finally{a.finalize()}return{length:i,currentHash:this.lastHash,types:n}}}function nr(t="env"){const e=Date.now().toString(36),n=Math.random().toString(36).substring(2,9);return`${t}_${e}_${n}`}async function wt(t){const e=await t.arrayBuffer(),n=await crypto.subtle.digest("SHA-256",e);return Array.from(new Uint8Array(n)).map(i=>i.toString(16).padStart(2,"0")).join("")}class ot{constructor(){x(this,"db",null);x(this,"writer",null);x(this,"gcaseId",null);x(this,"opfsPath",null)}static async exists(e){try{const n=await wt(e),a=`/envelopes/${n}.db`;return await(await(await navigator.storage.getDirectory()).getDirectoryHandle("envelopes",{create:!1})).getFileHandle(`${n}.db`,{create:!1}),!0}catch{return!1}}async create(e,n){this.gcaseId=await wt(e),this.opfsPath=`/envelopes/${this.gcaseId}.db`,await(await navigator.storage.getDirectory()).getDirectoryHandle("envelopes",{create:!0}),this.db=new n.oo1.OpfsDb(this.opfsPath,"c"),this.db.exec(Xr);const i=new Date().toISOString(),s="0".repeat(64),o=this.db.prepare(`
      INSERT INTO _envelope_meta (key, value) VALUES
      ('gcase_id', ?),
      ('created_at', ?),
      ('format_version', '1.1'),
      ('last_hash', ?)
    `);try{o.bind([this.gcaseId,i,s]),o.step()}finally{o.finalize()}this.writer=new St(this.db,s),console.log(`[Envelope] Created new envelope for ${this.gcaseId}`)}async load(e,n){this.gcaseId=await wt(e),this.opfsPath=`/envelopes/${this.gcaseId}.db`,this.db=new n.oo1.OpfsDb(this.opfsPath,"w");const a=this.db.prepare(`
      SELECT value FROM _envelope_meta WHERE key = 'last_hash'
    `);let i="0".repeat(64);try{a.step()&&(i=a.get([])[0])}finally{a.finalize()}this.writer=new St(this.db,i),console.log(`[Envelope] Loaded existing envelope for ${this.gcaseId}`)}async open(e,n){await ot.exists(e)?await this.load(e,n):await this.create(e,n)}close(){this.db&&(this.db.close(),this.db=null,this.writer=null,this.gcaseId=null,console.log("[Envelope] Closed envelope database"))}getWriter(){return this.writer}getStats(){if(!this.db)return null;const e=this.db.prepare("SELECT * FROM v_envelope_stats");try{if(e.step()){const n=e.get([]);return{retrievalCount:n[0]||0,embeddingCount:n[1]||0,feedbackCount:n[2]||0,summaryCount:n[3]||0,chainLength:n[4]||0,firstActivity:n[5]||null,lastActivity:n[6]||null}}}finally{e.finalize()}return null}getMeta(){if(!this.db)return null;const e=this.db.prepare("SELECT key, value FROM _envelope_meta"),n={};try{for(;e.step();){const a=e.get([]);n[a[0]]=a[1]}}finally{e.finalize()}return{gcaseId:n.gcase_id||"",createdAt:n.created_at||"",formatVersion:n.format_version||"1.1",lastHash:n.last_hash||""}}async clear(){if(!this.db)return;this.db.exec(`
      DELETE FROM env_retrieval_log;
      DELETE FROM env_embeddings;
      DELETE FROM env_feedback;
      DELETE FROM env_context_summaries;
      DELETE FROM _env_chain;
    `);const e="0".repeat(64),n=this.db.prepare(`
      UPDATE _envelope_meta SET value = ? WHERE key = 'last_hash'
    `);try{n.bind([e]),n.step()}finally{n.finalize()}this.writer=new St(this.db,e),console.log("[Envelope] Cleared all envelope data")}async export(){if(!this.db||!this.opfsPath)throw new Error("No envelope database open");return await(await(await(await navigator.storage.getDirectory()).getDirectoryHandle("envelopes")).getFileHandle(`${this.gcaseId}.db`)).getFile()}getRecentActivity(e=20){if(!this.db)return[];const n=this.db.prepare(`
      SELECT event_type, id, timestamp, description, value
      FROM v_recent_activity
      LIMIT ?
    `),a=[];try{for(n.bind([e]);n.step();){const i=n.get([]);a.push({eventType:i[0],id:i[1],timestamp:i[2],description:i[3],value:i[4]})}}finally{n.finalize()}return a}async verify(){return this.writer?this.writer.verifyChain():{valid:!1,errors:["No envelope writer available"]}}getDatabase(){return this.db}isOpen(){return this.db!==null}getOpfsPath(){return this.opfsPath}getGCaseId(){return this.gcaseId}}class Vr{constructor(){x(this,"dbClient");x(this,"envelopeManager");x(this,"currentModality","static");x(this,"currentFile",null);x(this,"currentInfo",null);this.dbClient=new tr,this.envelopeManager=new ot}getModalityPreference(){return localStorage.getItem("glyphcase.modality")||"auto"}setModalityPreference(e){localStorage.setItem("glyphcase.modality",e)}async detectModality(e){const n=this.getModalityPreference();return n==="static"?"static":n==="dynamic"||await ot.exists(e)?"dynamic":"static"}async openFromFile(e,n){this.currentFile=e;const a=await this.dbClient.openFromFile(e);let i;n!==void 0?i=n?"dynamic":"static":i=await this.detectModality(e),this.currentModality=i;let s;return i==="dynamic"&&console.log("[GlyphCase] Dynamic mode - envelope will be initialized on first write"),this.currentInfo={...a,modality:i,envelopeStats:s},On({gid:a.docId||"unknown",title:a.title||"Untitled",modality:i}),this.currentInfo}async openDemo(){const e=await this.dbClient.openDemo();return this.currentModality="static",this.currentInfo={...e,modality:"static"},On({gid:e.docId||"demo",title:e.title||"Demo",modality:"static"}),this.currentInfo}async enableDynamicMode(){if(!this.currentFile)throw new Error("No capsule loaded");if(this.currentModality==="dynamic"){console.log("[GlyphCase] Already in dynamic mode");return}this.currentModality="dynamic",this.currentInfo&&(this.currentInfo.modality="dynamic"),console.log("[GlyphCase] Enabled dynamic mode")}getModality(){return this.currentModality}getInfo(){return this.currentInfo}isDynamic(){return this.currentModality==="dynamic"}getCore(){return this.dbClient}getEnvelope(){return this.envelopeManager}getStream(){return ae}async close(){this.envelopeManager.isOpen()&&this.envelopeManager.close(),await this.dbClient.close(),this.currentModality="static",this.currentFile=null,this.currentInfo=null,Br()}async exportEnvelope(){return this.envelopeManager.isOpen()?this.envelopeManager.export():null}async clearEnvelope(){this.envelopeManager.isOpen()&&(await this.envelopeManager.clear(),this.currentInfo&&(this.currentInfo.envelopeStats=this.envelopeManager.getStats()||void 0))}getEnvelopeStats(){return this.envelopeManager.getStats()}async verifyEnvelope(){return this.envelopeManager.isOpen()?this.envelopeManager.verify():null}}const V=new Vr;function rr(t={}){const{defaultMode:e="hybrid",maxResults:n=10,maxGraphHops:a=2,debounceMs:i=300}=t,[s,o]=S(e),[h,u]=S(null),[d,f]=S(""),[c,p]=S(!1),[g,b]=S(null),[T,E]=S({}),[y,m]=S(""),[v,w]=S(()=>{try{const I=localStorage.getItem("memglyph-search-history");return I?JSON.parse(I):[]}catch{return[]}}),A=st(null);Q(()=>{if(y.trim())return A.current&&clearTimeout(A.current),A.current=window.setTimeout(()=>{M(y)},i),()=>{A.current&&clearTimeout(A.current)}},[y,s,T]);const C=I=>{if(!I.trim())return;const be=I.trim();w(le=>{const j=le.filter(ce=>ce!==be),ge=[be,...j].slice(0,10);try{localStorage.setItem("memglyph-search-history",JSON.stringify(ge))}catch(ce){console.warn("[Search] Failed to save history:",ce)}return ge})},O=()=>{w([]);try{localStorage.removeItem("memglyph-search-history")}catch(I){console.warn("[Search] Failed to clear history:",I)}},M=async I=>{if(!I.trim())return;p(!0),b(null),f(I),C(I);const be=performance.now();try{const le=te();Hr({query:I,type:s,limit:n});let j=[];switch(s){case"fts":j=await Qr(le,I,n,T);break;case"hybrid":j=await le.searchHybrid(I,n);break;case"graph":j=await jr(le,I,n,a,T);break;default:throw new Error(`Unknown search mode: ${s}`)}const ge=performance.now()-be;return $r({query:I,type:s,results:j.map(ce=>({gid:ce.gid,score:ce.scores.final,snippet:ce.snippet||void 0})),executionTime:ge}),V.isDynamic()&&await Yr(I,s,j),u(j),console.log(`[Search] ${s} mode: ${j.length} results in ${ge.toFixed(0)}ms`),j}catch(le){const j=String(le);return b(j),console.error("[Search] Failed:",le),[]}finally{p(!1)}};return{mode:s,results:h,lastQuery:d,loading:c,error:g,entityFilter:T,searchHistory:v,search:I=>{m(I)},searchImmediate:I=>(A.current&&clearTimeout(A.current),m(""),M(I)),clear:()=>{u(null),f(""),b(null),m(""),A.current&&clearTimeout(A.current)},changeMode:I=>{o(I),u(null)},setFilter:I=>{E(I),u(null)},clearFilter:()=>{E({}),u(null)},clearHistory:O}}async function Yr(t,e,n){try{const a=V.getEnvelope();if(!a.isOpen()){console.warn("[Search] Envelope not open, skipping log");return}const i=a.getWriter();if(!i){console.warn("[Search] No envelope writer available");return}await i.appendRetrieval({id:nr("ret"),query_text:t,query_type:e,top_docs:n.slice(0,10).map(s=>({gid:s.gid,score:s.scores.final,snippet:s.snippet||void 0})),hit_count:n.length}),console.log(`[Search] Logged retrieval to envelope: ${n.length} results`)}catch(a){console.error("[Search] Failed to log to envelope:",a)}}async function Qr(t,e,n,a){return(await t.searchFts(e,n,a.entityType,a.entityValue)).map(s=>({gid:s.gid,pageNo:s.pageNo,title:s.title,snippet:s.snippet,scores:{fts:s.score,vector:0,entity:0,graph:0,final:s.score}}))}async function jr(t,e,n,a,i){const s=await t.searchFts(e,3,i.entityType,i.entityValue);if(s.length===0)return[];const o=s[0].gid,h=await t.graphHops(o,void 0,a,n),u=h.nodes.map(d=>{const f=h.distances[d.gid]||0,c=s.find(p=>p.gid===d.gid);return{gid:d.gid,pageNo:d.pageNo,title:d.title,snippet:(c==null?void 0:c.snippet)||null,scores:{fts:(c==null?void 0:c.score)||0,vector:0,entity:0,graph:1/(f+1),final:((c==null?void 0:c.score)||0)*.3+1/(f+1)*.7}}});return u.sort((d,f)=>f.scores.final-d.scores.final),u}/*! @license DOMPurify 3.3.0 | (c) Cure53 and other contributors | Released under the Apache license 2.0 and Mozilla Public License 2.0 | github.com/cure53/DOMPurify/blob/3.3.0/LICENSE */const{entries:ar,setPrototypeOf:xn,isFrozen:Kr,getPrototypeOf:Jr,getOwnPropertyDescriptor:Zr}=Object;let{freeze:J,seal:ie,create:$t}=Object,{apply:Gt,construct:qt}=typeof Reflect<"u"&&Reflect;J||(J=function(e){return e});ie||(ie=function(e){return e});Gt||(Gt=function(e,n){for(var a=arguments.length,i=new Array(a>2?a-2:0),s=2;s<a;s++)i[s-2]=arguments[s];return e.apply(n,i)});qt||(qt=function(e){for(var n=arguments.length,a=new Array(n>1?n-1:0),i=1;i<n;i++)a[i-1]=arguments[i];return new e(...a)});const Je=Z(Array.prototype.forEach),ea=Z(Array.prototype.lastIndexOf),Mn=Z(Array.prototype.pop),Ie=Z(Array.prototype.push),ta=Z(Array.prototype.splice),rt=Z(String.prototype.toLowerCase),Ct=Z(String.prototype.toString),Lt=Z(String.prototype.match),Fe=Z(String.prototype.replace),na=Z(String.prototype.indexOf),ra=Z(String.prototype.trim),oe=Z(Object.prototype.hasOwnProperty),K=Z(RegExp.prototype.test),De=aa(TypeError);function Z(t){return function(e){e instanceof RegExp&&(e.lastIndex=0);for(var n=arguments.length,a=new Array(n>1?n-1:0),i=1;i<n;i++)a[i-1]=arguments[i];return Gt(t,e,a)}}function aa(t){return function(){for(var e=arguments.length,n=new Array(e),a=0;a<e;a++)n[a]=arguments[a];return qt(t,n)}}function k(t,e){let n=arguments.length>2&&arguments[2]!==void 0?arguments[2]:rt;xn&&xn(t,null);let a=e.length;for(;a--;){let i=e[a];if(typeof i=="string"){const s=n(i);s!==i&&(Kr(e)||(e[a]=s),i=s)}t[i]=!0}return t}function ia(t){for(let e=0;e<t.length;e++)oe(t,e)||(t[e]=null);return t}function me(t){const e=$t(null);for(const[n,a]of ar(t))oe(t,n)&&(Array.isArray(a)?e[n]=ia(a):a&&typeof a=="object"&&a.constructor===Object?e[n]=me(a):e[n]=a);return e}function Pe(t,e){for(;t!==null;){const a=Zr(t,e);if(a){if(a.get)return Z(a.get);if(typeof a.value=="function")return Z(a.value)}t=Jr(t)}function n(){return null}return n}const In=J(["a","abbr","acronym","address","area","article","aside","audio","b","bdi","bdo","big","blink","blockquote","body","br","button","canvas","caption","center","cite","code","col","colgroup","content","data","datalist","dd","decorator","del","details","dfn","dialog","dir","div","dl","dt","element","em","fieldset","figcaption","figure","font","footer","form","h1","h2","h3","h4","h5","h6","head","header","hgroup","hr","html","i","img","input","ins","kbd","label","legend","li","main","map","mark","marquee","menu","menuitem","meter","nav","nobr","ol","optgroup","option","output","p","picture","pre","progress","q","rp","rt","ruby","s","samp","search","section","select","shadow","slot","small","source","spacer","span","strike","strong","style","sub","summary","sup","table","tbody","td","template","textarea","tfoot","th","thead","time","tr","track","tt","u","ul","var","video","wbr"]),At=J(["svg","a","altglyph","altglyphdef","altglyphitem","animatecolor","animatemotion","animatetransform","circle","clippath","defs","desc","ellipse","enterkeyhint","exportparts","filter","font","g","glyph","glyphref","hkern","image","inputmode","line","lineargradient","marker","mask","metadata","mpath","part","path","pattern","polygon","polyline","radialgradient","rect","stop","style","switch","symbol","text","textpath","title","tref","tspan","view","vkern"]),kt=J(["feBlend","feColorMatrix","feComponentTransfer","feComposite","feConvolveMatrix","feDiffuseLighting","feDisplacementMap","feDistantLight","feDropShadow","feFlood","feFuncA","feFuncB","feFuncG","feFuncR","feGaussianBlur","feImage","feMerge","feMergeNode","feMorphology","feOffset","fePointLight","feSpecularLighting","feSpotLight","feTile","feTurbulence"]),sa=J(["animate","color-profile","cursor","discard","font-face","font-face-format","font-face-name","font-face-src","font-face-uri","foreignobject","hatch","hatchpath","mesh","meshgradient","meshpatch","meshrow","missing-glyph","script","set","solidcolor","unknown","use"]),Rt=J(["math","menclose","merror","mfenced","mfrac","mglyph","mi","mlabeledtr","mmultiscripts","mn","mo","mover","mpadded","mphantom","mroot","mrow","ms","mspace","msqrt","mstyle","msub","msup","msubsup","mtable","mtd","mtext","mtr","munder","munderover","mprescripts"]),oa=J(["maction","maligngroup","malignmark","mlongdiv","mscarries","mscarry","msgroup","mstack","msline","msrow","semantics","annotation","annotation-xml","mprescripts","none"]),Fn=J(["#text"]),Dn=J(["accept","action","align","alt","autocapitalize","autocomplete","autopictureinpicture","autoplay","background","bgcolor","border","capture","cellpadding","cellspacing","checked","cite","class","clear","color","cols","colspan","controls","controlslist","coords","crossorigin","datetime","decoding","default","dir","disabled","disablepictureinpicture","disableremoteplayback","download","draggable","enctype","enterkeyhint","exportparts","face","for","headers","height","hidden","high","href","hreflang","id","inert","inputmode","integrity","ismap","kind","label","lang","list","loading","loop","low","max","maxlength","media","method","min","minlength","multiple","muted","name","nonce","noshade","novalidate","nowrap","open","optimum","part","pattern","placeholder","playsinline","popover","popovertarget","popovertargetaction","poster","preload","pubdate","radiogroup","readonly","rel","required","rev","reversed","role","rows","rowspan","spellcheck","scope","selected","shape","size","sizes","slot","span","srclang","start","src","srcset","step","style","summary","tabindex","title","translate","type","usemap","valign","value","width","wrap","xmlns","slot"]),Ot=J(["accent-height","accumulate","additive","alignment-baseline","amplitude","ascent","attributename","attributetype","azimuth","basefrequency","baseline-shift","begin","bias","by","class","clip","clippathunits","clip-path","clip-rule","color","color-interpolation","color-interpolation-filters","color-profile","color-rendering","cx","cy","d","dx","dy","diffuseconstant","direction","display","divisor","dur","edgemode","elevation","end","exponent","fill","fill-opacity","fill-rule","filter","filterunits","flood-color","flood-opacity","font-family","font-size","font-size-adjust","font-stretch","font-style","font-variant","font-weight","fx","fy","g1","g2","glyph-name","glyphref","gradientunits","gradienttransform","height","href","id","image-rendering","in","in2","intercept","k","k1","k2","k3","k4","kerning","keypoints","keysplines","keytimes","lang","lengthadjust","letter-spacing","kernelmatrix","kernelunitlength","lighting-color","local","marker-end","marker-mid","marker-start","markerheight","markerunits","markerwidth","maskcontentunits","maskunits","max","mask","mask-type","media","method","mode","min","name","numoctaves","offset","operator","opacity","order","orient","orientation","origin","overflow","paint-order","path","pathlength","patterncontentunits","patterntransform","patternunits","points","preservealpha","preserveaspectratio","primitiveunits","r","rx","ry","radius","refx","refy","repeatcount","repeatdur","restart","result","rotate","scale","seed","shape-rendering","slope","specularconstant","specularexponent","spreadmethod","startoffset","stddeviation","stitchtiles","stop-color","stop-opacity","stroke-dasharray","stroke-dashoffset","stroke-linecap","stroke-linejoin","stroke-miterlimit","stroke-opacity","stroke","stroke-width","style","surfacescale","systemlanguage","tabindex","tablevalues","targetx","targety","transform","transform-origin","text-anchor","text-decoration","text-rendering","textlength","type","u1","u2","unicode","values","viewbox","visibility","version","vert-adv-y","vert-origin-x","vert-origin-y","width","word-spacing","wrap","writing-mode","xchannelselector","ychannelselector","x","x1","x2","xmlns","y","y1","y2","z","zoomandpan"]),Pn=J(["accent","accentunder","align","bevelled","close","columnsalign","columnlines","columnspan","denomalign","depth","dir","display","displaystyle","encoding","fence","frame","height","href","id","largeop","length","linethickness","lspace","lquote","mathbackground","mathcolor","mathsize","mathvariant","maxsize","minsize","movablelimits","notation","numalign","open","rowalign","rowlines","rowspacing","rowspan","rspace","rquote","scriptlevel","scriptminsize","scriptsizemultiplier","selection","separator","separators","stretchy","subscriptshift","supscriptshift","symmetric","voffset","width","xmlns"]),Ze=J(["xlink:href","xml:id","xlink:title","xml:space","xmlns:xlink"]),la=ie(/\{\{[\w\W]*|[\w\W]*\}\}/gm),ca=ie(/<%[\w\W]*|[\w\W]*%>/gm),da=ie(/\$\{[\w\W]*/gm),ua=ie(/^data-[\-\w.\u00B7-\uFFFF]+$/),ha=ie(/^aria-[\-\w]+$/),ir=ie(/^(?:(?:(?:f|ht)tps?|mailto|tel|callto|sms|cid|xmpp|matrix):|[^a-z]|[a-z+.\-]+(?:[^a-z+.\-:]|$))/i),pa=ie(/^(?:\w+script|data):/i),ma=ie(/[\u0000-\u0020\u00A0\u1680\u180E\u2000-\u2029\u205F\u3000]/g),sr=ie(/^html$/i),fa=ie(/^[a-z][.\w]*(-[.\w]+)+$/i);var Un=Object.freeze({__proto__:null,ARIA_ATTR:ha,ATTR_WHITESPACE:ma,CUSTOM_ELEMENT:fa,DATA_ATTR:ua,DOCTYPE_NAME:sr,ERB_EXPR:ca,IS_ALLOWED_URI:ir,IS_SCRIPT_OR_DATA:pa,MUSTACHE_EXPR:la,TMPLIT_EXPR:da});const Ue={element:1,text:3,progressingInstruction:7,comment:8,document:9},ga=function(){return typeof window>"u"?null:window},_a=function(e,n){if(typeof e!="object"||typeof e.createPolicy!="function")return null;let a=null;const i="data-tt-policy-suffix";n&&n.hasAttribute(i)&&(a=n.getAttribute(i));const s="dompurify"+(a?"#"+a:"");try{return e.createPolicy(s,{createHTML(o){return o},createScriptURL(o){return o}})}catch{return console.warn("TrustedTypes policy "+s+" could not be created."),null}},Hn=function(){return{afterSanitizeAttributes:[],afterSanitizeElements:[],afterSanitizeShadowDOM:[],beforeSanitizeAttributes:[],beforeSanitizeElements:[],beforeSanitizeShadowDOM:[],uponSanitizeAttribute:[],uponSanitizeElement:[],uponSanitizeShadowNode:[]}};function or(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:ga();const e=L=>or(L);if(e.version="3.3.0",e.removed=[],!t||!t.document||t.document.nodeType!==Ue.document||!t.Element)return e.isSupported=!1,e;let{document:n}=t;const a=n,i=a.currentScript,{DocumentFragment:s,HTMLTemplateElement:o,Node:h,Element:u,NodeFilter:d,NamedNodeMap:f=t.NamedNodeMap||t.MozNamedAttrMap,HTMLFormElement:c,DOMParser:p,trustedTypes:g}=t,b=u.prototype,T=Pe(b,"cloneNode"),E=Pe(b,"remove"),y=Pe(b,"nextSibling"),m=Pe(b,"childNodes"),v=Pe(b,"parentNode");if(typeof o=="function"){const L=n.createElement("template");L.content&&L.content.ownerDocument&&(n=L.content.ownerDocument)}let w,A="";const{implementation:C,createNodeIterator:O,createDocumentFragment:M,getElementsByTagName:ne}=n,{importNode:se}=a;let R=Hn();e.isSupported=typeof ar=="function"&&typeof v=="function"&&C&&C.createHTMLDocument!==void 0;const{MUSTACHE_EXPR:z,ERB_EXPR:H,TMPLIT_EXPR:qe,DATA_ATTR:I,ARIA_ATTR:be,IS_SCRIPT_OR_DATA:le,ATTR_WHITESPACE:j,CUSTOM_ELEMENT:ge}=Un;let{IS_ALLOWED_URI:ce}=Un,q=null;const Qt=k({},[...In,...At,...kt,...Rt,...Fn]);let B=null;const jt=k({},[...Dn,...Ot,...Pn,...Ze]);let P=Object.seal($t(null,{tagNameCheck:{writable:!0,configurable:!1,enumerable:!0,value:null},attributeNameCheck:{writable:!0,configurable:!1,enumerable:!0,value:null},allowCustomizedBuiltInElements:{writable:!0,configurable:!1,enumerable:!0,value:!1}})),Oe=null,dt=null;const Ee=Object.seal($t(null,{tagCheck:{writable:!0,configurable:!1,enumerable:!0,value:null},attributeCheck:{writable:!0,configurable:!1,enumerable:!0,value:null}}));let Kt=!0,ut=!0,Jt=!1,Zt=!0,Te=!1,We=!0,_e=!1,ht=!1,pt=!1,Ne=!1,ze=!1,Be=!1,en=!0,tn=!1;const pr="user-content-";let mt=!0,xe=!1,Se={},we=null;const nn=k({},["annotation-xml","audio","colgroup","desc","foreignobject","head","iframe","math","mi","mn","mo","ms","mtext","noembed","noframes","noscript","plaintext","script","style","svg","template","thead","title","video","xmp"]);let rn=null;const an=k({},["audio","video","img","source","image","track"]);let ft=null;const sn=k({},["alt","class","for","id","label","name","pattern","placeholder","role","summary","title","value","style","xmlns"]),Xe="http://www.w3.org/1998/Math/MathML",Ve="http://www.w3.org/2000/svg",ue="http://www.w3.org/1999/xhtml";let Ce=ue,gt=!1,_t=null;const mr=k({},[Xe,Ve,ue],Ct);let Ye=k({},["mi","mo","mn","ms","mtext"]),Qe=k({},["annotation-xml"]);const fr=k({},["title","style","font","a","script"]);let Me=null;const gr=["application/xhtml+xml","text/html"],_r="text/html";let W=null,Le=null;const yr=n.createElement("form"),on=function(l){return l instanceof RegExp||l instanceof Function},yt=function(){let l=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};if(!(Le&&Le===l)){if((!l||typeof l!="object")&&(l={}),l=me(l),Me=gr.indexOf(l.PARSER_MEDIA_TYPE)===-1?_r:l.PARSER_MEDIA_TYPE,W=Me==="application/xhtml+xml"?Ct:rt,q=oe(l,"ALLOWED_TAGS")?k({},l.ALLOWED_TAGS,W):Qt,B=oe(l,"ALLOWED_ATTR")?k({},l.ALLOWED_ATTR,W):jt,_t=oe(l,"ALLOWED_NAMESPACES")?k({},l.ALLOWED_NAMESPACES,Ct):mr,ft=oe(l,"ADD_URI_SAFE_ATTR")?k(me(sn),l.ADD_URI_SAFE_ATTR,W):sn,rn=oe(l,"ADD_DATA_URI_TAGS")?k(me(an),l.ADD_DATA_URI_TAGS,W):an,we=oe(l,"FORBID_CONTENTS")?k({},l.FORBID_CONTENTS,W):nn,Oe=oe(l,"FORBID_TAGS")?k({},l.FORBID_TAGS,W):me({}),dt=oe(l,"FORBID_ATTR")?k({},l.FORBID_ATTR,W):me({}),Se=oe(l,"USE_PROFILES")?l.USE_PROFILES:!1,Kt=l.ALLOW_ARIA_ATTR!==!1,ut=l.ALLOW_DATA_ATTR!==!1,Jt=l.ALLOW_UNKNOWN_PROTOCOLS||!1,Zt=l.ALLOW_SELF_CLOSE_IN_ATTR!==!1,Te=l.SAFE_FOR_TEMPLATES||!1,We=l.SAFE_FOR_XML!==!1,_e=l.WHOLE_DOCUMENT||!1,Ne=l.RETURN_DOM||!1,ze=l.RETURN_DOM_FRAGMENT||!1,Be=l.RETURN_TRUSTED_TYPE||!1,pt=l.FORCE_BODY||!1,en=l.SANITIZE_DOM!==!1,tn=l.SANITIZE_NAMED_PROPS||!1,mt=l.KEEP_CONTENT!==!1,xe=l.IN_PLACE||!1,ce=l.ALLOWED_URI_REGEXP||ir,Ce=l.NAMESPACE||ue,Ye=l.MATHML_TEXT_INTEGRATION_POINTS||Ye,Qe=l.HTML_INTEGRATION_POINTS||Qe,P=l.CUSTOM_ELEMENT_HANDLING||{},l.CUSTOM_ELEMENT_HANDLING&&on(l.CUSTOM_ELEMENT_HANDLING.tagNameCheck)&&(P.tagNameCheck=l.CUSTOM_ELEMENT_HANDLING.tagNameCheck),l.CUSTOM_ELEMENT_HANDLING&&on(l.CUSTOM_ELEMENT_HANDLING.attributeNameCheck)&&(P.attributeNameCheck=l.CUSTOM_ELEMENT_HANDLING.attributeNameCheck),l.CUSTOM_ELEMENT_HANDLING&&typeof l.CUSTOM_ELEMENT_HANDLING.allowCustomizedBuiltInElements=="boolean"&&(P.allowCustomizedBuiltInElements=l.CUSTOM_ELEMENT_HANDLING.allowCustomizedBuiltInElements),Te&&(ut=!1),ze&&(Ne=!0),Se&&(q=k({},Fn),B=[],Se.html===!0&&(k(q,In),k(B,Dn)),Se.svg===!0&&(k(q,At),k(B,Ot),k(B,Ze)),Se.svgFilters===!0&&(k(q,kt),k(B,Ot),k(B,Ze)),Se.mathMl===!0&&(k(q,Rt),k(B,Pn),k(B,Ze))),l.ADD_TAGS&&(typeof l.ADD_TAGS=="function"?Ee.tagCheck=l.ADD_TAGS:(q===Qt&&(q=me(q)),k(q,l.ADD_TAGS,W))),l.ADD_ATTR&&(typeof l.ADD_ATTR=="function"?Ee.attributeCheck=l.ADD_ATTR:(B===jt&&(B=me(B)),k(B,l.ADD_ATTR,W))),l.ADD_URI_SAFE_ATTR&&k(ft,l.ADD_URI_SAFE_ATTR,W),l.FORBID_CONTENTS&&(we===nn&&(we=me(we)),k(we,l.FORBID_CONTENTS,W)),mt&&(q["#text"]=!0),_e&&k(q,["html","head","body"]),q.table&&(k(q,["tbody"]),delete Oe.tbody),l.TRUSTED_TYPES_POLICY){if(typeof l.TRUSTED_TYPES_POLICY.createHTML!="function")throw De('TRUSTED_TYPES_POLICY configuration option must provide a "createHTML" hook.');if(typeof l.TRUSTED_TYPES_POLICY.createScriptURL!="function")throw De('TRUSTED_TYPES_POLICY configuration option must provide a "createScriptURL" hook.');w=l.TRUSTED_TYPES_POLICY,A=w.createHTML("")}else w===void 0&&(w=_a(g,i)),w!==null&&typeof A=="string"&&(A=w.createHTML(""));J&&J(l),Le=l}},ln=k({},[...At,...kt,...sa]),cn=k({},[...Rt,...oa]),vr=function(l){let _=v(l);(!_||!_.tagName)&&(_={namespaceURI:Ce,tagName:"template"});const N=rt(l.tagName),D=rt(_.tagName);return _t[l.namespaceURI]?l.namespaceURI===Ve?_.namespaceURI===ue?N==="svg":_.namespaceURI===Xe?N==="svg"&&(D==="annotation-xml"||Ye[D]):!!ln[N]:l.namespaceURI===Xe?_.namespaceURI===ue?N==="math":_.namespaceURI===Ve?N==="math"&&Qe[D]:!!cn[N]:l.namespaceURI===ue?_.namespaceURI===Ve&&!Qe[D]||_.namespaceURI===Xe&&!Ye[D]?!1:!cn[N]&&(fr[N]||!ln[N]):!!(Me==="application/xhtml+xml"&&_t[l.namespaceURI]):!1},de=function(l){Ie(e.removed,{element:l});try{v(l).removeChild(l)}catch{E(l)}},ye=function(l,_){try{Ie(e.removed,{attribute:_.getAttributeNode(l),from:_})}catch{Ie(e.removed,{attribute:null,from:_})}if(_.removeAttribute(l),l==="is")if(Ne||ze)try{de(_)}catch{}else try{_.setAttribute(l,"")}catch{}},dn=function(l){let _=null,N=null;if(pt)l="<remove></remove>"+l;else{const $=Lt(l,/^[\r\n\t ]+/);N=$&&$[0]}Me==="application/xhtml+xml"&&Ce===ue&&(l='<html xmlns="http://www.w3.org/1999/xhtml"><head></head><body>'+l+"</body></html>");const D=w?w.createHTML(l):l;if(Ce===ue)try{_=new p().parseFromString(D,Me)}catch{}if(!_||!_.documentElement){_=C.createDocument(Ce,"template",null);try{_.documentElement.innerHTML=gt?A:D}catch{}}const Y=_.body||_.documentElement;return l&&N&&Y.insertBefore(n.createTextNode(N),Y.childNodes[0]||null),Ce===ue?ne.call(_,_e?"html":"body")[0]:_e?_.documentElement:Y},un=function(l){return O.call(l.ownerDocument||l,l,d.SHOW_ELEMENT|d.SHOW_COMMENT|d.SHOW_TEXT|d.SHOW_PROCESSING_INSTRUCTION|d.SHOW_CDATA_SECTION,null)},vt=function(l){return l instanceof c&&(typeof l.nodeName!="string"||typeof l.textContent!="string"||typeof l.removeChild!="function"||!(l.attributes instanceof f)||typeof l.removeAttribute!="function"||typeof l.setAttribute!="function"||typeof l.namespaceURI!="string"||typeof l.insertBefore!="function"||typeof l.hasChildNodes!="function")},hn=function(l){return typeof h=="function"&&l instanceof h};function he(L,l,_){Je(L,N=>{N.call(e,l,_,Le)})}const pn=function(l){let _=null;if(he(R.beforeSanitizeElements,l,null),vt(l))return de(l),!0;const N=W(l.nodeName);if(he(R.uponSanitizeElement,l,{tagName:N,allowedTags:q}),We&&l.hasChildNodes()&&!hn(l.firstElementChild)&&K(/<[/\w!]/g,l.innerHTML)&&K(/<[/\w!]/g,l.textContent)||l.nodeType===Ue.progressingInstruction||We&&l.nodeType===Ue.comment&&K(/<[/\w]/g,l.data))return de(l),!0;if(!(Ee.tagCheck instanceof Function&&Ee.tagCheck(N))&&(!q[N]||Oe[N])){if(!Oe[N]&&fn(N)&&(P.tagNameCheck instanceof RegExp&&K(P.tagNameCheck,N)||P.tagNameCheck instanceof Function&&P.tagNameCheck(N)))return!1;if(mt&&!we[N]){const D=v(l)||l.parentNode,Y=m(l)||l.childNodes;if(Y&&D){const $=Y.length;for(let ee=$-1;ee>=0;--ee){const pe=T(Y[ee],!0);pe.__removalCount=(l.__removalCount||0)+1,D.insertBefore(pe,y(l))}}}return de(l),!0}return l instanceof u&&!vr(l)||(N==="noscript"||N==="noembed"||N==="noframes")&&K(/<\/no(script|embed|frames)/i,l.innerHTML)?(de(l),!0):(Te&&l.nodeType===Ue.text&&(_=l.textContent,Je([z,H,qe],D=>{_=Fe(_,D," ")}),l.textContent!==_&&(Ie(e.removed,{element:l.cloneNode()}),l.textContent=_)),he(R.afterSanitizeElements,l,null),!1)},mn=function(l,_,N){if(en&&(_==="id"||_==="name")&&(N in n||N in yr))return!1;if(!(ut&&!dt[_]&&K(I,_))){if(!(Kt&&K(be,_))){if(!(Ee.attributeCheck instanceof Function&&Ee.attributeCheck(_,l))){if(!B[_]||dt[_]){if(!(fn(l)&&(P.tagNameCheck instanceof RegExp&&K(P.tagNameCheck,l)||P.tagNameCheck instanceof Function&&P.tagNameCheck(l))&&(P.attributeNameCheck instanceof RegExp&&K(P.attributeNameCheck,_)||P.attributeNameCheck instanceof Function&&P.attributeNameCheck(_,l))||_==="is"&&P.allowCustomizedBuiltInElements&&(P.tagNameCheck instanceof RegExp&&K(P.tagNameCheck,N)||P.tagNameCheck instanceof Function&&P.tagNameCheck(N))))return!1}else if(!ft[_]){if(!K(ce,Fe(N,j,""))){if(!((_==="src"||_==="xlink:href"||_==="href")&&l!=="script"&&na(N,"data:")===0&&rn[l])){if(!(Jt&&!K(le,Fe(N,j,"")))){if(N)return!1}}}}}}}return!0},fn=function(l){return l!=="annotation-xml"&&Lt(l,ge)},gn=function(l){he(R.beforeSanitizeAttributes,l,null);const{attributes:_}=l;if(!_||vt(l))return;const N={attrName:"",attrValue:"",keepAttr:!0,allowedAttributes:B,forceKeepAttr:void 0};let D=_.length;for(;D--;){const Y=_[D],{name:$,namespaceURI:ee,value:pe}=Y,Ae=W($),bt=pe;let X=$==="value"?bt:ra(bt);if(N.attrName=Ae,N.attrValue=X,N.keepAttr=!0,N.forceKeepAttr=void 0,he(R.uponSanitizeAttribute,l,N),X=N.attrValue,tn&&(Ae==="id"||Ae==="name")&&(ye($,l),X=pr+X),We&&K(/((--!?|])>)|<\/(style|title|textarea)/i,X)){ye($,l);continue}if(Ae==="attributename"&&Lt(X,"href")){ye($,l);continue}if(N.forceKeepAttr)continue;if(!N.keepAttr){ye($,l);continue}if(!Zt&&K(/\/>/i,X)){ye($,l);continue}Te&&Je([z,H,qe],yn=>{X=Fe(X,yn," ")});const _n=W(l.nodeName);if(!mn(_n,Ae,X)){ye($,l);continue}if(w&&typeof g=="object"&&typeof g.getAttributeType=="function"&&!ee)switch(g.getAttributeType(_n,Ae)){case"TrustedHTML":{X=w.createHTML(X);break}case"TrustedScriptURL":{X=w.createScriptURL(X);break}}if(X!==bt)try{ee?l.setAttributeNS(ee,$,X):l.setAttribute($,X),vt(l)?de(l):Mn(e.removed)}catch{ye($,l)}}he(R.afterSanitizeAttributes,l,null)},br=function L(l){let _=null;const N=un(l);for(he(R.beforeSanitizeShadowDOM,l,null);_=N.nextNode();)he(R.uponSanitizeShadowNode,_,null),pn(_),gn(_),_.content instanceof s&&L(_.content);he(R.afterSanitizeShadowDOM,l,null)};return e.sanitize=function(L){let l=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{},_=null,N=null,D=null,Y=null;if(gt=!L,gt&&(L="<!-->"),typeof L!="string"&&!hn(L))if(typeof L.toString=="function"){if(L=L.toString(),typeof L!="string")throw De("dirty is not a string, aborting")}else throw De("toString is not a function");if(!e.isSupported)return L;if(ht||yt(l),e.removed=[],typeof L=="string"&&(xe=!1),xe){if(L.nodeName){const pe=W(L.nodeName);if(!q[pe]||Oe[pe])throw De("root node is forbidden and cannot be sanitized in-place")}}else if(L instanceof h)_=dn("<!---->"),N=_.ownerDocument.importNode(L,!0),N.nodeType===Ue.element&&N.nodeName==="BODY"||N.nodeName==="HTML"?_=N:_.appendChild(N);else{if(!Ne&&!Te&&!_e&&L.indexOf("<")===-1)return w&&Be?w.createHTML(L):L;if(_=dn(L),!_)return Ne?null:Be?A:""}_&&pt&&de(_.firstChild);const $=un(xe?L:_);for(;D=$.nextNode();)pn(D),gn(D),D.content instanceof s&&br(D.content);if(xe)return L;if(Ne){if(ze)for(Y=M.call(_.ownerDocument);_.firstChild;)Y.appendChild(_.firstChild);else Y=_;return(B.shadowroot||B.shadowrootmode)&&(Y=se.call(a,Y,!0)),Y}let ee=_e?_.outerHTML:_.innerHTML;return _e&&q["!doctype"]&&_.ownerDocument&&_.ownerDocument.doctype&&_.ownerDocument.doctype.name&&K(sr,_.ownerDocument.doctype.name)&&(ee="<!DOCTYPE "+_.ownerDocument.doctype.name+`>
`+ee),Te&&Je([z,H,qe],pe=>{ee=Fe(ee,pe," ")}),w&&Be?w.createHTML(ee):ee},e.setConfig=function(){let L=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};yt(L),ht=!0},e.clearConfig=function(){Le=null,ht=!1},e.isValidAttribute=function(L,l,_){Le||yt({});const N=W(L),D=W(l);return mn(N,D,_)},e.addHook=function(L,l){typeof l=="function"&&Ie(R[L],l)},e.removeHook=function(L,l){if(l!==void 0){const _=ea(R[L],l);return _===-1?void 0:ta(R[L],_,1)[0]}return Mn(R[L])},e.removeHooks=function(L){R[L]=[]},e.removeAllHooks=function(){R=Hn()},e}var Yt=or();function ya({mode:t,onModeChange:e,showToggle:n=!0}){return n?r("div",{className:"search-mode-toggle",children:[r("button",{className:`mode-btn ${t==="fts"?"active":""}`,onClick:()=>e("fts"),children:" FTS Only"}),r("button",{className:`mode-btn ${t==="hybrid"?"active":""}`,onClick:()=>e("hybrid"),children:" Hybrid"}),r("button",{className:`mode-btn ${t==="graph"?"active":""}`,onClick:()=>e("graph"),children:" Graph"})]}):null}function va({onSearch:t,loading:e,placeholder:n,searchHistory:a,onClearHistory:i}){return r(re,{children:[r("form",{onSubmit:s=>{s.preventDefault();const h=new FormData(s.currentTarget).get("query");h!=null&&h.trim()&&t(h.trim())},children:r("div",{className:"search-bar",children:[r("input",{type:"text",name:"query",placeholder:n||"Search the capsule...",className:"search-input",disabled:e}),r("button",{type:"submit",className:"btn-search",disabled:e,children:e?"Searching...":"Search"})]})}),a&&a.length>0&&r("div",{className:"search-history",children:[r("div",{className:"search-history-header",children:[r("span",{className:"search-history-label",children:"Recent searches:"}),i&&r("button",{className:"search-history-clear",onClick:i,type:"button",children:"Clear"})]}),r("div",{className:"search-history-items",children:a.map((s,o)=>r("button",{className:"search-history-item",onClick:()=>t(s),type:"button",children:s},o))})]})]})}function ba({resultGid:t,retrievalId:e}){const[n,a]=S(null),[i,s]=S(!1),o=async h=>{s(!0);try{if(zr({retrievalId:e,rating:h,notes:void 0}),V.isDynamic()){const d=V.getEnvelope().getWriter();d&&await d.appendFeedback({id:nr("fb"),retrieval_id:e,rating:h,notes:void 0})}a(h)}catch(u){console.error("[Feedback] Failed to submit feedback:",u)}finally{s(!1)}};return V.isDynamic()?r("div",{className:"result-feedback",children:[r("button",{className:`feedback-btn ${n===1?"feedback-btn-active-positive":""}`,onClick:h=>{h.stopPropagation(),o(1)},disabled:i||n!==null,title:"Helpful result",children:""}),r("button",{className:`feedback-btn ${n===-1?"feedback-btn-active-negative":""}`,onClick:h=>{h.stopPropagation(),o(-1)},disabled:i||n!==null,title:"Not helpful",children:""})]}):null}function Ea({results:t,query:e,onResultClick:n,retrievalId:a}){return r("div",{className:"search-results",children:[r("p",{className:"results-header",children:["Found ",t.length," results for ",r("strong",{children:['"',e,'"']})]}),t.map(i=>r("div",{className:`result-item ${n?"result-item-clickable":""}`,onClick:()=>n==null?void 0:n(i.gid),style:{cursor:n?"pointer":"default"},children:[r("div",{className:"result-header",children:[r("span",{className:"result-page",children:["Page ",i.pageNo]}),r("span",{className:"result-score",children:["Score: ",i.scores.final.toFixed(3)]}),r(ba,{resultGid:i.gid,retrievalId:a})]}),r("h4",{className:"result-title",children:i.title}),i.snippet&&r("p",{className:"result-snippet",dangerouslySetInnerHTML:{__html:Yt.sanitize(i.snippet,{ALLOWED_TAGS:["mark","strong","em","b","i"],ALLOWED_ATTR:[]})}}),r("div",{className:"result-scores",children:[r("span",{children:["FTS: ",i.scores.fts.toFixed(2)]}),r("span",{children:["Entity: ",i.scores.entity.toFixed(2)]}),r("span",{children:["Graph: ",i.scores.graph.toFixed(2)]})]})]},i.gid))]})}function Ta({mode:t,results:e,lastQuery:n,loading:a,onSearch:i,onModeChange:s,onResultClick:o,showModeToggle:h=!0,placeholder:u,searchHint:d,searchHistory:f,onClearHistory:c}){return r("div",{className:"search-section",children:[r("div",{className:"search-header",children:r("h3",{children:" Search"})}),r(ya,{mode:t,onModeChange:s,showToggle:h}),d&&r("p",{className:"search-hint",children:d}),r("div",{className:"keyboard-shortcuts-hint",children:[r("span",{className:"shortcut-item",children:[r("kbd",{children:"/"})," Focus search"]}),r("span",{className:"shortcut-item",children:[r("kbd",{children:"Ctrl+L"})," Toggle LLM"]}),r("span",{className:"shortcut-item",children:[r("kbd",{children:"Esc"})," Clear focus"]})]}),r(va,{onSearch:i,loading:a,placeholder:u,searchHistory:f,onClearHistory:c}),e&&e.length>0&&r(Ea,{results:e,query:n,onResultClick:o}),e&&e.length===0&&r("div",{className:"no-results",children:[r("p",{children:["No results found for ",r("strong",{children:['"',n,'"']})]}),r("p",{className:"search-hint",children:"Try different keywords or search terms."})]})]})}function lr(t={}){const{autoLoad:e=!0,maxEntities:n=50}=t,[a,i]=S([]),[s,o]=S(null),[h,u]=S(!1),[d,f]=S(null),c=async()=>{u(!0),f(null);try{const m=await te().listEntities(void 0,n);i(m),console.log("[Entities] Loaded:",m.length)}catch(y){const m=String(y);f(m),console.error("[Entities] Failed to load:",y)}finally{u(!1)}};Q(()=>{e&&c()},[e]);const p=y=>{o(y)},g=()=>Array.from(new Set(a.map(y=>y.entityType))),b=()=>s?a.filter(y=>y.entityType===s):a,T=y=>a.filter(m=>m.entityType===y).reduce((m,v)=>m+v.count,0),E=()=>a.reduce((y,m)=>y+m.count,0);return{entities:a,selectedType:s,loading:h,error:d,types:g(),filteredEntities:b(),totalCount:E(),loadEntities:c,selectType:p,getTypeCount:T}}function Na({types:t,selectedType:e,totalCount:n,onSelectType:a,getTypeCount:i}){return r("div",{className:"entity-filters",children:[r("button",{className:`entity-filter ${e===null?"active":""}`,onClick:()=>a(null),children:["All (",n,")"]}),t.map(s=>{const o=i(s);return r("button",{className:`entity-filter ${e===s?"active":""}`,onClick:()=>a(s),children:[s," (",o,")"]},s)})]})}function Sa({entities:t,maxDisplay:e=20}){const n=t.slice(0,e);return r("div",{className:"entity-list",children:[n.map(a=>r("div",{className:"entity-item",children:[r("span",{className:"entity-type",children:a.entityType}),r("span",{className:"entity-value",children:a.normalizedValue}),r("span",{className:"entity-count",children:a.count})]},`${a.entityType}-${a.normalizedValue}`)),t.length>e&&r("div",{className:"entity-item entity-more",children:r("span",{className:"entity-value",children:["... and ",t.length-e," more"]})})]})}function wa({entities:t,types:e,selectedType:n,totalCount:a,onSelectType:i,getTypeCount:s,show:o=!0,maxDisplay:h=20}){if(!o||t.length===0)return null;const u=n?t.filter(d=>d.entityType===n):t;return r("div",{className:"entity-panel",children:[r("h4",{children:"Filter by Entity Type"}),r(Na,{types:e,selectedType:n,totalCount:a,onSelectType:i,getTypeCount:s}),r(Sa,{entities:u,maxDisplay:h})]})}class Ca{constructor(){x(this,"worker",null);x(this,"nextId",1);x(this,"pending",new Map);x(this,"progressCallback",null);this.initWorker()}initWorker(){this.worker=new Worker(new URL("/assets/llm.worker-BXtIo8pX.js",import.meta.url),{type:"module"}),this.worker.onmessage=e=>{const n=e.data;if("type"in n&&n.type==="READY"){console.log("[LlmClient] Worker ready");return}if("type"in n&&n.type==="PROGRESS"){this.progressCallback&&this.progressCallback(n.data);return}const{id:a,response:i}=n,s=this.pending.get(a);s&&(this.pending.delete(a),s.resolve(i))},this.worker.onerror=e=>{console.error("[LlmClient] Worker error:",e);for(const n of this.pending.values())n.reject(new Error("Worker error"));this.pending.clear()}}async sendRequest(e){if(!this.worker)throw new Error("Worker not initialized");const n=this.nextId++;return new Promise((a,i)=>{this.pending.set(n,{resolve:o=>{o.ok?a(o.data):i(new Error(o.error))},reject:i});const s={id:n,request:e};this.worker.postMessage(s)})}onProgress(e){this.progressCallback=e}async loadModel(e){return this.sendRequest({type:"LOAD_MODEL",modelUrl:e})}async reason(e){return this.sendRequest({type:"REASON",request:e})}async unloadModel(){return this.sendRequest({type:"UNLOAD_MODEL"})}async getStatus(){return this.sendRequest({type:"GET_STATUS"})}terminate(){this.worker&&(this.worker.terminate(),this.worker=null),this.pending.clear(),this.progressCallback=null}}let xt=null;function $n(){return xt||(xt=new Ca),xt}const La={"0.6b":"https://huggingface.co/unsloth/Qwen3-0.6B-GGUF/resolve/main/Qwen3-0.6B-Q4_K_M.gguf","1.5b":"https://huggingface.co/ggml-org/Qwen2.5-1.5B-Instruct-GGUF/resolve/main/qwen2.5-1.5b-instruct-q4_k_m.gguf"};function cr(t={}){const[e,n]=S(!1),[a,i]=S(null),[s,o]=S(!1),[h,u]=S(null),[d,f]=S(null),[c,p]=S(null),[g,b]=S(0),[T,E]=S(.7),y=st(0),m=st(null);Q(()=>{if(s&&!h)return y.current=Date.now(),b(0),m.current=window.setInterval(()=>{const O=(Date.now()-y.current)/1e3;b(O)},100),()=>{m.current&&clearInterval(m.current)};m.current&&(clearInterval(m.current),m.current=null),b(0)},[s,h]);const v=async()=>{o(!0),p(null),u(null);try{const O=$n();O.onProgress(ne=>{u(ne)});const M=await O.loadModel(La["0.6b"]);i(M),u(null),console.log("[LLM] Model loaded:",M)}catch(O){const M=String(O);p(M),console.error("[LLM] Failed to load model:",O)}finally{o(!1)}};return{enabled:e,modelInfo:a,loading:s,progress:h,reasoning:d,error:c,elapsedTime:g,temperature:T,toggle:async()=>{e?(n(!1),f(null)):(a!=null&&a.loaded||await v(),n(!0))},loadModel:v,reason:async(O,M,ne=256)=>{if(!(a!=null&&a.loaded)){console.warn("[LLM] Cannot reason: model not loaded");return}o(!0),p(null);try{const se=$n(),R=M.slice(0,5).map(H=>({gid:H.gid,pageNo:H.pageNo,title:H.title,text:H.snippet||"",score:H.scores.final}));Gr({prompt:O,context:R.map(H=>H.text),model:a.modelId});const z=await se.reason({question:O,snippets:R,maxTokens:ne,temperature:T});qr({response:z.answer,citations:z.usedSnippets.map(H=>({gid:H.gid,pageNo:H.pageNo})),model:a.modelId}),z.usedSnippets.forEach(H=>{Wr({gid:H.gid,pageNo:H.pageNo,title:H.title||void 0,snippet:H.text})}),f(z),console.log("[LLM] Reasoning complete:",z)}catch(se){const R=String(se);p(R),console.error("[LLM] Reasoning failed:",se)}finally{o(!1)}},clearReasoning:()=>{f(null)},setTemperature:E}}function Aa({reasoning:t,searchResults:e,loading:n}){const[a,i]=S(null);return n&&!t?r("div",{className:"reasoning-loading",children:[r("div",{className:"spinner"}),r("p",{children:"LLM is reasoning..."})]}):t?r("div",{className:"reasoning-output",children:[r("div",{className:"reasoning-header",children:[r("h4",{children:" LLM Reasoning"}),r("span",{className:"reasoning-meta",children:[t.inferenceTimeMs.toFixed(0),"ms  ",t.tokensGenerated," tokens"]})]}),r("div",{className:"reasoning-answer",children:t.answer}),t.usedSnippets.length>0&&r("div",{className:"reasoning-citations",children:[r("strong",{children:" Cited sources:"}),t.usedSnippets.map(s=>{const o=e==null?void 0:e.find(h=>h.gid===s);return r("span",{className:"citation",onMouseEnter:()=>i(s),onMouseLeave:()=>i(null),style:{position:"relative"},children:["Page ",(o==null?void 0:o.pageNo)||"?",a===s&&o&&r("div",{className:"citation-tooltip",children:[r("div",{className:"citation-tooltip-title",children:o.title}),o.snippet&&r("div",{className:"citation-tooltip-snippet",dangerouslySetInnerHTML:{__html:Yt.sanitize(o.snippet,{ALLOWED_TAGS:["mark","strong","em","b","i"],ALLOWED_ATTR:[]})}}),r("div",{className:"citation-tooltip-meta",children:["Score: ",o.scores.final.toFixed(3),"  GID: ",s.slice(0,8),"..."]})]})]},s)})]})]}):null}function ke(){return typeof navigator<"u"&&"storage"in navigator&&"getDirectory"in navigator.storage}async function ka(){if(!ke())throw new Error("OPFS not supported in this browser");return await navigator.storage.getDirectory()}async function Ra(){return await(await ka()).getDirectoryHandle("capsules",{create:!0})}function Oa(t){const e=t.replace(/[^a-z0-9._-]/gi,"-");return e.endsWith(".mgx.sqlite")?e:`${e}.mgx.sqlite`}async function xa(t,e){if(!ke())throw new Error("OPFS not supported - cannot persist file");const n=await Ra(),a=e||Oa(t.name),s=await(await n.getFileHandle(a,{create:!0})).createWritable();try{return await s.write(t),await s.close(),console.log(`[OPFS] Copied file to ${a} (${t.size} bytes)`),{path:a,size:t.size}}catch(o){throw await s.close(),o}}async function Ma(){if(!navigator.storage||!navigator.storage.estimate)return null;try{const t=await navigator.storage.estimate(),e=t.usage||0,n=t.quota||0;return{usage:e,quota:n,available:n-e,percentUsed:n>0?e/n*100:0}}catch(t){return console.error("[OPFS] Failed to get storage quota:",t),null}}async function Ia(){if(!navigator.storage||!navigator.storage.persist)return!1;try{const t=await navigator.storage.persist();return console.log(`[OPFS] Persistent storage: ${t}`),t}catch(t){return console.error("[OPFS] Failed to request persistent storage:",t),!1}}function He(t){if(t===0)return"0 B";const e=1024,n=["B","KB","MB","GB"],a=Math.floor(Math.log(t)/Math.log(e));return`${(t/Math.pow(e,a)).toFixed(2)} ${n[a]}`}async function Fa(t,e=500*1024*1024){if(t.size===0)return{valid:!1,error:"File is empty"};if(t.size>e)return{valid:!1,error:`File too large (${He(t.size)} > ${He(e)})`};const n=t.name.toLowerCase();if(!n.endsWith(".mgx.sqlite")&&!n.endsWith(".sqlite"))return{valid:!1,error:"File must have .mgx.sqlite or .sqlite extension"};try{const a=await t.slice(0,16).arrayBuffer();if(!new TextDecoder().decode(a).startsWith("SQLite format 3"))return{valid:!1,error:"Not a valid SQLite file (invalid header)"}}catch(a){return{valid:!1,error:`Failed to read file header: ${a}`}}return{valid:!0}}function Da({onFileSelected:t,onOpfsFileSelected:e,onError:n}){const[a,i]=S([]),[s,o]=S(null),[h,u]=S(!1),[d,f]=S(!1),c=te();Q(()=>{p(),g()},[]);async function p(){try{const m=await c.listOpfsFiles();i(m)}catch(m){console.error("[FilePicker] Failed to list OPFS files:",m)}}async function g(){var m,v;try{const w=await Ma();o(w);const A=await((v=(m=navigator.storage)==null?void 0:m.persisted)==null?void 0:v.call(m));f(A||!1)}catch(w){console.error("[FilePicker] Failed to get quota:",w)}}async function b(m){var A;const v=m.target,w=(A=v.files)==null?void 0:A[0];if(w){u(!0);try{const C=await Fa(w);if(!C.valid){n(C.error),u(!1);return}if(ke()){const{path:O}=await xa(w);await p(),await g(),t(w,O)}else t(w)}catch(C){n(`Failed to load file: ${C}`)}finally{u(!1),v.value=""}}}async function T(m){u(!0);try{e(m)}catch(v){n(`Failed to open from OPFS: ${v}`)}finally{u(!1)}}async function E(m,v){if(v.stopPropagation(),!!confirm(`Remove "${m}" from device storage?`))try{await c.removeFromOpfs(m),await p(),await g()}catch(w){n(`Failed to remove file: ${w}`)}}async function y(){try{await Ia()?f(!0):n("Persistent storage not granted. Files may be evicted under storage pressure.")}catch(m){n(`Failed to request persistence: ${m}`)}}return r("div",{class:"file-picker",children:[r("div",{class:"file-picker-header",children:[r("h2",{children:"Open Capsule"}),s&&r("div",{class:"storage-quota",children:[r("div",{class:"quota-bar",children:r("div",{class:"quota-used",style:`width: ${Math.min(s.percentUsed,100)}%`})}),r("p",{class:"quota-text",children:[He(s.usage)," / ",He(s.quota)," used (",s.percentUsed.toFixed(1),"%)"]}),!d&&ke()&&r("button",{class:"btn-secondary btn-sm",onClick:y,children:"Request Persistent Storage"})]})]}),r("div",{class:"file-input-section",children:[r("label",{class:"file-input-label",children:[r("input",{type:"file",accept:".mgx.sqlite,.sqlite",onChange:b,disabled:h,style:"display: none"}),r("button",{class:"btn-primary",disabled:h,children:h?"Loading...":"Select File from Device"})]}),r("p",{class:"help-text",children:"Choose a .mgx.sqlite or .sqlite file from your device"})]}),ke()&&a.length>0&&r("div",{class:"opfs-files-section",children:[r("h3",{children:"Stored on Device"}),r("ul",{class:"opfs-files-list",children:a.map(m=>r("li",{class:"opfs-file-item",children:[r("button",{class:"opfs-file-button",onClick:()=>T(m.path),disabled:h,children:r("div",{class:"file-info",children:[r("span",{class:"file-name",children:m.path}),r("span",{class:"file-meta",children:[He(m.size)," "," ",new Date(m.lastModified).toLocaleDateString()]})]})}),r("button",{class:"btn-remove",onClick:v=>E(m.path,v),title:"Remove from device","aria-label":"Remove from device",children:""})]},m.path))})]}),!ke()&&r("div",{class:"opfs-warning",children:r("p",{children:[r("strong",{children:"Note:"})," Your browser doesn't support persistent storage. Files will only be kept in memory and lost when you close the tab."]})})]})}function Pa(t={}){const{autoLoad:e=!1,maxHops:n=2,limit:a=50}=t,[i,s]=S(null),[o,h]=S(null),[u,d]=S(void 0),[f,c]=S(!1),[p,g]=S(null),b=async(A,C)=>{c(!0),g(null),h(A),d(C);try{const M=await te().graphHops(A,C,n,a);s(M),console.log("[Graph] Loaded:",M.nodes.length,"nodes,",M.edges.length,"edges")}catch(O){const M=String(O);g(M),console.error("[Graph] Failed to load:",O)}finally{c(!1)}},T=async A=>{await b(A,u)},E=async A=>{o&&await b(o,A)},y=()=>{s(null),h(null),d(void 0),g(null)},m=()=>i?Array.from(new Set(i.edges.map(A=>A.predicate))):[],v=A=>i==null?void 0:i.nodes.find(C=>C.gid===A),w=A=>i?i.edges.filter(C=>C.fromGid===A):[];return Q(()=>{e&&o&&b(o,u)},[e]),{graphData:i,seedGid:o,predicate:u,loading:f,error:p,predicates:m(),nodeCount:(i==null?void 0:i.nodes.length)||0,edgeCount:(i==null?void 0:i.edges.length)||0,loadGraph:b,navigateToNode:T,filterByPredicate:E,clear:y,getNode:v,getNodeEdges:w}}function Ua({nodes:t,edges:e,seedGid:n,onNodeClick:a,width:i=800,height:s=600}){const[o,h]=S(new Map),u=st();return Q(()=>{const d=new Map,f=i/2,c=s/2;t.forEach((p,g)=>{const b=g/t.length*2*Math.PI,T=Math.min(i,s)/3;d.set(p.gid,{gid:p.gid,x:f+T*Math.cos(b),y:c+T*Math.sin(b),vx:0,vy:0})}),h(d)},[t,i,s]),Q(()=>{if(o.size===0)return;const d=()=>{const c=new Map(o),p=.3;c.forEach(g=>{c.forEach(b=>{if(g.gid===b.gid)return;const T=b.x-g.x,E=b.y-g.y,y=T*T+E*E+1,m=Math.sqrt(y),v=2e3/y;g.vx-=T/m*v*p,g.vy-=E/m*v*p})}),e.forEach(g=>{const b=c.get(g.fromGid),T=c.get(g.toGid);if(!b||!T)return;const E=T.x-b.x,y=T.y-b.y,m=Math.sqrt(E*E+y*y)+1,v=m*.01;b.vx+=E/m*v*p,b.vy+=y/m*v*p,T.vx-=E/m*v*p,T.vy-=y/m*v*p}),c.forEach(g=>{g.x+=g.vx,g.y+=g.vy,g.vx*=.8,g.vy*=.8,g.x=Math.max(30,Math.min(i-30,g.x)),g.y=Math.max(30,Math.min(s-30,g.y))}),h(c),u.current=requestAnimationFrame(d)};u.current=requestAnimationFrame(d);const f=setTimeout(()=>{u.current&&cancelAnimationFrame(u.current)},3e3);return()=>{u.current&&cancelAnimationFrame(u.current),clearTimeout(f)}},[e,i,s]),r("svg",{width:i,height:s,className:"graph-view",style:{border:"1px solid var(--color-border)",borderRadius:"8px"},children:[r("g",{className:"graph-edges",children:e.map((d,f)=>{const c=o.get(d.fromGid),p=o.get(d.toGid);return!c||!p?null:r("line",{x1:c.x,y1:c.y,x2:p.x,y2:p.y,stroke:"#94a3b8",strokeWidth:Math.max(1,d.weight*2),strokeOpacity:.6,markerEnd:"url(#arrowhead)"},`${d.fromGid}-${d.toGid}-${f}`)})}),r("defs",{children:r("marker",{id:"arrowhead",markerWidth:"10",markerHeight:"10",refX:"9",refY:"3",orient:"auto",markerUnits:"strokeWidth",children:r("path",{d:"M0,0 L0,6 L9,3 z",fill:"#94a3b8"})})}),r("g",{className:"graph-nodes",children:t.map(d=>{const f=o.get(d.gid);if(!f)return null;const c=d.gid===n,p=c?12:8,g=c?"#3b82f6":"#64748b";return r("g",{className:"graph-node",onClick:()=>a==null?void 0:a(d.gid),style:{cursor:a?"pointer":"default"},children:[r("circle",{cx:f.x,cy:f.y,r:p,fill:g,stroke:"#ffffff",strokeWidth:2,opacity:.9}),r("text",{x:f.x,y:f.y-p-5,textAnchor:"middle",fontSize:"11",fill:"var(--color-fg)",style:{pointerEvents:"none",userSelect:"none"},children:d.title||`Page ${d.pageNo}`})]},d.gid)})})]})}function Ha({nodes:t,edges:e,seedGid:n,onNodeClick:a,loading:i,error:s}){return i?r("div",{className:"graph-panel-loading",children:[r("div",{className:"spinner"}),r("p",{children:"Loading graph..."})]}):s?r("div",{className:"graph-panel-error",children:r("p",{children:["Error: ",s]})}):t.length===0?r("div",{className:"graph-panel-empty",children:[r("p",{children:"No graph data to display"}),r("p",{className:"hint",children:"Search for a page or select a result to explore its connections"})]}):r("div",{className:"graph-panel",children:[r("div",{className:"graph-info",children:[r("span",{children:[t.length," nodes"]}),r("span",{children:[e.length," edges"]})]}),r(Ua,{nodes:t,edges:e,seedGid:n,onNodeClick:a,width:800,height:600})]})}function $a({predicates:t,selectedPredicate:e,onPredicateChange:n,onReset:a}){return r("div",{className:"graph-controls",children:[r("div",{className:"graph-controls-section",children:[r("label",{className:"graph-controls-label",children:"Filter by Relationship:"}),r("select",{className:"graph-controls-select",value:e||"",onChange:i=>{const s=i.target.value;n(s||void 0)},children:[r("option",{value:"",children:"All Relationships"}),t.map(i=>r("option",{value:i,children:i},i))]})]}),a&&r("button",{className:"btn-secondary btn-sm",onClick:a,children:"Reset View"})]})}function Ga({nodeCount:t,edgeCount:e,predicateCount:n,seedNode:a}){return r("div",{className:"graph-stats",children:[r("div",{className:"graph-stat",children:[r("span",{className:"graph-stat-label",children:"Nodes:"}),r("span",{className:"graph-stat-value",children:t})]}),r("div",{className:"graph-stat",children:[r("span",{className:"graph-stat-label",children:"Edges:"}),r("span",{className:"graph-stat-value",children:e})]}),r("div",{className:"graph-stat",children:[r("span",{className:"graph-stat-label",children:"Relationships:"}),r("span",{className:"graph-stat-value",children:n})]}),a&&r("div",{className:"graph-stat",children:[r("span",{className:"graph-stat-label",children:"Seed:"}),r("span",{className:"graph-stat-value",children:a})]})]})}function qa(t={}){const{autoLoadCheckpoints:e=!1}=t,[n,a]=S([]),[i,s]=S(null),[o,h]=S(!1),[u,d]=S(!1),[f,c]=S(null),p=async()=>{h(!0),c(null);try{const E=await te().getCheckpoints();a(E),console.log("[Provenance] Loaded",E.length,"checkpoints")}catch(T){const E=String(T);c(E),console.error("[Provenance] Failed to load checkpoints:",T)}finally{h(!1)}},g=async T=>{d(!0),c(null);try{const y=await te().verifyPage(T);s(y),console.log("[Provenance] Verification result:",y)}catch(E){const y=String(E);c(y),console.error("[Provenance] Failed to verify page:",E)}finally{d(!1)}},b=()=>{s(null)};return Q(()=>{e&&p()},[e]),{checkpoints:n,verificationResult:i,loading:o,verifying:u,error:f,checkpointCount:n.length,latestCheckpoint:n[0]||null,loadCheckpoints:p,verifyPage:g,clearVerification:b}}function Wa({checkpoint:t,isLatest:e}){return r("div",{className:`checkpoint-item ${e?"checkpoint-latest":""}`,children:[r("div",{className:"checkpoint-header",children:[r("div",{className:"checkpoint-epoch",children:[e&&r("span",{className:"checkpoint-badge",children:"Latest"}),r("span",{className:"checkpoint-epoch-value",children:["Epoch ",t.epoch]})]}),r("div",{className:"checkpoint-date",children:new Date(t.createdTs).toLocaleString()})]}),r("div",{className:"checkpoint-body",children:[r("div",{className:"checkpoint-field",children:[r("span",{className:"field-label",children:"Merkle Root:"}),r("code",{className:"field-value",title:t.merkleRoot,children:[t.merkleRoot.substring(0,16),"..."]})]}),r("div",{className:"checkpoint-field",children:[r("span",{className:"field-label",children:"Pages:"}),r("span",{className:"field-value",children:t.pagesCount})]}),t.anchors&&t.anchors.length>0&&r("div",{className:"checkpoint-field",children:[r("span",{className:"field-label",children:"Anchors:"}),r("span",{className:"field-value",children:t.anchors.length})]})]})]})}function za({checkpoints:t,loading:e,error:n}){return e?r("div",{className:"checkpoint-timeline-loading",children:[r("div",{className:"spinner"}),r("p",{children:"Loading checkpoints..."})]}):n?r("div",{className:"checkpoint-timeline-error",children:r("p",{children:["Error: ",n]})}):t.length===0?r("div",{className:"checkpoint-timeline-empty",children:[r("p",{children:"No checkpoints found"}),r("p",{className:"hint",children:"This capsule has not been checkpointed yet"})]}):r("div",{className:"checkpoint-timeline",children:t.map((a,i)=>r(Wa,{checkpoint:a,isLatest:i===0},a.epoch))})}function Ba({result:t,verifying:e,onVerify:n}){return e?r("div",{className:"verification-panel verification-loading",children:[r("div",{className:"spinner"}),r("p",{children:"Verifying page integrity..."})]}):t?r("div",{className:`verification-panel ${t.verified?"verification-success":"verification-failure"}`,children:[r("div",{className:"verification-header",children:r("div",{className:"verification-status",children:t.verified?r(re,{children:[r("span",{className:"status-icon",children:""}),r("span",{className:"status-text",children:"Verified"})]}):r(re,{children:[r("span",{className:"status-icon",children:""}),r("span",{className:"status-text",children:"Verification Failed"})]})})}),r("div",{className:"verification-body",children:[r("div",{className:"verification-field",children:[r("span",{className:"field-label",children:"Content SHA:"}),r("code",{className:"field-value",title:t.contentSha,children:[t.contentSha.substring(0,16),"..."]})]}),t.expectedSha&&r("div",{className:"verification-field",children:[r("span",{className:"field-label",children:"Expected SHA:"}),r("code",{className:"field-value",title:t.expectedSha,children:[t.expectedSha.substring(0,16),"..."]})]}),t.epoch&&r("div",{className:"verification-field",children:[r("span",{className:"field-label",children:"Checkpoint Epoch:"}),r("span",{className:"field-value",children:t.epoch})]}),t.merkleRoot&&r("div",{className:"verification-field",children:[r("span",{className:"field-label",children:"Merkle Root:"}),r("code",{className:"field-value",title:t.merkleRoot,children:[t.merkleRoot.substring(0,16),"..."]})]}),t.signer&&r("div",{className:"verification-field",children:[r("span",{className:"field-label",children:"Signer:"}),r("code",{className:"field-value",children:t.signer})]}),t.signature&&r("div",{className:"verification-field",children:[r("span",{className:"field-label",children:"Signature:"}),r("code",{className:"field-value",title:t.signature,children:[t.signature.substring(0,16),"..."]})]})]}),n&&r("div",{className:"verification-footer",children:r("button",{className:"btn-secondary btn-sm",onClick:n,children:"Verify Again"})})]}):r("div",{className:"verification-panel verification-empty",children:[r("p",{children:'Click "Verify Page" to check integrity'}),n&&r("button",{className:"btn-primary btn-sm",onClick:n,children:"Verify Page"})]})}function Xa({checkpoints:t,verificationResult:e,loading:n,verifying:a,error:i,onVerify:s}){const[o,h]=S("checkpoints");return r("div",{className:"provenance-panel",children:[r("div",{className:"provenance-header",children:r("h3",{children:"Provenance & Trust"})}),r("div",{className:"provenance-tabs",children:[r("button",{className:`provenance-tab ${o==="checkpoints"?"active":""}`,onClick:()=>h("checkpoints"),children:[" Checkpoints (",t.length,")"]}),r("button",{className:`provenance-tab ${o==="verification"?"active":""}`,onClick:()=>h("verification"),children:" Verification"})]}),r("div",{className:"provenance-content",children:[o==="checkpoints"&&r(za,{checkpoints:t,loading:n,error:i}),o==="verification"&&r(Ba,{result:e,verifying:a,onVerify:s})]})]})}function Va(t){const{onFocusSearch:e,onToggleLlm:n,onEscape:a}=t;Q(()=>{function i(s){const o=s.target,h=o.tagName==="INPUT"||o.tagName==="TEXTAREA"||o.isContentEditable;if(s.key==="/"&&!h){s.preventDefault(),e==null||e();return}if((s.ctrlKey||s.metaKey)&&s.key==="l"){s.preventDefault(),n==null||n();return}if(s.key==="Escape"){a==null||a();return}}return window.addEventListener("keydown",i),()=>{window.removeEventListener("keydown",i)}},[e,n,a])}function Ya(){const[t,e]=S(V.getInfo()),[n,a]=S(V.getModality()),[i,s]=S(V.getEnvelopeStats());return Q(()=>{const c=ae.subscribe("capsule.loaded",()=>{e(V.getInfo()),a(V.getModality()),s(V.getEnvelopeStats())}),p=ae.subscribe("capsule.unloaded",()=>{e(null),a("static"),s(null)}),g=ae.subscribe("envelope.stats",b=>{s(b)});return()=>{c(),p(),g()}},[]),{info:t,modality:n,isDynamic:n==="dynamic",envelopeStats:i,enableDynamicMode:async()=>{await V.enableDynamicMode(),a("dynamic")},exportEnvelope:async()=>V.exportEnvelope(),clearEnvelope:async()=>{await V.clearEnvelope(),s(V.getEnvelopeStats())},verifyEnvelope:async()=>V.verifyEnvelope(),setModalityPreference:c=>{V.setModalityPreference(c)}}}function Qa({modality:t,envelopeStats:e,onEnableDynamic:n,onExportEnvelope:a,onClearEnvelope:i,onVerifyEnvelope:s}){const[o,h]=S(!1),[u,d]=S(!1),f=async()=>{if(n){d(!0);try{await n()}catch(T){console.error("Failed to enable dynamic mode:",T),alert(`Failed to enable dynamic mode: ${T}`)}finally{d(!1)}}},c=async()=>{if(a){d(!0);try{await a(),h(!1)}catch(T){console.error("Failed to export envelope:",T),alert(`Failed to export envelope: ${T}`)}finally{d(!1)}}},p=async()=>{if(!(!i||!confirm(`Are you sure you want to clear all envelope data?

This will delete:
 ${(e==null?void 0:e.retrievalCount)||0} retrieval logs
 ${(e==null?void 0:e.feedbackCount)||0} feedback entries
 ${(e==null?void 0:e.embeddingCount)||0} contextual embeddings
 ${(e==null?void 0:e.summaryCount)||0} context summaries

This action cannot be undone.`))){d(!0);try{await i(),h(!1)}catch(E){console.error("Failed to clear envelope:",E),alert(`Failed to clear envelope: ${E}`)}finally{d(!1)}}},g=async()=>{if(s){d(!0);try{await s(),h(!1)}catch(T){console.error("Failed to verify envelope:",T),alert(`Failed to verify envelope: ${T}`)}finally{d(!1)}}},b=t==="dynamic";return r("div",{className:"modality-badge",children:[r("button",{className:`modality-badge-button ${t}`,onClick:()=>h(!o),title:b?"Dynamic GlyphCase - Click for options":"Static GlyphCase - Click for options",children:b?" Dynamic":" Static"}),o&&r("div",{className:"modality-menu",children:[r("div",{className:"modality-menu-header",children:[r("h3",{children:b?"Dynamic Mode":"Static Mode"}),r("button",{className:"modality-menu-close",onClick:()=>h(!1),children:""})]}),b?r("div",{className:"modality-menu-content",children:[r("p",{className:"modality-description",children:"This GlyphCase has an active Envelope for episodic memory."}),e&&r("div",{className:"envelope-stats",children:[r("h4",{children:"Envelope Statistics:"}),r("div",{className:"envelope-stats-grid",children:[r("div",{className:"envelope-stat",children:[r("span",{className:"envelope-stat-label",children:"Retrievals"}),r("span",{className:"envelope-stat-value",children:e.retrievalCount})]}),r("div",{className:"envelope-stat",children:[r("span",{className:"envelope-stat-label",children:"Feedbacks"}),r("span",{className:"envelope-stat-value",children:e.feedbackCount})]}),r("div",{className:"envelope-stat",children:[r("span",{className:"envelope-stat-label",children:"Embeddings"}),r("span",{className:"envelope-stat-value",children:e.embeddingCount})]}),r("div",{className:"envelope-stat",children:[r("span",{className:"envelope-stat-label",children:"Summaries"}),r("span",{className:"envelope-stat-value",children:e.summaryCount})]})]}),e.firstActivity&&r("p",{className:"envelope-activity",children:[r("strong",{children:"Active since:"})," ",new Date(e.firstActivity).toLocaleString()]})]}),r("div",{className:"envelope-actions",children:[r("button",{className:"btn-secondary btn-sm",onClick:g,disabled:u,children:u?"Verifying...":" Verify Integrity"}),r("button",{className:"btn-secondary btn-sm",onClick:c,disabled:u,children:u?"Exporting...":" Export Envelope"}),r("button",{className:"btn-danger btn-sm",onClick:p,disabled:u,children:u?"Clearing...":" Clear Envelope"})]}),r("p",{className:"envelope-hint",children:" Envelope data persists across sessions and can be exported for remint tooling."})]}):r("div",{className:"modality-menu-content",children:[r("p",{className:"modality-description",children:"This GlyphCase is in static mode. All data is read-only."}),r("div",{className:"modality-info",children:[r("h4",{children:"Enable Dynamic Mode to:"}),r("ul",{children:[r("li",{children:"Log search queries and results"}),r("li",{children:"Provide feedback on retrievals"}),r("li",{children:"Generate contextual summaries"}),r("li",{children:"Build adaptive memory over time"})]})]}),r("button",{className:"btn-primary",onClick:f,disabled:u,children:u?"Enabling...":"Enable Dynamic Mode"})]})]}),o&&r("div",{className:"modality-menu-backdrop",onClick:()=>h(!1)})]})}function ja(t){return t.startsWith("asset://")?{protocol:"asset",path:t.slice(8)}:null}const Mt=new Map,Ka=new Map;async function Ja(t){if(Mt.has(t))return Mt.get(t);const e=ja(t);if(!e)return console.error("[Assets] Invalid asset URL:",t),null;try{const a=await te().getPageBlob(e.path);if(!a||a.size===0)return console.warn("[Assets] Asset not found or empty:",e.path),null;const i=URL.createObjectURL(a);return Mt.set(t,i),Ka.set(t,a),console.log("[Assets] Loaded:",e.path,`(${a.size} bytes, ${a.type||"unknown type"})`),i}catch(n){return console.error("[Assets] Failed to load asset:",t,n),null}}function Za(t){const[e,n]=S(null);return Q(()=>{if(!t){n(null);return}if(!t.startsWith("asset://")){n(t);return}Ja(t).then(n)},[t]),e}function ei({gid:t,onClose:e}){const[n,a]=S(null),[i,s]=S(!0),[o,h]=S(null);Q(()=>{(async()=>{s(!0),h(null);try{const p=await te().query("SELECT gid, doc_id, page_no, title, tags, updated_ts FROM meta_index WHERE gid = ? LIMIT 1",[t]);p.length>0?a(p[0]):h("Page not found")}catch(c){h(String(c)),console.error("[PagePreview] Failed to load page:",c)}finally{s(!1)}})()},[t]);const u=n?`asset://glyphs/page_${String(n.pageNo).padStart(4,"0")}.mgx.png`:void 0,d=Za(u);return i?r("div",{className:"page-preview",children:r("div",{className:"page-preview-loading",children:[r("div",{className:"spinner"}),r("p",{children:"Loading page..."})]})}):o||!n?r("div",{className:"page-preview",children:r("div",{className:"page-preview-error",children:[r("p",{children:["Error: ",o||"Page not found"]}),e&&r("button",{className:"btn-secondary",onClick:e,children:"Close"})]})}):r("div",{className:"page-preview",children:[r("div",{className:"page-preview-header",children:[r("div",{className:"page-preview-title",children:[r("span",{className:"page-number",children:["Page ",n.pageNo]}),r("h3",{children:n.title||"(Untitled)"})]}),e&&r("button",{className:"btn-icon",onClick:e,title:"Close preview",children:""})]}),r("div",{className:"page-preview-content",children:d?r("img",{src:d,alt:`Page ${n.pageNo}`,className:"page-image"}):r("div",{className:"page-preview-placeholder",children:r("p",{children:"No image available for this page"})})}),r("div",{className:"page-preview-metadata",children:r("dl",{children:[r("dt",{children:"GID:"}),r("dd",{children:r("code",{title:n.gid,children:[n.gid.substring(0,16),"..."]})}),n.tags&&r(re,{children:[r("dt",{children:"Tags:"}),r("dd",{children:n.tags})]}),r("dt",{children:"Updated:"}),r("dd",{children:new Date(n.updatedTs).toLocaleString()})]})})]})}function ti({selectedGid:t,onClose:e}){return t?r(ei,{gid:t,onClose:e}):r("div",{className:"page-preview-panel-empty",children:r("p",{children:"Select a search result to preview the page"})})}function ni({config:t,children:e}){return r("div",{className:"layout-landing",children:[r("section",{className:"hero",children:[r("div",{className:"hero-content",children:[t.logo_asset&&r("img",{src:t.logo_asset,alt:"Logo",className:"hero-logo"}),r("h1",{className:"hero-title",children:t.hero_title||t.site_title||"Welcome"}),t.hero_subtitle&&r("p",{className:"hero-subtitle",children:t.hero_subtitle})]}),t.hero_image&&r("div",{className:"hero-background",style:{backgroundImage:`url(${t.hero_image})`}})]}),r("main",{className:"landing-main",children:e})]})}function ri({config:t,navigation:e,currentPage:n,children:a}){const i=e.filter(s=>s.menu==="sidebar");return r("div",{className:"layout-docs",children:[r("aside",{className:"docs-sidebar",children:r("nav",{className:"docs-nav",children:[r("div",{className:"docs-nav-header",children:[t.logo_asset&&r("img",{src:t.logo_asset,alt:"Logo",className:"docs-logo"}),r("h3",{children:t.site_title||"Documentation"})]}),r("ul",{className:"docs-nav-list",children:i.map(s=>r("li",{className:"docs-nav-item",children:r("a",{href:`#${s.to_slug}`,className:(n==null?void 0:n.slug)===s.to_slug?"active":"",children:[s.icon_asset&&r("img",{src:s.icon_asset,alt:"",className:"nav-icon"}),s.label]})},s.to_slug))})]})}),r("main",{className:"docs-main",children:[n&&r("div",{className:"docs-breadcrumbs",children:[r("a",{href:"#/",children:"Home"}),n.category&&r(re,{children:[r("span",{children:" / "}),r("span",{children:n.category})]}),r("span",{children:" / "}),r("span",{children:n.title})]}),r("article",{className:"docs-content",children:[n&&r("h1",{children:n.title}),a]})]})]})}function dr({config:t,children:e}){return r("div",{className:"layout-dashboard",children:[r("header",{className:"dashboard-header",children:r("h1",{children:t.site_title||"Dashboard"})}),r("main",{className:"dashboard-content",children:e})]})}function ur({config:t,title:e,children:n}){return r("div",{className:"layout-simple",children:[r("header",{className:"simple-header",children:[t.logo_asset&&r("img",{src:t.logo_asset,alt:"Logo",className:"simple-logo"}),e&&r("h1",{children:e})]}),r("main",{className:"simple-content",children:n}),r("footer",{className:"simple-footer",children:r("p",{children:"Powered by GlyphCapsule"})})]})}function ai({topBar:t,leftSidebar:e,centerPanel:n,rightSidebar:a,showLeftSidebar:i=!0,showRightSidebar:s=!1}){return r("div",{className:"capsule-layout",children:[r("div",{className:"capsule-topbar",children:t}),r("div",{className:"capsule-content",children:[i&&e&&r("aside",{className:"capsule-sidebar capsule-sidebar-left",children:e}),r("main",{className:"capsule-main",children:n}),s&&a&&r("aside",{className:"capsule-sidebar capsule-sidebar-right",children:a})]})]})}function ii({capsuleName:t,onClose:e,actions:n}){return r("div",{className:"topbar-content",children:[r("div",{className:"topbar-left",children:r("h2",{className:"topbar-title",children:[" ",t]})}),r("div",{className:"topbar-right",children:[n,e&&r("button",{className:"btn-secondary btn-sm",onClick:e,children:"Close Capsule"})]})]})}function si({title:t,children:e,onClear:n,hasActiveFilters:a=!1}){return r("div",{className:"filter-panel",children:[r("div",{className:"filter-panel-header",children:[r("h3",{children:t}),a&&n&&r("button",{className:"btn-link btn-sm",onClick:n,children:"Clear All"})]}),r("div",{className:"filter-panel-content",children:e})]})}function oi({capsuleInfo:t,onClose:e}){var A;const[n,a]=S("search"),[i,s]=S(null),[o,h]=S(!1),u=rr({defaultMode:"fts"}),d=lr({autoLoad:!0}),f=Pa({maxHops:2,limit:50}),c=qa({autoLoadCheckpoints:!0}),p=cr({}),g=Ya();Va({onFocusSearch:()=>{const C=document.querySelector('input[name="query"]');C==null||C.focus(),C==null||C.select()},onToggleLlm:()=>{p.toggle()},onEscape:()=>{document.activeElement instanceof HTMLElement&&document.activeElement.blur()}});const b=C=>{s(C)},T=C=>{f.navigateToNode(C),s(C)},E=C=>{a("graph"),f.loadGraph(C),s(C)},y=()=>{u.clearFilter(),u.lastQuery&&u.search(u.lastQuery)},m=()=>{i&&(c.verifyPage(i),h(!0))},v=async()=>{p.enabled&&u.results&&u.results.length>0&&u.lastQuery&&(p.clearReasoning(),await p.reason(u.lastQuery,u.results,1500))};Q(()=>{p.enabled&&u.results&&u.results.length>0&&u.lastQuery&&(!p.reasoning||p.reasoning.usedSnippets.length===0)&&v()},[p.enabled,u.results,u.lastQuery]);const w=!!(u.entityFilter.entityType||u.entityFilter.entityValue);return r(ai,{topBar:r(ii,{capsuleName:t.fileName,onClose:e,actions:r(re,{children:[r("div",{className:"capsule-stats",children:[r("span",{children:[t.pageCount," pages"]}),r("span",{children:[t.entityCount," entities"]}),r("span",{children:[t.edgeCount," edges"]})]}),r(Qa,{modality:g.modality,envelopeStats:g.envelopeStats,onEnableDynamic:g.enableDynamicMode,onExportEnvelope:async()=>{const C=await g.exportEnvelope();if(C){const O=URL.createObjectURL(C),M=document.createElement("a");M.href=O,M.download=`envelope_${Date.now()}.db`,M.click(),URL.revokeObjectURL(O)}},onClearEnvelope:g.clearEnvelope,onVerifyEnvelope:async()=>{const C=await g.verifyEnvelope();C&&(C.valid?alert(` Envelope integrity verified!

The hash chain is intact.`):alert(` Envelope integrity check failed:

${C.errors.join(`
`)}`))}}),r("button",{className:`btn-secondary btn-sm ${p.enabled?"active":""}`,onClick:p.toggle,disabled:p.loading,title:(A=p.modelInfo)!=null&&A.loaded?"LLM Ready":"Click to load LLM",children:[" ",p.enabled?"LLM On":"LLM Off"]}),r("button",{className:`btn-secondary btn-sm ${o?"active":""}`,onClick:()=>h(!o),children:[o?"":""," Provenance"]})]})}),leftSidebar:r(si,{title:"Entity Filters",onClear:y,hasActiveFilters:w,children:[w&&r("div",{className:"active-filters",children:[r("p",{className:"filter-label",children:"Active Filter:"}),u.entityFilter.entityType&&r("span",{className:"filter-tag",children:["Type: ",u.entityFilter.entityType]}),u.entityFilter.entityValue&&r("span",{className:"filter-tag",children:["Value: ",u.entityFilter.entityValue]})]}),r(wa,{entities:d.entities,types:d.types,selectedType:d.selectedType,totalCount:d.totalCount,onSelectType:d.selectType,getTypeCount:d.getTypeCount,show:!0,maxDisplay:20})]}),centerPanel:r("div",{className:"capsule-center",children:[r("div",{className:"view-mode-tabs",children:[r("button",{className:`tab-btn ${n==="search"?"active":""}`,onClick:()=>a("search"),children:" Search"}),r("button",{className:`tab-btn ${n==="graph"?"active":""}`,onClick:()=>a("graph"),children:" Graph"})]}),n==="search"&&r(re,{children:[r(Ta,{mode:u.mode,results:u.results,lastQuery:u.lastQuery,loading:u.loading,onSearch:u.search,onModeChange:u.changeMode,onResultClick:b,showModeToggle:!0,placeholder:"Search the capsule...",searchHint:'Try: "vector search", "LEANN", "SQLite", or "hybrid retrieval"',searchHistory:u.searchHistory,onClearHistory:u.clearHistory}),p.enabled&&u.results&&u.results.length>0&&r("div",{className:"llm-section",children:[r("div",{className:"llm-temperature-control",children:[r("label",{htmlFor:"temperature-slider",className:"temperature-label",children:["Creativity:",r("input",{id:"temperature-slider",type:"range",min:"0",max:"1",step:"0.1",value:p.temperature,onChange:C=>p.setTemperature(parseFloat(C.currentTarget.value)),className:"temperature-slider"}),r("span",{className:"temperature-value",children:p.temperature.toFixed(1)})]}),r("small",{className:"temperature-hint",children:[p.temperature<.3&&" Very factual",p.temperature>=.3&&p.temperature<.6&&" Mostly factual",p.temperature>=.6&&p.temperature<.8&&" Balanced",p.temperature>=.8&&" Creative"]})]}),p.progress&&r("div",{className:"llm-progress-bar",children:[r("div",{className:"llm-progress-info",children:[r("span",{children:[" ",p.progress.message]}),r("span",{children:[(p.progress.progress*100).toFixed(0),"%"]})]}),r("div",{className:"llm-progress-track",children:r("div",{className:"llm-progress-fill",style:{width:`${p.progress.progress*100}%`}})})]}),p.reasoning&&r(Aa,{reasoning:p.reasoning,searchResults:u.results,loading:p.loading}),p.loading&&!p.reasoning&&!p.progress&&r("div",{className:"reasoning-loading",children:[r("div",{className:"spinner"}),r("p",{children:"LLM is reasoning over search results..."}),p.elapsedTime>0&&r("p",{className:"inference-time",children:["Elapsed: ",p.elapsedTime.toFixed(1),"s",p.elapsedTime>3&&"  Typically takes 2-5s"]})]}),p.error&&r("div",{className:"llm-error-panel",children:[r("strong",{children:" LLM Error:"})," ",p.error,r("button",{className:"btn-secondary btn-sm",onClick:v,disabled:p.loading,style:{marginLeft:"1rem"},children:p.loading?"Retrying...":"Try Again"})]})]}),p.enabled&&(!u.results||u.results.length===0)&&u.lastQuery&&r("div",{className:"llm-no-results",children:r("p",{children:" LLM needs search results to reason. Try searching first!"})})]}),n==="graph"&&r("div",{className:"graph-view-container",children:[!f.graphData&&r("div",{className:"graph-view-empty",children:[r("p",{children:"Select a search result to explore its graph connections"}),r("p",{className:"hint",children:"Or switch to Search tab to find pages"})]}),f.graphData&&r(re,{children:[r(Ga,{nodeCount:f.nodeCount,edgeCount:f.edgeCount,predicateCount:f.predicates.length,seedNode:f.seedGid||void 0}),r($a,{predicates:f.predicates,selectedPredicate:f.predicate,onPredicateChange:f.filterByPredicate,onReset:f.clear}),r(Ha,{nodes:f.graphData.nodes,edges:f.graphData.edges,seedGid:f.seedGid||void 0,onNodeClick:T,loading:f.loading,error:f.error})]})]}),i&&r("div",{className:"page-preview-section",children:[r("div",{className:"page-preview-header-actions",children:[r("h3",{children:"Page Preview"}),r("div",{className:"page-preview-actions",children:[n==="search"&&r("button",{className:"btn-secondary btn-sm",onClick:()=>E(i),children:"Explore Graph"}),r("button",{className:"btn-primary btn-sm",onClick:m,disabled:c.verifying,children:c.verifying?"Verifying...":"Verify Page"})]})]}),r(ti,{selectedGid:i,onClose:()=>s(null)})]})]}),rightSidebar:o&&r(Xa,{checkpoints:c.checkpoints,verificationResult:c.verificationResult,loading:c.loading,verifying:c.verifying,error:c.error,onVerify:m}),showLeftSidebar:!0,showRightSidebar:o})}async function li(t){const n=(await t.query("SELECT name FROM sqlite_master WHERE type='table'")).map(p=>p.name),a=n.includes("_ui_pages"),i=n.includes("_ui_dashboards"),s=n.includes("_ui_navigation"),o=n.includes("_ui_params"),h=n.includes("_meta_manifest"),u=n.includes("sqlar"),d=n.some(p=>p.startsWith("fts_"));let f="1.0";if(h)try{const p=await t.query("SELECT value FROM _meta_manifest WHERE key='gcui'");p.length>0&&(f=p[0].value)}catch(p){console.warn("Failed to read GCUI version:",p)}let c;return a&&i?c="hybrid":a?c="website":i?c="dashboard":c="generic",{version:f,hasWebsite:a,hasDashboards:i,hasNavigation:s,hasParams:o,hasFTS:d,hasAssets:u,mode:c}}async function ci(t){try{const e=await t.query("SELECT key, value FROM _meta_manifest");if(e.length===0)return null;const n={gcui:"1.0",capsule_kind:"sqlar"};return e.forEach(a=>{n[a.key]=a.value}),n}catch(e){return console.warn("Failed to load manifest:",e),null}}async function di(t){try{const e=await t.query("SELECT key, value FROM _ui_config"),n={};return e.forEach(a=>{n[a.key]=a.value}),n}catch(e){return console.warn("Failed to load config:",e),{}}}async function ui(t){try{return(await t.query("SELECT slug, title, content, layout, category, order_index FROM _ui_pages ORDER BY order_index ASC, slug ASC")).map(n=>({slug:n.slug,title:n.title,content:n.content||void 0,layout:n.layout||void 0,category:n.category||void 0,order_index:n.order_index||void 0}))}catch(e){return console.warn("Failed to load pages:",e),[]}}async function hi(t){try{return(await t.query("SELECT menu, label, to_slug, order_index, icon_asset FROM _ui_navigation ORDER BY menu, order_index ASC")).map(n=>({menu:n.menu,label:n.label,to_slug:n.to_slug,order_index:n.order_index||void 0,icon_asset:n.icon_asset||void 0}))}catch(e){return console.warn("Failed to load navigation:",e),[]}}async function pi(t){try{return(await t.query("SELECT name, query, grammar, config FROM _ui_dashboards")).map(n=>({name:n.name,query:n.query,grammar:n.grammar||void 0,config:n.config||void 0}))}catch(e){return console.warn("Failed to load dashboards:",e),[]}}async function mi(t){const e=await li(t),n=await ci(t)||{gcui:e.version,capsule_kind:"sqlar"},a=await di(t),i=e.hasWebsite?await ui(t):[],s=e.hasNavigation?await hi(t):[],o=e.hasDashboards?await pi(t):[];return{manifest:n,capabilities:e,config:a,pages:i,navigation:s,dashboards:o}}function fi({data:t,config:e,width:n=600,height:a=400}){if(!t||t.length===0)return r("div",{className:"chart-empty",style:{width:n,height:a},children:r("p",{children:"No data to display"})});switch(e.mark){case"bar":return r(gi,{data:t,config:e,width:n,height:a});case"line":return r(_i,{data:t,config:e,width:n,height:a});case"point":return r(yi,{data:t,config:e,width:n,height:a});case"area":return r(vi,{data:t,config:e,width:n,height:a});default:return r("div",{className:"chart-unsupported",style:{width:n,height:a},children:[r("p",{children:["Unsupported chart type: ",e.mark]}),r("p",{children:"Showing data as table:"}),r(bi,{data:t})]})}}function gi({data:t,config:e,width:n,height:a}){var d,f;const{encoding:i}=e,s=((d=i.x)==null?void 0:d.field)||Object.keys(t[0])[0],o=((f=i.y)==null?void 0:f.field)||Object.keys(t[0])[1],h=Math.max(...t.map(c=>Number(c[o])||0)),u=Math.max(20,(n-100)/t.length-10);return r("div",{className:"chart chart-bar",style:{width:n,height:a},children:[e.title&&r("h4",{className:"chart-title",children:e.title}),r("div",{className:"chart-container",style:{height:a-60},children:r("div",{className:"chart-bars",style:{display:"flex",alignItems:"flex-end",height:"100%",gap:"8px"},children:t.map((c,p)=>{const g=Number(c[o])||0,b=g/h*(a-100);return r("div",{className:"chart-bar-item",style:{textAlign:"center"},children:[r("div",{className:"bar",style:{width:u,height:b,backgroundColor:"#6366f1",borderRadius:"4px 4px 0 0"},title:`${c[s]}: ${g}`}),r("div",{className:"bar-label",style:{fontSize:"12px",marginTop:"4px",maxWidth:u,overflow:"hidden",textOverflow:"ellipsis"},children:String(c[s]).slice(0,10)})]},p)})})}),r("div",{className:"chart-legend",style:{fontSize:"12px",marginTop:"8px",textAlign:"center"},children:[r("strong",{children:o})," by ",r("strong",{children:s})]})]})}function _i({data:t,config:e,width:n,height:a}){var E,y;const{encoding:i}=e,s=((E=i.x)==null?void 0:E.field)||Object.keys(t[0])[0],o=((y=i.y)==null?void 0:y.field)||Object.keys(t[0])[1],h=t.map(m=>Number(m[o])||0),u=Math.max(...h),d=Math.min(...h),f=u-d||1,c=n-80,p=a-100,g=c/(t.length-1||1),b=t.map((m,v)=>{const w=40+v*g,A=Number(m[o])||0,C=p-(A-d)/f*p+20;return{x:w,y:C,value:A,label:m[s]}}),T=b.map((m,v)=>`${v===0?"M":"L"} ${m.x} ${m.y}`).join(" ");return r("div",{className:"chart chart-line",style:{width:n,height:a},children:[e.title&&r("h4",{className:"chart-title",children:e.title}),r("svg",{width:n,height:a-40,style:{overflow:"visible"},children:[[0,.25,.5,.75,1].map(m=>{const v=p-m*p+20,w=d+m*f;return r("g",{children:[r("line",{x1:40,y1:v,x2:n-40,y2:v,stroke:"#e5e7eb",strokeWidth:1}),r("text",{x:10,y:v+4,fontSize:10,fill:"#666",children:w.toFixed(0)})]},m)}),r("path",{d:T,fill:"none",stroke:"#6366f1",strokeWidth:2}),b.map((m,v)=>r("circle",{cx:m.x,cy:m.y,r:4,fill:"#6366f1",children:r("title",{children:`${m.label}: ${m.value}`})},v)),b.map((m,v)=>r("text",{x:m.x,y:p+40,fontSize:10,fill:"#666",textAnchor:"middle",children:String(m.label).slice(0,8)},v))]}),r("div",{className:"chart-legend",style:{fontSize:"12px",textAlign:"center"},children:[r("strong",{children:o})," over ",r("strong",{children:s})]})]})}function yi({data:t,config:e,width:n,height:a}){var y,m;const{encoding:i}=e,s=((y=i.x)==null?void 0:y.field)||Object.keys(t[0])[0],o=((m=i.y)==null?void 0:m.field)||Object.keys(t[0])[1],h=t.map(v=>Number(v[s])||0),u=t.map(v=>Number(v[o])||0),d=Math.min(...h),f=Math.max(...h),c=Math.min(...u),p=Math.max(...u),g=f-d||1,b=p-c||1,T=n-80,E=a-100;return r("div",{className:"chart chart-scatter",style:{width:n,height:a},children:[e.title&&r("h4",{className:"chart-title",children:e.title}),r("svg",{width:n,height:a-40,children:[[0,.25,.5,.75,1].map(v=>{const w=E-v*E+20;return r("line",{x1:40,y1:w,x2:n-40,y2:w,stroke:"#e5e7eb",strokeWidth:1},v)}),t.map((v,w)=>{const A=Number(v[s])||0,C=Number(v[o])||0,O=40+(A-d)/g*T,M=E-(C-c)/b*E+20;return r("circle",{cx:O,cy:M,r:5,fill:"#6366f1",opacity:.7,children:r("title",{children:`${s}: ${A}, ${o}: ${C}`})},w)})]}),r("div",{className:"chart-legend",style:{fontSize:"12px",textAlign:"center"},children:[r("strong",{children:o})," vs ",r("strong",{children:s})]})]})}function vi({data:t,config:e,width:n,height:a}){var y,m;const{encoding:i}=e,s=((y=i.x)==null?void 0:y.field)||Object.keys(t[0])[0],o=((m=i.y)==null?void 0:m.field)||Object.keys(t[0])[1],h=t.map(v=>Number(v[o])||0),u=Math.max(...h),d=Math.min(...h),f=u-d||1,c=n-80,p=a-100,g=c/(t.length-1||1),T=t.map((v,w)=>{const A=40+w*g,C=Number(v[o])||0,O=p-(C-d)/f*p+20;return{x:A,y:O}}).map((v,w)=>`${w===0?"M":"L"} ${v.x} ${v.y}`).join(" "),E=`${T} L ${n-40} ${p+20} L 40 ${p+20} Z`;return r("div",{className:"chart chart-area",style:{width:n,height:a},children:[e.title&&r("h4",{className:"chart-title",children:e.title}),r("svg",{width:n,height:a-40,children:[r("path",{d:E,fill:"#6366f1",opacity:.3}),r("path",{d:T,fill:"none",stroke:"#6366f1",strokeWidth:2})]}),r("div",{className:"chart-legend",style:{fontSize:"12px",textAlign:"center"},children:[r("strong",{children:o})," over ",r("strong",{children:s})]})]})}function bi({data:t}){if(t.length===0)return null;const e=Object.keys(t[0]);return r("table",{className:"data-table",style:{width:"100%",borderCollapse:"collapse",fontSize:"12px"},children:[r("thead",{children:r("tr",{children:e.map(n=>r("th",{style:{borderBottom:"2px solid #ddd",padding:"8px",textAlign:"left"},children:n},n))})}),r("tbody",{children:t.slice(0,10).map((n,a)=>r("tr",{children:e.map(i=>r("td",{style:{borderBottom:"1px solid #eee",padding:"6px"},children:String(n[i])},i))},a))})]})}function hr({dashboards:t}){return t.length===0?r("div",{className:"dashboard-empty",children:r("p",{children:"No dashboards defined"})}):r("div",{className:"dashboard-grid",children:t.map(e=>r(Ei,{dashboard:e},e.name))})}function Ei({dashboard:t}){const[e,n]=S(null),[a,i]=S(!1),[s,o]=S(null);Q(()=>{h()},[t.query]);const h=async()=>{i(!0),o(null);try{const f=await te().query(t.query);n(f)}catch(d){o(String(d)),console.error(`[Dashboard] Failed to load ${t.name}:`,d)}finally{i(!1)}};if(a)return r("div",{className:"dashboard-panel loading",children:[r("div",{className:"spinner"}),r("p",{children:["Loading ",t.name,"..."]})]});if(s)return r("div",{className:"dashboard-panel error",children:[r("h4",{children:t.name}),r("p",{className:"error-message",children:["Error: ",s]}),r("details",{children:[r("summary",{children:"Query"}),r("pre",{children:t.query})]})]});if(!e||e.length===0)return r("div",{className:"dashboard-panel empty",children:[r("h4",{children:t.name}),r("p",{children:"No data"})]});let u=null;if(t.config)try{u=JSON.parse(t.config)}catch(d){console.error(`[Dashboard] Invalid config for ${t.name}:`,d)}return!u||t.grammar!=="vegalite-lite-v1"?r("div",{className:"dashboard-panel table",children:[r("h4",{children:t.name}),r(Ti,{data:e})]}):r("div",{className:"dashboard-panel chart",children:r(fi,{data:e,config:u,width:600,height:400})})}function Ti({data:t}){const e=Object.keys(t[0]||{});return r("div",{style:{overflowX:"auto"},children:r("table",{className:"dashboard-table",style:{width:"100%",borderCollapse:"collapse",fontSize:"14px"},children:[r("thead",{children:r("tr",{children:e.map(n=>r("th",{style:{borderBottom:"2px solid #ddd",padding:"12px",textAlign:"left",fontWeight:600},children:n},n))})}),r("tbody",{children:t.map((n,a)=>r("tr",{style:{borderBottom:"1px solid #eee"},children:e.map(i=>r("td",{style:{padding:"10px"},children:String(n[i])},i))},a))})]})})}function Ni({content:t}){const e=Si(t),n=Yt.sanitize(e,{ALLOWED_TAGS:["h1","h2","h3","h4","h5","h6","p","br","strong","em","code","pre","a","ul","ol","li"],ALLOWED_ATTR:["href"],ALLOW_DATA_ATTR:!1});return r("div",{className:"markdown-content",dangerouslySetInnerHTML:{__html:n}})}function Si(t){let e=t;return e=e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;"),e=e.replace(/^### (.*$)/gim,"<h3>$1</h3>"),e=e.replace(/^## (.*$)/gim,"<h2>$1</h2>"),e=e.replace(/^# (.*$)/gim,"<h1>$1</h1>"),e=e.replace(/\*\*(.*?)\*\*/g,"<strong>$1</strong>"),e=e.replace(/\*(.*?)\*/g,"<em>$1</em>"),e=e.replace(/`(.*?)`/g,"<code>$1</code>"),e=e.replace(/\[(.*?)\]\((.*?)\)/g,'<a href="$2">$1</a>'),e=e.replace(/```(.*?)\n([\s\S]*?)```/g,"<pre><code>$2</code></pre>"),e=e.replace(/^\- (.*$)/gim,"<li>$1</li>"),e=e.replace(/(<li>.*<\/li>)/s,"<ul>$1</ul>"),e=e.replace(/^\d+\. (.*$)/gim,"<li>$1</li>"),e=e.split(`

`).map(a=>a.startsWith("<h")||a.startsWith("<ul>")||a.startsWith("<ol>")||a.startsWith("<pre>")||a.startsWith("<li>")?a:`<p>${a}</p>`).join(`
`),e=e.replace(/\n/g,"<br>"),e}function wi({context:t}){const[e,n]=S("/");Q(()=>{const i=()=>{const s=window.location.hash.slice(1);n(s||"/")};return window.addEventListener("hashchange",i),i(),()=>window.removeEventListener("hashchange",i)},[]);const a=t.pages.find(i=>i.slug===e)||t.pages[0];return a?r(Ci,{page:a,context:t}):t.dashboards.length>0?r(dr,{config:t.config,children:r(hr,{dashboards:t.dashboards})}):r(ur,{config:t.config,title:"404 Not Found",children:[r("p",{children:["Page not found: ",e]}),r("p",{children:r("a",{href:"#/",children:"Go home"})})]})}function Ci({page:t,context:e}){const n=t.layout||"simple",a=t.content?r(Ni,{content:t.content}):r("p",{children:"No content"});switch(n){case"landing":return r(ni,{config:e.config,children:a});case"docs":return r(ri,{config:e.config,navigation:e.navigation,currentPage:t,children:a});case"dashboard":return r(dr,{config:e.config,children:[a,e.dashboards.length>0&&r(hr,{dashboards:e.dashboards})]});case"simple":default:return r(ur,{config:e.config,title:t.title,children:a})}}const Li={mode:"website",bundledCapsule:"/memglyph-demo.mgx.sqlite",branding:{title:"Memglyph",tagline:"Your knowledge, crystallized",logoUrl:"/logo.svg"},features:{llm:{enabled:!0,autoReason:!1,defaultModel:"qwen3-0.6b",maxTokens:256},search:{defaultMode:"hybrid",enabledModes:["fts","hybrid"],showModeToggle:!1},graph:{enabled:!0,maxHops:2,defaultMaxHops:1},upload:{enabled:!1,acceptedExtensions:[]},gcui:{enabled:!0,fallbackToGeneric:!1},pwa:{enabled:!0,offlineMode:!0}},ui:{showLanding:!0,theme:"documentation"}},Ai={mode:"viewer",bundledCapsule:"/memglyph-demo.mgx.sqlite",branding:{title:"SQLAR Viewer",tagline:"Query your knowledge capsules",logoUrl:"/sqlar-logo.svg"},features:{llm:{enabled:!0,autoReason:!1,defaultModel:"qwen3-0.6b",maxTokens:256},search:{defaultMode:"hybrid",enabledModes:["fts","hybrid","graph"],showModeToggle:!0},graph:{enabled:!0,maxHops:3,defaultMaxHops:2},upload:{enabled:!0,acceptedExtensions:[".sqlite",".sqlar",".db",".mgx.sqlite"]},gcui:{enabled:!0,fallbackToGeneric:!0},pwa:{enabled:!0,offlineMode:!0}},ui:{showLanding:!1,theme:"tool"}};function ki(){return"website"}function Ri(){return ki()==="viewer"?Ai:Li}function Oi(){const t=Ri(),[e,n]=S(null),[a,i]=S(null),[s,o]=S(!1),[h,u]=S(null),[d,f]=S(!1);rr({defaultMode:t.features.search.defaultMode});const c=lr({autoLoad:!1});return cr({}),Q(()=>{e&&(c.loadEntities(),(async()=>{try{const y=te(),m=await mi(y);console.log("[GCUI] Detected capabilities:",m.capabilities),m.capabilities.mode!=="generic"?(i(m),console.log("[GCUI] Rendering in",m.capabilities.mode,"mode")):(console.log("[GCUI] No GCUI tables found, using legacy mode"),i(null))}catch(y){console.warn("[GCUI] Detection failed, using legacy mode:",y),i(null)}})())},[e]),r("div",{className:"app",children:[r("header",{className:"app-header",children:[r("h1",{children:"Glyphcapsule Explorer"}),r("p",{children:"Hybrid Retrieval Demo for MemGlyph"})]}),r("main",{className:"app-main",children:e?a&&t.features.gcui.enabled?r("div",{className:"gcui-mode",children:r(wi,{context:a})}):r(oi,{capsuleInfo:e,onClose:()=>n(null)}):r("div",{className:"welcome",children:[h&&r("div",{className:"error",style:"max-width: 600px; margin: 1rem auto;",children:[r("strong",{children:"Error:"})," ",h]}),r(Da,{onFileSelected:async(E,y)=>{o(!0),u(null);try{const v=await te().openFromFile(E);n(v),console.log("Capsule opened:",v)}catch(m){u(String(m)),console.error("Failed to open file:",m)}finally{o(!1)}},onOpfsFileSelected:async E=>{o(!0),u(null);try{const m=await te().openFromOpfs(E);n(m),console.log("Capsule opened from OPFS:",m)}catch(y){u(String(y)),console.error("Failed to open from OPFS:",y)}finally{o(!1)}},onError:E=>{u(E)}}),r("div",{style:"text-align: center; margin-top: 1.5rem;",children:[r("p",{style:"margin-bottom: 0.5rem; opacity: 0.7;",children:"Or try the demo:"}),r("button",{className:"btn-secondary",onClick:async()=>{o(!0),u(null);try{const y=await te().openDemo();n(y),console.log("Capsule info:",y)}catch(E){u(String(E)),console.error("Failed to open capsule:",E)}finally{o(!1)}},disabled:s,children:s?"Loading Demo...":"Load Demo Capsule"})]})]})}),r("footer",{className:"app-footer",children:r("p",{children:"Built with Preact + SQLite WASM + OPFS"})})]})}kr(r(Oi,{}),document.getElementById("app"));
