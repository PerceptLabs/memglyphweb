var ti=Object.defineProperty;var ni=(t,e,n)=>e in t?ti(t,e,{enumerable:!0,configurable:!0,writable:!0,value:n}):t[e]=n;var A=(t,e,n)=>ni(t,typeof e!="symbol"?e+"":e,n);(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const a of document.querySelectorAll('link[rel="modulepreload"]'))i(a);new MutationObserver(a=>{for(const s of a)if(s.type==="childList")for(const o of s.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&i(o)}).observe(document,{childList:!0,subtree:!0});function n(a){const s={};return a.integrity&&(s.integrity=a.integrity),a.referrerPolicy&&(s.referrerPolicy=a.referrerPolicy),a.crossOrigin==="use-credentials"?s.credentials="include":a.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function i(a){if(a.ep)return;a.ep=!0;const s=n(a);fetch(a.href,s)}})();var Rt,F,yr,xe,zn,_r,vr,Er,mn,rn,an,at={},br=[],ri=/acit|ex(?:s|g|n|p|$)|rph|grid|ows|mnc|ntw|ine[ch]|zoo|^ord|itera/i,Ot=Array.isArray;function Te(t,e){for(var n in e)t[n]=e[n];return t}function gn(t){t&&t.parentNode&&t.parentNode.removeChild(t)}function ii(t,e,n){var i,a,s,o={};for(s in e)s=="key"?i=e[s]:s=="ref"?a=e[s]:o[s]=e[s];if(arguments.length>2&&(o.children=arguments.length>3?Rt.call(arguments,2):n),typeof t=="function"&&t.defaultProps!=null)for(s in t.defaultProps)o[s]===void 0&&(o[s]=t.defaultProps[s]);return bt(t,o,i,a,null)}function bt(t,e,n,i,a){var s={type:t,props:e,key:n,ref:i,__k:null,__:null,__b:0,__e:null,__c:null,constructor:void 0,__v:a??++yr,__i:-1,__u:0};return a==null&&F.vnode!=null&&F.vnode(s),s}function ce(t){return t.children}function tt(t,e){this.props=t,this.context=e}function Be(t,e){if(e==null)return t.__?Be(t.__,t.__i+1):null;for(var n;e<t.__k.length;e++)if((n=t.__k[e])!=null&&n.__e!=null)return n.__e;return typeof t.type=="function"?Be(t):null}function Tr(t){var e,n;if((t=t.__)!=null&&t.__c!=null){for(t.__e=t.__c.base=null,e=0;e<t.__k.length;e++)if((n=t.__k[e])!=null&&n.__e!=null){t.__e=t.__c.base=n.__e;break}return Tr(t)}}function Bn(t){(!t.__d&&(t.__d=!0)&&xe.push(t)&&!St.__r++||zn!=F.debounceRendering)&&((zn=F.debounceRendering)||_r)(St)}function St(){for(var t,e,n,i,a,s,o,l=1;xe.length;)xe.length>l&&xe.sort(vr),t=xe.shift(),l=xe.length,t.__d&&(n=void 0,i=void 0,a=(i=(e=t).__v).__e,s=[],o=[],e.__P&&((n=Te({},i)).__v=i.__v+1,F.vnode&&F.vnode(n),yn(e.__P,n,i,e.__n,e.__P.namespaceURI,32&i.__u?[a]:null,s,a??Be(i),!!(32&i.__u),o),n.__v=i.__v,n.__.__k[n.__i]=n,wr(s,n,o),i.__e=i.__=null,n.__e!=a&&Tr(n)));St.__r=0}function Nr(t,e,n,i,a,s,o,l,u,d,f){var c,p,m,g,b,v,_,y=i&&i.__k||br,T=e.length;for(u=ai(n,e,y,u,T),c=0;c<T;c++)(m=n.__k[c])!=null&&(p=m.__i==-1?at:y[m.__i]||at,m.__i=c,v=yn(t,m,p,a,s,o,l,u,d,f),g=m.__e,m.ref&&p.ref!=m.ref&&(p.ref&&_n(p.ref,null,m),f.push(m.ref,m.__c||g,m)),b==null&&g!=null&&(b=g),(_=!!(4&m.__u))||p.__k===m.__k?u=Sr(m,u,t,_):typeof m.type=="function"&&v!==void 0?u=v:g&&(u=g.nextSibling),m.__u&=-7);return n.__e=b,u}function ai(t,e,n,i,a){var s,o,l,u,d,f=n.length,c=f,p=0;for(t.__k=new Array(a),s=0;s<a;s++)(o=e[s])!=null&&typeof o!="boolean"&&typeof o!="function"?(u=s+p,(o=t.__k[s]=typeof o=="string"||typeof o=="number"||typeof o=="bigint"||o.constructor==String?bt(null,o,null,null,null):Ot(o)?bt(ce,{children:o},null,null,null):o.constructor==null&&o.__b>0?bt(o.type,o.props,o.key,o.ref?o.ref:null,o.__v):o).__=t,o.__b=t.__b+1,l=null,(d=o.__i=si(o,n,u,c))!=-1&&(c--,(l=n[d])&&(l.__u|=2)),l==null||l.__v==null?(d==-1&&(a>f?p--:a<f&&p++),typeof o.type!="function"&&(o.__u|=4)):d!=u&&(d==u-1?p--:d==u+1?p++:(d>u?p--:p++,o.__u|=4))):t.__k[s]=null;if(c)for(s=0;s<f;s++)(l=n[s])!=null&&!(2&l.__u)&&(l.__e==i&&(i=Be(l)),Lr(l,l));return i}function Sr(t,e,n,i){var a,s;if(typeof t.type=="function"){for(a=t.__k,s=0;a&&s<a.length;s++)a[s]&&(a[s].__=t,e=Sr(a[s],e,n,i));return e}t.__e!=e&&(i&&(e&&t.type&&!e.parentNode&&(e=Be(t)),n.insertBefore(t.__e,e||null)),e=t.__e);do e=e&&e.nextSibling;while(e!=null&&e.nodeType==8);return e}function si(t,e,n,i){var a,s,o,l=t.key,u=t.type,d=e[n],f=d!=null&&(2&d.__u)==0;if(d===null&&t.key==null||f&&l==d.key&&u==d.type)return n;if(i>(f?1:0)){for(a=n-1,s=n+1;a>=0||s<e.length;)if((d=e[o=a>=0?a--:s++])!=null&&!(2&d.__u)&&l==d.key&&u==d.type)return o}return-1}function Xn(t,e,n){e[0]=="-"?t.setProperty(e,n??""):t[e]=n==null?"":typeof n!="number"||ri.test(e)?n:n+"px"}function ft(t,e,n,i,a){var s,o;e:if(e=="style")if(typeof n=="string")t.style.cssText=n;else{if(typeof i=="string"&&(t.style.cssText=i=""),i)for(e in i)n&&e in n||Xn(t.style,e,"");if(n)for(e in n)i&&n[e]==i[e]||Xn(t.style,e,n[e])}else if(e[0]=="o"&&e[1]=="n")s=e!=(e=e.replace(Er,"$1")),o=e.toLowerCase(),e=o in t||e=="onFocusOut"||e=="onFocusIn"?o.slice(2):e.slice(2),t.l||(t.l={}),t.l[e+s]=n,n?i?n.u=i.u:(n.u=mn,t.addEventListener(e,s?an:rn,s)):t.removeEventListener(e,s?an:rn,s);else{if(a=="http://www.w3.org/2000/svg")e=e.replace(/xlink(H|:h)/,"h").replace(/sName$/,"s");else if(e!="width"&&e!="height"&&e!="href"&&e!="list"&&e!="form"&&e!="tabIndex"&&e!="download"&&e!="rowSpan"&&e!="colSpan"&&e!="role"&&e!="popover"&&e in t)try{t[e]=n??"";break e}catch{}typeof n=="function"||(n==null||n===!1&&e[4]!="-"?t.removeAttribute(e):t.setAttribute(e,e=="popover"&&n==1?"":n))}}function Vn(t){return function(e){if(this.l){var n=this.l[e.type+t];if(e.t==null)e.t=mn++;else if(e.t<n.u)return;return n(F.event?F.event(e):e)}}}function yn(t,e,n,i,a,s,o,l,u,d){var f,c,p,m,g,b,v,_,y,T,N,L,O,W,q,se,M,I=e.type;if(e.constructor!=null)return null;128&n.__u&&(u=!!(32&n.__u),s=[l=e.__e=n.__e]),(f=F.__b)&&f(e);e:if(typeof I=="function")try{if(_=e.props,y="prototype"in I&&I.prototype.render,T=(f=I.contextType)&&i[f.__c],N=f?T?T.props.value:f.__:i,n.__c?v=(c=e.__c=n.__c).__=c.__E:(y?e.__c=c=new I(_,N):(e.__c=c=new tt(_,N),c.constructor=I,c.render=li),T&&T.sub(c),c.props=_,c.state||(c.state={}),c.context=N,c.__n=i,p=c.__d=!0,c.__h=[],c._sb=[]),y&&c.__s==null&&(c.__s=c.state),y&&I.getDerivedStateFromProps!=null&&(c.__s==c.state&&(c.__s=Te({},c.__s)),Te(c.__s,I.getDerivedStateFromProps(_,c.__s))),m=c.props,g=c.state,c.__v=e,p)y&&I.getDerivedStateFromProps==null&&c.componentWillMount!=null&&c.componentWillMount(),y&&c.componentDidMount!=null&&c.__h.push(c.componentDidMount);else{if(y&&I.getDerivedStateFromProps==null&&_!==m&&c.componentWillReceiveProps!=null&&c.componentWillReceiveProps(_,N),!c.__e&&c.shouldComponentUpdate!=null&&c.shouldComponentUpdate(_,c.__s,N)===!1||e.__v==n.__v){for(e.__v!=n.__v&&(c.props=_,c.state=c.__s,c.__d=!1),e.__e=n.__e,e.__k=n.__k,e.__k.some(function(Z){Z&&(Z.__=e)}),L=0;L<c._sb.length;L++)c.__h.push(c._sb[L]);c._sb=[],c.__h.length&&o.push(c);break e}c.componentWillUpdate!=null&&c.componentWillUpdate(_,c.__s,N),y&&c.componentDidUpdate!=null&&c.__h.push(function(){c.componentDidUpdate(m,g,b)})}if(c.context=N,c.props=_,c.__P=t,c.__e=!1,O=F.__r,W=0,y){for(c.state=c.__s,c.__d=!1,O&&O(e),f=c.render(c.props,c.state,c.context),q=0;q<c._sb.length;q++)c.__h.push(c._sb[q]);c._sb=[]}else do c.__d=!1,O&&O(e),f=c.render(c.props,c.state,c.context),c.state=c.__s;while(c.__d&&++W<25);c.state=c.__s,c.getChildContext!=null&&(i=Te(Te({},i),c.getChildContext())),y&&!p&&c.getSnapshotBeforeUpdate!=null&&(b=c.getSnapshotBeforeUpdate(m,g)),se=f,f!=null&&f.type===ce&&f.key==null&&(se=Cr(f.props.children)),l=Nr(t,Ot(se)?se:[se],e,n,i,a,s,o,l,u,d),c.base=e.__e,e.__u&=-161,c.__h.length&&o.push(c),v&&(c.__E=c.__=null)}catch(Z){if(e.__v=null,u||s!=null)if(Z.then){for(e.__u|=u?160:128;l&&l.nodeType==8&&l.nextSibling;)l=l.nextSibling;s[s.indexOf(l)]=null,e.__e=l}else{for(M=s.length;M--;)gn(s[M]);sn(e)}else e.__e=n.__e,e.__k=n.__k,Z.then||sn(e);F.__e(Z,e,n)}else s==null&&e.__v==n.__v?(e.__k=n.__k,e.__e=n.__e):l=e.__e=oi(n.__e,e,n,i,a,s,o,u,d);return(f=F.diffed)&&f(e),128&e.__u?void 0:l}function sn(t){t&&t.__c&&(t.__c.__e=!0),t&&t.__k&&t.__k.forEach(sn)}function wr(t,e,n){for(var i=0;i<n.length;i++)_n(n[i],n[++i],n[++i]);F.__c&&F.__c(e,t),t.some(function(a){try{t=a.__h,a.__h=[],t.some(function(s){s.call(a)})}catch(s){F.__e(s,a.__v)}})}function Cr(t){return typeof t!="object"||t==null||t.__b&&t.__b>0?t:Ot(t)?t.map(Cr):Te({},t)}function oi(t,e,n,i,a,s,o,l,u){var d,f,c,p,m,g,b,v=n.props,_=e.props,y=e.type;if(y=="svg"?a="http://www.w3.org/2000/svg":y=="math"?a="http://www.w3.org/1998/Math/MathML":a||(a="http://www.w3.org/1999/xhtml"),s!=null){for(d=0;d<s.length;d++)if((m=s[d])&&"setAttribute"in m==!!y&&(y?m.localName==y:m.nodeType==3)){t=m,s[d]=null;break}}if(t==null){if(y==null)return document.createTextNode(_);t=document.createElementNS(a,y,_.is&&_),l&&(F.__m&&F.__m(e,s),l=!1),s=null}if(y==null)v===_||l&&t.data==_||(t.data=_);else{if(s=s&&Rt.call(t.childNodes),v=n.props||at,!l&&s!=null)for(v={},d=0;d<t.attributes.length;d++)v[(m=t.attributes[d]).name]=m.value;for(d in v)if(m=v[d],d!="children"){if(d=="dangerouslySetInnerHTML")c=m;else if(!(d in _)){if(d=="value"&&"defaultValue"in _||d=="checked"&&"defaultChecked"in _)continue;ft(t,d,null,m,a)}}for(d in _)m=_[d],d=="children"?p=m:d=="dangerouslySetInnerHTML"?f=m:d=="value"?g=m:d=="checked"?b=m:l&&typeof m!="function"||v[d]===m||ft(t,d,m,v[d],a);if(f)l||c&&(f.__html==c.__html||f.__html==t.innerHTML)||(t.innerHTML=f.__html),e.__k=[];else if(c&&(t.innerHTML=""),Nr(e.type=="template"?t.content:t,Ot(p)?p:[p],e,n,i,y=="foreignObject"?"http://www.w3.org/1999/xhtml":a,s,o,s?s[0]:n.__k&&Be(n,0),l,u),s!=null)for(d=s.length;d--;)gn(s[d]);l||(d="value",y=="progress"&&g==null?t.removeAttribute("value"):g!=null&&(g!==t[d]||y=="progress"&&!g||y=="option"&&g!=v[d])&&ft(t,d,g,v[d],a),d="checked",b!=null&&b!=t[d]&&ft(t,d,b,v[d],a))}return t}function _n(t,e,n){try{if(typeof t=="function"){var i=typeof t.__u=="function";i&&t.__u(),i&&e==null||(t.__u=t(e))}else t.current=e}catch(a){F.__e(a,n)}}function Lr(t,e,n){var i,a;if(F.unmount&&F.unmount(t),(i=t.ref)&&(i.current&&i.current!=t.__e||_n(i,null,e)),(i=t.__c)!=null){if(i.componentWillUnmount)try{i.componentWillUnmount()}catch(s){F.__e(s,e)}i.base=i.__P=null}if(i=t.__k)for(a=0;a<i.length;a++)i[a]&&Lr(i[a],e,n||typeof t.type!="function");n||gn(t.__e),t.__c=t.__=t.__e=void 0}function li(t,e,n){return this.constructor(t,n)}function ci(t,e,n){var i,a,s,o;e==document&&(e=document.documentElement),F.__&&F.__(t,e),a=(i=!1)?null:e.__k,s=[],o=[],yn(e,t=e.__k=ii(ce,null,[t]),a||at,at,e.namespaceURI,a?null:e.firstChild?Rt.call(e.childNodes):null,s,a?a.__e:e.firstChild,i,o),wr(s,t,o)}Rt=br.slice,F={__e:function(t,e,n,i){for(var a,s,o;e=e.__;)if((a=e.__c)&&!a.__)try{if((s=a.constructor)&&s.getDerivedStateFromError!=null&&(a.setState(s.getDerivedStateFromError(t)),o=a.__d),a.componentDidCatch!=null&&(a.componentDidCatch(t,i||{}),o=a.__d),o)return a.__E=a}catch(l){t=l}throw t}},yr=0,tt.prototype.setState=function(t,e){var n;n=this.__s!=null&&this.__s!=this.state?this.__s:this.__s=Te({},this.state),typeof t=="function"&&(t=t(Te({},n),this.props)),t&&Te(n,t),t!=null&&this.__v&&(e&&this._sb.push(e),Bn(this))},tt.prototype.forceUpdate=function(t){this.__v&&(this.__e=!0,t&&this.__h.push(t),Bn(this))},tt.prototype.render=ce,xe=[],_r=typeof Promise=="function"?Promise.prototype.then.bind(Promise.resolve()):setTimeout,vr=function(t,e){return t.__v.__b-e.__v.__b},St.__r=0,Er=/(PointerCapture)$|Capture$/i,mn=0,rn=Vn(!1),an=Vn(!0);var di=0;function r(t,e,n,i,a,s){e||(e={});var o,l,u=e;if("ref"in u)for(l in u={},e)l=="ref"?o=e[l]:u[l]=e[l];var d={type:t,props:u,key:n,ref:o,__k:null,__:null,__b:0,__e:null,__c:null,constructor:void 0,__v:--di,__i:-1,__u:0,__source:a,__self:s};if(typeof t=="function"&&(o=t.defaultProps))for(l in o)u[l]===void 0&&(u[l]=o[l]);return F.vnode&&F.vnode(d),d}var st,B,Gt,Yn,wt=0,Ar=[],V=F,Qn=V.__b,jn=V.__r,Jn=V.diffed,Kn=V.__c,Zn=V.unmount,er=V.__;function vn(t,e){V.__h&&V.__h(B,t,wt||e),wt=0;var n=B.__H||(B.__H={__:[],__h:[]});return t>=n.__.length&&n.__.push({}),n.__[t]}function S(t){return wt=1,ui(Or,t)}function ui(t,e,n){var i=vn(st++,2);if(i.t=t,!i.__c&&(i.__=[Or(void 0,e),function(l){var u=i.__N?i.__N[0]:i.__[0],d=i.t(u,l);u!==d&&(i.__N=[d,i.__[1]],i.__c.setState({}))}],i.__c=B,!B.__f)){var a=function(l,u,d){if(!i.__c.__H)return!0;var f=i.__c.__H.__.filter(function(p){return!!p.__c});if(f.every(function(p){return!p.__N}))return!s||s.call(this,l,u,d);var c=i.__c.props!==l;return f.forEach(function(p){if(p.__N){var m=p.__[0];p.__=p.__N,p.__N=void 0,m!==p.__[0]&&(c=!0)}}),s&&s.call(this,l,u,d)||c};B.__f=!0;var s=B.shouldComponentUpdate,o=B.componentWillUpdate;B.componentWillUpdate=function(l,u,d){if(this.__e){var f=s;s=void 0,a(l,u,d),s=f}o&&o.call(this,l,u,d)},B.shouldComponentUpdate=a}return i.__N||i.__}function J(t,e){var n=vn(st++,3);!V.__s&&Rr(n.__H,e)&&(n.__=t,n.u=e,B.__H.__h.push(n))}function nt(t){return wt=5,hi(function(){return{current:t}},[])}function hi(t,e){var n=vn(st++,7);return Rr(n.__H,e)&&(n.__=t(),n.__H=e,n.__h=t),n.__}function pi(){for(var t;t=Ar.shift();)if(t.__P&&t.__H)try{t.__H.__h.forEach(Tt),t.__H.__h.forEach(on),t.__H.__h=[]}catch(e){t.__H.__h=[],V.__e(e,t.__v)}}V.__b=function(t){B=null,Qn&&Qn(t)},V.__=function(t,e){t&&e.__k&&e.__k.__m&&(t.__m=e.__k.__m),er&&er(t,e)},V.__r=function(t){jn&&jn(t),st=0;var e=(B=t.__c).__H;e&&(Gt===B?(e.__h=[],B.__h=[],e.__.forEach(function(n){n.__N&&(n.__=n.__N),n.u=n.__N=void 0})):(e.__h.forEach(Tt),e.__h.forEach(on),e.__h=[],st=0)),Gt=B},V.diffed=function(t){Jn&&Jn(t);var e=t.__c;e&&e.__H&&(e.__H.__h.length&&(Ar.push(e)!==1&&Yn===V.requestAnimationFrame||((Yn=V.requestAnimationFrame)||fi)(pi)),e.__H.__.forEach(function(n){n.u&&(n.__H=n.u),n.u=void 0})),Gt=B=null},V.__c=function(t,e){e.some(function(n){try{n.__h.forEach(Tt),n.__h=n.__h.filter(function(i){return!i.__||on(i)})}catch(i){e.some(function(a){a.__h&&(a.__h=[])}),e=[],V.__e(i,n.__v)}}),Kn&&Kn(t,e)},V.unmount=function(t){Zn&&Zn(t);var e,n=t.__c;n&&n.__H&&(n.__H.__.forEach(function(i){try{Tt(i)}catch(a){e=a}}),n.__H=void 0,e&&V.__e(e,n.__v))};var tr=typeof requestAnimationFrame=="function";function fi(t){var e,n=function(){clearTimeout(i),tr&&cancelAnimationFrame(e),setTimeout(t)},i=setTimeout(n,35);tr&&(e=requestAnimationFrame(n))}function Tt(t){var e=B,n=t.__c;typeof n=="function"&&(t.__c=void 0,n()),B=e}function on(t){var e=B;t.__c=t.__(),B=e}function Rr(t,e){return!t||t.length!==e.length||e.some(function(n,i){return n!==t[i]})}function Or(t,e){return typeof e=="function"?e(t):e}const mi={maxQueueSize:50,defaultTimeout:1e4,maxTimeout:3e4};class gi{constructor(e={}){A(this,"queue",[]);A(this,"processing",!1);A(this,"nextId",1);A(this,"config");A(this,"stats",{totalProcessed:0,totalTimeouts:0,totalErrors:0});this.config={...mi,...e}}async enqueue(e,n){if(this.queue.length>=this.config.maxQueueSize)throw new Error(`Query queue full (${this.config.maxQueueSize} items). Too many pending queries.`);const i=Math.min(n||this.config.defaultTimeout,this.config.maxTimeout);return new Promise((a,s)=>{const o={id:this.nextId++,execute:e,resolve:a,reject:s,timeout:i,enqueuedAt:Date.now()};this.queue.push(o),this.processing||this.processQueue()})}async processQueue(){if(!(this.processing||this.queue.length===0)){for(this.processing=!0;this.queue.length>0;){const e=this.queue.shift();try{await this.executeWithTimeout(e)}catch{}}this.processing=!1}}async executeWithTimeout(e){const n=new Promise((i,a)=>{setTimeout(()=>{a(new Error(`Query ${e.id} timed out after ${e.timeout}ms`))},e.timeout)});try{const i=await Promise.race([e.execute(),n]);this.stats.totalProcessed++,e.resolve(i)}catch(i){i instanceof Error&&i.message.includes("timed out")?(this.stats.totalTimeouts++,console.warn(`[QueryQueue] Query ${e.id} timed out`,{timeout:e.timeout,waitTime:Date.now()-e.enqueuedAt})):this.stats.totalErrors++,e.reject(i)}}getStats(){return{queueLength:this.queue.length,busy:this.processing,totalProcessed:this.stats.totalProcessed,totalTimeouts:this.stats.totalTimeouts,totalErrors:this.stats.totalErrors}}isBusy(){return this.processing||this.queue.length>0}clear(){const e=new Error("Query queue cleared");for(const n of this.queue)n.reject(e);this.queue=[]}get length(){return this.queue.length}}let Wt=null;function ln(t){return Wt||(Wt=new gi(t)),Wt}function yi(t,e){return ln().enqueue(t,e)}class kr{constructor(){A(this,"worker",null);A(this,"nextId",1);A(this,"pending",new Map);this.initWorker()}initWorker(){this.worker=new Worker(new URL("/assets/sqlite.worker-CxyBnLSe.js",import.meta.url),{type:"module"}),this.worker.onmessage=e=>{const n=e.data;if("type"in n&&n.type==="READY"){console.log("[DbClient] Worker ready");return}const{id:i,response:a}=n,s=this.pending.get(i);s&&(this.pending.delete(i),s.resolve(a))},this.worker.onerror=e=>{console.error("[DbClient] Worker error:",e);for(const n of this.pending.values())n.reject(new Error("Worker error"));this.pending.clear()}}async sendRequest(e,n=1e4){if(!this.worker)throw new Error("Worker not initialized");const i=this.nextId++;return yi(async()=>new Promise((a,s)=>{const o=setTimeout(()=>{this.pending.delete(i),s(new Error(`Request ${e.type} timed out after ${n}ms`))},n);this.pending.set(i,{resolve:u=>{clearTimeout(o),u.ok?a(u.data):s(new Error(u.error))},reject:u=>{clearTimeout(o),s(u)},timeout:o});const l={id:i,request:e};this.worker.postMessage(l)}),n)}async openFromFile(e){return this.sendRequest({type:"OPEN_FROM_FILE",file:e})}async openFromOpfs(e){return this.sendRequest({type:"OPEN_FROM_OPFS",path:e})}async openDemo(){return this.sendRequest({type:"OPEN_DEMO"})}async saveToOpfs(e){return this.sendRequest({type:"SAVE_TO_OPFS",path:e})}async removeFromOpfs(e){return this.sendRequest({type:"REMOVE_FROM_OPFS",path:e})}async listOpfsFiles(){return this.sendRequest({type:"LIST_OPFS_FILES"})}async close(){return this.sendRequest({type:"CLOSE"})}async searchFts(e,n=20,i,a){return this.sendRequest({type:"FTS_SEARCH",query:e,limit:n,entityType:i,entityValue:a})}async searchHybrid(e,n=20,i){return this.sendRequest({type:"HYBRID_SEARCH",query:e,limit:n,weights:i})}async listEntities(e,n=100){return this.sendRequest({type:"LIST_ENTITIES",entityType:e,limit:n})}async getPageList(e=100,n=0){return this.sendRequest({type:"GET_PAGE_LIST",limit:e,offset:n})}async getPageBlob(e){return this.sendRequest({type:"GET_PAGE_BLOB",name:e})}async verifyPage(e){return this.sendRequest({type:"VERIFY_PAGE",gid:e})}async getCheckpoints(){return this.sendRequest({type:"GET_CHECKPOINTS"})}async graphHops(e,n,i,a){return this.sendRequest({type:"GRAPH_HOPS",seedGid:e,predicate:n,maxHops:i,limit:a})}async query(e,n=[]){return this.sendRequest({type:"QUERY",sql:e,params:n})}async exportDatabase(){return this.sendRequest({type:"EXPORT_DATABASE"})}async hasEnvelopeTables(e){return this.sendRequest({type:"HAS_ENVELOPE_TABLES",fileBytes:e})}async extractEnvelope(e){return this.sendRequest({type:"EXTRACT_ENVELOPE",file:e})}async mergeWithEnvelope(e){return this.sendRequest({type:"MERGE_ENVELOPE",file:e})}getQueueStats(){return ln().getStats()}isQueueBusy(){return ln().isBusy()}terminate(){this.worker&&(this.worker.terminate(),this.worker=null);for(const e of this.pending.values())clearTimeout(e.timeout),e.reject(new Error("Worker terminated"));this.pending.clear()}}let zt=null;function de(){return zt||(zt=new kr),zt}class _i{constructor(){A(this,"bus",new EventTarget);A(this,"topics",new Set);A(this,"eventLog",[]);A(this,"maxLogSize",100)}publish(e,n){this.topics.add(e);const i={topic:e,data:n,timestamp:Date.now()};this.bus.dispatchEvent(new CustomEvent(e,{detail:i}))}subscribe(e,n){const i=a=>{const s=a;n(s.detail.data,s.detail)};return this.bus.addEventListener(e,i),()=>{this.bus.removeEventListener(e,i)}}subscribeMany(e,n){const i=e.map(a=>this.subscribe(a,(s,o)=>n(a,s,o)));return()=>{i.forEach(a=>a())}}getActiveTopics(){return Array.from(this.topics)}getRecentEvents(e){return[]}clearEventLog(){this.eventLog=[]}getStats(){const e={};return{activeTopics:this.topics.size,eventLogSize:this.eventLog.length,topicCounts:e}}}const ue=new _i,vi=t=>ue.publish("retrieval.query",t),Ei=t=>ue.publish("retrieval.result",t),bi=t=>ue.publish("llm.prompt",t),Ti=t=>ue.publish("llm.output",t),Ni=t=>ue.publish("llm.citation",t),Si=t=>ue.publish("feedback.signal",t),nr=t=>ue.publish("capsule.loaded",t),wi=()=>ue.publish("capsule.unloaded",{}),Ci=`-- GlyphCase Envelope Schema v1.1
-- Append-only episodic memory layer for Dynamic GlyphCases
-- This schema represents the mutable, hash-chained memory buffer
-- that sits alongside the immutable Core.

-- ============================================================================
-- METADATA
-- ============================================================================

-- Envelope metadata and configuration
CREATE TABLE IF NOT EXISTS _envelope_meta (
  key TEXT PRIMARY KEY,
  value TEXT NOT NULL
) STRICT;

-- Core metadata values:
-- 'gcase_id' - SHA256 hash of the Core capsule this envelope is linked to
-- 'created_at' - ISO8601 timestamp of envelope creation
-- 'format_version' - Envelope schema version (1.1)
-- 'last_hash' - Most recent hash in the chain

-- ============================================================================
-- HASH CHAIN (Merkle Integrity)
-- ============================================================================

-- Hash chain for append-only integrity verification
-- Each block represents a batch of appends with a Merkle root
CREATE TABLE IF NOT EXISTS _env_chain (
  seq INTEGER PRIMARY KEY AUTOINCREMENT,
  block_hash TEXT NOT NULL UNIQUE,
  parent_hash TEXT NOT NULL,
  block_type TEXT NOT NULL, -- 'retrieval' | 'embedding' | 'feedback' | 'summary' | 'log'
  row_count INTEGER NOT NULL DEFAULT 1,
  created_at TEXT NOT NULL DEFAULT (datetime('now'))
) STRICT;

CREATE INDEX IF NOT EXISTS idx_chain_block_type ON _env_chain(block_type);
CREATE INDEX IF NOT EXISTS idx_chain_created_at ON _env_chain(created_at);

-- ============================================================================
-- RETRIEVAL LOGS
-- ============================================================================

-- Logs every search/retrieval operation performed
-- Enables learning from query patterns and improving relevance
CREATE TABLE IF NOT EXISTS env_retrieval_log (
  id TEXT PRIMARY KEY,
  seq INTEGER NOT NULL REFERENCES _env_chain(seq),
  ts TEXT NOT NULL DEFAULT (datetime('now')),
  query_text TEXT NOT NULL,
  query_type TEXT NOT NULL CHECK(query_type IN ('fts', 'vector', 'hybrid', 'graph')),
  top_docs TEXT, -- JSON array of {gid, score, snippet}
  hit_count INTEGER NOT NULL DEFAULT 0,
  parent_hash TEXT NOT NULL
) STRICT;

CREATE INDEX IF NOT EXISTS idx_retrieval_ts ON env_retrieval_log(ts);
CREATE INDEX IF NOT EXISTS idx_retrieval_type ON env_retrieval_log(query_type);
CREATE INDEX IF NOT EXISTS idx_retrieval_query ON env_retrieval_log(query_text);

-- ============================================================================
-- CONTEXTUAL EMBEDDINGS
-- ============================================================================

-- Runtime-generated embeddings for queries, responses, and context
-- Provides adaptive semantic memory beyond the canonical Core vectors
CREATE TABLE IF NOT EXISTS env_embeddings (
  id TEXT PRIMARY KEY,
  seq INTEGER NOT NULL REFERENCES _env_chain(seq),
  source TEXT NOT NULL, -- 'user_query' | 'llm_response' | 'context_window' | 'feedback_cluster'
  vector BLOB NOT NULL,
  metadata TEXT, -- JSON metadata about this embedding
  created_at TEXT NOT NULL DEFAULT (datetime('now')),
  parent_hash TEXT NOT NULL
) STRICT;

CREATE INDEX IF NOT EXISTS idx_embeddings_source ON env_embeddings(source);
CREATE INDEX IF NOT EXISTS idx_embeddings_created ON env_embeddings(created_at);

-- ============================================================================
-- USER FEEDBACK
-- ============================================================================

-- User ratings and feedback on retrievals and responses
-- Enables learning from human signals and improving relevance over time
CREATE TABLE IF NOT EXISTS env_feedback (
  id TEXT PRIMARY KEY,
  seq INTEGER NOT NULL REFERENCES _env_chain(seq),
  retrieval_id TEXT REFERENCES env_retrieval_log(id),
  rating INTEGER NOT NULL CHECK(rating IN (-1, 0, 1)), -- -1 (bad) | 0 (neutral) | 1 (good)
  notes TEXT,
  created_at TEXT NOT NULL DEFAULT (datetime('now')),
  parent_hash TEXT NOT NULL
) STRICT;

CREATE INDEX IF NOT EXISTS idx_feedback_rating ON env_feedback(rating);
CREATE INDEX IF NOT EXISTS idx_feedback_retrieval ON env_feedback(retrieval_id);
CREATE INDEX IF NOT EXISTS idx_feedback_created ON env_feedback(created_at);

-- ============================================================================
-- CONTEXT SUMMARIES
-- ============================================================================

-- LLM-generated context summaries and insights
-- Captures high-level understanding and reasoning patterns
CREATE TABLE IF NOT EXISTS env_context_summaries (
  id TEXT PRIMARY KEY,
  seq INTEGER NOT NULL REFERENCES _env_chain(seq),
  summary TEXT NOT NULL,
  relevance REAL NOT NULL CHECK(relevance >= 0.0 AND relevance <= 1.0),
  source_retrievals TEXT, -- JSON array of retrieval_log IDs
  created_at TEXT NOT NULL DEFAULT (datetime('now')),
  parent_hash TEXT NOT NULL
) STRICT;

CREATE INDEX IF NOT EXISTS idx_summaries_relevance ON env_context_summaries(relevance);
CREATE INDEX IF NOT EXISTS idx_summaries_created ON env_context_summaries(created_at);

-- ============================================================================
-- OBSERVABILITY LOGS
-- ============================================================================

-- System and application logs for debugging, analytics, and audit trails
-- Captures errors, warnings, performance issues, and system events
CREATE TABLE IF NOT EXISTS env_logs (
  id TEXT PRIMARY KEY,
  seq INTEGER NOT NULL REFERENCES _env_chain(seq),
  level TEXT NOT NULL CHECK(level IN ('debug', 'info', 'warn', 'error', 'fatal')),
  logger TEXT NOT NULL, -- Hierarchical logger name: 'search.fts', 'llm.inference'
  message TEXT NOT NULL,
  context TEXT, -- JSON with structured metadata
  created_at TEXT NOT NULL DEFAULT (datetime('now')),
  parent_hash TEXT NOT NULL
) STRICT;

CREATE INDEX IF NOT EXISTS idx_env_logs_level ON env_logs(level);
CREATE INDEX IF NOT EXISTS idx_env_logs_logger ON env_logs(logger);
CREATE INDEX IF NOT EXISTS idx_env_logs_created ON env_logs(created_at);
CREATE INDEX IF NOT EXISTS idx_env_logs_seq ON env_logs(seq);

-- ============================================================================
-- VIEWS
-- ============================================================================

-- Recent activity view (last 100 events)
CREATE VIEW IF NOT EXISTS v_recent_activity AS
SELECT
  'retrieval' as event_type,
  id,
  ts as timestamp,
  query_text as description,
  hit_count as value
FROM env_retrieval_log
UNION ALL
SELECT
  'feedback' as event_type,
  id,
  created_at as timestamp,
  notes as description,
  rating as value
FROM env_feedback
UNION ALL
SELECT
  'summary' as event_type,
  id,
  created_at as timestamp,
  substr(summary, 1, 100) as description,
  relevance as value
FROM env_context_summaries
UNION ALL
SELECT
  'log' as event_type,
  id,
  created_at as timestamp,
  '[' || level || '] ' || logger || ': ' || message as description,
  NULL as value
FROM env_logs
WHERE level IN ('warn', 'error', 'fatal')
ORDER BY timestamp DESC
LIMIT 100;

-- Envelope statistics view
CREATE VIEW IF NOT EXISTS v_envelope_stats AS
SELECT
  (SELECT COUNT(*) FROM env_retrieval_log) as retrieval_count,
  (SELECT COUNT(*) FROM env_embeddings) as embedding_count,
  (SELECT COUNT(*) FROM env_feedback) as feedback_count,
  (SELECT COUNT(*) FROM env_context_summaries) as summary_count,
  (SELECT COUNT(*) FROM env_logs) as log_count,
  (SELECT COUNT(*) FROM _env_chain) as chain_length,
  (SELECT MIN(ts) FROM env_retrieval_log) as first_activity,
  (SELECT MAX(ts) FROM env_retrieval_log) as last_activity;

-- Search analytics view
CREATE VIEW IF NOT EXISTS v_search_analytics AS
SELECT
  COUNT(*) as total_queries,
  COUNT(CASE WHEN hit_count = 0 THEN 1 END) as zero_result_queries,
  COUNT(CASE WHEN hit_count > 0 THEN 1 END) as successful_queries,
  ROUND(COUNT(CASE WHEN hit_count = 0 THEN 1 END) * 100.0 / COUNT(*), 2) as zero_result_rate,
  AVG(hit_count) as avg_hit_count,
  COUNT(DISTINCT query_text) as unique_queries,
  query_type,
  date(ts) as query_date
FROM env_retrieval_log
GROUP BY query_type, query_date
ORDER BY query_date DESC;

-- Zero-result queries view (for improving search)
CREATE VIEW IF NOT EXISTS v_zero_result_queries AS
SELECT
  query_text,
  query_type,
  ts,
  COUNT(*) as attempt_count
FROM env_retrieval_log
WHERE hit_count = 0
GROUP BY query_text, query_type
ORDER BY attempt_count DESC, ts DESC;
`,ve={QUERY_TEXT:10*1024,TOP_DOCS_JSON:100*1024,FEEDBACK_NOTES:50*1024,SUMMARY_TEXT:100*1024,EMBEDDING_DIMS:1e4,METADATA_JSON:50*1024,LOG_MESSAGE:10*1024,LOG_CONTEXT:50*1024};function Oe(t,e){const n=new TextEncoder,i=new TextDecoder;let a=n.encode(t);if(a.length<=e)return t;const s=a.slice(0,e-3);return i.decode(s)+"..."}async function Qe(t){const e=JSON.stringify({table:t.table,id:t.rowId,data:cn(t.data),parent:t.parentHash,ts:t.timestamp}),i=new TextEncoder().encode(e),a=await crypto.subtle.digest("SHA-256",i);return Array.from(new Uint8Array(a)).map(o=>o.toString(16).padStart(2,"0")).join("")}function cn(t){if(t instanceof Float32Array)return{__type:"Float32Array",values:Array.from(t)};if(Array.isArray(t))return t.map(cn);if(t&&typeof t=="object"){const e={};for(const[n,i]of Object.entries(t))e[n]=cn(i);return e}return t}class mt{constructor(e,n){A(this,"lastHash");A(this,"db");A(this,"genesis","0".repeat(64));this.db=e,this.lastHash=n||this.genesis}getCurrentHash(){return this.lastHash}async appendRetrieval(e){const n=Oe(e.query_text,ve.QUERY_TEXT),i=e.top_docs?JSON.stringify(e.top_docs):null,a=i?Oe(i,ve.TOP_DOCS_JSON):null,s=new Date().toISOString(),o=await Qe({table:"retrieval_log",rowId:e.id,data:{...e,query_text:n},parentHash:this.lastHash,timestamp:s}),l=this.db.prepare(`
      INSERT INTO env_retrieval_log
      (id, query_text, query_type, top_docs, hit_count, parent_hash, ts)
      VALUES (?, ?, ?, ?, ?, ?, ?)
    `);try{l.bind([e.id,n,e.query_type,a,e.hit_count,this.lastHash,s]),l.step()}finally{l.finalize()}return await this.recordChainBlock(o,"retrieval",1),this.lastHash=o,o}async appendEmbedding(e){if(e.vector.length>ve.EMBEDDING_DIMS)throw new Error(`Embedding vector too large: ${e.vector.length} dimensions (limit: ${ve.EMBEDDING_DIMS})`);const n=e.metadata?JSON.stringify(e.metadata):null,i=n?Oe(n,ve.METADATA_JSON):null,a=new Date().toISOString(),s=await Qe({table:"embeddings",rowId:e.id,data:e,parentHash:this.lastHash,timestamp:a}),o=new Uint8Array(e.vector.buffer),l=this.db.prepare(`
      INSERT INTO env_embeddings
      (id, source, vector, metadata, parent_hash, created_at)
      VALUES (?, ?, ?, ?, ?, ?)
    `);try{l.bind([e.id,e.source,o,i,this.lastHash,a]),l.step()}finally{l.finalize()}return await this.recordChainBlock(s,"embedding",1),this.lastHash=s,s}async appendFeedback(e){const n=e.notes?Oe(e.notes,ve.FEEDBACK_NOTES):null,i=new Date().toISOString(),a=await Qe({table:"feedback",rowId:e.id,data:{...e,notes:n||void 0},parentHash:this.lastHash,timestamp:i}),s=this.db.prepare(`
      INSERT INTO env_feedback
      (id, retrieval_id, rating, notes, parent_hash, created_at)
      VALUES (?, ?, ?, ?, ?, ?)
    `);try{s.bind([e.id,e.retrieval_id||null,e.rating,n,this.lastHash,i]),s.step()}finally{s.finalize()}return await this.recordChainBlock(a,"feedback",1),this.lastHash=a,a}async appendSummary(e){const n=Oe(e.summary,ve.SUMMARY_TEXT),i=new Date().toISOString(),a=await Qe({table:"summaries",rowId:e.id,data:{...e,summary:n},parentHash:this.lastHash,timestamp:i}),s=this.db.prepare(`
      INSERT INTO env_context_summaries
      (id, summary, relevance, source_retrievals, parent_hash, created_at)
      VALUES (?, ?, ?, ?, ?, ?)
    `);try{s.bind([e.id,n,e.relevance,e.source_retrievals?JSON.stringify(e.source_retrievals):null,this.lastHash,i]),s.step()}finally{s.finalize()}return await this.recordChainBlock(a,"summary",1),this.lastHash=a,a}async appendLog(e){const n=Oe(e.message,ve.LOG_MESSAGE),i=e.context?JSON.stringify(e.context):null,a=i?Oe(i,ve.LOG_CONTEXT):null,s=new Date().toISOString(),o=await Qe({table:"logs",rowId:e.id,data:{...e,message:n},parentHash:this.lastHash,timestamp:s}),l=this.db.prepare(`
      INSERT INTO env_logs
      (id, level, logger, message, context, parent_hash, created_at)
      VALUES (?, ?, ?, ?, ?, ?, ?)
    `);try{l.bind([e.id,e.level,e.logger,n,a,this.lastHash,s]),l.step()}finally{l.finalize()}return await this.recordChainBlock(o,"log",1),this.lastHash=o,o}async recordChainBlock(e,n,i){const a=this.db.prepare(`
      INSERT INTO _env_chain (block_hash, parent_hash, block_type, row_count)
      VALUES (?, ?, ?, ?)
    `);try{a.bind([e,this.lastHash,n,i]),a.step();const o=this.db.prepare("SELECT last_insert_rowid()");try{o.step();const l=o.get([])[0],u=n==="retrieval"?"retrieval_log":n==="embedding"?"embeddings":n==="feedback"?"feedback":n==="summary"?"context_summaries":"logs",d=this.db.prepare(`
          UPDATE env_${u}
          SET seq = ?
          WHERE parent_hash = ?
        `);try{d.bind([l,this.lastHash]),d.step()}finally{d.finalize()}}finally{o.finalize()}}finally{a.finalize()}const s=this.db.prepare(`
      INSERT OR REPLACE INTO _envelope_meta (key, value) VALUES ('last_hash', ?)
    `);try{s.bind([e]),s.step()}finally{s.finalize()}}async verifyChain(){const e=[],n=this.db.prepare(`
      SELECT seq, block_hash, parent_hash, block_type
      FROM _env_chain
      ORDER BY seq ASC
    `),i=[];try{for(;n.step();){const a=n.get([]);i.push({seq:a[0],block_hash:a[1],parent_hash:a[2],block_type:a[3],row_count:0,created_at:""})}}finally{n.finalize()}for(let a=1;a<i.length;a++){const s=i[a],o=i[a-1];s.parent_hash!==o.block_hash&&e.push(`Chain break at seq ${s.seq}: parent_hash ${s.parent_hash} does not match previous block_hash ${o.block_hash}`)}return{valid:e.length===0,errors:e}}getChainStats(){const e=this.db.prepare(`
      SELECT block_type, COUNT(*) as count
      FROM _env_chain
      GROUP BY block_type
    `),n={};try{for(;e.step();){const s=e.get([]);n[s[0]]=s[1]}}finally{e.finalize()}const i=this.db.prepare("SELECT COUNT(*) FROM _env_chain");let a=0;try{i.step(),a=i.get([])[0]}finally{i.finalize()}return{length:a,currentHash:this.lastHash,types:n}}}function kt(t="env"){const e=Date.now().toString(36),n=Math.random().toString(36).substring(2,9);return`${t}_${e}_${n}`}async function gt(t){const e=await t.arrayBuffer(),n=await crypto.subtle.digest("SHA-256",e);return Array.from(new Uint8Array(n)).map(a=>a.toString(16).padStart(2,"0")).join("")}class Ct{constructor(){A(this,"db",null);A(this,"writer",null);A(this,"gcaseId",null);A(this,"opfsPath",null);A(this,"sqlite3",null)}static async exists(e){try{const n=await gt(e),i=`/envelopes/${n}.db`;return await(await(await navigator.storage.getDirectory()).getDirectoryHandle("envelopes",{create:!1})).getFileHandle(`${n}.db`,{create:!1}),!0}catch{return!1}}static hasEnvelopeTables(e,n){const i=new e.oo1.DB(":memory:");try{if(e.capi.sqlite3_deserialize(i.pointer,"main",n,n.byteLength,n.byteLength,e.capi.SQLITE_DESERIALIZE_FREEONCLOSE|e.capi.SQLITE_DESERIALIZE_RESIZEABLE)!==0)return!1;const s=i.prepare(`
        SELECT COUNT(*) FROM sqlite_master
        WHERE type='table' AND name='_envelope_meta'
      `);try{if(s.step())return s.get([])[0]>0}finally{s.finalize()}return!1}catch(a){return console.warn("[Envelope] Error checking for envelope tables:",a),!1}finally{i.close()}}async extractFromCanonical(e,n,i){this.sqlite3=n,this.gcaseId=await gt(e),this.opfsPath=`/envelopes/${this.gcaseId}.db`,console.log("[Envelope] Extracting envelope from canonical .gcase+ file..."),await(await navigator.storage.getDirectory()).getDirectoryHandle("envelopes",{create:!0}),this.db=new n.oo1.OpfsDb(this.opfsPath,"c");const s=new n.oo1.DB(":memory:");try{const u=n.capi.sqlite3_deserialize(s.pointer,"main",i,i.byteLength,i.byteLength,n.capi.SQLITE_DESERIALIZE_FREEONCLOSE|n.capi.SQLITE_DESERIALIZE_RESIZEABLE);if(u!==0)throw new Error(`Failed to deserialize source database: ${u}`);s.exec(`ATTACH DATABASE '${this.opfsPath}' AS sidecar`);const d=["_envelope_meta","_env_chain","env_retrieval_log","env_embeddings","env_feedback","env_context_summaries"];for(const p of d){const m=s.prepare(`
          SELECT sql FROM main.sqlite_master
          WHERE type='table' AND name=?
        `);try{if(m.bind([p]),m.step()){const g=m.get([])[0];if(g){const b=g.replace(/CREATE TABLE/,"CREATE TABLE sidecar.");s.exec(b),console.log(`[Envelope] Created sidecar table: ${p}`),s.exec(`INSERT INTO sidecar.${p} SELECT * FROM main.${p}`);const v=s.prepare(`SELECT COUNT(*) FROM sidecar.${p}`);try{v.step();const _=v.get([])[0];console.log(`[Envelope] Copied ${_} rows to ${p}`)}finally{v.finalize()}}}}finally{m.finalize()}}const f=["v_recent_activity","v_envelope_stats","v_search_analytics","v_zero_result_queries"];for(const p of f){const m=s.prepare(`
          SELECT sql FROM main.sqlite_master
          WHERE type='view' AND name=?
        `);try{if(m.bind([p]),m.step()){const g=m.get([])[0];if(g){const b=g.replace(/CREATE VIEW/,"CREATE VIEW sidecar.");s.exec(b),console.log(`[Envelope] Created view: ${p}`)}}}finally{m.finalize()}}const c=s.prepare(`
        SELECT sql FROM main.sqlite_master
        WHERE type='index' AND sql IS NOT NULL AND name LIKE 'idx_%'
      `);try{for(;c.step();){const p=c.get([])[0];if(p&&(p.includes("env_")||p.includes("_env_")))try{const m=p.replace(/ON\s+(\w+)/,"ON sidecar.$1");s.exec(m)}catch(m){console.warn("[Envelope] Index copy failed:",m)}}}finally{c.finalize()}s.exec("DETACH DATABASE sidecar"),console.log("[Envelope] Extraction complete")}finally{s.close()}const o=this.db.prepare(`
      SELECT value FROM _envelope_meta WHERE key = 'last_hash'
    `);let l="0".repeat(64);try{o.step()&&(l=o.get([])[0])}finally{o.finalize()}this.writer=new mt(this.db,l),console.log(`[Envelope] Extracted envelope for ${this.gcaseId}`)}async create(e,n){this.sqlite3=n,this.gcaseId=await gt(e),this.opfsPath=`/envelopes/${this.gcaseId}.db`,await(await navigator.storage.getDirectory()).getDirectoryHandle("envelopes",{create:!0}),this.db=new n.oo1.OpfsDb(this.opfsPath,"c"),this.db.exec(Ci);const a=new Date().toISOString(),s="0".repeat(64),o=this.db.prepare(`
      INSERT INTO _envelope_meta (key, value) VALUES
      ('gcase_id', ?),
      ('created_at', ?),
      ('format_version', '1.1'),
      ('last_hash', ?)
    `);try{o.bind([this.gcaseId,a,s]),o.step()}finally{o.finalize()}this.writer=new mt(this.db,s),console.log(`[Envelope] Created new envelope for ${this.gcaseId}`)}async load(e,n){this.sqlite3=n,this.gcaseId=await gt(e),this.opfsPath=`/envelopes/${this.gcaseId}.db`,this.db=new n.oo1.OpfsDb(this.opfsPath,"w");const i=this.db.prepare(`
      SELECT value FROM _envelope_meta WHERE key = 'last_hash'
    `);let a="0".repeat(64);try{i.step()&&(a=i.get([])[0])}finally{i.finalize()}this.writer=new mt(this.db,a),console.log(`[Envelope] Loaded existing envelope for ${this.gcaseId}`)}async open(e,n){await Ct.exists(e)?await this.load(e,n):await this.create(e,n)}close(){this.db&&(this.db.close(),this.db=null,this.writer=null,this.gcaseId=null,console.log("[Envelope] Closed envelope database"))}getWriter(){return this.writer}getStats(){if(!this.db)return null;const e=this.db.prepare("SELECT * FROM v_envelope_stats");try{if(e.step()){const n=e.get([]);return{retrievalCount:n[0]||0,embeddingCount:n[1]||0,feedbackCount:n[2]||0,summaryCount:n[3]||0,chainLength:n[4]||0,firstActivity:n[5]||null,lastActivity:n[6]||null}}}finally{e.finalize()}return null}getMeta(){if(!this.db)return null;const e=this.db.prepare("SELECT key, value FROM _envelope_meta"),n={};try{for(;e.step();){const i=e.get([]);n[i[0]]=i[1]}}finally{e.finalize()}return{gcaseId:n.gcase_id||"",createdAt:n.created_at||"",formatVersion:n.format_version||"1.1",lastHash:n.last_hash||""}}async clear(){if(!this.db)return;this.db.exec(`
      DELETE FROM env_retrieval_log;
      DELETE FROM env_embeddings;
      DELETE FROM env_feedback;
      DELETE FROM env_context_summaries;
      DELETE FROM _env_chain;
    `);const e="0".repeat(64),n=this.db.prepare(`
      UPDATE _envelope_meta SET value = ? WHERE key = 'last_hash'
    `);try{n.bind([e]),n.step()}finally{n.finalize()}this.writer=new mt(this.db,e),console.log("[Envelope] Cleared all envelope data")}async exportSidecar(){if(!this.db||!this.opfsPath)throw new Error("No envelope sidecar open");return await(await(await(await navigator.storage.getDirectory()).getDirectoryHandle("envelopes")).getFileHandle(`${this.gcaseId}.db`)).getFile()}getRecentActivity(e=20){if(!this.db)return[];const n=this.db.prepare(`
      SELECT event_type, id, timestamp, description, value
      FROM v_recent_activity
      LIMIT ?
    `),i=[];try{for(n.bind([e]);n.step();){const a=n.get([]);i.push({eventType:a[0],id:a[1],timestamp:a[2],description:a[3],value:a[4]})}}finally{n.finalize()}return i}async verify(){return this.writer?this.writer.verifyChain():{valid:!1,errors:["No envelope writer available"]}}getDatabase(){return this.db}isOpen(){return this.db!==null}getOpfsPath(){return this.opfsPath}getGCaseId(){return this.gcaseId}async mergeWithCore(e){if(!this.db||!this.opfsPath||!this.sqlite3)throw new Error("No envelope sidecar open or sqlite3 not available");console.log(`[Envelope] Merging Core (${e.byteLength} bytes) with Envelope sidecar...`);const n=new this.sqlite3.oo1.DB(":memory:");try{const i=this.sqlite3.capi.sqlite3_deserialize(n.pointer,"main",e,e.byteLength,e.byteLength,this.sqlite3.capi.SQLITE_DESERIALIZE_FREEONCLOSE|this.sqlite3.capi.SQLITE_DESERIALIZE_RESIZEABLE);if(i!==0)throw new Error(`Failed to deserialize Core database: ${i}`);console.log("[Envelope] Core database loaded into memory"),n.exec(`ATTACH DATABASE '${this.opfsPath}' AS envelope`),console.log("[Envelope] Attached sidecar database");const a=["_envelope_meta","_env_chain","env_retrieval_log","env_embeddings","env_feedback","env_context_summaries"];for(const u of a){const d=n.prepare(`
          SELECT sql FROM envelope.sqlite_master
          WHERE type='table' AND name=?
        `);try{if(d.bind([u]),d.step()){const f=d.get([])[0];if(f){n.exec(f),console.log(`[Envelope] Created table: ${u}`),n.exec(`INSERT INTO main.${u} SELECT * FROM envelope.${u}`);const c=n.prepare(`SELECT COUNT(*) FROM main.${u}`);try{c.step();const p=c.get([])[0];console.log(`[Envelope] Copied ${p} rows to ${u}`)}finally{c.finalize()}}}}finally{d.finalize()}}const s=["v_recent_activity","v_envelope_stats","v_search_analytics","v_zero_result_queries"];for(const u of s){const d=n.prepare(`
          SELECT sql FROM envelope.sqlite_master
          WHERE type='view' AND name=?
        `);try{if(d.bind([u]),d.step()){const f=d.get([])[0];f&&(n.exec(f),console.log(`[Envelope] Created view: ${u}`))}}finally{d.finalize()}}const o=n.prepare(`
        SELECT sql FROM envelope.sqlite_master
        WHERE type='index' AND sql IS NOT NULL
      `);try{for(;o.step();){const u=o.get([])[0];if(u)try{n.exec(u)}catch(d){console.warn("[Envelope] Index already exists or failed:",d)}}}finally{o.finalize()}n.exec("DETACH DATABASE envelope"),console.log("[Envelope] Detached sidecar");const l=this.sqlite3.capi.sqlite3_js_db_export(n.pointer);if(!l)throw new Error("Failed to export merged database");return console.log(`[Envelope] Merged database exported: ${l.byteLength} bytes`),new Blob([l],{type:"application/x-sqlite3"})}finally{n.close()}}}function Li(t){return typeof t=="function"?t:Ai(t)}function Ai(t){if(t==null)return()=>!1;if(t==="fatal")return e=>e.level==="fatal";if(t==="error")return e=>e.level==="fatal"||e.level==="error";if(t==="warning")return e=>e.level==="fatal"||e.level==="error"||e.level==="warning";if(t==="info")return e=>e.level==="fatal"||e.level==="error"||e.level==="warning"||e.level==="info";if(t==="debug")return e=>e.level==="fatal"||e.level==="error"||e.level==="warning"||e.level==="info"||e.level==="debug";if(t==="trace")return()=>!0;throw new TypeError(`Invalid log level: ${t}.`)}const rr=["trace","debug","info","warning","error","fatal"];function ir(t,e){const n=rr.indexOf(t);if(n<0)throw new TypeError(`Invalid log level: ${JSON.stringify(t)}.`);const i=rr.indexOf(e);if(i<0)throw new TypeError(`Invalid log level: ${JSON.stringify(e)}.`);return n-i}function En(t=[]){return ze.getLogger(t)}const Bt=Symbol.for("logtape.rootLogger");var ze=class Se{constructor(e,n){A(this,"parent");A(this,"children");A(this,"category");A(this,"sinks");A(this,"parentSinks","inherit");A(this,"filters");A(this,"lowestLevel","trace");A(this,"contextLocalStorage");this.parent=e,this.children={},this.category=n,this.sinks=[],this.filters=[]}static getLogger(e=[]){let n=Bt in globalThis?globalThis[Bt]??null:null;return n==null&&(n=new Se(null,[]),globalThis[Bt]=n),typeof e=="string"?n.getChild(e):e.length===0?n:n.getChild(e)}getChild(e){const n=typeof e=="string"?e:e[0],i=this.children[n];let a=i instanceof Se?i:i==null?void 0:i.deref();return a==null&&(a=new Se(this,[...this.category,n]),this.children[n]="WeakRef"in globalThis?new WeakRef(a):a),typeof e=="string"||e.length===1?a:a.getChild(e.slice(1))}reset(){for(;this.sinks.length>0;)this.sinks.shift();for(this.parentSinks="inherit";this.filters.length>0;)this.filters.shift();this.lowestLevel="trace"}resetDescendants(){for(const e of Object.values(this.children)){const n=e instanceof Se?e:e.deref();n!=null&&n.resetDescendants()}this.reset()}with(e){return new Ri(this,{...e})}filter(e){var n;for(const i of this.filters)if(!i(e))return!1;return this.filters.length<1?((n=this.parent)==null?void 0:n.filter(e))??!0:!0}*getSinks(e){if(!(this.lowestLevel===null||ir(e,this.lowestLevel)<0)){if(this.parent!=null&&this.parentSinks==="inherit")for(const n of this.parent.getSinks(e))yield n;for(const n of this.sinks)yield n}}emit(e,n){const i="category"in e?e:{...e,category:this.category};if(!(this.lowestLevel===null||ir(i.level,this.lowestLevel)<0||!this.filter(i))){for(const a of this.getSinks(i.level))if(!(n!=null&&n.has(a)))try{a(i)}catch(s){const o=new Set(n);o.add(a),Oi.log("fatal","Failed to emit a log record to sink {sink}: {error}",{sink:a,error:s,record:i},o)}}}log(e,n,i,a){var u;const s=((u=Se.getLogger().contextLocalStorage)==null?void 0:u.getStore())??{};let o;const l=typeof i=="function"?{category:this.category,level:e,timestamp:Date.now(),get message(){return ar(n,this.properties)},rawMessage:n,get properties(){return o==null&&(o={...s,...i()}),o}}:{category:this.category,level:e,timestamp:Date.now(),message:ar(n,{...s,...i}),rawMessage:n,properties:{...s,...i}};this.emit(l,a)}logLazily(e,n,i={}){var u;const a=((u=Se.getLogger().contextLocalStorage)==null?void 0:u.getStore())??{};let s,o;function l(){if((o==null||s==null)&&(o=n((d,...f)=>(s=d,sr(d,f))),s==null))throw new TypeError("No log record was made.");return[o,s]}this.emit({category:this.category,level:e,get message(){return l()[0]},get rawMessage(){return l()[1]},timestamp:Date.now(),properties:{...a,...i}})}logTemplate(e,n,i,a={}){var o;const s=((o=Se.getLogger().contextLocalStorage)==null?void 0:o.getStore())??{};this.emit({category:this.category,level:e,message:sr(n,i),rawMessage:n,timestamp:Date.now(),properties:{...s,...a}})}trace(e,...n){typeof e=="string"?this.log("trace",e,n[0]??{}):typeof e=="function"?this.logLazily("trace",e):Array.isArray(e)?this.logTemplate("trace",e,n):this.log("trace","{*}",e)}debug(e,...n){typeof e=="string"?this.log("debug",e,n[0]??{}):typeof e=="function"?this.logLazily("debug",e):Array.isArray(e)?this.logTemplate("debug",e,n):this.log("debug","{*}",e)}info(e,...n){typeof e=="string"?this.log("info",e,n[0]??{}):typeof e=="function"?this.logLazily("info",e):Array.isArray(e)?this.logTemplate("info",e,n):this.log("info","{*}",e)}warn(e,...n){typeof e=="string"?this.log("warning",e,n[0]??{}):typeof e=="function"?this.logLazily("warning",e):Array.isArray(e)?this.logTemplate("warning",e,n):this.log("warning","{*}",e)}warning(e,...n){this.warn(e,...n)}error(e,...n){typeof e=="string"?this.log("error",e,n[0]??{}):typeof e=="function"?this.logLazily("error",e):Array.isArray(e)?this.logTemplate("error",e,n):this.log("error","{*}",e)}fatal(e,...n){typeof e=="string"?this.log("fatal",e,n[0]??{}):typeof e=="function"?this.logLazily("fatal",e):Array.isArray(e)?this.logTemplate("fatal",e,n):this.log("fatal","{*}",e)}},Ri=class xr{constructor(e,n){A(this,"logger");A(this,"properties");this.logger=e,this.properties=n}get category(){return this.logger.category}get parent(){return this.logger.parent}getChild(e){return this.logger.getChild(e).with(this.properties)}with(e){return new xr(this.logger,{...this.properties,...e})}log(e,n,i,a){this.logger.log(e,n,typeof i=="function"?()=>({...this.properties,...i()}):{...this.properties,...i},a)}logLazily(e,n){this.logger.logLazily(e,n,this.properties)}logTemplate(e,n,i){this.logger.logTemplate(e,n,i,this.properties)}emit(e){const n={...e,properties:{...this.properties,...e.properties}};this.logger.emit(n)}trace(e,...n){typeof e=="string"?this.log("trace",e,n[0]??{}):typeof e=="function"?this.logLazily("trace",e):Array.isArray(e)?this.logTemplate("trace",e,n):this.log("trace","{*}",e)}debug(e,...n){typeof e=="string"?this.log("debug",e,n[0]??{}):typeof e=="function"?this.logLazily("debug",e):Array.isArray(e)?this.logTemplate("debug",e,n):this.log("debug","{*}",e)}info(e,...n){typeof e=="string"?this.log("info",e,n[0]??{}):typeof e=="function"?this.logLazily("info",e):Array.isArray(e)?this.logTemplate("info",e,n):this.log("info","{*}",e)}warn(e,...n){typeof e=="string"?this.log("warning",e,n[0]??{}):typeof e=="function"?this.logLazily("warning",e):Array.isArray(e)?this.logTemplate("warning",e,n):this.log("warning","{*}",e)}warning(e,...n){this.warn(e,...n)}error(e,...n){typeof e=="string"?this.log("error",e,n[0]??{}):typeof e=="function"?this.logLazily("error",e):Array.isArray(e)?this.logTemplate("error",e,n):this.log("error","{*}",e)}fatal(e,...n){typeof e=="string"?this.log("fatal",e,n[0]??{}):typeof e=="function"?this.logLazily("fatal",e):Array.isArray(e)?this.logTemplate("fatal",e,n):this.log("fatal","{*}",e)}};const Oi=ze.getLogger(["logtape","meta"]);function ki(t){return t.includes(".")||t.includes("[")||t.includes("?.")}function xi(t,e){if(!(e==="__proto__"||e==="prototype"||e==="constructor")&&(typeof t=="object"||typeof t=="function")&&t!==null)return Object.prototype.hasOwnProperty.call(t,e)?t[e]:void 0}function Ii(t,e){const n=t.length;let i=e;if(i>=n)return null;let a;if(t[i]==="["){if(i++,i>=n)return null;if(t[i]==='"'||t[i]==="'"){const s=t[i];i++;let o="";for(;i<n&&t[i]!==s;)if(t[i]==="\\"){if(i++,i<n){const l=t[i];switch(l){case"n":o+=`
`;break;case"t":o+="	";break;case"r":o+="\r";break;case"b":o+="\b";break;case"f":o+="\f";break;case"v":o+="\v";break;case"0":o+="\0";break;case"\\":o+="\\";break;case'"':o+='"';break;case"'":o+="'";break;case"u":if(i+4<n){const u=t.slice(i+1,i+5),d=Number.parseInt(u,16);Number.isNaN(d)?o+=l:(o+=String.fromCharCode(d),i+=4)}else o+=l;break;default:o+=l}i++}}else o+=t[i],i++;if(i>=n)return null;a=o,i++}else{const s=i;for(;i<n&&t[i]!=="]"&&t[i]!=="'"&&t[i]!=='"';)i++;if(i>=n)return null;const o=t.slice(s,i);if(o.length===0)return null;const l=Number(o);a=Number.isNaN(l)?o:l}for(;i<n&&t[i]!=="]";)i++;i<n&&i++}else{const s=i;for(;i<n&&t[i]!=="."&&t[i]!=="["&&t[i]!=="?"&&t[i]!=="]";)i++;if(a=t.slice(s,i),a.length===0)return null}return i<n&&t[i]==="."&&i++,{segment:a,nextIndex:i}}function Mi(t,e){if(typeof e=="string")return xi(t,e);if(Array.isArray(t)&&e>=0&&e<t.length)return t[e]}function Di(t,e){if(t==null||e.length===0||e.endsWith("."))return;let n=t,i=0;const a=e.length;for(;i<a;){if(e.slice(i,i+2)==="?."){if(i+=2,n==null)return}else if(n==null)return;const o=Ii(e,i);if(o===null)return;const{segment:l,nextIndex:u}=o;if(i=u,n=Mi(n,l),n===void 0)return}return n}function ar(t,e){const n=t.length;if(n===0)return[""];if(!t.includes("{"))return[t];const i=[];let a=0;for(let o=0;o<n;o++){const l=t[o];if(l==="{"){if((o+1<n?t[o+1]:"")==="{"){o++;continue}const d=t.indexOf("}",o+1);if(d===-1)continue;const f=t.slice(a,o);i.push(f.replace(/{{/g,"{").replace(/}}/g,"}"));const c=t.slice(o+1,d);let p;const m=c.trim();m==="*"?p=c in e?e[c]:"*"in e?e["*"]:e:(c!==m?p=c in e?e[c]:e[m]:p=e[c],p===void 0&&ki(m)&&(p=Di(e,m))),i.push(p),o=d,a=o+1}else l==="}"&&o+1<n&&t[o+1]==="}"&&o++}const s=t.slice(a);return i.push(s.replace(/{{/g,"{").replace(/}}/g,"}")),i}function sr(t,e){const n=[];for(let i=0;i<t.length;i++)n.push(t[i]),i<e.length&&n.push(e[i]);return n}function dn(t,e){const n=(e==null?void 0:e.compact)===!0?void 0:2;return JSON.stringify(t,null,n)}const Fi=Object.freeze(Object.defineProperty({__proto__:null,inspect:dn},Symbol.toStringTag,{value:"Module"})),Ir={trace:"TRC",debug:"DBG",info:"INF",warning:"WRN",error:"ERR",fatal:"FTL"},or=typeof document<"u"||typeof navigator<"u"&&navigator.product==="ReactNative"?t=>JSON.stringify(t):"Deno"in globalThis&&"inspect"in globalThis.Deno&&typeof globalThis.Deno.inspect=="function"?(t,e)=>globalThis.Deno.inspect(t,{strAbbreviateSize:1/0,iterableLimit:1/0,...e}):Fi!=null&&typeof dn=="function"?(t,e)=>dn(t,{...e}):t=>JSON.stringify(t);function $(t){return t<10?`0${t}`:`${t}`}function qe(t){return t<10?`00${t}`:t<100?`0${t}`:`${t}`}const yt={"date-time-timezone":t=>{const e=new Date(t),n=e.getUTCFullYear(),i=$(e.getUTCMonth()+1),a=$(e.getUTCDate()),s=$(e.getUTCHours()),o=$(e.getUTCMinutes()),l=$(e.getUTCSeconds()),u=qe(e.getUTCMilliseconds());return`${n}-${i}-${a} ${s}:${o}:${l}.${u} +00:00`},"date-time-tz":t=>{const e=new Date(t),n=e.getUTCFullYear(),i=$(e.getUTCMonth()+1),a=$(e.getUTCDate()),s=$(e.getUTCHours()),o=$(e.getUTCMinutes()),l=$(e.getUTCSeconds()),u=qe(e.getUTCMilliseconds());return`${n}-${i}-${a} ${s}:${o}:${l}.${u} +00`},"date-time":t=>{const e=new Date(t),n=e.getUTCFullYear(),i=$(e.getUTCMonth()+1),a=$(e.getUTCDate()),s=$(e.getUTCHours()),o=$(e.getUTCMinutes()),l=$(e.getUTCSeconds()),u=qe(e.getUTCMilliseconds());return`${n}-${i}-${a} ${s}:${o}:${l}.${u}`},"time-timezone":t=>{const e=new Date(t),n=$(e.getUTCHours()),i=$(e.getUTCMinutes()),a=$(e.getUTCSeconds()),s=qe(e.getUTCMilliseconds());return`${n}:${i}:${a}.${s} +00:00`},"time-tz":t=>{const e=new Date(t),n=$(e.getUTCHours()),i=$(e.getUTCMinutes()),a=$(e.getUTCSeconds()),s=qe(e.getUTCMilliseconds());return`${n}:${i}:${a}.${s} +00`},time:t=>{const e=new Date(t),n=$(e.getUTCHours()),i=$(e.getUTCMinutes()),a=$(e.getUTCSeconds()),s=qe(e.getUTCMilliseconds());return`${n}:${i}:${a}.${s}`},date:t=>{const e=new Date(t),n=e.getUTCFullYear(),i=$(e.getUTCMonth()+1),a=$(e.getUTCDate());return`${n}-${i}-${a}`},rfc3339:t=>new Date(t).toISOString(),none:()=>null},Ge={ABBR:Ir,abbr:{trace:"trc",debug:"dbg",info:"inf",warning:"wrn",error:"err",fatal:"ftl"},FULL:{trace:"TRACE",debug:"DEBUG",info:"INFO",warning:"WARNING",error:"ERROR",fatal:"FATAL"},full:{trace:"trace",debug:"debug",info:"info",warning:"warning",error:"error",fatal:"fatal"},L:{trace:"T",debug:"D",info:"I",warning:"W",error:"E",fatal:"F"},l:{trace:"t",debug:"d",info:"i",warning:"w",error:"e",fatal:"f"}};function Mr(t={}){const e=(()=>{const o=t.timestamp;return o==null?yt["date-time-timezone"]:o==="disabled"?yt.none:typeof o=="string"&&o in yt?yt[o]:o})(),n=t.category??"",i=t.value?o=>t.value(o,or):or,a=(()=>{const o=t.level;return o==null||o==="ABBR"?l=>Ge.ABBR[l]:o==="abbr"?l=>Ge.abbr[l]:o==="FULL"?l=>Ge.FULL[l]:o==="full"?l=>Ge.full[l]:o==="L"?l=>Ge.L[l]:o==="l"?l=>Ge.l[l]:o})(),s=t.format??(({timestamp:o,level:l,category:u,message:d})=>`${o?`${o} `:""}[${l}] ${u}: ${d}`);return o=>{const l=o.message,u=l.length;let d;if(u===1)d=l[0];else if(u<=6){d="";for(let g=0;g<u;g++)d+=g%2===0?l[g]:i(l[g])}else{const g=new Array(u);for(let b=0;b<u;b++)g[b]=b%2===0?l[b]:i(l[b]);d=g.join("")}const f=e(o.timestamp),c=a(o.level),p=typeof n=="function"?n(o.category):o.category.join(n);return`${s({timestamp:f,level:c,category:p,message:d,record:o})}
`}}Mr();const Xt="\x1B[0m",Vt={black:"\x1B[30m",red:"\x1B[31m",green:"\x1B[32m",yellow:"\x1B[33m",blue:"\x1B[34m",magenta:"\x1B[35m",cyan:"\x1B[36m",white:"\x1B[37m"},Yt={bold:"\x1B[1m",dim:"\x1B[2m",italic:"\x1B[3m",underline:"\x1B[4m",strikethrough:"\x1B[9m"},Pi={trace:null,debug:"blue",info:"green",warning:"yellow",error:"red",fatal:"magenta"};function $i(t={}){const e=t.format,n=typeof t.timestampStyle>"u"?"dim":t.timestampStyle,i=t.timestampColor??null,a=`${n==null?"":Yt[n]}${i==null?"":Vt[i]}`,s=n==null&&i==null?"":Xt,o=typeof t.levelStyle>"u"?"bold":t.levelStyle,l=t.levelColors??Pi,u=typeof t.categoryStyle>"u"?"dim":t.categoryStyle,d=t.categoryColor??null,f=`${u==null?"":Yt[u]}${d==null?"":Vt[d]}`,c=u==null&&d==null?"":Xt;return Mr({timestamp:"date-time-tz",value(p,m){return m(p,{colors:!0})},...t,format({timestamp:p,level:m,category:g,message:b,record:v}){const _=l[v.level];return p=`${a}${p}${s}`,m=`${o==null?"":Yt[o]}${_==null?"":Vt[_]}${m}${o==null&&_==null?"":Xt}`,e==null?`${p} ${m} ${f}${g}:${c} ${b}`:e({timestamp:p,level:m,category:`${f}${g}${c}`,message:b,record:v})}})}$i();function Ui(t={}){if(!t.categorySeparator&&!t.message&&!t.properties)return o=>{if(o.message.length===3)return JSON.stringify({"@timestamp":new Date(o.timestamp).toISOString(),level:o.level==="warning"?"WARN":o.level.toUpperCase(),message:o.message[0]+JSON.stringify(o.message[1])+o.message[2],logger:o.category.join("."),properties:o.properties})+`
`;if(o.message.length===1)return JSON.stringify({"@timestamp":new Date(o.timestamp).toISOString(),level:o.level==="warning"?"WARN":o.level.toUpperCase(),message:o.message[0],logger:o.category.join("."),properties:o.properties})+`
`;let l=o.message[0];for(let u=1;u<o.message.length;u++)l+=u&1?JSON.stringify(o.message[u]):o.message[u];return JSON.stringify({"@timestamp":new Date(o.timestamp).toISOString(),level:o.level==="warning"?"WARN":o.level.toUpperCase(),message:l,logger:o.category.join("."),properties:o.properties})+`
`};const e=t.message==="template",n=t.properties??"nest:properties";let i;if(typeof t.categorySeparator=="function")i=t.categorySeparator;else{const o=t.categorySeparator??".";i=l=>l.join(o)}let a;if(n==="flatten")a=o=>o;else if(n.startsWith("prepend:")){const o=n.substring(8);if(o==="")throw new TypeError(`Invalid properties option: ${JSON.stringify(n)}. It must be of the form "prepend:<prefix>" where <prefix> is a non-empty string.`);a=l=>{const u={};for(const d in l)u[`${o}${d}`]=l[d];return u}}else if(n.startsWith("nest:")){const o=n.substring(5);a=l=>({[o]:l})}else throw new TypeError(`Invalid properties option: ${JSON.stringify(n)}. It must be "flatten", "prepend:<prefix>", or "nest:<key>".`);let s;return e?s=o=>{if(typeof o.rawMessage=="string")return o.rawMessage;let l="";for(let u=0;u<o.rawMessage.length;u++)l+=u%2<1?o.rawMessage[u]:"{}";return l}:s=o=>{const l=o.message.length;if(l===1)return o.message[0];let u="";for(let d=0;d<l;d++)u+=d%2<1?o.message[d]:JSON.stringify(o.message[d]);return u},o=>JSON.stringify({"@timestamp":new Date(o.timestamp).toISOString(),level:o.level==="warning"?"WARN":o.level.toUpperCase(),message:s(o),logger:i(o.category),...a(o.properties)})+`
`}Ui();const Hi={trace:"background-color: gray; color: white;",debug:"background-color: gray; color: white;",info:"background-color: white; color: black;",warning:"background-color: orange; color: black;",error:"background-color: red; color: white;",fatal:"background-color: maroon; color: white;"};function qi(t){let e="";const n=[];for(let s=0;s<t.message.length;s++)s%2===0?e+=t.message[s]:(e+="%o",n.push(t.message[s]));const i=new Date(t.timestamp);return[`%c${`${i.getUTCHours().toString().padStart(2,"0")}:${i.getUTCMinutes().toString().padStart(2,"0")}:${i.getUTCSeconds().toString().padStart(2,"0")}.${i.getUTCMilliseconds().toString().padStart(3,"0")}`} %c${Ir[t.level]}%c %c${t.category.join("")} %c${e}`,"color: gray;",Hi[t.level],"background-color: default;","color: gray;","color: default;",...n]}function Dr(t={}){const e=t.formatter??qi,n={trace:"debug",debug:"debug",info:"info",warning:"warn",error:"error",fatal:"error",...t.levelMap??{}},i=t.console??globalThis.console,a=_=>{const y=e(_),T=n[_.level];if(T===void 0)throw new TypeError(`Invalid log level: ${_.level}.`);if(typeof y=="string"){const N=y.replace(/\r?\n$/,"");i[T](N)}else i[T](...y)};if(!t.nonBlocking)return a;const s=t.nonBlocking===!0?{}:t.nonBlocking,o=s.bufferSize??100,l=s.flushInterval??100,u=[];let d=null,f=!1,c=!1;const p=o*2;function m(){if(u.length===0)return;const _=u.splice(0);for(const y of _)try{a(y)}catch{}}function g(){c||(c=!0,setTimeout(()=>{c=!1,m()},0))}function b(){d!==null||f||(d=setInterval(()=>{m()},l))}const v=_=>{f||(u.length>=p&&u.shift(),u.push(_),u.length>=o?g():d===null&&b())};return v[Symbol.dispose]=()=>{f=!0,d!==null&&(clearInterval(d),d=null),m()},v}let bn=null;const Fr=new Set,Lt=new Set,At=new Set;function Gi(t){return t.category.length===0||t.category.length===1&&t.category[0]==="logtape"||t.category.length===2&&t.category[0]==="logtape"&&t.category[1]==="meta"}async function Wi(t){if(bn!=null&&!t.reset)throw new rt("Already configured; if you want to reset, turn on the reset flag.");await lr();try{zi(t,!0)}catch(e){throw e instanceof rt&&await lr(),e}}function zi(t,e){var s;bn=t;let n=!1;const i=new Set;for(const o of t.loggers){Gi(o)&&(n=!0);const l=Array.isArray(o.category)?JSON.stringify(o.category):JSON.stringify([o.category]);if(i.has(l))throw new rt(`Duplicate logger configuration for category: ${l}. Each category can only be configured once.`);i.add(l);const u=ze.getLogger(o.category);for(const d of o.sinks??[]){const f=t.sinks[d];if(!f)throw new rt(`Sink not found: ${d}.`);u.sinks.push(f)}u.parentSinks=o.parentSinks??"inherit",o.lowestLevel!==void 0&&(u.lowestLevel=o.lowestLevel);for(const d of o.filters??[]){const f=(s=t.filters)==null?void 0:s[d];if(f===void 0)throw new rt(`Filter not found: ${d}.`);u.filters.push(Li(f))}Fr.add(u)}ze.getLogger().contextLocalStorage=t.contextLocalStorage;for(const o of Object.values(t.sinks))Symbol.asyncDispose in o&&At.add(o),Symbol.dispose in o&&Lt.add(o);for(const o of Object.values(t.filters??{}))o==null||typeof o=="string"||(Symbol.asyncDispose in o&&At.add(o),Symbol.dispose in o&&Lt.add(o));if(typeof globalThis.EdgeRuntime!="string"&&"process"in globalThis&&!("Deno"in globalThis)){const o=globalThis.process,l=o==null?void 0:o.on;typeof l=="function"&&l.call(o,"exit",un)}else addEventListener("unload",un);const a=ze.getLogger(["logtape","meta"]);n||a.sinks.push(Dr()),a.info("LogTape loggers are configured.  Note that LogTape itself uses the meta logger, which has category {metaLoggerCategory}.  The meta logger purposes to log internal errors such as sink exceptions.  If you are seeing this message, the meta logger is automatically configured.  It's recommended to configure the meta logger with a separate sink so that you can easily notice if logging itself fails or is misconfigured.  To turn off this message, configure the meta logger with higher log levels than {dismissLevel}.  See also <https://logtape.org/manual/categories#meta-logger>.",{metaLoggerCategory:["logtape","meta"],dismissLevel:"info"})}async function lr(){await un(),Bi()}function Bi(){const t=ze.getLogger([]);t.resetDescendants(),delete t.contextLocalStorage,Fr.clear(),bn=null}async function un(){Xi();const t=[];for(const e of At)t.push(e[Symbol.asyncDispose]()),At.delete(e);await Promise.all(t)}function Xi(){for(const t of Lt)t[Symbol.dispose]();Lt.clear()}var rt=class extends Error{constructor(t){super(t),this.name="ConfigureError"}};const j=En(["glyphcase"]);class Vi{constructor(){A(this,"dbClient");A(this,"envelopeManager");A(this,"currentModality","static");A(this,"currentFile",null);A(this,"currentInfo",null);this.dbClient=new kr,this.envelopeManager=new Ct}getModalityPreference(){return localStorage.getItem("glyphcase.modality")||"auto"}setModalityPreference(e){localStorage.setItem("glyphcase.modality",e)}async detectModality(e){const n=this.getModalityPreference();return n==="static"?"static":n==="dynamic"||await Ct.exists(e)?"dynamic":"static"}async openFromFile(e,n){this.currentFile=e,e.name.endsWith(".gcasex")&&j.info("Active GlyphCase detected",{filename:e.name,note:"WASM apps not supported in PWA - treating as Dynamic mode"});const i=new Uint8Array(await e.arrayBuffer()),a=await this.dbClient.hasEnvelopeTables(i);a&&(j.info("Detected canonical file with embedded envelope",{filename:e.name}),await this.dbClient.extractEnvelope(e),j.info("Envelope extracted to runtime sidecar"));const s=await this.dbClient.openFromFile(e);let o=!1;try{const f=await this.dbClient.query("SELECT value FROM _metadata WHERE key = ?",["mgqd_extensions"]);if(f.length>0)try{const c=JSON.parse(f[0].value);Array.isArray(c)&&c.includes("tcmr")&&(o=!0,j.info("TCMR scripts detected via metadata",{filename:e.name,extensions:c}))}catch(c){j.warn("Failed to parse mgqd_extensions metadata",{filename:e.name,error:c})}if(!o){const c=await this.dbClient.query("SELECT COUNT(*) as count FROM sqlar WHERE name LIKE 'scripts/%'",[]);c.length>0&&c[0].count>0&&(o=!0,j.warn("TCMR scripts detected via directory scan",{filename:e.name,scriptCount:c[0].count,recommendation:'Add "tcmr" to mgqd_extensions in _metadata'}))}o&&j.info("TCMR support detected",{filename:e.name,note:"Scripts are not executable in PWA (display only)"})}catch{j.debug("TCMR detection skipped",{filename:e.name,reason:"No _metadata or sqlar tables (expected for some formats)"})}let l=!1;try{const f=await this.dbClient.query("SELECT value FROM _metadata WHERE key = ?",["mgqd_extensions"]);if(f.length>0)try{const c=JSON.parse(f[0].value);Array.isArray(c)&&c.includes("panda-css")&&(l=!0,j.info("Panda CSS detected via metadata",{filename:e.name,extensions:c}))}catch(c){j.warn("Failed to parse mgqd_extensions metadata",{filename:e.name,error:c})}if(!l){const c=await this.dbClient.query("SELECT COUNT(*) as count FROM sqlar WHERE name LIKE 'gc/ui/%'",[]);c.length>0&&c[0].count>0&&(l=!0,j.warn("Panda CSS detected via directory scan",{filename:e.name,fileCount:c[0].count,recommendation:'Add "panda-css" to mgqd_extensions in _metadata'}))}l&&j.info("Panda CSS support detected",{filename:e.name,note:"Design tokens and styles available for UI enhancement"})}catch{j.debug("Panda CSS detection skipped",{filename:e.name,reason:"No _metadata or sqlar tables (expected for some formats)"})}let u;n!==void 0?u=n?"dynamic":"static":a?u="dynamic":u=await this.detectModality(e),this.currentModality=u;let d;return u==="dynamic"&&(d=this.envelopeManager.getStats()||void 0,j.info("Dynamic mode active",{filename:e.name,stats:d})),this.currentInfo={...s,modality:u,envelopeStats:d,envelopeExtracted:a,hasScripts:o,hasPandaCss:l},nr({gid:s.docId||"unknown",title:s.title||"Untitled",modality:u}),this.currentInfo}async openDemo(){const e=await this.dbClient.openDemo();return this.currentModality="static",this.currentInfo={...e,modality:"static"},nr({gid:e.docId||"demo",title:e.title||"Demo",modality:"static"}),this.currentInfo}async enableDynamicMode(){if(!this.currentFile)throw new Error("No capsule loaded");if(this.currentModality==="dynamic"){j.info("Already in dynamic mode");return}this.currentModality="dynamic",this.currentInfo&&(this.currentInfo.modality="dynamic"),j.info("Enabled dynamic mode")}getModality(){return this.currentModality}getInfo(){return this.currentInfo}isDynamic(){return this.currentModality==="dynamic"}getCore(){return this.dbClient}getEnvelope(){return this.envelopeManager}getStream(){return ue}async close(){this.envelopeManager.isOpen()&&this.envelopeManager.close(),await this.dbClient.close(),this.currentModality="static",this.currentFile=null,this.currentInfo=null,wi()}async saveGlyphCase(){if(!this.currentFile)throw new Error("No capsule loaded");if(this.currentModality==="static"){j.info("Saving Standard GlyphCase (Core only)");const n=await this.dbClient.exportDatabase();return new Blob([n],{type:"application/x-sqlite3"})}j.info("Saving Dynamic GlyphCase (.gcase+)");const e=await this.dbClient.mergeWithEnvelope(this.currentFile);return new Blob([e],{type:"application/x-sqlite3"})}async exportGlyphCase(){return this.saveGlyphCase()}async exportEnvelopeSidecar(){return this.envelopeManager.isOpen()?this.envelopeManager.exportSidecar():null}async clearEnvelope(){this.envelopeManager.isOpen()&&(await this.envelopeManager.clear(),this.currentInfo&&(this.currentInfo.envelopeStats=this.envelopeManager.getStats()||void 0))}getEnvelopeStats(){return this.envelopeManager.getStats()}async verifyEnvelope(){return this.envelopeManager.isOpen()?this.envelopeManager.verify():null}}const U=new Vi,be=En(["search"]);function Pr(t={}){const{defaultMode:e="hybrid",maxResults:n=10,maxGraphHops:i=2,debounceMs:a=300}=t,[s,o]=S(e),[l,u]=S(null),[d,f]=S(""),[c,p]=S(!1),[m,g]=S(null),[b,v]=S({}),[_,y]=S(""),[T,N]=S(()=>{try{const R=localStorage.getItem("memglyph-search-history");return R?JSON.parse(R):[]}catch{return[]}}),L=nt(null);J(()=>{if(_.trim())return L.current&&clearTimeout(L.current),L.current=window.setTimeout(()=>{q(_)},a),()=>{L.current&&clearTimeout(L.current)}},[_,s,b]);const O=R=>{if(!R.trim())return;const ee=R.trim();N(oe=>{const z=oe.filter(Y=>Y!==ee),te=[ee,...z].slice(0,10);try{localStorage.setItem("memglyph-search-history",JSON.stringify(te))}catch(Y){be.warn("Failed to save search history",{error:String(Y)})}return te})},W=()=>{N([]);try{localStorage.removeItem("memglyph-search-history")}catch(R){be.warn("Failed to clear search history",{error:String(R)})}},q=async R=>{if(!R.trim())return;p(!0),g(null),f(R),O(R);const ee=performance.now();try{const oe=de();vi({query:R,type:s,limit:n});let z=[];switch(s){case"fts":z=await Qi(oe,R,n,b);break;case"hybrid":z=await oe.searchHybrid(R,n);break;case"graph":z=await ji(oe,R,n,i,b);break;default:throw new Error(`Unknown search mode: ${s}`)}const te=performance.now()-ee;return Ei({query:R,type:s,results:z.map(Y=>({gid:Y.gid,score:Y.scores.final,snippet:Y.snippet||void 0})),executionTime:te}),U.isDynamic()&&await Yi(R,s,z),be.info("Search completed",{query:R,mode:s,hits:z.length,duration_ms:Math.round(te)}),te>1e3&&be.warn("Slow search detected",{query:R,mode:s,duration_ms:Math.round(te)}),u(z),z}catch(oe){const z=String(oe);return g(z),be.error("Search failed",{query:R,mode:s,error:z}),[]}finally{p(!1)}};return{mode:s,results:l,lastQuery:d,loading:c,error:m,entityFilter:b,searchHistory:T,search:R=>{y(R)},searchImmediate:R=>(L.current&&clearTimeout(L.current),y(""),q(R)),clear:()=>{u(null),f(""),g(null),y(""),L.current&&clearTimeout(L.current)},changeMode:R=>{o(R),u(null)},setFilter:R=>{v(R),u(null)},clearFilter:()=>{v({}),u(null)},clearHistory:W}}async function Yi(t,e,n){try{const i=U.getEnvelope();if(!i.isOpen()){be.warn("Envelope not open, skipping retrieval log",{query:t,mode:e});return}const a=i.getWriter();if(!a){be.warn("No envelope writer available",{query:t,mode:e});return}await a.appendRetrieval({id:kt("ret"),query_text:t,query_type:e,top_docs:n.slice(0,10).map(s=>({gid:s.gid,score:s.scores.final,snippet:s.snippet||void 0})),hit_count:n.length}),be.debug("Logged retrieval to envelope",{query:t,mode:e,results:n.length})}catch(i){be.error("Failed to log to envelope",{query:t,mode:e,error:String(i)})}}async function Qi(t,e,n,i){return(await t.searchFts(e,n,i.entityType,i.entityValue)).map(s=>({gid:s.gid,pageNo:s.pageNo,title:s.title,snippet:s.snippet,scores:{fts:s.score,vector:0,entity:0,graph:0,final:s.score}}))}async function ji(t,e,n,i,a){const s=await t.searchFts(e,3,a.entityType,a.entityValue);if(s.length===0)return[];const o=s[0].gid,l=await t.graphHops(o,void 0,i,n),u=l.nodes.map(d=>{const f=l.distances[d.gid]||0,c=s.find(p=>p.gid===d.gid);return{gid:d.gid,pageNo:d.pageNo,title:d.title,snippet:(c==null?void 0:c.snippet)||null,scores:{fts:(c==null?void 0:c.score)||0,vector:0,entity:0,graph:1/(f+1),final:((c==null?void 0:c.score)||0)*.3+1/(f+1)*.7}}});return u.sort((d,f)=>f.scores.final-d.scores.final),u}/*! @license DOMPurify 3.3.0 | (c) Cure53 and other contributors | Released under the Apache license 2.0 and Mozilla Public License 2.0 | github.com/cure53/DOMPurify/blob/3.3.0/LICENSE */const{entries:$r,setPrototypeOf:cr,isFrozen:Ji,getPrototypeOf:Ki,getOwnPropertyDescriptor:Zi}=Object;let{freeze:ie,seal:he,create:hn}=Object,{apply:pn,construct:fn}=typeof Reflect<"u"&&Reflect;ie||(ie=function(e){return e});he||(he=function(e){return e});pn||(pn=function(e,n){for(var i=arguments.length,a=new Array(i>2?i-2:0),s=2;s<i;s++)a[s-2]=arguments[s];return e.apply(n,a)});fn||(fn=function(e){for(var n=arguments.length,i=new Array(n>1?n-1:0),a=1;a<n;a++)i[a-1]=arguments[a];return new e(...i)});const _t=ae(Array.prototype.forEach),ea=ae(Array.prototype.lastIndexOf),dr=ae(Array.prototype.pop),je=ae(Array.prototype.push),ta=ae(Array.prototype.splice),Nt=ae(String.prototype.toLowerCase),Qt=ae(String.prototype.toString),jt=ae(String.prototype.match),Je=ae(String.prototype.replace),na=ae(String.prototype.indexOf),ra=ae(String.prototype.trim),pe=ae(Object.prototype.hasOwnProperty),re=ae(RegExp.prototype.test),Ke=ia(TypeError);function ae(t){return function(e){e instanceof RegExp&&(e.lastIndex=0);for(var n=arguments.length,i=new Array(n>1?n-1:0),a=1;a<n;a++)i[a-1]=arguments[a];return pn(t,e,i)}}function ia(t){return function(){for(var e=arguments.length,n=new Array(e),i=0;i<e;i++)n[i]=arguments[i];return fn(t,n)}}function x(t,e){let n=arguments.length>2&&arguments[2]!==void 0?arguments[2]:Nt;cr&&cr(t,null);let i=e.length;for(;i--;){let a=e[i];if(typeof a=="string"){const s=n(a);s!==a&&(Ji(e)||(e[i]=s),a=s)}t[a]=!0}return t}function aa(t){for(let e=0;e<t.length;e++)pe(t,e)||(t[e]=null);return t}function Ee(t){const e=hn(null);for(const[n,i]of $r(t))pe(t,n)&&(Array.isArray(i)?e[n]=aa(i):i&&typeof i=="object"&&i.constructor===Object?e[n]=Ee(i):e[n]=i);return e}function Ze(t,e){for(;t!==null;){const i=Zi(t,e);if(i){if(i.get)return ae(i.get);if(typeof i.value=="function")return ae(i.value)}t=Ki(t)}function n(){return null}return n}const ur=ie(["a","abbr","acronym","address","area","article","aside","audio","b","bdi","bdo","big","blink","blockquote","body","br","button","canvas","caption","center","cite","code","col","colgroup","content","data","datalist","dd","decorator","del","details","dfn","dialog","dir","div","dl","dt","element","em","fieldset","figcaption","figure","font","footer","form","h1","h2","h3","h4","h5","h6","head","header","hgroup","hr","html","i","img","input","ins","kbd","label","legend","li","main","map","mark","marquee","menu","menuitem","meter","nav","nobr","ol","optgroup","option","output","p","picture","pre","progress","q","rp","rt","ruby","s","samp","search","section","select","shadow","slot","small","source","spacer","span","strike","strong","style","sub","summary","sup","table","tbody","td","template","textarea","tfoot","th","thead","time","tr","track","tt","u","ul","var","video","wbr"]),Jt=ie(["svg","a","altglyph","altglyphdef","altglyphitem","animatecolor","animatemotion","animatetransform","circle","clippath","defs","desc","ellipse","enterkeyhint","exportparts","filter","font","g","glyph","glyphref","hkern","image","inputmode","line","lineargradient","marker","mask","metadata","mpath","part","path","pattern","polygon","polyline","radialgradient","rect","stop","style","switch","symbol","text","textpath","title","tref","tspan","view","vkern"]),Kt=ie(["feBlend","feColorMatrix","feComponentTransfer","feComposite","feConvolveMatrix","feDiffuseLighting","feDisplacementMap","feDistantLight","feDropShadow","feFlood","feFuncA","feFuncB","feFuncG","feFuncR","feGaussianBlur","feImage","feMerge","feMergeNode","feMorphology","feOffset","fePointLight","feSpecularLighting","feSpotLight","feTile","feTurbulence"]),sa=ie(["animate","color-profile","cursor","discard","font-face","font-face-format","font-face-name","font-face-src","font-face-uri","foreignobject","hatch","hatchpath","mesh","meshgradient","meshpatch","meshrow","missing-glyph","script","set","solidcolor","unknown","use"]),Zt=ie(["math","menclose","merror","mfenced","mfrac","mglyph","mi","mlabeledtr","mmultiscripts","mn","mo","mover","mpadded","mphantom","mroot","mrow","ms","mspace","msqrt","mstyle","msub","msup","msubsup","mtable","mtd","mtext","mtr","munder","munderover","mprescripts"]),oa=ie(["maction","maligngroup","malignmark","mlongdiv","mscarries","mscarry","msgroup","mstack","msline","msrow","semantics","annotation","annotation-xml","mprescripts","none"]),hr=ie(["#text"]),pr=ie(["accept","action","align","alt","autocapitalize","autocomplete","autopictureinpicture","autoplay","background","bgcolor","border","capture","cellpadding","cellspacing","checked","cite","class","clear","color","cols","colspan","controls","controlslist","coords","crossorigin","datetime","decoding","default","dir","disabled","disablepictureinpicture","disableremoteplayback","download","draggable","enctype","enterkeyhint","exportparts","face","for","headers","height","hidden","high","href","hreflang","id","inert","inputmode","integrity","ismap","kind","label","lang","list","loading","loop","low","max","maxlength","media","method","min","minlength","multiple","muted","name","nonce","noshade","novalidate","nowrap","open","optimum","part","pattern","placeholder","playsinline","popover","popovertarget","popovertargetaction","poster","preload","pubdate","radiogroup","readonly","rel","required","rev","reversed","role","rows","rowspan","spellcheck","scope","selected","shape","size","sizes","slot","span","srclang","start","src","srcset","step","style","summary","tabindex","title","translate","type","usemap","valign","value","width","wrap","xmlns","slot"]),en=ie(["accent-height","accumulate","additive","alignment-baseline","amplitude","ascent","attributename","attributetype","azimuth","basefrequency","baseline-shift","begin","bias","by","class","clip","clippathunits","clip-path","clip-rule","color","color-interpolation","color-interpolation-filters","color-profile","color-rendering","cx","cy","d","dx","dy","diffuseconstant","direction","display","divisor","dur","edgemode","elevation","end","exponent","fill","fill-opacity","fill-rule","filter","filterunits","flood-color","flood-opacity","font-family","font-size","font-size-adjust","font-stretch","font-style","font-variant","font-weight","fx","fy","g1","g2","glyph-name","glyphref","gradientunits","gradienttransform","height","href","id","image-rendering","in","in2","intercept","k","k1","k2","k3","k4","kerning","keypoints","keysplines","keytimes","lang","lengthadjust","letter-spacing","kernelmatrix","kernelunitlength","lighting-color","local","marker-end","marker-mid","marker-start","markerheight","markerunits","markerwidth","maskcontentunits","maskunits","max","mask","mask-type","media","method","mode","min","name","numoctaves","offset","operator","opacity","order","orient","orientation","origin","overflow","paint-order","path","pathlength","patterncontentunits","patterntransform","patternunits","points","preservealpha","preserveaspectratio","primitiveunits","r","rx","ry","radius","refx","refy","repeatcount","repeatdur","restart","result","rotate","scale","seed","shape-rendering","slope","specularconstant","specularexponent","spreadmethod","startoffset","stddeviation","stitchtiles","stop-color","stop-opacity","stroke-dasharray","stroke-dashoffset","stroke-linecap","stroke-linejoin","stroke-miterlimit","stroke-opacity","stroke","stroke-width","style","surfacescale","systemlanguage","tabindex","tablevalues","targetx","targety","transform","transform-origin","text-anchor","text-decoration","text-rendering","textlength","type","u1","u2","unicode","values","viewbox","visibility","version","vert-adv-y","vert-origin-x","vert-origin-y","width","word-spacing","wrap","writing-mode","xchannelselector","ychannelselector","x","x1","x2","xmlns","y","y1","y2","z","zoomandpan"]),fr=ie(["accent","accentunder","align","bevelled","close","columnsalign","columnlines","columnspan","denomalign","depth","dir","display","displaystyle","encoding","fence","frame","height","href","id","largeop","length","linethickness","lspace","lquote","mathbackground","mathcolor","mathsize","mathvariant","maxsize","minsize","movablelimits","notation","numalign","open","rowalign","rowlines","rowspacing","rowspan","rspace","rquote","scriptlevel","scriptminsize","scriptsizemultiplier","selection","separator","separators","stretchy","subscriptshift","supscriptshift","symmetric","voffset","width","xmlns"]),vt=ie(["xlink:href","xml:id","xlink:title","xml:space","xmlns:xlink"]),la=he(/\{\{[\w\W]*|[\w\W]*\}\}/gm),ca=he(/<%[\w\W]*|[\w\W]*%>/gm),da=he(/\$\{[\w\W]*/gm),ua=he(/^data-[\-\w.\u00B7-\uFFFF]+$/),ha=he(/^aria-[\-\w]+$/),Ur=he(/^(?:(?:(?:f|ht)tps?|mailto|tel|callto|sms|cid|xmpp|matrix):|[^a-z]|[a-z+.\-]+(?:[^a-z+.\-:]|$))/i),pa=he(/^(?:\w+script|data):/i),fa=he(/[\u0000-\u0020\u00A0\u1680\u180E\u2000-\u2029\u205F\u3000]/g),Hr=he(/^html$/i),ma=he(/^[a-z][.\w]*(-[.\w]+)+$/i);var mr=Object.freeze({__proto__:null,ARIA_ATTR:ha,ATTR_WHITESPACE:fa,CUSTOM_ELEMENT:ma,DATA_ATTR:ua,DOCTYPE_NAME:Hr,ERB_EXPR:ca,IS_ALLOWED_URI:Ur,IS_SCRIPT_OR_DATA:pa,MUSTACHE_EXPR:la,TMPLIT_EXPR:da});const et={element:1,text:3,progressingInstruction:7,comment:8,document:9},ga=function(){return typeof window>"u"?null:window},ya=function(e,n){if(typeof e!="object"||typeof e.createPolicy!="function")return null;let i=null;const a="data-tt-policy-suffix";n&&n.hasAttribute(a)&&(i=n.getAttribute(a));const s="dompurify"+(i?"#"+i:"");try{return e.createPolicy(s,{createHTML(o){return o},createScriptURL(o){return o}})}catch{return console.warn("TrustedTypes policy "+s+" could not be created."),null}},gr=function(){return{afterSanitizeAttributes:[],afterSanitizeElements:[],afterSanitizeShadowDOM:[],beforeSanitizeAttributes:[],beforeSanitizeElements:[],beforeSanitizeShadowDOM:[],uponSanitizeAttribute:[],uponSanitizeElement:[],uponSanitizeShadowNode:[]}};function qr(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:ga();const e=C=>qr(C);if(e.version="3.3.0",e.removed=[],!t||!t.document||t.document.nodeType!==et.document||!t.Element)return e.isSupported=!1,e;let{document:n}=t;const i=n,a=i.currentScript,{DocumentFragment:s,HTMLTemplateElement:o,Node:l,Element:u,NodeFilter:d,NamedNodeMap:f=t.NamedNodeMap||t.MozNamedAttrMap,HTMLFormElement:c,DOMParser:p,trustedTypes:m}=t,g=u.prototype,b=Ze(g,"cloneNode"),v=Ze(g,"remove"),_=Ze(g,"nextSibling"),y=Ze(g,"childNodes"),T=Ze(g,"parentNode");if(typeof o=="function"){const C=n.createElement("template");C.content&&C.content.ownerDocument&&(n=C.content.ownerDocument)}let N,L="";const{implementation:O,createNodeIterator:W,createDocumentFragment:q,getElementsByTagName:se}=n,{importNode:M}=i;let I=gr();e.isSupported=typeof $r=="function"&&typeof T=="function"&&O&&O.createHTMLDocument!==void 0;const{MUSTACHE_EXPR:Z,ERB_EXPR:we,TMPLIT_EXPR:P,DATA_ATTR:R,ARIA_ATTR:ee,IS_SCRIPT_OR_DATA:oe,ATTR_WHITESPACE:z,CUSTOM_ELEMENT:te}=mr;let{IS_ALLOWED_URI:Y}=mr,D=null;const Ne=x({},[...ur,...Jt,...Kt,...Zt,...hr]);let k=null;const Ce=x({},[...pr,...en,...fr,...vt]);let G=Object.seal(hn(null,{tagNameCheck:{writable:!0,configurable:!1,enumerable:!0,value:null},attributeNameCheck:{writable:!0,configurable:!1,enumerable:!0,value:null},allowCustomizedBuiltInElements:{writable:!0,configurable:!1,enumerable:!0,value:!1}})),Le=null,Xe=null;const Ie=Object.seal(hn(null,{tagCheck:{writable:!0,configurable:!1,enumerable:!0,value:null},attributeCheck:{writable:!0,configurable:!1,enumerable:!0,value:null}}));let Nn=!0,xt=!0,Sn=!1,wn=!0,Me=!1,ot=!0,Ae=!1,It=!1,Mt=!1,De=!1,lt=!1,ct=!1,Cn=!0,Ln=!1;const Vr="user-content-";let Dt=!0,Ve=!1,Fe={},Pe=null;const An=x({},["annotation-xml","audio","colgroup","desc","foreignobject","head","iframe","math","mi","mn","mo","ms","mtext","noembed","noframes","noscript","plaintext","script","style","svg","template","thead","title","video","xmp"]);let Rn=null;const On=x({},["audio","video","img","source","image","track"]);let Ft=null;const kn=x({},["alt","class","for","id","label","name","pattern","placeholder","role","summary","title","value","style","xmlns"]),dt="http://www.w3.org/1998/Math/MathML",ut="http://www.w3.org/2000/svg",ge="http://www.w3.org/1999/xhtml";let $e=ge,Pt=!1,$t=null;const Yr=x({},[dt,ut,ge],Qt);let ht=x({},["mi","mo","mn","ms","mtext"]),pt=x({},["annotation-xml"]);const Qr=x({},["title","style","font","a","script"]);let Ye=null;const jr=["application/xhtml+xml","text/html"],Jr="text/html";let Q=null,Ue=null;const Kr=n.createElement("form"),xn=function(h){return h instanceof RegExp||h instanceof Function},Ut=function(){let h=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};if(!(Ue&&Ue===h)){if((!h||typeof h!="object")&&(h={}),h=Ee(h),Ye=jr.indexOf(h.PARSER_MEDIA_TYPE)===-1?Jr:h.PARSER_MEDIA_TYPE,Q=Ye==="application/xhtml+xml"?Qt:Nt,D=pe(h,"ALLOWED_TAGS")?x({},h.ALLOWED_TAGS,Q):Ne,k=pe(h,"ALLOWED_ATTR")?x({},h.ALLOWED_ATTR,Q):Ce,$t=pe(h,"ALLOWED_NAMESPACES")?x({},h.ALLOWED_NAMESPACES,Qt):Yr,Ft=pe(h,"ADD_URI_SAFE_ATTR")?x(Ee(kn),h.ADD_URI_SAFE_ATTR,Q):kn,Rn=pe(h,"ADD_DATA_URI_TAGS")?x(Ee(On),h.ADD_DATA_URI_TAGS,Q):On,Pe=pe(h,"FORBID_CONTENTS")?x({},h.FORBID_CONTENTS,Q):An,Le=pe(h,"FORBID_TAGS")?x({},h.FORBID_TAGS,Q):Ee({}),Xe=pe(h,"FORBID_ATTR")?x({},h.FORBID_ATTR,Q):Ee({}),Fe=pe(h,"USE_PROFILES")?h.USE_PROFILES:!1,Nn=h.ALLOW_ARIA_ATTR!==!1,xt=h.ALLOW_DATA_ATTR!==!1,Sn=h.ALLOW_UNKNOWN_PROTOCOLS||!1,wn=h.ALLOW_SELF_CLOSE_IN_ATTR!==!1,Me=h.SAFE_FOR_TEMPLATES||!1,ot=h.SAFE_FOR_XML!==!1,Ae=h.WHOLE_DOCUMENT||!1,De=h.RETURN_DOM||!1,lt=h.RETURN_DOM_FRAGMENT||!1,ct=h.RETURN_TRUSTED_TYPE||!1,Mt=h.FORCE_BODY||!1,Cn=h.SANITIZE_DOM!==!1,Ln=h.SANITIZE_NAMED_PROPS||!1,Dt=h.KEEP_CONTENT!==!1,Ve=h.IN_PLACE||!1,Y=h.ALLOWED_URI_REGEXP||Ur,$e=h.NAMESPACE||ge,ht=h.MATHML_TEXT_INTEGRATION_POINTS||ht,pt=h.HTML_INTEGRATION_POINTS||pt,G=h.CUSTOM_ELEMENT_HANDLING||{},h.CUSTOM_ELEMENT_HANDLING&&xn(h.CUSTOM_ELEMENT_HANDLING.tagNameCheck)&&(G.tagNameCheck=h.CUSTOM_ELEMENT_HANDLING.tagNameCheck),h.CUSTOM_ELEMENT_HANDLING&&xn(h.CUSTOM_ELEMENT_HANDLING.attributeNameCheck)&&(G.attributeNameCheck=h.CUSTOM_ELEMENT_HANDLING.attributeNameCheck),h.CUSTOM_ELEMENT_HANDLING&&typeof h.CUSTOM_ELEMENT_HANDLING.allowCustomizedBuiltInElements=="boolean"&&(G.allowCustomizedBuiltInElements=h.CUSTOM_ELEMENT_HANDLING.allowCustomizedBuiltInElements),Me&&(xt=!1),lt&&(De=!0),Fe&&(D=x({},hr),k=[],Fe.html===!0&&(x(D,ur),x(k,pr)),Fe.svg===!0&&(x(D,Jt),x(k,en),x(k,vt)),Fe.svgFilters===!0&&(x(D,Kt),x(k,en),x(k,vt)),Fe.mathMl===!0&&(x(D,Zt),x(k,fr),x(k,vt))),h.ADD_TAGS&&(typeof h.ADD_TAGS=="function"?Ie.tagCheck=h.ADD_TAGS:(D===Ne&&(D=Ee(D)),x(D,h.ADD_TAGS,Q))),h.ADD_ATTR&&(typeof h.ADD_ATTR=="function"?Ie.attributeCheck=h.ADD_ATTR:(k===Ce&&(k=Ee(k)),x(k,h.ADD_ATTR,Q))),h.ADD_URI_SAFE_ATTR&&x(Ft,h.ADD_URI_SAFE_ATTR,Q),h.FORBID_CONTENTS&&(Pe===An&&(Pe=Ee(Pe)),x(Pe,h.FORBID_CONTENTS,Q)),Dt&&(D["#text"]=!0),Ae&&x(D,["html","head","body"]),D.table&&(x(D,["tbody"]),delete Le.tbody),h.TRUSTED_TYPES_POLICY){if(typeof h.TRUSTED_TYPES_POLICY.createHTML!="function")throw Ke('TRUSTED_TYPES_POLICY configuration option must provide a "createHTML" hook.');if(typeof h.TRUSTED_TYPES_POLICY.createScriptURL!="function")throw Ke('TRUSTED_TYPES_POLICY configuration option must provide a "createScriptURL" hook.');N=h.TRUSTED_TYPES_POLICY,L=N.createHTML("")}else N===void 0&&(N=ya(m,a)),N!==null&&typeof L=="string"&&(L=N.createHTML(""));ie&&ie(h),Ue=h}},In=x({},[...Jt,...Kt,...sa]),Mn=x({},[...Zt,...oa]),Zr=function(h){let E=T(h);(!E||!E.tagName)&&(E={namespaceURI:$e,tagName:"template"});const w=Nt(h.tagName),H=Nt(E.tagName);return $t[h.namespaceURI]?h.namespaceURI===ut?E.namespaceURI===ge?w==="svg":E.namespaceURI===dt?w==="svg"&&(H==="annotation-xml"||ht[H]):!!In[w]:h.namespaceURI===dt?E.namespaceURI===ge?w==="math":E.namespaceURI===ut?w==="math"&&pt[H]:!!Mn[w]:h.namespaceURI===ge?E.namespaceURI===ut&&!pt[H]||E.namespaceURI===dt&&!ht[H]?!1:!Mn[w]&&(Qr[w]||!In[w]):!!(Ye==="application/xhtml+xml"&&$t[h.namespaceURI]):!1},fe=function(h){je(e.removed,{element:h});try{T(h).removeChild(h)}catch{v(h)}},Re=function(h,E){try{je(e.removed,{attribute:E.getAttributeNode(h),from:E})}catch{je(e.removed,{attribute:null,from:E})}if(E.removeAttribute(h),h==="is")if(De||lt)try{fe(E)}catch{}else try{E.setAttribute(h,"")}catch{}},Dn=function(h){let E=null,w=null;if(Mt)h="<remove></remove>"+h;else{const X=jt(h,/^[\r\n\t ]+/);w=X&&X[0]}Ye==="application/xhtml+xml"&&$e===ge&&(h='<html xmlns="http://www.w3.org/1999/xhtml"><head></head><body>'+h+"</body></html>");const H=N?N.createHTML(h):h;if($e===ge)try{E=new p().parseFromString(H,Ye)}catch{}if(!E||!E.documentElement){E=O.createDocument($e,"template",null);try{E.documentElement.innerHTML=Pt?L:H}catch{}}const ne=E.body||E.documentElement;return h&&w&&ne.insertBefore(n.createTextNode(w),ne.childNodes[0]||null),$e===ge?se.call(E,Ae?"html":"body")[0]:Ae?E.documentElement:ne},Fn=function(h){return W.call(h.ownerDocument||h,h,d.SHOW_ELEMENT|d.SHOW_COMMENT|d.SHOW_TEXT|d.SHOW_PROCESSING_INSTRUCTION|d.SHOW_CDATA_SECTION,null)},Ht=function(h){return h instanceof c&&(typeof h.nodeName!="string"||typeof h.textContent!="string"||typeof h.removeChild!="function"||!(h.attributes instanceof f)||typeof h.removeAttribute!="function"||typeof h.setAttribute!="function"||typeof h.namespaceURI!="string"||typeof h.insertBefore!="function"||typeof h.hasChildNodes!="function")},Pn=function(h){return typeof l=="function"&&h instanceof l};function ye(C,h,E){_t(C,w=>{w.call(e,h,E,Ue)})}const $n=function(h){let E=null;if(ye(I.beforeSanitizeElements,h,null),Ht(h))return fe(h),!0;const w=Q(h.nodeName);if(ye(I.uponSanitizeElement,h,{tagName:w,allowedTags:D}),ot&&h.hasChildNodes()&&!Pn(h.firstElementChild)&&re(/<[/\w!]/g,h.innerHTML)&&re(/<[/\w!]/g,h.textContent)||h.nodeType===et.progressingInstruction||ot&&h.nodeType===et.comment&&re(/<[/\w]/g,h.data))return fe(h),!0;if(!(Ie.tagCheck instanceof Function&&Ie.tagCheck(w))&&(!D[w]||Le[w])){if(!Le[w]&&Hn(w)&&(G.tagNameCheck instanceof RegExp&&re(G.tagNameCheck,w)||G.tagNameCheck instanceof Function&&G.tagNameCheck(w)))return!1;if(Dt&&!Pe[w]){const H=T(h)||h.parentNode,ne=y(h)||h.childNodes;if(ne&&H){const X=ne.length;for(let le=X-1;le>=0;--le){const _e=b(ne[le],!0);_e.__removalCount=(h.__removalCount||0)+1,H.insertBefore(_e,_(h))}}}return fe(h),!0}return h instanceof u&&!Zr(h)||(w==="noscript"||w==="noembed"||w==="noframes")&&re(/<\/no(script|embed|frames)/i,h.innerHTML)?(fe(h),!0):(Me&&h.nodeType===et.text&&(E=h.textContent,_t([Z,we,P],H=>{E=Je(E,H," ")}),h.textContent!==E&&(je(e.removed,{element:h.cloneNode()}),h.textContent=E)),ye(I.afterSanitizeElements,h,null),!1)},Un=function(h,E,w){if(Cn&&(E==="id"||E==="name")&&(w in n||w in Kr))return!1;if(!(xt&&!Xe[E]&&re(R,E))){if(!(Nn&&re(ee,E))){if(!(Ie.attributeCheck instanceof Function&&Ie.attributeCheck(E,h))){if(!k[E]||Xe[E]){if(!(Hn(h)&&(G.tagNameCheck instanceof RegExp&&re(G.tagNameCheck,h)||G.tagNameCheck instanceof Function&&G.tagNameCheck(h))&&(G.attributeNameCheck instanceof RegExp&&re(G.attributeNameCheck,E)||G.attributeNameCheck instanceof Function&&G.attributeNameCheck(E,h))||E==="is"&&G.allowCustomizedBuiltInElements&&(G.tagNameCheck instanceof RegExp&&re(G.tagNameCheck,w)||G.tagNameCheck instanceof Function&&G.tagNameCheck(w))))return!1}else if(!Ft[E]){if(!re(Y,Je(w,z,""))){if(!((E==="src"||E==="xlink:href"||E==="href")&&h!=="script"&&na(w,"data:")===0&&Rn[h])){if(!(Sn&&!re(oe,Je(w,z,"")))){if(w)return!1}}}}}}}return!0},Hn=function(h){return h!=="annotation-xml"&&jt(h,te)},qn=function(h){ye(I.beforeSanitizeAttributes,h,null);const{attributes:E}=h;if(!E||Ht(h))return;const w={attrName:"",attrValue:"",keepAttr:!0,allowedAttributes:k,forceKeepAttr:void 0};let H=E.length;for(;H--;){const ne=E[H],{name:X,namespaceURI:le,value:_e}=ne,He=Q(X),qt=_e;let K=X==="value"?qt:ra(qt);if(w.attrName=He,w.attrValue=K,w.keepAttr=!0,w.forceKeepAttr=void 0,ye(I.uponSanitizeAttribute,h,w),K=w.attrValue,Ln&&(He==="id"||He==="name")&&(Re(X,h),K=Vr+K),ot&&re(/((--!?|])>)|<\/(style|title|textarea)/i,K)){Re(X,h);continue}if(He==="attributename"&&jt(K,"href")){Re(X,h);continue}if(w.forceKeepAttr)continue;if(!w.keepAttr){Re(X,h);continue}if(!wn&&re(/\/>/i,K)){Re(X,h);continue}Me&&_t([Z,we,P],Wn=>{K=Je(K,Wn," ")});const Gn=Q(h.nodeName);if(!Un(Gn,He,K)){Re(X,h);continue}if(N&&typeof m=="object"&&typeof m.getAttributeType=="function"&&!le)switch(m.getAttributeType(Gn,He)){case"TrustedHTML":{K=N.createHTML(K);break}case"TrustedScriptURL":{K=N.createScriptURL(K);break}}if(K!==qt)try{le?h.setAttributeNS(le,X,K):h.setAttribute(X,K),Ht(h)?fe(h):dr(e.removed)}catch{Re(X,h)}}ye(I.afterSanitizeAttributes,h,null)},ei=function C(h){let E=null;const w=Fn(h);for(ye(I.beforeSanitizeShadowDOM,h,null);E=w.nextNode();)ye(I.uponSanitizeShadowNode,E,null),$n(E),qn(E),E.content instanceof s&&C(E.content);ye(I.afterSanitizeShadowDOM,h,null)};return e.sanitize=function(C){let h=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{},E=null,w=null,H=null,ne=null;if(Pt=!C,Pt&&(C="<!-->"),typeof C!="string"&&!Pn(C))if(typeof C.toString=="function"){if(C=C.toString(),typeof C!="string")throw Ke("dirty is not a string, aborting")}else throw Ke("toString is not a function");if(!e.isSupported)return C;if(It||Ut(h),e.removed=[],typeof C=="string"&&(Ve=!1),Ve){if(C.nodeName){const _e=Q(C.nodeName);if(!D[_e]||Le[_e])throw Ke("root node is forbidden and cannot be sanitized in-place")}}else if(C instanceof l)E=Dn("<!---->"),w=E.ownerDocument.importNode(C,!0),w.nodeType===et.element&&w.nodeName==="BODY"||w.nodeName==="HTML"?E=w:E.appendChild(w);else{if(!De&&!Me&&!Ae&&C.indexOf("<")===-1)return N&&ct?N.createHTML(C):C;if(E=Dn(C),!E)return De?null:ct?L:""}E&&Mt&&fe(E.firstChild);const X=Fn(Ve?C:E);for(;H=X.nextNode();)$n(H),qn(H),H.content instanceof s&&ei(H.content);if(Ve)return C;if(De){if(lt)for(ne=q.call(E.ownerDocument);E.firstChild;)ne.appendChild(E.firstChild);else ne=E;return(k.shadowroot||k.shadowrootmode)&&(ne=M.call(i,ne,!0)),ne}let le=Ae?E.outerHTML:E.innerHTML;return Ae&&D["!doctype"]&&E.ownerDocument&&E.ownerDocument.doctype&&E.ownerDocument.doctype.name&&re(Hr,E.ownerDocument.doctype.name)&&(le="<!DOCTYPE "+E.ownerDocument.doctype.name+`>
`+le),Me&&_t([Z,we,P],_e=>{le=Je(le,_e," ")}),N&&ct?N.createHTML(le):le},e.setConfig=function(){let C=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};Ut(C),It=!0},e.clearConfig=function(){Ue=null,It=!1},e.isValidAttribute=function(C,h,E){Ue||Ut({});const w=Q(C),H=Q(h);return Un(w,H,E)},e.addHook=function(C,h){typeof h=="function"&&je(I[C],h)},e.removeHook=function(C,h){if(h!==void 0){const E=ea(I[C],h);return E===-1?void 0:ta(I[C],E,1)[0]}return dr(I[C])},e.removeHooks=function(C){I[C]=[]},e.removeAllHooks=function(){I=gr()},e}var Tn=qr();function _a({mode:t,onModeChange:e,showToggle:n=!0}){return n?r("div",{className:"search-mode-toggle",children:[r("button",{className:`mode-btn ${t==="fts"?"active":""}`,onClick:()=>e("fts"),children:" FTS Only"}),r("button",{className:`mode-btn ${t==="hybrid"?"active":""}`,onClick:()=>e("hybrid"),children:" Hybrid"}),r("button",{className:`mode-btn ${t==="graph"?"active":""}`,onClick:()=>e("graph"),children:" Graph"})]}):null}function va({onSearch:t,loading:e,placeholder:n,searchHistory:i,onClearHistory:a}){return r(ce,{children:[r("form",{onSubmit:s=>{s.preventDefault();const l=new FormData(s.currentTarget).get("query");l!=null&&l.trim()&&t(l.trim())},children:r("div",{className:"search-bar",children:[r("input",{type:"text",name:"query",placeholder:n||"Search the capsule...",className:"search-input",disabled:e}),r("button",{type:"submit",className:"btn-search",disabled:e,children:e?"Searching...":"Search"})]})}),i&&i.length>0&&r("div",{className:"search-history",children:[r("div",{className:"search-history-header",children:[r("span",{className:"search-history-label",children:"Recent searches:"}),a&&r("button",{className:"search-history-clear",onClick:a,type:"button",children:"Clear"})]}),r("div",{className:"search-history-items",children:i.map((s,o)=>r("button",{className:"search-history-item",onClick:()=>t(s),type:"button",children:s},o))})]})]})}function Ea({resultGid:t,retrievalId:e}){const[n,i]=S(null),[a,s]=S(!1),o=async l=>{s(!0);try{if(Si({retrievalId:e,rating:l,notes:void 0}),U.isDynamic()){const d=U.getEnvelope().getWriter();d&&await d.appendFeedback({id:kt("fb"),retrieval_id:e,rating:l,notes:void 0})}i(l)}catch(u){console.error("[Feedback] Failed to submit feedback:",u)}finally{s(!1)}};return U.isDynamic()?r("div",{className:"result-feedback",children:[r("button",{className:`feedback-btn ${n===1?"feedback-btn-active-positive":""}`,onClick:l=>{l.stopPropagation(),o(1)},disabled:a||n!==null,title:"Helpful result",children:""}),r("button",{className:`feedback-btn ${n===-1?"feedback-btn-active-negative":""}`,onClick:l=>{l.stopPropagation(),o(-1)},disabled:a||n!==null,title:"Not helpful",children:""})]}):null}function ba({results:t,query:e,onResultClick:n,retrievalId:i}){return r("div",{className:"search-results",children:[r("p",{className:"results-header",children:["Found ",t.length," results for ",r("strong",{children:['"',e,'"']})]}),t.map(a=>r("div",{className:`result-item ${n?"result-item-clickable":""}`,onClick:()=>n==null?void 0:n(a.gid),style:{cursor:n?"pointer":"default"},children:[r("div",{className:"result-header",children:[r("span",{className:"result-page",children:["Page ",a.pageNo]}),r("span",{className:"result-score",children:["Score: ",a.scores.final.toFixed(3)]}),r(Ea,{resultGid:a.gid,retrievalId:i})]}),r("h4",{className:"result-title",children:a.title}),a.snippet&&r("p",{className:"result-snippet",dangerouslySetInnerHTML:{__html:Tn.sanitize(a.snippet,{ALLOWED_TAGS:["mark","strong","em","b","i"],ALLOWED_ATTR:[]})}}),r("div",{className:"result-scores",children:[r("span",{children:["FTS: ",a.scores.fts.toFixed(2)]}),r("span",{children:["Entity: ",a.scores.entity.toFixed(2)]}),r("span",{children:["Graph: ",a.scores.graph.toFixed(2)]})]})]},a.gid))]})}function Ta({mode:t,results:e,lastQuery:n,loading:i,onSearch:a,onModeChange:s,onResultClick:o,showModeToggle:l=!0,placeholder:u,searchHint:d,searchHistory:f,onClearHistory:c}){return r("div",{className:"search-section",children:[r("div",{className:"search-header",children:r("h3",{children:" Search"})}),r(_a,{mode:t,onModeChange:s,showToggle:l}),d&&r("p",{className:"search-hint",children:d}),r("div",{className:"keyboard-shortcuts-hint",children:[r("span",{className:"shortcut-item",children:[r("kbd",{children:"/"})," Focus search"]}),r("span",{className:"shortcut-item",children:[r("kbd",{children:"Ctrl+L"})," Toggle LLM"]}),r("span",{className:"shortcut-item",children:[r("kbd",{children:"Esc"})," Clear focus"]})]}),r(va,{onSearch:a,loading:i,placeholder:u,searchHistory:f,onClearHistory:c}),e&&e.length>0&&r(ba,{results:e,query:n,onResultClick:o}),e&&e.length===0&&r("div",{className:"no-results",children:[r("p",{children:["No results found for ",r("strong",{children:['"',n,'"']})]}),r("p",{className:"search-hint",children:"Try different keywords or search terms."})]})]})}function Gr(t={}){const{autoLoad:e=!0,maxEntities:n=50}=t,[i,a]=S([]),[s,o]=S(null),[l,u]=S(!1),[d,f]=S(null),c=async()=>{u(!0),f(null);try{const y=await de().listEntities(void 0,n);a(y),console.log("[Entities] Loaded:",y.length)}catch(_){const y=String(_);f(y),console.error("[Entities] Failed to load:",_)}finally{u(!1)}};J(()=>{e&&c()},[e]);const p=_=>{o(_)},m=()=>Array.from(new Set(i.map(_=>_.entityType))),g=()=>s?i.filter(_=>_.entityType===s):i,b=_=>i.filter(y=>y.entityType===_).reduce((y,T)=>y+T.count,0),v=()=>i.reduce((_,y)=>_+y.count,0);return{entities:i,selectedType:s,loading:l,error:d,types:m(),filteredEntities:g(),totalCount:v(),loadEntities:c,selectType:p,getTypeCount:b}}function Na({types:t,selectedType:e,totalCount:n,onSelectType:i,getTypeCount:a}){return r("div",{className:"entity-filters",children:[r("button",{className:`entity-filter ${e===null?"active":""}`,onClick:()=>i(null),children:["All (",n,")"]}),t.map(s=>{const o=a(s);return r("button",{className:`entity-filter ${e===s?"active":""}`,onClick:()=>i(s),children:[s," (",o,")"]},s)})]})}function Sa({entities:t,maxDisplay:e=20}){const n=t.slice(0,e);return r("div",{className:"entity-list",children:[n.map(i=>r("div",{className:"entity-item",children:[r("span",{className:"entity-type",children:i.entityType}),r("span",{className:"entity-value",children:i.normalizedValue}),r("span",{className:"entity-count",children:i.count})]},`${i.entityType}-${i.normalizedValue}`)),t.length>e&&r("div",{className:"entity-item entity-more",children:r("span",{className:"entity-value",children:["... and ",t.length-e," more"]})})]})}function wa({entities:t,types:e,selectedType:n,totalCount:i,onSelectType:a,getTypeCount:s,show:o=!0,maxDisplay:l=20}){if(!o||t.length===0)return null;const u=n?t.filter(d=>d.entityType===n):t;return r("div",{className:"entity-panel",children:[r("h4",{children:"Filter by Entity Type"}),r(Na,{types:e,selectedType:n,totalCount:i,onSelectType:a,getTypeCount:s}),r(Sa,{entities:u,maxDisplay:l})]})}class Ca{constructor(){A(this,"worker",null);A(this,"nextId",1);A(this,"pending",new Map);A(this,"progressCallback",null);A(this,"streamTokenCallback",null);A(this,"streamCompleteCallback",null);A(this,"streamErrorCallback",null);this.initWorker()}initWorker(){this.worker=new Worker(new URL("/assets/llm.worker-BiRl8TFV.js",import.meta.url),{type:"module"}),this.worker.onmessage=e=>{const n=e.data;if("type"in n&&n.type==="READY"){console.log("[LlmClient] Worker ready");return}if("type"in n&&n.type==="PROGRESS"){this.progressCallback&&this.progressCallback(n.data);return}if("type"in n&&n.type==="STREAM_TOKEN"){this.streamTokenCallback&&this.streamTokenCallback(n.token,n.piece);return}if("type"in n&&n.type==="STREAM_COMPLETE"){this.streamCompleteCallback&&this.streamCompleteCallback();return}if("type"in n&&n.type==="STREAM_ERROR"){this.streamErrorCallback&&this.streamErrorCallback(n.error);return}const{id:i,response:a}=n,s=this.pending.get(i);s&&(this.pending.delete(i),s.resolve(a))},this.worker.onerror=e=>{console.error("[LlmClient] Worker error:",e);for(const n of this.pending.values())n.reject(new Error("Worker error"));this.pending.clear()}}async sendRequest(e){if(!this.worker)throw new Error("Worker not initialized");const n=this.nextId++;return new Promise((i,a)=>{this.pending.set(n,{resolve:o=>{o.ok?i(o.data):a(new Error(o.error))},reject:a});const s={id:n,request:e};this.worker.postMessage(s)})}onProgress(e){this.progressCallback=e}onStreamToken(e){this.streamTokenCallback=e}onStreamComplete(e){this.streamCompleteCallback=e}onStreamError(e){this.streamErrorCallback=e}async abortReasoning(){return this.sendRequest({type:"ABORT_REASONING"})}async loadModel(e){return this.sendRequest({type:"LOAD_MODEL",modelUrl:e})}async reason(e){return this.sendRequest({type:"REASON",request:e})}async unloadModel(){return this.sendRequest({type:"UNLOAD_MODEL"})}async getStatus(){return this.sendRequest({type:"GET_STATUS"})}terminate(){this.worker&&(this.worker.terminate(),this.worker=null),this.pending.clear(),this.progressCallback=null,this.streamTokenCallback=null,this.streamCompleteCallback=null,this.streamErrorCallback=null}}let tn=null;function Et(){return tn||(tn=new Ca),tn}const La={"0.6b":"https://huggingface.co/unsloth/Qwen3-0.6B-GGUF/resolve/main/Qwen3-0.6B-Q4_K_M.gguf","1.5b":"https://huggingface.co/ggml-org/Qwen2.5-1.5B-Instruct-GGUF/resolve/main/qwen2.5-1.5b-instruct-q4_k_m.gguf"},me=En(["llm"]);function Wr(t={}){const[e,n]=S(!1),[i,a]=S(null),[s,o]=S(!1),[l,u]=S(null),[d,f]=S(null),[c,p]=S(null),[m,g]=S(0),[b,v]=S(.7),[_,y]=S(!1),[T,N]=S(""),L=nt(0),O=nt(null),W=nt(0),q=5e3;J(()=>{if(s&&!l)return L.current=Date.now(),g(0),O.current=window.setInterval(()=>{const P=(Date.now()-L.current)/1e3;g(P)},100),()=>{O.current&&clearInterval(O.current)};O.current&&(clearInterval(O.current),O.current=null),g(0)},[s,l]);const se=async()=>{o(!0),p(null),u(null);try{const P=Et();P.onProgress(ee=>{u(ee)}),P.onStreamToken((ee,oe)=>{N(z=>z+oe)}),P.onStreamComplete(()=>{y(!1)}),P.onStreamError(ee=>{p(ee),y(!1),N("")});const R=await P.loadModel(La["0.6b"]);a(R),u(null),me.info("Model loaded successfully",{modelId:R.modelId,size_mb:R.size})}catch(P){const R=String(P);p(R),me.error("Failed to load model",{error:R})}finally{o(!1)}};return{enabled:e,modelInfo:i,loading:s,progress:l,reasoning:d,error:c,elapsedTime:m,temperature:b,isStreaming:_,streamingText:T,toggle:async()=>{if(!e)i!=null&&i.loaded||await se(),n(!0);else if(n(!1),f(null),i!=null&&i.loaded)try{await Et().unloadModel(),a({...i,loaded:!1}),me.info("Model unloaded successfully",{modelId:i.modelId})}catch(P){me.error("Failed to unload model",{error:String(P)})}},loadModel:se,reason:async(P,R,ee=256)=>{if(!(i!=null&&i.loaded)){me.warn("Cannot reason: model not loaded");return}const oe=Date.now(),z=oe-W.current;if(z<q){const te=Math.ceil((q-z)/1e3),Y=`Please wait ${te}s before making another query (rate limit: 1 query per 5 seconds)`;p(Y),me.warn("Rate limit hit",{wait_seconds:te});return}W.current=oe,o(!0),p(null),y(!0),N("");try{const te=Et(),Y=R.slice(0,5).map(k=>({gid:k.gid,pageNo:k.pageNo,title:k.title,text:k.snippet||"",score:k.scores.final}));bi({prompt:P,context:Y.map(k=>k.text),model:i.modelId});const D=await te.reason({question:P,snippets:Y,maxTokens:ee,temperature:b}),Ne=D.usedSnippets.map(k=>Y.find(Ce=>Ce.gid===k)).filter(k=>k!==void 0);if(Ti({response:D.answer,citations:Ne.map(k=>({gid:k.gid,pageNo:k.pageNo})),model:i.modelId}),Ne.forEach(k=>{Ni({gid:k.gid,pageNo:k.pageNo,title:k.title||void 0,snippet:k.text})}),U.isDynamic()){const k=U.getEnvelope();if(k.isOpen()){const Ce=k.getWriter();if(Ce){const G=Ne.length>0?Ne.reduce((Le,Xe)=>Le+Xe.score,0)/Ne.length:1;await Ce.appendSummary({id:kt("llm"),summary:D.answer,relevance:G,source_retrievals:D.usedSnippets})}}}f(D),y(!1),me.info("Reasoning complete",{query:P,tokensGenerated:D.tokensGenerated,inferenceTimeMs:D.inferenceTimeMs,usedSnippets:D.usedSnippets.length})}catch(te){const Y=String(te);p(Y),y(!1),N(""),me.error("Reasoning failed",{query:P,error:Y})}finally{o(!1)}},clearReasoning:()=>{f(null)},abortReasoning:async()=>{try{await Et().abortReasoning(),y(!1),N(""),o(!1),me.info("Reasoning aborted")}catch(P){me.error("Failed to abort reasoning",{error:String(P)})}},setTemperature:v}}function Aa({reasoning:t,searchResults:e,loading:n}){const[i,a]=S(null);return n&&!t?r("div",{className:"reasoning-loading",children:[r("div",{className:"spinner"}),r("p",{children:"LLM is reasoning..."})]}):t?r("div",{className:"reasoning-output",children:[r("div",{className:"reasoning-header",children:[r("h4",{children:" LLM Reasoning"}),r("span",{className:"reasoning-meta",children:[t.inferenceTimeMs.toFixed(0),"ms  ",t.tokensGenerated," tokens"]})]}),r("div",{className:"reasoning-answer",children:t.answer}),t.usedSnippets.length>0&&r("div",{className:"reasoning-citations",children:[r("strong",{children:" Cited sources:"}),t.usedSnippets.map(s=>{const o=e==null?void 0:e.find(l=>l.gid===s);return r("span",{className:"citation",onMouseEnter:()=>a(s),onMouseLeave:()=>a(null),style:{position:"relative"},children:["Page ",(o==null?void 0:o.pageNo)||"?",i===s&&o&&r("div",{className:"citation-tooltip",children:[r("div",{className:"citation-tooltip-title",children:o.title}),o.snippet&&r("div",{className:"citation-tooltip-snippet",dangerouslySetInnerHTML:{__html:Tn.sanitize(o.snippet,{ALLOWED_TAGS:["mark","strong","em","b","i"],ALLOWED_ATTR:[]})}}),r("div",{className:"citation-tooltip-meta",children:["Score: ",o.scores.final.toFixed(3),"  GID: ",s.slice(0,8),"..."]})]})]},s)})]})]}):null}function We(){return typeof navigator<"u"&&"storage"in navigator&&"getDirectory"in navigator.storage}async function Ra(){if(!We())throw new Error("OPFS not supported in this browser");return await navigator.storage.getDirectory()}async function Oa(){return await(await Ra()).getDirectoryHandle("capsules",{create:!0})}function ka(t){const e=t.replace(/[^a-z0-9._-]/gi,"-");return e.endsWith(".mgx.sqlite")?e:`${e}.mgx.sqlite`}async function xa(t,e){if(!We())throw new Error("OPFS not supported - cannot persist file");const n=await Oa(),i=e||ka(t.name),s=await(await n.getFileHandle(i,{create:!0})).createWritable();try{return await s.write(t),await s.close(),console.log(`[OPFS] Copied file to ${i} (${t.size} bytes)`),{path:i,size:t.size}}catch(o){throw await s.close(),o}}async function Ia(){if(!navigator.storage||!navigator.storage.estimate)return null;try{const t=await navigator.storage.estimate(),e=t.usage||0,n=t.quota||0;return{usage:e,quota:n,available:n-e,percentUsed:n>0?e/n*100:0}}catch(t){return console.error("[OPFS] Failed to get storage quota:",t),null}}async function Ma(){if(!navigator.storage||!navigator.storage.persist)return!1;try{const t=await navigator.storage.persist();return console.log(`[OPFS] Persistent storage: ${t}`),t}catch(t){return console.error("[OPFS] Failed to request persistent storage:",t),!1}}function it(t){if(t===0)return"0 B";const e=1024,n=["B","KB","MB","GB"],i=Math.floor(Math.log(t)/Math.log(e));return`${(t/Math.pow(e,i)).toFixed(2)} ${n[i]}`}async function Da(t,e=500*1024*1024){if(t.size===0)return{valid:!1,error:"File is empty"};if(t.size>e)return{valid:!1,error:`File too large (${it(t.size)} > ${it(e)})`};const n=t.name.toLowerCase();if(!n.endsWith(".mgx.sqlite")&&!n.endsWith(".sqlite"))return{valid:!1,error:"File must have .mgx.sqlite or .sqlite extension"};try{const i=await t.slice(0,16).arrayBuffer();if(!new TextDecoder().decode(i).startsWith("SQLite format 3"))return{valid:!1,error:"Not a valid SQLite file (invalid header)"}}catch(i){return{valid:!1,error:`Failed to read file header: ${i}`}}return{valid:!0}}function Fa({onFileSelected:t,onOpfsFileSelected:e,onError:n}){const[i,a]=S([]),[s,o]=S(null),[l,u]=S(!1),[d,f]=S(!1),c=de();J(()=>{p(),m()},[]);async function p(){try{const y=await c.listOpfsFiles();a(y)}catch(y){console.error("[FilePicker] Failed to list OPFS files:",y)}}async function m(){var y,T;try{const N=await Ia();o(N);const L=await((T=(y=navigator.storage)==null?void 0:y.persisted)==null?void 0:T.call(y));f(L||!1)}catch(N){console.error("[FilePicker] Failed to get quota:",N)}}async function g(y){var L;const T=y.target,N=(L=T.files)==null?void 0:L[0];if(N){u(!0);try{const O=await Da(N);if(!O.valid){n(O.error),u(!1);return}if(We()){const{path:W}=await xa(N);await p(),await m(),t(N,W)}else t(N)}catch(O){n(`Failed to load file: ${O}`)}finally{u(!1),T.value=""}}}async function b(y){u(!0);try{e(y)}catch(T){n(`Failed to open from OPFS: ${T}`)}finally{u(!1)}}async function v(y,T){if(T.stopPropagation(),!!confirm(`Remove "${y}" from device storage?`))try{await c.removeFromOpfs(y),await p(),await m()}catch(N){n(`Failed to remove file: ${N}`)}}async function _(){try{await Ma()?f(!0):n("Persistent storage not granted. Files may be evicted under storage pressure.")}catch(y){n(`Failed to request persistence: ${y}`)}}return r("div",{class:"file-picker",children:[r("div",{class:"file-picker-header",children:[r("h2",{children:"Open Capsule"}),s&&r("div",{class:"storage-quota",children:[r("div",{class:"quota-bar",children:r("div",{class:"quota-used",style:`width: ${Math.min(s.percentUsed,100)}%`})}),r("p",{class:"quota-text",children:[it(s.usage)," / ",it(s.quota)," used (",s.percentUsed.toFixed(1),"%)"]}),!d&&We()&&r("button",{class:"btn-secondary btn-sm",onClick:_,children:"Request Persistent Storage"})]})]}),r("div",{class:"file-input-section",children:[r("label",{class:"file-input-label",children:[r("input",{type:"file",accept:".mgx.sqlite,.sqlite",onChange:g,disabled:l,style:"display: none"}),r("button",{class:"btn-primary",disabled:l,children:l?"Loading...":"Select File from Device"})]}),r("p",{class:"help-text",children:"Choose a .mgx.sqlite or .sqlite file from your device"})]}),We()&&i.length>0&&r("div",{class:"opfs-files-section",children:[r("h3",{children:"Stored on Device"}),r("ul",{class:"opfs-files-list",children:i.map(y=>r("li",{class:"opfs-file-item",children:[r("button",{class:"opfs-file-button",onClick:()=>b(y.path),disabled:l,children:r("div",{class:"file-info",children:[r("span",{class:"file-name",children:y.path}),r("span",{class:"file-meta",children:[it(y.size)," "," ",new Date(y.lastModified).toLocaleDateString()]})]})}),r("button",{class:"btn-remove",onClick:T=>v(y.path,T),title:"Remove from device","aria-label":"Remove from device",children:""})]},y.path))})]}),!We()&&r("div",{class:"opfs-warning",children:r("p",{children:[r("strong",{children:"Note:"})," Your browser doesn't support persistent storage. Files will only be kept in memory and lost when you close the tab."]})})]})}function Pa(t={}){const{autoLoad:e=!1,maxHops:n=2,limit:i=50}=t,[a,s]=S(null),[o,l]=S(null),[u,d]=S(void 0),[f,c]=S(!1),[p,m]=S(null),g=async(L,O)=>{c(!0),m(null),l(L),d(O);try{const q=await de().graphHops(L,O,n,i);s(q),console.log("[Graph] Loaded:",q.nodes.length,"nodes,",q.edges.length,"edges")}catch(W){const q=String(W);m(q),console.error("[Graph] Failed to load:",W)}finally{c(!1)}},b=async L=>{await g(L,u)},v=async L=>{o&&await g(o,L)},_=()=>{s(null),l(null),d(void 0),m(null)},y=()=>a?Array.from(new Set(a.edges.map(L=>L.predicate))):[],T=L=>a==null?void 0:a.nodes.find(O=>O.gid===L),N=L=>a?a.edges.filter(O=>O.fromGid===L):[];return J(()=>{e&&o&&g(o,u)},[e]),{graphData:a,seedGid:o,predicate:u,loading:f,error:p,predicates:y(),nodeCount:(a==null?void 0:a.nodes.length)||0,edgeCount:(a==null?void 0:a.edges.length)||0,loadGraph:g,navigateToNode:b,filterByPredicate:v,clear:_,getNode:T,getNodeEdges:N}}function $a({nodes:t,edges:e,seedGid:n,onNodeClick:i,width:a=800,height:s=600}){const[o,l]=S(new Map),u=nt();return J(()=>{const d=new Map,f=a/2,c=s/2;t.forEach((p,m)=>{const g=m/t.length*2*Math.PI,b=Math.min(a,s)/3;d.set(p.gid,{gid:p.gid,x:f+b*Math.cos(g),y:c+b*Math.sin(g),vx:0,vy:0})}),l(d)},[t,a,s]),J(()=>{if(o.size===0)return;const d=()=>{const c=new Map(o),p=.3;c.forEach(m=>{c.forEach(g=>{if(m.gid===g.gid)return;const b=g.x-m.x,v=g.y-m.y,_=b*b+v*v+1,y=Math.sqrt(_),T=2e3/_;m.vx-=b/y*T*p,m.vy-=v/y*T*p})}),e.forEach(m=>{const g=c.get(m.fromGid),b=c.get(m.toGid);if(!g||!b)return;const v=b.x-g.x,_=b.y-g.y,y=Math.sqrt(v*v+_*_)+1,T=y*.01;g.vx+=v/y*T*p,g.vy+=_/y*T*p,b.vx-=v/y*T*p,b.vy-=_/y*T*p}),c.forEach(m=>{m.x+=m.vx,m.y+=m.vy,m.vx*=.8,m.vy*=.8,m.x=Math.max(30,Math.min(a-30,m.x)),m.y=Math.max(30,Math.min(s-30,m.y))}),l(c),u.current=requestAnimationFrame(d)};u.current=requestAnimationFrame(d);const f=setTimeout(()=>{u.current&&cancelAnimationFrame(u.current)},3e3);return()=>{u.current&&cancelAnimationFrame(u.current),clearTimeout(f)}},[e,a,s]),r("svg",{width:a,height:s,className:"graph-view",style:{border:"1px solid var(--color-border)",borderRadius:"8px"},children:[r("g",{className:"graph-edges",children:e.map((d,f)=>{const c=o.get(d.fromGid),p=o.get(d.toGid);return!c||!p?null:r("line",{x1:c.x,y1:c.y,x2:p.x,y2:p.y,stroke:"#94a3b8",strokeWidth:Math.max(1,d.weight*2),strokeOpacity:.6,markerEnd:"url(#arrowhead)"},`${d.fromGid}-${d.toGid}-${f}`)})}),r("defs",{children:r("marker",{id:"arrowhead",markerWidth:"10",markerHeight:"10",refX:"9",refY:"3",orient:"auto",markerUnits:"strokeWidth",children:r("path",{d:"M0,0 L0,6 L9,3 z",fill:"#94a3b8"})})}),r("g",{className:"graph-nodes",children:t.map(d=>{const f=o.get(d.gid);if(!f)return null;const c=d.gid===n,p=c?12:8,m=c?"#3b82f6":"#64748b";return r("g",{className:"graph-node",onClick:()=>i==null?void 0:i(d.gid),style:{cursor:i?"pointer":"default"},children:[r("circle",{cx:f.x,cy:f.y,r:p,fill:m,stroke:"#ffffff",strokeWidth:2,opacity:.9}),r("text",{x:f.x,y:f.y-p-5,textAnchor:"middle",fontSize:"11",fill:"var(--color-fg)",style:{pointerEvents:"none",userSelect:"none"},children:d.title||`Page ${d.pageNo}`})]},d.gid)})})]})}function Ua({nodes:t,edges:e,seedGid:n,onNodeClick:i,loading:a,error:s}){return a?r("div",{className:"graph-panel-loading",children:[r("div",{className:"spinner"}),r("p",{children:"Loading graph..."})]}):s?r("div",{className:"graph-panel-error",children:r("p",{children:["Error: ",s]})}):t.length===0?r("div",{className:"graph-panel-empty",children:[r("p",{children:"No graph data to display"}),r("p",{className:"hint",children:"Search for a page or select a result to explore its connections"})]}):r("div",{className:"graph-panel",children:[r("div",{className:"graph-info",children:[r("span",{children:[t.length," nodes"]}),r("span",{children:[e.length," edges"]})]}),r($a,{nodes:t,edges:e,seedGid:n,onNodeClick:i,width:800,height:600})]})}function Ha({predicates:t,selectedPredicate:e,onPredicateChange:n,onReset:i}){return r("div",{className:"graph-controls",children:[r("div",{className:"graph-controls-section",children:[r("label",{className:"graph-controls-label",children:"Filter by Relationship:"}),r("select",{className:"graph-controls-select",value:e||"",onChange:a=>{const s=a.target.value;n(s||void 0)},children:[r("option",{value:"",children:"All Relationships"}),t.map(a=>r("option",{value:a,children:a},a))]})]}),i&&r("button",{className:"btn-secondary btn-sm",onClick:i,children:"Reset View"})]})}function qa({nodeCount:t,edgeCount:e,predicateCount:n,seedNode:i}){return r("div",{className:"graph-stats",children:[r("div",{className:"graph-stat",children:[r("span",{className:"graph-stat-label",children:"Nodes:"}),r("span",{className:"graph-stat-value",children:t})]}),r("div",{className:"graph-stat",children:[r("span",{className:"graph-stat-label",children:"Edges:"}),r("span",{className:"graph-stat-value",children:e})]}),r("div",{className:"graph-stat",children:[r("span",{className:"graph-stat-label",children:"Relationships:"}),r("span",{className:"graph-stat-value",children:n})]}),i&&r("div",{className:"graph-stat",children:[r("span",{className:"graph-stat-label",children:"Seed:"}),r("span",{className:"graph-stat-value",children:i})]})]})}function Ga(t={}){const{autoLoadCheckpoints:e=!1}=t,[n,i]=S([]),[a,s]=S(null),[o,l]=S(!1),[u,d]=S(!1),[f,c]=S(null),p=async()=>{l(!0),c(null);try{const v=await de().getCheckpoints();i(v),console.log("[Provenance] Loaded",v.length,"checkpoints")}catch(b){const v=String(b);c(v),console.error("[Provenance] Failed to load checkpoints:",b)}finally{l(!1)}},m=async b=>{d(!0),c(null);try{const _=await de().verifyPage(b);s(_),console.log("[Provenance] Verification result:",_)}catch(v){const _=String(v);c(_),console.error("[Provenance] Failed to verify page:",v)}finally{d(!1)}},g=()=>{s(null)};return J(()=>{e&&p()},[e]),{checkpoints:n,verificationResult:a,loading:o,verifying:u,error:f,checkpointCount:n.length,latestCheckpoint:n[0]||null,loadCheckpoints:p,verifyPage:m,clearVerification:g}}function Wa({checkpoint:t,isLatest:e}){return r("div",{className:`checkpoint-item ${e?"checkpoint-latest":""}`,children:[r("div",{className:"checkpoint-header",children:[r("div",{className:"checkpoint-epoch",children:[e&&r("span",{className:"checkpoint-badge",children:"Latest"}),r("span",{className:"checkpoint-epoch-value",children:["Epoch ",t.epoch]})]}),r("div",{className:"checkpoint-date",children:new Date(t.createdTs).toLocaleString()})]}),r("div",{className:"checkpoint-body",children:[r("div",{className:"checkpoint-field",children:[r("span",{className:"field-label",children:"Merkle Root:"}),r("code",{className:"field-value",title:t.merkleRoot,children:[t.merkleRoot.substring(0,16),"..."]})]}),r("div",{className:"checkpoint-field",children:[r("span",{className:"field-label",children:"Pages:"}),r("span",{className:"field-value",children:t.pagesCount})]}),t.anchors&&t.anchors.length>0&&r("div",{className:"checkpoint-field",children:[r("span",{className:"field-label",children:"Anchors:"}),r("span",{className:"field-value",children:t.anchors.length})]})]})]})}function za({checkpoints:t,loading:e,error:n}){return e?r("div",{className:"checkpoint-timeline-loading",children:[r("div",{className:"spinner"}),r("p",{children:"Loading checkpoints..."})]}):n?r("div",{className:"checkpoint-timeline-error",children:r("p",{children:["Error: ",n]})}):t.length===0?r("div",{className:"checkpoint-timeline-empty",children:[r("p",{children:"No checkpoints found"}),r("p",{className:"hint",children:"This capsule has not been checkpointed yet"})]}):r("div",{className:"checkpoint-timeline",children:t.map((i,a)=>r(Wa,{checkpoint:i,isLatest:a===0},i.epoch))})}function Ba({result:t,verifying:e,onVerify:n}){return e?r("div",{className:"verification-panel verification-loading",children:[r("div",{className:"spinner"}),r("p",{children:"Verifying page integrity..."})]}):t?r("div",{className:`verification-panel ${t.verified?"verification-success":"verification-failure"}`,children:[r("div",{className:"verification-header",children:r("div",{className:"verification-status",children:t.verified?r(ce,{children:[r("span",{className:"status-icon",children:""}),r("span",{className:"status-text",children:"Verified"})]}):r(ce,{children:[r("span",{className:"status-icon",children:""}),r("span",{className:"status-text",children:"Verification Failed"})]})})}),r("div",{className:"verification-body",children:[r("div",{className:"verification-field",children:[r("span",{className:"field-label",children:"Content SHA:"}),r("code",{className:"field-value",title:t.contentSha,children:[t.contentSha.substring(0,16),"..."]})]}),t.expectedSha&&r("div",{className:"verification-field",children:[r("span",{className:"field-label",children:"Expected SHA:"}),r("code",{className:"field-value",title:t.expectedSha,children:[t.expectedSha.substring(0,16),"..."]})]}),t.epoch&&r("div",{className:"verification-field",children:[r("span",{className:"field-label",children:"Checkpoint Epoch:"}),r("span",{className:"field-value",children:t.epoch})]}),t.merkleRoot&&r("div",{className:"verification-field",children:[r("span",{className:"field-label",children:"Merkle Root:"}),r("code",{className:"field-value",title:t.merkleRoot,children:[t.merkleRoot.substring(0,16),"..."]})]}),t.signer&&r("div",{className:"verification-field",children:[r("span",{className:"field-label",children:"Signer:"}),r("code",{className:"field-value",children:t.signer})]}),t.signature&&r("div",{className:"verification-field",children:[r("span",{className:"field-label",children:"Signature:"}),r("code",{className:"field-value",title:t.signature,children:[t.signature.substring(0,16),"..."]})]})]}),n&&r("div",{className:"verification-footer",children:r("button",{className:"btn-secondary btn-sm",onClick:n,children:"Verify Again"})})]}):r("div",{className:"verification-panel verification-empty",children:[r("p",{children:'Click "Verify Page" to check integrity'}),n&&r("button",{className:"btn-primary btn-sm",onClick:n,children:"Verify Page"})]})}function Xa({checkpoints:t,verificationResult:e,loading:n,verifying:i,error:a,onVerify:s}){const[o,l]=S("checkpoints");return r("div",{className:"provenance-panel",children:[r("div",{className:"provenance-header",children:r("h3",{children:"Provenance & Trust"})}),r("div",{className:"provenance-tabs",children:[r("button",{className:`provenance-tab ${o==="checkpoints"?"active":""}`,onClick:()=>l("checkpoints"),children:[" Checkpoints (",t.length,")"]}),r("button",{className:`provenance-tab ${o==="verification"?"active":""}`,onClick:()=>l("verification"),children:" Verification"})]}),r("div",{className:"provenance-content",children:[o==="checkpoints"&&r(za,{checkpoints:t,loading:n,error:a}),o==="verification"&&r(Ba,{result:e,verifying:i,onVerify:s})]})]})}function Va(t){const{onFocusSearch:e,onToggleLlm:n,onEscape:i}=t;J(()=>{function a(s){const o=s.target,l=o.tagName==="INPUT"||o.tagName==="TEXTAREA"||o.isContentEditable;if(s.key==="/"&&!l){s.preventDefault(),e==null||e();return}if((s.ctrlKey||s.metaKey)&&s.key==="l"){s.preventDefault(),n==null||n();return}if(s.key==="Escape"){i==null||i();return}}return window.addEventListener("keydown",a),()=>{window.removeEventListener("keydown",a)}},[e,n,i])}function Ya(){const[t,e]=S(U.getInfo()),[n,i]=S(U.getModality()),[a,s]=S(U.getEnvelopeStats());return J(()=>{const m=ue.subscribe("capsule.loaded",()=>{e(U.getInfo()),i(U.getModality()),s(U.getEnvelopeStats())}),g=ue.subscribe("capsule.unloaded",()=>{e(null),i("static"),s(null)}),b=ue.subscribe("envelope.stats",v=>{s(v)});return()=>{m(),g(),b()}},[]),{info:t,modality:n,isDynamic:n==="dynamic",envelopeStats:a,enableDynamicMode:async()=>{await U.enableDynamicMode(),i("dynamic")},saveGlyphCase:async()=>U.saveGlyphCase(),exportGlyphCase:async()=>U.exportGlyphCase(),exportEnvelopeSidecar:async()=>U.exportEnvelopeSidecar(),clearEnvelope:async()=>{await U.clearEnvelope(),s(U.getEnvelopeStats())},verifyEnvelope:async()=>U.verifyEnvelope(),setModalityPreference:m=>{U.setModalityPreference(m)}}}function Qa({modality:t,hasScripts:e,envelopeStats:n,envelopeExtracted:i,onEnableDynamic:a,onSaveGlyphCase:s,onClearEnvelope:o,onVerifyEnvelope:l}){const[u,d]=S(!1),[f,c]=S(!1),p=async()=>{if(a){c(!0);try{await a()}catch(T){console.error("Failed to enable dynamic mode:",T),alert(`Failed to enable dynamic mode: ${T}`)}finally{c(!1)}}},m=async()=>{if(s){c(!0);try{await s(),d(!1)}catch(T){console.error("Failed to save GlyphCase:",T),alert(`Failed to save GlyphCase: ${T}`)}finally{c(!1)}}},g=async()=>{if(!(!o||!confirm(`Are you sure you want to clear all envelope data?

This will delete:
 ${(n==null?void 0:n.retrievalCount)||0} retrieval logs
 ${(n==null?void 0:n.feedbackCount)||0} feedback entries
 ${(n==null?void 0:n.embeddingCount)||0} contextual embeddings
 ${(n==null?void 0:n.summaryCount)||0} context summaries

This action cannot be undone.`))){c(!0);try{await o(),d(!1)}catch(N){console.error("Failed to clear envelope:",N),alert(`Failed to clear envelope: ${N}`)}finally{c(!1)}}},b=async()=>{if(l){c(!0);try{await l(),d(!1)}catch(T){console.error("Failed to verify envelope:",T),alert(`Failed to verify envelope: ${T}`)}finally{c(!1)}}},v=t==="dynamic",_=[v?"Dynamic GlyphCase":"Static GlyphCase"];e&&_.push("Contains automation scripts (not executable in PWA)"),_.push("Click for options");const y=_.join("  ");return r("div",{className:"modality-badge",children:[r("button",{className:`modality-badge-button ${t} ${e?"has-scripts":""}`,onClick:()=>d(!u),title:y,children:[r("span",{className:"modality-badge-text",children:v?" Dynamic":" Static"}),e&&r("span",{className:"scripts-badge",title:"TCMR automation scripts detected",children:" Scripts"})]}),u&&r("div",{className:"modality-menu",children:[r("div",{className:"modality-menu-header",children:[r("h3",{children:v?"Dynamic Mode":"Static Mode"}),r("button",{className:"modality-menu-close",onClick:()=>d(!1),children:""})]}),v?r("div",{className:"modality-menu-content",children:[r("p",{className:"modality-description",children:"This GlyphCase has an active Envelope for episodic memory."}),i&&r("p",{className:"envelope-hint",style:{marginBottom:"1rem",fontSize:"0.9em",color:"#6b7280"},children:" Opened from canonical .gcase+ format (Core + Envelope in single file)"}),n&&r("div",{className:"envelope-stats",children:[r("h4",{children:"Envelope Statistics:"}),r("div",{className:"envelope-stats-grid",children:[r("div",{className:"envelope-stat",children:[r("span",{className:"envelope-stat-label",children:"Retrievals"}),r("span",{className:"envelope-stat-value",children:n.retrievalCount})]}),r("div",{className:"envelope-stat",children:[r("span",{className:"envelope-stat-label",children:"Feedbacks"}),r("span",{className:"envelope-stat-value",children:n.feedbackCount})]}),r("div",{className:"envelope-stat",children:[r("span",{className:"envelope-stat-label",children:"Embeddings"}),r("span",{className:"envelope-stat-value",children:n.embeddingCount})]}),r("div",{className:"envelope-stat",children:[r("span",{className:"envelope-stat-label",children:"Summaries"}),r("span",{className:"envelope-stat-value",children:n.summaryCount})]})]}),n.firstActivity&&r("p",{className:"envelope-activity",children:[r("strong",{children:"Active since:"})," ",new Date(n.firstActivity).toLocaleString()]})]}),r("div",{className:"envelope-actions",children:[r("button",{className:"btn-secondary btn-sm",onClick:b,disabled:f,children:f?"Verifying...":" Verify Integrity"}),r("button",{className:"btn-secondary btn-sm",onClick:m,disabled:f,children:f?"Saving...":" Save GlyphCase"}),r("button",{className:"btn-danger btn-sm",onClick:g,disabled:f,children:f?"Clearing...":" Clear Envelope"})]}),r("p",{className:"envelope-hint",children:" Save GlyphCase creates a single .gcase+ file with Core + Envelope merged together."})]}):r("div",{className:"modality-menu-content",children:[r("p",{className:"modality-description",children:"This GlyphCase is in static mode. All data is read-only."}),r("div",{className:"modality-info",children:[r("h4",{children:"Enable Dynamic Mode to:"}),r("ul",{children:[r("li",{children:"Log search queries and results"}),r("li",{children:"Provide feedback on retrievals"}),r("li",{children:"Generate contextual summaries"}),r("li",{children:"Build adaptive memory over time"})]})]}),r("button",{className:"btn-primary",onClick:p,disabled:f,children:f?"Enabling...":"Enable Dynamic Mode"})]})]}),u&&r("div",{className:"modality-menu-backdrop",onClick:()=>d(!1)})]})}function ja(t){return t.startsWith("asset://")?{protocol:"asset",path:t.slice(8)}:null}const nn=new Map,Ja=new Map;async function Ka(t){if(nn.has(t))return nn.get(t);const e=ja(t);if(!e)return console.error("[Assets] Invalid asset URL:",t),null;try{const i=await de().getPageBlob(e.path);if(!i||i.size===0)return console.warn("[Assets] Asset not found or empty:",e.path),null;const a=URL.createObjectURL(i);return nn.set(t,a),Ja.set(t,i),console.log("[Assets] Loaded:",e.path,`(${i.size} bytes, ${i.type||"unknown type"})`),a}catch(n){return console.error("[Assets] Failed to load asset:",t,n),null}}function Za(t){const[e,n]=S(null);return J(()=>{if(!t){n(null);return}if(!t.startsWith("asset://")){n(t);return}Ka(t).then(n)},[t]),e}function es({gid:t,onClose:e}){const[n,i]=S(null),[a,s]=S(!0),[o,l]=S(null);J(()=>{(async()=>{s(!0),l(null);try{const p=await de().query("SELECT gid, doc_id, page_no, title, tags, updated_ts FROM meta_index WHERE gid = ? LIMIT 1",[t]);p.length>0?i(p[0]):l("Page not found")}catch(c){l(String(c)),console.error("[PagePreview] Failed to load page:",c)}finally{s(!1)}})()},[t]);const u=n?`asset://glyphs/page_${String(n.pageNo).padStart(4,"0")}.mgx.png`:void 0,d=Za(u);return a?r("div",{className:"page-preview",children:r("div",{className:"page-preview-loading",children:[r("div",{className:"spinner"}),r("p",{children:"Loading page..."})]})}):o||!n?r("div",{className:"page-preview",children:r("div",{className:"page-preview-error",children:[r("p",{children:["Error: ",o||"Page not found"]}),e&&r("button",{className:"btn-secondary",onClick:e,children:"Close"})]})}):r("div",{className:"page-preview",children:[r("div",{className:"page-preview-header",children:[r("div",{className:"page-preview-title",children:[r("span",{className:"page-number",children:["Page ",n.pageNo]}),r("h3",{children:n.title||"(Untitled)"})]}),e&&r("button",{className:"btn-icon",onClick:e,title:"Close preview",children:""})]}),r("div",{className:"page-preview-content",children:d?r("img",{src:d,alt:`Page ${n.pageNo}`,className:"page-image"}):r("div",{className:"page-preview-placeholder",children:r("p",{children:"No image available for this page"})})}),r("div",{className:"page-preview-metadata",children:r("dl",{children:[r("dt",{children:"GID:"}),r("dd",{children:r("code",{title:n.gid,children:[n.gid.substring(0,16),"..."]})}),n.tags&&r(ce,{children:[r("dt",{children:"Tags:"}),r("dd",{children:n.tags})]}),r("dt",{children:"Updated:"}),r("dd",{children:new Date(n.updatedTs).toLocaleString()})]})})]})}function ts({selectedGid:t,onClose:e}){return t?r(es,{gid:t,onClose:e}):r("div",{className:"page-preview-panel-empty",children:r("p",{children:"Select a search result to preview the page"})})}function ns({config:t,children:e}){return r("div",{className:"layout-landing",children:[r("section",{className:"hero",children:[r("div",{className:"hero-content",children:[t.logo_asset&&r("img",{src:t.logo_asset,alt:"Logo",className:"hero-logo"}),r("h1",{className:"hero-title",children:t.hero_title||t.site_title||"Welcome"}),t.hero_subtitle&&r("p",{className:"hero-subtitle",children:t.hero_subtitle})]}),t.hero_image&&r("div",{className:"hero-background",style:{backgroundImage:`url(${t.hero_image})`}})]}),r("main",{className:"landing-main",children:e})]})}function rs({config:t,navigation:e,currentPage:n,children:i}){const a=e.filter(s=>s.menu==="sidebar");return r("div",{className:"layout-docs",children:[r("aside",{className:"docs-sidebar",children:r("nav",{className:"docs-nav",children:[r("div",{className:"docs-nav-header",children:[t.logo_asset&&r("img",{src:t.logo_asset,alt:"Logo",className:"docs-logo"}),r("h3",{children:t.site_title||"Documentation"})]}),r("ul",{className:"docs-nav-list",children:a.map(s=>r("li",{className:"docs-nav-item",children:r("a",{href:`#${s.to_slug}`,className:(n==null?void 0:n.slug)===s.to_slug?"active":"",children:[s.icon_asset&&r("img",{src:s.icon_asset,alt:"",className:"nav-icon"}),s.label]})},s.to_slug))})]})}),r("main",{className:"docs-main",children:[n&&r("div",{className:"docs-breadcrumbs",children:[r("a",{href:"#/",children:"Home"}),n.category&&r(ce,{children:[r("span",{children:" / "}),r("span",{children:n.category})]}),r("span",{children:" / "}),r("span",{children:n.title})]}),r("article",{className:"docs-content",children:[n&&r("h1",{children:n.title}),i]})]})]})}function zr({config:t,children:e}){return r("div",{className:"layout-dashboard",children:[r("header",{className:"dashboard-header",children:r("h1",{children:t.site_title||"Dashboard"})}),r("main",{className:"dashboard-content",children:e})]})}function Br({config:t,title:e,children:n}){return r("div",{className:"layout-simple",children:[r("header",{className:"simple-header",children:[t.logo_asset&&r("img",{src:t.logo_asset,alt:"Logo",className:"simple-logo"}),e&&r("h1",{children:e})]}),r("main",{className:"simple-content",children:n}),r("footer",{className:"simple-footer",children:r("p",{children:"Powered by GlyphCase"})})]})}function is({topBar:t,leftSidebar:e,centerPanel:n,rightSidebar:i,showLeftSidebar:a=!0,showRightSidebar:s=!1}){return r("div",{className:"capsule-layout",children:[r("div",{className:"capsule-topbar",children:t}),r("div",{className:"capsule-content",children:[a&&e&&r("aside",{className:"capsule-sidebar capsule-sidebar-left",children:e}),r("main",{className:"capsule-main",children:n}),s&&i&&r("aside",{className:"capsule-sidebar capsule-sidebar-right",children:i})]})]})}function as({capsuleName:t,onClose:e,actions:n}){return r("div",{className:"topbar-content",children:[r("div",{className:"topbar-left",children:r("h2",{className:"topbar-title",children:[" ",t]})}),r("div",{className:"topbar-right",children:[n,e&&r("button",{className:"btn-secondary btn-sm",onClick:e,children:"Close Capsule"})]})]})}function ss({title:t,children:e,onClear:n,hasActiveFilters:i=!1}){return r("div",{className:"filter-panel",children:[r("div",{className:"filter-panel-header",children:[r("h3",{children:t}),i&&n&&r("button",{className:"btn-link btn-sm",onClick:n,children:"Clear All"})]}),r("div",{className:"filter-panel-content",children:e})]})}function os({limit:t=50}){const[e,n]=S([]),[i,a]=S(!1),[s,o]=S(null);J(()=>{l()},[t]);const l=async()=>{if(!U.isDynamic()){n([]);return}a(!0),o(null);try{const p=U.getEnvelope();if(!p.isOpen()){n([]);return}const m=p.getRecentActivity(t);n(m)}catch(p){o(String(p)),console.error("[EnvelopeTimeline] Failed to load:",p)}finally{a(!1)}},u=p=>{switch(p){case"retrieval":return"";case"feedback":return"";case"summary":return"";default:return""}},d=p=>{switch(p){case"retrieval":return"timeline-event-retrieval";case"feedback":return"timeline-event-feedback";case"summary":return"timeline-event-summary";default:return""}},f=p=>p===null?"":p===1?" Helpful":p===-1?" Not helpful":" Neutral",c=p=>{try{const m=new Date(p),b=new Date().getTime()-m.getTime(),v=Math.floor(b/6e4);if(v<1)return"Just now";if(v<60)return`${v}m ago`;const _=Math.floor(v/60);if(_<24)return`${_}h ago`;const y=Math.floor(_/24);return y<7?`${y}d ago`:m.toLocaleDateString()}catch{return p}};return U.isDynamic()?i?r("div",{className:"envelope-timeline",children:r("div",{className:"timeline-loading",children:[r("div",{className:"spinner"}),r("p",{children:"Loading timeline..."})]})}):s?r("div",{className:"envelope-timeline",children:r("div",{className:"timeline-error",children:[r("p",{children:" Failed to load timeline"}),r("p",{className:"error-message",children:s}),r("button",{className:"btn-secondary btn-sm",onClick:l,children:"Retry"})]})}):e.length===0?r("div",{className:"envelope-timeline",children:r("div",{className:"timeline-empty",children:[r("p",{children:"No activity yet."}),r("p",{className:"timeline-hint",children:"Search, give feedback, or generate summaries to populate the timeline."})]})}):r("div",{className:"envelope-timeline",children:[r("div",{className:"timeline-header",children:[r("h3",{children:" Activity Timeline"}),r("span",{className:"timeline-count",children:[e.length," events"]})]}),r("div",{className:"timeline-events",children:e.map((p,m)=>r("div",{className:`timeline-event ${d(p.eventType)}`,children:[r("div",{className:"timeline-event-icon",children:u(p.eventType)}),r("div",{className:"timeline-event-content",children:[r("div",{className:"timeline-event-header",children:[r("span",{className:"timeline-event-type",children:p.eventType.charAt(0).toUpperCase()+p.eventType.slice(1)}),r("span",{className:"timeline-event-time",children:c(p.timestamp)})]}),r("div",{className:"timeline-event-description",children:p.description}),p.eventType==="feedback"&&p.value!==null&&r("div",{className:"timeline-event-meta",children:f(p.value)}),p.eventType==="summary"&&p.value!==null&&r("div",{className:"timeline-event-meta",children:["Relevance: ",(p.value*100).toFixed(0),"%"]})]})]},`${p.id}-${m}`))}),r("div",{className:"timeline-footer",children:r("button",{className:"btn-secondary btn-sm",onClick:l,children:"Refresh Timeline"})})]}):r("div",{className:"envelope-timeline",children:r("div",{className:"timeline-empty",children:[r("p",{children:"Timeline is only available in Dynamic mode."}),r("p",{className:"timeline-hint",children:"Enable Dynamic mode to start tracking activity."})]})})}class ke extends tt{constructor(n){super(n);A(this,"reset",()=>{this.setState({hasError:!1,error:null})});this.state={hasError:!1,error:null}}static getDerivedStateFromError(n){return{hasError:!0,error:n}}componentDidCatch(n,i){const{name:a="Unknown"}=this.props;console.error(`[ErrorBoundary:${a}]`,n,i)}render(){const{hasError:n,error:i}=this.state,{children:a,fallback:s,name:o="Component"}=this.props;return n&&i?s?s(i,this.reset):r("div",{className:"error-boundary",children:r("div",{className:"error-boundary-content",children:[r("h3",{children:[" ",o," Error"]}),r("p",{className:"error-message",children:i.message}),r("button",{className:"btn-secondary",onClick:this.reset,children:"Try Again"}),!1]})}):a}}function ls({capsuleInfo:t,onClose:e}){var W,q,se;const[n,i]=S("search"),[a,s]=S(null),[o,l]=S(!1),[u,d]=S(!1),f=Pr({defaultMode:"fts"}),c=Gr({autoLoad:!0}),p=Pa({maxHops:2,limit:50}),m=Ga({autoLoadCheckpoints:!0}),g=Wr({}),b=Ya();Va({onFocusSearch:()=>{const M=document.querySelector('input[name="query"]');M==null||M.focus(),M==null||M.select()},onToggleLlm:()=>{g.toggle()},onEscape:()=>{document.activeElement instanceof HTMLElement&&document.activeElement.blur()}});const v=M=>{s(M)},_=M=>{p.navigateToNode(M),s(M)},y=M=>{i("graph"),p.loadGraph(M),s(M)},T=()=>{f.clearFilter(),f.lastQuery&&f.search(f.lastQuery)},N=()=>{a&&(m.verifyPage(a),l(!0))},L=async()=>{g.enabled&&f.results&&f.results.length>0&&f.lastQuery&&(g.clearReasoning(),await g.reason(f.lastQuery,f.results,1500))};J(()=>{g.enabled&&f.results&&f.results.length>0&&f.lastQuery&&(!g.reasoning||g.reasoning.usedSnippets.length===0)&&L()},[g.enabled,f.results,f.lastQuery]);const O=!!(f.entityFilter.entityType||f.entityFilter.entityValue);return r(is,{topBar:r(as,{capsuleName:t.fileName,onClose:e,actions:r(ce,{children:[r("div",{className:"capsule-stats",children:[r("span",{children:[t.pageCount," pages"]}),r("span",{children:[t.entityCount," entities"]}),r("span",{children:[t.edgeCount," edges"]})]}),r(Qa,{modality:b.modality,hasScripts:(W=b.info)==null?void 0:W.hasScripts,envelopeStats:b.envelopeStats,envelopeExtracted:(q=b.info)==null?void 0:q.envelopeExtracted,onEnableDynamic:b.enableDynamicMode,onSaveGlyphCase:async()=>{var ee;const M=await b.saveGlyphCase(),I=URL.createObjectURL(M),Z=document.createElement("a");Z.href=I;const we=b.modality==="dynamic"?".gcase+":".gcase",R=(((ee=b.info)==null?void 0:ee.fileName)||"glyphcase").replace(/\.(db|gcase|gcase\+)$/,"");Z.download=`${R}${we}`,Z.click(),URL.revokeObjectURL(I)},onClearEnvelope:b.clearEnvelope,onVerifyEnvelope:async()=>{const M=await b.verifyEnvelope();M&&(M.valid?alert(` Envelope integrity verified!

The hash chain is intact.`):alert(` Envelope integrity check failed:

${M.errors.join(`
`)}`))}}),r("button",{className:`btn-secondary btn-sm ${g.enabled?"active":""}`,onClick:g.toggle,disabled:g.loading,title:(se=g.modelInfo)!=null&&se.loaded?"LLM Ready":"Click to load LLM",children:[" ",g.enabled?"LLM On":"LLM Off"]}),r("button",{className:`btn-secondary btn-sm ${o?"active":""}`,onClick:()=>l(!o),children:[o?"":""," Provenance"]}),b.isDynamic&&r("button",{className:`btn-secondary btn-sm ${u?"active":""}`,onClick:()=>d(!u),children:[u?"":""," Timeline"]})]})}),leftSidebar:r(ke,{name:"EntityPanel",children:r(ss,{title:"Entity Filters",onClear:T,hasActiveFilters:O,children:[O&&r("div",{className:"active-filters",children:[r("p",{className:"filter-label",children:"Active Filter:"}),f.entityFilter.entityType&&r("span",{className:"filter-tag",children:["Type: ",f.entityFilter.entityType]}),f.entityFilter.entityValue&&r("span",{className:"filter-tag",children:["Value: ",f.entityFilter.entityValue]})]}),r(wa,{entities:c.entities,types:c.types,selectedType:c.selectedType,totalCount:c.totalCount,onSelectType:c.selectType,getTypeCount:c.getTypeCount,show:!0,maxDisplay:20})]})}),centerPanel:r("div",{className:"capsule-center",children:[r("div",{className:"view-mode-tabs",children:[r("button",{className:`tab-btn ${n==="search"?"active":""}`,onClick:()=>i("search"),children:" Search"}),r("button",{className:`tab-btn ${n==="graph"?"active":""}`,onClick:()=>i("graph"),children:" Graph"})]}),n==="search"&&r(ce,{children:[r(ke,{name:"SearchPanel",children:r(Ta,{mode:f.mode,results:f.results,lastQuery:f.lastQuery,loading:f.loading,onSearch:f.search,onModeChange:f.changeMode,onResultClick:v,showModeToggle:!0,placeholder:"Search the capsule...",searchHint:'Try: "vector search", "LEANN", "SQLite", or "hybrid retrieval"',searchHistory:f.searchHistory,onClearHistory:f.clearHistory})}),r(ke,{name:"LLM",children:[g.enabled&&f.results&&f.results.length>0&&r("div",{className:"llm-section",children:[r("div",{className:"llm-temperature-control",children:[r("label",{htmlFor:"temperature-slider",className:"temperature-label",children:["Creativity:",r("input",{id:"temperature-slider",type:"range",min:"0",max:"1",step:"0.1",value:g.temperature,onChange:M=>g.setTemperature(parseFloat(M.currentTarget.value)),className:"temperature-slider"}),r("span",{className:"temperature-value",children:g.temperature.toFixed(1)})]}),r("small",{className:"temperature-hint",children:[g.temperature<.3&&" Very factual",g.temperature>=.3&&g.temperature<.6&&" Mostly factual",g.temperature>=.6&&g.temperature<.8&&" Balanced",g.temperature>=.8&&" Creative"]})]}),g.progress&&r("div",{className:"llm-progress-bar",children:[r("div",{className:"llm-progress-info",children:[r("span",{children:[" ",g.progress.message]}),r("span",{children:[(g.progress.progress*100).toFixed(0),"%"]})]}),r("div",{className:"llm-progress-track",children:r("div",{className:"llm-progress-fill",style:{width:`${g.progress.progress*100}%`}})})]}),g.isStreaming&&g.streamingText&&r("div",{className:"streaming-output",children:[r("div",{className:"streaming-header",children:[r("span",{className:"streaming-indicator",children:" Streaming..."}),r("button",{className:"btn-secondary btn-sm abort-btn",onClick:()=>g.abortReasoning(),title:"Stop reasoning",children:" Stop"})]}),r("div",{className:"streaming-text",children:[g.streamingText,r("span",{className:"streaming-cursor",children:""})]})]}),g.reasoning&&r(Aa,{reasoning:g.reasoning,searchResults:f.results,loading:g.loading}),g.loading&&!g.reasoning&&!g.progress&&!g.isStreaming&&r("div",{className:"reasoning-loading",children:[r("div",{className:"spinner"}),r("p",{children:"LLM is reasoning over search results..."}),g.elapsedTime>0&&r("p",{className:"inference-time",children:["Elapsed: ",g.elapsedTime.toFixed(1),"s",g.elapsedTime>3&&"  Typically takes 2-5s"]})]}),g.error&&r("div",{className:"llm-error-panel",children:[r("strong",{children:" LLM Error:"})," ",g.error,r("button",{className:"btn-secondary btn-sm",onClick:L,disabled:g.loading,style:{marginLeft:"1rem"},children:g.loading?"Retrying...":"Try Again"})]})]}),g.enabled&&(!f.results||f.results.length===0)&&f.lastQuery&&r("div",{className:"llm-no-results",children:r("p",{children:" LLM needs search results to reason. Try searching first!"})})]})]}),n==="graph"&&r(ke,{name:"GraphPanel",children:r("div",{className:"graph-view-container",children:[!p.graphData&&r("div",{className:"graph-view-empty",children:[r("p",{children:"Select a search result to explore its graph connections"}),r("p",{className:"hint",children:"Or switch to Search tab to find pages"})]}),p.graphData&&r(ce,{children:[r(qa,{nodeCount:p.nodeCount,edgeCount:p.edgeCount,predicateCount:p.predicates.length,seedNode:p.seedGid||void 0}),r(Ha,{predicates:p.predicates,selectedPredicate:p.predicate,onPredicateChange:p.filterByPredicate,onReset:p.clear}),r(Ua,{nodes:p.graphData.nodes,edges:p.graphData.edges,seedGid:p.seedGid||void 0,onNodeClick:_,loading:p.loading,error:p.error})]})]})}),a&&r(ke,{name:"PagePreview",children:r("div",{className:"page-preview-section",children:[r("div",{className:"page-preview-header-actions",children:[r("h3",{children:"Page Preview"}),r("div",{className:"page-preview-actions",children:[n==="search"&&r("button",{className:"btn-secondary btn-sm",onClick:()=>y(a),children:"Explore Graph"}),r("button",{className:"btn-primary btn-sm",onClick:N,disabled:m.verifying,children:m.verifying?"Verifying...":"Verify Page"})]})]}),r(ts,{selectedGid:a,onClose:()=>s(null)})]})})]}),rightSidebar:r(ce,{children:[o&&r(ke,{name:"ProvenancePanel",children:r(Xa,{checkpoints:m.checkpoints,verificationResult:m.verificationResult,loading:m.loading,verifying:m.verifying,error:m.error,onVerify:N})}),u&&b.isDynamic&&r(ke,{name:"EnvelopeTimeline",children:r(os,{limit:100})})]}),showLeftSidebar:!0,showRightSidebar:o||u})}async function cs(t){const n=(await t.query("SELECT name FROM sqlite_master WHERE type='table'")).map(p=>p.name),i=n.includes("_ui_pages"),a=n.includes("_ui_dashboards"),s=n.includes("_ui_navigation"),o=n.includes("_ui_params"),l=n.includes("_meta_manifest"),u=n.includes("sqlar"),d=n.some(p=>p.startsWith("fts_"));let f="1.0";if(l)try{const p=await t.query("SELECT value FROM _meta_manifest WHERE key='gcui'");p.length>0&&(f=p[0].value)}catch(p){console.warn("Failed to read GCUI version:",p)}let c;return i&&a?c="hybrid":i?c="website":a?c="dashboard":c="generic",{version:f,hasWebsite:i,hasDashboards:a,hasNavigation:s,hasParams:o,hasFTS:d,hasAssets:u,mode:c}}async function ds(t){try{const e=await t.query("SELECT key, value FROM _meta_manifest");if(e.length===0)return null;const n={gcui:"1.0",capsule_kind:"sqlar"};return e.forEach(i=>{n[i.key]=i.value}),n}catch(e){return console.warn("Failed to load manifest:",e),null}}async function us(t){try{const e=await t.query("SELECT key, value FROM _ui_config"),n={};return e.forEach(i=>{n[i.key]=i.value}),n}catch(e){return console.warn("Failed to load config:",e),{}}}async function hs(t){try{return(await t.query("SELECT slug, title, content, layout, category, order_index FROM _ui_pages ORDER BY order_index ASC, slug ASC")).map(n=>({slug:n.slug,title:n.title,content:n.content||void 0,layout:n.layout||void 0,category:n.category||void 0,order_index:n.order_index||void 0}))}catch(e){return console.warn("Failed to load pages:",e),[]}}async function ps(t){try{return(await t.query("SELECT menu, label, to_slug, order_index, icon_asset FROM _ui_navigation ORDER BY menu, order_index ASC")).map(n=>({menu:n.menu,label:n.label,to_slug:n.to_slug,order_index:n.order_index||void 0,icon_asset:n.icon_asset||void 0}))}catch(e){return console.warn("Failed to load navigation:",e),[]}}async function fs(t){try{return(await t.query("SELECT name, query, grammar, config FROM _ui_dashboards")).map(n=>({name:n.name,query:n.query,grammar:n.grammar||void 0,config:n.config||void 0}))}catch(e){return console.warn("Failed to load dashboards:",e),[]}}async function ms(t){const e=await cs(t),n=await ds(t)||{gcui:e.version,capsule_kind:"sqlar"},i=await us(t),a=e.hasWebsite?await hs(t):[],s=e.hasNavigation?await ps(t):[],o=e.hasDashboards?await fs(t):[];return{manifest:n,capabilities:e,config:i,pages:a,navigation:s,dashboards:o}}function gs({data:t,config:e,width:n=600,height:i=400}){if(!t||t.length===0)return r("div",{className:"chart-empty",style:{width:n,height:i},children:r("p",{children:"No data to display"})});switch(e.mark){case"bar":return r(ys,{data:t,config:e,width:n,height:i});case"line":return r(_s,{data:t,config:e,width:n,height:i});case"point":return r(vs,{data:t,config:e,width:n,height:i});case"area":return r(Es,{data:t,config:e,width:n,height:i});default:return r("div",{className:"chart-unsupported",style:{width:n,height:i},children:[r("p",{children:["Unsupported chart type: ",e.mark]}),r("p",{children:"Showing data as table:"}),r(bs,{data:t})]})}}function ys({data:t,config:e,width:n,height:i}){var d,f;const{encoding:a}=e,s=((d=a.x)==null?void 0:d.field)||Object.keys(t[0])[0],o=((f=a.y)==null?void 0:f.field)||Object.keys(t[0])[1],l=Math.max(...t.map(c=>Number(c[o])||0)),u=Math.max(20,(n-100)/t.length-10);return r("div",{className:"chart chart-bar",style:{width:n,height:i},children:[e.title&&r("h4",{className:"chart-title",children:e.title}),r("div",{className:"chart-container",style:{height:i-60},children:r("div",{className:"chart-bars",style:{display:"flex",alignItems:"flex-end",height:"100%",gap:"8px"},children:t.map((c,p)=>{const m=Number(c[o])||0,g=m/l*(i-100);return r("div",{className:"chart-bar-item",style:{textAlign:"center"},children:[r("div",{className:"bar",style:{width:u,height:g,backgroundColor:"#6366f1",borderRadius:"4px 4px 0 0"},title:`${c[s]}: ${m}`}),r("div",{className:"bar-label",style:{fontSize:"12px",marginTop:"4px",maxWidth:u,overflow:"hidden",textOverflow:"ellipsis"},children:String(c[s]).slice(0,10)})]},p)})})}),r("div",{className:"chart-legend",style:{fontSize:"12px",marginTop:"8px",textAlign:"center"},children:[r("strong",{children:o})," by ",r("strong",{children:s})]})]})}function _s({data:t,config:e,width:n,height:i}){var v,_;const{encoding:a}=e,s=((v=a.x)==null?void 0:v.field)||Object.keys(t[0])[0],o=((_=a.y)==null?void 0:_.field)||Object.keys(t[0])[1],l=t.map(y=>Number(y[o])||0),u=Math.max(...l),d=Math.min(...l),f=u-d||1,c=n-80,p=i-100,m=c/(t.length-1||1),g=t.map((y,T)=>{const N=40+T*m,L=Number(y[o])||0,O=p-(L-d)/f*p+20;return{x:N,y:O,value:L,label:y[s]}}),b=g.map((y,T)=>`${T===0?"M":"L"} ${y.x} ${y.y}`).join(" ");return r("div",{className:"chart chart-line",style:{width:n,height:i},children:[e.title&&r("h4",{className:"chart-title",children:e.title}),r("svg",{width:n,height:i-40,style:{overflow:"visible"},children:[[0,.25,.5,.75,1].map(y=>{const T=p-y*p+20,N=d+y*f;return r("g",{children:[r("line",{x1:40,y1:T,x2:n-40,y2:T,stroke:"#e5e7eb",strokeWidth:1}),r("text",{x:10,y:T+4,fontSize:10,fill:"#666",children:N.toFixed(0)})]},y)}),r("path",{d:b,fill:"none",stroke:"#6366f1",strokeWidth:2}),g.map((y,T)=>r("circle",{cx:y.x,cy:y.y,r:4,fill:"#6366f1",children:r("title",{children:`${y.label}: ${y.value}`})},T)),g.map((y,T)=>r("text",{x:y.x,y:p+40,fontSize:10,fill:"#666",textAnchor:"middle",children:String(y.label).slice(0,8)},T))]}),r("div",{className:"chart-legend",style:{fontSize:"12px",textAlign:"center"},children:[r("strong",{children:o})," over ",r("strong",{children:s})]})]})}function vs({data:t,config:e,width:n,height:i}){var _,y;const{encoding:a}=e,s=((_=a.x)==null?void 0:_.field)||Object.keys(t[0])[0],o=((y=a.y)==null?void 0:y.field)||Object.keys(t[0])[1],l=t.map(T=>Number(T[s])||0),u=t.map(T=>Number(T[o])||0),d=Math.min(...l),f=Math.max(...l),c=Math.min(...u),p=Math.max(...u),m=f-d||1,g=p-c||1,b=n-80,v=i-100;return r("div",{className:"chart chart-scatter",style:{width:n,height:i},children:[e.title&&r("h4",{className:"chart-title",children:e.title}),r("svg",{width:n,height:i-40,children:[[0,.25,.5,.75,1].map(T=>{const N=v-T*v+20;return r("line",{x1:40,y1:N,x2:n-40,y2:N,stroke:"#e5e7eb",strokeWidth:1},T)}),t.map((T,N)=>{const L=Number(T[s])||0,O=Number(T[o])||0,W=40+(L-d)/m*b,q=v-(O-c)/g*v+20;return r("circle",{cx:W,cy:q,r:5,fill:"#6366f1",opacity:.7,children:r("title",{children:`${s}: ${L}, ${o}: ${O}`})},N)})]}),r("div",{className:"chart-legend",style:{fontSize:"12px",textAlign:"center"},children:[r("strong",{children:o})," vs ",r("strong",{children:s})]})]})}function Es({data:t,config:e,width:n,height:i}){var _,y;const{encoding:a}=e,s=((_=a.x)==null?void 0:_.field)||Object.keys(t[0])[0],o=((y=a.y)==null?void 0:y.field)||Object.keys(t[0])[1],l=t.map(T=>Number(T[o])||0),u=Math.max(...l),d=Math.min(...l),f=u-d||1,c=n-80,p=i-100,m=c/(t.length-1||1),b=t.map((T,N)=>{const L=40+N*m,O=Number(T[o])||0,W=p-(O-d)/f*p+20;return{x:L,y:W}}).map((T,N)=>`${N===0?"M":"L"} ${T.x} ${T.y}`).join(" "),v=`${b} L ${n-40} ${p+20} L 40 ${p+20} Z`;return r("div",{className:"chart chart-area",style:{width:n,height:i},children:[e.title&&r("h4",{className:"chart-title",children:e.title}),r("svg",{width:n,height:i-40,children:[r("path",{d:v,fill:"#6366f1",opacity:.3}),r("path",{d:b,fill:"none",stroke:"#6366f1",strokeWidth:2})]}),r("div",{className:"chart-legend",style:{fontSize:"12px",textAlign:"center"},children:[r("strong",{children:o})," over ",r("strong",{children:s})]})]})}function bs({data:t}){if(t.length===0)return null;const e=Object.keys(t[0]);return r("table",{className:"data-table",style:{width:"100%",borderCollapse:"collapse",fontSize:"12px"},children:[r("thead",{children:r("tr",{children:e.map(n=>r("th",{style:{borderBottom:"2px solid #ddd",padding:"8px",textAlign:"left"},children:n},n))})}),r("tbody",{children:t.slice(0,10).map((n,i)=>r("tr",{children:e.map(a=>r("td",{style:{borderBottom:"1px solid #eee",padding:"6px"},children:String(n[a])},a))},i))})]})}function Xr({dashboards:t}){return t.length===0?r("div",{className:"dashboard-empty",children:r("p",{children:"No dashboards defined"})}):r("div",{className:"dashboard-grid",children:t.map(e=>r(Ts,{dashboard:e},e.name))})}function Ts({dashboard:t}){const[e,n]=S(null),[i,a]=S(!1),[s,o]=S(null);J(()=>{l()},[t.query]);const l=async()=>{a(!0),o(null);try{const f=await de().query(t.query);n(f)}catch(d){o(String(d)),console.error(`[Dashboard] Failed to load ${t.name}:`,d)}finally{a(!1)}};if(i)return r("div",{className:"dashboard-panel loading",children:[r("div",{className:"spinner"}),r("p",{children:["Loading ",t.name,"..."]})]});if(s)return r("div",{className:"dashboard-panel error",children:[r("h4",{children:t.name}),r("p",{className:"error-message",children:["Error: ",s]}),r("details",{children:[r("summary",{children:"Query"}),r("pre",{children:t.query})]})]});if(!e||e.length===0)return r("div",{className:"dashboard-panel empty",children:[r("h4",{children:t.name}),r("p",{children:"No data"})]});let u=null;if(t.config)try{u=JSON.parse(t.config)}catch(d){console.error(`[Dashboard] Invalid config for ${t.name}:`,d)}return!u||t.grammar!=="vegalite-lite-v1"?r("div",{className:"dashboard-panel table",children:[r("h4",{children:t.name}),r(Ns,{data:e})]}):r("div",{className:"dashboard-panel chart",children:r(gs,{data:e,config:u,width:600,height:400})})}function Ns({data:t}){const e=Object.keys(t[0]||{});return r("div",{style:{overflowX:"auto"},children:r("table",{className:"dashboard-table",style:{width:"100%",borderCollapse:"collapse",fontSize:"14px"},children:[r("thead",{children:r("tr",{children:e.map(n=>r("th",{style:{borderBottom:"2px solid #ddd",padding:"12px",textAlign:"left",fontWeight:600},children:n},n))})}),r("tbody",{children:t.map((n,i)=>r("tr",{style:{borderBottom:"1px solid #eee"},children:e.map(a=>r("td",{style:{padding:"10px"},children:String(n[a])},a))},i))})]})})}function Ss({content:t}){const e=ws(t),n=Tn.sanitize(e,{ALLOWED_TAGS:["h1","h2","h3","h4","h5","h6","p","br","strong","em","code","pre","a","ul","ol","li"],ALLOWED_ATTR:["href"],ALLOW_DATA_ATTR:!1});return r("div",{className:"markdown-content",dangerouslySetInnerHTML:{__html:n}})}function ws(t){let e=t;return e=e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;"),e=e.replace(/^### (.*$)/gim,"<h3>$1</h3>"),e=e.replace(/^## (.*$)/gim,"<h2>$1</h2>"),e=e.replace(/^# (.*$)/gim,"<h1>$1</h1>"),e=e.replace(/\*\*(.*?)\*\*/g,"<strong>$1</strong>"),e=e.replace(/\*(.*?)\*/g,"<em>$1</em>"),e=e.replace(/`(.*?)`/g,"<code>$1</code>"),e=e.replace(/\[(.*?)\]\((.*?)\)/g,'<a href="$2">$1</a>'),e=e.replace(/```(.*?)\n([\s\S]*?)```/g,"<pre><code>$2</code></pre>"),e=e.replace(/^\- (.*$)/gim,"<li>$1</li>"),e=e.replace(/(<li>.*<\/li>)/s,"<ul>$1</ul>"),e=e.replace(/^\d+\. (.*$)/gim,"<li>$1</li>"),e=e.split(`

`).map(i=>i.startsWith("<h")||i.startsWith("<ul>")||i.startsWith("<ol>")||i.startsWith("<pre>")||i.startsWith("<li>")?i:`<p>${i}</p>`).join(`
`),e=e.replace(/\n/g,"<br>"),e}function Cs({context:t}){const[e,n]=S("/");J(()=>{const a=()=>{const s=window.location.hash.slice(1);n(s||"/")};return window.addEventListener("hashchange",a),a(),()=>window.removeEventListener("hashchange",a)},[]);const i=t.pages.find(a=>a.slug===e)||t.pages[0];return i?r(Ls,{page:i,context:t}):t.dashboards.length>0?r(zr,{config:t.config,children:r(Xr,{dashboards:t.dashboards})}):r(Br,{config:t.config,title:"404 Not Found",children:[r("p",{children:["Page not found: ",e]}),r("p",{children:r("a",{href:"#/",children:"Go home"})})]})}function Ls({page:t,context:e}){const n=t.layout||"simple",i=t.content?r(Ss,{content:t.content}):r("p",{children:"No content"});switch(n){case"landing":return r(ns,{config:e.config,children:i});case"docs":return r(rs,{config:e.config,navigation:e.navigation,currentPage:t,children:i});case"dashboard":return r(zr,{config:e.config,children:[i,e.dashboards.length>0&&r(Xr,{dashboards:e.dashboards})]});case"simple":default:return r(Br,{config:e.config,title:t.title,children:i})}}const As={mode:"website",bundledCapsule:"/memglyph-demo.mgx.sqlite",branding:{title:"Memglyph",tagline:"Your knowledge, crystallized",logoUrl:"/logo.svg"},features:{llm:{enabled:!0,autoReason:!1,defaultModel:"qwen3-0.6b",maxTokens:256},search:{defaultMode:"hybrid",enabledModes:["fts","hybrid"],showModeToggle:!1},graph:{enabled:!0,maxHops:2,defaultMaxHops:1},upload:{enabled:!1,acceptedExtensions:[]},gcui:{enabled:!0,fallbackToGeneric:!1},pwa:{enabled:!0,offlineMode:!0}},ui:{showLanding:!0,theme:"documentation"}},Rs={mode:"viewer",bundledCapsule:"/memglyph-demo.mgx.sqlite",branding:{title:"SQLAR Viewer",tagline:"Query your knowledge capsules",logoUrl:"/sqlar-logo.svg"},features:{llm:{enabled:!0,autoReason:!1,defaultModel:"qwen3-0.6b",maxTokens:256},search:{defaultMode:"hybrid",enabledModes:["fts","hybrid","graph"],showModeToggle:!0},graph:{enabled:!0,maxHops:3,defaultMaxHops:2},upload:{enabled:!0,acceptedExtensions:[".sqlite",".sqlar",".db",".mgx.sqlite"]},gcui:{enabled:!0,fallbackToGeneric:!0},pwa:{enabled:!0,offlineMode:!0}},ui:{showLanding:!1,theme:"tool"}};function Os(){return"website"}function ks(){return Os()==="viewer"?Rs:As}class xs{async log(e){try{if(!U.isDynamic())return;const n=U.getEnvelope();if(!n.isOpen())return;const i=n.getWriter();if(!i)return;await i.appendLog({id:kt("log"),level:e.level,logger:e.category.join("."),message:e.message,context:e.properties||void 0})}catch(n){console.error("[LogTape] Failed to write to envelope:",n)}}}function Is(){Wi({sinks:{console:Dr(),envelope:new xs},loggers:[{category:["search"],level:"info",sinks:["console","envelope"]},{category:["llm"],level:"info",sinks:["console","envelope"]},{category:["envelope"],level:"info",sinks:["console","envelope"]},{category:["glyphcase"],level:"info",sinks:["console","envelope"]},{category:["debug"],level:"debug",sinks:["console"]},{category:[],level:"error",sinks:["console","envelope"]}]}),console.log("[Logging] LogTape initialized with console and envelope sinks")}function Ms(){const t=ks(),[e,n]=S(null),[i,a]=S(null),[s,o]=S(!1),[l,u]=S(null),[d,f]=S(!1);Pr({defaultMode:t.features.search.defaultMode});const c=Gr({autoLoad:!1});return Wr({}),J(()=>{Is()},[]),J(()=>{e&&(c.loadEntities(),(async()=>{try{const _=de(),y=await ms(_);console.log("[GCUI] Detected capabilities:",y.capabilities),y.capabilities.mode!=="generic"?(a(y),console.log("[GCUI] Rendering in",y.capabilities.mode,"mode")):(console.log("[GCUI] No GCUI tables found, using legacy mode"),a(null))}catch(_){console.warn("[GCUI] Detection failed, using legacy mode:",_),a(null)}})())},[e]),r("div",{className:"app",children:[r("header",{className:"app-header",children:[r("h1",{children:"GlyphCase Explorer"}),r("p",{children:"Hybrid Retrieval + Dynamic Memory for MemGlyph"})]}),r("main",{className:"app-main",children:e?i&&t.features.gcui.enabled?r("div",{className:"gcui-mode",children:r(Cs,{context:i})}):r(ls,{capsuleInfo:e,onClose:()=>n(null)}):r("div",{className:"welcome",children:[l&&r("div",{className:"error",style:"max-width: 600px; margin: 1rem auto;",children:[r("strong",{children:"Error:"})," ",l]}),r(Fa,{onFileSelected:async(v,_)=>{o(!0),u(null);try{const T=await de().openFromFile(v);n(T),console.log("Capsule opened:",T)}catch(y){u(String(y)),console.error("Failed to open file:",y)}finally{o(!1)}},onOpfsFileSelected:async v=>{o(!0),u(null);try{const y=await de().openFromOpfs(v);n(y),console.log("Capsule opened from OPFS:",y)}catch(_){u(String(_)),console.error("Failed to open from OPFS:",_)}finally{o(!1)}},onError:v=>{u(v)}}),r("div",{style:"text-align: center; margin-top: 1.5rem;",children:[r("p",{style:"margin-bottom: 0.5rem; opacity: 0.7;",children:"Or try the demo:"}),r("button",{className:"btn-secondary",onClick:async()=>{o(!0),u(null);try{const _=await de().openDemo();n(_),console.log("Capsule info:",_)}catch(v){u(String(v)),console.error("Failed to open capsule:",v)}finally{o(!1)}},disabled:s,children:s?"Loading Demo...":"Load Demo Capsule"})]})]})}),r("footer",{className:"app-footer",children:r("p",{children:"Built with Preact + SQLite WASM + OPFS"})})]})}ci(r(Ms,{}),document.getElementById("app"));
